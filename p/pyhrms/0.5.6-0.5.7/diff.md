# Comparing `tmp/pyhrms-0.5.6.zip` & `tmp/pyhrms-0.5.7.zip`

## zipinfo {}

```diff
@@ -1,17 +1,17 @@
-Zip file size: 72960 bytes, number of entries: 15
-drwxrwxrwx  2.0 fat        0 b- stor 23-May-05 08:13 pyhrms-0.5.6/
-drwxrwxrwx  2.0 fat        0 b- stor 23-May-05 08:13 pyhrms-0.5.6/pyhrms/
-drwxrwxrwx  2.0 fat        0 b- stor 23-May-05 08:13 pyhrms-0.5.6/pyhrms.egg-info/
--rw-rw-rw-  2.0 fat     1088 b- defN 21-Nov-11 20:05 pyhrms-0.5.6/License.txt
--rw-rw-rw-  2.0 fat    23109 b- defN 23-May-05 08:13 pyhrms-0.5.6/PKG-INFO
--rw-rw-rw-  2.0 fat    22200 b- defN 23-May-05 08:12 pyhrms-0.5.6/README.rst
--rw-rw-rw-  2.0 fat       42 b- defN 23-May-05 08:13 pyhrms-0.5.6/setup.cfg
--rw-rw-rw-  2.0 fat      899 b- defN 23-May-05 08:12 pyhrms-0.5.6/setup.py
--rw-rw-rw-  2.0 fat   214728 b- defN 23-May-05 08:08 pyhrms-0.5.6/pyhrms/pyhrms.py
--rw-rw-rw-  2.0 fat     1311 b- defN 23-Mar-13 13:39 pyhrms-0.5.6/pyhrms/__init__.py
--rw-rw-rw-  2.0 fat        1 b- defN 23-May-05 08:13 pyhrms-0.5.6/pyhrms.egg-info/dependency_links.txt
--rw-rw-rw-  2.0 fat    23109 b- defN 23-May-05 08:13 pyhrms-0.5.6/pyhrms.egg-info/PKG-INFO
--rw-rw-rw-  2.0 fat      157 b- defN 23-May-05 08:13 pyhrms-0.5.6/pyhrms.egg-info/requires.txt
--rw-rw-rw-  2.0 fat      216 b- defN 23-May-05 08:13 pyhrms-0.5.6/pyhrms.egg-info/SOURCES.txt
--rw-rw-rw-  2.0 fat        7 b- defN 23-May-05 08:13 pyhrms-0.5.6/pyhrms.egg-info/top_level.txt
-15 files, 286867 bytes uncompressed, 70914 bytes compressed:  75.3%
+Zip file size: 73336 bytes, number of entries: 15
+drwxrwxrwx  2.0 fat        0 b- stor 23-May-15 06:51 pyhrms-0.5.7/
+drwxrwxrwx  2.0 fat        0 b- stor 23-May-15 06:51 pyhrms-0.5.7/pyhrms/
+drwxrwxrwx  2.0 fat        0 b- stor 23-May-15 06:51 pyhrms-0.5.7/pyhrms.egg-info/
+-rw-rw-rw-  2.0 fat     1088 b- defN 21-Nov-11 20:05 pyhrms-0.5.7/License.txt
+-rw-rw-rw-  2.0 fat    23190 b- defN 23-May-15 06:51 pyhrms-0.5.7/PKG-INFO
+-rw-rw-rw-  2.0 fat    22277 b- defN 23-May-15 06:51 pyhrms-0.5.7/README.rst
+-rw-rw-rw-  2.0 fat       42 b- defN 23-May-15 06:51 pyhrms-0.5.7/setup.cfg
+-rw-rw-rw-  2.0 fat      899 b- defN 23-May-15 06:48 pyhrms-0.5.7/setup.py
+-rw-rw-rw-  2.0 fat   215577 b- defN 23-May-15 06:46 pyhrms-0.5.7/pyhrms/pyhrms.py
+-rw-rw-rw-  2.0 fat     1311 b- defN 23-May-15 06:47 pyhrms-0.5.7/pyhrms/__init__.py
+-rw-rw-rw-  2.0 fat        1 b- defN 23-May-15 06:51 pyhrms-0.5.7/pyhrms.egg-info/dependency_links.txt
+-rw-rw-rw-  2.0 fat    23190 b- defN 23-May-15 06:51 pyhrms-0.5.7/pyhrms.egg-info/PKG-INFO
+-rw-rw-rw-  2.0 fat      157 b- defN 23-May-15 06:51 pyhrms-0.5.7/pyhrms.egg-info/requires.txt
+-rw-rw-rw-  2.0 fat      216 b- defN 23-May-15 06:51 pyhrms-0.5.7/pyhrms.egg-info/SOURCES.txt
+-rw-rw-rw-  2.0 fat        7 b- defN 23-May-15 06:51 pyhrms-0.5.7/pyhrms.egg-info/top_level.txt
+15 files, 287955 bytes uncompressed, 71290 bytes compressed:  75.2%
```

## zipnote {}

```diff
@@ -1,46 +1,46 @@
-Filename: pyhrms-0.5.6/
+Filename: pyhrms-0.5.7/
 Comment: 
 
-Filename: pyhrms-0.5.6/pyhrms/
+Filename: pyhrms-0.5.7/pyhrms/
 Comment: 
 
-Filename: pyhrms-0.5.6/pyhrms.egg-info/
+Filename: pyhrms-0.5.7/pyhrms.egg-info/
 Comment: 
 
-Filename: pyhrms-0.5.6/License.txt
+Filename: pyhrms-0.5.7/License.txt
 Comment: 
 
-Filename: pyhrms-0.5.6/PKG-INFO
+Filename: pyhrms-0.5.7/PKG-INFO
 Comment: 
 
-Filename: pyhrms-0.5.6/README.rst
+Filename: pyhrms-0.5.7/README.rst
 Comment: 
 
-Filename: pyhrms-0.5.6/setup.cfg
+Filename: pyhrms-0.5.7/setup.cfg
 Comment: 
 
-Filename: pyhrms-0.5.6/setup.py
+Filename: pyhrms-0.5.7/setup.py
 Comment: 
 
-Filename: pyhrms-0.5.6/pyhrms/pyhrms.py
+Filename: pyhrms-0.5.7/pyhrms/pyhrms.py
 Comment: 
 
-Filename: pyhrms-0.5.6/pyhrms/__init__.py
+Filename: pyhrms-0.5.7/pyhrms/__init__.py
 Comment: 
 
-Filename: pyhrms-0.5.6/pyhrms.egg-info/dependency_links.txt
+Filename: pyhrms-0.5.7/pyhrms.egg-info/dependency_links.txt
 Comment: 
 
-Filename: pyhrms-0.5.6/pyhrms.egg-info/PKG-INFO
+Filename: pyhrms-0.5.7/pyhrms.egg-info/PKG-INFO
 Comment: 
 
-Filename: pyhrms-0.5.6/pyhrms.egg-info/requires.txt
+Filename: pyhrms-0.5.7/pyhrms.egg-info/requires.txt
 Comment: 
 
-Filename: pyhrms-0.5.6/pyhrms.egg-info/SOURCES.txt
+Filename: pyhrms-0.5.7/pyhrms.egg-info/SOURCES.txt
 Comment: 
 
-Filename: pyhrms-0.5.6/pyhrms.egg-info/top_level.txt
+Filename: pyhrms-0.5.7/pyhrms.egg-info/top_level.txt
 Comment: 
 
 Zip file comment:
```

## Comparing `pyhrms-0.5.6/License.txt` & `pyhrms-0.5.7/License.txt`

 * *Files identical despite different names*

## Comparing `pyhrms-0.5.6/PKG-INFO` & `pyhrms-0.5.7/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: pyhrms
-Version: 0.5.6
+Version: 0.5.7
 Summary: A powerful GC/LC-HRMS data analysis tool
 Home-page: https://github.com/WangRui5/PyHRMS.git
 Author: Wang Rui
 Author-email: wtrt7009@gmail.com
 License: UNKNOWN
 Platform: UNKNOWN
 Classifier: Programming Language :: Python :: 3
@@ -22,18 +22,22 @@
 
 Contributer: Rui Wang
 ======================
 First release date: Nov.15.2021
 
 Update
 ======
-Mar.23.2023: pyhrms 0.5.6 new features:
+May.15.2023: pyhrms 0.5.7 new features:
+
+    * Add DIA spectrum
+    * update DDA ms2 spectrum collection
+    * update the resolution calculation
+    * fix bugs in ms2 matching for DDA and DIA
+
 
-    * Split in different direction (RT&m/z)
-    * Can process FT_ICRMS data
 
 
 pyhrms can be installed and import as following:
 
 .. code-block:: python
 
     pip install pyhrms
```

## Comparing `pyhrms-0.5.6/README.rst` & `pyhrms-0.5.7/README.rst`

 * *Files 0% similar despite different names*

```diff
@@ -7,18 +7,22 @@
 
 Contributer: Rui Wang
 ======================
 First release date: Nov.15.2021
 
 Update
 ======
-Mar.23.2023: pyhrms 0.5.6 new features:
+May.15.2023: pyhrms 0.5.7 new features:
+
+    * Add DIA spectrum
+    * update DDA ms2 spectrum collection
+    * update the resolution calculation
+    * fix bugs in ms2 matching for DDA and DIA
+
 
-    * Split in different direction (RT&m/z)
-    * Can process FT_ICRMS data
 
 
 pyhrms can be installed and import as following:
 
 .. code-block:: python
 
     pip install pyhrms
```

## Comparing `pyhrms-0.5.6/setup.py` & `pyhrms-0.5.7/setup.py`

 * *Files 1% similar despite different names*

```diff
@@ -2,15 +2,15 @@
 
 def readme_file():
     with open('README.rst') as rf:
         return rf.read()
 
 setuptools.setup(
     name = 'pyhrms',
-    version = '0.5.6',
+    version = '0.5.7',
     author = 'Wang Rui',
     author_email = 'wtrt7009@gmail.com',
     url = 'https://github.com/WangRui5/PyHRMS.git',
     description = 'A powerful GC/LC-HRMS data analysis tool',
     long_description = readme_file(),
     packages = setuptools.find_packages(),
     install_requires = ['numpy>=1.19.2','pandas>=1.3.3'
```

## Comparing `pyhrms-0.5.6/pyhrms/pyhrms.py` & `pyhrms-0.5.7/pyhrms/pyhrms.py`

 * *Files 2% similar despite different names*

```diff
@@ -118,39 +118,34 @@
         fold_change_filter2(path, fold_change=fold_change, p_value=p_value, area_threshold=area_threshold)
     elif filter_type == 3:
         fold_change_filter3(path, fold_change=fold_change, p_value=p_value, area_threshold=area_threshold)
 
     # 如果有DDA，将DDA数据加入到excel里
     files_excel = glob(os.path.join(path, '*.xlsx'))
     unique_cmps = [file for file in files_excel if 'unique_cmps' in os.path.basename(file)]
+             
     for file in files_mzml_DDA:
         df2 = gen_DDA_ms2_df(file, company, profile=profile, opt=False)
         name = os.path.basename(file).replace('-DDA', '').replace('_DDA', '').replace('.mzML', '')  # 获得DDA文件的特征名称
         for file_excel in unique_cmps:
             if name in os.path.basename(file_excel):
                 df1 = pd.read_excel(file_excel)
                 for i in range(len(df1)):
                     rt, mz = df1.loc[i, ['rt', 'mz']]
                     df_frag = df2[(df2['precursor'] >= mz - 0.015) & (df2['precursor'] <= mz + 0.015)
                                   & (df2['rt'] >= rt - 0.1) & (df2['rt'] <= rt + 0.1)]
                     if len(df_frag) == 0:
                         df1.loc[i, 'frag_DDA'] = str([])
                     else:
-                        frag_all = []
-                        for j in range(len(df_frag)):
-                            mz1, intensity1 = df_frag['frag'].iloc[j], df_frag['intensity'].iloc[j]
-                            frag_s = pd.Series(data=intensity1, index=mz1, dtype=float)
-                            frag_all.append(frag_s)
-                        frag_s_all = pd.concat(frag_all).sort_values(ascending=False)
-                        frag_s_all1 = frag_s_all[frag_s_all > 200]
-                        frag_s_all2 = frag_s_all1[~frag_s_all1.index.duplicated(keep='first')]
-                        frag_final = str(list(frag_s_all2.iloc[:20].index.values))
-                        df1.loc[i, 'frag_DDA'] = frag_final
-                        df1.loc[i, 'MS2_spectra'] = str(frag_s_all2.iloc[:20])
-                df1.to_excel(file_excel)  
+                        s_ms2_info = df_frag.iloc[np.argmin(abs(df_frag['rt'].values-rt))]
+                        ms2_rt = df_frag['rt'].values[np.argmin(abs(df_frag['rt'].values-rt))]
+                        s_ms2 = pd.Series(data = s_ms2_info['intensity'], index = s_ms2_info['frag'],name = ms2_rt)
+                        df1.loc[i, 'frag_DDA'] = str(list(s_ms2.index))
+                        df1.loc[i,'MS2_spec_DDA'] = str(s_ms2.astype(int))
+                df1.to_excel(file_excel) 
 
 
 
                 
 def ultimate_peak_picking(ms1, profile=True, split_n=20, threshold=15, i_threshold=500,
                        SN_threshold=3, noise_threshold=0, rt_error_alignment=0.05,
                        mz_error_alignment=0.015, mz_overlap=1, sat_intensity=False,long_rt_split_n = 1,rt_overlap = 1):
@@ -262,34 +257,69 @@
                 print('----------------------------')
                 print('Starting DIA ms2 analysis...')
                 print('----------------------------')
                 peak_all2 = ultimate_peak_picking(ms2, profile=profile, split_n=split_n, i_threshold=i_threshold,
                        SN_threshold=SN_threshold,  sat_intensity=sat_intensity, long_rt_split_n = long_rt_split_n)
 
                 frag_all = []
-                for i in range(len(peak_all)):
+                spec_all = []
+                for i in tqdm(range(len(peak_all)),desc = 'Assign DIA MS2 spectrum'):
                     rt = peak_all.loc[i, 'rt']
-                    frag = str(list(peak_all2[(peak_all2['rt'] > rt - frag_rt_error)
+                    df_DIA = peak_all2[(peak_all2['rt'] > rt - frag_rt_error)
                                               & (peak_all2['rt'] < rt + frag_rt_error)].sort_values(
-                        by='intensity', ascending=False)['mz'].values))
+                        by='intensity', ascending=False)
+                    # append fragments
+                    frag = str(list(df_DIA['mz'].values))
                     frag_all.append(frag)
+                    # append ms2 spectra
+                    
+                    s = pd.Series(data = df_DIA['intensity'].values,index = df_DIA['mz'])
+                    # Convert the series to a DataFrame
+                    df = pd.DataFrame(s).reset_index()
+                    df.columns = ['m/z', 'intensity']
+
+                    # Sort the dataframe by 'm/z'
+                    df = df.sort_values(by='m/z')
+
+                    # Create a new column 'group' for data grouping
+                    df['group'] = (df['m/z'].diff() > 0.5).cumsum()
+
+                    # Keep the row with max 'intensity' from each group
+                    df = df.loc[df.groupby('group')['intensity'].idxmax()]
+
+                    # Drop the 'group' column as it's no longer needed
+                    df = df.drop(columns=['group'])
+
+                    # Convert the DataFrame back to a Series
+                    result = pd.Series(df['intensity'].values, index=df['m/z']).astype(int)
+
+                    # Remove the name of the index
+                    result.index.name = None
+
+                    result = result.sort_values(ascending = False).iloc[:20]
+
+                    spec_all.append(str(result))
+    
                 peak_all.loc[:, 'frag_DIA'] = frag_all
+                peak_all.loc[:,'ms2_spec_DIA'] = spec_all
+
 
         else:
             pass
     file_name = os.path.basename(file)
     peak_selected = identify_isotopes(peak_all)
     peak_selected = remove_unnamed_columns(peak_selected)
     peak_selected.to_excel(file.replace('.mzML', '.xlsx'))
     print('                                                              ')
     print(f'-------------------------------------------------------------')
     print(f'Result generated! File name:{file_name}')
     print('--------------------------------------------------------------')
     print('                                                              ')
-                
+
+
 
 def multi_process(path, company, profile=True, processors=1, p_value=1, ms2_analysis=True, fold_change=0,
                   area_threshold=200, filter_type=3, split_n=20, sat_intensity=False,long_rt_split_n = 1):
     """
     This function is to process mzML data and perform a comparison between the sample set and the control set. The resulting data will be used to generate an Excel file that summarizes the differences between the two sets.
     Args:
        - path: The file path for the mzML files that will be processed. For example, '../Users/Desktop/my_HRMS_files'.
@@ -382,39 +412,34 @@
         fold_change_filter2(path, fold_change=fold_change, p_value=p_value, area_threshold=area_threshold)
     elif filter_type == 3:
         fold_change_filter3(path, fold_change=fold_change, p_value=p_value, area_threshold=area_threshold)
 
     # 如果有DDA，将DDA数据加入到excel里
     files_excel = glob(os.path.join(path, '*.xlsx'))
     unique_cmps = [file for file in files_excel if 'unique_cmps' in os.path.basename(file)]
+             
     for file in files_mzml_DDA:
         df2 = gen_DDA_ms2_df(file, company, profile=profile, opt=False)
         name = os.path.basename(file).replace('-DDA', '').replace('_DDA', '').replace('.mzML', '')  # 获得DDA文件的特征名称
         for file_excel in unique_cmps:
             if name in os.path.basename(file_excel):
                 df1 = pd.read_excel(file_excel)
                 for i in range(len(df1)):
                     rt, mz = df1.loc[i, ['rt', 'mz']]
                     df_frag = df2[(df2['precursor'] >= mz - 0.015) & (df2['precursor'] <= mz + 0.015)
                                   & (df2['rt'] >= rt - 0.1) & (df2['rt'] <= rt + 0.1)]
                     if len(df_frag) == 0:
                         df1.loc[i, 'frag_DDA'] = str([])
                     else:
-                        frag_all = []
-                        for j in range(len(df_frag)):
-                            mz1, intensity1 = df_frag['frag'].iloc[j], df_frag['intensity'].iloc[j]
-                            frag_s = pd.Series(data=intensity1, index=mz1, dtype='float64')
-                            frag_all.append(frag_s)
-                        frag_s_all = pd.concat(frag_all).sort_values(ascending=False)
-                        frag_s_all1 = frag_s_all[frag_s_all > 200]
-                        frag_s_all2 = frag_s_all1[~frag_s_all1.index.duplicated(keep='first')]
-                        frag_final = str(list(frag_s_all2.iloc[:20].index.values))
-                        df1.loc[i, 'frag_DDA'] = frag_final
-                        df1.loc[i, 'MS2_spectra'] = str(frag_s_all2.iloc[:20])
-                df1.to_excel(file_excel)
+                        s_ms2_info = df_frag.iloc[np.argmin(abs(df_frag['rt'].values-rt))]
+                        ms2_rt = df_frag['rt'].values[np.argmin(abs(df_frag['rt'].values-rt))]
+                        s_ms2 = pd.Series(data = s_ms2_info['intensity'], index = s_ms2_info['frag'],name = ms2_rt)
+                        df1.loc[i, 'frag_DDA'] = str(list(s_ms2.index))
+                        df1.loc[i,'MS2_spec_DDA'] = str(s_ms2.astype(int))
+                df1.to_excel(file_excel) 
 
 
 def sep_scans(path, company):
     """
     Separates scans for MS1 and MS2 in mzML files using pymzml package.
     Args:
        path (str): The path of the mzML file.
@@ -1067,14 +1092,15 @@
                         new_spec1 = target_spec1(s1, mz,
                                                  0.2)  # cut the spectrum in a certain range. 1 m/z in this case.
                         peak_index, *_ = scipy.signal.find_peaks(new_spec1.values)
                         if max(new_spec1.values[peak_index]) < sat_intensity:
                             insat_mz_obs, error1, insat_mz_opt, error2, resolution = evaluate_ms(new_spec1, mz)
                             peak_all.loc[j, 'mz'] = insat_mz_obs
                             peak_all.loc[j, 'mz_opt'] = insat_mz_opt
+                            peak_all.loc[j,'resolution'] = resolution
                             break
     return peak_all
 
 
 def remove_unnamed_columns(df):
     """
     Remove any columns in the input DataFrame that are named 'Unnamed:*'.
@@ -1890,23 +1916,23 @@
 
         # Get the m/z and intensity values from the scan
         mz = scan.mz
         intensity = scan.i
 
         # If data is in profile mode, convert it to centroid mode
         if profile is True:
-            spec = pd.Series(data=intensity, index=mz)
+            spec = pd.Series(data=intensity, index=mz,dtype = 'float64')
             new_spec = ms_to_centroid(spec)
             mz = new_spec.index.values
             intensity = new_spec.values
         else:
             pass
 
         # Filter out low intensity peaks and get the top 20 peaks
-        s = pd.Series(data=intensity, index=mz).sort_values(ascending=False).iloc[:20]
+        s = pd.Series(data=intensity, index=mz,dtype='float64').sort_values(ascending=False).iloc[:20]
         s = s[s > i_threshold]
 
         # Get the fragment m/z values and their intensities
         frag = list(s.index.values.round(4))
         frags.append(frag)
         intensities.append(list(s.values))
 
@@ -1920,15 +1946,15 @@
         if opt == False:
             pass
         else:
             mz_opt_all = []
             for i in tqdm(range(len(DDA_df)), desc='Optimizing mass'):
                 frag = DDA_df.loc[i].frag
                 x = DDA_df.loc[i].scan_index
-                s1 = pd.Series(ms2[x].i, ms2[x].mz.round(4))
+                s1 = pd.Series(ms2[x].i, ms2[x].mz.round(4),dtype = 'float64')
                 mz_opt = [evaluate_ms(target_spec(s1, mz), mz)[2] for mz in frag]
                 mz_opt_all.append(mz_opt)
 
             DDA_df['frag_opt'] = mz_opt_all
     return DDA_df
 
 
@@ -1945,16 +1971,16 @@
 
     Returns:
         pandas.DataFrame: DataFrame with the matching results.
     """
 
     columns = list(unique.columns.values)
 
-    DIA = [column for column in columns if 'DIA' in column]
-    DDA = [column for column in columns if 'DDA' in column]
+    DIA = [column for column in columns if 'frag_DIA' in column]
+    DDA = [column for column in columns if 'frag_DDA' in column]
     print(' ')
     print('DIA columns:', DIA)
     print('DIA columns:', DDA)
     database1 = database[database['mode'] == mode]  # 匹配mode模式
     if len(DIA) != 0:
         for i in tqdm(range(len(unique)), desc='Starting DIA ms2 matching:'):
             mz = unique.loc[i]['mz']
```

## Comparing `pyhrms-0.5.6/pyhrms/__init__.py` & `pyhrms-0.5.7/pyhrms/__init__.py`

 * *Files 0% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 from . import pyhrms
 
-__version__ = "0.5.3"
+__version__ = "0.5.7"
 
 __all__ = [
     "sep_scans",
     "gen_df",
     "peak_picking",
     "split_peak_picking",
     "remove_unnamed_columns",
```

## Comparing `pyhrms-0.5.6/pyhrms.egg-info/PKG-INFO` & `pyhrms-0.5.7/pyhrms.egg-info/PKG-INFO`

 * *Files 1% similar despite different names*

```diff
@@ -1,10 +1,10 @@
 Metadata-Version: 2.1
 Name: pyhrms
-Version: 0.5.6
+Version: 0.5.7
 Summary: A powerful GC/LC-HRMS data analysis tool
 Home-page: https://github.com/WangRui5/PyHRMS.git
 Author: Wang Rui
 Author-email: wtrt7009@gmail.com
 License: UNKNOWN
 Platform: UNKNOWN
 Classifier: Programming Language :: Python :: 3
@@ -22,18 +22,22 @@
 
 Contributer: Rui Wang
 ======================
 First release date: Nov.15.2021
 
 Update
 ======
-Mar.23.2023: pyhrms 0.5.6 new features:
+May.15.2023: pyhrms 0.5.7 new features:
+
+    * Add DIA spectrum
+    * update DDA ms2 spectrum collection
+    * update the resolution calculation
+    * fix bugs in ms2 matching for DDA and DIA
+
 
-    * Split in different direction (RT&m/z)
-    * Can process FT_ICRMS data
 
 
 pyhrms can be installed and import as following:
 
 .. code-block:: python
 
     pip install pyhrms
```

