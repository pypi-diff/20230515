# Comparing `tmp/eynollah-0.2.0.tar.gz` & `tmp/eynollah-0.3.0.tar.gz`

## filetype from file(1)

```diff
@@ -1 +1 @@
-gzip compressed data, was "dist/eynollah-0.2.0.tar", last modified: Fri Mar 24 13:17:21 2023, max compression
+gzip compressed data, was "eynollah-0.3.0.tar", last modified: Mon May 15 15:34:57 2023, max compression
```

## Comparing `eynollah-0.2.0.tar` & `eynollah-0.3.0.tar`

### file list

```diff
@@ -1,43 +1,42 @@
-drwxrwxr-x   0 kba       (1000) kba       (1000)        0 2023-03-24 13:17:21.000000 eynollah-0.2.0/
--rw-rw-r--   0 kba       (1000) kba       (1000)    10141 2021-05-04 11:58:05.000000 eynollah-0.2.0/LICENSE
--rw-rw-r--   0 kba       (1000) kba       (1000)    12419 2023-03-24 13:17:21.000000 eynollah-0.2.0/PKG-INFO
--rw-rw-r--   0 kba       (1000) kba       (1000)    12200 2023-02-16 16:09:17.000000 eynollah-0.2.0/README.md
-drwxrwxr-x   0 kba       (1000) kba       (1000)        0 2023-03-24 13:17:21.000000 eynollah-0.2.0/eynollah.egg-info/
--rw-rw-r--   0 kba       (1000) kba       (1000)    12419 2023-03-24 13:17:20.000000 eynollah-0.2.0/eynollah.egg-info/PKG-INFO
--rw-rw-r--   0 kba       (1000) kba       (1000)      985 2023-03-24 13:17:20.000000 eynollah-0.2.0/eynollah.egg-info/SOURCES.txt
--rw-rw-r--   0 kba       (1000) kba       (1000)        1 2023-03-24 13:17:20.000000 eynollah-0.2.0/eynollah.egg-info/dependency_links.txt
--rw-rw-r--   0 kba       (1000) kba       (1000)      110 2023-03-24 13:17:20.000000 eynollah-0.2.0/eynollah.egg-info/entry_points.txt
--rw-rw-r--   0 kba       (1000) kba       (1000)        8 2023-03-24 13:17:20.000000 eynollah-0.2.0/eynollah.egg-info/namespace_packages.txt
--rw-rw-r--   0 kba       (1000) kba       (1000)       93 2023-03-24 13:17:20.000000 eynollah-0.2.0/eynollah.egg-info/requires.txt
--rw-rw-r--   0 kba       (1000) kba       (1000)        8 2023-03-24 13:17:20.000000 eynollah-0.2.0/eynollah.egg-info/top_level.txt
-drwxrwxr-x   0 kba       (1000) kba       (1000)        0 2023-03-24 13:17:21.000000 eynollah-0.2.0/qurator/
--rw-rw-r--   0 kba       (1000) kba       (1000)       56 2023-03-23 14:30:57.000000 eynollah-0.2.0/qurator/__init__.py
-drwxrwxr-x   0 kba       (1000) kba       (1000)        0 2023-03-24 13:17:21.000000 eynollah-0.2.0/qurator/eynollah/
--rw-rw-r--   0 kba       (1000) kba       (1000)        1 2021-05-04 11:58:05.000000 eynollah-0.2.0/qurator/eynollah/__init__.py
--rw-rw-r--   0 kba       (1000) kba       (1000)     4886 2022-05-03 13:09:46.000000 eynollah-0.2.0/qurator/eynollah/cli.py
--rw-rw-r--   0 kba       (1000) kba       (1000)   141469 2023-03-24 13:12:53.000000 eynollah-0.2.0/qurator/eynollah/eynollah.py
--rw-rw-r--   0 kba       (1000) kba       (1000)     2371 2023-03-24 13:16:48.000000 eynollah-0.2.0/qurator/eynollah/ocrd-tool.json
--rw-rw-r--   0 kba       (1000) kba       (1000)      304 2022-07-28 16:14:44.000000 eynollah-0.2.0/qurator/eynollah/ocrd_cli.py
--rw-rw-r--   0 kba       (1000) kba       (1000)     9400 2021-08-16 15:30:33.000000 eynollah-0.2.0/qurator/eynollah/plot.py
--rw-rw-r--   0 kba       (1000) kba       (1000)     2870 2023-03-24 13:12:53.000000 eynollah-0.2.0/qurator/eynollah/processor.py
-drwxrwxr-x   0 kba       (1000) kba       (1000)        0 2023-03-24 13:17:21.000000 eynollah-0.2.0/qurator/eynollah/utils/
--rw-rw-r--   0 kba       (1000) kba       (1000)   104974 2022-08-15 07:09:54.000000 eynollah-0.2.0/qurator/eynollah/utils/__init__.py
--rw-rw-r--   0 kba       (1000) kba       (1000)    11004 2023-03-24 13:12:53.000000 eynollah-0.2.0/qurator/eynollah/utils/contour.py
--rw-rw-r--   0 kba       (1000) kba       (1000)     1321 2021-05-04 11:58:05.000000 eynollah-0.2.0/qurator/eynollah/utils/counter.py
--rw-rw-r--   0 kba       (1000) kba       (1000)    26575 2021-08-16 15:30:33.000000 eynollah-0.2.0/qurator/eynollah/utils/drop_capitals.py
--rw-rw-r--   0 kba       (1000) kba       (1000)       39 2021-05-04 11:58:05.000000 eynollah-0.2.0/qurator/eynollah/utils/is_nan.py
--rw-rw-r--   0 kba       (1000) kba       (1000)     8762 2021-05-04 11:58:05.000000 eynollah-0.2.0/qurator/eynollah/utils/marginals.py
--rw-rw-r--   0 kba       (1000) kba       (1000)     1062 2021-05-04 11:58:05.000000 eynollah-0.2.0/qurator/eynollah/utils/pil_cv2.py
--rw-rw-r--   0 kba       (1000) kba       (1000)      157 2021-05-04 11:58:05.000000 eynollah-0.2.0/qurator/eynollah/utils/resize.py
--rw-rw-r--   0 kba       (1000) kba       (1000)     3825 2021-08-16 15:30:33.000000 eynollah-0.2.0/qurator/eynollah/utils/rotate.py
--rw-rw-r--   0 kba       (1000) kba       (1000)    74071 2021-06-22 11:29:34.000000 eynollah-0.2.0/qurator/eynollah/utils/separate_lines.py
--rw-rw-r--   0 kba       (1000) kba       (1000)     3163 2022-03-14 12:53:17.000000 eynollah-0.2.0/qurator/eynollah/utils/xml.py
--rw-rw-r--   0 kba       (1000) kba       (1000)    16938 2022-03-14 12:53:17.000000 eynollah-0.2.0/qurator/eynollah/writer.py
--rw-rw-r--   0 kba       (1000) kba       (1000)       38 2023-03-24 13:17:21.000000 eynollah-0.2.0/setup.cfg
--rw-rw-r--   0 kba       (1000) kba       (1000)      840 2023-03-23 14:30:57.000000 eynollah-0.2.0/setup.py
-drwxrwxr-x   0 kba       (1000) kba       (1000)        0 2023-03-24 13:17:21.000000 eynollah-0.2.0/tests/
--rw-rw-r--   0 kba       (1000) kba       (1000)      989 2021-05-04 11:58:05.000000 eynollah-0.2.0/tests/test_counter.py
--rw-rw-r--   0 kba       (1000) kba       (1000)      323 2021-05-04 11:58:05.000000 eynollah-0.2.0/tests/test_dpi.py
--rw-rw-r--   0 kba       (1000) kba       (1000)      803 2021-05-04 11:58:05.000000 eynollah-0.2.0/tests/test_run.py
--rw-rw-r--   0 kba       (1000) kba       (1000)      279 2021-05-04 11:58:05.000000 eynollah-0.2.0/tests/test_smoke.py
--rw-rw-r--   0 kba       (1000) kba       (1000)      438 2021-05-04 11:58:05.000000 eynollah-0.2.0/tests/test_xml.py
+drwxrwxr-x   0 kba       (1000) kba       (1000)        0 2023-05-15 15:34:56.997972 eynollah-0.3.0/
+-rw-rw-r--   0 kba       (1000) kba       (1000)    10141 2021-05-04 11:58:05.000000 eynollah-0.3.0/LICENSE
+-rw-rw-r--   0 kba       (1000) kba       (1000)     5316 2023-05-15 15:34:56.997972 eynollah-0.3.0/PKG-INFO
+-rw-rw-r--   0 kba       (1000) kba       (1000)     5097 2023-05-15 15:33:39.000000 eynollah-0.3.0/README.md
+drwxrwxr-x   0 kba       (1000) kba       (1000)        0 2023-05-15 15:34:56.957973 eynollah-0.3.0/eynollah.egg-info/
+-rw-rw-r--   0 kba       (1000) kba       (1000)     5316 2023-05-15 15:34:56.000000 eynollah-0.3.0/eynollah.egg-info/PKG-INFO
+-rw-rw-r--   0 kba       (1000) kba       (1000)      944 2023-05-15 15:34:56.000000 eynollah-0.3.0/eynollah.egg-info/SOURCES.txt
+-rw-rw-r--   0 kba       (1000) kba       (1000)        1 2023-05-15 15:34:56.000000 eynollah-0.3.0/eynollah.egg-info/dependency_links.txt
+-rw-rw-r--   0 kba       (1000) kba       (1000)      110 2023-05-15 15:34:56.000000 eynollah-0.3.0/eynollah.egg-info/entry_points.txt
+-rw-rw-r--   0 kba       (1000) kba       (1000)       93 2023-05-15 15:34:56.000000 eynollah-0.3.0/eynollah.egg-info/requires.txt
+-rw-rw-r--   0 kba       (1000) kba       (1000)        8 2023-05-15 15:34:56.000000 eynollah-0.3.0/eynollah.egg-info/top_level.txt
+drwxrwxr-x   0 kba       (1000) kba       (1000)        0 2023-05-15 15:34:56.957973 eynollah-0.3.0/qurator/
+-rw-rw-r--   0 kba       (1000) kba       (1000)        0 2023-05-15 15:33:39.000000 eynollah-0.3.0/qurator/__init__.py
+drwxrwxr-x   0 kba       (1000) kba       (1000)        0 2023-05-15 15:34:56.969972 eynollah-0.3.0/qurator/eynollah/
+-rw-rw-r--   0 kba       (1000) kba       (1000)        1 2021-05-04 11:58:05.000000 eynollah-0.3.0/qurator/eynollah/__init__.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)     6288 2023-05-15 15:33:39.000000 eynollah-0.3.0/qurator/eynollah/cli.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)   175516 2023-05-15 15:33:39.000000 eynollah-0.3.0/qurator/eynollah/eynollah.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)     2397 2023-05-15 15:33:39.000000 eynollah-0.3.0/qurator/eynollah/ocrd-tool.json
+-rw-rw-r--   0 kba       (1000) kba       (1000)      304 2022-07-28 16:14:44.000000 eynollah-0.3.0/qurator/eynollah/ocrd_cli.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)     9647 2023-05-15 15:33:39.000000 eynollah-0.3.0/qurator/eynollah/plot.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)     2870 2023-03-24 16:57:09.000000 eynollah-0.3.0/qurator/eynollah/processor.py
+drwxrwxr-x   0 kba       (1000) kba       (1000)        0 2023-05-15 15:34:56.997972 eynollah-0.3.0/qurator/eynollah/utils/
+-rw-rw-r--   0 kba       (1000) kba       (1000)   108562 2023-05-15 15:33:39.000000 eynollah-0.3.0/qurator/eynollah/utils/__init__.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)    15741 2023-05-15 15:33:39.000000 eynollah-0.3.0/qurator/eynollah/utils/contour.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)     1321 2021-05-04 11:58:05.000000 eynollah-0.3.0/qurator/eynollah/utils/counter.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)    26575 2021-08-16 15:30:33.000000 eynollah-0.3.0/qurator/eynollah/utils/drop_capitals.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)       39 2021-05-04 11:58:05.000000 eynollah-0.3.0/qurator/eynollah/utils/is_nan.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)     8762 2021-05-04 11:58:05.000000 eynollah-0.3.0/qurator/eynollah/utils/marginals.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)     1062 2021-05-04 11:58:05.000000 eynollah-0.3.0/qurator/eynollah/utils/pil_cv2.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)      157 2021-05-04 11:58:05.000000 eynollah-0.3.0/qurator/eynollah/utils/resize.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)     3825 2021-08-16 15:30:33.000000 eynollah-0.3.0/qurator/eynollah/utils/rotate.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)    74071 2021-06-22 11:29:34.000000 eynollah-0.3.0/qurator/eynollah/utils/separate_lines.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)     3163 2022-03-14 12:53:17.000000 eynollah-0.3.0/qurator/eynollah/utils/xml.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)    17148 2023-05-15 15:33:39.000000 eynollah-0.3.0/qurator/eynollah/writer.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)       38 2023-05-15 15:34:56.997972 eynollah-0.3.0/setup.cfg
+-rw-rw-r--   0 kba       (1000) kba       (1000)      829 2023-05-15 15:33:39.000000 eynollah-0.3.0/setup.py
+drwxrwxr-x   0 kba       (1000) kba       (1000)        0 2023-05-15 15:34:56.997972 eynollah-0.3.0/tests/
+-rw-rw-r--   0 kba       (1000) kba       (1000)      989 2021-05-04 11:58:05.000000 eynollah-0.3.0/tests/test_counter.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)      323 2021-05-04 11:58:05.000000 eynollah-0.3.0/tests/test_dpi.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)      803 2021-05-04 11:58:05.000000 eynollah-0.3.0/tests/test_run.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)      279 2021-05-04 11:58:05.000000 eynollah-0.3.0/tests/test_smoke.py
+-rw-rw-r--   0 kba       (1000) kba       (1000)      438 2021-05-04 11:58:05.000000 eynollah-0.3.0/tests/test_xml.py
```

### filetype from file(1)

```diff
@@ -1 +1 @@
-POSIX tar archive (GNU)
+POSIX tar archive
```

### Comparing `eynollah-0.2.0/LICENSE` & `eynollah-0.3.0/LICENSE`

 * *Files identical despite different names*

### Comparing `eynollah-0.2.0/eynollah.egg-info/SOURCES.txt` & `eynollah-0.3.0/eynollah.egg-info/SOURCES.txt`

 * *Files 3% similar despite different names*

```diff
@@ -1,15 +1,14 @@
 LICENSE
 README.md
 setup.py
 eynollah.egg-info/PKG-INFO
 eynollah.egg-info/SOURCES.txt
 eynollah.egg-info/dependency_links.txt
 eynollah.egg-info/entry_points.txt
-eynollah.egg-info/namespace_packages.txt
 eynollah.egg-info/requires.txt
 eynollah.egg-info/top_level.txt
 qurator/__init__.py
 qurator/eynollah/__init__.py
 qurator/eynollah/cli.py
 qurator/eynollah/eynollah.py
 qurator/eynollah/ocrd-tool.json
```

### Comparing `eynollah-0.2.0/qurator/eynollah/cli.py` & `eynollah-0.3.0/qurator/eynollah/cli.py`

 * *Files 24% similar despite different names*

```diff
@@ -6,24 +6,29 @@
 
 @click.command()
 @click.option(
     "--image",
     "-i",
     help="image filename",
     type=click.Path(exists=True, dir_okay=False),
-    required=True,
 )
 @click.option(
     "--out",
     "-o",
     help="directory to write output xml data",
     type=click.Path(exists=True, file_okay=False),
     required=True,
 )
 @click.option(
+    "--dir_in",
+    "-di",
+    help="directory of images",
+    type=click.Path(exists=True, file_okay=False),
+)
+@click.option(
     "--model",
     "-m",
     help="directory of models",
     type=click.Path(exists=True, file_okay=False),
     required=True,
 )
 @click.option(
@@ -47,14 +52,20 @@
 @click.option(
     "--save_all",
     "-sa",
     help="if a directory is given, all plots needed for documentation will be saved there",
     type=click.Path(exists=True, file_okay=False),
 )
 @click.option(
+    "--save_page",
+    "-sp",
+    help="if a directory is given, page crop of image will be saved there",
+    type=click.Path(exists=True, file_okay=False),
+)
+@click.option(
     "--enable-plotting/--disable-plotting",
     "-ep/-noep",
     is_flag=True,
     help="If set, will plot intermediary files and images",
 )
 @click.option(
     "--allow-enhancement/--no-allow-enhancement",
@@ -62,15 +73,21 @@
     is_flag=True,
     help="if this parameter set to true, this tool would check that input image need resizing and enhancement or not. If so output of resized and enhanced image and corresponding layout data will be written in out directory",
 )
 @click.option(
     "--curved-line/--no-curvedline",
     "-cl/-nocl",
     is_flag=True,
-    help="if this parameter set to true, this tool will try to return contoure of textlines instead of rectabgle bounding box of textline. This should be taken into account that with this option the tool need more time to do process.",
+    help="if this parameter set to true, this tool will try to return contoure of textlines instead of rectangle bounding box of textline. This should be taken into account that with this option the tool need more time to do process.",
+)
+@click.option(
+    "--textline_light/--no-textline_light",
+    "-tll/-notll",
+    is_flag=True,
+    help="if this parameter set to true, this tool will try to return contoure of textlines instead of rectangle bounding box of textline with a faster method.",
 )
 @click.option(
     "--full-layout/--no-full-layout",
     "-fl/-nofl",
     is_flag=True,
     help="if this parameter set to true, this tool will try to return all elements of layout.",
 )
@@ -89,67 +106,93 @@
 @click.option(
     "--allow_scaling/--no-allow-scaling",
     "-as/-noas",
     is_flag=True,
     help="if this parameter set to true, this tool would check the scale and if needed it will scale it to perform better layout detection",
 )
 @click.option(
-    "--headers-off/--headers-on",
+    "--headers_off/--headers-on",
     "-ho/-noho",
     is_flag=True,
     help="if this parameter set to true, this tool would ignore headers role in reading order",
 )
 @click.option(
+    "--light_version/--original",
+    "-light/-org",
+    is_flag=True,
+    help="if this parameter set to true, this tool would use lighter version",
+)
+@click.option(
+    "--ignore_page_extraction/--extract_page_included",
+    "-ipe/-epi",
+    is_flag=True,
+    help="if this parameter set to true, this tool would ignore page extraction",
+)
+@click.option(
     "--log-level",
     "-l",
     type=click.Choice(['OFF', 'DEBUG', 'INFO', 'WARN', 'ERROR']),
     help="Override log level globally to this",
 )
 def main(
     image,
     out,
+    dir_in,
     model,
     save_images,
     save_layout,
     save_deskewed,
     save_all,
+    save_page,
     enable_plotting,
     allow_enhancement,
     curved_line,
+    textline_light,
     full_layout,
     tables,
     input_binary,
     allow_scaling,
     headers_off,
+    light_version,
+    ignore_page_extraction,
     log_level
 ):
     if log_level:
         setOverrideLogLevel(log_level)
     initLogging()
-    if not enable_plotting and (save_layout or save_deskewed or save_all or save_images or allow_enhancement):
-        print("Error: You used one of -sl, -sd, -sa, -si or -ae but did not enable plotting with -ep")
+    if not enable_plotting and (save_layout or save_deskewed or save_all or save_page or save_images or allow_enhancement):
+        print("Error: You used one of -sl, -sd, -sa, -sp, -si or -ae but did not enable plotting with -ep")
+        sys.exit(1)
+    elif enable_plotting and not (save_layout or save_deskewed or save_all or save_page or save_images or allow_enhancement):
+        print("Error: You used -ep to enable plotting but set none of -sl, -sd, -sa, -sp, -si or -ae")
         sys.exit(1)
-    elif enable_plotting and not (save_layout or save_deskewed or save_all or save_images or allow_enhancement):
-        print("Error: You used -ep to enable plotting but set none of -sl, -sd, -sa, -si or -ae")
+    if textline_light and not light_version:
+        print('Error: You used -tll to enable light textline detection but -light is not enabled')
         sys.exit(1)
     eynollah = Eynollah(
         image_filename=image,
         dir_out=out,
+        dir_in=dir_in,
         dir_models=model,
         dir_of_cropped_images=save_images,
         dir_of_layout=save_layout,
         dir_of_deskewed=save_deskewed,
         dir_of_all=save_all,
+        dir_save_page=save_page,
         enable_plotting=enable_plotting,
         allow_enhancement=allow_enhancement,
         curved_line=curved_line,
+        textline_light=textline_light,
         full_layout=full_layout,
         tables=tables,
         input_binary=input_binary,
         allow_scaling=allow_scaling,
         headers_off=headers_off,
+        light_version=light_version,
+        ignore_page_extraction=ignore_page_extraction,
     )
-    pcgts = eynollah.run()
-    eynollah.writer.write_pagexml(pcgts)
+    eynollah.run()
+    #pcgts = eynollah.run()
+    ##eynollah.writer.write_pagexml(pcgts)
 
 if __name__ == "__main__":
     main()
```

### Comparing `eynollah-0.2.0/qurator/eynollah/eynollah.py` & `eynollah-0.3.0/qurator/eynollah/eynollah.py`

 * *Files 13% similar despite different names*

```diff
@@ -21,8822 +21,10950 @@
 00000140: 2d6d 616e 792d 6172 6775 6d65 6e74 732c  -many-arguments,
 00000150: 746f 6f2d 6d61 6e79 2d69 6e73 7461 6e63  too-many-instanc
 00000160: 652d 6174 7472 6962 7574 6573 2c74 6f6f  e-attributes,too
 00000170: 2d6d 616e 792d 7075 626c 6963 2d6d 6574  -many-public-met
 00000180: 686f 6473 2c0a 2320 7079 6c69 6e74 3a20  hods,.# pylint: 
 00000190: 6469 7361 626c 653d 636f 6e73 6964 6572  disable=consider
 000001a0: 2d75 7369 6e67 2d65 6e75 6d65 7261 7465  -using-enumerate
-000001b0: 0a22 2222 0a74 6f6f 6c20 746f 2065 7874  .""".tool to ext
-000001c0: 7261 6374 2074 6162 6c65 2066 6f72 6d20  ract table form 
-000001d0: 6461 7461 2066 726f 6d20 616c 746f 2078  data from alto x
-000001e0: 6d6c 2064 6174 610a 2222 220a 0a69 6d70  ml data."""..imp
-000001f0: 6f72 7420 6d61 7468 0a69 6d70 6f72 7420  ort math.import 
-00000200: 6f73 0a69 6d70 6f72 7420 7379 730a 696d  os.import sys.im
-00000210: 706f 7274 2074 696d 650a 696d 706f 7274  port time.import
-00000220: 2077 6172 6e69 6e67 730a 6672 6f6d 2070   warnings.from p
-00000230: 6174 686c 6962 2069 6d70 6f72 7420 5061  athlib import Pa
-00000240: 7468 0a66 726f 6d20 6d75 6c74 6970 726f  th.from multipro
-00000250: 6365 7373 696e 6720 696d 706f 7274 2050  cessing import P
-00000260: 726f 6365 7373 2c20 5175 6575 652c 2063  rocess, Queue, c
-00000270: 7075 5f63 6f75 6e74 0a69 6d70 6f72 7420  pu_count.import 
-00000280: 6763 0a66 726f 6d20 6f63 7264 5f75 7469  gc.from ocrd_uti
-00000290: 6c73 2069 6d70 6f72 7420 6765 744c 6f67  ls import getLog
-000002a0: 6765 720a 696d 706f 7274 2063 7632 0a69  ger.import cv2.i
-000002b0: 6d70 6f72 7420 6e75 6d70 7920 6173 206e  mport numpy as n
-000002c0: 700a 6f73 2e65 6e76 6972 6f6e 5b22 5446  p.os.environ["TF
-000002d0: 5f43 5050 5f4d 494e 5f4c 4f47 5f4c 4556  _CPP_MIN_LOG_LEV
-000002e0: 454c 225d 203d 2022 3322 0a73 7464 6572  EL"] = "3".stder
-000002f0: 7220 3d20 7379 732e 7374 6465 7272 0a73  r = sys.stderr.s
-00000300: 7973 2e73 7464 6572 7220 3d20 6f70 656e  ys.stderr = open
-00000310: 286f 732e 6465 766e 756c 6c2c 2022 7722  (os.devnull, "w"
-00000320: 290a 696d 706f 7274 2074 656e 736f 7266  ).import tensorf
-00000330: 6c6f 7720 6173 2074 660a 6672 6f6d 2074  low as tf.from t
-00000340: 656e 736f 7266 6c6f 772e 7079 7468 6f6e  ensorflow.python
-00000350: 2e6b 6572 6173 2069 6d70 6f72 7420 6261  .keras import ba
-00000360: 636b 656e 6420 6173 204b 0a66 726f 6d20  ckend as K.from 
-00000370: 7465 6e73 6f72 666c 6f77 2e6b 6572 6173  tensorflow.keras
-00000380: 2e6d 6f64 656c 7320 696d 706f 7274 206c  .models import l
-00000390: 6f61 645f 6d6f 6465 6c0a 7379 732e 7374  oad_model.sys.st
-000003a0: 6465 7272 203d 2073 7464 6572 720a 7466  derr = stderr.tf
-000003b0: 2e67 6574 5f6c 6f67 6765 7228 292e 7365  .get_logger().se
-000003c0: 744c 6576 656c 2822 4552 524f 5222 290a  tLevel("ERROR").
-000003d0: 7761 726e 696e 6773 2e66 696c 7465 7277  warnings.filterw
-000003e0: 6172 6e69 6e67 7328 2269 676e 6f72 6522  arnings("ignore"
-000003f0: 290a 6672 6f6d 2073 6369 7079 2e73 6967  ).from scipy.sig
-00000400: 6e61 6c20 696d 706f 7274 2066 696e 645f  nal import find_
-00000410: 7065 616b 730a 696d 706f 7274 206d 6174  peaks.import mat
-00000420: 706c 6f74 6c69 622e 7079 706c 6f74 2061  plotlib.pyplot a
-00000430: 7320 706c 740a 6672 6f6d 2073 6369 7079  s plt.from scipy
-00000440: 2e6e 6469 6d61 6765 2069 6d70 6f72 7420  .ndimage import 
-00000450: 6761 7573 7369 616e 5f66 696c 7465 7231  gaussian_filter1
-00000460: 640a 0a66 726f 6d20 2e75 7469 6c73 2e63  d..from .utils.c
-00000470: 6f6e 746f 7572 2069 6d70 6f72 7420 280a  ontour import (.
-00000480: 2020 2020 6669 6c74 6572 5f63 6f6e 746f      filter_conto
-00000490: 7572 735f 6172 6561 5f6f 665f 696d 6167  urs_area_of_imag
-000004a0: 652c 0a20 2020 2066 696c 7465 725f 636f  e,.    filter_co
-000004b0: 6e74 6f75 7273 5f61 7265 615f 6f66 5f69  ntours_area_of_i
-000004c0: 6d61 6765 5f74 6162 6c65 732c 0a20 2020  mage_tables,.   
-000004d0: 2066 696e 645f 636f 6e74 6f75 7273 5f6d   find_contours_m
-000004e0: 6561 6e5f 795f 6469 6666 2c0a 2020 2020  ean_y_diff,.    
-000004f0: 6669 6e64 5f6e 6577 5f66 6561 7475 7265  find_new_feature
-00000500: 735f 6f66 5f63 6f6e 746f 7572 732c 0a20  s_of_contours,. 
-00000510: 2020 2066 696e 645f 6665 6174 7572 6573     find_features
-00000520: 5f6f 665f 636f 6e74 6f75 7273 2c0a 2020  _of_contours,.  
-00000530: 2020 6765 745f 7465 7874 5f72 6567 696f    get_text_regio
-00000540: 6e5f 626f 7865 735f 6279 5f67 6976 656e  n_boxes_by_given
-00000550: 5f63 6f6e 746f 7572 732c 0a20 2020 2067  _contours,.    g
-00000560: 6574 5f74 6578 7472 6567 696f 6e5f 636f  et_textregion_co
-00000570: 6e74 6f75 7273 5f69 6e5f 6f72 675f 696d  ntours_in_org_im
-00000580: 6167 652c 0a20 2020 2072 6574 7572 6e5f  age,.    return_
-00000590: 636f 6e74 6f75 7273 5f6f 665f 696d 6167  contours_of_imag
-000005a0: 652c 0a20 2020 2072 6574 7572 6e5f 636f  e,.    return_co
-000005b0: 6e74 6f75 7273 5f6f 665f 696e 7465 7265  ntours_of_intere
-000005c0: 7374 6564 5f72 6567 696f 6e2c 0a20 2020  sted_region,.   
-000005d0: 2072 6574 7572 6e5f 636f 6e74 6f75 7273   return_contours
-000005e0: 5f6f 665f 696e 7465 7265 7374 6564 5f72  _of_interested_r
-000005f0: 6567 696f 6e5f 6279 5f6d 696e 5f73 697a  egion_by_min_siz
-00000600: 652c 0a20 2020 2072 6574 7572 6e5f 636f  e,.    return_co
-00000610: 6e74 6f75 7273 5f6f 665f 696e 7465 7265  ntours_of_intere
-00000620: 7374 6564 5f74 6578 746c 696e 652c 0a20  sted_textline,. 
-00000630: 2020 2072 6574 7572 6e5f 7061 7265 6e74     return_parent
-00000640: 5f63 6f6e 746f 7572 732c 0a29 0a66 726f  _contours,.).fro
-00000650: 6d20 2e75 7469 6c73 2e72 6f74 6174 6520  m .utils.rotate 
-00000660: 696d 706f 7274 2028 0a20 2020 2072 6f74  import (.    rot
-00000670: 6174 655f 696d 6167 652c 0a20 2020 2072  ate_image,.    r
-00000680: 6f74 6174 696f 6e5f 6e6f 745f 3930 5f66  otation_not_90_f
-00000690: 756e 632c 0a20 2020 2072 6f74 6174 696f  unc,.    rotatio
-000006a0: 6e5f 6e6f 745f 3930 5f66 756e 635f 6675  n_not_90_func_fu
-000006b0: 6c6c 5f6c 6179 6f75 7429 0a66 726f 6d20  ll_layout).from 
-000006c0: 2e75 7469 6c73 2e73 6570 6172 6174 655f  .utils.separate_
-000006d0: 6c69 6e65 7320 696d 706f 7274 2028 0a20  lines import (. 
-000006e0: 2020 2074 6578 746c 696e 655f 636f 6e74     textline_cont
-000006f0: 6f75 7273 5f70 6f73 7470 726f 6365 7373  ours_postprocess
-00000700: 696e 672c 0a20 2020 2073 6570 6172 6174  ing,.    separat
-00000710: 655f 6c69 6e65 735f 6e65 7732 2c0a 2020  e_lines_new2,.  
-00000720: 2020 7265 7475 726e 5f64 6573 6b65 775f    return_deskew_
-00000730: 736c 6f70 290a 6672 6f6d 202e 7574 696c  slop).from .util
-00000740: 732e 6472 6f70 5f63 6170 6974 616c 7320  s.drop_capitals 
-00000750: 696d 706f 7274 2028 0a20 2020 2061 6468  import (.    adh
-00000760: 6572 655f 6472 6f70 5f63 6170 6974 616c  ere_drop_capital
-00000770: 5f72 6567 696f 6e5f 696e 746f 5f63 6f72  _region_into_cor
-00000780: 7265 7370 6f6e 6469 6e67 5f74 6578 746c  responding_textl
-00000790: 696e 652c 0a20 2020 2066 696c 7465 725f  ine,.    filter_
-000007a0: 736d 616c 6c5f 6472 6f70 5f63 6170 6974  small_drop_capit
-000007b0: 616c 735f 6672 6f6d 5f6e 6f5f 7061 7463  als_from_no_patc
-000007c0: 685f 6c61 796f 7574 290a 6672 6f6d 202e  h_layout).from .
-000007d0: 7574 696c 732e 6d61 7267 696e 616c 7320  utils.marginals 
-000007e0: 696d 706f 7274 2067 6574 5f6d 6172 6769  import get_margi
-000007f0: 6e61 6c73 0a66 726f 6d20 2e75 7469 6c73  nals.from .utils
-00000800: 2e72 6573 697a 6520 696d 706f 7274 2072  .resize import r
-00000810: 6573 697a 655f 696d 6167 650a 6672 6f6d  esize_image.from
-00000820: 202e 7574 696c 7320 696d 706f 7274 2028   .utils import (
-00000830: 0a20 2020 2062 6f6f 7374 696e 675f 6865  .    boosting_he
-00000840: 6164 6572 735f 6279 5f6c 6f6e 6773 686f  aders_by_longsho
-00000850: 745f 7265 6769 6f6e 5f73 6567 6d65 6e74  t_region_segment
-00000860: 6174 696f 6e2c 0a20 2020 2063 726f 705f  ation,.    crop_
-00000870: 696d 6167 655f 696e 7369 6465 5f62 6f78  image_inside_box
-00000880: 2c0a 2020 2020 6669 6e64 5f6e 756d 5f63  ,.    find_num_c
-00000890: 6f6c 2c0a 2020 2020 6f74 7375 5f63 6f70  ol,.    otsu_cop
-000008a0: 795f 6269 6e61 7279 2c0a 2020 2020 7075  y_binary,.    pu
-000008b0: 745f 6472 6f70 5f6f 7574 5f66 726f 6d5f  t_drop_out_from_
-000008c0: 6f6e 6c79 5f64 726f 705f 6d6f 6465 6c2c  only_drop_model,
-000008d0: 0a20 2020 2070 7574 745f 6262 5f6f 665f  .    putt_bb_of_
-000008e0: 6472 6f70 5f63 6170 6974 616c 735f 6f66  drop_capitals_of
-000008f0: 5f6d 6f64 656c 5f69 6e5f 7061 7463 6865  _model_in_patche
-00000900: 735f 696e 5f6c 6179 6f75 742c 0a20 2020  s_in_layout,.   
-00000910: 2063 6865 636b 5f61 6e79 5f74 6578 745f   check_any_text_
-00000920: 7265 6769 6f6e 5f69 6e5f 6d6f 6465 6c5f  region_in_model_
-00000930: 6f6e 655f 6973 5f6d 6169 6e5f 6f72 5f68  one_is_main_or_h
-00000940: 6561 6465 722c 0a20 2020 2073 6d61 6c6c  eader,.    small
-00000950: 5f74 6578 746c 696e 6573 5f74 6f5f 7061  _textlines_to_pa
-00000960: 7265 6e74 5f61 6468 6572 656e 6365 322c  rent_adherence2,
-00000970: 0a20 2020 206f 7264 6572 5f6f 665f 7265  .    order_of_re
-00000980: 6769 6f6e 732c 0a20 2020 2066 696e 645f  gions,.    find_
-00000990: 6e75 6d62 6572 5f6f 665f 636f 6c75 6d6e  number_of_column
-000009a0: 735f 696e 5f64 6f63 756d 656e 742c 0a20  s_in_document,. 
-000009b0: 2020 2072 6574 7572 6e5f 626f 7865 735f     return_boxes_
-000009c0: 6f66 5f69 6d61 6765 735f 6279 5f6f 7264  of_images_by_ord
-000009d0: 6572 5f6f 665f 7265 6164 696e 675f 6e65  er_of_reading_ne
-000009e0: 7729 0a66 726f 6d20 2e75 7469 6c73 2e70  w).from .utils.p
-000009f0: 696c 5f63 7632 2069 6d70 6f72 7420 6368  il_cv2 import ch
-00000a00: 6563 6b5f 6470 692c 2070 696c 3263 760a  eck_dpi, pil2cv.
-00000a10: 6672 6f6d 202e 7574 696c 732e 786d 6c20  from .utils.xml 
-00000a20: 696d 706f 7274 206f 7264 6572 5f61 6e64  import order_and
-00000a30: 5f69 645f 6f66 5f74 6578 7473 0a66 726f  _id_of_texts.fro
-00000a40: 6d20 2e70 6c6f 7420 696d 706f 7274 2045  m .plot import E
-00000a50: 796e 6f6c 6c61 6850 6c6f 7474 6572 0a66  ynollahPlotter.f
-00000a60: 726f 6d20 2e77 7269 7465 7220 696d 706f  rom .writer impo
-00000a70: 7274 2045 796e 6f6c 6c61 6858 6d6c 5772  rt EynollahXmlWr
-00000a80: 6974 6572 0a0a 534c 4f50 455f 5448 5245  iter..SLOPE_THRE
-00000a90: 5348 4f4c 4420 3d20 302e 3133 0a52 4154  SHOLD = 0.13.RAT
-00000aa0: 494f 5f4f 465f 5457 4f5f 4d4f 4445 4c5f  IO_OF_TWO_MODEL_
-00000ab0: 5448 5245 5348 4f4c 4420 3d20 3935 2e35  THRESHOLD = 95.5
-00000ac0: 3020 2339 382e 3435 3a0a 4450 495f 5448  0 #98.45:.DPI_TH
-00000ad0: 5245 5348 4f4c 4420 3d20 3239 380a 4d41  RESHOLD = 298.MA
-00000ae0: 585f 534c 4f50 4520 3d20 3939 390a 4b45  X_SLOPE = 999.KE
-00000af0: 524e 454c 203d 206e 702e 6f6e 6573 2828  RNEL = np.ones((
-00000b00: 352c 2035 292c 206e 702e 7569 6e74 3829  5, 5), np.uint8)
-00000b10: 0a0a 636c 6173 7320 4579 6e6f 6c6c 6168  ..class Eynollah
-00000b20: 3a0a 2020 2020 6465 6620 5f5f 696e 6974  :.    def __init
-00000b30: 5f5f 280a 2020 2020 2020 2020 7365 6c66  __(.        self
-00000b40: 2c0a 2020 2020 2020 2020 6469 725f 6d6f  ,.        dir_mo
-00000b50: 6465 6c73 2c0a 2020 2020 2020 2020 696d  dels,.        im
-00000b60: 6167 655f 6669 6c65 6e61 6d65 2c0a 2020  age_filename,.  
-00000b70: 2020 2020 2020 696d 6167 655f 7069 6c3d        image_pil=
-00000b80: 4e6f 6e65 2c0a 2020 2020 2020 2020 696d  None,.        im
-00000b90: 6167 655f 6669 6c65 6e61 6d65 5f73 7465  age_filename_ste
-00000ba0: 6d3d 4e6f 6e65 2c0a 2020 2020 2020 2020  m=None,.        
-00000bb0: 6469 725f 6f75 743d 4e6f 6e65 2c0a 2020  dir_out=None,.  
-00000bc0: 2020 2020 2020 6469 725f 6f66 5f63 726f        dir_of_cro
-00000bd0: 7070 6564 5f69 6d61 6765 733d 4e6f 6e65  pped_images=None
-00000be0: 2c0a 2020 2020 2020 2020 6469 725f 6f66  ,.        dir_of
-00000bf0: 5f6c 6179 6f75 743d 4e6f 6e65 2c0a 2020  _layout=None,.  
-00000c00: 2020 2020 2020 6469 725f 6f66 5f64 6573        dir_of_des
-00000c10: 6b65 7765 643d 4e6f 6e65 2c0a 2020 2020  kewed=None,.    
-00000c20: 2020 2020 6469 725f 6f66 5f61 6c6c 3d4e      dir_of_all=N
-00000c30: 6f6e 652c 0a20 2020 2020 2020 2065 6e61  one,.        ena
-00000c40: 626c 655f 706c 6f74 7469 6e67 3d46 616c  ble_plotting=Fal
-00000c50: 7365 2c0a 2020 2020 2020 2020 616c 6c6f  se,.        allo
-00000c60: 775f 656e 6861 6e63 656d 656e 743d 4661  w_enhancement=Fa
-00000c70: 6c73 652c 0a20 2020 2020 2020 2063 7572  lse,.        cur
-00000c80: 7665 645f 6c69 6e65 3d46 616c 7365 2c0a  ved_line=False,.
-00000c90: 2020 2020 2020 2020 6675 6c6c 5f6c 6179          full_lay
-00000ca0: 6f75 743d 4661 6c73 652c 0a20 2020 2020  out=False,.     
-00000cb0: 2020 2074 6162 6c65 733d 4661 6c73 652c     tables=False,
-00000cc0: 0a20 2020 2020 2020 2069 6e70 7574 5f62  .        input_b
-00000cd0: 696e 6172 793d 4661 6c73 652c 0a20 2020  inary=False,.   
-00000ce0: 2020 2020 2061 6c6c 6f77 5f73 6361 6c69       allow_scali
-00000cf0: 6e67 3d46 616c 7365 2c0a 2020 2020 2020  ng=False,.      
-00000d00: 2020 6865 6164 6572 735f 6f66 663d 4661    headers_off=Fa
-00000d10: 6c73 652c 0a20 2020 2020 2020 206f 7665  lse,.        ove
-00000d20: 7272 6964 655f 6470 693d 4e6f 6e65 2c0a  rride_dpi=None,.
-00000d30: 2020 2020 2020 2020 6c6f 6767 6572 3d4e          logger=N
-00000d40: 6f6e 652c 0a20 2020 2020 2020 2070 6367  one,.        pcg
-00000d50: 7473 3d4e 6f6e 652c 0a20 2020 2029 3a0a  ts=None,.    ):.
-00000d60: 2020 2020 2020 2020 6966 2069 6d61 6765          if image
-00000d70: 5f70 696c 3a0a 2020 2020 2020 2020 2020  _pil:.          
-00000d80: 2020 7365 6c66 2e5f 696d 6773 203d 2073    self._imgs = s
-00000d90: 656c 662e 5f63 6163 6865 5f69 6d61 6765  elf._cache_image
-00000da0: 7328 696d 6167 655f 7069 6c3d 696d 6167  s(image_pil=imag
-00000db0: 655f 7069 6c29 0a20 2020 2020 2020 2065  e_pil).        e
-00000dc0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00000dd0: 2073 656c 662e 5f69 6d67 7320 3d20 7365   self._imgs = se
-00000de0: 6c66 2e5f 6361 6368 655f 696d 6167 6573  lf._cache_images
-00000df0: 2869 6d61 6765 5f66 696c 656e 616d 653d  (image_filename=
-00000e00: 696d 6167 655f 6669 6c65 6e61 6d65 290a  image_filename).
-00000e10: 2020 2020 2020 2020 6966 206f 7665 7272          if overr
-00000e20: 6964 655f 6470 693a 0a20 2020 2020 2020  ide_dpi:.       
-00000e30: 2020 2020 2073 656c 662e 6470 6920 3d20       self.dpi = 
-00000e40: 6f76 6572 7269 6465 5f64 7069 0a20 2020  override_dpi.   
-00000e50: 2020 2020 2073 656c 662e 696d 6167 655f       self.image_
-00000e60: 6669 6c65 6e61 6d65 203d 2069 6d61 6765  filename = image
-00000e70: 5f66 696c 656e 616d 650a 2020 2020 2020  _filename.      
-00000e80: 2020 7365 6c66 2e64 6972 5f6f 7574 203d    self.dir_out =
-00000e90: 2064 6972 5f6f 7574 0a20 2020 2020 2020   dir_out.       
-00000ea0: 2073 656c 662e 616c 6c6f 775f 656e 6861   self.allow_enha
-00000eb0: 6e63 656d 656e 7420 3d20 616c 6c6f 775f  ncement = allow_
-00000ec0: 656e 6861 6e63 656d 656e 740a 2020 2020  enhancement.    
-00000ed0: 2020 2020 7365 6c66 2e63 7572 7665 645f      self.curved_
-00000ee0: 6c69 6e65 203d 2063 7572 7665 645f 6c69  line = curved_li
-00000ef0: 6e65 0a20 2020 2020 2020 2073 656c 662e  ne.        self.
-00000f00: 6675 6c6c 5f6c 6179 6f75 7420 3d20 6675  full_layout = fu
-00000f10: 6c6c 5f6c 6179 6f75 740a 2020 2020 2020  ll_layout.      
-00000f20: 2020 7365 6c66 2e74 6162 6c65 7320 3d20    self.tables = 
-00000f30: 7461 626c 6573 0a20 2020 2020 2020 2073  tables.        s
-00000f40: 656c 662e 696e 7075 745f 6269 6e61 7279  elf.input_binary
-00000f50: 203d 2069 6e70 7574 5f62 696e 6172 790a   = input_binary.
-00000f60: 2020 2020 2020 2020 7365 6c66 2e61 6c6c          self.all
-00000f70: 6f77 5f73 6361 6c69 6e67 203d 2061 6c6c  ow_scaling = all
-00000f80: 6f77 5f73 6361 6c69 6e67 0a20 2020 2020  ow_scaling.     
-00000f90: 2020 2073 656c 662e 6865 6164 6572 735f     self.headers_
-00000fa0: 6f66 6620 3d20 6865 6164 6572 735f 6f66  off = headers_of
-00000fb0: 660a 2020 2020 2020 2020 7365 6c66 2e70  f.        self.p
-00000fc0: 6c6f 7474 6572 203d 204e 6f6e 6520 6966  lotter = None if
-00000fd0: 206e 6f74 2065 6e61 626c 655f 706c 6f74   not enable_plot
-00000fe0: 7469 6e67 2065 6c73 6520 4579 6e6f 6c6c  ting else Eynoll
-00000ff0: 6168 506c 6f74 7465 7228 0a20 2020 2020  ahPlotter(.     
-00001000: 2020 2020 2020 2064 6972 5f6f 7574 3d73         dir_out=s
-00001010: 656c 662e 6469 725f 6f75 742c 0a20 2020  elf.dir_out,.   
-00001020: 2020 2020 2020 2020 2064 6972 5f6f 665f           dir_of_
-00001030: 616c 6c3d 6469 725f 6f66 5f61 6c6c 2c0a  all=dir_of_all,.
-00001040: 2020 2020 2020 2020 2020 2020 6469 725f              dir_
-00001050: 6f66 5f64 6573 6b65 7765 643d 6469 725f  of_deskewed=dir_
-00001060: 6f66 5f64 6573 6b65 7765 642c 0a20 2020  of_deskewed,.   
-00001070: 2020 2020 2020 2020 2064 6972 5f6f 665f           dir_of_
-00001080: 6372 6f70 7065 645f 696d 6167 6573 3d64  cropped_images=d
-00001090: 6972 5f6f 665f 6372 6f70 7065 645f 696d  ir_of_cropped_im
-000010a0: 6167 6573 2c0a 2020 2020 2020 2020 2020  ages,.          
-000010b0: 2020 6469 725f 6f66 5f6c 6179 6f75 743d    dir_of_layout=
-000010c0: 6469 725f 6f66 5f6c 6179 6f75 742c 0a20  dir_of_layout,. 
-000010d0: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-000010e0: 5f66 696c 656e 616d 655f 7374 656d 3d50  _filename_stem=P
-000010f0: 6174 6828 5061 7468 2869 6d61 6765 5f66  ath(Path(image_f
-00001100: 696c 656e 616d 6529 2e6e 616d 6529 2e73  ilename).name).s
-00001110: 7465 6d29 0a20 2020 2020 2020 2073 656c  tem).        sel
-00001120: 662e 7772 6974 6572 203d 2045 796e 6f6c  f.writer = Eynol
-00001130: 6c61 6858 6d6c 5772 6974 6572 280a 2020  lahXmlWriter(.  
-00001140: 2020 2020 2020 2020 2020 6469 725f 6f75            dir_ou
-00001150: 743d 7365 6c66 2e64 6972 5f6f 7574 2c0a  t=self.dir_out,.
-00001160: 2020 2020 2020 2020 2020 2020 696d 6167              imag
-00001170: 655f 6669 6c65 6e61 6d65 3d73 656c 662e  e_filename=self.
-00001180: 696d 6167 655f 6669 6c65 6e61 6d65 2c0a  image_filename,.
-00001190: 2020 2020 2020 2020 2020 2020 6375 7276              curv
-000011a0: 6564 5f6c 696e 653d 7365 6c66 2e63 7572  ed_line=self.cur
-000011b0: 7665 645f 6c69 6e65 2c0a 2020 2020 2020  ved_line,.      
-000011c0: 2020 2020 2020 7063 6774 733d 7063 6774        pcgts=pcgt
-000011d0: 7329 0a20 2020 2020 2020 2073 656c 662e  s).        self.
-000011e0: 6c6f 6767 6572 203d 206c 6f67 6765 7220  logger = logger 
-000011f0: 6966 206c 6f67 6765 7220 656c 7365 2067  if logger else g
-00001200: 6574 4c6f 6767 6572 2827 6579 6e6f 6c6c  etLogger('eynoll
-00001210: 6168 2729 0a20 2020 2020 2020 2073 656c  ah').        sel
-00001220: 662e 6469 725f 6d6f 6465 6c73 203d 2064  f.dir_models = d
-00001230: 6972 5f6d 6f64 656c 730a 0a20 2020 2020  ir_models..     
-00001240: 2020 2073 656c 662e 6d6f 6465 6c5f 6469     self.model_di
-00001250: 725f 6f66 5f65 6e68 616e 6365 6d65 6e74  r_of_enhancement
-00001260: 203d 2064 6972 5f6d 6f64 656c 7320 2b20   = dir_models + 
-00001270: 222f 6d6f 6465 6c5f 656e 6861 6e63 656d  "/model_enhancem
-00001280: 656e 742e 6835 220a 2020 2020 2020 2020  ent.h5".        
-00001290: 7365 6c66 2e6d 6f64 656c 5f64 6972 5f6f  self.model_dir_o
-000012a0: 665f 6269 6e61 7269 7a61 7469 6f6e 203d  f_binarization =
-000012b0: 2064 6972 5f6d 6f64 656c 7320 2b20 222f   dir_models + "/
-000012c0: 6d6f 6465 6c5f 6269 6e5f 7362 625f 656e  model_bin_sbb_en
-000012d0: 732e 6835 220a 2020 2020 2020 2020 7365  s.h5".        se
-000012e0: 6c66 2e6d 6f64 656c 5f64 6972 5f6f 665f  lf.model_dir_of_
-000012f0: 636f 6c5f 636c 6173 7369 6669 6572 203d  col_classifier =
-00001300: 2064 6972 5f6d 6f64 656c 7320 2b20 222f   dir_models + "/
-00001310: 6d6f 6465 6c5f 7363 616c 655f 636c 6173  model_scale_clas
-00001320: 7369 6669 6572 2e68 3522 0a20 2020 2020  sifier.h5".     
-00001330: 2020 2073 656c 662e 6d6f 6465 6c5f 7265     self.model_re
-00001340: 6769 6f6e 5f64 6972 5f70 203d 2064 6972  gion_dir_p = dir
-00001350: 5f6d 6f64 656c 7320 2b20 222f 6d6f 6465  _models + "/mode
-00001360: 6c5f 6d61 696e 5f63 6f76 6964 3139 5f6c  l_main_covid19_l
-00001370: 7235 2d35 5f73 6361 6c65 5f31 5f31 5f67  r5-5_scale_1_1_g
-00001380: 7265 6174 2e68 3522 0a20 2020 2020 2020  reat.h5".       
-00001390: 2073 656c 662e 6d6f 6465 6c5f 7265 6769   self.model_regi
-000013a0: 6f6e 5f64 6972 5f70 3220 3d20 6469 725f  on_dir_p2 = dir_
-000013b0: 6d6f 6465 6c73 202b 2022 2f6d 6f64 656c  models + "/model
-000013c0: 5f6d 6169 6e5f 686f 6d65 5f63 6f72 6f6e  _main_home_coron
-000013d0: 6133 5f72 6f74 2e68 3522 0a20 2020 2020  a3_rot.h5".     
-000013e0: 2020 2073 656c 662e 6d6f 6465 6c5f 7265     self.model_re
-000013f0: 6769 6f6e 5f64 6972 5f66 756c 6c79 5f6e  gion_dir_fully_n
-00001400: 7020 3d20 6469 725f 6d6f 6465 6c73 202b  p = dir_models +
-00001410: 2022 2f6d 6f64 656c 5f6e 6f5f 7061 7463   "/model_no_patc
-00001420: 6865 735f 636c 6173 7330 5f33 3065 6f70  hes_class0_30eop
-00001430: 6368 2e68 3522 0a20 2020 2020 2020 2073  ch.h5".        s
-00001440: 656c 662e 6d6f 6465 6c5f 7265 6769 6f6e  elf.model_region
-00001450: 5f64 6972 5f66 756c 6c79 203d 2064 6972  _dir_fully = dir
-00001460: 5f6d 6f64 656c 7320 2b20 222f 6d6f 6465  _models + "/mode
-00001470: 6c5f 3375 705f 6e65 775f 676f 6f64 5f6e  l_3up_new_good_n
-00001480: 6f5f 6175 676d 656e 7461 7469 6f6e 2e68  o_augmentation.h
-00001490: 3522 0a20 2020 2020 2020 2073 656c 662e  5".        self.
-000014a0: 6d6f 6465 6c5f 7061 6765 5f64 6972 203d  model_page_dir =
-000014b0: 2064 6972 5f6d 6f64 656c 7320 2b20 222f   dir_models + "/
-000014c0: 6d6f 6465 6c5f 7061 6765 5f6d 6978 6564  model_page_mixed
-000014d0: 5f62 6573 742e 6835 220a 2020 2020 2020  _best.h5".      
-000014e0: 2020 7365 6c66 2e6d 6f64 656c 5f72 6567    self.model_reg
-000014f0: 696f 6e5f 6469 725f 705f 656e 7320 3d20  ion_dir_p_ens = 
-00001500: 6469 725f 6d6f 6465 6c73 202b 2022 2f6d  dir_models + "/m
-00001510: 6f64 656c 5f65 6e73 656d 626c 655f 732e  odel_ensemble_s.
-00001520: 6835 220a 2020 2020 2020 2020 7365 6c66  h5".        self
-00001530: 2e6d 6f64 656c 5f74 6578 746c 696e 655f  .model_textline_
-00001540: 6469 7220 3d20 6469 725f 6d6f 6465 6c73  dir = dir_models
-00001550: 202b 2022 2f6d 6f64 656c 5f74 6578 746c   + "/model_textl
-00001560: 696e 655f 6e65 7773 7061 7065 7273 2e68  ine_newspapers.h
-00001570: 3522 0a20 2020 2020 2020 2073 656c 662e  5".        self.
-00001580: 6d6f 6465 6c5f 7461 626c 6573 203d 2064  model_tables = d
-00001590: 6972 5f6d 6f64 656c 7320 2b20 222f 6d6f  ir_models + "/mo
-000015a0: 6465 6c5f 7461 626c 6573 5f65 6e73 5f6d  del_tables_ens_m
-000015b0: 6978 6564 5f6e 6577 5f32 2e68 3522 0a0a  ixed_new_2.h5"..
-000015c0: 2020 2020 2020 2020 7365 6c66 2e6d 6f64          self.mod
-000015d0: 656c 7320 3d20 7b7d 0a20 2020 2020 2020  els = {}.       
-000015e0: 200a 2020 2020 6465 6620 5f63 6163 6865   .    def _cache
-000015f0: 5f69 6d61 6765 7328 7365 6c66 2c20 696d  _images(self, im
-00001600: 6167 655f 6669 6c65 6e61 6d65 3d4e 6f6e  age_filename=Non
-00001610: 652c 2069 6d61 6765 5f70 696c 3d4e 6f6e  e, image_pil=Non
-00001620: 6529 3a0a 2020 2020 2020 2020 7265 7420  e):.        ret 
-00001630: 3d20 7b7d 0a20 2020 2020 2020 2069 6620  = {}.        if 
-00001640: 696d 6167 655f 6669 6c65 6e61 6d65 3a0a  image_filename:.
-00001650: 2020 2020 2020 2020 2020 2020 7265 745b              ret[
-00001660: 2769 6d67 275d 203d 2063 7632 2e69 6d72  'img'] = cv2.imr
-00001670: 6561 6428 696d 6167 655f 6669 6c65 6e61  ead(image_filena
-00001680: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
-00001690: 7365 6c66 2e64 7069 203d 2063 6865 636b  self.dpi = check
-000016a0: 5f64 7069 2869 6d61 6765 5f66 696c 656e  _dpi(image_filen
-000016b0: 616d 6529 0a20 2020 2020 2020 2065 6c73  ame).        els
-000016c0: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
-000016d0: 6574 5b27 696d 6727 5d20 3d20 7069 6c32  et['img'] = pil2
-000016e0: 6376 2869 6d61 6765 5f70 696c 290a 2020  cv(image_pil).  
-000016f0: 2020 2020 2020 2020 2020 7365 6c66 2e64            self.d
-00001700: 7069 203d 2063 6865 636b 5f64 7069 2869  pi = check_dpi(i
-00001710: 6d61 6765 5f70 696c 290a 2020 2020 2020  mage_pil).      
-00001720: 2020 7265 745b 2769 6d67 5f67 7261 7973    ret['img_grays
-00001730: 6361 6c65 275d 203d 2063 7632 2e63 7674  cale'] = cv2.cvt
-00001740: 436f 6c6f 7228 7265 745b 2769 6d67 275d  Color(ret['img']
-00001750: 2c20 6376 322e 434f 4c4f 525f 4247 5232  , cv2.COLOR_BGR2
-00001760: 4752 4159 290a 2020 2020 2020 2020 666f  GRAY).        fo
-00001770: 7220 7072 6566 6978 2069 6e20 2827 272c  r prefix in ('',
-00001780: 2020 275f 6772 6179 7363 616c 6527 293a    '_grayscale'):
-00001790: 0a20 2020 2020 2020 2020 2020 2072 6574  .            ret
-000017a0: 5b66 2769 6d67 7b70 7265 6669 787d 5f75  [f'img{prefix}_u
-000017b0: 696e 7438 275d 203d 2072 6574 5b66 2769  int8'] = ret[f'i
-000017c0: 6d67 7b70 7265 6669 787d 275d 2e61 7374  mg{prefix}'].ast
-000017d0: 7970 6528 6e70 2e75 696e 7438 290a 2020  ype(np.uint8).  
-000017e0: 2020 2020 2020 7265 7475 726e 2072 6574        return ret
-000017f0: 0a0a 2020 2020 6465 6620 696d 7265 6164  ..    def imread
-00001800: 2873 656c 662c 2067 7261 7973 6361 6c65  (self, grayscale
-00001810: 3d46 616c 7365 2c20 7569 6e74 383d 5472  =False, uint8=Tr
-00001820: 7565 293a 0a20 2020 2020 2020 206b 6579  ue):.        key
-00001830: 203d 2027 696d 6727 0a20 2020 2020 2020   = 'img'.       
-00001840: 2069 6620 6772 6179 7363 616c 653a 0a20   if grayscale:. 
-00001850: 2020 2020 2020 2020 2020 206b 6579 202b             key +
-00001860: 3d20 275f 6772 6179 7363 616c 6527 0a20  = '_grayscale'. 
-00001870: 2020 2020 2020 2069 6620 7569 6e74 383a         if uint8:
-00001880: 0a20 2020 2020 2020 2020 2020 206b 6579  .            key
-00001890: 202b 3d20 275f 7569 6e74 3827 0a20 2020   += '_uint8'.   
-000018a0: 2020 2020 2072 6574 7572 6e20 7365 6c66       return self
-000018b0: 2e5f 696d 6773 5b6b 6579 5d2e 636f 7079  ._imgs[key].copy
-000018c0: 2829 0a20 2020 200a 2020 2020 6465 6620  ().    .    def 
-000018d0: 6973 4e61 4e28 7365 6c66 2c20 6e75 6d29  isNaN(self, num)
-000018e0: 3a0a 2020 2020 2020 2020 7265 7475 726e  :.        return
-000018f0: 206e 756d 2021 3d20 6e75 6d0a 0a0a 2020   num != num...  
-00001900: 2020 6465 6620 7072 6564 6963 745f 656e    def predict_en
-00001910: 6861 6e63 656d 656e 7428 7365 6c66 2c20  hancement(self, 
-00001920: 696d 6729 3a0a 2020 2020 2020 2020 7365  img):.        se
-00001930: 6c66 2e6c 6f67 6765 722e 6465 6275 6728  lf.logger.debug(
-00001940: 2265 6e74 6572 2070 7265 6469 6374 5f65  "enter predict_e
-00001950: 6e68 616e 6365 6d65 6e74 2229 0a20 2020  nhancement").   
-00001960: 2020 2020 206d 6f64 656c 5f65 6e68 616e       model_enhan
-00001970: 6365 6d65 6e74 2c20 7365 7373 696f 6e5f  cement, session_
-00001980: 656e 6861 6e63 656d 656e 7420 3d20 7365  enhancement = se
-00001990: 6c66 2e73 7461 7274 5f6e 6577 5f73 6573  lf.start_new_ses
-000019a0: 7369 6f6e 5f61 6e64 5f6d 6f64 656c 2873  sion_and_model(s
-000019b0: 656c 662e 6d6f 6465 6c5f 6469 725f 6f66  elf.model_dir_of
-000019c0: 5f65 6e68 616e 6365 6d65 6e74 290a 0a20  _enhancement).. 
-000019d0: 2020 2020 2020 2069 6d67 5f68 6569 6768         img_heigh
-000019e0: 745f 6d6f 6465 6c20 3d20 6d6f 6465 6c5f  t_model = model_
-000019f0: 656e 6861 6e63 656d 656e 742e 6c61 7965  enhancement.laye
-00001a00: 7273 5b6c 656e 286d 6f64 656c 5f65 6e68  rs[len(model_enh
-00001a10: 616e 6365 6d65 6e74 2e6c 6179 6572 7329  ancement.layers)
-00001a20: 202d 2031 5d2e 6f75 7470 7574 5f73 6861   - 1].output_sha
-00001a30: 7065 5b31 5d0a 2020 2020 2020 2020 696d  pe[1].        im
-00001a40: 675f 7769 6474 685f 6d6f 6465 6c20 3d20  g_width_model = 
-00001a50: 6d6f 6465 6c5f 656e 6861 6e63 656d 656e  model_enhancemen
-00001a60: 742e 6c61 7965 7273 5b6c 656e 286d 6f64  t.layers[len(mod
-00001a70: 656c 5f65 6e68 616e 6365 6d65 6e74 2e6c  el_enhancement.l
-00001a80: 6179 6572 7329 202d 2031 5d2e 6f75 7470  ayers) - 1].outp
-00001a90: 7574 5f73 6861 7065 5b32 5d0a 2020 2020  ut_shape[2].    
-00001aa0: 2020 2020 6966 2069 6d67 2e73 6861 7065      if img.shape
-00001ab0: 5b30 5d20 3c20 696d 675f 6865 6967 6874  [0] < img_height
-00001ac0: 5f6d 6f64 656c 3a0a 2020 2020 2020 2020  _model:.        
-00001ad0: 2020 2020 696d 6720 3d20 6376 322e 7265      img = cv2.re
-00001ae0: 7369 7a65 2869 6d67 2c20 2869 6d67 2e73  size(img, (img.s
-00001af0: 6861 7065 5b31 5d2c 2069 6d67 5f77 6964  hape[1], img_wid
-00001b00: 7468 5f6d 6f64 656c 292c 2069 6e74 6572  th_model), inter
-00001b10: 706f 6c61 7469 6f6e 3d63 7632 2e49 4e54  polation=cv2.INT
-00001b20: 4552 5f4e 4541 5245 5354 290a 0a20 2020  ER_NEAREST)..   
-00001b30: 2020 2020 2069 6620 696d 672e 7368 6170       if img.shap
-00001b40: 655b 315d 203c 2069 6d67 5f77 6964 7468  e[1] < img_width
-00001b50: 5f6d 6f64 656c 3a0a 2020 2020 2020 2020  _model:.        
-00001b60: 2020 2020 696d 6720 3d20 6376 322e 7265      img = cv2.re
-00001b70: 7369 7a65 2869 6d67 2c20 2869 6d67 5f68  size(img, (img_h
-00001b80: 6569 6768 745f 6d6f 6465 6c2c 2069 6d67  eight_model, img
-00001b90: 2e73 6861 7065 5b30 5d29 2c20 696e 7465  .shape[0]), inte
-00001ba0: 7270 6f6c 6174 696f 6e3d 6376 322e 494e  rpolation=cv2.IN
-00001bb0: 5445 525f 4e45 4152 4553 5429 0a20 2020  TER_NEAREST).   
-00001bc0: 2020 2020 206d 6172 6769 6e20 3d20 696e       margin = in
-00001bd0: 7428 3020 2a20 696d 675f 7769 6474 685f  t(0 * img_width_
-00001be0: 6d6f 6465 6c29 0a20 2020 2020 2020 2077  model).        w
-00001bf0: 6964 7468 5f6d 6964 203d 2069 6d67 5f77  idth_mid = img_w
-00001c00: 6964 7468 5f6d 6f64 656c 202d 2032 202a  idth_model - 2 *
-00001c10: 206d 6172 6769 6e0a 2020 2020 2020 2020   margin.        
-00001c20: 6865 6967 6874 5f6d 6964 203d 2069 6d67  height_mid = img
-00001c30: 5f68 6569 6768 745f 6d6f 6465 6c20 2d20  _height_model - 
-00001c40: 3220 2a20 6d61 7267 696e 0a20 2020 2020  2 * margin.     
-00001c50: 2020 2069 6d67 203d 2069 6d67 202f 2066     img = img / f
-00001c60: 6c6f 6174 2832 3535 2e30 290a 0a20 2020  loat(255.0)..   
-00001c70: 2020 2020 2069 6d67 5f68 203d 2069 6d67       img_h = img
-00001c80: 2e73 6861 7065 5b30 5d0a 2020 2020 2020  .shape[0].      
-00001c90: 2020 696d 675f 7720 3d20 696d 672e 7368    img_w = img.sh
-00001ca0: 6170 655b 315d 0a0a 2020 2020 2020 2020  ape[1]..        
-00001cb0: 7072 6564 6963 7469 6f6e 5f74 7275 6520  prediction_true 
-00001cc0: 3d20 6e70 2e7a 6572 6f73 2828 696d 675f  = np.zeros((img_
-00001cd0: 682c 2069 6d67 5f77 2c20 3329 290a 2020  h, img_w, 3)).  
-00001ce0: 2020 2020 2020 6e78 6620 3d20 696d 675f        nxf = img_
-00001cf0: 7720 2f20 666c 6f61 7428 7769 6474 685f  w / float(width_
-00001d00: 6d69 6429 0a20 2020 2020 2020 206e 7966  mid).        nyf
-00001d10: 203d 2069 6d67 5f68 202f 2066 6c6f 6174   = img_h / float
-00001d20: 2868 6569 6768 745f 6d69 6429 0a0a 2020  (height_mid)..  
-00001d30: 2020 2020 2020 6e78 6620 3d20 696e 7428        nxf = int(
-00001d40: 6e78 6629 202b 2031 2069 6620 6e78 6620  nxf) + 1 if nxf 
-00001d50: 3e20 696e 7428 6e78 6629 2065 6c73 6520  > int(nxf) else 
-00001d60: 696e 7428 6e78 6629 0a20 2020 2020 2020  int(nxf).       
-00001d70: 206e 7966 203d 2069 6e74 286e 7966 2920   nyf = int(nyf) 
-00001d80: 2b20 3120 6966 206e 7966 203e 2069 6e74  + 1 if nyf > int
-00001d90: 286e 7966 2920 656c 7365 2069 6e74 286e  (nyf) else int(n
-00001da0: 7966 290a 0a20 2020 2020 2020 2066 6f72  yf)..        for
-00001db0: 2069 2069 6e20 7261 6e67 6528 6e78 6629   i in range(nxf)
-00001dc0: 3a0a 2020 2020 2020 2020 2020 2020 666f  :.            fo
-00001dd0: 7220 6a20 696e 2072 616e 6765 286e 7966  r j in range(nyf
-00001de0: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00001df0: 2020 2069 6620 6920 3d3d 2030 3a0a 2020     if i == 0:.  
-00001e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001e10: 2020 696e 6465 785f 785f 6420 3d20 6920    index_x_d = i 
-00001e20: 2a20 7769 6474 685f 6d69 640a 2020 2020  * width_mid.    
-00001e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001e40: 696e 6465 785f 785f 7520 3d20 696e 6465  index_x_u = inde
-00001e50: 785f 785f 6420 2b20 696d 675f 7769 6474  x_x_d + img_widt
-00001e60: 685f 6d6f 6465 6c0a 2020 2020 2020 2020  h_model.        
-00001e70: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00001e80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001e90: 2020 696e 6465 785f 785f 6420 3d20 6920    index_x_d = i 
-00001ea0: 2a20 7769 6474 685f 6d69 640a 2020 2020  * width_mid.    
-00001eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00001ec0: 696e 6465 785f 785f 7520 3d20 696e 6465  index_x_u = inde
-00001ed0: 785f 785f 6420 2b20 696d 675f 7769 6474  x_x_d + img_widt
-00001ee0: 685f 6d6f 6465 6c0a 2020 2020 2020 2020  h_model.        
-00001ef0: 2020 2020 2020 2020 6966 206a 203d 3d20          if j == 
-00001f00: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
-00001f10: 2020 2020 2020 2069 6e64 6578 5f79 5f64         index_y_d
-00001f20: 203d 206a 202a 2068 6569 6768 745f 6d69   = j * height_mi
-00001f30: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
-00001f40: 2020 2020 2020 696e 6465 785f 795f 7520        index_y_u 
-00001f50: 3d20 696e 6465 785f 795f 6420 2b20 696d  = index_y_d + im
-00001f60: 675f 6865 6967 6874 5f6d 6f64 656c 0a20  g_height_model. 
-00001f70: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00001f80: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00001f90: 2020 2020 2020 2020 2069 6e64 6578 5f79           index_y
-00001fa0: 5f64 203d 206a 202a 2068 6569 6768 745f  _d = j * height_
-00001fb0: 6d69 640a 2020 2020 2020 2020 2020 2020  mid.            
-00001fc0: 2020 2020 2020 2020 696e 6465 785f 795f          index_y_
-00001fd0: 7520 3d20 696e 6465 785f 795f 6420 2b20  u = index_y_d + 
-00001fe0: 696d 675f 6865 6967 6874 5f6d 6f64 656c  img_height_model
-00001ff0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00002000: 2020 6966 2069 6e64 6578 5f78 5f75 203e    if index_x_u >
-00002010: 2069 6d67 5f77 3a0a 2020 2020 2020 2020   img_w:.        
-00002020: 2020 2020 2020 2020 2020 2020 696e 6465              inde
-00002030: 785f 785f 7520 3d20 696d 675f 770a 2020  x_x_u = img_w.  
-00002040: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002050: 2020 696e 6465 785f 785f 6420 3d20 696d    index_x_d = im
-00002060: 675f 7720 2d20 696d 675f 7769 6474 685f  g_w - img_width_
-00002070: 6d6f 6465 6c0a 2020 2020 2020 2020 2020  model.          
-00002080: 2020 2020 2020 6966 2069 6e64 6578 5f79        if index_y
-00002090: 5f75 203e 2069 6d67 5f68 3a0a 2020 2020  _u > img_h:.    
-000020a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000020b0: 696e 6465 785f 795f 7520 3d20 696d 675f  index_y_u = img_
-000020c0: 680a 2020 2020 2020 2020 2020 2020 2020  h.              
-000020d0: 2020 2020 2020 696e 6465 785f 795f 6420        index_y_d 
-000020e0: 3d20 696d 675f 6820 2d20 696d 675f 6865  = img_h - img_he
-000020f0: 6967 6874 5f6d 6f64 656c 0a0a 2020 2020  ight_model..    
-00002100: 2020 2020 2020 2020 2020 2020 696d 675f              img_
-00002110: 7061 7463 6820 3d20 696d 675b 696e 6465  patch = img[inde
-00002120: 785f 795f 643a 696e 6465 785f 795f 752c  x_y_d:index_y_u,
-00002130: 2069 6e64 6578 5f78 5f64 3a69 6e64 6578   index_x_d:index
-00002140: 5f78 5f75 2c20 3a5d 0a20 2020 2020 2020  _x_u, :].       
-00002150: 2020 2020 2020 2020 206c 6162 656c 5f70           label_p
-00002160: 5f70 7265 6420 3d20 6d6f 6465 6c5f 656e  _pred = model_en
-00002170: 6861 6e63 656d 656e 742e 7072 6564 6963  hancement.predic
-00002180: 7428 696d 675f 7061 7463 682e 7265 7368  t(img_patch.resh
-00002190: 6170 6528 312c 2069 6d67 5f70 6174 6368  ape(1, img_patch
-000021a0: 2e73 6861 7065 5b30 5d2c 2069 6d67 5f70  .shape[0], img_p
-000021b0: 6174 6368 2e73 6861 7065 5b31 5d2c 2069  atch.shape[1], i
-000021c0: 6d67 5f70 6174 6368 2e73 6861 7065 5b32  mg_patch.shape[2
-000021d0: 5d29 2c0a 2020 2020 2020 2020 2020 2020  ]),.            
-000021e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000021f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002200: 2020 2020 2020 2020 2020 2020 2076 6572               ver
-00002210: 626f 7365 3d30 290a 0a20 2020 2020 2020  bose=0)..       
-00002220: 2020 2020 2020 2020 2073 6567 203d 206c           seg = l
-00002230: 6162 656c 5f70 5f70 7265 645b 302c 203a  abel_p_pred[0, :
-00002240: 2c20 3a2c 203a 5d0a 2020 2020 2020 2020  , :, :].        
-00002250: 2020 2020 2020 2020 7365 6720 3d20 7365          seg = se
-00002260: 6720 2a20 3235 350a 0a20 2020 2020 2020  g * 255..       
-00002270: 2020 2020 2020 2020 2069 6620 6920 3d3d           if i ==
-00002280: 2030 2061 6e64 206a 203d 3d20 303a 0a20   0 and j == 0:. 
-00002290: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000022a0: 2020 2073 6567 203d 2073 6567 5b30 203a     seg = seg[0 :
-000022b0: 2073 6567 2e73 6861 7065 5b30 5d20 2d20   seg.shape[0] - 
-000022c0: 6d61 7267 696e 2c20 3020 3a20 7365 672e  margin, 0 : seg.
-000022d0: 7368 6170 655b 315d 202d 206d 6172 6769  shape[1] - margi
-000022e0: 6e5d 0a20 2020 2020 2020 2020 2020 2020  n].             
-000022f0: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
-00002300: 6e5f 7472 7565 5b69 6e64 6578 5f79 5f64  n_true[index_y_d
-00002310: 202b 2030 203a 2069 6e64 6578 5f79 5f75   + 0 : index_y_u
-00002320: 202d 206d 6172 6769 6e2c 2069 6e64 6578   - margin, index
-00002330: 5f78 5f64 202b 2030 203a 2069 6e64 6578  _x_d + 0 : index
-00002340: 5f78 5f75 202d 206d 6172 6769 6e2c 203a  _x_u - margin, :
-00002350: 5d20 3d20 7365 670a 2020 2020 2020 2020  ] = seg.        
-00002360: 2020 2020 2020 2020 656c 6966 2069 203d          elif i =
-00002370: 3d20 6e78 6620 2d20 3120 616e 6420 6a20  = nxf - 1 and j 
-00002380: 3d3d 206e 7966 202d 2031 3a0a 2020 2020  == nyf - 1:.    
-00002390: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000023a0: 7365 6720 3d20 7365 675b 6d61 7267 696e  seg = seg[margin
-000023b0: 203a 2073 6567 2e73 6861 7065 5b30 5d20   : seg.shape[0] 
-000023c0: 2d20 302c 206d 6172 6769 6e20 3a20 7365  - 0, margin : se
-000023d0: 672e 7368 6170 655b 315d 202d 2030 5d0a  g.shape[1] - 0].
-000023e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000023f0: 2020 2020 7072 6564 6963 7469 6f6e 5f74      prediction_t
-00002400: 7275 655b 696e 6465 785f 795f 6420 2b20  rue[index_y_d + 
-00002410: 6d61 7267 696e 203a 2069 6e64 6578 5f79  margin : index_y
-00002420: 5f75 202d 2030 2c20 696e 6465 785f 785f  _u - 0, index_x_
-00002430: 6420 2b20 6d61 7267 696e 203a 2069 6e64  d + margin : ind
-00002440: 6578 5f78 5f75 202d 2030 2c20 3a5d 203d  ex_x_u - 0, :] =
-00002450: 2073 6567 0a20 2020 2020 2020 2020 2020   seg.           
-00002460: 2020 2020 2065 6c69 6620 6920 3d3d 2030       elif i == 0
-00002470: 2061 6e64 206a 203d 3d20 6e79 6620 2d20   and j == nyf - 
-00002480: 313a 0a20 2020 2020 2020 2020 2020 2020  1:.             
-00002490: 2020 2020 2020 2073 6567 203d 2073 6567         seg = seg
-000024a0: 5b6d 6172 6769 6e20 3a20 7365 672e 7368  [margin : seg.sh
-000024b0: 6170 655b 305d 202d 2030 2c20 3020 3a20  ape[0] - 0, 0 : 
-000024c0: 7365 672e 7368 6170 655b 315d 202d 206d  seg.shape[1] - m
-000024d0: 6172 6769 6e5d 0a20 2020 2020 2020 2020  argin].         
-000024e0: 2020 2020 2020 2020 2020 2070 7265 6469             predi
-000024f0: 6374 696f 6e5f 7472 7565 5b69 6e64 6578  ction_true[index
-00002500: 5f79 5f64 202b 206d 6172 6769 6e20 3a20  _y_d + margin : 
-00002510: 696e 6465 785f 795f 7520 2d20 302c 2069  index_y_u - 0, i
-00002520: 6e64 6578 5f78 5f64 202b 2030 203a 2069  ndex_x_d + 0 : i
-00002530: 6e64 6578 5f78 5f75 202d 206d 6172 6769  ndex_x_u - margi
-00002540: 6e2c 203a 5d20 3d20 7365 670a 2020 2020  n, :] = seg.    
-00002550: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00002560: 2069 203d 3d20 6e78 6620 2d20 3120 616e   i == nxf - 1 an
-00002570: 6420 6a20 3d3d 2030 3a0a 2020 2020 2020  d j == 0:.      
-00002580: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00002590: 6720 3d20 7365 675b 3020 3a20 7365 672e  g = seg[0 : seg.
-000025a0: 7368 6170 655b 305d 202d 206d 6172 6769  shape[0] - margi
-000025b0: 6e2c 206d 6172 6769 6e20 3a20 7365 672e  n, margin : seg.
-000025c0: 7368 6170 655b 315d 202d 2030 5d0a 2020  shape[1] - 0].  
-000025d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000025e0: 2020 7072 6564 6963 7469 6f6e 5f74 7275    prediction_tru
-000025f0: 655b 696e 6465 785f 795f 6420 2b20 3020  e[index_y_d + 0 
-00002600: 3a20 696e 6465 785f 795f 7520 2d20 6d61  : index_y_u - ma
-00002610: 7267 696e 2c20 696e 6465 785f 785f 6420  rgin, index_x_d 
-00002620: 2b20 6d61 7267 696e 203a 2069 6e64 6578  + margin : index
-00002630: 5f78 5f75 202d 2030 2c20 3a5d 203d 2073  _x_u - 0, :] = s
-00002640: 6567 0a20 2020 2020 2020 2020 2020 2020  eg.             
-00002650: 2020 2065 6c69 6620 6920 3d3d 2030 2061     elif i == 0 a
-00002660: 6e64 206a 2021 3d20 3020 616e 6420 6a20  nd j != 0 and j 
-00002670: 213d 206e 7966 202d 2031 3a0a 2020 2020  != nyf - 1:.    
-00002680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00002690: 7365 6720 3d20 7365 675b 6d61 7267 696e  seg = seg[margin
-000026a0: 203a 2073 6567 2e73 6861 7065 5b30 5d20   : seg.shape[0] 
-000026b0: 2d20 6d61 7267 696e 2c20 3020 3a20 7365  - margin, 0 : se
-000026c0: 672e 7368 6170 655b 315d 202d 206d 6172  g.shape[1] - mar
-000026d0: 6769 6e5d 0a20 2020 2020 2020 2020 2020  gin].           
-000026e0: 2020 2020 2020 2020 2070 7265 6469 6374           predict
-000026f0: 696f 6e5f 7472 7565 5b69 6e64 6578 5f79  ion_true[index_y
-00002700: 5f64 202b 206d 6172 6769 6e20 3a20 696e  _d + margin : in
-00002710: 6465 785f 795f 7520 2d20 6d61 7267 696e  dex_y_u - margin
-00002720: 2c20 696e 6465 785f 785f 6420 2b20 3020  , index_x_d + 0 
-00002730: 3a20 696e 6465 785f 785f 7520 2d20 6d61  : index_x_u - ma
-00002740: 7267 696e 2c20 3a5d 203d 2073 6567 0a20  rgin, :] = seg. 
-00002750: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00002760: 6c69 6620 6920 3d3d 206e 7866 202d 2031  lif i == nxf - 1
-00002770: 2061 6e64 206a 2021 3d20 3020 616e 6420   and j != 0 and 
-00002780: 6a20 213d 206e 7966 202d 2031 3a0a 2020  j != nyf - 1:.  
-00002790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000027a0: 2020 7365 6720 3d20 7365 675b 6d61 7267    seg = seg[marg
-000027b0: 696e 203a 2073 6567 2e73 6861 7065 5b30  in : seg.shape[0
-000027c0: 5d20 2d20 6d61 7267 696e 2c20 6d61 7267  ] - margin, marg
-000027d0: 696e 203a 2073 6567 2e73 6861 7065 5b31  in : seg.shape[1
-000027e0: 5d20 2d20 305d 0a20 2020 2020 2020 2020  ] - 0].         
-000027f0: 2020 2020 2020 2020 2020 2070 7265 6469             predi
-00002800: 6374 696f 6e5f 7472 7565 5b69 6e64 6578  ction_true[index
-00002810: 5f79 5f64 202b 206d 6172 6769 6e20 3a20  _y_d + margin : 
-00002820: 696e 6465 785f 795f 7520 2d20 6d61 7267  index_y_u - marg
-00002830: 696e 2c20 696e 6465 785f 785f 6420 2b20  in, index_x_d + 
-00002840: 6d61 7267 696e 203a 2069 6e64 6578 5f78  margin : index_x
-00002850: 5f75 202d 2030 2c20 3a5d 203d 2073 6567  _u - 0, :] = seg
-00002860: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00002870: 2065 6c69 6620 6920 213d 2030 2061 6e64   elif i != 0 and
-00002880: 2069 2021 3d20 6e78 6620 2d20 3120 616e   i != nxf - 1 an
-00002890: 6420 6a20 3d3d 2030 3a0a 2020 2020 2020  d j == 0:.      
-000028a0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-000028b0: 6720 3d20 7365 675b 3020 3a20 7365 672e  g = seg[0 : seg.
-000028c0: 7368 6170 655b 305d 202d 206d 6172 6769  shape[0] - margi
-000028d0: 6e2c 206d 6172 6769 6e20 3a20 7365 672e  n, margin : seg.
-000028e0: 7368 6170 655b 315d 202d 206d 6172 6769  shape[1] - margi
-000028f0: 6e5d 0a20 2020 2020 2020 2020 2020 2020  n].             
-00002900: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
-00002910: 6e5f 7472 7565 5b69 6e64 6578 5f79 5f64  n_true[index_y_d
-00002920: 202b 2030 203a 2069 6e64 6578 5f79 5f75   + 0 : index_y_u
-00002930: 202d 206d 6172 6769 6e2c 2069 6e64 6578   - margin, index
-00002940: 5f78 5f64 202b 206d 6172 6769 6e20 3a20  _x_d + margin : 
-00002950: 696e 6465 785f 785f 7520 2d20 6d61 7267  index_x_u - marg
-00002960: 696e 2c20 3a5d 203d 2073 6567 0a20 2020  in, :] = seg.   
-00002970: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
-00002980: 6620 6920 213d 2030 2061 6e64 2069 2021  f i != 0 and i !
-00002990: 3d20 6e78 6620 2d20 3120 616e 6420 6a20  = nxf - 1 and j 
-000029a0: 3d3d 206e 7966 202d 2031 3a0a 2020 2020  == nyf - 1:.    
-000029b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000029c0: 7365 6720 3d20 7365 675b 6d61 7267 696e  seg = seg[margin
-000029d0: 203a 2073 6567 2e73 6861 7065 5b30 5d20   : seg.shape[0] 
-000029e0: 2d20 302c 206d 6172 6769 6e20 3a20 7365  - 0, margin : se
-000029f0: 672e 7368 6170 655b 315d 202d 206d 6172  g.shape[1] - mar
-00002a00: 6769 6e5d 0a20 2020 2020 2020 2020 2020  gin].           
-00002a10: 2020 2020 2020 2020 2070 7265 6469 6374           predict
-00002a20: 696f 6e5f 7472 7565 5b69 6e64 6578 5f79  ion_true[index_y
-00002a30: 5f64 202b 206d 6172 6769 6e20 3a20 696e  _d + margin : in
-00002a40: 6465 785f 795f 7520 2d20 302c 2069 6e64  dex_y_u - 0, ind
-00002a50: 6578 5f78 5f64 202b 206d 6172 6769 6e20  ex_x_d + margin 
-00002a60: 3a20 696e 6465 785f 785f 7520 2d20 6d61  : index_x_u - ma
-00002a70: 7267 696e 2c20 3a5d 203d 2073 6567 0a20  rgin, :] = seg. 
-00002a80: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00002a90: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00002aa0: 2020 2020 2020 2020 2073 6567 203d 2073           seg = s
-00002ab0: 6567 5b6d 6172 6769 6e20 3a20 7365 672e  eg[margin : seg.
-00002ac0: 7368 6170 655b 305d 202d 206d 6172 6769  shape[0] - margi
-00002ad0: 6e2c 206d 6172 6769 6e20 3a20 7365 672e  n, margin : seg.
-00002ae0: 7368 6170 655b 315d 202d 206d 6172 6769  shape[1] - margi
-00002af0: 6e5d 0a20 2020 2020 2020 2020 2020 2020  n].             
-00002b00: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
-00002b10: 6e5f 7472 7565 5b69 6e64 6578 5f79 5f64  n_true[index_y_d
-00002b20: 202b 206d 6172 6769 6e20 3a20 696e 6465   + margin : inde
-00002b30: 785f 795f 7520 2d20 6d61 7267 696e 2c20  x_y_u - margin, 
-00002b40: 696e 6465 785f 785f 6420 2b20 6d61 7267  index_x_d + marg
-00002b50: 696e 203a 2069 6e64 6578 5f78 5f75 202d  in : index_x_u -
-00002b60: 206d 6172 6769 6e2c 203a 5d20 3d20 7365   margin, :] = se
-00002b70: 670a 0a20 2020 2020 2020 2070 7265 6469  g..        predi
-00002b80: 6374 696f 6e5f 7472 7565 203d 2070 7265  ction_true = pre
-00002b90: 6469 6374 696f 6e5f 7472 7565 2e61 7374  diction_true.ast
-00002ba0: 7970 6528 696e 7429 0a20 2020 2020 2020  ype(int).       
-00002bb0: 2072 6574 7572 6e20 7072 6564 6963 7469   return predicti
-00002bc0: 6f6e 5f74 7275 650a 0a20 2020 2064 6566  on_true..    def
-00002bd0: 2063 616c 6375 6c61 7465 5f77 6964 7468   calculate_width
-00002be0: 5f68 6569 6768 745f 6279 5f63 6f6c 756d  _height_by_colum
-00002bf0: 6e73 2873 656c 662c 2069 6d67 2c20 6e75  ns(self, img, nu
-00002c00: 6d5f 636f 6c2c 2077 6964 7468 5f65 6172  m_col, width_ear
-00002c10: 6c79 2c20 6c61 6265 6c5f 705f 7072 6564  ly, label_p_pred
-00002c20: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00002c30: 6c6f 6767 6572 2e64 6562 7567 2822 656e  logger.debug("en
-00002c40: 7465 7220 6361 6c63 756c 6174 655f 7769  ter calculate_wi
-00002c50: 6474 685f 6865 6967 6874 5f62 795f 636f  dth_height_by_co
-00002c60: 6c75 6d6e 7322 290a 2020 2020 2020 2020  lumns").        
-00002c70: 6966 206e 756d 5f63 6f6c 203d 3d20 3120  if num_col == 1 
-00002c80: 616e 6420 7769 6474 685f 6561 726c 7920  and width_early 
-00002c90: 3c20 3131 3030 3a0a 2020 2020 2020 2020  < 1100:.        
-00002ca0: 2020 2020 696d 675f 775f 6e65 7720 3d20      img_w_new = 
-00002cb0: 3230 3030 0a20 2020 2020 2020 2020 2020  2000.           
-00002cc0: 2069 6d67 5f68 5f6e 6577 203d 2069 6e74   img_h_new = int
-00002cd0: 2869 6d67 2e73 6861 7065 5b30 5d20 2f20  (img.shape[0] / 
-00002ce0: 666c 6f61 7428 696d 672e 7368 6170 655b  float(img.shape[
-00002cf0: 315d 2920 2a20 3230 3030 290a 2020 2020  1]) * 2000).    
-00002d00: 2020 2020 656c 6966 206e 756d 5f63 6f6c      elif num_col
-00002d10: 203d 3d20 3120 616e 6420 7769 6474 685f   == 1 and width_
-00002d20: 6561 726c 7920 3e3d 2032 3530 303a 0a20  early >= 2500:. 
-00002d30: 2020 2020 2020 2020 2020 2069 6d67 5f77             img_w
-00002d40: 5f6e 6577 203d 2032 3030 300a 2020 2020  _new = 2000.    
-00002d50: 2020 2020 2020 2020 696d 675f 685f 6e65          img_h_ne
-00002d60: 7720 3d20 696e 7428 696d 672e 7368 6170  w = int(img.shap
-00002d70: 655b 305d 202f 2066 6c6f 6174 2869 6d67  e[0] / float(img
-00002d80: 2e73 6861 7065 5b31 5d29 202a 2032 3030  .shape[1]) * 200
-00002d90: 3029 0a20 2020 2020 2020 2065 6c69 6620  0).        elif 
-00002da0: 6e75 6d5f 636f 6c20 3d3d 2031 2061 6e64  num_col == 1 and
-00002db0: 2077 6964 7468 5f65 6172 6c79 203e 3d20   width_early >= 
-00002dc0: 3131 3030 2061 6e64 2077 6964 7468 5f65  1100 and width_e
-00002dd0: 6172 6c79 203c 2032 3530 303a 0a20 2020  arly < 2500:.   
-00002de0: 2020 2020 2020 2020 2069 6d67 5f77 5f6e           img_w_n
-00002df0: 6577 203d 2077 6964 7468 5f65 6172 6c79  ew = width_early
-00002e00: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
-00002e10: 5f68 5f6e 6577 203d 2069 6e74 2869 6d67  _h_new = int(img
-00002e20: 2e73 6861 7065 5b30 5d20 2f20 666c 6f61  .shape[0] / floa
-00002e30: 7428 696d 672e 7368 6170 655b 315d 2920  t(img.shape[1]) 
-00002e40: 2a20 7769 6474 685f 6561 726c 7929 0a20  * width_early). 
-00002e50: 2020 2020 2020 2065 6c69 6620 6e75 6d5f         elif num_
-00002e60: 636f 6c20 3d3d 2032 2061 6e64 2077 6964  col == 2 and wid
-00002e70: 7468 5f65 6172 6c79 203c 2032 3030 303a  th_early < 2000:
-00002e80: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
-00002e90: 5f77 5f6e 6577 203d 2032 3430 300a 2020  _w_new = 2400.  
-00002ea0: 2020 2020 2020 2020 2020 696d 675f 685f            img_h_
-00002eb0: 6e65 7720 3d20 696e 7428 696d 672e 7368  new = int(img.sh
-00002ec0: 6170 655b 305d 202f 2066 6c6f 6174 2869  ape[0] / float(i
-00002ed0: 6d67 2e73 6861 7065 5b31 5d29 202a 2032  mg.shape[1]) * 2
-00002ee0: 3430 3029 0a20 2020 2020 2020 2065 6c69  400).        eli
-00002ef0: 6620 6e75 6d5f 636f 6c20 3d3d 2032 2061  f num_col == 2 a
-00002f00: 6e64 2077 6964 7468 5f65 6172 6c79 203e  nd width_early >
-00002f10: 3d20 3335 3030 3a0a 2020 2020 2020 2020  = 3500:.        
-00002f20: 2020 2020 696d 675f 775f 6e65 7720 3d20      img_w_new = 
-00002f30: 3234 3030 0a20 2020 2020 2020 2020 2020  2400.           
-00002f40: 2069 6d67 5f68 5f6e 6577 203d 2069 6e74   img_h_new = int
-00002f50: 2869 6d67 2e73 6861 7065 5b30 5d20 2f20  (img.shape[0] / 
-00002f60: 666c 6f61 7428 696d 672e 7368 6170 655b  float(img.shape[
-00002f70: 315d 2920 2a20 3234 3030 290a 2020 2020  1]) * 2400).    
-00002f80: 2020 2020 656c 6966 206e 756d 5f63 6f6c      elif num_col
-00002f90: 203d 3d20 3220 616e 6420 7769 6474 685f   == 2 and width_
-00002fa0: 6561 726c 7920 3e3d 2032 3030 3020 616e  early >= 2000 an
-00002fb0: 6420 7769 6474 685f 6561 726c 7920 3c20  d width_early < 
-00002fc0: 3335 3030 3a0a 2020 2020 2020 2020 2020  3500:.          
-00002fd0: 2020 696d 675f 775f 6e65 7720 3d20 7769    img_w_new = wi
-00002fe0: 6474 685f 6561 726c 790a 2020 2020 2020  dth_early.      
-00002ff0: 2020 2020 2020 696d 675f 685f 6e65 7720        img_h_new 
-00003000: 3d20 696e 7428 696d 672e 7368 6170 655b  = int(img.shape[
-00003010: 305d 202f 2066 6c6f 6174 2869 6d67 2e73  0] / float(img.s
-00003020: 6861 7065 5b31 5d29 202a 2077 6964 7468  hape[1]) * width
-00003030: 5f65 6172 6c79 290a 2020 2020 2020 2020  _early).        
-00003040: 656c 6966 206e 756d 5f63 6f6c 203d 3d20  elif num_col == 
-00003050: 3320 616e 6420 7769 6474 685f 6561 726c  3 and width_earl
-00003060: 7920 3c20 3230 3030 3a0a 2020 2020 2020  y < 2000:.      
-00003070: 2020 2020 2020 696d 675f 775f 6e65 7720        img_w_new 
-00003080: 3d20 3330 3030 0a20 2020 2020 2020 2020  = 3000.         
-00003090: 2020 2069 6d67 5f68 5f6e 6577 203d 2069     img_h_new = i
-000030a0: 6e74 2869 6d67 2e73 6861 7065 5b30 5d20  nt(img.shape[0] 
-000030b0: 2f20 666c 6f61 7428 696d 672e 7368 6170  / float(img.shap
-000030c0: 655b 315d 2920 2a20 3330 3030 290a 2020  e[1]) * 3000).  
-000030d0: 2020 2020 2020 656c 6966 206e 756d 5f63        elif num_c
-000030e0: 6f6c 203d 3d20 3320 616e 6420 7769 6474  ol == 3 and widt
-000030f0: 685f 6561 726c 7920 3e3d 2034 3030 303a  h_early >= 4000:
-00003100: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
-00003110: 5f77 5f6e 6577 203d 2033 3030 300a 2020  _w_new = 3000.  
-00003120: 2020 2020 2020 2020 2020 696d 675f 685f            img_h_
-00003130: 6e65 7720 3d20 696e 7428 696d 672e 7368  new = int(img.sh
-00003140: 6170 655b 305d 202f 2066 6c6f 6174 2869  ape[0] / float(i
-00003150: 6d67 2e73 6861 7065 5b31 5d29 202a 2033  mg.shape[1]) * 3
-00003160: 3030 3029 0a20 2020 2020 2020 2065 6c69  000).        eli
-00003170: 6620 6e75 6d5f 636f 6c20 3d3d 2033 2061  f num_col == 3 a
-00003180: 6e64 2077 6964 7468 5f65 6172 6c79 203e  nd width_early >
-00003190: 3d20 3230 3030 2061 6e64 2077 6964 7468  = 2000 and width
-000031a0: 5f65 6172 6c79 203c 2034 3030 303a 0a20  _early < 4000:. 
-000031b0: 2020 2020 2020 2020 2020 2069 6d67 5f77             img_w
-000031c0: 5f6e 6577 203d 2077 6964 7468 5f65 6172  _new = width_ear
-000031d0: 6c79 0a20 2020 2020 2020 2020 2020 2069  ly.            i
-000031e0: 6d67 5f68 5f6e 6577 203d 2069 6e74 2869  mg_h_new = int(i
-000031f0: 6d67 2e73 6861 7065 5b30 5d20 2f20 666c  mg.shape[0] / fl
-00003200: 6f61 7428 696d 672e 7368 6170 655b 315d  oat(img.shape[1]
-00003210: 2920 2a20 7769 6474 685f 6561 726c 7929  ) * width_early)
-00003220: 0a20 2020 2020 2020 2065 6c69 6620 6e75  .        elif nu
-00003230: 6d5f 636f 6c20 3d3d 2034 2061 6e64 2077  m_col == 4 and w
-00003240: 6964 7468 5f65 6172 6c79 203c 2032 3530  idth_early < 250
-00003250: 303a 0a20 2020 2020 2020 2020 2020 2069  0:.            i
-00003260: 6d67 5f77 5f6e 6577 203d 2034 3030 300a  mg_w_new = 4000.
-00003270: 2020 2020 2020 2020 2020 2020 696d 675f              img_
-00003280: 685f 6e65 7720 3d20 696e 7428 696d 672e  h_new = int(img.
-00003290: 7368 6170 655b 305d 202f 2066 6c6f 6174  shape[0] / float
-000032a0: 2869 6d67 2e73 6861 7065 5b31 5d29 202a  (img.shape[1]) *
-000032b0: 2034 3030 3029 0a20 2020 2020 2020 2065   4000).        e
-000032c0: 6c69 6620 6e75 6d5f 636f 6c20 3d3d 2034  lif num_col == 4
-000032d0: 2061 6e64 2077 6964 7468 5f65 6172 6c79   and width_early
-000032e0: 203e 3d20 3530 3030 3a0a 2020 2020 2020   >= 5000:.      
-000032f0: 2020 2020 2020 696d 675f 775f 6e65 7720        img_w_new 
-00003300: 3d20 3430 3030 0a20 2020 2020 2020 2020  = 4000.         
-00003310: 2020 2069 6d67 5f68 5f6e 6577 203d 2069     img_h_new = i
-00003320: 6e74 2869 6d67 2e73 6861 7065 5b30 5d20  nt(img.shape[0] 
-00003330: 2f20 666c 6f61 7428 696d 672e 7368 6170  / float(img.shap
-00003340: 655b 315d 2920 2a20 3430 3030 290a 2020  e[1]) * 4000).  
-00003350: 2020 2020 2020 656c 6966 206e 756d 5f63        elif num_c
-00003360: 6f6c 203d 3d20 3420 616e 6420 7769 6474  ol == 4 and widt
-00003370: 685f 6561 726c 7920 3e3d 2032 3530 3020  h_early >= 2500 
-00003380: 616e 6420 7769 6474 685f 6561 726c 7920  and width_early 
-00003390: 3c20 3530 3030 3a0a 2020 2020 2020 2020  < 5000:.        
-000033a0: 2020 2020 696d 675f 775f 6e65 7720 3d20      img_w_new = 
-000033b0: 7769 6474 685f 6561 726c 790a 2020 2020  width_early.    
-000033c0: 2020 2020 2020 2020 696d 675f 685f 6e65          img_h_ne
-000033d0: 7720 3d20 696e 7428 696d 672e 7368 6170  w = int(img.shap
-000033e0: 655b 305d 202f 2066 6c6f 6174 2869 6d67  e[0] / float(img
-000033f0: 2e73 6861 7065 5b31 5d29 202a 2077 6964  .shape[1]) * wid
-00003400: 7468 5f65 6172 6c79 290a 2020 2020 2020  th_early).      
-00003410: 2020 656c 6966 206e 756d 5f63 6f6c 203d    elif num_col =
-00003420: 3d20 3520 616e 6420 7769 6474 685f 6561  = 5 and width_ea
-00003430: 726c 7920 3c20 3337 3030 3a0a 2020 2020  rly < 3700:.    
-00003440: 2020 2020 2020 2020 696d 675f 775f 6e65          img_w_ne
-00003450: 7720 3d20 3530 3030 0a20 2020 2020 2020  w = 5000.       
-00003460: 2020 2020 2069 6d67 5f68 5f6e 6577 203d       img_h_new =
-00003470: 2069 6e74 2869 6d67 2e73 6861 7065 5b30   int(img.shape[0
-00003480: 5d20 2f20 666c 6f61 7428 696d 672e 7368  ] / float(img.sh
-00003490: 6170 655b 315d 2920 2a20 3530 3030 290a  ape[1]) * 5000).
-000034a0: 2020 2020 2020 2020 656c 6966 206e 756d          elif num
-000034b0: 5f63 6f6c 203d 3d20 3520 616e 6420 7769  _col == 5 and wi
-000034c0: 6474 685f 6561 726c 7920 3e3d 2037 3030  dth_early >= 700
-000034d0: 303a 0a20 2020 2020 2020 2020 2020 2069  0:.            i
-000034e0: 6d67 5f77 5f6e 6577 203d 2035 3030 300a  mg_w_new = 5000.
-000034f0: 2020 2020 2020 2020 2020 2020 696d 675f              img_
-00003500: 685f 6e65 7720 3d20 696e 7428 696d 672e  h_new = int(img.
-00003510: 7368 6170 655b 305d 202f 2066 6c6f 6174  shape[0] / float
-00003520: 2869 6d67 2e73 6861 7065 5b31 5d29 202a  (img.shape[1]) *
-00003530: 2035 3030 3029 0a20 2020 2020 2020 2065   5000).        e
-00003540: 6c69 6620 6e75 6d5f 636f 6c20 3d3d 2035  lif num_col == 5
-00003550: 2061 6e64 2077 6964 7468 5f65 6172 6c79   and width_early
-00003560: 203e 3d20 3337 3030 2061 6e64 2077 6964   >= 3700 and wid
-00003570: 7468 5f65 6172 6c79 203c 2037 3030 303a  th_early < 7000:
-00003580: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
-00003590: 5f77 5f6e 6577 203d 2077 6964 7468 5f65  _w_new = width_e
-000035a0: 6172 6c79 0a20 2020 2020 2020 2020 2020  arly.           
-000035b0: 2069 6d67 5f68 5f6e 6577 203d 2069 6e74   img_h_new = int
-000035c0: 2869 6d67 2e73 6861 7065 5b30 5d20 2f20  (img.shape[0] / 
-000035d0: 666c 6f61 7428 696d 672e 7368 6170 655b  float(img.shape[
-000035e0: 315d 2920 2a20 7769 6474 685f 6561 726c  1]) * width_earl
-000035f0: 7929 0a20 2020 2020 2020 2065 6c69 6620  y).        elif 
-00003600: 6e75 6d5f 636f 6c20 3d3d 2036 2061 6e64  num_col == 6 and
-00003610: 2077 6964 7468 5f65 6172 6c79 203c 2034   width_early < 4
-00003620: 3530 303a 0a20 2020 2020 2020 2020 2020  500:.           
-00003630: 2069 6d67 5f77 5f6e 6577 203d 2036 3530   img_w_new = 650
-00003640: 3020 2023 2035 3430 300a 2020 2020 2020  0  # 5400.      
-00003650: 2020 2020 2020 696d 675f 685f 6e65 7720        img_h_new 
-00003660: 3d20 696e 7428 696d 672e 7368 6170 655b  = int(img.shape[
-00003670: 305d 202f 2066 6c6f 6174 2869 6d67 2e73  0] / float(img.s
-00003680: 6861 7065 5b31 5d29 202a 2036 3530 3029  hape[1]) * 6500)
-00003690: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-000036a0: 2020 2020 2020 2020 2020 2069 6d67 5f77             img_w
-000036b0: 5f6e 6577 203d 2077 6964 7468 5f65 6172  _new = width_ear
-000036c0: 6c79 0a20 2020 2020 2020 2020 2020 2069  ly.            i
-000036d0: 6d67 5f68 5f6e 6577 203d 2069 6e74 2869  mg_h_new = int(i
-000036e0: 6d67 2e73 6861 7065 5b30 5d20 2f20 666c  mg.shape[0] / fl
-000036f0: 6f61 7428 696d 672e 7368 6170 655b 315d  oat(img.shape[1]
-00003700: 2920 2a20 7769 6474 685f 6561 726c 7929  ) * width_early)
-00003710: 0a0a 2020 2020 2020 2020 6966 206c 6162  ..        if lab
-00003720: 656c 5f70 5f70 7265 645b 305d 5b69 6e74  el_p_pred[0][int
-00003730: 286e 756d 5f63 6f6c 202d 2031 295d 203c  (num_col - 1)] <
-00003740: 2030 2e39 2061 6e64 2069 6d67 5f77 5f6e   0.9 and img_w_n
-00003750: 6577 203c 2077 6964 7468 5f65 6172 6c79  ew < width_early
-00003760: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
-00003770: 675f 6e65 7720 3d20 6e70 2e63 6f70 7928  g_new = np.copy(
-00003780: 696d 6729 0a20 2020 2020 2020 2020 2020  img).           
-00003790: 206e 756d 5f63 6f6c 756d 6e5f 6973 5f63   num_column_is_c
-000037a0: 6c61 7373 6966 6965 6420 3d20 4661 6c73  lassified = Fals
-000037b0: 650a 2020 2020 2020 2020 656c 7365 3a0a  e.        else:.
-000037c0: 2020 2020 2020 2020 2020 2020 696d 675f              img_
-000037d0: 6e65 7720 3d20 7265 7369 7a65 5f69 6d61  new = resize_ima
-000037e0: 6765 2869 6d67 2c20 696d 675f 685f 6e65  ge(img, img_h_ne
-000037f0: 772c 2069 6d67 5f77 5f6e 6577 290a 2020  w, img_w_new).  
-00003800: 2020 2020 2020 2020 2020 6e75 6d5f 636f            num_co
-00003810: 6c75 6d6e 5f69 735f 636c 6173 7369 6669  lumn_is_classifi
-00003820: 6564 203d 2054 7275 650a 0a20 2020 2020  ed = True..     
-00003830: 2020 2072 6574 7572 6e20 696d 675f 6e65     return img_ne
-00003840: 772c 206e 756d 5f63 6f6c 756d 6e5f 6973  w, num_column_is
-00003850: 5f63 6c61 7373 6966 6965 640a 0a20 2020  _classified..   
-00003860: 2064 6566 2072 6573 697a 655f 696d 6167   def resize_imag
-00003870: 655f 7769 7468 5f63 6f6c 756d 6e5f 636c  e_with_column_cl
-00003880: 6173 7369 6669 6572 2873 656c 662c 2069  assifier(self, i
-00003890: 735f 696d 6167 655f 656e 6861 6e63 6564  s_image_enhanced
-000038a0: 2c20 696d 675f 6269 6e29 3a0a 2020 2020  , img_bin):.    
-000038b0: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
-000038c0: 6465 6275 6728 2265 6e74 6572 2072 6573  debug("enter res
-000038d0: 697a 655f 696d 6167 655f 7769 7468 5f63  ize_image_with_c
-000038e0: 6f6c 756d 6e5f 636c 6173 7369 6669 6572  olumn_classifier
-000038f0: 2229 0a20 2020 2020 2020 2069 6620 7365  ").        if se
-00003900: 6c66 2e69 6e70 7574 5f62 696e 6172 793a  lf.input_binary:
-00003910: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
-00003920: 203d 206e 702e 636f 7079 2869 6d67 5f62   = np.copy(img_b
-00003930: 696e 290a 2020 2020 2020 2020 656c 7365  in).        else
-00003940: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
-00003950: 6720 3d20 7365 6c66 2e69 6d72 6561 6428  g = self.imread(
-00003960: 290a 0a20 2020 2020 2020 205f 2c20 7061  )..        _, pa
-00003970: 6765 5f63 6f6f 7264 203d 2073 656c 662e  ge_coord = self.
-00003980: 6561 726c 795f 7061 6765 5f66 6f72 5f6e  early_page_for_n
-00003990: 756d 5f6f 665f 636f 6c75 6d6e 5f63 6c61  um_of_column_cla
-000039a0: 7373 6966 6963 6174 696f 6e28 696d 6729  ssification(img)
-000039b0: 0a20 2020 2020 2020 206d 6f64 656c 5f6e  .        model_n
-000039c0: 756d 5f63 6c61 7373 6966 6965 722c 2073  um_classifier, s
-000039d0: 6573 7369 6f6e 5f63 6f6c 5f63 6c61 7373  ession_col_class
-000039e0: 6966 6965 7220 3d20 7365 6c66 2e73 7461  ifier = self.sta
-000039f0: 7274 5f6e 6577 5f73 6573 7369 6f6e 5f61  rt_new_session_a
-00003a00: 6e64 5f6d 6f64 656c 2873 656c 662e 6d6f  nd_model(self.mo
-00003a10: 6465 6c5f 6469 725f 6f66 5f63 6f6c 5f63  del_dir_of_col_c
-00003a20: 6c61 7373 6966 6965 7229 0a20 2020 2020  lassifier).     
-00003a30: 2020 2069 6620 7365 6c66 2e69 6e70 7574     if self.input
-00003a40: 5f62 696e 6172 793a 0a20 2020 2020 2020  _binary:.       
-00003a50: 2020 2020 2069 6d67 5f69 6e20 3d20 6e70       img_in = np
-00003a60: 2e63 6f70 7928 696d 6729 0a20 2020 2020  .copy(img).     
-00003a70: 2020 2020 2020 2069 6d67 5f69 6e20 3d20         img_in = 
-00003a80: 696d 675f 696e 202f 2032 3535 2e30 0a20  img_in / 255.0. 
-00003a90: 2020 2020 2020 2020 2020 2077 6964 7468             width
-00003aa0: 5f65 6172 6c79 203d 2069 6d67 5f69 6e2e  _early = img_in.
-00003ab0: 7368 6170 655b 315d 0a20 2020 2020 2020  shape[1].       
-00003ac0: 2020 2020 2069 6d67 5f69 6e20 3d20 6376       img_in = cv
-00003ad0: 322e 7265 7369 7a65 2869 6d67 5f69 6e2c  2.resize(img_in,
-00003ae0: 2028 3434 382c 2034 3438 292c 2069 6e74   (448, 448), int
-00003af0: 6572 706f 6c61 7469 6f6e 3d63 7632 2e49  erpolation=cv2.I
-00003b00: 4e54 4552 5f4e 4541 5245 5354 290a 2020  NTER_NEAREST).  
-00003b10: 2020 2020 2020 2020 2020 696d 675f 696e            img_in
-00003b20: 203d 2069 6d67 5f69 6e2e 7265 7368 6170   = img_in.reshap
-00003b30: 6528 312c 2034 3438 2c20 3434 382c 2033  e(1, 448, 448, 3
-00003b40: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
-00003b50: 2020 2020 2020 2020 2020 2020 696d 675f              img_
-00003b60: 3163 6820 3d20 7365 6c66 2e69 6d72 6561  1ch = self.imrea
-00003b70: 6428 6772 6179 7363 616c 653d 5472 7565  d(grayscale=True
-00003b80: 2c20 7569 6e74 383d 4661 6c73 6529 0a20  , uint8=False). 
-00003b90: 2020 2020 2020 2020 2020 2077 6964 7468             width
-00003ba0: 5f65 6172 6c79 203d 2069 6d67 5f31 6368  _early = img_1ch
-00003bb0: 2e73 6861 7065 5b31 5d0a 2020 2020 2020  .shape[1].      
-00003bc0: 2020 2020 2020 696d 675f 3163 6820 3d20        img_1ch = 
-00003bd0: 696d 675f 3163 685b 7061 6765 5f63 6f6f  img_1ch[page_coo
-00003be0: 7264 5b30 5d20 3a20 7061 6765 5f63 6f6f  rd[0] : page_coo
-00003bf0: 7264 5b31 5d2c 2070 6167 655f 636f 6f72  rd[1], page_coor
-00003c00: 645b 325d 203a 2070 6167 655f 636f 6f72  d[2] : page_coor
-00003c10: 645b 335d 5d0a 0a20 2020 2020 2020 2020  d[3]]..         
-00003c20: 2020 2023 2070 6c74 2e69 6d73 686f 7728     # plt.imshow(
-00003c30: 696d 675f 3163 6829 0a20 2020 2020 2020  img_1ch).       
-00003c40: 2020 2020 2023 2070 6c74 2e73 686f 7728       # plt.show(
-00003c50: 290a 2020 2020 2020 2020 2020 2020 696d  ).            im
-00003c60: 675f 3163 6820 3d20 696d 675f 3163 6820  g_1ch = img_1ch 
-00003c70: 2f20 3235 352e 300a 0a20 2020 2020 2020  / 255.0..       
-00003c80: 2020 2020 2069 6d67 5f31 6368 203d 2063       img_1ch = c
-00003c90: 7632 2e72 6573 697a 6528 696d 675f 3163  v2.resize(img_1c
-00003ca0: 682c 2028 3434 382c 2034 3438 292c 2069  h, (448, 448), i
-00003cb0: 6e74 6572 706f 6c61 7469 6f6e 3d63 7632  nterpolation=cv2
-00003cc0: 2e49 4e54 4552 5f4e 4541 5245 5354 290a  .INTER_NEAREST).
-00003cd0: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
-00003ce0: 5f69 6e20 3d20 6e70 2e7a 6572 6f73 2828  _in = np.zeros((
-00003cf0: 312c 2069 6d67 5f31 6368 2e73 6861 7065  1, img_1ch.shape
-00003d00: 5b30 5d2c 2069 6d67 5f31 6368 2e73 6861  [0], img_1ch.sha
-00003d10: 7065 5b31 5d2c 2033 2929 0a20 2020 2020  pe[1], 3)).     
-00003d20: 2020 2020 2020 2069 6d67 5f69 6e5b 302c         img_in[0,
-00003d30: 203a 2c20 3a2c 2030 5d20 3d20 696d 675f   :, :, 0] = img_
-00003d40: 3163 685b 3a2c 203a 5d0a 2020 2020 2020  1ch[:, :].      
-00003d50: 2020 2020 2020 696d 675f 696e 5b30 2c20        img_in[0, 
-00003d60: 3a2c 203a 2c20 315d 203d 2069 6d67 5f31  :, :, 1] = img_1
-00003d70: 6368 5b3a 2c20 3a5d 0a20 2020 2020 2020  ch[:, :].       
-00003d80: 2020 2020 2069 6d67 5f69 6e5b 302c 203a       img_in[0, :
-00003d90: 2c20 3a2c 2032 5d20 3d20 696d 675f 3163  , :, 2] = img_1c
-00003da0: 685b 3a2c 203a 5d0a 0a20 2020 2020 2020  h[:, :]..       
-00003db0: 206c 6162 656c 5f70 5f70 7265 6420 3d20   label_p_pred = 
-00003dc0: 6d6f 6465 6c5f 6e75 6d5f 636c 6173 7369  model_num_classi
-00003dd0: 6669 6572 2e70 7265 6469 6374 2869 6d67  fier.predict(img
-00003de0: 5f69 6e2c 2076 6572 626f 7365 3d30 290a  _in, verbose=0).
-00003df0: 2020 2020 2020 2020 6e75 6d5f 636f 6c20          num_col 
-00003e00: 3d20 6e70 2e61 7267 6d61 7828 6c61 6265  = np.argmax(labe
-00003e10: 6c5f 705f 7072 6564 5b30 5d29 202b 2031  l_p_pred[0]) + 1
-00003e20: 0a0a 2020 2020 2020 2020 7365 6c66 2e6c  ..        self.l
-00003e30: 6f67 6765 722e 696e 666f 2822 466f 756e  ogger.info("Foun
-00003e40: 6420 2573 2063 6f6c 756d 6e73 2028 2573  d %s columns (%s
-00003e50: 2922 2c20 6e75 6d5f 636f 6c2c 206c 6162  )", num_col, lab
-00003e60: 656c 5f70 5f70 7265 6429 0a0a 2020 2020  el_p_pred)..    
-00003e70: 2020 2020 696d 675f 6e65 772c 205f 203d      img_new, _ =
-00003e80: 2073 656c 662e 6361 6c63 756c 6174 655f   self.calculate_
-00003e90: 7769 6474 685f 6865 6967 6874 5f62 795f  width_height_by_
-00003ea0: 636f 6c75 6d6e 7328 696d 672c 206e 756d  columns(img, num
-00003eb0: 5f63 6f6c 2c20 7769 6474 685f 6561 726c  _col, width_earl
-00003ec0: 792c 206c 6162 656c 5f70 5f70 7265 6429  y, label_p_pred)
-00003ed0: 0a0a 2020 2020 2020 2020 6966 2069 6d67  ..        if img
-00003ee0: 5f6e 6577 2e73 6861 7065 5b31 5d20 3e20  _new.shape[1] > 
-00003ef0: 696d 672e 7368 6170 655b 315d 3a0a 2020  img.shape[1]:.  
-00003f00: 2020 2020 2020 2020 2020 696d 675f 6e65            img_ne
-00003f10: 7720 3d20 7365 6c66 2e70 7265 6469 6374  w = self.predict
-00003f20: 5f65 6e68 616e 6365 6d65 6e74 2869 6d67  _enhancement(img
-00003f30: 5f6e 6577 290a 2020 2020 2020 2020 2020  _new).          
-00003f40: 2020 6973 5f69 6d61 6765 5f65 6e68 616e    is_image_enhan
-00003f50: 6365 6420 3d20 5472 7565 0a0a 2020 2020  ced = True..    
-00003f60: 2020 2020 7265 7475 726e 2069 6d67 2c20      return img, 
-00003f70: 696d 675f 6e65 772c 2069 735f 696d 6167  img_new, is_imag
-00003f80: 655f 656e 6861 6e63 6564 0a0a 2020 2020  e_enhanced..    
-00003f90: 6465 6620 7265 7369 7a65 5f61 6e64 5f65  def resize_and_e
-00003fa0: 6e68 616e 6365 5f69 6d61 6765 5f77 6974  nhance_image_wit
-00003fb0: 685f 636f 6c75 6d6e 5f63 6c61 7373 6966  h_column_classif
-00003fc0: 6965 7228 7365 6c66 293a 0a20 2020 2020  ier(self):.     
-00003fd0: 2020 2073 656c 662e 6c6f 6767 6572 2e64     self.logger.d
-00003fe0: 6562 7567 2822 656e 7465 7220 7265 7369  ebug("enter resi
-00003ff0: 7a65 5f61 6e64 5f65 6e68 616e 6365 5f69  ze_and_enhance_i
-00004000: 6d61 6765 5f77 6974 685f 636f 6c75 6d6e  mage_with_column
-00004010: 5f63 6c61 7373 6966 6965 7222 290a 2020  _classifier").  
-00004020: 2020 2020 2020 6470 6920 3d20 7365 6c66        dpi = self
-00004030: 2e64 7069 0a20 2020 2020 2020 2073 656c  .dpi.        sel
-00004040: 662e 6c6f 6767 6572 2e69 6e66 6f28 2244  f.logger.info("D
-00004050: 6574 6563 7465 6420 2573 2044 5049 222c  etected %s DPI",
-00004060: 2064 7069 290a 2020 2020 2020 2020 6966   dpi).        if
-00004070: 2073 656c 662e 696e 7075 745f 6269 6e61   self.input_bina
-00004080: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00004090: 696d 6720 3d20 7365 6c66 2e69 6d72 6561  img = self.imrea
-000040a0: 6428 290a 2020 2020 2020 2020 2020 2020  d().            
-000040b0: 6d6f 6465 6c5f 6269 6e2c 2073 6573 7369  model_bin, sessi
-000040c0: 6f6e 5f62 696e 203d 2073 656c 662e 7374  on_bin = self.st
-000040d0: 6172 745f 6e65 775f 7365 7373 696f 6e5f  art_new_session_
-000040e0: 616e 645f 6d6f 6465 6c28 7365 6c66 2e6d  and_model(self.m
-000040f0: 6f64 656c 5f64 6972 5f6f 665f 6269 6e61  odel_dir_of_bina
-00004100: 7269 7a61 7469 6f6e 290a 2020 2020 2020  rization).      
-00004110: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
-00004120: 5f62 696e 203d 2073 656c 662e 646f 5f70  _bin = self.do_p
-00004130: 7265 6469 6374 696f 6e28 5472 7565 2c20  rediction(True, 
-00004140: 696d 672c 206d 6f64 656c 5f62 696e 290a  img, model_bin).
-00004150: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-00004160: 2020 2020 2020 2020 2070 7265 6469 6374           predict
-00004170: 696f 6e5f 6269 6e3d 7072 6564 6963 7469  ion_bin=predicti
-00004180: 6f6e 5f62 696e 5b3a 2c3a 2c30 5d0a 2020  on_bin[:,:,0].  
-00004190: 2020 2020 2020 2020 2020 7072 6564 6963            predic
-000041a0: 7469 6f6e 5f62 696e 203d 2028 7072 6564  tion_bin = (pred
-000041b0: 6963 7469 6f6e 5f62 696e 5b3a 2c3a 5d3d  iction_bin[:,:]=
-000041c0: 3d30 292a 310a 2020 2020 2020 2020 2020  =0)*1.          
-000041d0: 2020 7072 6564 6963 7469 6f6e 5f62 696e    prediction_bin
-000041e0: 203d 2070 7265 6469 6374 696f 6e5f 6269   = prediction_bi
-000041f0: 6e2a 3235 350a 2020 2020 2020 2020 2020  n*255.          
-00004200: 2020 0a20 2020 2020 2020 2020 2020 2070    .            p
-00004210: 7265 6469 6374 696f 6e5f 6269 6e20 3d6e  rediction_bin =n
-00004220: 702e 7265 7065 6174 2870 7265 6469 6374  p.repeat(predict
-00004230: 696f 6e5f 6269 6e5b 3a2c 203a 2c20 6e70  ion_bin[:, :, np
-00004240: 2e6e 6577 6178 6973 5d2c 2033 2c20 6178  .newaxis], 3, ax
-00004250: 6973 3d32 290a 0a20 2020 2020 2020 2020  is=2)..         
-00004260: 2020 2070 7265 6469 6374 696f 6e5f 6269     prediction_bi
-00004270: 6e20 3d20 7072 6564 6963 7469 6f6e 5f62  n = prediction_b
-00004280: 696e 2e61 7374 7970 6528 6e70 2e75 696e  in.astype(np.uin
-00004290: 7438 290a 2020 2020 2020 2020 2020 2020  t8).            
-000042a0: 696d 673d 206e 702e 636f 7079 2870 7265  img= np.copy(pre
-000042b0: 6469 6374 696f 6e5f 6269 6e29 0a20 2020  diction_bin).   
-000042c0: 2020 2020 2020 2020 2069 6d67 5f62 696e           img_bin
-000042d0: 203d 206e 702e 636f 7079 2870 7265 6469   = np.copy(predi
-000042e0: 6374 696f 6e5f 6269 6e29 0a20 2020 2020  ction_bin).     
-000042f0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00004300: 2020 2020 2069 6d67 203d 2073 656c 662e       img = self.
-00004310: 696d 7265 6164 2829 0a20 2020 2020 2020  imread().       
-00004320: 2020 2020 2069 6d67 5f62 696e 203d 204e       img_bin = N
-00004330: 6f6e 650a 0a20 2020 2020 2020 2074 3120  one..        t1 
-00004340: 3d20 7469 6d65 2e74 696d 6528 290a 2020  = time.time().  
-00004350: 2020 2020 2020 5f2c 2070 6167 655f 636f        _, page_co
-00004360: 6f72 6420 3d20 7365 6c66 2e65 6172 6c79  ord = self.early
-00004370: 5f70 6167 655f 666f 725f 6e75 6d5f 6f66  _page_for_num_of
-00004380: 5f63 6f6c 756d 6e5f 636c 6173 7369 6669  _column_classifi
-00004390: 6361 7469 6f6e 2869 6d67 5f62 696e 290a  cation(img_bin).
-000043a0: 2020 2020 2020 2020 6d6f 6465 6c5f 6e75          model_nu
-000043b0: 6d5f 636c 6173 7369 6669 6572 2c20 7365  m_classifier, se
-000043c0: 7373 696f 6e5f 636f 6c5f 636c 6173 7369  ssion_col_classi
-000043d0: 6669 6572 203d 2073 656c 662e 7374 6172  fier = self.star
-000043e0: 745f 6e65 775f 7365 7373 696f 6e5f 616e  t_new_session_an
-000043f0: 645f 6d6f 6465 6c28 7365 6c66 2e6d 6f64  d_model(self.mod
-00004400: 656c 5f64 6972 5f6f 665f 636f 6c5f 636c  el_dir_of_col_cl
-00004410: 6173 7369 6669 6572 290a 2020 2020 2020  assifier).      
-00004420: 2020 0a20 2020 2020 2020 2069 6620 7365    .        if se
-00004430: 6c66 2e69 6e70 7574 5f62 696e 6172 793a  lf.input_binary:
-00004440: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
-00004450: 5f69 6e20 3d20 6e70 2e63 6f70 7928 696d  _in = np.copy(im
-00004460: 6729 0a20 2020 2020 2020 2020 2020 2077  g).            w
-00004470: 6964 7468 5f65 6172 6c79 203d 2069 6d67  idth_early = img
-00004480: 5f69 6e2e 7368 6170 655b 315d 0a20 2020  _in.shape[1].   
-00004490: 2020 2020 2020 2020 2069 6d67 5f69 6e20           img_in 
-000044a0: 3d20 696d 675f 696e 202f 2032 3535 2e30  = img_in / 255.0
-000044b0: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
-000044c0: 5f69 6e20 3d20 6376 322e 7265 7369 7a65  _in = cv2.resize
-000044d0: 2869 6d67 5f69 6e2c 2028 3434 382c 2034  (img_in, (448, 4
-000044e0: 3438 292c 2069 6e74 6572 706f 6c61 7469  48), interpolati
-000044f0: 6f6e 3d63 7632 2e49 4e54 4552 5f4e 4541  on=cv2.INTER_NEA
-00004500: 5245 5354 290a 2020 2020 2020 2020 2020  REST).          
-00004510: 2020 696d 675f 696e 203d 2069 6d67 5f69    img_in = img_i
-00004520: 6e2e 7265 7368 6170 6528 312c 2034 3438  n.reshape(1, 448
-00004530: 2c20 3434 382c 2033 290a 2020 2020 2020  , 448, 3).      
-00004540: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00004550: 2020 2020 696d 675f 3163 6820 3d20 7365      img_1ch = se
-00004560: 6c66 2e69 6d72 6561 6428 6772 6179 7363  lf.imread(graysc
-00004570: 616c 653d 5472 7565 290a 2020 2020 2020  ale=True).      
-00004580: 2020 2020 2020 7769 6474 685f 6561 726c        width_earl
-00004590: 7920 3d20 696d 675f 3163 682e 7368 6170  y = img_1ch.shap
-000045a0: 655b 315d 0a20 2020 2020 2020 2020 2020  e[1].           
-000045b0: 2069 6d67 5f31 6368 203d 2069 6d67 5f31   img_1ch = img_1
-000045c0: 6368 5b70 6167 655f 636f 6f72 645b 305d  ch[page_coord[0]
-000045d0: 203a 2070 6167 655f 636f 6f72 645b 315d   : page_coord[1]
-000045e0: 2c20 7061 6765 5f63 6f6f 7264 5b32 5d20  , page_coord[2] 
-000045f0: 3a20 7061 6765 5f63 6f6f 7264 5b33 5d5d  : page_coord[3]]
-00004600: 0a0a 2020 2020 2020 2020 2020 2020 696d  ..            im
-00004610: 675f 3163 6820 3d20 696d 675f 3163 6820  g_1ch = img_1ch 
-00004620: 2f20 3235 352e 300a 2020 2020 2020 2020  / 255.0.        
-00004630: 2020 2020 696d 675f 3163 6820 3d20 6376      img_1ch = cv
-00004640: 322e 7265 7369 7a65 2869 6d67 5f31 6368  2.resize(img_1ch
-00004650: 2c20 2834 3438 2c20 3434 3829 2c20 696e  , (448, 448), in
-00004660: 7465 7270 6f6c 6174 696f 6e3d 6376 322e  terpolation=cv2.
-00004670: 494e 5445 525f 4e45 4152 4553 5429 0a20  INTER_NEAREST). 
-00004680: 2020 2020 2020 2020 2020 2069 6d67 5f69             img_i
-00004690: 6e20 3d20 6e70 2e7a 6572 6f73 2828 312c  n = np.zeros((1,
-000046a0: 2069 6d67 5f31 6368 2e73 6861 7065 5b30   img_1ch.shape[0
-000046b0: 5d2c 2069 6d67 5f31 6368 2e73 6861 7065  ], img_1ch.shape
-000046c0: 5b31 5d2c 2033 2929 0a20 2020 2020 2020  [1], 3)).       
-000046d0: 2020 2020 2069 6d67 5f69 6e5b 302c 203a       img_in[0, :
-000046e0: 2c20 3a2c 2030 5d20 3d20 696d 675f 3163  , :, 0] = img_1c
-000046f0: 685b 3a2c 203a 5d0a 2020 2020 2020 2020  h[:, :].        
-00004700: 2020 2020 696d 675f 696e 5b30 2c20 3a2c      img_in[0, :,
-00004710: 203a 2c20 315d 203d 2069 6d67 5f31 6368   :, 1] = img_1ch
-00004720: 5b3a 2c20 3a5d 0a20 2020 2020 2020 2020  [:, :].         
-00004730: 2020 2069 6d67 5f69 6e5b 302c 203a 2c20     img_in[0, :, 
-00004740: 3a2c 2032 5d20 3d20 696d 675f 3163 685b  :, 2] = img_1ch[
-00004750: 3a2c 203a 5d0a 0a0a 2020 2020 2020 2020  :, :]...        
-00004760: 6c61 6265 6c5f 705f 7072 6564 203d 206d  label_p_pred = m
-00004770: 6f64 656c 5f6e 756d 5f63 6c61 7373 6966  odel_num_classif
-00004780: 6965 722e 7072 6564 6963 7428 696d 675f  ier.predict(img_
-00004790: 696e 2c20 7665 7262 6f73 653d 3029 0a20  in, verbose=0). 
-000047a0: 2020 2020 2020 206e 756d 5f63 6f6c 203d         num_col =
-000047b0: 206e 702e 6172 676d 6178 286c 6162 656c   np.argmax(label
-000047c0: 5f70 5f70 7265 645b 305d 2920 2b20 310a  _p_pred[0]) + 1.
-000047d0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-000047e0: 6765 722e 696e 666f 2822 466f 756e 6420  ger.info("Found 
-000047f0: 2564 2063 6f6c 756d 6e73 2028 2573 2922  %d columns (%s)"
-00004800: 2c20 6e75 6d5f 636f 6c2c 206e 702e 6172  , num_col, np.ar
-00004810: 6f75 6e64 286c 6162 656c 5f70 5f70 7265  ound(label_p_pre
-00004820: 642c 2064 6563 696d 616c 733d 3529 290a  d, decimals=5)).
-00004830: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-00004840: 6765 722e 696e 666f 2822 6465 7465 6374  ger.info("detect
-00004850: 696e 6720 636f 6c75 6d6e 7320 746f 6f6b  ing columns took
-00004860: 2025 2e31 6673 222c 2074 696d 652e 7469   %.1fs", time.ti
-00004870: 6d65 2829 202d 2074 3129 0a0a 2020 2020  me() - t1)..    
-00004880: 2020 2020 6966 2064 7069 203c 2044 5049      if dpi < DPI
-00004890: 5f54 4852 4553 484f 4c44 3a0a 2020 2020  _THRESHOLD:.    
-000048a0: 2020 2020 2020 2020 696d 675f 6e65 772c          img_new,
-000048b0: 206e 756d 5f63 6f6c 756d 6e5f 6973 5f63   num_column_is_c
-000048c0: 6c61 7373 6966 6965 6420 3d20 7365 6c66  lassified = self
-000048d0: 2e63 616c 6375 6c61 7465 5f77 6964 7468  .calculate_width
-000048e0: 5f68 6569 6768 745f 6279 5f63 6f6c 756d  _height_by_colum
-000048f0: 6e73 2869 6d67 2c20 6e75 6d5f 636f 6c2c  ns(img, num_col,
-00004900: 2077 6964 7468 5f65 6172 6c79 2c20 6c61   width_early, la
-00004910: 6265 6c5f 705f 7072 6564 290a 2020 2020  bel_p_pred).    
-00004920: 2020 2020 2020 2020 696d 6167 655f 7265          image_re
-00004930: 7320 3d20 7365 6c66 2e70 7265 6469 6374  s = self.predict
-00004940: 5f65 6e68 616e 6365 6d65 6e74 2869 6d67  _enhancement(img
-00004950: 5f6e 6577 290a 2020 2020 2020 2020 2020  _new).          
-00004960: 2020 6973 5f69 6d61 6765 5f65 6e68 616e    is_image_enhan
-00004970: 6365 6420 3d20 5472 7565 0a20 2020 2020  ced = True.     
-00004980: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00004990: 2020 2020 206e 756d 5f63 6f6c 756d 6e5f       num_column_
-000049a0: 6973 5f63 6c61 7373 6966 6965 6420 3d20  is_classified = 
-000049b0: 5472 7565 0a20 2020 2020 2020 2020 2020  True.           
-000049c0: 2069 6d61 6765 5f72 6573 203d 206e 702e   image_res = np.
-000049d0: 636f 7079 2869 6d67 290a 2020 2020 2020  copy(img).      
-000049e0: 2020 2020 2020 6973 5f69 6d61 6765 5f65        is_image_e
-000049f0: 6e68 616e 6365 6420 3d20 4661 6c73 650a  nhanced = False.
-00004a00: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
-00004a10: 6767 6572 2e64 6562 7567 2822 6578 6974  gger.debug("exit
-00004a20: 2072 6573 697a 655f 616e 645f 656e 6861   resize_and_enha
-00004a30: 6e63 655f 696d 6167 655f 7769 7468 5f63  nce_image_with_c
-00004a40: 6f6c 756d 6e5f 636c 6173 7369 6669 6572  olumn_classifier
-00004a50: 2229 0a20 2020 2020 2020 2072 6574 7572  ").        retur
-00004a60: 6e20 6973 5f69 6d61 6765 5f65 6e68 616e  n is_image_enhan
-00004a70: 6365 642c 2069 6d67 2c20 696d 6167 655f  ced, img, image_
-00004a80: 7265 732c 206e 756d 5f63 6f6c 2c20 6e75  res, num_col, nu
-00004a90: 6d5f 636f 6c75 6d6e 5f69 735f 636c 6173  m_column_is_clas
-00004aa0: 7369 6669 6564 2c20 696d 675f 6269 6e0a  sified, img_bin.
-00004ab0: 0a20 2020 2023 2070 796c 696e 743a 2064  .    # pylint: d
-00004ac0: 6973 6162 6c65 3d61 7474 7269 6275 7465  isable=attribute
-00004ad0: 2d64 6566 696e 6564 2d6f 7574 7369 6465  -defined-outside
-00004ae0: 2d69 6e69 740a 2020 2020 6465 6620 6765  -init.    def ge
-00004af0: 745f 696d 6167 655f 616e 645f 7363 616c  t_image_and_scal
-00004b00: 6573 2873 656c 662c 2069 6d67 5f6f 7267  es(self, img_org
-00004b10: 2c20 696d 675f 7265 732c 2073 6361 6c65  , img_res, scale
-00004b20: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-00004b30: 6c6f 6767 6572 2e64 6562 7567 2822 656e  logger.debug("en
-00004b40: 7465 7220 6765 745f 696d 6167 655f 616e  ter get_image_an
-00004b50: 645f 7363 616c 6573 2229 0a20 2020 2020  d_scales").     
-00004b60: 2020 2073 656c 662e 696d 6167 6520 3d20     self.image = 
-00004b70: 6e70 2e63 6f70 7928 696d 675f 7265 7329  np.copy(img_res)
-00004b80: 0a20 2020 2020 2020 2073 656c 662e 696d  .        self.im
-00004b90: 6167 655f 6f72 6720 3d20 6e70 2e63 6f70  age_org = np.cop
-00004ba0: 7928 696d 675f 6f72 6729 0a20 2020 2020  y(img_org).     
-00004bb0: 2020 2073 656c 662e 6865 6967 6874 5f6f     self.height_o
-00004bc0: 7267 203d 2073 656c 662e 696d 6167 652e  rg = self.image.
-00004bd0: 7368 6170 655b 305d 0a20 2020 2020 2020  shape[0].       
-00004be0: 2073 656c 662e 7769 6474 685f 6f72 6720   self.width_org 
-00004bf0: 3d20 7365 6c66 2e69 6d61 6765 2e73 6861  = self.image.sha
-00004c00: 7065 5b31 5d0a 0a20 2020 2020 2020 2073  pe[1]..        s
-00004c10: 656c 662e 696d 675f 6869 6768 745f 696e  elf.img_hight_in
-00004c20: 7420 3d20 696e 7428 7365 6c66 2e69 6d61  t = int(self.ima
-00004c30: 6765 2e73 6861 7065 5b30 5d20 2a20 7363  ge.shape[0] * sc
-00004c40: 616c 6529 0a20 2020 2020 2020 2073 656c  ale).        sel
-00004c50: 662e 696d 675f 7769 6474 685f 696e 7420  f.img_width_int 
-00004c60: 3d20 696e 7428 7365 6c66 2e69 6d61 6765  = int(self.image
-00004c70: 2e73 6861 7065 5b31 5d20 2a20 7363 616c  .shape[1] * scal
-00004c80: 6529 0a20 2020 2020 2020 2073 656c 662e  e).        self.
-00004c90: 7363 616c 655f 7920 3d20 7365 6c66 2e69  scale_y = self.i
-00004ca0: 6d67 5f68 6967 6874 5f69 6e74 202f 2066  mg_hight_int / f
-00004cb0: 6c6f 6174 2873 656c 662e 696d 6167 652e  loat(self.image.
-00004cc0: 7368 6170 655b 305d 290a 2020 2020 2020  shape[0]).      
-00004cd0: 2020 7365 6c66 2e73 6361 6c65 5f78 203d    self.scale_x =
-00004ce0: 2073 656c 662e 696d 675f 7769 6474 685f   self.img_width_
-00004cf0: 696e 7420 2f20 666c 6f61 7428 7365 6c66  int / float(self
-00004d00: 2e69 6d61 6765 2e73 6861 7065 5b31 5d29  .image.shape[1])
-00004d10: 0a0a 2020 2020 2020 2020 7365 6c66 2e69  ..        self.i
-00004d20: 6d61 6765 203d 2072 6573 697a 655f 696d  mage = resize_im
-00004d30: 6167 6528 7365 6c66 2e69 6d61 6765 2c20  age(self.image, 
-00004d40: 7365 6c66 2e69 6d67 5f68 6967 6874 5f69  self.img_hight_i
-00004d50: 6e74 2c20 7365 6c66 2e69 6d67 5f77 6964  nt, self.img_wid
-00004d60: 7468 5f69 6e74 290a 0a20 2020 2020 2020  th_int)..       
-00004d70: 2023 2041 6c73 6f20 7365 7420 666f 7220   # Also set for 
-00004d80: 7468 6520 706c 6f74 7465 720a 2020 2020  the plotter.    
-00004d90: 2020 2020 6966 2073 656c 662e 706c 6f74      if self.plot
-00004da0: 7465 723a 0a20 2020 2020 2020 2020 2020  ter:.           
-00004db0: 2073 656c 662e 706c 6f74 7465 722e 696d   self.plotter.im
-00004dc0: 6167 655f 6f72 6720 3d20 7365 6c66 2e69  age_org = self.i
-00004dd0: 6d61 6765 5f6f 7267 0a20 2020 2020 2020  mage_org.       
-00004de0: 2020 2020 2073 656c 662e 706c 6f74 7465       self.plotte
-00004df0: 722e 7363 616c 655f 7920 3d20 7365 6c66  r.scale_y = self
-00004e00: 2e73 6361 6c65 5f79 0a20 2020 2020 2020  .scale_y.       
-00004e10: 2020 2020 2073 656c 662e 706c 6f74 7465       self.plotte
-00004e20: 722e 7363 616c 655f 7820 3d20 7365 6c66  r.scale_x = self
-00004e30: 2e73 6361 6c65 5f78 0a20 2020 2020 2020  .scale_x.       
-00004e40: 2023 2041 6c73 6f20 7365 7420 666f 7220   # Also set for 
-00004e50: 7468 6520 7772 6974 6572 0a20 2020 2020  the writer.     
-00004e60: 2020 2073 656c 662e 7772 6974 6572 2e69     self.writer.i
-00004e70: 6d61 6765 5f6f 7267 203d 2073 656c 662e  mage_org = self.
-00004e80: 696d 6167 655f 6f72 670a 2020 2020 2020  image_org.      
-00004e90: 2020 7365 6c66 2e77 7269 7465 722e 7363    self.writer.sc
-00004ea0: 616c 655f 7920 3d20 7365 6c66 2e73 6361  ale_y = self.sca
-00004eb0: 6c65 5f79 0a20 2020 2020 2020 2073 656c  le_y.        sel
-00004ec0: 662e 7772 6974 6572 2e73 6361 6c65 5f78  f.writer.scale_x
-00004ed0: 203d 2073 656c 662e 7363 616c 655f 780a   = self.scale_x.
-00004ee0: 2020 2020 2020 2020 7365 6c66 2e77 7269          self.wri
-00004ef0: 7465 722e 6865 6967 6874 5f6f 7267 203d  ter.height_org =
-00004f00: 2073 656c 662e 6865 6967 6874 5f6f 7267   self.height_org
-00004f10: 0a20 2020 2020 2020 2073 656c 662e 7772  .        self.wr
-00004f20: 6974 6572 2e77 6964 7468 5f6f 7267 203d  iter.width_org =
-00004f30: 2073 656c 662e 7769 6474 685f 6f72 670a   self.width_org.
-00004f40: 0a20 2020 2064 6566 2067 6574 5f69 6d61  .    def get_ima
-00004f50: 6765 5f61 6e64 5f73 6361 6c65 735f 6166  ge_and_scales_af
-00004f60: 7465 725f 656e 6861 6e63 696e 6728 7365  ter_enhancing(se
-00004f70: 6c66 2c20 696d 675f 6f72 672c 2069 6d67  lf, img_org, img
-00004f80: 5f72 6573 293a 0a20 2020 2020 2020 2073  _res):.        s
-00004f90: 656c 662e 6c6f 6767 6572 2e64 6562 7567  elf.logger.debug
-00004fa0: 2822 656e 7465 7220 6765 745f 696d 6167  ("enter get_imag
-00004fb0: 655f 616e 645f 7363 616c 6573 5f61 6674  e_and_scales_aft
-00004fc0: 6572 5f65 6e68 616e 6369 6e67 2229 0a20  er_enhancing"). 
-00004fd0: 2020 2020 2020 2073 656c 662e 696d 6167         self.imag
-00004fe0: 6520 3d20 6e70 2e63 6f70 7928 696d 675f  e = np.copy(img_
-00004ff0: 7265 7329 0a20 2020 2020 2020 2073 656c  res).        sel
-00005000: 662e 696d 6167 6520 3d20 7365 6c66 2e69  f.image = self.i
-00005010: 6d61 6765 2e61 7374 7970 6528 6e70 2e75  mage.astype(np.u
-00005020: 696e 7438 290a 2020 2020 2020 2020 7365  int8).        se
-00005030: 6c66 2e69 6d61 6765 5f6f 7267 203d 206e  lf.image_org = n
-00005040: 702e 636f 7079 2869 6d67 5f6f 7267 290a  p.copy(img_org).
-00005050: 2020 2020 2020 2020 7365 6c66 2e68 6569          self.hei
-00005060: 6768 745f 6f72 6720 3d20 7365 6c66 2e69  ght_org = self.i
-00005070: 6d61 6765 5f6f 7267 2e73 6861 7065 5b30  mage_org.shape[0
-00005080: 5d0a 2020 2020 2020 2020 7365 6c66 2e77  ].        self.w
-00005090: 6964 7468 5f6f 7267 203d 2073 656c 662e  idth_org = self.
-000050a0: 696d 6167 655f 6f72 672e 7368 6170 655b  image_org.shape[
-000050b0: 315d 0a0a 2020 2020 2020 2020 7365 6c66  1]..        self
-000050c0: 2e73 6361 6c65 5f79 203d 2069 6d67 5f72  .scale_y = img_r
-000050d0: 6573 2e73 6861 7065 5b30 5d20 2f20 666c  es.shape[0] / fl
-000050e0: 6f61 7428 7365 6c66 2e69 6d61 6765 5f6f  oat(self.image_o
-000050f0: 7267 2e73 6861 7065 5b30 5d29 0a20 2020  rg.shape[0]).   
-00005100: 2020 2020 2073 656c 662e 7363 616c 655f       self.scale_
-00005110: 7820 3d20 696d 675f 7265 732e 7368 6170  x = img_res.shap
-00005120: 655b 315d 202f 2066 6c6f 6174 2873 656c  e[1] / float(sel
-00005130: 662e 696d 6167 655f 6f72 672e 7368 6170  f.image_org.shap
-00005140: 655b 315d 290a 0a20 2020 2020 2020 2023  e[1])..        #
-00005150: 2041 6c73 6f20 7365 7420 666f 7220 7468   Also set for th
-00005160: 6520 706c 6f74 7465 720a 2020 2020 2020  e plotter.      
-00005170: 2020 6966 2073 656c 662e 706c 6f74 7465    if self.plotte
-00005180: 723a 0a20 2020 2020 2020 2020 2020 2073  r:.            s
-00005190: 656c 662e 706c 6f74 7465 722e 696d 6167  elf.plotter.imag
-000051a0: 655f 6f72 6720 3d20 7365 6c66 2e69 6d61  e_org = self.ima
-000051b0: 6765 5f6f 7267 0a20 2020 2020 2020 2020  ge_org.         
-000051c0: 2020 2073 656c 662e 706c 6f74 7465 722e     self.plotter.
-000051d0: 7363 616c 655f 7920 3d20 7365 6c66 2e73  scale_y = self.s
-000051e0: 6361 6c65 5f79 0a20 2020 2020 2020 2020  cale_y.         
-000051f0: 2020 2073 656c 662e 706c 6f74 7465 722e     self.plotter.
-00005200: 7363 616c 655f 7820 3d20 7365 6c66 2e73  scale_x = self.s
-00005210: 6361 6c65 5f78 0a20 2020 2020 2020 2023  cale_x.        #
-00005220: 2041 6c73 6f20 7365 7420 666f 7220 7468   Also set for th
-00005230: 6520 7772 6974 6572 0a20 2020 2020 2020  e writer.       
-00005240: 2073 656c 662e 7772 6974 6572 2e69 6d61   self.writer.ima
-00005250: 6765 5f6f 7267 203d 2073 656c 662e 696d  ge_org = self.im
-00005260: 6167 655f 6f72 670a 2020 2020 2020 2020  age_org.        
-00005270: 7365 6c66 2e77 7269 7465 722e 7363 616c  self.writer.scal
-00005280: 655f 7920 3d20 7365 6c66 2e73 6361 6c65  e_y = self.scale
-00005290: 5f79 0a20 2020 2020 2020 2073 656c 662e  _y.        self.
-000052a0: 7772 6974 6572 2e73 6361 6c65 5f78 203d  writer.scale_x =
-000052b0: 2073 656c 662e 7363 616c 655f 780a 2020   self.scale_x.  
-000052c0: 2020 2020 2020 7365 6c66 2e77 7269 7465        self.write
-000052d0: 722e 6865 6967 6874 5f6f 7267 203d 2073  r.height_org = s
-000052e0: 656c 662e 6865 6967 6874 5f6f 7267 0a20  elf.height_org. 
-000052f0: 2020 2020 2020 2073 656c 662e 7772 6974         self.writ
-00005300: 6572 2e77 6964 7468 5f6f 7267 203d 2073  er.width_org = s
-00005310: 656c 662e 7769 6474 685f 6f72 670a 0a20  elf.width_org.. 
-00005320: 2020 2064 6566 2073 7461 7274 5f6e 6577     def start_new
-00005330: 5f73 6573 7369 6f6e 5f61 6e64 5f6d 6f64  _session_and_mod
-00005340: 656c 5f6f 6c64 2873 656c 662c 206d 6f64  el_old(self, mod
-00005350: 656c 5f64 6972 293a 0a20 2020 2020 2020  el_dir):.       
-00005360: 2073 656c 662e 6c6f 6767 6572 2e64 6562   self.logger.deb
-00005370: 7567 2822 656e 7465 7220 7374 6172 745f  ug("enter start_
-00005380: 6e65 775f 7365 7373 696f 6e5f 616e 645f  new_session_and_
-00005390: 6d6f 6465 6c20 286d 6f64 656c 5f64 6972  model (model_dir
-000053a0: 3d25 7329 222c 206d 6f64 656c 5f64 6972  =%s)", model_dir
-000053b0: 290a 2020 2020 2020 2020 636f 6e66 6967  ).        config
-000053c0: 203d 2074 662e 436f 6e66 6967 5072 6f74   = tf.ConfigProt
-000053d0: 6f28 290a 2020 2020 2020 2020 636f 6e66  o().        conf
-000053e0: 6967 2e67 7075 5f6f 7074 696f 6e73 2e61  ig.gpu_options.a
-000053f0: 6c6c 6f77 5f67 726f 7774 6820 3d20 5472  llow_growth = Tr
-00005400: 7565 0a0a 2020 2020 2020 2020 7365 7373  ue..        sess
-00005410: 696f 6e20 3d20 7466 2e49 6e74 6572 6163  ion = tf.Interac
-00005420: 7469 7665 5365 7373 696f 6e28 290a 2020  tiveSession().  
-00005430: 2020 2020 2020 6d6f 6465 6c20 3d20 6c6f        model = lo
-00005440: 6164 5f6d 6f64 656c 286d 6f64 656c 5f64  ad_model(model_d
-00005450: 6972 2c20 636f 6d70 696c 653d 4661 6c73  ir, compile=Fals
-00005460: 6529 0a0a 2020 2020 2020 2020 7265 7475  e)..        retu
-00005470: 726e 206d 6f64 656c 2c20 7365 7373 696f  rn model, sessio
-00005480: 6e0a 0a20 2020 200a 2020 2020 6465 6620  n..    .    def 
-00005490: 7374 6172 745f 6e65 775f 7365 7373 696f  start_new_sessio
-000054a0: 6e5f 616e 645f 6d6f 6465 6c28 7365 6c66  n_and_model(self
-000054b0: 2c20 6d6f 6465 6c5f 6469 7229 3a0a 2020  , model_dir):.  
-000054c0: 2020 2020 2020 7365 6c66 2e6c 6f67 6765        self.logge
-000054d0: 722e 6465 6275 6728 2265 6e74 6572 2073  r.debug("enter s
-000054e0: 7461 7274 5f6e 6577 5f73 6573 7369 6f6e  tart_new_session
-000054f0: 5f61 6e64 5f6d 6f64 656c 2028 6d6f 6465  _and_model (mode
-00005500: 6c5f 6469 723d 2573 2922 2c20 6d6f 6465  l_dir=%s)", mode
-00005510: 6c5f 6469 7229 0a20 2020 2020 2020 2023  l_dir).        #
-00005520: 6770 755f 6f70 7469 6f6e 7320 3d20 7466  gpu_options = tf
-00005530: 2e63 6f6d 7061 742e 7631 2e47 5055 4f70  .compat.v1.GPUOp
-00005540: 7469 6f6e 7328 616c 6c6f 775f 6772 6f77  tions(allow_grow
-00005550: 7468 3d54 7275 6529 0a20 2020 2020 2020  th=True).       
-00005560: 2023 6770 755f 6f70 7469 6f6e 7320 3d20   #gpu_options = 
-00005570: 7466 2e63 6f6d 7061 742e 7631 2e47 5055  tf.compat.v1.GPU
-00005580: 4f70 7469 6f6e 7328 7065 725f 7072 6f63  Options(per_proc
-00005590: 6573 735f 6770 755f 6d65 6d6f 7279 5f66  ess_gpu_memory_f
-000055a0: 7261 6374 696f 6e3d 372e 372c 2061 6c6c  raction=7.7, all
-000055b0: 6f77 5f67 726f 7774 683d 5472 7565 290a  ow_growth=True).
-000055c0: 2020 2020 2020 2020 2373 6573 7369 6f6e          #session
-000055d0: 203d 2074 662e 636f 6d70 6174 2e76 312e   = tf.compat.v1.
-000055e0: 5365 7373 696f 6e28 636f 6e66 6967 3d74  Session(config=t
-000055f0: 662e 636f 6d70 6174 2e76 312e 436f 6e66  f.compat.v1.Conf
-00005600: 6967 5072 6f74 6f28 6770 755f 6f70 7469  igProto(gpu_opti
-00005610: 6f6e 733d 6770 755f 6f70 7469 6f6e 7329  ons=gpu_options)
-00005620: 290a 2020 2020 2020 2020 7068 7973 6963  ).        physic
-00005630: 616c 5f64 6576 6963 6573 203d 2074 662e  al_devices = tf.
-00005640: 636f 6e66 6967 2e6c 6973 745f 7068 7973  config.list_phys
-00005650: 6963 616c 5f64 6576 6963 6573 2827 4750  ical_devices('GP
-00005660: 5527 290a 2020 2020 2020 2020 7472 793a  U').        try:
-00005670: 0a20 2020 2020 2020 2020 2020 2074 662e  .            tf.
-00005680: 636f 6e66 6967 2e65 7870 6572 696d 656e  config.experimen
-00005690: 7461 6c2e 7365 745f 6d65 6d6f 7279 5f67  tal.set_memory_g
-000056a0: 726f 7774 6828 7068 7973 6963 616c 5f64  rowth(physical_d
-000056b0: 6576 6963 6573 5b30 5d2c 2054 7275 6529  evices[0], True)
-000056c0: 0a20 2020 2020 2020 2065 7863 6570 743a  .        except:
-000056d0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
-000056e0: 662e 6c6f 6767 6572 2e77 6172 6e69 6e67  f.logger.warning
-000056f0: 2822 6e6f 2047 5055 2064 6576 6963 6520  ("no GPU device 
-00005700: 6176 6169 6c61 626c 6522 290a 2020 2020  available").    
-00005710: 2020 2020 6966 206d 6f64 656c 5f64 6972      if model_dir
-00005720: 2e65 6e64 7377 6974 6828 272e 6835 2729  .endswith('.h5')
-00005730: 2061 6e64 2050 6174 6828 6d6f 6465 6c5f   and Path(model_
-00005740: 6469 725b 3a2d 335d 292e 6578 6973 7473  dir[:-3]).exists
-00005750: 2829 3a0a 2020 2020 2020 2020 2020 2020  ():.            
-00005760: 2320 7072 6566 6572 2053 6176 6564 4d6f  # prefer SavedMo
-00005770: 6465 6c20 6f76 6572 2048 4446 3520 666f  del over HDF5 fo
-00005780: 726d 6174 2069 6620 6974 2065 7869 7374  rmat if it exist
-00005790: 730a 2020 2020 2020 2020 2020 2020 6d6f  s.            mo
-000057a0: 6465 6c5f 6469 7220 3d20 6d6f 6465 6c5f  del_dir = model_
-000057b0: 6469 725b 3a2d 335d 0a20 2020 2020 2020  dir[:-3].       
-000057c0: 2069 6620 6d6f 6465 6c5f 6469 7220 696e   if model_dir in
-000057d0: 2073 656c 662e 6d6f 6465 6c73 3a0a 2020   self.models:.  
-000057e0: 2020 2020 2020 2020 2020 6d6f 6465 6c20            model 
-000057f0: 3d20 7365 6c66 2e6d 6f64 656c 735b 6d6f  = self.models[mo
-00005800: 6465 6c5f 6469 725d 0a20 2020 2020 2020  del_dir].       
-00005810: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00005820: 2020 206d 6f64 656c 203d 206c 6f61 645f     model = load_
-00005830: 6d6f 6465 6c28 6d6f 6465 6c5f 6469 722c  model(model_dir,
-00005840: 2063 6f6d 7069 6c65 3d46 616c 7365 290a   compile=False).
-00005850: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00005860: 2e6d 6f64 656c 735b 6d6f 6465 6c5f 6469  .models[model_di
-00005870: 725d 203d 206d 6f64 656c 0a0a 2020 2020  r] = model..    
-00005880: 2020 2020 7265 7475 726e 206d 6f64 656c      return model
-00005890: 2c20 4e6f 6e65 0a0a 2020 2020 6465 6620  , None..    def 
-000058a0: 646f 5f70 7265 6469 6374 696f 6e28 7365  do_prediction(se
-000058b0: 6c66 2c20 7061 7463 6865 732c 2069 6d67  lf, patches, img
-000058c0: 2c20 6d6f 6465 6c2c 206d 6172 6769 6e61  , model, margina
-000058d0: 6c5f 6f66 5f70 6174 6368 5f70 6572 6365  l_of_patch_perce
-000058e0: 6e74 3d30 2e31 293a 0a20 2020 2020 2020  nt=0.1):.       
-000058f0: 2073 656c 662e 6c6f 6767 6572 2e64 6562   self.logger.deb
-00005900: 7567 2822 656e 7465 7220 646f 5f70 7265  ug("enter do_pre
-00005910: 6469 6374 696f 6e22 290a 0a20 2020 2020  diction")..     
-00005920: 2020 2069 6d67 5f68 6569 6768 745f 6d6f     img_height_mo
-00005930: 6465 6c20 3d20 6d6f 6465 6c2e 6c61 7965  del = model.laye
-00005940: 7273 5b6c 656e 286d 6f64 656c 2e6c 6179  rs[len(model.lay
-00005950: 6572 7329 202d 2031 5d2e 6f75 7470 7574  ers) - 1].output
-00005960: 5f73 6861 7065 5b31 5d0a 2020 2020 2020  _shape[1].      
-00005970: 2020 696d 675f 7769 6474 685f 6d6f 6465    img_width_mode
-00005980: 6c20 3d20 6d6f 6465 6c2e 6c61 7965 7273  l = model.layers
-00005990: 5b6c 656e 286d 6f64 656c 2e6c 6179 6572  [len(model.layer
-000059a0: 7329 202d 2031 5d2e 6f75 7470 7574 5f73  s) - 1].output_s
-000059b0: 6861 7065 5b32 5d0a 0a20 2020 2020 2020  hape[2]..       
-000059c0: 2069 6620 6e6f 7420 7061 7463 6865 733a   if not patches:
-000059d0: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
-000059e0: 5f68 5f70 6167 6520 3d20 696d 672e 7368  _h_page = img.sh
-000059f0: 6170 655b 305d 0a20 2020 2020 2020 2020  ape[0].         
-00005a00: 2020 2069 6d67 5f77 5f70 6167 6520 3d20     img_w_page = 
-00005a10: 696d 672e 7368 6170 655b 315d 0a20 2020  img.shape[1].   
-00005a20: 2020 2020 2020 2020 2069 6d67 203d 2069           img = i
-00005a30: 6d67 202f 2066 6c6f 6174 2832 3535 2e30  mg / float(255.0
-00005a40: 290a 2020 2020 2020 2020 2020 2020 696d  ).            im
-00005a50: 6720 3d20 7265 7369 7a65 5f69 6d61 6765  g = resize_image
-00005a60: 2869 6d67 2c20 696d 675f 6865 6967 6874  (img, img_height
-00005a70: 5f6d 6f64 656c 2c20 696d 675f 7769 6474  _model, img_widt
-00005a80: 685f 6d6f 6465 6c29 0a0a 2020 2020 2020  h_model)..      
-00005a90: 2020 2020 2020 6c61 6265 6c5f 705f 7072        label_p_pr
-00005aa0: 6564 203d 206d 6f64 656c 2e70 7265 6469  ed = model.predi
-00005ab0: 6374 2869 6d67 2e72 6573 6861 7065 2831  ct(img.reshape(1
-00005ac0: 2c20 696d 672e 7368 6170 655b 305d 2c20  , img.shape[0], 
-00005ad0: 696d 672e 7368 6170 655b 315d 2c20 696d  img.shape[1], im
-00005ae0: 672e 7368 6170 655b 325d 292c 0a20 2020  g.shape[2]),.   
-00005af0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005b10: 2020 2020 2020 7665 7262 6f73 653d 3029        verbose=0)
-00005b20: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
-00005b30: 6720 3d20 6e70 2e61 7267 6d61 7828 6c61  g = np.argmax(la
-00005b40: 6265 6c5f 705f 7072 6564 2c20 6178 6973  bel_p_pred, axis
-00005b50: 3d33 295b 305d 0a20 2020 2020 2020 2020  =3)[0].         
-00005b60: 2020 2073 6567 5f63 6f6c 6f72 203d 206e     seg_color = n
-00005b70: 702e 7265 7065 6174 2873 6567 5b3a 2c20  p.repeat(seg[:, 
-00005b80: 3a2c 206e 702e 6e65 7761 7869 735d 2c20  :, np.newaxis], 
-00005b90: 332c 2061 7869 733d 3229 0a20 2020 2020  3, axis=2).     
-00005ba0: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
-00005bb0: 6e5f 7472 7565 203d 2072 6573 697a 655f  n_true = resize_
-00005bc0: 696d 6167 6528 7365 675f 636f 6c6f 722c  image(seg_color,
-00005bd0: 2069 6d67 5f68 5f70 6167 652c 2069 6d67   img_h_page, img
-00005be0: 5f77 5f70 6167 6529 0a20 2020 2020 2020  _w_page).       
-00005bf0: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
-00005c00: 7472 7565 203d 2070 7265 6469 6374 696f  true = predictio
-00005c10: 6e5f 7472 7565 2e61 7374 7970 6528 6e70  n_true.astype(np
-00005c20: 2e75 696e 7438 290a 0a0a 2020 2020 2020  .uint8)...      
-00005c30: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00005c40: 2020 2020 6966 2069 6d67 2e73 6861 7065      if img.shape
-00005c50: 5b30 5d20 3c20 696d 675f 6865 6967 6874  [0] < img_height
-00005c60: 5f6d 6f64 656c 3a0a 2020 2020 2020 2020  _model:.        
-00005c70: 2020 2020 2020 2020 696d 6720 3d20 7265          img = re
-00005c80: 7369 7a65 5f69 6d61 6765 2869 6d67 2c20  size_image(img, 
-00005c90: 696d 675f 6865 6967 6874 5f6d 6f64 656c  img_height_model
-00005ca0: 2c20 696d 672e 7368 6170 655b 315d 290a  , img.shape[1]).
-00005cb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00005cc0: 696d 672e 7368 6170 655b 315d 203c 2069  img.shape[1] < i
-00005cd0: 6d67 5f77 6964 7468 5f6d 6f64 656c 3a0a  mg_width_model:.
-00005ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00005cf0: 696d 6720 3d20 7265 7369 7a65 5f69 6d61  img = resize_ima
-00005d00: 6765 2869 6d67 2c20 696d 672e 7368 6170  ge(img, img.shap
-00005d10: 655b 305d 2c20 696d 675f 7769 6474 685f  e[0], img_width_
-00005d20: 6d6f 6465 6c29 0a0a 2020 2020 2020 2020  model)..        
-00005d30: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
-00005d40: 6465 6275 6728 2250 6174 6368 2073 697a  debug("Patch siz
-00005d50: 653a 2025 7378 2573 222c 2069 6d67 5f68  e: %sx%s", img_h
-00005d60: 6569 6768 745f 6d6f 6465 6c2c 2069 6d67  eight_model, img
-00005d70: 5f77 6964 7468 5f6d 6f64 656c 290a 2020  _width_model).  
-00005d80: 2020 2020 2020 2020 2020 6d61 7267 696e            margin
-00005d90: 203d 2069 6e74 286d 6172 6769 6e61 6c5f   = int(marginal_
-00005da0: 6f66 5f70 6174 6368 5f70 6572 6365 6e74  of_patch_percent
-00005db0: 202a 2069 6d67 5f68 6569 6768 745f 6d6f   * img_height_mo
-00005dc0: 6465 6c29 0a20 2020 2020 2020 2020 2020  del).           
-00005dd0: 2077 6964 7468 5f6d 6964 203d 2069 6d67   width_mid = img
-00005de0: 5f77 6964 7468 5f6d 6f64 656c 202d 2032  _width_model - 2
-00005df0: 202a 206d 6172 6769 6e0a 2020 2020 2020   * margin.      
-00005e00: 2020 2020 2020 6865 6967 6874 5f6d 6964        height_mid
-00005e10: 203d 2069 6d67 5f68 6569 6768 745f 6d6f   = img_height_mo
-00005e20: 6465 6c20 2d20 3220 2a20 6d61 7267 696e  del - 2 * margin
-00005e30: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
-00005e40: 203d 2069 6d67 202f 2066 6c6f 6174 2832   = img / float(2
-00005e50: 3535 2e30 290a 2020 2020 2020 2020 2020  55.0).          
-00005e60: 2020 696d 6720 3d20 696d 672e 6173 7479    img = img.asty
-00005e70: 7065 286e 702e 666c 6f61 7431 3629 0a20  pe(np.float16). 
-00005e80: 2020 2020 2020 2020 2020 2069 6d67 5f68             img_h
-00005e90: 203d 2069 6d67 2e73 6861 7065 5b30 5d0a   = img.shape[0].
-00005ea0: 2020 2020 2020 2020 2020 2020 696d 675f              img_
-00005eb0: 7720 3d20 696d 672e 7368 6170 655b 315d  w = img.shape[1]
-00005ec0: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
-00005ed0: 6469 6374 696f 6e5f 7472 7565 203d 206e  diction_true = n
-00005ee0: 702e 7a65 726f 7328 2869 6d67 5f68 2c20  p.zeros((img_h, 
-00005ef0: 696d 675f 772c 2033 2929 0a20 2020 2020  img_w, 3)).     
-00005f00: 2020 2020 2020 206d 6173 6b5f 7472 7565         mask_true
-00005f10: 203d 206e 702e 7a65 726f 7328 2869 6d67   = np.zeros((img
-00005f20: 5f68 2c20 696d 675f 7729 290a 2020 2020  _h, img_w)).    
-00005f30: 2020 2020 2020 2020 6e78 6620 3d20 696d          nxf = im
-00005f40: 675f 7720 2f20 666c 6f61 7428 7769 6474  g_w / float(widt
-00005f50: 685f 6d69 6429 0a20 2020 2020 2020 2020  h_mid).         
-00005f60: 2020 206e 7966 203d 2069 6d67 5f68 202f     nyf = img_h /
-00005f70: 2066 6c6f 6174 2868 6569 6768 745f 6d69   float(height_mi
-00005f80: 6429 0a20 2020 2020 2020 2020 2020 206e  d).            n
-00005f90: 7866 203d 2069 6e74 286e 7866 2920 2b20  xf = int(nxf) + 
-00005fa0: 3120 6966 206e 7866 203e 2069 6e74 286e  1 if nxf > int(n
-00005fb0: 7866 2920 656c 7365 2069 6e74 286e 7866  xf) else int(nxf
-00005fc0: 290a 2020 2020 2020 2020 2020 2020 6e79  ).            ny
-00005fd0: 6620 3d20 696e 7428 6e79 6629 202b 2031  f = int(nyf) + 1
-00005fe0: 2069 6620 6e79 6620 3e20 696e 7428 6e79   if nyf > int(ny
-00005ff0: 6629 2065 6c73 6520 696e 7428 6e79 6629  f) else int(nyf)
-00006000: 0a0a 2020 2020 2020 2020 2020 2020 666f  ..            fo
-00006010: 7220 6920 696e 2072 616e 6765 286e 7866  r i in range(nxf
-00006020: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00006030: 2020 2066 6f72 206a 2069 6e20 7261 6e67     for j in rang
-00006040: 6528 6e79 6629 3a0a 2020 2020 2020 2020  e(nyf):.        
-00006050: 2020 2020 2020 2020 2020 2020 6966 2069              if i
-00006060: 203d 3d20 303a 0a20 2020 2020 2020 2020   == 0:.         
-00006070: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00006080: 6e64 6578 5f78 5f64 203d 2069 202a 2077  ndex_x_d = i * w
-00006090: 6964 7468 5f6d 6964 0a20 2020 2020 2020  idth_mid.       
-000060a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000060b0: 2069 6e64 6578 5f78 5f75 203d 2069 6e64   index_x_u = ind
-000060c0: 6578 5f78 5f64 202b 2069 6d67 5f77 6964  ex_x_d + img_wid
-000060d0: 7468 5f6d 6f64 656c 0a20 2020 2020 2020  th_model.       
-000060e0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-000060f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00006100: 2020 2020 2020 2020 2020 2069 6e64 6578             index
-00006110: 5f78 5f64 203d 2069 202a 2077 6964 7468  _x_d = i * width
-00006120: 5f6d 6964 0a20 2020 2020 2020 2020 2020  _mid.           
-00006130: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
-00006140: 6578 5f78 5f75 203d 2069 6e64 6578 5f78  ex_x_u = index_x
-00006150: 5f64 202b 2069 6d67 5f77 6964 7468 5f6d  _d + img_width_m
-00006160: 6f64 656c 0a20 2020 2020 2020 2020 2020  odel.           
-00006170: 2020 2020 2020 2020 2069 6620 6a20 3d3d           if j ==
-00006180: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
-00006190: 2020 2020 2020 2020 2020 2020 696e 6465              inde
-000061a0: 785f 795f 6420 3d20 6a20 2a20 6865 6967  x_y_d = j * heig
-000061b0: 6874 5f6d 6964 0a20 2020 2020 2020 2020  ht_mid.         
-000061c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-000061d0: 6e64 6578 5f79 5f75 203d 2069 6e64 6578  ndex_y_u = index
-000061e0: 5f79 5f64 202b 2069 6d67 5f68 6569 6768  _y_d + img_heigh
-000061f0: 745f 6d6f 6465 6c0a 2020 2020 2020 2020  t_model.        
-00006200: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00006210: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00006220: 2020 2020 2020 2020 2020 696e 6465 785f            index_
-00006230: 795f 6420 3d20 6a20 2a20 6865 6967 6874  y_d = j * height
-00006240: 5f6d 6964 0a20 2020 2020 2020 2020 2020  _mid.           
-00006250: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
-00006260: 6578 5f79 5f75 203d 2069 6e64 6578 5f79  ex_y_u = index_y
-00006270: 5f64 202b 2069 6d67 5f68 6569 6768 745f  _d + img_height_
-00006280: 6d6f 6465 6c0a 2020 2020 2020 2020 2020  model.          
-00006290: 2020 2020 2020 2020 2020 6966 2069 6e64            if ind
-000062a0: 6578 5f78 5f75 203e 2069 6d67 5f77 3a0a  ex_x_u > img_w:.
-000062b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000062c0: 2020 2020 2020 2020 696e 6465 785f 785f          index_x_
-000062d0: 7520 3d20 696d 675f 770a 2020 2020 2020  u = img_w.      
-000062e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000062f0: 2020 696e 6465 785f 785f 6420 3d20 696d    index_x_d = im
-00006300: 675f 7720 2d20 696d 675f 7769 6474 685f  g_w - img_width_
-00006310: 6d6f 6465 6c0a 2020 2020 2020 2020 2020  model.          
-00006320: 2020 2020 2020 2020 2020 6966 2069 6e64            if ind
-00006330: 6578 5f79 5f75 203e 2069 6d67 5f68 3a0a  ex_y_u > img_h:.
-00006340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006350: 2020 2020 2020 2020 696e 6465 785f 795f          index_y_
-00006360: 7520 3d20 696d 675f 680a 2020 2020 2020  u = img_h.      
-00006370: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006380: 2020 696e 6465 785f 795f 6420 3d20 696d    index_y_d = im
-00006390: 675f 6820 2d20 696d 675f 6865 6967 6874  g_h - img_height
-000063a0: 5f6d 6f64 656c 0a0a 2020 2020 2020 2020  _model..        
-000063b0: 2020 2020 2020 2020 2020 2020 696d 675f              img_
-000063c0: 7061 7463 6820 3d20 696d 675b 696e 6465  patch = img[inde
-000063d0: 785f 795f 643a 696e 6465 785f 795f 752c  x_y_d:index_y_u,
-000063e0: 2069 6e64 6578 5f78 5f64 3a69 6e64 6578   index_x_d:index
-000063f0: 5f78 5f75 2c20 3a5d 0a20 2020 2020 2020  _x_u, :].       
-00006400: 2020 2020 2020 2020 2020 2020 206c 6162               lab
-00006410: 656c 5f70 5f70 7265 6420 3d20 6d6f 6465  el_p_pred = mode
-00006420: 6c2e 7072 6564 6963 7428 696d 675f 7061  l.predict(img_pa
-00006430: 7463 682e 7265 7368 6170 6528 312c 2069  tch.reshape(1, i
-00006440: 6d67 5f70 6174 6368 2e73 6861 7065 5b30  mg_patch.shape[0
-00006450: 5d2c 2069 6d67 5f70 6174 6368 2e73 6861  ], img_patch.sha
-00006460: 7065 5b31 5d2c 2069 6d67 5f70 6174 6368  pe[1], img_patch
-00006470: 2e73 6861 7065 5b32 5d29 2c0a 2020 2020  .shape[2]),.    
-00006480: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000064a0: 2020 2020 2020 2020 2020 2020 2076 6572               ver
-000064b0: 626f 7365 3d30 290a 2020 2020 2020 2020  bose=0).        
-000064c0: 2020 2020 2020 2020 2020 2020 7365 6720              seg 
-000064d0: 3d20 6e70 2e61 7267 6d61 7828 6c61 6265  = np.argmax(labe
-000064e0: 6c5f 705f 7072 6564 2c20 6178 6973 3d33  l_p_pred, axis=3
-000064f0: 295b 305d 0a20 2020 2020 2020 2020 2020  )[0].           
-00006500: 2020 2020 2020 2020 2073 6567 5f63 6f6c           seg_col
-00006510: 6f72 203d 206e 702e 7265 7065 6174 2873  or = np.repeat(s
-00006520: 6567 5b3a 2c20 3a2c 206e 702e 6e65 7761  eg[:, :, np.newa
-00006530: 7869 735d 2c20 332c 2061 7869 733d 3229  xis], 3, axis=2)
-00006540: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00006550: 2020 2020 2020 6966 2069 203d 3d20 3020        if i == 0 
-00006560: 616e 6420 6a20 3d3d 2030 3a0a 2020 2020  and j == 0:.    
-00006570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006580: 2020 2020 7365 675f 636f 6c6f 7220 3d20      seg_color = 
-00006590: 7365 675f 636f 6c6f 725b 3020 3a20 7365  seg_color[0 : se
-000065a0: 675f 636f 6c6f 722e 7368 6170 655b 305d  g_color.shape[0]
-000065b0: 202d 206d 6172 6769 6e2c 2030 203a 2073   - margin, 0 : s
-000065c0: 6567 5f63 6f6c 6f72 2e73 6861 7065 5b31  eg_color.shape[1
-000065d0: 5d20 2d20 6d61 7267 696e 2c20 3a5d 0a20  ] - margin, :]. 
-000065e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000065f0: 2020 2020 2020 2073 6567 203d 2073 6567         seg = seg
-00006600: 5b30 203a 2073 6567 2e73 6861 7065 5b30  [0 : seg.shape[0
-00006610: 5d20 2d20 6d61 7267 696e 2c20 3020 3a20  ] - margin, 0 : 
-00006620: 7365 672e 7368 6170 655b 315d 202d 206d  seg.shape[1] - m
-00006630: 6172 6769 6e5d 0a20 2020 2020 2020 2020  argin].         
-00006640: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-00006650: 6173 6b5f 7472 7565 5b69 6e64 6578 5f79  ask_true[index_y
-00006660: 5f64 202b 2030 203a 2069 6e64 6578 5f79  _d + 0 : index_y
-00006670: 5f75 202d 206d 6172 6769 6e2c 2069 6e64  _u - margin, ind
-00006680: 6578 5f78 5f64 202b 2030 203a 2069 6e64  ex_x_d + 0 : ind
-00006690: 6578 5f78 5f75 202d 206d 6172 6769 6e5d  ex_x_u - margin]
-000066a0: 203d 2073 6567 0a20 2020 2020 2020 2020   = seg.         
-000066b0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000066c0: 7265 6469 6374 696f 6e5f 7472 7565 5b69  rediction_true[i
-000066d0: 6e64 6578 5f79 5f64 202b 2030 203a 2069  ndex_y_d + 0 : i
-000066e0: 6e64 6578 5f79 5f75 202d 206d 6172 6769  ndex_y_u - margi
-000066f0: 6e2c 2069 6e64 6578 5f78 5f64 202b 2030  n, index_x_d + 0
-00006700: 203a 2069 6e64 6578 5f78 5f75 202d 206d   : index_x_u - m
-00006710: 6172 6769 6e2c 203a 5d20 3d20 7365 675f  argin, :] = seg_
-00006720: 636f 6c6f 720a 2020 2020 2020 2020 2020  color.          
-00006730: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
-00006740: 203d 3d20 6e78 6620 2d20 3120 616e 6420   == nxf - 1 and 
-00006750: 6a20 3d3d 206e 7966 202d 2031 3a0a 2020  j == nyf - 1:.  
-00006760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006770: 2020 2020 2020 7365 675f 636f 6c6f 7220        seg_color 
-00006780: 3d20 7365 675f 636f 6c6f 725b 6d61 7267  = seg_color[marg
-00006790: 696e 203a 2073 6567 5f63 6f6c 6f72 2e73  in : seg_color.s
-000067a0: 6861 7065 5b30 5d20 2d20 302c 206d 6172  hape[0] - 0, mar
-000067b0: 6769 6e20 3a20 7365 675f 636f 6c6f 722e  gin : seg_color.
-000067c0: 7368 6170 655b 315d 202d 2030 2c20 3a5d  shape[1] - 0, :]
-000067d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000067e0: 2020 2020 2020 2020 2073 6567 203d 2073           seg = s
-000067f0: 6567 5b6d 6172 6769 6e20 3a20 7365 672e  eg[margin : seg.
-00006800: 7368 6170 655b 305d 202d 2030 2c20 6d61  shape[0] - 0, ma
-00006810: 7267 696e 203a 2073 6567 2e73 6861 7065  rgin : seg.shape
-00006820: 5b31 5d20 2d20 305d 0a20 2020 2020 2020  [1] - 0].       
-00006830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006840: 206d 6173 6b5f 7472 7565 5b69 6e64 6578   mask_true[index
-00006850: 5f79 5f64 202b 206d 6172 6769 6e20 3a20  _y_d + margin : 
-00006860: 696e 6465 785f 795f 7520 2d20 302c 2069  index_y_u - 0, i
-00006870: 6e64 6578 5f78 5f64 202b 206d 6172 6769  ndex_x_d + margi
-00006880: 6e20 3a20 696e 6465 785f 785f 7520 2d20  n : index_x_u - 
-00006890: 305d 203d 2073 6567 0a20 2020 2020 2020  0] = seg.       
-000068a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000068b0: 2070 7265 6469 6374 696f 6e5f 7472 7565   prediction_true
-000068c0: 5b69 6e64 6578 5f79 5f64 202b 206d 6172  [index_y_d + mar
-000068d0: 6769 6e20 3a20 696e 6465 785f 795f 7520  gin : index_y_u 
-000068e0: 2d20 302c 2069 6e64 6578 5f78 5f64 202b  - 0, index_x_d +
-000068f0: 206d 6172 6769 6e20 3a20 696e 6465 785f   margin : index_
-00006900: 785f 7520 2d20 302c 203a 5d20 3d20 7365  x_u - 0, :] = se
-00006910: 675f 636f 6c6f 720a 2020 2020 2020 2020  g_color.        
-00006920: 2020 2020 2020 2020 2020 2020 656c 6966              elif
-00006930: 2069 203d 3d20 3020 616e 6420 6a20 3d3d   i == 0 and j ==
-00006940: 206e 7966 202d 2031 3a0a 2020 2020 2020   nyf - 1:.      
-00006950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006960: 2020 7365 675f 636f 6c6f 7220 3d20 7365    seg_color = se
-00006970: 675f 636f 6c6f 725b 6d61 7267 696e 203a  g_color[margin :
-00006980: 2073 6567 5f63 6f6c 6f72 2e73 6861 7065   seg_color.shape
-00006990: 5b30 5d20 2d20 302c 2030 203a 2073 6567  [0] - 0, 0 : seg
-000069a0: 5f63 6f6c 6f72 2e73 6861 7065 5b31 5d20  _color.shape[1] 
-000069b0: 2d20 6d61 7267 696e 2c20 3a5d 0a20 2020  - margin, :].   
-000069c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000069d0: 2020 2020 2073 6567 203d 2073 6567 5b6d       seg = seg[m
-000069e0: 6172 6769 6e20 3a20 7365 672e 7368 6170  argin : seg.shap
-000069f0: 655b 305d 202d 2030 2c20 3020 3a20 7365  e[0] - 0, 0 : se
-00006a00: 672e 7368 6170 655b 315d 202d 206d 6172  g.shape[1] - mar
-00006a10: 6769 6e5d 0a20 2020 2020 2020 2020 2020  gin].           
-00006a20: 2020 2020 2020 2020 2020 2020 206d 6173               mas
-00006a30: 6b5f 7472 7565 5b69 6e64 6578 5f79 5f64  k_true[index_y_d
-00006a40: 202b 206d 6172 6769 6e20 3a20 696e 6465   + margin : inde
-00006a50: 785f 795f 7520 2d20 302c 2069 6e64 6578  x_y_u - 0, index
-00006a60: 5f78 5f64 202b 2030 203a 2069 6e64 6578  _x_d + 0 : index
-00006a70: 5f78 5f75 202d 206d 6172 6769 6e5d 203d  _x_u - margin] =
-00006a80: 2073 6567 0a20 2020 2020 2020 2020 2020   seg.           
-00006a90: 2020 2020 2020 2020 2020 2020 2070 7265               pre
-00006aa0: 6469 6374 696f 6e5f 7472 7565 5b69 6e64  diction_true[ind
-00006ab0: 6578 5f79 5f64 202b 206d 6172 6769 6e20  ex_y_d + margin 
-00006ac0: 3a20 696e 6465 785f 795f 7520 2d20 302c  : index_y_u - 0,
-00006ad0: 2069 6e64 6578 5f78 5f64 202b 2030 203a   index_x_d + 0 :
-00006ae0: 2069 6e64 6578 5f78 5f75 202d 206d 6172   index_x_u - mar
-00006af0: 6769 6e2c 203a 5d20 3d20 7365 675f 636f  gin, :] = seg_co
-00006b00: 6c6f 720a 2020 2020 2020 2020 2020 2020  lor.            
-00006b10: 2020 2020 2020 2020 656c 6966 2069 203d          elif i =
-00006b20: 3d20 6e78 6620 2d20 3120 616e 6420 6a20  = nxf - 1 and j 
-00006b30: 3d3d 2030 3a0a 2020 2020 2020 2020 2020  == 0:.          
-00006b40: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00006b50: 675f 636f 6c6f 7220 3d20 7365 675f 636f  g_color = seg_co
-00006b60: 6c6f 725b 3020 3a20 7365 675f 636f 6c6f  lor[0 : seg_colo
-00006b70: 722e 7368 6170 655b 305d 202d 206d 6172  r.shape[0] - mar
-00006b80: 6769 6e2c 206d 6172 6769 6e20 3a20 7365  gin, margin : se
-00006b90: 675f 636f 6c6f 722e 7368 6170 655b 315d  g_color.shape[1]
-00006ba0: 202d 2030 2c20 3a5d 0a20 2020 2020 2020   - 0, :].       
-00006bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006bc0: 2073 6567 203d 2073 6567 5b30 203a 2073   seg = seg[0 : s
-00006bd0: 6567 2e73 6861 7065 5b30 5d20 2d20 6d61  eg.shape[0] - ma
-00006be0: 7267 696e 2c20 6d61 7267 696e 203a 2073  rgin, margin : s
-00006bf0: 6567 2e73 6861 7065 5b31 5d20 2d20 305d  eg.shape[1] - 0]
-00006c00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006c10: 2020 2020 2020 2020 206d 6173 6b5f 7472           mask_tr
-00006c20: 7565 5b69 6e64 6578 5f79 5f64 202b 2030  ue[index_y_d + 0
-00006c30: 203a 2069 6e64 6578 5f79 5f75 202d 206d   : index_y_u - m
-00006c40: 6172 6769 6e2c 2069 6e64 6578 5f78 5f64  argin, index_x_d
-00006c50: 202b 206d 6172 6769 6e20 3a20 696e 6465   + margin : inde
-00006c60: 785f 785f 7520 2d20 305d 203d 2073 6567  x_x_u - 0] = seg
-00006c70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00006c80: 2020 2020 2020 2020 2070 7265 6469 6374           predict
-00006c90: 696f 6e5f 7472 7565 5b69 6e64 6578 5f79  ion_true[index_y
-00006ca0: 5f64 202b 2030 203a 2069 6e64 6578 5f79  _d + 0 : index_y
-00006cb0: 5f75 202d 206d 6172 6769 6e2c 2069 6e64  _u - margin, ind
-00006cc0: 6578 5f78 5f64 202b 206d 6172 6769 6e20  ex_x_d + margin 
-00006cd0: 3a20 696e 6465 785f 785f 7520 2d20 302c  : index_x_u - 0,
-00006ce0: 203a 5d20 3d20 7365 675f 636f 6c6f 720a   :] = seg_color.
-00006cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d00: 2020 2020 656c 6966 2069 203d 3d20 3020      elif i == 0 
-00006d10: 616e 6420 6a20 213d 2030 2061 6e64 206a  and j != 0 and j
-00006d20: 2021 3d20 6e79 6620 2d20 313a 0a20 2020   != nyf - 1:.   
-00006d30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006d40: 2020 2020 2073 6567 5f63 6f6c 6f72 203d       seg_color =
-00006d50: 2073 6567 5f63 6f6c 6f72 5b6d 6172 6769   seg_color[margi
-00006d60: 6e20 3a20 7365 675f 636f 6c6f 722e 7368  n : seg_color.sh
-00006d70: 6170 655b 305d 202d 206d 6172 6769 6e2c  ape[0] - margin,
-00006d80: 2030 203a 2073 6567 5f63 6f6c 6f72 2e73   0 : seg_color.s
-00006d90: 6861 7065 5b31 5d20 2d20 6d61 7267 696e  hape[1] - margin
-00006da0: 2c20 3a5d 0a20 2020 2020 2020 2020 2020  , :].           
-00006db0: 2020 2020 2020 2020 2020 2020 2073 6567               seg
-00006dc0: 203d 2073 6567 5b6d 6172 6769 6e20 3a20   = seg[margin : 
-00006dd0: 7365 672e 7368 6170 655b 305d 202d 206d  seg.shape[0] - m
-00006de0: 6172 6769 6e2c 2030 203a 2073 6567 2e73  argin, 0 : seg.s
-00006df0: 6861 7065 5b31 5d20 2d20 6d61 7267 696e  hape[1] - margin
-00006e00: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00006e10: 2020 2020 2020 2020 2020 6d61 736b 5f74            mask_t
-00006e20: 7275 655b 696e 6465 785f 795f 6420 2b20  rue[index_y_d + 
-00006e30: 6d61 7267 696e 203a 2069 6e64 6578 5f79  margin : index_y
-00006e40: 5f75 202d 206d 6172 6769 6e2c 2069 6e64  _u - margin, ind
-00006e50: 6578 5f78 5f64 202b 2030 203a 2069 6e64  ex_x_d + 0 : ind
-00006e60: 6578 5f78 5f75 202d 206d 6172 6769 6e5d  ex_x_u - margin]
-00006e70: 203d 2073 6567 0a20 2020 2020 2020 2020   = seg.         
-00006e80: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-00006e90: 7265 6469 6374 696f 6e5f 7472 7565 5b69  rediction_true[i
-00006ea0: 6e64 6578 5f79 5f64 202b 206d 6172 6769  ndex_y_d + margi
-00006eb0: 6e20 3a20 696e 6465 785f 795f 7520 2d20  n : index_y_u - 
-00006ec0: 6d61 7267 696e 2c20 696e 6465 785f 785f  margin, index_x_
-00006ed0: 6420 2b20 3020 3a20 696e 6465 785f 785f  d + 0 : index_x_
-00006ee0: 7520 2d20 6d61 7267 696e 2c20 3a5d 203d  u - margin, :] =
-00006ef0: 2073 6567 5f63 6f6c 6f72 0a20 2020 2020   seg_color.     
-00006f00: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00006f10: 6c69 6620 6920 3d3d 206e 7866 202d 2031  lif i == nxf - 1
-00006f20: 2061 6e64 206a 2021 3d20 3020 616e 6420   and j != 0 and 
-00006f30: 6a20 213d 206e 7966 202d 2031 3a0a 2020  j != nyf - 1:.  
-00006f40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00006f50: 2020 2020 2020 7365 675f 636f 6c6f 7220        seg_color 
-00006f60: 3d20 7365 675f 636f 6c6f 725b 6d61 7267  = seg_color[marg
-00006f70: 696e 203a 2073 6567 5f63 6f6c 6f72 2e73  in : seg_color.s
-00006f80: 6861 7065 5b30 5d20 2d20 6d61 7267 696e  hape[0] - margin
-00006f90: 2c20 6d61 7267 696e 203a 2073 6567 5f63  , margin : seg_c
-00006fa0: 6f6c 6f72 2e73 6861 7065 5b31 5d20 2d20  olor.shape[1] - 
-00006fb0: 302c 203a 5d0a 2020 2020 2020 2020 2020  0, :].          
-00006fc0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00006fd0: 6720 3d20 7365 675b 6d61 7267 696e 203a  g = seg[margin :
-00006fe0: 2073 6567 2e73 6861 7065 5b30 5d20 2d20   seg.shape[0] - 
-00006ff0: 6d61 7267 696e 2c20 6d61 7267 696e 203a  margin, margin :
-00007000: 2073 6567 2e73 6861 7065 5b31 5d20 2d20   seg.shape[1] - 
-00007010: 305d 0a20 2020 2020 2020 2020 2020 2020  0].             
-00007020: 2020 2020 2020 2020 2020 206d 6173 6b5f             mask_
-00007030: 7472 7565 5b69 6e64 6578 5f79 5f64 202b  true[index_y_d +
-00007040: 206d 6172 6769 6e20 3a20 696e 6465 785f   margin : index_
-00007050: 795f 7520 2d20 6d61 7267 696e 2c20 696e  y_u - margin, in
-00007060: 6465 785f 785f 6420 2b20 6d61 7267 696e  dex_x_d + margin
-00007070: 203a 2069 6e64 6578 5f78 5f75 202d 2030   : index_x_u - 0
-00007080: 5d20 3d20 7365 670a 2020 2020 2020 2020  ] = seg.        
-00007090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000070a0: 7072 6564 6963 7469 6f6e 5f74 7275 655b  prediction_true[
-000070b0: 696e 6465 785f 795f 6420 2b20 6d61 7267  index_y_d + marg
-000070c0: 696e 203a 2069 6e64 6578 5f79 5f75 202d  in : index_y_u -
-000070d0: 206d 6172 6769 6e2c 2069 6e64 6578 5f78   margin, index_x
-000070e0: 5f64 202b 206d 6172 6769 6e20 3a20 696e  _d + margin : in
-000070f0: 6465 785f 785f 7520 2d20 302c 203a 5d20  dex_x_u - 0, :] 
-00007100: 3d20 7365 675f 636f 6c6f 720a 2020 2020  = seg_color.    
-00007110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007120: 656c 6966 2069 2021 3d20 3020 616e 6420  elif i != 0 and 
-00007130: 6920 213d 206e 7866 202d 2031 2061 6e64  i != nxf - 1 and
-00007140: 206a 203d 3d20 303a 0a20 2020 2020 2020   j == 0:.       
-00007150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007160: 2073 6567 5f63 6f6c 6f72 203d 2073 6567   seg_color = seg
-00007170: 5f63 6f6c 6f72 5b30 203a 2073 6567 5f63  _color[0 : seg_c
-00007180: 6f6c 6f72 2e73 6861 7065 5b30 5d20 2d20  olor.shape[0] - 
-00007190: 6d61 7267 696e 2c20 6d61 7267 696e 203a  margin, margin :
-000071a0: 2073 6567 5f63 6f6c 6f72 2e73 6861 7065   seg_color.shape
-000071b0: 5b31 5d20 2d20 6d61 7267 696e 2c20 3a5d  [1] - margin, :]
-000071c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000071d0: 2020 2020 2020 2020 2073 6567 203d 2073           seg = s
-000071e0: 6567 5b30 203a 2073 6567 2e73 6861 7065  eg[0 : seg.shape
-000071f0: 5b30 5d20 2d20 6d61 7267 696e 2c20 6d61  [0] - margin, ma
-00007200: 7267 696e 203a 2073 6567 2e73 6861 7065  rgin : seg.shape
-00007210: 5b31 5d20 2d20 6d61 7267 696e 5d0a 2020  [1] - margin].  
-00007220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007230: 2020 2020 2020 6d61 736b 5f74 7275 655b        mask_true[
-00007240: 696e 6465 785f 795f 6420 2b20 3020 3a20  index_y_d + 0 : 
-00007250: 696e 6465 785f 795f 7520 2d20 6d61 7267  index_y_u - marg
-00007260: 696e 2c20 696e 6465 785f 785f 6420 2b20  in, index_x_d + 
-00007270: 6d61 7267 696e 203a 2069 6e64 6578 5f78  margin : index_x
-00007280: 5f75 202d 206d 6172 6769 6e5d 203d 2073  _u - margin] = s
-00007290: 6567 0a20 2020 2020 2020 2020 2020 2020  eg.             
-000072a0: 2020 2020 2020 2020 2020 2070 7265 6469             predi
-000072b0: 6374 696f 6e5f 7472 7565 5b69 6e64 6578  ction_true[index
-000072c0: 5f79 5f64 202b 2030 203a 2069 6e64 6578  _y_d + 0 : index
-000072d0: 5f79 5f75 202d 206d 6172 6769 6e2c 2069  _y_u - margin, i
-000072e0: 6e64 6578 5f78 5f64 202b 206d 6172 6769  ndex_x_d + margi
-000072f0: 6e20 3a20 696e 6465 785f 785f 7520 2d20  n : index_x_u - 
-00007300: 6d61 7267 696e 2c20 3a5d 203d 2073 6567  margin, :] = seg
-00007310: 5f63 6f6c 6f72 0a20 2020 2020 2020 2020  _color.         
-00007320: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
-00007330: 6920 213d 2030 2061 6e64 2069 2021 3d20  i != 0 and i != 
-00007340: 6e78 6620 2d20 3120 616e 6420 6a20 3d3d  nxf - 1 and j ==
-00007350: 206e 7966 202d 2031 3a0a 2020 2020 2020   nyf - 1:.      
-00007360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007370: 2020 7365 675f 636f 6c6f 7220 3d20 7365    seg_color = se
-00007380: 675f 636f 6c6f 725b 6d61 7267 696e 203a  g_color[margin :
-00007390: 2073 6567 5f63 6f6c 6f72 2e73 6861 7065   seg_color.shape
-000073a0: 5b30 5d20 2d20 302c 206d 6172 6769 6e20  [0] - 0, margin 
-000073b0: 3a20 7365 675f 636f 6c6f 722e 7368 6170  : seg_color.shap
-000073c0: 655b 315d 202d 206d 6172 6769 6e2c 203a  e[1] - margin, :
-000073d0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-000073e0: 2020 2020 2020 2020 2020 7365 6720 3d20            seg = 
-000073f0: 7365 675b 6d61 7267 696e 203a 2073 6567  seg[margin : seg
-00007400: 2e73 6861 7065 5b30 5d20 2d20 302c 206d  .shape[0] - 0, m
-00007410: 6172 6769 6e20 3a20 7365 672e 7368 6170  argin : seg.shap
-00007420: 655b 315d 202d 206d 6172 6769 6e5d 0a20  e[1] - margin]. 
-00007430: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007440: 2020 2020 2020 206d 6173 6b5f 7472 7565         mask_true
-00007450: 5b69 6e64 6578 5f79 5f64 202b 206d 6172  [index_y_d + mar
-00007460: 6769 6e20 3a20 696e 6465 785f 795f 7520  gin : index_y_u 
-00007470: 2d20 302c 2069 6e64 6578 5f78 5f64 202b  - 0, index_x_d +
-00007480: 206d 6172 6769 6e20 3a20 696e 6465 785f   margin : index_
-00007490: 785f 7520 2d20 6d61 7267 696e 5d20 3d20  x_u - margin] = 
-000074a0: 7365 670a 2020 2020 2020 2020 2020 2020  seg.            
-000074b0: 2020 2020 2020 2020 2020 2020 7072 6564              pred
-000074c0: 6963 7469 6f6e 5f74 7275 655b 696e 6465  iction_true[inde
-000074d0: 785f 795f 6420 2b20 6d61 7267 696e 203a  x_y_d + margin :
-000074e0: 2069 6e64 6578 5f79 5f75 202d 2030 2c20   index_y_u - 0, 
-000074f0: 696e 6465 785f 785f 6420 2b20 6d61 7267  index_x_d + marg
-00007500: 696e 203a 2069 6e64 6578 5f78 5f75 202d  in : index_x_u -
-00007510: 206d 6172 6769 6e2c 203a 5d20 3d20 7365   margin, :] = se
-00007520: 675f 636f 6c6f 720a 2020 2020 2020 2020  g_color.        
-00007530: 2020 2020 2020 2020 2020 2020 656c 7365              else
-00007540: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00007550: 2020 2020 2020 2020 2020 7365 675f 636f            seg_co
-00007560: 6c6f 7220 3d20 7365 675f 636f 6c6f 725b  lor = seg_color[
-00007570: 6d61 7267 696e 203a 2073 6567 5f63 6f6c  margin : seg_col
-00007580: 6f72 2e73 6861 7065 5b30 5d20 2d20 6d61  or.shape[0] - ma
-00007590: 7267 696e 2c20 6d61 7267 696e 203a 2073  rgin, margin : s
-000075a0: 6567 5f63 6f6c 6f72 2e73 6861 7065 5b31  eg_color.shape[1
-000075b0: 5d20 2d20 6d61 7267 696e 2c20 3a5d 0a20  ] - margin, :]. 
-000075c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000075d0: 2020 2020 2020 2073 6567 203d 2073 6567         seg = seg
-000075e0: 5b6d 6172 6769 6e20 3a20 7365 672e 7368  [margin : seg.sh
-000075f0: 6170 655b 305d 202d 206d 6172 6769 6e2c  ape[0] - margin,
-00007600: 206d 6172 6769 6e20 3a20 7365 672e 7368   margin : seg.sh
-00007610: 6170 655b 315d 202d 206d 6172 6769 6e5d  ape[1] - margin]
-00007620: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00007630: 2020 2020 2020 2020 206d 6173 6b5f 7472           mask_tr
-00007640: 7565 5b69 6e64 6578 5f79 5f64 202b 206d  ue[index_y_d + m
-00007650: 6172 6769 6e20 3a20 696e 6465 785f 795f  argin : index_y_
-00007660: 7520 2d20 6d61 7267 696e 2c20 696e 6465  u - margin, inde
-00007670: 785f 785f 6420 2b20 6d61 7267 696e 203a  x_x_d + margin :
-00007680: 2069 6e64 6578 5f78 5f75 202d 206d 6172   index_x_u - mar
-00007690: 6769 6e5d 203d 2073 6567 0a20 2020 2020  gin] = seg.     
-000076a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000076b0: 2020 2070 7265 6469 6374 696f 6e5f 7472     prediction_tr
-000076c0: 7565 5b69 6e64 6578 5f79 5f64 202b 206d  ue[index_y_d + m
-000076d0: 6172 6769 6e20 3a20 696e 6465 785f 795f  argin : index_y_
-000076e0: 7520 2d20 6d61 7267 696e 2c20 696e 6465  u - margin, inde
-000076f0: 785f 785f 6420 2b20 6d61 7267 696e 203a  x_x_d + margin :
-00007700: 2069 6e64 6578 5f78 5f75 202d 206d 6172   index_x_u - mar
-00007710: 6769 6e2c 203a 5d20 3d20 7365 675f 636f  gin, :] = seg_co
-00007720: 6c6f 720a 0a20 2020 2020 2020 2020 2020  lor..           
-00007730: 2070 7265 6469 6374 696f 6e5f 7472 7565   prediction_true
-00007740: 203d 2070 7265 6469 6374 696f 6e5f 7472   = prediction_tr
-00007750: 7565 2e61 7374 7970 6528 6e70 2e75 696e  ue.astype(np.uin
-00007760: 7438 290a 2020 2020 2020 2020 7265 7475  t8).        retu
-00007770: 726e 2070 7265 6469 6374 696f 6e5f 7472  rn prediction_tr
-00007780: 7565 0a0a 2020 2020 6465 6620 6561 726c  ue..    def earl
-00007790: 795f 7061 6765 5f66 6f72 5f6e 756d 5f6f  y_page_for_num_o
-000077a0: 665f 636f 6c75 6d6e 5f63 6c61 7373 6966  f_column_classif
-000077b0: 6963 6174 696f 6e28 7365 6c66 2c69 6d67  ication(self,img
-000077c0: 5f62 696e 293a 0a20 2020 2020 2020 2073  _bin):.        s
-000077d0: 656c 662e 6c6f 6767 6572 2e64 6562 7567  elf.logger.debug
-000077e0: 2822 656e 7465 7220 6561 726c 795f 7061  ("enter early_pa
-000077f0: 6765 5f66 6f72 5f6e 756d 5f6f 665f 636f  ge_for_num_of_co
-00007800: 6c75 6d6e 5f63 6c61 7373 6966 6963 6174  lumn_classificat
-00007810: 696f 6e22 290a 2020 2020 2020 2020 6966  ion").        if
-00007820: 2073 656c 662e 696e 7075 745f 6269 6e61   self.input_bina
-00007830: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
-00007840: 696d 6720 3d6e 702e 636f 7079 2869 6d67  img =np.copy(img
-00007850: 5f62 696e 290a 2020 2020 2020 2020 2020  _bin).          
-00007860: 2020 696d 6720 3d20 696d 672e 6173 7479    img = img.asty
-00007870: 7065 286e 702e 7569 6e74 3829 0a20 2020  pe(np.uint8).   
-00007880: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00007890: 2020 2020 2020 2069 6d67 203d 2073 656c         img = sel
-000078a0: 662e 696d 7265 6164 2829 0a20 2020 2020  f.imread().     
-000078b0: 2020 206d 6f64 656c 5f70 6167 652c 2073     model_page, s
-000078c0: 6573 7369 6f6e 5f70 6167 6520 3d20 7365  ession_page = se
-000078d0: 6c66 2e73 7461 7274 5f6e 6577 5f73 6573  lf.start_new_ses
-000078e0: 7369 6f6e 5f61 6e64 5f6d 6f64 656c 2873  sion_and_model(s
-000078f0: 656c 662e 6d6f 6465 6c5f 7061 6765 5f64  elf.model_page_d
-00007900: 6972 290a 2020 2020 2020 2020 696d 6720  ir).        img 
-00007910: 3d20 6376 322e 4761 7573 7369 616e 426c  = cv2.GaussianBl
-00007920: 7572 2869 6d67 2c20 2835 2c20 3529 2c20  ur(img, (5, 5), 
-00007930: 3029 0a0a 2020 2020 2020 2020 696d 675f  0)..        img_
-00007940: 7061 6765 5f70 7265 6469 6374 696f 6e20  page_prediction 
-00007950: 3d20 7365 6c66 2e64 6f5f 7072 6564 6963  = self.do_predic
-00007960: 7469 6f6e 2846 616c 7365 2c20 696d 672c  tion(False, img,
-00007970: 206d 6f64 656c 5f70 6167 6529 0a0a 2020   model_page)..  
-00007980: 2020 2020 2020 696d 6772 6179 203d 2063        imgray = c
-00007990: 7632 2e63 7674 436f 6c6f 7228 696d 675f  v2.cvtColor(img_
-000079a0: 7061 6765 5f70 7265 6469 6374 696f 6e2c  page_prediction,
-000079b0: 2063 7632 2e43 4f4c 4f52 5f42 4752 3247   cv2.COLOR_BGR2G
-000079c0: 5241 5929 0a20 2020 2020 2020 205f 2c20  RAY).        _, 
-000079d0: 7468 7265 7368 203d 2063 7632 2e74 6872  thresh = cv2.thr
-000079e0: 6573 686f 6c64 2869 6d67 7261 792c 2030  eshold(imgray, 0
-000079f0: 2c20 3235 352c 2030 290a 2020 2020 2020  , 255, 0).      
-00007a00: 2020 7468 7265 7368 203d 2063 7632 2e64    thresh = cv2.d
-00007a10: 696c 6174 6528 7468 7265 7368 2c20 4b45  ilate(thresh, KE
-00007a20: 524e 454c 2c20 6974 6572 6174 696f 6e73  RNEL, iterations
-00007a30: 3d33 290a 2020 2020 2020 2020 636f 6e74  =3).        cont
-00007a40: 6f75 7273 2c20 5f20 3d20 6376 322e 6669  ours, _ = cv2.fi
-00007a50: 6e64 436f 6e74 6f75 7273 2874 6872 6573  ndContours(thres
-00007a60: 682c 2063 7632 2e52 4554 525f 5452 4545  h, cv2.RETR_TREE
-00007a70: 2c20 6376 322e 4348 4149 4e5f 4150 5052  , cv2.CHAIN_APPR
-00007a80: 4f58 5f53 494d 504c 4529 0a20 2020 2020  OX_SIMPLE).     
-00007a90: 2020 2069 6620 6c65 6e28 636f 6e74 6f75     if len(contou
-00007aa0: 7273 293e 303a 0a20 2020 2020 2020 2020  rs)>0:.         
-00007ab0: 2020 2063 6e74 5f73 697a 6520 3d20 6e70     cnt_size = np
-00007ac0: 2e61 7272 6179 285b 6376 322e 636f 6e74  .array([cv2.cont
-00007ad0: 6f75 7241 7265 6128 636f 6e74 6f75 7273  ourArea(contours
-00007ae0: 5b6a 5d29 2066 6f72 206a 2069 6e20 7261  [j]) for j in ra
-00007af0: 6e67 6528 6c65 6e28 636f 6e74 6f75 7273  nge(len(contours
-00007b00: 2929 5d29 0a20 2020 2020 2020 2020 2020  ))]).           
-00007b10: 2063 6e74 203d 2063 6f6e 746f 7572 735b   cnt = contours[
-00007b20: 6e70 2e61 7267 6d61 7828 636e 745f 7369  np.argmax(cnt_si
-00007b30: 7a65 295d 0a20 2020 2020 2020 2020 2020  ze)].           
-00007b40: 2078 2c20 792c 2077 2c20 6820 3d20 6376   x, y, w, h = cv
-00007b50: 322e 626f 756e 6469 6e67 5265 6374 2863  2.boundingRect(c
-00007b60: 6e74 290a 2020 2020 2020 2020 2020 2020  nt).            
-00007b70: 626f 7820 3d20 5b78 2c20 792c 2077 2c20  box = [x, y, w, 
-00007b80: 685d 0a20 2020 2020 2020 2065 6c73 653a  h].        else:
-00007b90: 0a20 2020 2020 2020 2020 2020 2062 6f78  .            box
-00007ba0: 203d 205b 302c 2030 2c20 696d 672e 7368   = [0, 0, img.sh
-00007bb0: 6170 655b 315d 2c20 696d 672e 7368 6170  ape[1], img.shap
-00007bc0: 655b 305d 5d0a 2020 2020 2020 2020 6372  e[0]].        cr
-00007bd0: 6f70 6564 5f70 6167 652c 2070 6167 655f  oped_page, page_
-00007be0: 636f 6f72 6420 3d20 6372 6f70 5f69 6d61  coord = crop_ima
-00007bf0: 6765 5f69 6e73 6964 655f 626f 7828 626f  ge_inside_box(bo
-00007c00: 782c 2069 6d67 290a 2020 2020 2020 2020  x, img).        
-00007c10: 7365 6c66 2e6c 6f67 6765 722e 6465 6275  self.logger.debu
-00007c20: 6728 2265 7869 7420 6561 726c 795f 7061  g("exit early_pa
-00007c30: 6765 5f66 6f72 5f6e 756d 5f6f 665f 636f  ge_for_num_of_co
-00007c40: 6c75 6d6e 5f63 6c61 7373 6966 6963 6174  lumn_classificat
-00007c50: 696f 6e22 290a 2020 2020 2020 2020 7265  ion").        re
-00007c60: 7475 726e 2063 726f 7065 645f 7061 6765  turn croped_page
-00007c70: 2c20 7061 6765 5f63 6f6f 7264 0a0a 2020  , page_coord..  
-00007c80: 2020 6465 6620 6578 7472 6163 745f 7061    def extract_pa
-00007c90: 6765 2873 656c 6629 3a0a 2020 2020 2020  ge(self):.      
-00007ca0: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
-00007cb0: 6275 6728 2265 6e74 6572 2065 7874 7261  bug("enter extra
-00007cc0: 6374 5f70 6167 6522 290a 2020 2020 2020  ct_page").      
-00007cd0: 2020 636f 6e74 5f70 6167 6520 3d20 5b5d    cont_page = []
-00007ce0: 0a20 2020 2020 2020 2069 6d67 203d 2063  .        img = c
-00007cf0: 7632 2e47 6175 7373 6961 6e42 6c75 7228  v2.GaussianBlur(
-00007d00: 7365 6c66 2e69 6d61 6765 2c20 2835 2c20  self.image, (5, 
-00007d10: 3529 2c20 3029 0a20 2020 2020 2020 200a  5), 0).        .
-00007d20: 2020 2020 2020 2020 6d6f 6465 6c5f 7061          model_pa
-00007d30: 6765 2c20 7365 7373 696f 6e5f 7061 6765  ge, session_page
-00007d40: 203d 2073 656c 662e 7374 6172 745f 6e65   = self.start_ne
-00007d50: 775f 7365 7373 696f 6e5f 616e 645f 6d6f  w_session_and_mo
-00007d60: 6465 6c28 7365 6c66 2e6d 6f64 656c 5f70  del(self.model_p
-00007d70: 6167 655f 6469 7229 0a20 2020 2020 2020  age_dir).       
-00007d80: 2069 6d67 5f70 6167 655f 7072 6564 6963   img_page_predic
-00007d90: 7469 6f6e 203d 2073 656c 662e 646f 5f70  tion = self.do_p
-00007da0: 7265 6469 6374 696f 6e28 4661 6c73 652c  rediction(False,
-00007db0: 2069 6d67 2c20 6d6f 6465 6c5f 7061 6765   img, model_page
-00007dc0: 290a 2020 2020 2020 2020 696d 6772 6179  ).        imgray
-00007dd0: 203d 2063 7632 2e63 7674 436f 6c6f 7228   = cv2.cvtColor(
-00007de0: 696d 675f 7061 6765 5f70 7265 6469 6374  img_page_predict
-00007df0: 696f 6e2c 2063 7632 2e43 4f4c 4f52 5f42  ion, cv2.COLOR_B
-00007e00: 4752 3247 5241 5929 0a20 2020 2020 2020  GR2GRAY).       
-00007e10: 205f 2c20 7468 7265 7368 203d 2063 7632   _, thresh = cv2
-00007e20: 2e74 6872 6573 686f 6c64 2869 6d67 7261  .threshold(imgra
-00007e30: 792c 2030 2c20 3235 352c 2030 290a 2020  y, 0, 255, 0).  
-00007e40: 2020 2020 2020 7468 7265 7368 203d 2063        thresh = c
-00007e50: 7632 2e64 696c 6174 6528 7468 7265 7368  v2.dilate(thresh
-00007e60: 2c20 4b45 524e 454c 2c20 6974 6572 6174  , KERNEL, iterat
-00007e70: 696f 6e73 3d33 290a 2020 2020 2020 2020  ions=3).        
-00007e80: 636f 6e74 6f75 7273 2c20 5f20 3d20 6376  contours, _ = cv
-00007e90: 322e 6669 6e64 436f 6e74 6f75 7273 2874  2.findContours(t
-00007ea0: 6872 6573 682c 2063 7632 2e52 4554 525f  hresh, cv2.RETR_
-00007eb0: 5452 4545 2c20 6376 322e 4348 4149 4e5f  TREE, cv2.CHAIN_
-00007ec0: 4150 5052 4f58 5f53 494d 504c 4529 0a20  APPROX_SIMPLE). 
-00007ed0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00007ee0: 6966 206c 656e 2863 6f6e 746f 7572 7329  if len(contours)
-00007ef0: 3e30 3a0a 2020 2020 2020 2020 2020 2020  >0:.            
-00007f00: 636e 745f 7369 7a65 203d 206e 702e 6172  cnt_size = np.ar
-00007f10: 7261 7928 5b63 7632 2e63 6f6e 746f 7572  ray([cv2.contour
-00007f20: 4172 6561 2863 6f6e 746f 7572 735b 6a5d  Area(contours[j]
-00007f30: 2920 666f 7220 6a20 696e 2072 616e 6765  ) for j in range
-00007f40: 286c 656e 2863 6f6e 746f 7572 7329 295d  (len(contours))]
-00007f50: 290a 2020 2020 2020 2020 2020 2020 636e  ).            cn
-00007f60: 7420 3d20 636f 6e74 6f75 7273 5b6e 702e  t = contours[np.
-00007f70: 6172 676d 6178 2863 6e74 5f73 697a 6529  argmax(cnt_size)
-00007f80: 5d0a 2020 2020 2020 2020 2020 2020 782c  ].            x,
-00007f90: 2079 2c20 772c 2068 203d 2063 7632 2e62   y, w, h = cv2.b
-00007fa0: 6f75 6e64 696e 6752 6563 7428 636e 7429  oundingRect(cnt)
-00007fb0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-00007fc0: 7820 3c3d 2033 303a 0a20 2020 2020 2020  x <= 30:.       
-00007fd0: 2020 2020 2020 2020 2077 202b 3d20 780a           w += x.
-00007fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00007ff0: 7820 3d20 300a 2020 2020 2020 2020 2020  x = 0.          
-00008000: 2020 6966 2028 7365 6c66 2e69 6d61 6765    if (self.image
-00008010: 2e73 6861 7065 5b31 5d20 2d20 2878 202b  .shape[1] - (x +
-00008020: 2077 2929 203c 3d20 3330 3a0a 2020 2020   w)) <= 30:.    
-00008030: 2020 2020 2020 2020 2020 2020 7720 3d20              w = 
-00008040: 7720 2b20 2873 656c 662e 696d 6167 652e  w + (self.image.
-00008050: 7368 6170 655b 315d 202d 2028 7820 2b20  shape[1] - (x + 
-00008060: 7729 290a 2020 2020 2020 2020 2020 2020  w)).            
-00008070: 6966 2079 203c 3d20 3330 3a0a 2020 2020  if y <= 30:.    
-00008080: 2020 2020 2020 2020 2020 2020 6820 3d20              h = 
-00008090: 6820 2b20 790a 2020 2020 2020 2020 2020  h + y.          
-000080a0: 2020 2020 2020 7920 3d20 300a 2020 2020        y = 0.    
-000080b0: 2020 2020 2020 2020 6966 2028 7365 6c66          if (self
-000080c0: 2e69 6d61 6765 2e73 6861 7065 5b30 5d20  .image.shape[0] 
-000080d0: 2d20 2879 202b 2068 2929 203c 3d20 3330  - (y + h)) <= 30
-000080e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000080f0: 2020 6820 3d20 6820 2b20 2873 656c 662e    h = h + (self.
-00008100: 696d 6167 652e 7368 6170 655b 305d 202d  image.shape[0] -
-00008110: 2028 7920 2b20 6829 290a 0a20 2020 2020   (y + h))..     
-00008120: 2020 2020 2020 2062 6f78 203d 205b 782c         box = [x,
-00008130: 2079 2c20 772c 2068 5d0a 2020 2020 2020   y, w, h].      
-00008140: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00008150: 2020 2020 626f 7820 3d20 5b30 2c20 302c      box = [0, 0,
-00008160: 2069 6d67 2e73 6861 7065 5b31 5d2c 2069   img.shape[1], i
-00008170: 6d67 2e73 6861 7065 5b30 5d5d 0a20 2020  mg.shape[0]].   
-00008180: 2020 2020 2063 726f 7065 645f 7061 6765       croped_page
-00008190: 2c20 7061 6765 5f63 6f6f 7264 203d 2063  , page_coord = c
-000081a0: 726f 705f 696d 6167 655f 696e 7369 6465  rop_image_inside
-000081b0: 5f62 6f78 2862 6f78 2c20 7365 6c66 2e69  _box(box, self.i
-000081c0: 6d61 6765 290a 2020 2020 2020 2020 636f  mage).        co
-000081d0: 6e74 5f70 6167 652e 6170 7065 6e64 286e  nt_page.append(n
-000081e0: 702e 6172 7261 7928 5b5b 7061 6765 5f63  p.array([[page_c
-000081f0: 6f6f 7264 5b32 5d2c 2070 6167 655f 636f  oord[2], page_co
-00008200: 6f72 645b 305d 5d2c 205b 7061 6765 5f63  ord[0]], [page_c
-00008210: 6f6f 7264 5b33 5d2c 2070 6167 655f 636f  oord[3], page_co
-00008220: 6f72 645b 305d 5d2c 205b 7061 6765 5f63  ord[0]], [page_c
-00008230: 6f6f 7264 5b33 5d2c 2070 6167 655f 636f  oord[3], page_co
-00008240: 6f72 645b 315d 5d2c 205b 7061 6765 5f63  ord[1]], [page_c
-00008250: 6f6f 7264 5b32 5d2c 2070 6167 655f 636f  oord[2], page_co
-00008260: 6f72 645b 315d 5d5d 2929 0a20 2020 2020  ord[1]]])).     
-00008270: 2020 2073 656c 662e 6c6f 6767 6572 2e64     self.logger.d
-00008280: 6562 7567 2822 6578 6974 2065 7874 7261  ebug("exit extra
-00008290: 6374 5f70 6167 6522 290a 2020 2020 2020  ct_page").      
-000082a0: 2020 7265 7475 726e 2063 726f 7065 645f    return croped_
-000082b0: 7061 6765 2c20 7061 6765 5f63 6f6f 7264  page, page_coord
-000082c0: 2c20 636f 6e74 5f70 6167 650a 0a20 2020  , cont_page..   
-000082d0: 2064 6566 2065 7874 7261 6374 5f74 6578   def extract_tex
-000082e0: 745f 7265 6769 6f6e 7328 7365 6c66 2c20  t_regions(self, 
-000082f0: 696d 672c 2070 6174 6368 6573 2c20 636f  img, patches, co
-00008300: 6c73 293a 0a20 2020 2020 2020 2073 656c  ls):.        sel
-00008310: 662e 6c6f 6767 6572 2e64 6562 7567 2822  f.logger.debug("
-00008320: 656e 7465 7220 6578 7472 6163 745f 7465  enter extract_te
-00008330: 7874 5f72 6567 696f 6e73 2229 0a20 2020  xt_regions").   
-00008340: 2020 2020 2069 6d67 5f68 6569 6768 745f       img_height_
-00008350: 6820 3d20 696d 672e 7368 6170 655b 305d  h = img.shape[0]
-00008360: 0a20 2020 2020 2020 2069 6d67 5f77 6964  .        img_wid
-00008370: 7468 5f68 203d 2069 6d67 2e73 6861 7065  th_h = img.shape
-00008380: 5b31 5d0a 0a20 2020 2020 2020 206d 6f64  [1]..        mod
-00008390: 656c 5f72 6567 696f 6e2c 2073 6573 7369  el_region, sessi
-000083a0: 6f6e 5f72 6567 696f 6e20 3d20 7365 6c66  on_region = self
-000083b0: 2e73 7461 7274 5f6e 6577 5f73 6573 7369  .start_new_sessi
-000083c0: 6f6e 5f61 6e64 5f6d 6f64 656c 2873 656c  on_and_model(sel
-000083d0: 662e 6d6f 6465 6c5f 7265 6769 6f6e 5f64  f.model_region_d
-000083e0: 6972 5f66 756c 6c79 2069 6620 7061 7463  ir_fully if patc
-000083f0: 6865 7320 656c 7365 2073 656c 662e 6d6f  hes else self.mo
-00008400: 6465 6c5f 7265 6769 6f6e 5f64 6972 5f66  del_region_dir_f
-00008410: 756c 6c79 5f6e 7029 0a0a 2020 2020 2020  ully_np)..      
-00008420: 2020 6966 206e 6f74 2070 6174 6368 6573    if not patches
-00008430: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
-00008440: 6720 3d20 6f74 7375 5f63 6f70 795f 6269  g = otsu_copy_bi
-00008450: 6e61 7279 2869 6d67 290a 2020 2020 2020  nary(img).      
-00008460: 2020 2020 2020 696d 6720 3d20 696d 672e        img = img.
-00008470: 6173 7479 7065 286e 702e 7569 6e74 3829  astype(np.uint8)
-00008480: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
-00008490: 6469 6374 696f 6e5f 7265 6769 6f6e 7332  diction_regions2
-000084a0: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-000084b0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-000084c0: 2020 6966 2063 6f6c 7320 3d3d 2031 3a0a    if cols == 1:.
-000084d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000084e0: 696d 6732 203d 206f 7473 755f 636f 7079  img2 = otsu_copy
-000084f0: 5f62 696e 6172 7928 696d 6729 0a20 2020  _binary(img).   
-00008500: 2020 2020 2020 2020 2020 2020 2069 6d67               img
-00008510: 3220 3d20 696d 6732 2e61 7374 7970 6528  2 = img2.astype(
-00008520: 6e70 2e75 696e 7438 290a 2020 2020 2020  np.uint8).      
-00008530: 2020 2020 2020 2020 2020 696d 6732 203d            img2 =
-00008540: 2072 6573 697a 655f 696d 6167 6528 696d   resize_image(im
-00008550: 6732 2c20 696e 7428 696d 675f 6865 6967  g2, int(img_heig
-00008560: 6874 5f68 202a 2030 2e37 292c 2069 6e74  ht_h * 0.7), int
-00008570: 2869 6d67 5f77 6964 7468 5f68 202a 2030  (img_width_h * 0
-00008580: 2e37 2929 0a20 2020 2020 2020 2020 2020  .7)).           
-00008590: 2020 2020 206d 6172 6769 6e61 6c5f 6f66       marginal_of
-000085a0: 5f70 6174 6368 5f70 6572 6365 6e74 203d  _patch_percent =
-000085b0: 2030 2e31 0a20 2020 2020 2020 2020 2020   0.1.           
-000085c0: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
-000085d0: 7265 6769 6f6e 7332 203d 2073 656c 662e  regions2 = self.
-000085e0: 646f 5f70 7265 6469 6374 696f 6e28 7061  do_prediction(pa
-000085f0: 7463 6865 732c 2069 6d67 322c 206d 6f64  tches, img2, mod
-00008600: 656c 5f72 6567 696f 6e2c 206d 6172 6769  el_region, margi
-00008610: 6e61 6c5f 6f66 5f70 6174 6368 5f70 6572  nal_of_patch_per
-00008620: 6365 6e74 290a 2020 2020 2020 2020 2020  cent).          
-00008630: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
-00008640: 5f72 6567 696f 6e73 3220 3d20 7265 7369  _regions2 = resi
-00008650: 7a65 5f69 6d61 6765 2870 7265 6469 6374  ze_image(predict
-00008660: 696f 6e5f 7265 6769 6f6e 7332 2c20 696d  ion_regions2, im
-00008670: 675f 6865 6967 6874 5f68 2c20 696d 675f  g_height_h, img_
-00008680: 7769 6474 685f 6829 0a0a 2020 2020 2020  width_h)..      
-00008690: 2020 2020 2020 6966 2063 6f6c 7320 3d3d        if cols ==
-000086a0: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
-000086b0: 2020 2020 696d 6732 203d 206f 7473 755f      img2 = otsu_
-000086c0: 636f 7079 5f62 696e 6172 7928 696d 6729  copy_binary(img)
-000086d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000086e0: 2069 6d67 3220 3d20 696d 6732 2e61 7374   img2 = img2.ast
-000086f0: 7970 6528 6e70 2e75 696e 7438 290a 2020  ype(np.uint8).  
-00008700: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00008710: 6732 203d 2072 6573 697a 655f 696d 6167  g2 = resize_imag
-00008720: 6528 696d 6732 2c20 696e 7428 696d 675f  e(img2, int(img_
-00008730: 6865 6967 6874 5f68 202a 2030 2e34 292c  height_h * 0.4),
-00008740: 2069 6e74 2869 6d67 5f77 6964 7468 5f68   int(img_width_h
-00008750: 202a 2030 2e34 2929 0a20 2020 2020 2020   * 0.4)).       
-00008760: 2020 2020 2020 2020 206d 6172 6769 6e61           margina
-00008770: 6c5f 6f66 5f70 6174 6368 5f70 6572 6365  l_of_patch_perce
-00008780: 6e74 203d 2030 2e31 0a20 2020 2020 2020  nt = 0.1.       
-00008790: 2020 2020 2020 2020 2070 7265 6469 6374           predict
-000087a0: 696f 6e5f 7265 6769 6f6e 7332 203d 2073  ion_regions2 = s
-000087b0: 656c 662e 646f 5f70 7265 6469 6374 696f  elf.do_predictio
-000087c0: 6e28 7061 7463 6865 732c 2069 6d67 322c  n(patches, img2,
-000087d0: 206d 6f64 656c 5f72 6567 696f 6e2c 206d   model_region, m
-000087e0: 6172 6769 6e61 6c5f 6f66 5f70 6174 6368  arginal_of_patch
-000087f0: 5f70 6572 6365 6e74 290a 2020 2020 2020  _percent).      
-00008800: 2020 2020 2020 2020 2020 7072 6564 6963            predic
-00008810: 7469 6f6e 5f72 6567 696f 6e73 3220 3d20  tion_regions2 = 
-00008820: 7265 7369 7a65 5f69 6d61 6765 2870 7265  resize_image(pre
-00008830: 6469 6374 696f 6e5f 7265 6769 6f6e 7332  diction_regions2
-00008840: 2c20 696d 675f 6865 6967 6874 5f68 2c20  , img_height_h, 
-00008850: 696d 675f 7769 6474 685f 6829 0a0a 2020  img_width_h)..  
-00008860: 2020 2020 2020 2020 2020 656c 6966 2063            elif c
-00008870: 6f6c 7320 3e20 323a 0a20 2020 2020 2020  ols > 2:.       
-00008880: 2020 2020 2020 2020 2069 6d67 3220 3d20           img2 = 
-00008890: 6f74 7375 5f63 6f70 795f 6269 6e61 7279  otsu_copy_binary
-000088a0: 2869 6d67 290a 2020 2020 2020 2020 2020  (img).          
-000088b0: 2020 2020 2020 696d 6732 203d 2069 6d67        img2 = img
-000088c0: 322e 6173 7479 7065 286e 702e 7569 6e74  2.astype(np.uint
-000088d0: 3829 0a20 2020 2020 2020 2020 2020 2020  8).             
-000088e0: 2020 2069 6d67 3220 3d20 7265 7369 7a65     img2 = resize
-000088f0: 5f69 6d61 6765 2869 6d67 322c 2069 6e74  _image(img2, int
-00008900: 2869 6d67 5f68 6569 6768 745f 6820 2a20  (img_height_h * 
-00008910: 302e 3329 2c20 696e 7428 696d 675f 7769  0.3), int(img_wi
-00008920: 6474 685f 6820 2a20 302e 3329 290a 2020  dth_h * 0.3)).  
-00008930: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00008940: 7267 696e 616c 5f6f 665f 7061 7463 685f  rginal_of_patch_
-00008950: 7065 7263 656e 7420 3d20 302e 310a 2020  percent = 0.1.  
-00008960: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-00008970: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
-00008980: 3220 3d20 7365 6c66 2e64 6f5f 7072 6564  2 = self.do_pred
-00008990: 6963 7469 6f6e 2870 6174 6368 6573 2c20  iction(patches, 
-000089a0: 696d 6732 2c20 6d6f 6465 6c5f 7265 6769  img2, model_regi
-000089b0: 6f6e 2c20 6d61 7267 696e 616c 5f6f 665f  on, marginal_of_
-000089c0: 7061 7463 685f 7065 7263 656e 7429 0a20  patch_percent). 
-000089d0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-000089e0: 7265 6469 6374 696f 6e5f 7265 6769 6f6e  rediction_region
-000089f0: 7332 203d 2072 6573 697a 655f 696d 6167  s2 = resize_imag
-00008a00: 6528 7072 6564 6963 7469 6f6e 5f72 6567  e(prediction_reg
-00008a10: 696f 6e73 322c 2069 6d67 5f68 6569 6768  ions2, img_heigh
-00008a20: 745f 682c 2069 6d67 5f77 6964 7468 5f68  t_h, img_width_h
-00008a30: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
-00008a40: 6620 636f 6c73 203d 3d20 323a 0a20 2020  f cols == 2:.   
-00008a50: 2020 2020 2020 2020 2020 2020 2069 6d67               img
-00008a60: 203d 206f 7473 755f 636f 7079 5f62 696e   = otsu_copy_bin
-00008a70: 6172 7928 696d 6729 0a20 2020 2020 2020  ary(img).       
-00008a80: 2020 2020 2020 2020 2069 6d67 203d 2069           img = i
-00008a90: 6d67 2e61 7374 7970 6528 6e70 2e75 696e  mg.astype(np.uin
-00008aa0: 7438 290a 2020 2020 2020 2020 2020 2020  t8).            
-00008ab0: 2020 2020 6966 2069 6d67 5f77 6964 7468      if img_width
-00008ac0: 5f68 203e 3d20 3230 3030 3a0a 2020 2020  _h >= 2000:.    
-00008ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ae0: 696d 6720 3d20 7265 7369 7a65 5f69 6d61  img = resize_ima
-00008af0: 6765 2869 6d67 2c20 696e 7428 696d 675f  ge(img, int(img_
-00008b00: 6865 6967 6874 5f68 202a 2030 2e39 292c  height_h * 0.9),
-00008b10: 2069 6e74 2869 6d67 5f77 6964 7468 5f68   int(img_width_h
-00008b20: 202a 2030 2e39 2929 0a20 2020 2020 2020   * 0.9)).       
-00008b30: 2020 2020 2020 2020 2069 6d67 203d 2069           img = i
-00008b40: 6d67 2e61 7374 7970 6528 6e70 2e75 696e  mg.astype(np.uin
-00008b50: 7438 290a 0a20 2020 2020 2020 2020 2020  t8)..           
-00008b60: 2069 6620 636f 6c73 203d 3d20 313a 0a20   if cols == 1:. 
-00008b70: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00008b80: 6d67 203d 206f 7473 755f 636f 7079 5f62  mg = otsu_copy_b
-00008b90: 696e 6172 7928 696d 6729 0a20 2020 2020  inary(img).     
-00008ba0: 2020 2020 2020 2020 2020 2069 6d67 203d             img =
-00008bb0: 2069 6d67 2e61 7374 7970 6528 6e70 2e75   img.astype(np.u
-00008bc0: 696e 7438 290a 2020 2020 2020 2020 2020  int8).          
-00008bd0: 2020 2020 2020 696d 6720 3d20 7265 7369        img = resi
-00008be0: 7a65 5f69 6d61 6765 2869 6d67 2c20 696e  ze_image(img, in
-00008bf0: 7428 696d 675f 6865 6967 6874 5f68 202a  t(img_height_h *
-00008c00: 2030 2e35 292c 2069 6e74 2869 6d67 5f77   0.5), int(img_w
-00008c10: 6964 7468 5f68 202a 2030 2e35 2929 0a20  idth_h * 0.5)). 
-00008c20: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00008c30: 6d67 203d 2069 6d67 2e61 7374 7970 6528  mg = img.astype(
-00008c40: 6e70 2e75 696e 7438 290a 0a20 2020 2020  np.uint8)..     
-00008c50: 2020 2020 2020 2069 6620 636f 6c73 203d         if cols =
-00008c60: 3d20 333a 0a20 2020 2020 2020 2020 2020  = 3:.           
-00008c70: 2020 2020 2069 6620 2873 656c 662e 7363       if (self.sc
-00008c80: 616c 655f 7820 3d3d 2031 2061 6e64 2069  ale_x == 1 and i
-00008c90: 6d67 5f77 6964 7468 5f68 203e 2033 3030  mg_width_h > 300
-00008ca0: 3029 206f 7220 2873 656c 662e 7363 616c  0) or (self.scal
-00008cb0: 655f 7820 213d 2031 2061 6e64 2069 6d67  e_x != 1 and img
-00008cc0: 5f77 6964 7468 5f68 203e 2032 3830 3029  _width_h > 2800)
-00008cd0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00008ce0: 2020 2020 2020 696d 6720 3d20 6f74 7375        img = otsu
-00008cf0: 5f63 6f70 795f 6269 6e61 7279 2869 6d67  _copy_binary(img
-00008d00: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00008d10: 2020 2020 2020 696d 6720 3d20 696d 672e        img = img.
-00008d20: 6173 7479 7065 286e 702e 7569 6e74 3829  astype(np.uint8)
-00008d30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00008d40: 2020 2020 2069 6d67 203d 2072 6573 697a       img = resiz
-00008d50: 655f 696d 6167 6528 696d 672c 2069 6e74  e_image(img, int
-00008d60: 2869 6d67 5f68 6569 6768 745f 6820 2a20  (img_height_h * 
-00008d70: 3238 3030 202f 2066 6c6f 6174 2869 6d67  2800 / float(img
-00008d80: 5f77 6964 7468 5f68 2929 2c20 3238 3030  _width_h)), 2800
-00008d90: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00008da0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00008db0: 2020 2020 2020 2020 2020 2020 696d 6720              img 
-00008dc0: 3d20 6f74 7375 5f63 6f70 795f 6269 6e61  = otsu_copy_bina
-00008dd0: 7279 2869 6d67 290a 2020 2020 2020 2020  ry(img).        
-00008de0: 2020 2020 2020 2020 2020 2020 696d 6720              img 
-00008df0: 3d20 696d 672e 6173 7479 7065 286e 702e  = img.astype(np.
-00008e00: 7569 6e74 3829 0a0a 2020 2020 2020 2020  uint8)..        
-00008e10: 2020 2020 6966 2063 6f6c 7320 3d3d 2034      if cols == 4
-00008e20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00008e30: 2020 6966 2028 7365 6c66 2e73 6361 6c65    if (self.scale
-00008e40: 5f78 203d 3d20 3120 616e 6420 696d 675f  _x == 1 and img_
-00008e50: 7769 6474 685f 6820 3e20 3430 3030 2920  width_h > 4000) 
-00008e60: 6f72 2028 7365 6c66 2e73 6361 6c65 5f78  or (self.scale_x
-00008e70: 2021 3d20 3120 616e 6420 696d 675f 7769   != 1 and img_wi
-00008e80: 6474 685f 6820 3e20 3337 3030 293a 0a20  dth_h > 3700):. 
-00008e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ea0: 2020 2069 6d67 203d 206f 7473 755f 636f     img = otsu_co
-00008eb0: 7079 5f62 696e 6172 7928 696d 6729 0a20  py_binary(img). 
-00008ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008ed0: 2020 2069 6d67 203d 2069 6d67 2e61 7374     img = img.ast
-00008ee0: 7970 6528 6e70 2e75 696e 7438 290a 2020  ype(np.uint8).  
-00008ef0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00008f00: 2020 696d 673d 2072 6573 697a 655f 696d    img= resize_im
-00008f10: 6167 6528 696d 672c 2069 6e74 2869 6d67  age(img, int(img
-00008f20: 5f68 6569 6768 745f 6820 2a20 3337 3030  _height_h * 3700
-00008f30: 202f 2066 6c6f 6174 2869 6d67 5f77 6964   / float(img_wid
-00008f40: 7468 5f68 2929 2c20 3337 3030 290a 2020  th_h)), 3700).  
-00008f50: 2020 2020 2020 2020 2020 2020 2020 656c                el
-00008f60: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-00008f70: 2020 2020 2020 2020 696d 6720 3d20 6f74          img = ot
-00008f80: 7375 5f63 6f70 795f 6269 6e61 7279 2869  su_copy_binary(i
-00008f90: 6d67 290a 2020 2020 2020 2020 2020 2020  mg).            
-00008fa0: 2020 2020 2020 2020 696d 6720 3d20 696d          img = im
-00008fb0: 672e 6173 7479 7065 286e 702e 7569 6e74  g.astype(np.uint
-00008fc0: 3829 0a20 2020 2020 2020 2020 2020 2020  8).             
-00008fd0: 2020 2020 2020 2069 6d67 3d20 7265 7369         img= resi
-00008fe0: 7a65 5f69 6d61 6765 2869 6d67 2c20 696e  ze_image(img, in
-00008ff0: 7428 696d 675f 6865 6967 6874 5f68 202a  t(img_height_h *
-00009000: 2030 2e39 292c 2069 6e74 2869 6d67 5f77   0.9), int(img_w
-00009010: 6964 7468 5f68 202a 2030 2e39 2929 0a0a  idth_h * 0.9))..
-00009020: 2020 2020 2020 2020 2020 2020 6966 2063              if c
-00009030: 6f6c 7320 3d3d 2035 3a0a 2020 2020 2020  ols == 5:.      
-00009040: 2020 2020 2020 2020 2020 6966 2073 656c            if sel
-00009050: 662e 7363 616c 655f 7820 3d3d 2031 2061  f.scale_x == 1 a
-00009060: 6e64 2069 6d67 5f77 6964 7468 5f68 203e  nd img_width_h >
-00009070: 2035 3030 303a 0a20 2020 2020 2020 2020   5000:.         
-00009080: 2020 2020 2020 2020 2020 2069 6d67 203d             img =
-00009090: 206f 7473 755f 636f 7079 5f62 696e 6172   otsu_copy_binar
-000090a0: 7928 696d 6729 0a20 2020 2020 2020 2020  y(img).         
-000090b0: 2020 2020 2020 2020 2020 2069 6d67 203d             img =
-000090c0: 2069 6d67 2e61 7374 7970 6528 6e70 2e75   img.astype(np.u
-000090d0: 696e 7438 290a 2020 2020 2020 2020 2020  int8).          
-000090e0: 2020 2020 2020 2020 2020 696d 673d 2072            img= r
-000090f0: 6573 697a 655f 696d 6167 6528 696d 672c  esize_image(img,
-00009100: 2069 6e74 2869 6d67 5f68 6569 6768 745f   int(img_height_
-00009110: 6820 2a20 302e 3729 2c20 696e 7428 696d  h * 0.7), int(im
-00009120: 675f 7769 6474 685f 6820 2a20 302e 3729  g_width_h * 0.7)
-00009130: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00009140: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00009150: 2020 2020 2020 2020 2020 2020 696d 6720              img 
-00009160: 3d20 6f74 7375 5f63 6f70 795f 6269 6e61  = otsu_copy_bina
-00009170: 7279 2869 6d67 290a 2020 2020 2020 2020  ry(img).        
-00009180: 2020 2020 2020 2020 2020 2020 696d 6720              img 
-00009190: 3d20 696d 672e 6173 7479 7065 286e 702e  = img.astype(np.
-000091a0: 7569 6e74 3829 0a20 2020 2020 2020 2020  uint8).         
-000091b0: 2020 2020 2020 2020 2020 2069 6d67 3d20             img= 
-000091c0: 7265 7369 7a65 5f69 6d61 6765 2869 6d67  resize_image(img
-000091d0: 2c20 696e 7428 696d 675f 6865 6967 6874  , int(img_height
-000091e0: 5f68 202a 2030 2e39 292c 2069 6e74 2869  _h * 0.9), int(i
-000091f0: 6d67 5f77 6964 7468 5f68 202a 2030 2e39  mg_width_h * 0.9
-00009200: 2920 290a 0a20 2020 2020 2020 2020 2020  ) )..           
-00009210: 2069 6620 636f 6c73 203e 3d20 363a 0a20   if cols >= 6:. 
-00009220: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00009230: 6620 696d 675f 7769 6474 685f 6820 3e20  f img_width_h > 
-00009240: 3536 3030 3a0a 2020 2020 2020 2020 2020  5600:.          
-00009250: 2020 2020 2020 2020 2020 696d 6720 3d20            img = 
-00009260: 6f74 7375 5f63 6f70 795f 6269 6e61 7279  otsu_copy_binary
-00009270: 2869 6d67 290a 2020 2020 2020 2020 2020  (img).          
-00009280: 2020 2020 2020 2020 2020 696d 6720 3d20            img = 
-00009290: 696d 672e 6173 7479 7065 286e 702e 7569  img.astype(np.ui
-000092a0: 6e74 3829 0a20 2020 2020 2020 2020 2020  nt8).           
-000092b0: 2020 2020 2020 2020 2069 6d67 3d20 7265           img= re
-000092c0: 7369 7a65 5f69 6d61 6765 2869 6d67 2c20  size_image(img, 
-000092d0: 696e 7428 696d 675f 6865 6967 6874 5f68  int(img_height_h
-000092e0: 202a 2035 3630 3020 2f20 666c 6f61 7428   * 5600 / float(
-000092f0: 696d 675f 7769 6474 685f 6829 292c 2035  img_width_h)), 5
-00009300: 3630 3029 0a20 2020 2020 2020 2020 2020  600).           
-00009310: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-00009320: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00009330: 6d67 203d 206f 7473 755f 636f 7079 5f62  mg = otsu_copy_b
-00009340: 696e 6172 7928 696d 6729 0a20 2020 2020  inary(img).     
-00009350: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-00009360: 6d67 203d 2069 6d67 2e61 7374 7970 6528  mg = img.astype(
-00009370: 6e70 2e75 696e 7438 290a 2020 2020 2020  np.uint8).      
-00009380: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00009390: 673d 2072 6573 697a 655f 696d 6167 6528  g= resize_image(
-000093a0: 696d 672c 2069 6e74 2869 6d67 5f68 6569  img, int(img_hei
-000093b0: 6768 745f 6820 2a20 302e 3929 2c20 696e  ght_h * 0.9), in
-000093c0: 7428 696d 675f 7769 6474 685f 6820 2a20  t(img_width_h * 
-000093d0: 302e 3929 290a 0a20 2020 2020 2020 206d  0.9))..        m
-000093e0: 6172 6769 6e61 6c5f 6f66 5f70 6174 6368  arginal_of_patch
-000093f0: 5f70 6572 6365 6e74 203d 2030 2e31 0a20  _percent = 0.1. 
-00009400: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
-00009410: 6e5f 7265 6769 6f6e 7320 3d20 7365 6c66  n_regions = self
-00009420: 2e64 6f5f 7072 6564 6963 7469 6f6e 2870  .do_prediction(p
-00009430: 6174 6368 6573 2c20 696d 672c 206d 6f64  atches, img, mod
-00009440: 656c 5f72 6567 696f 6e2c 206d 6172 6769  el_region, margi
-00009450: 6e61 6c5f 6f66 5f70 6174 6368 5f70 6572  nal_of_patch_per
-00009460: 6365 6e74 290a 2020 2020 2020 2020 7072  cent).        pr
-00009470: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
-00009480: 203d 2072 6573 697a 655f 696d 6167 6528   = resize_image(
-00009490: 7072 6564 6963 7469 6f6e 5f72 6567 696f  prediction_regio
-000094a0: 6e73 2c20 696d 675f 6865 6967 6874 5f68  ns, img_height_h
-000094b0: 2c20 696d 675f 7769 6474 685f 6829 0a0a  , img_width_h)..
-000094c0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-000094d0: 6765 722e 6465 6275 6728 2265 7869 7420  ger.debug("exit 
-000094e0: 6578 7472 6163 745f 7465 7874 5f72 6567  extract_text_reg
-000094f0: 696f 6e73 2229 0a20 2020 2020 2020 2072  ions").        r
-00009500: 6574 7572 6e20 7072 6564 6963 7469 6f6e  eturn prediction
-00009510: 5f72 6567 696f 6e73 2c20 7072 6564 6963  _regions, predic
-00009520: 7469 6f6e 5f72 6567 696f 6e73 320a 0a20  tion_regions2.. 
-00009530: 2020 2064 6566 2067 6574 5f73 6c6f 7065     def get_slope
-00009540: 735f 616e 645f 6465 736b 6577 5f6e 6577  s_and_deskew_new
-00009550: 2873 656c 662c 2063 6f6e 746f 7572 732c  (self, contours,
-00009560: 2063 6f6e 746f 7572 735f 7061 722c 2074   contours_par, t
-00009570: 6578 746c 696e 655f 6d61 736b 5f74 6f74  extline_mask_tot
-00009580: 2c20 696d 6167 655f 7061 6765 5f72 6f74  , image_page_rot
-00009590: 6174 6564 2c20 626f 7865 732c 2073 6c6f  ated, boxes, slo
-000095a0: 7065 5f64 6573 6b65 7729 3a0a 2020 2020  pe_deskew):.    
-000095b0: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
-000095c0: 6465 6275 6728 2265 6e74 6572 2067 6574  debug("enter get
-000095d0: 5f73 6c6f 7065 735f 616e 645f 6465 736b  _slopes_and_desk
-000095e0: 6577 5f6e 6577 2229 0a20 2020 2020 2020  ew_new").       
-000095f0: 206e 756d 5f63 6f72 6573 203d 2063 7075   num_cores = cpu
-00009600: 5f63 6f75 6e74 2829 0a20 2020 2020 2020  _count().       
-00009610: 2071 7565 7565 5f6f 665f 616c 6c5f 7061   queue_of_all_pa
-00009620: 7261 6d73 203d 2051 7565 7565 2829 0a0a  rams = Queue()..
-00009630: 2020 2020 2020 2020 7072 6f63 6573 7365          processe
-00009640: 7320 3d20 5b5d 0a20 2020 2020 2020 206e  s = [].        n
-00009650: 6820 3d20 6e70 2e6c 696e 7370 6163 6528  h = np.linspace(
-00009660: 302c 206c 656e 2862 6f78 6573 292c 206e  0, len(boxes), n
-00009670: 756d 5f63 6f72 6573 202b 2031 290a 2020  um_cores + 1).  
-00009680: 2020 2020 2020 696e 6465 7865 735f 6279        indexes_by
-00009690: 5f74 6578 745f 636f 6e20 3d20 6e70 2e61  _text_con = np.a
-000096a0: 7272 6179 2872 616e 6765 286c 656e 2863  rray(range(len(c
-000096b0: 6f6e 746f 7572 735f 7061 7229 2929 0a20  ontours_par))). 
-000096c0: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
-000096d0: 7261 6e67 6528 6e75 6d5f 636f 7265 7329  range(num_cores)
-000096e0: 3a0a 2020 2020 2020 2020 2020 2020 626f  :.            bo
-000096f0: 7865 735f 7065 725f 7072 6f63 6573 7320  xes_per_process 
-00009700: 3d20 626f 7865 735b 696e 7428 6e68 5b69  = boxes[int(nh[i
-00009710: 5d29 203a 2069 6e74 286e 685b 6920 2b20  ]) : int(nh[i + 
-00009720: 315d 295d 0a20 2020 2020 2020 2020 2020  1])].           
-00009730: 2063 6f6e 746f 7572 735f 7065 725f 7072   contours_per_pr
-00009740: 6f63 6573 7320 3d20 636f 6e74 6f75 7273  ocess = contours
-00009750: 5b69 6e74 286e 685b 695d 2920 3a20 696e  [int(nh[i]) : in
-00009760: 7428 6e68 5b69 202b 2031 5d29 5d0a 2020  t(nh[i + 1])].  
-00009770: 2020 2020 2020 2020 2020 636f 6e74 6f75            contou
-00009780: 7273 5f70 6172 5f70 6572 5f70 726f 6365  rs_par_per_proce
-00009790: 7373 203d 2063 6f6e 746f 7572 735f 7061  ss = contours_pa
-000097a0: 725b 696e 7428 6e68 5b69 5d29 203a 2069  r[int(nh[i]) : i
-000097b0: 6e74 286e 685b 6920 2b20 315d 295d 0a20  nt(nh[i + 1])]. 
-000097c0: 2020 2020 2020 2020 2020 2069 6e64 6578             index
-000097d0: 6573 5f74 6578 745f 636f 6e5f 7065 725f  es_text_con_per_
-000097e0: 7072 6f63 6573 7320 3d20 696e 6465 7865  process = indexe
-000097f0: 735f 6279 5f74 6578 745f 636f 6e5b 696e  s_by_text_con[in
-00009800: 7428 6e68 5b69 5d29 203a 2069 6e74 286e  t(nh[i]) : int(n
-00009810: 685b 6920 2b20 315d 295d 0a0a 2020 2020  h[i + 1])]..    
-00009820: 2020 2020 2020 2020 7072 6f63 6573 7365          processe
-00009830: 732e 6170 7065 6e64 2850 726f 6365 7373  s.append(Process
-00009840: 2874 6172 6765 743d 7365 6c66 2e64 6f5f  (target=self.do_
-00009850: 776f 726b 5f6f 665f 736c 6f70 6573 5f6e  work_of_slopes_n
-00009860: 6577 2c20 6172 6773 3d28 7175 6575 655f  ew, args=(queue_
-00009870: 6f66 5f61 6c6c 5f70 6172 616d 732c 2062  of_all_params, b
-00009880: 6f78 6573 5f70 6572 5f70 726f 6365 7373  oxes_per_process
-00009890: 2c20 7465 7874 6c69 6e65 5f6d 6173 6b5f  , textline_mask_
-000098a0: 746f 742c 2063 6f6e 746f 7572 735f 7065  tot, contours_pe
-000098b0: 725f 7072 6f63 6573 732c 2063 6f6e 746f  r_process, conto
-000098c0: 7572 735f 7061 725f 7065 725f 7072 6f63  urs_par_per_proc
-000098d0: 6573 732c 2069 6e64 6578 6573 5f74 6578  ess, indexes_tex
-000098e0: 745f 636f 6e5f 7065 725f 7072 6f63 6573  t_con_per_proces
-000098f0: 732c 2069 6d61 6765 5f70 6167 655f 726f  s, image_page_ro
-00009900: 7461 7465 642c 2073 6c6f 7065 5f64 6573  tated, slope_des
-00009910: 6b65 7729 2929 0a20 2020 2020 2020 2066  kew))).        f
-00009920: 6f72 2069 2069 6e20 7261 6e67 6528 6e75  or i in range(nu
-00009930: 6d5f 636f 7265 7329 3a0a 2020 2020 2020  m_cores):.      
-00009940: 2020 2020 2020 7072 6f63 6573 7365 735b        processes[
-00009950: 695d 2e73 7461 7274 2829 0a0a 2020 2020  i].start()..    
-00009960: 2020 2020 736c 6f70 6573 203d 205b 5d0a      slopes = [].
-00009970: 2020 2020 2020 2020 616c 6c5f 666f 756e          all_foun
-00009980: 645f 7465 786c 696e 655f 706f 6c79 676f  d_texline_polygo
-00009990: 6e73 203d 205b 5d0a 2020 2020 2020 2020  ns = [].        
-000099a0: 616c 6c5f 666f 756e 645f 7465 7874 5f72  all_found_text_r
-000099b0: 6567 696f 6e73 203d 205b 5d0a 2020 2020  egions = [].    
-000099c0: 2020 2020 616c 6c5f 666f 756e 645f 7465      all_found_te
-000099d0: 7874 5f72 6567 696f 6e73 5f70 6172 203d  xt_regions_par =
-000099e0: 205b 5d0a 2020 2020 2020 2020 626f 7865   [].        boxe
-000099f0: 7320 3d20 5b5d 0a20 2020 2020 2020 2061  s = [].        a
-00009a00: 6c6c 5f62 6f78 5f63 6f6f 7264 203d 205b  ll_box_coord = [
-00009a10: 5d0a 2020 2020 2020 2020 616c 6c5f 696e  ].        all_in
-00009a20: 6465 785f 7465 7874 5f63 6f6e 203d 205b  dex_text_con = [
-00009a30: 5d0a 2020 2020 2020 2020 666f 7220 6920  ].        for i 
-00009a40: 696e 2072 616e 6765 286e 756d 5f63 6f72  in range(num_cor
-00009a50: 6573 293a 0a20 2020 2020 2020 2020 2020  es):.           
-00009a60: 206c 6973 745f 616c 6c5f 7061 7220 3d20   list_all_par = 
-00009a70: 7175 6575 655f 6f66 5f61 6c6c 5f70 6172  queue_of_all_par
-00009a80: 616d 732e 6765 7428 5472 7565 290a 2020  ams.get(True).  
-00009a90: 2020 2020 2020 2020 2020 736c 6f70 6573            slopes
-00009aa0: 5f66 6f72 5f73 7562 5f70 726f 6365 7373  _for_sub_process
-00009ab0: 203d 206c 6973 745f 616c 6c5f 7061 725b   = list_all_par[
-00009ac0: 305d 0a20 2020 2020 2020 2020 2020 2070  0].            p
-00009ad0: 6f6c 7973 5f66 6f72 5f73 7562 5f70 726f  olys_for_sub_pro
-00009ae0: 6365 7373 203d 206c 6973 745f 616c 6c5f  cess = list_all_
-00009af0: 7061 725b 315d 0a20 2020 2020 2020 2020  par[1].         
-00009b00: 2020 2062 6f78 6573 5f66 6f72 5f73 7562     boxes_for_sub
-00009b10: 5f70 726f 6365 7373 203d 206c 6973 745f  _process = list_
-00009b20: 616c 6c5f 7061 725b 325d 0a20 2020 2020  all_par[2].     
-00009b30: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
-00009b40: 666f 725f 7375 6270 726f 6365 7373 203d  for_subprocess =
-00009b50: 206c 6973 745f 616c 6c5f 7061 725b 335d   list_all_par[3]
-00009b60: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-00009b70: 746f 7572 735f 7061 725f 666f 725f 7375  tours_par_for_su
-00009b80: 6270 726f 6365 7373 203d 206c 6973 745f  bprocess = list_
-00009b90: 616c 6c5f 7061 725b 345d 0a20 2020 2020  all_par[4].     
-00009ba0: 2020 2020 2020 2062 6f78 6573 5f63 6f6f         boxes_coo
-00009bb0: 7264 5f66 6f72 5f73 7562 7072 6f63 6573  rd_for_subproces
-00009bc0: 7320 3d20 6c69 7374 5f61 6c6c 5f70 6172  s = list_all_par
-00009bd0: 5b35 5d0a 2020 2020 2020 2020 2020 2020  [5].            
-00009be0: 696e 6465 7865 735f 666f 725f 7375 6270  indexes_for_subp
-00009bf0: 726f 6365 7373 203d 206c 6973 745f 616c  rocess = list_al
-00009c00: 6c5f 7061 725b 365d 0a20 2020 2020 2020  l_par[6].       
-00009c10: 2020 2020 2066 6f72 206a 2069 6e20 7261       for j in ra
-00009c20: 6e67 6528 6c65 6e28 736c 6f70 6573 5f66  nge(len(slopes_f
-00009c30: 6f72 5f73 7562 5f70 726f 6365 7373 2929  or_sub_process))
-00009c40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00009c50: 2020 736c 6f70 6573 2e61 7070 656e 6428    slopes.append(
-00009c60: 736c 6f70 6573 5f66 6f72 5f73 7562 5f70  slopes_for_sub_p
-00009c70: 726f 6365 7373 5b6a 5d29 0a20 2020 2020  rocess[j]).     
-00009c80: 2020 2020 2020 2020 2020 2061 6c6c 5f66             all_f
-00009c90: 6f75 6e64 5f74 6578 6c69 6e65 5f70 6f6c  ound_texline_pol
-00009ca0: 7967 6f6e 732e 6170 7065 6e64 2870 6f6c  ygons.append(pol
-00009cb0: 7973 5f66 6f72 5f73 7562 5f70 726f 6365  ys_for_sub_proce
-00009cc0: 7373 5b6a 5d29 0a20 2020 2020 2020 2020  ss[j]).         
-00009cd0: 2020 2020 2020 2062 6f78 6573 2e61 7070         boxes.app
-00009ce0: 656e 6428 626f 7865 735f 666f 725f 7375  end(boxes_for_su
-00009cf0: 625f 7072 6f63 6573 735b 6a5d 290a 2020  b_process[j]).  
-00009d00: 2020 2020 2020 2020 2020 2020 2020 616c                al
-00009d10: 6c5f 666f 756e 645f 7465 7874 5f72 6567  l_found_text_reg
-00009d20: 696f 6e73 2e61 7070 656e 6428 636f 6e74  ions.append(cont
-00009d30: 6f75 7273 5f66 6f72 5f73 7562 7072 6f63  ours_for_subproc
-00009d40: 6573 735b 6a5d 290a 2020 2020 2020 2020  ess[j]).        
-00009d50: 2020 2020 2020 2020 616c 6c5f 666f 756e          all_foun
-00009d60: 645f 7465 7874 5f72 6567 696f 6e73 5f70  d_text_regions_p
-00009d70: 6172 2e61 7070 656e 6428 636f 6e74 6f75  ar.append(contou
-00009d80: 7273 5f70 6172 5f66 6f72 5f73 7562 7072  rs_par_for_subpr
-00009d90: 6f63 6573 735b 6a5d 290a 2020 2020 2020  ocess[j]).      
-00009da0: 2020 2020 2020 2020 2020 616c 6c5f 626f            all_bo
-00009db0: 785f 636f 6f72 642e 6170 7065 6e64 2862  x_coord.append(b
-00009dc0: 6f78 6573 5f63 6f6f 7264 5f66 6f72 5f73  oxes_coord_for_s
-00009dd0: 7562 7072 6f63 6573 735b 6a5d 290a 2020  ubprocess[j]).  
-00009de0: 2020 2020 2020 2020 2020 2020 2020 616c                al
-00009df0: 6c5f 696e 6465 785f 7465 7874 5f63 6f6e  l_index_text_con
-00009e00: 2e61 7070 656e 6428 696e 6465 7865 735f  .append(indexes_
-00009e10: 666f 725f 7375 6270 726f 6365 7373 5b6a  for_subprocess[j
-00009e20: 5d29 0a20 2020 2020 2020 2066 6f72 2069  ]).        for i
-00009e30: 2069 6e20 7261 6e67 6528 6e75 6d5f 636f   in range(num_co
-00009e40: 7265 7329 3a0a 2020 2020 2020 2020 2020  res):.          
-00009e50: 2020 7072 6f63 6573 7365 735b 695d 2e6a    processes[i].j
-00009e60: 6f69 6e28 290a 2020 2020 2020 2020 7365  oin().        se
-00009e70: 6c66 2e6c 6f67 6765 722e 6465 6275 6728  lf.logger.debug(
-00009e80: 2773 6c6f 7065 7320 2573 272c 2073 6c6f  'slopes %s', slo
-00009e90: 7065 7329 0a20 2020 2020 2020 2073 656c  pes).        sel
-00009ea0: 662e 6c6f 6767 6572 2e64 6562 7567 2822  f.logger.debug("
-00009eb0: 6578 6974 2067 6574 5f73 6c6f 7065 735f  exit get_slopes_
-00009ec0: 616e 645f 6465 736b 6577 5f6e 6577 2229  and_deskew_new")
-00009ed0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-00009ee0: 736c 6f70 6573 2c20 616c 6c5f 666f 756e  slopes, all_foun
-00009ef0: 645f 7465 786c 696e 655f 706f 6c79 676f  d_texline_polygo
-00009f00: 6e73 2c20 626f 7865 732c 2061 6c6c 5f66  ns, boxes, all_f
-00009f10: 6f75 6e64 5f74 6578 745f 7265 6769 6f6e  ound_text_region
-00009f20: 732c 2061 6c6c 5f66 6f75 6e64 5f74 6578  s, all_found_tex
-00009f30: 745f 7265 6769 6f6e 735f 7061 722c 2061  t_regions_par, a
-00009f40: 6c6c 5f62 6f78 5f63 6f6f 7264 2c20 616c  ll_box_coord, al
-00009f50: 6c5f 696e 6465 785f 7465 7874 5f63 6f6e  l_index_text_con
-00009f60: 0a0a 2020 2020 6465 6620 6765 745f 736c  ..    def get_sl
-00009f70: 6f70 6573 5f61 6e64 5f64 6573 6b65 775f  opes_and_deskew_
-00009f80: 6e65 775f 6375 7276 6564 2873 656c 662c  new_curved(self,
-00009f90: 2063 6f6e 746f 7572 732c 2063 6f6e 746f   contours, conto
-00009fa0: 7572 735f 7061 722c 2074 6578 746c 696e  urs_par, textlin
-00009fb0: 655f 6d61 736b 5f74 6f74 2c20 696d 6167  e_mask_tot, imag
-00009fc0: 655f 7061 6765 5f72 6f74 6174 6564 2c20  e_page_rotated, 
-00009fd0: 626f 7865 732c 206d 6173 6b5f 7465 7874  boxes, mask_text
-00009fe0: 735f 6f6e 6c79 2c20 6e75 6d5f 636f 6c2c  s_only, num_col,
-00009ff0: 2073 6361 6c65 5f70 6172 2c20 736c 6f70   scale_par, slop
-0000a000: 655f 6465 736b 6577 293a 0a20 2020 2020  e_deskew):.     
-0000a010: 2020 2073 656c 662e 6c6f 6767 6572 2e64     self.logger.d
-0000a020: 6562 7567 2822 656e 7465 7220 6765 745f  ebug("enter get_
-0000a030: 736c 6f70 6573 5f61 6e64 5f64 6573 6b65  slopes_and_deske
-0000a040: 775f 6e65 775f 6375 7276 6564 2229 0a20  w_new_curved"). 
-0000a050: 2020 2020 2020 206e 756d 5f63 6f72 6573         num_cores
-0000a060: 203d 2063 7075 5f63 6f75 6e74 2829 0a20   = cpu_count(). 
-0000a070: 2020 2020 2020 2071 7565 7565 5f6f 665f         queue_of_
-0000a080: 616c 6c5f 7061 7261 6d73 203d 2051 7565  all_params = Que
-0000a090: 7565 2829 0a0a 2020 2020 2020 2020 7072  ue()..        pr
-0000a0a0: 6f63 6573 7365 7320 3d20 5b5d 0a20 2020  ocesses = [].   
-0000a0b0: 2020 2020 206e 6820 3d20 6e70 2e6c 696e       nh = np.lin
-0000a0c0: 7370 6163 6528 302c 206c 656e 2862 6f78  space(0, len(box
-0000a0d0: 6573 292c 206e 756d 5f63 6f72 6573 202b  es), num_cores +
-0000a0e0: 2031 290a 2020 2020 2020 2020 696e 6465   1).        inde
-0000a0f0: 7865 735f 6279 5f74 6578 745f 636f 6e20  xes_by_text_con 
-0000a100: 3d20 6e70 2e61 7272 6179 2872 616e 6765  = np.array(range
-0000a110: 286c 656e 2863 6f6e 746f 7572 735f 7061  (len(contours_pa
-0000a120: 7229 2929 0a0a 2020 2020 2020 2020 666f  r)))..        fo
-0000a130: 7220 6920 696e 2072 616e 6765 286e 756d  r i in range(num
-0000a140: 5f63 6f72 6573 293a 0a20 2020 2020 2020  _cores):.       
-0000a150: 2020 2020 2062 6f78 6573 5f70 6572 5f70       boxes_per_p
-0000a160: 726f 6365 7373 203d 2062 6f78 6573 5b69  rocess = boxes[i
-0000a170: 6e74 286e 685b 695d 2920 3a20 696e 7428  nt(nh[i]) : int(
-0000a180: 6e68 5b69 202b 2031 5d29 5d0a 2020 2020  nh[i + 1])].    
-0000a190: 2020 2020 2020 2020 636f 6e74 6f75 7273          contours
-0000a1a0: 5f70 6572 5f70 726f 6365 7373 203d 2063  _per_process = c
-0000a1b0: 6f6e 746f 7572 735b 696e 7428 6e68 5b69  ontours[int(nh[i
-0000a1c0: 5d29 203a 2069 6e74 286e 685b 6920 2b20  ]) : int(nh[i + 
-0000a1d0: 315d 295d 0a20 2020 2020 2020 2020 2020  1])].           
-0000a1e0: 2063 6f6e 746f 7572 735f 7061 725f 7065   contours_par_pe
-0000a1f0: 725f 7072 6f63 6573 7320 3d20 636f 6e74  r_process = cont
-0000a200: 6f75 7273 5f70 6172 5b69 6e74 286e 685b  ours_par[int(nh[
-0000a210: 695d 2920 3a20 696e 7428 6e68 5b69 202b  i]) : int(nh[i +
-0000a220: 2031 5d29 5d0a 2020 2020 2020 2020 2020   1])].          
-0000a230: 2020 696e 6465 7865 735f 7465 7874 5f63    indexes_text_c
-0000a240: 6f6e 5f70 6572 5f70 726f 6365 7373 203d  on_per_process =
-0000a250: 2069 6e64 6578 6573 5f62 795f 7465 7874   indexes_by_text
-0000a260: 5f63 6f6e 5b69 6e74 286e 685b 695d 2920  _con[int(nh[i]) 
-0000a270: 3a20 696e 7428 6e68 5b69 202b 2031 5d29  : int(nh[i + 1])
-0000a280: 5d0a 0a20 2020 2020 2020 2020 2020 2070  ]..            p
-0000a290: 726f 6365 7373 6573 2e61 7070 656e 6428  rocesses.append(
-0000a2a0: 5072 6f63 6573 7328 7461 7267 6574 3d73  Process(target=s
-0000a2b0: 656c 662e 646f 5f77 6f72 6b5f 6f66 5f73  elf.do_work_of_s
-0000a2c0: 6c6f 7065 735f 6e65 775f 6375 7276 6564  lopes_new_curved
-0000a2d0: 2c20 6172 6773 3d28 7175 6575 655f 6f66  , args=(queue_of
-0000a2e0: 5f61 6c6c 5f70 6172 616d 732c 2062 6f78  _all_params, box
-0000a2f0: 6573 5f70 6572 5f70 726f 6365 7373 2c20  es_per_process, 
-0000a300: 7465 7874 6c69 6e65 5f6d 6173 6b5f 746f  textline_mask_to
-0000a310: 742c 2063 6f6e 746f 7572 735f 7065 725f  t, contours_per_
-0000a320: 7072 6f63 6573 732c 2063 6f6e 746f 7572  process, contour
-0000a330: 735f 7061 725f 7065 725f 7072 6f63 6573  s_par_per_proces
-0000a340: 732c 2069 6d61 6765 5f70 6167 655f 726f  s, image_page_ro
-0000a350: 7461 7465 642c 206d 6173 6b5f 7465 7874  tated, mask_text
-0000a360: 735f 6f6e 6c79 2c20 6e75 6d5f 636f 6c2c  s_only, num_col,
-0000a370: 2073 6361 6c65 5f70 6172 2c20 696e 6465   scale_par, inde
-0000a380: 7865 735f 7465 7874 5f63 6f6e 5f70 6572  xes_text_con_per
-0000a390: 5f70 726f 6365 7373 2c20 736c 6f70 655f  _process, slope_
-0000a3a0: 6465 736b 6577 2929 290a 0a20 2020 2020  deskew)))..     
-0000a3b0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
-0000a3c0: 6528 6e75 6d5f 636f 7265 7329 3a0a 2020  e(num_cores):.  
-0000a3d0: 2020 2020 2020 2020 2020 7072 6f63 6573            proces
-0000a3e0: 7365 735b 695d 2e73 7461 7274 2829 0a0a  ses[i].start()..
-0000a3f0: 2020 2020 2020 2020 736c 6f70 6573 203d          slopes =
-0000a400: 205b 5d0a 2020 2020 2020 2020 616c 6c5f   [].        all_
-0000a410: 666f 756e 645f 7465 786c 696e 655f 706f  found_texline_po
-0000a420: 6c79 676f 6e73 203d 205b 5d0a 2020 2020  lygons = [].    
-0000a430: 2020 2020 616c 6c5f 666f 756e 645f 7465      all_found_te
-0000a440: 7874 5f72 6567 696f 6e73 203d 205b 5d0a  xt_regions = [].
-0000a450: 2020 2020 2020 2020 616c 6c5f 666f 756e          all_foun
-0000a460: 645f 7465 7874 5f72 6567 696f 6e73 5f70  d_text_regions_p
-0000a470: 6172 203d 205b 5d0a 2020 2020 2020 2020  ar = [].        
-0000a480: 626f 7865 7320 3d20 5b5d 0a20 2020 2020  boxes = [].     
-0000a490: 2020 2061 6c6c 5f62 6f78 5f63 6f6f 7264     all_box_coord
-0000a4a0: 203d 205b 5d0a 2020 2020 2020 2020 616c   = [].        al
-0000a4b0: 6c5f 696e 6465 785f 7465 7874 5f63 6f6e  l_index_text_con
-0000a4c0: 203d 205b 5d0a 0a20 2020 2020 2020 2066   = []..        f
-0000a4d0: 6f72 2069 2069 6e20 7261 6e67 6528 6e75  or i in range(nu
-0000a4e0: 6d5f 636f 7265 7329 3a0a 2020 2020 2020  m_cores):.      
-0000a4f0: 2020 2020 2020 6c69 7374 5f61 6c6c 5f70        list_all_p
-0000a500: 6172 203d 2071 7565 7565 5f6f 665f 616c  ar = queue_of_al
-0000a510: 6c5f 7061 7261 6d73 2e67 6574 2854 7275  l_params.get(Tru
-0000a520: 6529 0a20 2020 2020 2020 2020 2020 2070  e).            p
-0000a530: 6f6c 7973 5f66 6f72 5f73 7562 5f70 726f  olys_for_sub_pro
-0000a540: 6365 7373 203d 206c 6973 745f 616c 6c5f  cess = list_all_
-0000a550: 7061 725b 305d 0a20 2020 2020 2020 2020  par[0].         
-0000a560: 2020 2062 6f78 6573 5f66 6f72 5f73 7562     boxes_for_sub
-0000a570: 5f70 726f 6365 7373 203d 206c 6973 745f  _process = list_
-0000a580: 616c 6c5f 7061 725b 315d 0a20 2020 2020  all_par[1].     
-0000a590: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
-0000a5a0: 666f 725f 7375 6270 726f 6365 7373 203d  for_subprocess =
-0000a5b0: 206c 6973 745f 616c 6c5f 7061 725b 325d   list_all_par[2]
-0000a5c0: 0a20 2020 2020 2020 2020 2020 2063 6f6e  .            con
-0000a5d0: 746f 7572 735f 7061 725f 666f 725f 7375  tours_par_for_su
-0000a5e0: 6270 726f 6365 7373 203d 206c 6973 745f  bprocess = list_
-0000a5f0: 616c 6c5f 7061 725b 335d 0a20 2020 2020  all_par[3].     
-0000a600: 2020 2020 2020 2062 6f78 6573 5f63 6f6f         boxes_coo
-0000a610: 7264 5f66 6f72 5f73 7562 7072 6f63 6573  rd_for_subproces
-0000a620: 7320 3d20 6c69 7374 5f61 6c6c 5f70 6172  s = list_all_par
-0000a630: 5b34 5d0a 2020 2020 2020 2020 2020 2020  [4].            
-0000a640: 696e 6465 7865 735f 666f 725f 7375 6270  indexes_for_subp
-0000a650: 726f 6365 7373 203d 206c 6973 745f 616c  rocess = list_al
-0000a660: 6c5f 7061 725b 355d 0a20 2020 2020 2020  l_par[5].       
-0000a670: 2020 2020 2073 6c6f 7065 735f 666f 725f       slopes_for_
-0000a680: 7375 625f 7072 6f63 6573 7320 3d20 6c69  sub_process = li
-0000a690: 7374 5f61 6c6c 5f70 6172 5b36 5d0a 2020  st_all_par[6].  
-0000a6a0: 2020 2020 2020 2020 2020 666f 7220 6a20            for j 
-0000a6b0: 696e 2072 616e 6765 286c 656e 2870 6f6c  in range(len(pol
-0000a6c0: 7973 5f66 6f72 5f73 7562 5f70 726f 6365  ys_for_sub_proce
-0000a6d0: 7373 2929 3a0a 2020 2020 2020 2020 2020  ss)):.          
-0000a6e0: 2020 2020 2020 736c 6f70 6573 2e61 7070        slopes.app
-0000a6f0: 656e 6428 736c 6f70 6573 5f66 6f72 5f73  end(slopes_for_s
-0000a700: 7562 5f70 726f 6365 7373 5b6a 5d29 0a20  ub_process[j]). 
-0000a710: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0000a720: 6c6c 5f66 6f75 6e64 5f74 6578 6c69 6e65  ll_found_texline
-0000a730: 5f70 6f6c 7967 6f6e 732e 6170 7065 6e64  _polygons.append
-0000a740: 2870 6f6c 7973 5f66 6f72 5f73 7562 5f70  (polys_for_sub_p
-0000a750: 726f 6365 7373 5b6a 5d5b 3a3a 2d31 5d29  rocess[j][::-1])
-0000a760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000a770: 2062 6f78 6573 2e61 7070 656e 6428 626f   boxes.append(bo
-0000a780: 7865 735f 666f 725f 7375 625f 7072 6f63  xes_for_sub_proc
-0000a790: 6573 735b 6a5d 290a 2020 2020 2020 2020  ess[j]).        
-0000a7a0: 2020 2020 2020 2020 616c 6c5f 666f 756e          all_foun
-0000a7b0: 645f 7465 7874 5f72 6567 696f 6e73 2e61  d_text_regions.a
-0000a7c0: 7070 656e 6428 636f 6e74 6f75 7273 5f66  ppend(contours_f
-0000a7d0: 6f72 5f73 7562 7072 6f63 6573 735b 6a5d  or_subprocess[j]
-0000a7e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000a7f0: 2020 616c 6c5f 666f 756e 645f 7465 7874    all_found_text
-0000a800: 5f72 6567 696f 6e73 5f70 6172 2e61 7070  _regions_par.app
-0000a810: 656e 6428 636f 6e74 6f75 7273 5f70 6172  end(contours_par
-0000a820: 5f66 6f72 5f73 7562 7072 6f63 6573 735b  _for_subprocess[
-0000a830: 6a5d 290a 2020 2020 2020 2020 2020 2020  j]).            
-0000a840: 2020 2020 616c 6c5f 626f 785f 636f 6f72      all_box_coor
-0000a850: 642e 6170 7065 6e64 2862 6f78 6573 5f63  d.append(boxes_c
-0000a860: 6f6f 7264 5f66 6f72 5f73 7562 7072 6f63  oord_for_subproc
-0000a870: 6573 735b 6a5d 290a 2020 2020 2020 2020  ess[j]).        
-0000a880: 2020 2020 2020 2020 616c 6c5f 696e 6465          all_inde
-0000a890: 785f 7465 7874 5f63 6f6e 2e61 7070 656e  x_text_con.appen
-0000a8a0: 6428 696e 6465 7865 735f 666f 725f 7375  d(indexes_for_su
-0000a8b0: 6270 726f 6365 7373 5b6a 5d29 0a0a 2020  bprocess[j])..  
-0000a8c0: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
-0000a8d0: 616e 6765 286e 756d 5f63 6f72 6573 293a  ange(num_cores):
-0000a8e0: 0a20 2020 2020 2020 2020 2020 2070 726f  .            pro
-0000a8f0: 6365 7373 6573 5b69 5d2e 6a6f 696e 2829  cesses[i].join()
-0000a900: 0a20 2020 2020 2020 2023 2070 7269 6e74  .        # print
-0000a910: 2873 6c6f 7065 732c 2773 6c6f 7065 7327  (slopes,'slopes'
-0000a920: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
-0000a930: 2061 6c6c 5f66 6f75 6e64 5f74 6578 6c69   all_found_texli
-0000a940: 6e65 5f70 6f6c 7967 6f6e 732c 2062 6f78  ne_polygons, box
-0000a950: 6573 2c20 616c 6c5f 666f 756e 645f 7465  es, all_found_te
-0000a960: 7874 5f72 6567 696f 6e73 2c20 616c 6c5f  xt_regions, all_
-0000a970: 666f 756e 645f 7465 7874 5f72 6567 696f  found_text_regio
-0000a980: 6e73 5f70 6172 2c20 616c 6c5f 626f 785f  ns_par, all_box_
-0000a990: 636f 6f72 642c 2061 6c6c 5f69 6e64 6578  coord, all_index
-0000a9a0: 5f74 6578 745f 636f 6e2c 2073 6c6f 7065  _text_con, slope
-0000a9b0: 730a 0a20 2020 2064 6566 2064 6f5f 776f  s..    def do_wo
-0000a9c0: 726b 5f6f 665f 736c 6f70 6573 5f6e 6577  rk_of_slopes_new
-0000a9d0: 5f63 7572 7665 6428 7365 6c66 2c20 7175  _curved(self, qu
-0000a9e0: 6575 655f 6f66 5f61 6c6c 5f70 6172 616d  eue_of_all_param
-0000a9f0: 732c 2062 6f78 6573 5f74 6578 742c 2074  s, boxes_text, t
-0000aa00: 6578 746c 696e 655f 6d61 736b 5f74 6f74  extline_mask_tot
-0000aa10: 5f65 612c 2063 6f6e 746f 7572 735f 7065  _ea, contours_pe
-0000aa20: 725f 7072 6f63 6573 732c 2063 6f6e 746f  r_process, conto
-0000aa30: 7572 735f 7061 725f 7065 725f 7072 6f63  urs_par_per_proc
-0000aa40: 6573 732c 2069 6d61 6765 5f70 6167 655f  ess, image_page_
-0000aa50: 726f 7461 7465 642c 206d 6173 6b5f 7465  rotated, mask_te
-0000aa60: 7874 735f 6f6e 6c79 2c20 6e75 6d5f 636f  xts_only, num_co
-0000aa70: 6c2c 2073 6361 6c65 5f70 6172 2c20 696e  l, scale_par, in
-0000aa80: 6465 7865 735f 725f 636f 6e5f 7065 725f  dexes_r_con_per_
-0000aa90: 7072 6f2c 2073 6c6f 7065 5f64 6573 6b65  pro, slope_deske
-0000aaa0: 7729 3a0a 2020 2020 2020 2020 7365 6c66  w):.        self
-0000aab0: 2e6c 6f67 6765 722e 6465 6275 6728 2265  .logger.debug("e
-0000aac0: 6e74 6572 2064 6f5f 776f 726b 5f6f 665f  nter do_work_of_
-0000aad0: 736c 6f70 6573 5f6e 6577 5f63 7572 7665  slopes_new_curve
-0000aae0: 6422 290a 2020 2020 2020 2020 736c 6f70  d").        slop
-0000aaf0: 6573 5f70 6572 5f65 6163 685f 7375 6270  es_per_each_subp
-0000ab00: 726f 6365 7373 203d 205b 5d0a 2020 2020  rocess = [].    
-0000ab10: 2020 2020 626f 756e 6469 6e67 5f62 6f78      bounding_box
-0000ab20: 5f6f 665f 7465 7874 7265 6769 6f6e 5f70  _of_textregion_p
-0000ab30: 6572 5f65 6163 685f 7375 6270 726f 6365  er_each_subproce
-0000ab40: 7373 203d 205b 5d0a 2020 2020 2020 2020  ss = [].        
-0000ab50: 7465 7874 6c69 6e65 735f 7265 6374 616e  textlines_rectan
-0000ab60: 676c 6573 5f70 6572 5f65 6163 685f 7375  gles_per_each_su
-0000ab70: 6270 726f 6365 7373 203d 205b 5d0a 2020  bprocess = [].  
-0000ab80: 2020 2020 2020 636f 6e74 6f75 7273 5f74        contours_t
-0000ab90: 6578 7472 6567 696f 6e5f 7065 725f 6561  extregion_per_ea
-0000aba0: 6368 5f73 7562 7072 6f63 6573 7320 3d20  ch_subprocess = 
-0000abb0: 5b5d 0a20 2020 2020 2020 2063 6f6e 746f  [].        conto
-0000abc0: 7572 735f 7465 7874 7265 6769 6f6e 5f70  urs_textregion_p
-0000abd0: 6172 5f70 6572 5f65 6163 685f 7375 6270  ar_per_each_subp
-0000abe0: 726f 6365 7373 203d 205b 5d0a 2020 2020  rocess = [].    
-0000abf0: 2020 2020 616c 6c5f 626f 785f 636f 6f72      all_box_coor
-0000ac00: 645f 7065 725f 7072 6f63 6573 7320 3d20  d_per_process = 
-0000ac10: 5b5d 0a20 2020 2020 2020 2069 6e64 6578  [].        index
-0000ac20: 5f62 795f 7465 7874 5f72 6567 696f 6e5f  _by_text_region_
-0000ac30: 636f 6e74 6f75 7273 203d 205b 5d0a 0a20  contours = [].. 
-0000ac40: 2020 2020 2020 2074 6578 746c 696e 655f         textline_
-0000ac50: 636e 745f 7365 7061 7261 7465 6420 3d20  cnt_separated = 
-0000ac60: 6e70 2e7a 6572 6f73 2874 6578 746c 696e  np.zeros(textlin
-0000ac70: 655f 6d61 736b 5f74 6f74 5f65 612e 7368  e_mask_tot_ea.sh
-0000ac80: 6170 6529 0a0a 2020 2020 2020 2020 666f  ape)..        fo
-0000ac90: 7220 6d76 2069 6e20 7261 6e67 6528 6c65  r mv in range(le
-0000aca0: 6e28 626f 7865 735f 7465 7874 2929 3a0a  n(boxes_text)):.
-0000acb0: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
-0000acc0: 5f74 6578 745f 7265 6769 6f6e 5f72 6177  _text_region_raw
-0000acd0: 203d 2074 6578 746c 696e 655f 6d61 736b   = textline_mask
-0000ace0: 5f74 6f74 5f65 615b 626f 7865 735f 7465  _tot_ea[boxes_te
-0000acf0: 7874 5b6d 765d 5b31 5d20 3a20 626f 7865  xt[mv][1] : boxe
-0000ad00: 735f 7465 7874 5b6d 765d 5b31 5d20 2b20  s_text[mv][1] + 
-0000ad10: 626f 7865 735f 7465 7874 5b6d 765d 5b33  boxes_text[mv][3
-0000ad20: 5d2c 2062 6f78 6573 5f74 6578 745b 6d76  ], boxes_text[mv
-0000ad30: 5d5b 305d 203a 2062 6f78 6573 5f74 6578  ][0] : boxes_tex
-0000ad40: 745b 6d76 5d5b 305d 202b 2062 6f78 6573  t[mv][0] + boxes
-0000ad50: 5f74 6578 745b 6d76 5d5b 325d 5d0a 2020  _text[mv][2]].  
-0000ad60: 2020 2020 2020 2020 2020 616c 6c5f 7465            all_te
-0000ad70: 7874 5f72 6567 696f 6e5f 7261 7720 3d20  xt_region_raw = 
-0000ad80: 616c 6c5f 7465 7874 5f72 6567 696f 6e5f  all_text_region_
-0000ad90: 7261 772e 6173 7479 7065 286e 702e 7569  raw.astype(np.ui
-0000ada0: 6e74 3829 0a20 2020 2020 2020 2020 2020  nt8).           
-0000adb0: 2069 6d67 5f69 6e74 5f70 203d 2061 6c6c   img_int_p = all
-0000adc0: 5f74 6578 745f 7265 6769 6f6e 5f72 6177  _text_region_raw
-0000add0: 5b3a 2c20 3a5d 0a0a 2020 2020 2020 2020  [:, :]..        
-0000ade0: 2020 2020 2320 696d 675f 696e 745f 703d      # img_int_p=
-0000adf0: 6376 322e 6572 6f64 6528 696d 675f 696e  cv2.erode(img_in
-0000ae00: 745f 702c 4b45 524e 454c 2c69 7465 7261  t_p,KERNEL,itera
-0000ae10: 7469 6f6e 7320 3d20 3229 0a20 2020 2020  tions = 2).     
-0000ae20: 2020 2020 2020 2023 2070 6c74 2e69 6d73         # plt.ims
-0000ae30: 686f 7728 696d 675f 696e 745f 7029 0a20  how(img_int_p). 
-0000ae40: 2020 2020 2020 2020 2020 2023 2070 6c74             # plt
-0000ae50: 2e73 686f 7728 290a 0a20 2020 2020 2020  .show()..       
-0000ae60: 2020 2020 2069 6620 696d 675f 696e 745f       if img_int_
-0000ae70: 702e 7368 6170 655b 305d 202f 2069 6d67  p.shape[0] / img
-0000ae80: 5f69 6e74 5f70 2e73 6861 7065 5b31 5d20  _int_p.shape[1] 
-0000ae90: 3c20 302e 313a 0a20 2020 2020 2020 2020  < 0.1:.         
-0000aea0: 2020 2020 2020 2073 6c6f 7065 735f 7065         slopes_pe
-0000aeb0: 725f 6561 6368 5f73 7562 7072 6f63 6573  r_each_subproces
-0000aec0: 732e 6170 7065 6e64 2830 290a 2020 2020  s.append(0).    
-0000aed0: 2020 2020 2020 2020 2020 2020 736c 6f70              slop
-0000aee0: 655f 666f 725f 616c 6c20 3d20 5b73 6c6f  e_for_all = [slo
-0000aef0: 7065 5f64 6573 6b65 775d 5b30 5d0a 2020  pe_deskew][0].  
-0000af00: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0000af10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000af20: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-0000af30: 2020 2020 2020 2020 2074 6578 746c 696e           textlin
-0000af40: 655f 636f 6e2c 2068 6965 7261 7263 6879  e_con, hierarchy
-0000af50: 203d 2072 6574 7572 6e5f 636f 6e74 6f75   = return_contou
-0000af60: 7273 5f6f 665f 696d 6167 6528 696d 675f  rs_of_image(img_
-0000af70: 696e 745f 7029 0a20 2020 2020 2020 2020  int_p).         
-0000af80: 2020 2020 2020 2020 2020 2074 6578 746c             textl
-0000af90: 696e 655f 636f 6e5f 6669 6c20 3d20 6669  ine_con_fil = fi
-0000afa0: 6c74 6572 5f63 6f6e 746f 7572 735f 6172  lter_contours_ar
-0000afb0: 6561 5f6f 665f 696d 6167 6528 696d 675f  ea_of_image(img_
-0000afc0: 696e 745f 702c 2074 6578 746c 696e 655f  int_p, textline_
-0000afd0: 636f 6e2c 2068 6965 7261 7263 6879 2c20  con, hierarchy, 
-0000afe0: 6d61 785f 6172 6561 3d31 2c20 6d69 6e5f  max_area=1, min_
-0000aff0: 6172 6561 3d30 2e30 3030 3829 0a20 2020  area=0.0008).   
-0000b000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b010: 2079 5f64 6966 665f 6d65 616e 203d 2066   y_diff_mean = f
-0000b020: 696e 645f 636f 6e74 6f75 7273 5f6d 6561  ind_contours_mea
-0000b030: 6e5f 795f 6469 6666 2874 6578 746c 696e  n_y_diff(textlin
-0000b040: 655f 636f 6e5f 6669 6c29 0a20 2020 2020  e_con_fil).     
-0000b050: 2020 2020 2020 2020 2020 2020 2020 2069                 i
-0000b060: 6620 7365 6c66 2e69 734e 614e 2879 5f64  f self.isNaN(y_d
-0000b070: 6966 665f 6d65 616e 293a 0a20 2020 2020  iff_mean):.     
-0000b080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b090: 2020 2073 6c6f 7065 5f66 6f72 5f61 6c6c     slope_for_all
-0000b0a0: 203d 204d 4158 5f53 4c4f 5045 0a20 2020   = MAX_SLOPE.   
-0000b0b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b0c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0000b0d0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
-0000b0e0: 6967 6d61 5f64 6573 203d 206d 6178 2831  igma_des = max(1
-0000b0f0: 2c20 696e 7428 795f 6469 6666 5f6d 6561  , int(y_diff_mea
-0000b100: 6e20 2a20 2834 2e30 202f 2034 302e 3029  n * (4.0 / 40.0)
-0000b110: 2929 0a20 2020 2020 2020 2020 2020 2020  )).             
-0000b120: 2020 2020 2020 2020 2020 2069 6d67 5f69             img_i
-0000b130: 6e74 5f70 5b69 6d67 5f69 6e74 5f70 203e  nt_p[img_int_p >
-0000b140: 2030 5d20 3d20 310a 2020 2020 2020 2020   0] = 1.        
-0000b150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b160: 736c 6f70 655f 666f 725f 616c 6c20 3d20  slope_for_all = 
-0000b170: 7265 7475 726e 5f64 6573 6b65 775f 736c  return_deskew_sl
-0000b180: 6f70 2869 6d67 5f69 6e74 5f70 2c20 7369  op(img_int_p, si
-0000b190: 676d 615f 6465 732c 2070 6c6f 7474 6572  gma_des, plotter
-0000b1a0: 3d73 656c 662e 706c 6f74 7465 7229 0a0a  =self.plotter)..
+000001b0: 0a22 2222 0a64 6f63 756d 656e 7420 6c61  .""".document la
+000001c0: 796f 7574 2061 6e61 6c79 7369 7320 2873  yout analysis (s
+000001d0: 6567 6d65 6e74 6174 696f 6e29 2077 6974  egmentation) wit
+000001e0: 6820 6f75 7470 7574 2069 6e20 5041 4745  h output in PAGE
+000001f0: 2d58 4d4c 0a22 2222 0a0a 696d 706f 7274  -XML."""..import
+00000200: 206d 6174 680a 696d 706f 7274 206f 730a   math.import os.
+00000210: 696d 706f 7274 2073 7973 0a69 6d70 6f72  import sys.impor
+00000220: 7420 7469 6d65 0a69 6d70 6f72 7420 7761  t time.import wa
+00000230: 726e 696e 6773 0a66 726f 6d20 7061 7468  rnings.from path
+00000240: 6c69 6220 696d 706f 7274 2050 6174 680a  lib import Path.
+00000250: 6672 6f6d 206d 756c 7469 7072 6f63 6573  from multiproces
+00000260: 7369 6e67 2069 6d70 6f72 7420 5072 6f63  sing import Proc
+00000270: 6573 732c 2051 7565 7565 2c20 6370 755f  ess, Queue, cpu_
+00000280: 636f 756e 740a 696d 706f 7274 2067 630a  count.import gc.
+00000290: 6672 6f6d 206f 6372 645f 7574 696c 7320  from ocrd_utils 
+000002a0: 696d 706f 7274 2067 6574 4c6f 6767 6572  import getLogger
+000002b0: 0a69 6d70 6f72 7420 6376 320a 696d 706f  .import cv2.impo
+000002c0: 7274 206e 756d 7079 2061 7320 6e70 0a6f  rt numpy as np.o
+000002d0: 732e 656e 7669 726f 6e5b 2254 465f 4350  s.environ["TF_CP
+000002e0: 505f 4d49 4e5f 4c4f 475f 4c45 5645 4c22  P_MIN_LOG_LEVEL"
+000002f0: 5d20 3d20 2233 220a 7374 6465 7272 203d  ] = "3".stderr =
+00000300: 2073 7973 2e73 7464 6572 720a 7379 732e   sys.stderr.sys.
+00000310: 7374 6465 7272 203d 206f 7065 6e28 6f73  stderr = open(os
+00000320: 2e64 6576 6e75 6c6c 2c20 2277 2229 0a69  .devnull, "w").i
+00000330: 6d70 6f72 7420 7465 6e73 6f72 666c 6f77  mport tensorflow
+00000340: 2061 7320 7466 0a66 726f 6d20 7465 6e73   as tf.from tens
+00000350: 6f72 666c 6f77 2e70 7974 686f 6e2e 6b65  orflow.python.ke
+00000360: 7261 7320 696d 706f 7274 2062 6163 6b65  ras import backe
+00000370: 6e64 2061 7320 4b0a 6672 6f6d 2074 656e  nd as K.from ten
+00000380: 736f 7266 6c6f 772e 6b65 7261 732e 6d6f  sorflow.keras.mo
+00000390: 6465 6c73 2069 6d70 6f72 7420 6c6f 6164  dels import load
+000003a0: 5f6d 6f64 656c 0a73 7973 2e73 7464 6572  _model.sys.stder
+000003b0: 7220 3d20 7374 6465 7272 0a74 662e 6765  r = stderr.tf.ge
+000003c0: 745f 6c6f 6767 6572 2829 2e73 6574 4c65  t_logger().setLe
+000003d0: 7665 6c28 2245 5252 4f52 2229 0a77 6172  vel("ERROR").war
+000003e0: 6e69 6e67 732e 6669 6c74 6572 7761 726e  nings.filterwarn
+000003f0: 696e 6773 2822 6967 6e6f 7265 2229 0a66  ings("ignore").f
+00000400: 726f 6d20 7363 6970 792e 7369 676e 616c  rom scipy.signal
+00000410: 2069 6d70 6f72 7420 6669 6e64 5f70 6561   import find_pea
+00000420: 6b73 0a69 6d70 6f72 7420 6d61 7470 6c6f  ks.import matplo
+00000430: 746c 6962 2e70 7970 6c6f 7420 6173 2070  tlib.pyplot as p
+00000440: 6c74 0a66 726f 6d20 7363 6970 792e 6e64  lt.from scipy.nd
+00000450: 696d 6167 6520 696d 706f 7274 2067 6175  image import gau
+00000460: 7373 6961 6e5f 6669 6c74 6572 3164 0a66  ssian_filter1d.f
+00000470: 726f 6d20 6b65 7261 732e 6261 636b 656e  rom keras.backen
+00000480: 6420 696d 706f 7274 2073 6574 5f73 6573  d import set_ses
+00000490: 7369 6f6e 0a66 726f 6d20 7465 6e73 6f72  sion.from tensor
+000004a0: 666c 6f77 2e6b 6572 6173 2069 6d70 6f72  flow.keras impor
+000004b0: 7420 6c61 7965 7273 0a0a 6672 6f6d 202e  t layers..from .
+000004c0: 7574 696c 732e 636f 6e74 6f75 7220 696d  utils.contour im
+000004d0: 706f 7274 2028 0a20 2020 2066 696c 7465  port (.    filte
+000004e0: 725f 636f 6e74 6f75 7273 5f61 7265 615f  r_contours_area_
+000004f0: 6f66 5f69 6d61 6765 2c0a 2020 2020 6669  of_image,.    fi
+00000500: 6c74 6572 5f63 6f6e 746f 7572 735f 6172  lter_contours_ar
+00000510: 6561 5f6f 665f 696d 6167 655f 7461 626c  ea_of_image_tabl
+00000520: 6573 2c0a 2020 2020 6669 6e64 5f63 6f6e  es,.    find_con
+00000530: 746f 7572 735f 6d65 616e 5f79 5f64 6966  tours_mean_y_dif
+00000540: 662c 0a20 2020 2066 696e 645f 6e65 775f  f,.    find_new_
+00000550: 6665 6174 7572 6573 5f6f 665f 636f 6e74  features_of_cont
+00000560: 6f75 7273 2c0a 2020 2020 6669 6e64 5f66  ours,.    find_f
+00000570: 6561 7475 7265 735f 6f66 5f63 6f6e 746f  eatures_of_conto
+00000580: 7572 732c 0a20 2020 2067 6574 5f74 6578  urs,.    get_tex
+00000590: 745f 7265 6769 6f6e 5f62 6f78 6573 5f62  t_region_boxes_b
+000005a0: 795f 6769 7665 6e5f 636f 6e74 6f75 7273  y_given_contours
+000005b0: 2c0a 2020 2020 6765 745f 7465 7874 7265  ,.    get_textre
+000005c0: 6769 6f6e 5f63 6f6e 746f 7572 735f 696e  gion_contours_in
+000005d0: 5f6f 7267 5f69 6d61 6765 2c0a 2020 2020  _org_image,.    
+000005e0: 6765 745f 7465 7874 7265 6769 6f6e 5f63  get_textregion_c
+000005f0: 6f6e 746f 7572 735f 696e 5f6f 7267 5f69  ontours_in_org_i
+00000600: 6d61 6765 5f6c 6967 6874 2c0a 2020 2020  mage_light,.    
+00000610: 7265 7475 726e 5f63 6f6e 746f 7572 735f  return_contours_
+00000620: 6f66 5f69 6d61 6765 2c0a 2020 2020 7265  of_image,.    re
+00000630: 7475 726e 5f63 6f6e 746f 7572 735f 6f66  turn_contours_of
+00000640: 5f69 6e74 6572 6573 7465 645f 7265 6769  _interested_regi
+00000650: 6f6e 2c0a 2020 2020 7265 7475 726e 5f63  on,.    return_c
+00000660: 6f6e 746f 7572 735f 6f66 5f69 6e74 6572  ontours_of_inter
+00000670: 6573 7465 645f 7265 6769 6f6e 5f62 795f  ested_region_by_
+00000680: 6d69 6e5f 7369 7a65 2c0a 2020 2020 7265  min_size,.    re
+00000690: 7475 726e 5f63 6f6e 746f 7572 735f 6f66  turn_contours_of
+000006a0: 5f69 6e74 6572 6573 7465 645f 7465 7874  _interested_text
+000006b0: 6c69 6e65 2c0a 2020 2020 7265 7475 726e  line,.    return
+000006c0: 5f70 6172 656e 745f 636f 6e74 6f75 7273  _parent_contours
+000006d0: 2c0a 290a 6672 6f6d 202e 7574 696c 732e  ,.).from .utils.
+000006e0: 726f 7461 7465 2069 6d70 6f72 7420 280a  rotate import (.
+000006f0: 2020 2020 726f 7461 7465 5f69 6d61 6765      rotate_image
+00000700: 2c0a 2020 2020 726f 7461 7469 6f6e 5f6e  ,.    rotation_n
+00000710: 6f74 5f39 305f 6675 6e63 2c0a 2020 2020  ot_90_func,.    
+00000720: 726f 7461 7469 6f6e 5f6e 6f74 5f39 305f  rotation_not_90_
+00000730: 6675 6e63 5f66 756c 6c5f 6c61 796f 7574  func_full_layout
+00000740: 290a 6672 6f6d 202e 7574 696c 732e 7365  ).from .utils.se
+00000750: 7061 7261 7465 5f6c 696e 6573 2069 6d70  parate_lines imp
+00000760: 6f72 7420 280a 2020 2020 7465 7874 6c69  ort (.    textli
+00000770: 6e65 5f63 6f6e 746f 7572 735f 706f 7374  ne_contours_post
+00000780: 7072 6f63 6573 7369 6e67 2c0a 2020 2020  processing,.    
+00000790: 7365 7061 7261 7465 5f6c 696e 6573 5f6e  separate_lines_n
+000007a0: 6577 322c 0a20 2020 2072 6574 7572 6e5f  ew2,.    return_
+000007b0: 6465 736b 6577 5f73 6c6f 7029 0a66 726f  deskew_slop).fro
+000007c0: 6d20 2e75 7469 6c73 2e64 726f 705f 6361  m .utils.drop_ca
+000007d0: 7069 7461 6c73 2069 6d70 6f72 7420 280a  pitals import (.
+000007e0: 2020 2020 6164 6865 7265 5f64 726f 705f      adhere_drop_
+000007f0: 6361 7069 7461 6c5f 7265 6769 6f6e 5f69  capital_region_i
+00000800: 6e74 6f5f 636f 7272 6573 706f 6e64 696e  nto_correspondin
+00000810: 675f 7465 7874 6c69 6e65 2c0a 2020 2020  g_textline,.    
+00000820: 6669 6c74 6572 5f73 6d61 6c6c 5f64 726f  filter_small_dro
+00000830: 705f 6361 7069 7461 6c73 5f66 726f 6d5f  p_capitals_from_
+00000840: 6e6f 5f70 6174 6368 5f6c 6179 6f75 7429  no_patch_layout)
+00000850: 0a66 726f 6d20 2e75 7469 6c73 2e6d 6172  .from .utils.mar
+00000860: 6769 6e61 6c73 2069 6d70 6f72 7420 6765  ginals import ge
+00000870: 745f 6d61 7267 696e 616c 730a 6672 6f6d  t_marginals.from
+00000880: 202e 7574 696c 732e 7265 7369 7a65 2069   .utils.resize i
+00000890: 6d70 6f72 7420 7265 7369 7a65 5f69 6d61  mport resize_ima
+000008a0: 6765 0a66 726f 6d20 2e75 7469 6c73 2069  ge.from .utils i
+000008b0: 6d70 6f72 7420 280a 2020 2020 626f 6f73  mport (.    boos
+000008c0: 7469 6e67 5f68 6561 6465 7273 5f62 795f  ting_headers_by_
+000008d0: 6c6f 6e67 7368 6f74 5f72 6567 696f 6e5f  longshot_region_
+000008e0: 7365 676d 656e 7461 7469 6f6e 2c0a 2020  segmentation,.  
+000008f0: 2020 6372 6f70 5f69 6d61 6765 5f69 6e73    crop_image_ins
+00000900: 6964 655f 626f 782c 0a20 2020 2066 696e  ide_box,.    fin
+00000910: 645f 6e75 6d5f 636f 6c2c 0a20 2020 206f  d_num_col,.    o
+00000920: 7473 755f 636f 7079 5f62 696e 6172 792c  tsu_copy_binary,
+00000930: 0a20 2020 2070 7574 5f64 726f 705f 6f75  .    put_drop_ou
+00000940: 745f 6672 6f6d 5f6f 6e6c 795f 6472 6f70  t_from_only_drop
+00000950: 5f6d 6f64 656c 2c0a 2020 2020 7075 7474  _model,.    putt
+00000960: 5f62 625f 6f66 5f64 726f 705f 6361 7069  _bb_of_drop_capi
+00000970: 7461 6c73 5f6f 665f 6d6f 6465 6c5f 696e  tals_of_model_in
+00000980: 5f70 6174 6368 6573 5f69 6e5f 6c61 796f  _patches_in_layo
+00000990: 7574 2c0a 2020 2020 6368 6563 6b5f 616e  ut,.    check_an
+000009a0: 795f 7465 7874 5f72 6567 696f 6e5f 696e  y_text_region_in
+000009b0: 5f6d 6f64 656c 5f6f 6e65 5f69 735f 6d61  _model_one_is_ma
+000009c0: 696e 5f6f 725f 6865 6164 6572 2c0a 2020  in_or_header,.  
+000009d0: 2020 6368 6563 6b5f 616e 795f 7465 7874    check_any_text
+000009e0: 5f72 6567 696f 6e5f 696e 5f6d 6f64 656c  _region_in_model
+000009f0: 5f6f 6e65 5f69 735f 6d61 696e 5f6f 725f  _one_is_main_or_
+00000a00: 6865 6164 6572 5f6c 6967 6874 2c0a 2020  header_light,.  
+00000a10: 2020 736d 616c 6c5f 7465 7874 6c69 6e65    small_textline
+00000a20: 735f 746f 5f70 6172 656e 745f 6164 6865  s_to_parent_adhe
+00000a30: 7265 6e63 6532 2c0a 2020 2020 6f72 6465  rence2,.    orde
+00000a40: 725f 6f66 5f72 6567 696f 6e73 2c0a 2020  r_of_regions,.  
+00000a50: 2020 6669 6e64 5f6e 756d 6265 725f 6f66    find_number_of
+00000a60: 5f63 6f6c 756d 6e73 5f69 6e5f 646f 6375  _columns_in_docu
+00000a70: 6d65 6e74 2c0a 2020 2020 7265 7475 726e  ment,.    return
+00000a80: 5f62 6f78 6573 5f6f 665f 696d 6167 6573  _boxes_of_images
+00000a90: 5f62 795f 6f72 6465 725f 6f66 5f72 6561  _by_order_of_rea
+00000aa0: 6469 6e67 5f6e 6577 290a 6672 6f6d 202e  ding_new).from .
+00000ab0: 7574 696c 732e 7069 6c5f 6376 3220 696d  utils.pil_cv2 im
+00000ac0: 706f 7274 2063 6865 636b 5f64 7069 2c20  port check_dpi, 
+00000ad0: 7069 6c32 6376 0a66 726f 6d20 2e75 7469  pil2cv.from .uti
+00000ae0: 6c73 2e78 6d6c 2069 6d70 6f72 7420 6f72  ls.xml import or
+00000af0: 6465 725f 616e 645f 6964 5f6f 665f 7465  der_and_id_of_te
+00000b00: 7874 730a 6672 6f6d 202e 706c 6f74 2069  xts.from .plot i
+00000b10: 6d70 6f72 7420 4579 6e6f 6c6c 6168 506c  mport EynollahPl
+00000b20: 6f74 7465 720a 6672 6f6d 202e 7772 6974  otter.from .writ
+00000b30: 6572 2069 6d70 6f72 7420 4579 6e6f 6c6c  er import Eynoll
+00000b40: 6168 586d 6c57 7269 7465 720a 0a53 4c4f  ahXmlWriter..SLO
+00000b50: 5045 5f54 4852 4553 484f 4c44 203d 2030  PE_THRESHOLD = 0
+00000b60: 2e31 330a 5241 5449 4f5f 4f46 5f54 574f  .13.RATIO_OF_TWO
+00000b70: 5f4d 4f44 454c 5f54 4852 4553 484f 4c44  _MODEL_THRESHOLD
+00000b80: 203d 2039 352e 3530 2023 3938 2e34 353a   = 95.50 #98.45:
+00000b90: 0a44 5049 5f54 4852 4553 484f 4c44 203d  .DPI_THRESHOLD =
+00000ba0: 2032 3938 0a4d 4158 5f53 4c4f 5045 203d   298.MAX_SLOPE =
+00000bb0: 2039 3939 0a4b 4552 4e45 4c20 3d20 6e70   999.KERNEL = np
+00000bc0: 2e6f 6e65 7328 2835 2c20 3529 2c20 6e70  .ones((5, 5), np
+00000bd0: 2e75 696e 7438 290a 0a70 726f 6a65 6374  .uint8)..project
+00000be0: 696f 6e5f 6469 6d20 3d20 3634 0a70 6174  ion_dim = 64.pat
+00000bf0: 6368 5f73 697a 6520 3d20 310a 6e75 6d5f  ch_size = 1.num_
+00000c00: 7061 7463 6865 7320 3d32 312a 3231 2331  patches =21*21#1
+00000c10: 342a 3134 2332 382a 3238 2331 342a 3134  4*14#28*28#14*14
+00000c20: 2332 382a 3238 0a0a 0a63 6c61 7373 2050  #28*28...class P
+00000c30: 6174 6368 6573 286c 6179 6572 732e 4c61  atches(layers.La
+00000c40: 7965 7229 3a0a 2020 2020 6465 6620 5f5f  yer):.    def __
+00000c50: 696e 6974 5f5f 2873 656c 662c 202a 2a6b  init__(self, **k
+00000c60: 7761 7267 7329 3a0a 2020 2020 2020 2020  wargs):.        
+00000c70: 7375 7065 7228 5061 7463 6865 732c 2073  super(Patches, s
+00000c80: 656c 6629 2e5f 5f69 6e69 745f 5f28 290a  elf).__init__().
+00000c90: 2020 2020 2020 2020 7365 6c66 2e70 6174          self.pat
+00000ca0: 6368 5f73 697a 6520 3d20 7061 7463 685f  ch_size = patch_
+00000cb0: 7369 7a65 0a0a 2020 2020 6465 6620 6361  size..    def ca
+00000cc0: 6c6c 2873 656c 662c 2069 6d61 6765 7329  ll(self, images)
+00000cd0: 3a0a 2020 2020 2020 2020 6261 7463 685f  :.        batch_
+00000ce0: 7369 7a65 203d 2074 662e 7368 6170 6528  size = tf.shape(
+00000cf0: 696d 6167 6573 295b 305d 0a20 2020 2020  images)[0].     
+00000d00: 2020 2070 6174 6368 6573 203d 2074 662e     patches = tf.
+00000d10: 696d 6167 652e 6578 7472 6163 745f 7061  image.extract_pa
+00000d20: 7463 6865 7328 0a20 2020 2020 2020 2020  tches(.         
+00000d30: 2020 2069 6d61 6765 733d 696d 6167 6573     images=images
+00000d40: 2c0a 2020 2020 2020 2020 2020 2020 7369  ,.            si
+00000d50: 7a65 733d 5b31 2c20 7365 6c66 2e70 6174  zes=[1, self.pat
+00000d60: 6368 5f73 697a 652c 2073 656c 662e 7061  ch_size, self.pa
+00000d70: 7463 685f 7369 7a65 2c20 315d 2c0a 2020  tch_size, 1],.  
+00000d80: 2020 2020 2020 2020 2020 7374 7269 6465            stride
+00000d90: 733d 5b31 2c20 7365 6c66 2e70 6174 6368  s=[1, self.patch
+00000da0: 5f73 697a 652c 2073 656c 662e 7061 7463  _size, self.patc
+00000db0: 685f 7369 7a65 2c20 315d 2c0a 2020 2020  h_size, 1],.    
+00000dc0: 2020 2020 2020 2020 7261 7465 733d 5b31          rates=[1
+00000dd0: 2c20 312c 2031 2c20 315d 2c0a 2020 2020  , 1, 1, 1],.    
+00000de0: 2020 2020 2020 2020 7061 6464 696e 673d          padding=
+00000df0: 2256 414c 4944 222c 0a20 2020 2020 2020  "VALID",.       
+00000e00: 2029 0a20 2020 2020 2020 2070 6174 6368   ).        patch
+00000e10: 5f64 696d 7320 3d20 7061 7463 6865 732e  _dims = patches.
+00000e20: 7368 6170 655b 2d31 5d0a 2020 2020 2020  shape[-1].      
+00000e30: 2020 7061 7463 6865 7320 3d20 7466 2e72    patches = tf.r
+00000e40: 6573 6861 7065 2870 6174 6368 6573 2c20  eshape(patches, 
+00000e50: 5b62 6174 6368 5f73 697a 652c 202d 312c  [batch_size, -1,
+00000e60: 2070 6174 6368 5f64 696d 735d 290a 2020   patch_dims]).  
+00000e70: 2020 2020 2020 7265 7475 726e 2070 6174        return pat
+00000e80: 6368 6573 0a20 2020 2064 6566 2067 6574  ches.    def get
+00000e90: 5f63 6f6e 6669 6728 7365 6c66 293a 0a0a  _config(self):..
+00000ea0: 2020 2020 2020 2020 636f 6e66 6967 203d          config =
+00000eb0: 2073 7570 6572 2829 2e67 6574 5f63 6f6e   super().get_con
+00000ec0: 6669 6728 292e 636f 7079 2829 0a20 2020  fig().copy().   
+00000ed0: 2020 2020 2063 6f6e 6669 672e 7570 6461       config.upda
+00000ee0: 7465 287b 0a20 2020 2020 2020 2020 2020  te({.           
+00000ef0: 2027 7061 7463 685f 7369 7a65 273a 2073   'patch_size': s
+00000f00: 656c 662e 7061 7463 685f 7369 7a65 2c0a  elf.patch_size,.
+00000f10: 2020 2020 2020 2020 7d29 0a20 2020 2020          }).     
+00000f20: 2020 2072 6574 7572 6e20 636f 6e66 6967     return config
+00000f30: 0a20 2020 200a 2020 2020 0a63 6c61 7373  .    .    .class
+00000f40: 2050 6174 6368 456e 636f 6465 7228 6c61   PatchEncoder(la
+00000f50: 7965 7273 2e4c 6179 6572 293a 0a20 2020  yers.Layer):.   
+00000f60: 2064 6566 205f 5f69 6e69 745f 5f28 7365   def __init__(se
+00000f70: 6c66 2c20 2a2a 6b77 6172 6773 293a 0a20  lf, **kwargs):. 
+00000f80: 2020 2020 2020 2073 7570 6572 2850 6174         super(Pat
+00000f90: 6368 456e 636f 6465 722c 2073 656c 6629  chEncoder, self)
+00000fa0: 2e5f 5f69 6e69 745f 5f28 290a 2020 2020  .__init__().    
+00000fb0: 2020 2020 7365 6c66 2e6e 756d 5f70 6174      self.num_pat
+00000fc0: 6368 6573 203d 206e 756d 5f70 6174 6368  ches = num_patch
+00000fd0: 6573 0a20 2020 2020 2020 2073 656c 662e  es.        self.
+00000fe0: 7072 6f6a 6563 7469 6f6e 203d 206c 6179  projection = lay
+00000ff0: 6572 732e 4465 6e73 6528 756e 6974 733d  ers.Dense(units=
+00001000: 7072 6f6a 6563 7469 6f6e 5f64 696d 290a  projection_dim).
+00001010: 2020 2020 2020 2020 7365 6c66 2e70 6f73          self.pos
+00001020: 6974 696f 6e5f 656d 6265 6464 696e 6720  ition_embedding 
+00001030: 3d20 6c61 7965 7273 2e45 6d62 6564 6469  = layers.Embeddi
+00001040: 6e67 280a 2020 2020 2020 2020 2020 2020  ng(.            
+00001050: 696e 7075 745f 6469 6d3d 6e75 6d5f 7061  input_dim=num_pa
+00001060: 7463 6865 732c 206f 7574 7075 745f 6469  tches, output_di
+00001070: 6d3d 7072 6f6a 6563 7469 6f6e 5f64 696d  m=projection_dim
+00001080: 0a20 2020 2020 2020 2029 0a0a 2020 2020  .        )..    
+00001090: 6465 6620 6361 6c6c 2873 656c 662c 2070  def call(self, p
+000010a0: 6174 6368 293a 0a20 2020 2020 2020 2070  atch):.        p
+000010b0: 6f73 6974 696f 6e73 203d 2074 662e 7261  ositions = tf.ra
+000010c0: 6e67 6528 7374 6172 743d 302c 206c 696d  nge(start=0, lim
+000010d0: 6974 3d73 656c 662e 6e75 6d5f 7061 7463  it=self.num_patc
+000010e0: 6865 732c 2064 656c 7461 3d31 290a 2020  hes, delta=1).  
+000010f0: 2020 2020 2020 656e 636f 6465 6420 3d20        encoded = 
+00001100: 7365 6c66 2e70 726f 6a65 6374 696f 6e28  self.projection(
+00001110: 7061 7463 6829 202b 2073 656c 662e 706f  patch) + self.po
+00001120: 7369 7469 6f6e 5f65 6d62 6564 6469 6e67  sition_embedding
+00001130: 2870 6f73 6974 696f 6e73 290a 2020 2020  (positions).    
+00001140: 2020 2020 7265 7475 726e 2065 6e63 6f64      return encod
+00001150: 6564 0a20 2020 2064 6566 2067 6574 5f63  ed.    def get_c
+00001160: 6f6e 6669 6728 7365 6c66 293a 0a0a 2020  onfig(self):..  
+00001170: 2020 2020 2020 636f 6e66 6967 203d 2073        config = s
+00001180: 7570 6572 2829 2e67 6574 5f63 6f6e 6669  uper().get_confi
+00001190: 6728 292e 636f 7079 2829 0a20 2020 2020  g().copy().     
+000011a0: 2020 2063 6f6e 6669 672e 7570 6461 7465     config.update
+000011b0: 287b 0a20 2020 2020 2020 2020 2020 2027  ({.            '
+000011c0: 6e75 6d5f 7061 7463 6865 7327 3a20 7365  num_patches': se
+000011d0: 6c66 2e6e 756d 5f70 6174 6368 6573 2c0a  lf.num_patches,.
+000011e0: 2020 2020 2020 2020 2020 2020 2770 726f              'pro
+000011f0: 6a65 6374 696f 6e27 3a20 7365 6c66 2e70  jection': self.p
+00001200: 726f 6a65 6374 696f 6e2c 0a20 2020 2020  rojection,.     
+00001210: 2020 2020 2020 2027 706f 7369 7469 6f6e         'position
+00001220: 5f65 6d62 6564 6469 6e67 273a 2073 656c  _embedding': sel
+00001230: 662e 706f 7369 7469 6f6e 5f65 6d62 6564  f.position_embed
+00001240: 6469 6e67 2c0a 2020 2020 2020 2020 7d29  ding,.        })
+00001250: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00001260: 636f 6e66 6967 0a0a 636c 6173 7320 4579  config..class Ey
+00001270: 6e6f 6c6c 6168 3a0a 2020 2020 6465 6620  nollah:.    def 
+00001280: 5f5f 696e 6974 5f5f 280a 2020 2020 2020  __init__(.      
+00001290: 2020 7365 6c66 2c0a 2020 2020 2020 2020    self,.        
+000012a0: 6469 725f 6d6f 6465 6c73 2c0a 2020 2020  dir_models,.    
+000012b0: 2020 2020 696d 6167 655f 6669 6c65 6e61      image_filena
+000012c0: 6d65 3d4e 6f6e 652c 0a20 2020 2020 2020  me=None,.       
+000012d0: 2069 6d61 6765 5f70 696c 3d4e 6f6e 652c   image_pil=None,
+000012e0: 0a20 2020 2020 2020 2069 6d61 6765 5f66  .        image_f
+000012f0: 696c 656e 616d 655f 7374 656d 3d4e 6f6e  ilename_stem=Non
+00001300: 652c 0a20 2020 2020 2020 2064 6972 5f6f  e,.        dir_o
+00001310: 7574 3d4e 6f6e 652c 0a20 2020 2020 2020  ut=None,.       
+00001320: 2064 6972 5f69 6e3d 4e6f 6e65 2c0a 2020   dir_in=None,.  
+00001330: 2020 2020 2020 6469 725f 6f66 5f63 726f        dir_of_cro
+00001340: 7070 6564 5f69 6d61 6765 733d 4e6f 6e65  pped_images=None
+00001350: 2c0a 2020 2020 2020 2020 6469 725f 6f66  ,.        dir_of
+00001360: 5f6c 6179 6f75 743d 4e6f 6e65 2c0a 2020  _layout=None,.  
+00001370: 2020 2020 2020 6469 725f 6f66 5f64 6573        dir_of_des
+00001380: 6b65 7765 643d 4e6f 6e65 2c0a 2020 2020  kewed=None,.    
+00001390: 2020 2020 6469 725f 6f66 5f61 6c6c 3d4e      dir_of_all=N
+000013a0: 6f6e 652c 0a20 2020 2020 2020 2064 6972  one,.        dir
+000013b0: 5f73 6176 655f 7061 6765 3d4e 6f6e 652c  _save_page=None,
+000013c0: 0a20 2020 2020 2020 2065 6e61 626c 655f  .        enable_
+000013d0: 706c 6f74 7469 6e67 3d46 616c 7365 2c0a  plotting=False,.
+000013e0: 2020 2020 2020 2020 616c 6c6f 775f 656e          allow_en
+000013f0: 6861 6e63 656d 656e 743d 4661 6c73 652c  hancement=False,
+00001400: 0a20 2020 2020 2020 2063 7572 7665 645f  .        curved_
+00001410: 6c69 6e65 3d46 616c 7365 2c0a 2020 2020  line=False,.    
+00001420: 2020 2020 7465 7874 6c69 6e65 5f6c 6967      textline_lig
+00001430: 6874 3d46 616c 7365 2c0a 2020 2020 2020  ht=False,.      
+00001440: 2020 6675 6c6c 5f6c 6179 6f75 743d 4661    full_layout=Fa
+00001450: 6c73 652c 0a20 2020 2020 2020 2074 6162  lse,.        tab
+00001460: 6c65 733d 4661 6c73 652c 0a20 2020 2020  les=False,.     
+00001470: 2020 2069 6e70 7574 5f62 696e 6172 793d     input_binary=
+00001480: 4661 6c73 652c 0a20 2020 2020 2020 2061  False,.        a
+00001490: 6c6c 6f77 5f73 6361 6c69 6e67 3d46 616c  llow_scaling=Fal
+000014a0: 7365 2c0a 2020 2020 2020 2020 6865 6164  se,.        head
+000014b0: 6572 735f 6f66 663d 4661 6c73 652c 0a20  ers_off=False,. 
+000014c0: 2020 2020 2020 206c 6967 6874 5f76 6572         light_ver
+000014d0: 7369 6f6e 3d46 616c 7365 2c0a 2020 2020  sion=False,.    
+000014e0: 2020 2020 6967 6e6f 7265 5f70 6167 655f      ignore_page_
+000014f0: 6578 7472 6163 7469 6f6e 3d46 616c 7365  extraction=False
+00001500: 2c0a 2020 2020 2020 2020 6f76 6572 7269  ,.        overri
+00001510: 6465 5f64 7069 3d4e 6f6e 652c 0a20 2020  de_dpi=None,.   
+00001520: 2020 2020 206c 6f67 6765 723d 4e6f 6e65       logger=None
+00001530: 2c0a 2020 2020 2020 2020 7063 6774 733d  ,.        pcgts=
+00001540: 4e6f 6e65 2c0a 2020 2020 293a 0a20 2020  None,.    ):.   
+00001550: 2020 2020 2069 6620 6e6f 7420 6469 725f       if not dir_
+00001560: 696e 3a0a 2020 2020 2020 2020 2020 2020  in:.            
+00001570: 6966 2069 6d61 6765 5f70 696c 3a0a 2020  if image_pil:.  
+00001580: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00001590: 6c66 2e5f 696d 6773 203d 2073 656c 662e  lf._imgs = self.
+000015a0: 5f63 6163 6865 5f69 6d61 6765 7328 696d  _cache_images(im
+000015b0: 6167 655f 7069 6c3d 696d 6167 655f 7069  age_pil=image_pi
+000015c0: 6c29 0a20 2020 2020 2020 2020 2020 2065  l).            e
+000015d0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+000015e0: 2020 2020 2073 656c 662e 5f69 6d67 7320       self._imgs 
+000015f0: 3d20 7365 6c66 2e5f 6361 6368 655f 696d  = self._cache_im
+00001600: 6167 6573 2869 6d61 6765 5f66 696c 656e  ages(image_filen
+00001610: 616d 653d 696d 6167 655f 6669 6c65 6e61  ame=image_filena
+00001620: 6d65 290a 2020 2020 2020 2020 2020 2020  me).            
+00001630: 6966 206f 7665 7272 6964 655f 6470 693a  if override_dpi:
+00001640: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00001650: 2073 656c 662e 6470 6920 3d20 6f76 6572   self.dpi = over
+00001660: 7269 6465 5f64 7069 0a20 2020 2020 2020  ride_dpi.       
+00001670: 2020 2020 2073 656c 662e 696d 6167 655f       self.image_
+00001680: 6669 6c65 6e61 6d65 203d 2069 6d61 6765  filename = image
+00001690: 5f66 696c 656e 616d 650a 2020 2020 2020  _filename.      
+000016a0: 2020 7365 6c66 2e64 6972 5f6f 7574 203d    self.dir_out =
+000016b0: 2064 6972 5f6f 7574 0a20 2020 2020 2020   dir_out.       
+000016c0: 2073 656c 662e 6469 725f 696e 203d 2064   self.dir_in = d
+000016d0: 6972 5f69 6e0a 2020 2020 2020 2020 7365  ir_in.        se
+000016e0: 6c66 2e64 6972 5f6f 665f 616c 6c20 3d20  lf.dir_of_all = 
+000016f0: 6469 725f 6f66 5f61 6c6c 0a20 2020 2020  dir_of_all.     
+00001700: 2020 2073 656c 662e 6469 725f 7361 7665     self.dir_save
+00001710: 5f70 6167 6520 3d20 6469 725f 7361 7665  _page = dir_save
+00001720: 5f70 6167 650a 2020 2020 2020 2020 7365  _page.        se
+00001730: 6c66 2e64 6972 5f6f 665f 6465 736b 6577  lf.dir_of_deskew
+00001740: 6564 203d 2064 6972 5f6f 665f 6465 736b  ed = dir_of_desk
+00001750: 6577 6564 0a20 2020 2020 2020 2073 656c  ewed.        sel
+00001760: 662e 6469 725f 6f66 5f64 6573 6b65 7765  f.dir_of_deskewe
+00001770: 6420 3d20 2064 6972 5f6f 665f 6465 736b  d =  dir_of_desk
+00001780: 6577 6564 0a20 2020 2020 2020 2073 656c  ewed.        sel
+00001790: 662e 6469 725f 6f66 5f63 726f 7070 6564  f.dir_of_cropped
+000017a0: 5f69 6d61 6765 733d 6469 725f 6f66 5f63  _images=dir_of_c
+000017b0: 726f 7070 6564 5f69 6d61 6765 730a 2020  ropped_images.  
+000017c0: 2020 2020 2020 7365 6c66 2e64 6972 5f6f        self.dir_o
+000017d0: 665f 6c61 796f 7574 3d64 6972 5f6f 665f  f_layout=dir_of_
+000017e0: 6c61 796f 7574 0a20 2020 2020 2020 2073  layout.        s
+000017f0: 656c 662e 656e 6162 6c65 5f70 6c6f 7474  elf.enable_plott
+00001800: 696e 6720 3d20 656e 6162 6c65 5f70 6c6f  ing = enable_plo
+00001810: 7474 696e 670a 2020 2020 2020 2020 7365  tting.        se
+00001820: 6c66 2e61 6c6c 6f77 5f65 6e68 616e 6365  lf.allow_enhance
+00001830: 6d65 6e74 203d 2061 6c6c 6f77 5f65 6e68  ment = allow_enh
+00001840: 616e 6365 6d65 6e74 0a20 2020 2020 2020  ancement.       
+00001850: 2073 656c 662e 6375 7276 6564 5f6c 696e   self.curved_lin
+00001860: 6520 3d20 6375 7276 6564 5f6c 696e 650a  e = curved_line.
+00001870: 2020 2020 2020 2020 7365 6c66 2e74 6578          self.tex
+00001880: 746c 696e 655f 6c69 6768 7420 3d20 7465  tline_light = te
+00001890: 7874 6c69 6e65 5f6c 6967 6874 0a20 2020  xtline_light.   
+000018a0: 2020 2020 2073 656c 662e 6675 6c6c 5f6c       self.full_l
+000018b0: 6179 6f75 7420 3d20 6675 6c6c 5f6c 6179  ayout = full_lay
+000018c0: 6f75 740a 2020 2020 2020 2020 7365 6c66  out.        self
+000018d0: 2e74 6162 6c65 7320 3d20 7461 626c 6573  .tables = tables
+000018e0: 0a20 2020 2020 2020 2073 656c 662e 696e  .        self.in
+000018f0: 7075 745f 6269 6e61 7279 203d 2069 6e70  put_binary = inp
+00001900: 7574 5f62 696e 6172 790a 2020 2020 2020  ut_binary.      
+00001910: 2020 7365 6c66 2e61 6c6c 6f77 5f73 6361    self.allow_sca
+00001920: 6c69 6e67 203d 2061 6c6c 6f77 5f73 6361  ling = allow_sca
+00001930: 6c69 6e67 0a20 2020 2020 2020 2073 656c  ling.        sel
+00001940: 662e 6865 6164 6572 735f 6f66 6620 3d20  f.headers_off = 
+00001950: 6865 6164 6572 735f 6f66 660a 2020 2020  headers_off.    
+00001960: 2020 2020 7365 6c66 2e6c 6967 6874 5f76      self.light_v
+00001970: 6572 7369 6f6e 203d 206c 6967 6874 5f76  ersion = light_v
+00001980: 6572 7369 6f6e 0a20 2020 2020 2020 2073  ersion.        s
+00001990: 656c 662e 6967 6e6f 7265 5f70 6167 655f  elf.ignore_page_
+000019a0: 6578 7472 6163 7469 6f6e 203d 2069 676e  extraction = ign
+000019b0: 6f72 655f 7061 6765 5f65 7874 7261 6374  ore_page_extract
+000019c0: 696f 6e0a 2020 2020 2020 2020 7365 6c66  ion.        self
+000019d0: 2e70 6367 7473 203d 2070 6367 7473 0a20  .pcgts = pcgts. 
+000019e0: 2020 2020 2020 2069 6620 6e6f 7420 6469         if not di
+000019f0: 725f 696e 3a0a 2020 2020 2020 2020 2020  r_in:.          
+00001a00: 2020 7365 6c66 2e70 6c6f 7474 6572 203d    self.plotter =
+00001a10: 204e 6f6e 6520 6966 206e 6f74 2065 6e61   None if not ena
+00001a20: 626c 655f 706c 6f74 7469 6e67 2065 6c73  ble_plotting els
+00001a30: 6520 4579 6e6f 6c6c 6168 506c 6f74 7465  e EynollahPlotte
+00001a40: 7228 0a20 2020 2020 2020 2020 2020 2020  r(.             
+00001a50: 2020 2064 6972 5f6f 7574 3d73 656c 662e     dir_out=self.
+00001a60: 6469 725f 6f75 742c 0a20 2020 2020 2020  dir_out,.       
+00001a70: 2020 2020 2020 2020 2064 6972 5f6f 665f           dir_of_
+00001a80: 616c 6c3d 6469 725f 6f66 5f61 6c6c 2c0a  all=dir_of_all,.
+00001a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00001aa0: 6469 725f 7361 7665 5f70 6167 653d 6469  dir_save_page=di
+00001ab0: 725f 7361 7665 5f70 6167 652c 0a20 2020  r_save_page,.   
+00001ac0: 2020 2020 2020 2020 2020 2020 2064 6972               dir
+00001ad0: 5f6f 665f 6465 736b 6577 6564 3d64 6972  _of_deskewed=dir
+00001ae0: 5f6f 665f 6465 736b 6577 6564 2c0a 2020  _of_deskewed,.  
+00001af0: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00001b00: 725f 6f66 5f63 726f 7070 6564 5f69 6d61  r_of_cropped_ima
+00001b10: 6765 733d 6469 725f 6f66 5f63 726f 7070  ges=dir_of_cropp
+00001b20: 6564 5f69 6d61 6765 732c 0a20 2020 2020  ed_images,.     
+00001b30: 2020 2020 2020 2020 2020 2064 6972 5f6f             dir_o
+00001b40: 665f 6c61 796f 7574 3d64 6972 5f6f 665f  f_layout=dir_of_
+00001b50: 6c61 796f 7574 2c0a 2020 2020 2020 2020  layout,.        
+00001b60: 2020 2020 2020 2020 696d 6167 655f 6669          image_fi
+00001b70: 6c65 6e61 6d65 5f73 7465 6d3d 5061 7468  lename_stem=Path
+00001b80: 2850 6174 6828 696d 6167 655f 6669 6c65  (Path(image_file
+00001b90: 6e61 6d65 292e 6e61 6d65 292e 7374 656d  name).name).stem
+00001ba0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00001bb0: 6c66 2e77 7269 7465 7220 3d20 4579 6e6f  lf.writer = Eyno
+00001bc0: 6c6c 6168 586d 6c57 7269 7465 7228 0a20  llahXmlWriter(. 
+00001bd0: 2020 2020 2020 2020 2020 2020 2020 2064                 d
+00001be0: 6972 5f6f 7574 3d73 656c 662e 6469 725f  ir_out=self.dir_
+00001bf0: 6f75 742c 0a20 2020 2020 2020 2020 2020  out,.           
+00001c00: 2020 2020 2069 6d61 6765 5f66 696c 656e       image_filen
+00001c10: 616d 653d 7365 6c66 2e69 6d61 6765 5f66  ame=self.image_f
+00001c20: 696c 656e 616d 652c 0a20 2020 2020 2020  ilename,.       
+00001c30: 2020 2020 2020 2020 2063 7572 7665 645f           curved_
+00001c40: 6c69 6e65 3d73 656c 662e 6375 7276 6564  line=self.curved
+00001c50: 5f6c 696e 652c 0a20 2020 2020 2020 2020  _line,.         
+00001c60: 2020 2020 2020 2074 6578 746c 696e 655f         textline_
+00001c70: 6c69 6768 7420 3d20 7365 6c66 2e74 6578  light = self.tex
+00001c80: 746c 696e 655f 6c69 6768 742c 0a20 2020  tline_light,.   
+00001c90: 2020 2020 2020 2020 2020 2020 2070 6367               pcg
+00001ca0: 7473 3d70 6367 7473 290a 2020 2020 2020  ts=pcgts).      
+00001cb0: 2020 7365 6c66 2e6c 6f67 6765 7220 3d20    self.logger = 
+00001cc0: 6c6f 6767 6572 2069 6620 6c6f 6767 6572  logger if logger
+00001cd0: 2065 6c73 6520 6765 744c 6f67 6765 7228   else getLogger(
+00001ce0: 2765 796e 6f6c 6c61 6827 290a 2020 2020  'eynollah').    
+00001cf0: 2020 2020 7365 6c66 2e64 6972 5f6d 6f64      self.dir_mod
+00001d00: 656c 7320 3d20 6469 725f 6d6f 6465 6c73  els = dir_models
+00001d10: 0a0a 2020 2020 2020 2020 7365 6c66 2e6d  ..        self.m
+00001d20: 6f64 656c 5f64 6972 5f6f 665f 656e 6861  odel_dir_of_enha
+00001d30: 6e63 656d 656e 7420 3d20 6469 725f 6d6f  ncement = dir_mo
+00001d40: 6465 6c73 202b 2022 2f65 796e 6f6c 6c61  dels + "/eynolla
+00001d50: 682d 656e 6861 6e63 656d 656e 745f 3230  h-enhancement_20
+00001d60: 3231 3034 3235 220a 2020 2020 2020 2020  210425".        
+00001d70: 7365 6c66 2e6d 6f64 656c 5f64 6972 5f6f  self.model_dir_o
+00001d80: 665f 6269 6e61 7269 7a61 7469 6f6e 203d  f_binarization =
+00001d90: 2064 6972 5f6d 6f64 656c 7320 2b20 222f   dir_models + "/
+00001da0: 6579 6e6f 6c6c 6168 2d62 696e 6172 697a  eynollah-binariz
+00001db0: 6174 696f 6e5f 3230 3231 3034 3235 220a  ation_20210425".
+00001dc0: 2020 2020 2020 2020 7365 6c66 2e6d 6f64          self.mod
+00001dd0: 656c 5f64 6972 5f6f 665f 636f 6c5f 636c  el_dir_of_col_cl
+00001de0: 6173 7369 6669 6572 203d 2064 6972 5f6d  assifier = dir_m
+00001df0: 6f64 656c 7320 2b20 222f 6579 6e6f 6c6c  odels + "/eynoll
+00001e00: 6168 2d63 6f6c 756d 6e2d 636c 6173 7369  ah-column-classi
+00001e10: 6669 6572 5f32 3032 3130 3432 3522 0a20  fier_20210425". 
+00001e20: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
+00001e30: 6c5f 7265 6769 6f6e 5f64 6972 5f70 203d  l_region_dir_p =
+00001e40: 2064 6972 5f6d 6f64 656c 7320 2b20 222f   dir_models + "/
+00001e50: 6579 6e6f 6c6c 6168 2d6d 6169 6e2d 7265  eynollah-main-re
+00001e60: 6769 6f6e 732d 6175 672d 7363 616c 696e  gions-aug-scalin
+00001e70: 675f 3230 3231 3034 3235 220a 2020 2020  g_20210425".    
+00001e80: 2020 2020 7365 6c66 2e6d 6f64 656c 5f72      self.model_r
+00001e90: 6567 696f 6e5f 6469 725f 7032 203d 2064  egion_dir_p2 = d
+00001ea0: 6972 5f6d 6f64 656c 7320 2b20 222f 6579  ir_models + "/ey
+00001eb0: 6e6f 6c6c 6168 2d6d 6169 6e2d 7265 6769  nollah-main-regi
+00001ec0: 6f6e 732d 6175 672d 726f 7461 7469 6f6e  ons-aug-rotation
+00001ed0: 5f32 3032 3130 3432 3522 0a20 2020 2020  _20210425".     
+00001ee0: 2020 2073 656c 662e 6d6f 6465 6c5f 7265     self.model_re
+00001ef0: 6769 6f6e 5f64 6972 5f66 756c 6c79 5f6e  gion_dir_fully_n
+00001f00: 7020 3d20 6469 725f 6d6f 6465 6c73 202b  p = dir_models +
+00001f10: 2022 2f65 796e 6f6c 6c61 682d 6675 6c6c   "/eynollah-full
+00001f20: 2d72 6567 696f 6e73 2d31 636f 6c75 6d6e  -regions-1column
+00001f30: 5f32 3032 3130 3432 3522 0a20 2020 2020  _20210425".     
+00001f40: 2020 2073 656c 662e 6d6f 6465 6c5f 7265     self.model_re
+00001f50: 6769 6f6e 5f64 6972 5f66 756c 6c79 203d  gion_dir_fully =
+00001f60: 2064 6972 5f6d 6f64 656c 7320 2b20 222f   dir_models + "/
+00001f70: 6579 6e6f 6c6c 6168 2d66 756c 6c2d 7265  eynollah-full-re
+00001f80: 6769 6f6e 732d 332b 636f 6c75 6d6e 5f32  gions-3+column_2
+00001f90: 3032 3130 3432 3522 0a20 2020 2020 2020  0210425".       
+00001fa0: 2073 656c 662e 6d6f 6465 6c5f 7061 6765   self.model_page
+00001fb0: 5f64 6972 203d 2064 6972 5f6d 6f64 656c  _dir = dir_model
+00001fc0: 7320 2b20 222f 6579 6e6f 6c6c 6168 2d70  s + "/eynollah-p
+00001fd0: 6167 652d 6578 7472 6163 7469 6f6e 5f32  age-extraction_2
+00001fe0: 3032 3130 3432 3522 0a20 2020 2020 2020  0210425".       
+00001ff0: 2073 656c 662e 6d6f 6465 6c5f 7265 6769   self.model_regi
+00002000: 6f6e 5f64 6972 5f70 5f65 6e73 203d 2064  on_dir_p_ens = d
+00002010: 6972 5f6d 6f64 656c 7320 2b20 222f 6579  ir_models + "/ey
+00002020: 6e6f 6c6c 6168 2d6d 6169 6e2d 7265 6769  nollah-main-regi
+00002030: 6f6e 732d 656e 7365 6d62 6c65 645f 3230  ons-ensembled_20
+00002040: 3231 3034 3235 220a 2020 2020 2020 2020  210425".        
+00002050: 7365 6c66 2e6d 6f64 656c 5f72 6567 696f  self.model_regio
+00002060: 6e5f 6469 725f 705f 656e 735f 6c69 6768  n_dir_p_ens_ligh
+00002070: 7420 3d20 6469 725f 6d6f 6465 6c73 202b  t = dir_models +
+00002080: 2022 2f65 796e 6f6c 6c61 682d 6d61 696e   "/eynollah-main
+00002090: 2d72 6567 696f 6e73 5f32 3032 3230 3331  -regions_2022031
+000020a0: 3422 0a20 2020 2020 2020 2069 6620 7365  4".        if se
+000020b0: 6c66 2e74 6578 746c 696e 655f 6c69 6768  lf.textline_ligh
+000020c0: 743a 0a20 2020 2020 2020 2020 2020 2073  t:.            s
+000020d0: 656c 662e 6d6f 6465 6c5f 7465 7874 6c69  elf.model_textli
+000020e0: 6e65 5f64 6972 203d 2064 6972 5f6d 6f64  ne_dir = dir_mod
+000020f0: 656c 7320 2b20 222f 6579 6e6f 6c6c 6168  els + "/eynollah
+00002100: 2d74 6578 746c 696e 655f 6c69 6768 745f  -textline_light_
+00002110: 3230 3231 3034 3235 220a 2020 2020 2020  20210425".      
+00002120: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00002130: 2020 2020 7365 6c66 2e6d 6f64 656c 5f74      self.model_t
+00002140: 6578 746c 696e 655f 6469 7220 3d20 6469  extline_dir = di
+00002150: 725f 6d6f 6465 6c73 202b 2022 2f65 796e  r_models + "/eyn
+00002160: 6f6c 6c61 682d 7465 7874 6c69 6e65 5f32  ollah-textline_2
+00002170: 3032 3130 3432 3522 0a20 2020 2020 2020  0210425".       
+00002180: 2073 656c 662e 6d6f 6465 6c5f 7461 626c   self.model_tabl
+00002190: 6573 203d 2064 6972 5f6d 6f64 656c 7320  es = dir_models 
+000021a0: 2b20 222f 6579 6e6f 6c6c 6168 2d74 6162  + "/eynollah-tab
+000021b0: 6c65 735f 3230 3231 3033 3139 220a 2020  les_20210319".  
+000021c0: 2020 2020 2020 0a20 2020 2020 2020 2073        .        s
+000021d0: 656c 662e 6d6f 6465 6c73 203d 207b 7d0a  elf.models = {}.
+000021e0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000021f0: 2069 6620 6469 725f 696e 2061 6e64 206c   if dir_in and l
+00002200: 6967 6874 5f76 6572 7369 6f6e 3a0a 2020  ight_version:.  
+00002210: 2020 2020 2020 2020 2020 636f 6e66 6967            config
+00002220: 203d 2074 662e 636f 6d70 6174 2e76 312e   = tf.compat.v1.
+00002230: 436f 6e66 6967 5072 6f74 6f28 290a 2020  ConfigProto().  
+00002240: 2020 2020 2020 2020 2020 636f 6e66 6967            config
+00002250: 2e67 7075 5f6f 7074 696f 6e73 2e61 6c6c  .gpu_options.all
+00002260: 6f77 5f67 726f 7774 6820 3d20 5472 7565  ow_growth = True
+00002270: 0a20 2020 2020 2020 2020 2020 2073 6573  .            ses
+00002280: 7369 6f6e 203d 2074 662e 636f 6d70 6174  sion = tf.compat
+00002290: 2e76 312e 5365 7373 696f 6e28 636f 6e66  .v1.Session(conf
+000022a0: 6967 3d63 6f6e 6669 6729 0a20 2020 2020  ig=config).     
+000022b0: 2020 2020 2020 2073 6574 5f73 6573 7369         set_sessi
+000022c0: 6f6e 2873 6573 7369 6f6e 290a 2020 2020  on(session).    
+000022d0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000022e0: 2020 2020 2073 656c 662e 6d6f 6465 6c5f       self.model_
+000022f0: 7061 6765 203d 2073 656c 662e 6f75 725f  page = self.our_
+00002300: 6c6f 6164 5f6d 6f64 656c 2873 656c 662e  load_model(self.
+00002310: 6d6f 6465 6c5f 7061 6765 5f64 6972 290a  model_page_dir).
+00002320: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00002330: 2e6d 6f64 656c 5f63 6c61 7373 6966 6965  .model_classifie
+00002340: 7220 3d20 7365 6c66 2e6f 7572 5f6c 6f61  r = self.our_loa
+00002350: 645f 6d6f 6465 6c28 7365 6c66 2e6d 6f64  d_model(self.mod
+00002360: 656c 5f64 6972 5f6f 665f 636f 6c5f 636c  el_dir_of_col_cl
+00002370: 6173 7369 6669 6572 290a 2020 2020 2020  assifier).      
+00002380: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
+00002390: 5f62 696e 203d 2073 656c 662e 6f75 725f  _bin = self.our_
+000023a0: 6c6f 6164 5f6d 6f64 656c 2873 656c 662e  load_model(self.
+000023b0: 6d6f 6465 6c5f 6469 725f 6f66 5f62 696e  model_dir_of_bin
+000023c0: 6172 697a 6174 696f 6e29 0a20 2020 2020  arization).     
+000023d0: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
+000023e0: 6c5f 7465 7874 6c69 6e65 203d 2073 656c  l_textline = sel
+000023f0: 662e 6f75 725f 6c6f 6164 5f6d 6f64 656c  f.our_load_model
+00002400: 2873 656c 662e 6d6f 6465 6c5f 7465 7874  (self.model_text
+00002410: 6c69 6e65 5f64 6972 290a 2020 2020 2020  line_dir).      
+00002420: 2020 2020 2020 7365 6c66 2e6d 6f64 656c        self.model
+00002430: 5f72 6567 696f 6e20 3d20 7365 6c66 2e6f  _region = self.o
+00002440: 7572 5f6c 6f61 645f 6d6f 6465 6c28 7365  ur_load_model(se
+00002450: 6c66 2e6d 6f64 656c 5f72 6567 696f 6e5f  lf.model_region_
+00002460: 6469 725f 705f 656e 735f 6c69 6768 7429  dir_p_ens_light)
+00002470: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00002480: 662e 6d6f 6465 6c5f 7265 6769 6f6e 5f66  f.model_region_f
+00002490: 6c5f 6e70 203d 2073 656c 662e 6f75 725f  l_np = self.our_
+000024a0: 6c6f 6164 5f6d 6f64 656c 2873 656c 662e  load_model(self.
+000024b0: 6d6f 6465 6c5f 7265 6769 6f6e 5f64 6972  model_region_dir
+000024c0: 5f66 756c 6c79 5f6e 7029 0a20 2020 2020  _fully_np).     
+000024d0: 2020 2020 2020 2073 656c 662e 6d6f 6465         self.mode
+000024e0: 6c5f 7265 6769 6f6e 5f66 6c20 3d20 7365  l_region_fl = se
+000024f0: 6c66 2e6f 7572 5f6c 6f61 645f 6d6f 6465  lf.our_load_mode
+00002500: 6c28 7365 6c66 2e6d 6f64 656c 5f72 6567  l(self.model_reg
+00002510: 696f 6e5f 6469 725f 6675 6c6c 7929 0a20  ion_dir_fully). 
+00002520: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00002530: 2020 2020 2020 2020 7365 6c66 2e6c 735f          self.ls_
+00002540: 696d 6773 2020 3d20 6f73 2e6c 6973 7464  imgs  = os.listd
+00002550: 6972 2873 656c 662e 6469 725f 696e 290a  ir(self.dir_in).
+00002560: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00002570: 2020 2020 2069 6620 6469 725f 696e 2061       if dir_in a
+00002580: 6e64 206e 6f74 206c 6967 6874 5f76 6572  nd not light_ver
+00002590: 7369 6f6e 3a0a 2020 2020 2020 2020 2020  sion:.          
+000025a0: 2020 636f 6e66 6967 203d 2074 662e 636f    config = tf.co
+000025b0: 6d70 6174 2e76 312e 436f 6e66 6967 5072  mpat.v1.ConfigPr
+000025c0: 6f74 6f28 290a 2020 2020 2020 2020 2020  oto().          
+000025d0: 2020 636f 6e66 6967 2e67 7075 5f6f 7074    config.gpu_opt
+000025e0: 696f 6e73 2e61 6c6c 6f77 5f67 726f 7774  ions.allow_growt
+000025f0: 6820 3d20 5472 7565 0a20 2020 2020 2020  h = True.       
+00002600: 2020 2020 2073 6573 7369 6f6e 203d 2074       session = t
+00002610: 662e 636f 6d70 6174 2e76 312e 5365 7373  f.compat.v1.Sess
+00002620: 696f 6e28 636f 6e66 6967 3d63 6f6e 6669  ion(config=confi
+00002630: 6729 0a20 2020 2020 2020 2020 2020 2073  g).            s
+00002640: 6574 5f73 6573 7369 6f6e 2873 6573 7369  et_session(sessi
+00002650: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
+00002660: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00002670: 662e 6d6f 6465 6c5f 7061 6765 203d 2073  f.model_page = s
+00002680: 656c 662e 6f75 725f 6c6f 6164 5f6d 6f64  elf.our_load_mod
+00002690: 656c 2873 656c 662e 6d6f 6465 6c5f 7061  el(self.model_pa
+000026a0: 6765 5f64 6972 290a 2020 2020 2020 2020  ge_dir).        
+000026b0: 2020 2020 7365 6c66 2e6d 6f64 656c 5f63      self.model_c
+000026c0: 6c61 7373 6966 6965 7220 3d20 7365 6c66  lassifier = self
+000026d0: 2e6f 7572 5f6c 6f61 645f 6d6f 6465 6c28  .our_load_model(
+000026e0: 7365 6c66 2e6d 6f64 656c 5f64 6972 5f6f  self.model_dir_o
+000026f0: 665f 636f 6c5f 636c 6173 7369 6669 6572  f_col_classifier
+00002700: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00002710: 6c66 2e6d 6f64 656c 5f62 696e 203d 2073  lf.model_bin = s
+00002720: 656c 662e 6f75 725f 6c6f 6164 5f6d 6f64  elf.our_load_mod
+00002730: 656c 2873 656c 662e 6d6f 6465 6c5f 6469  el(self.model_di
+00002740: 725f 6f66 5f62 696e 6172 697a 6174 696f  r_of_binarizatio
+00002750: 6e29 0a20 2020 2020 2020 2020 2020 2073  n).            s
+00002760: 656c 662e 6d6f 6465 6c5f 7465 7874 6c69  elf.model_textli
+00002770: 6e65 203d 2073 656c 662e 6f75 725f 6c6f  ne = self.our_lo
+00002780: 6164 5f6d 6f64 656c 2873 656c 662e 6d6f  ad_model(self.mo
+00002790: 6465 6c5f 7465 7874 6c69 6e65 5f64 6972  del_textline_dir
+000027a0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+000027b0: 6c66 2e6d 6f64 656c 5f72 6567 696f 6e20  lf.model_region 
+000027c0: 3d20 7365 6c66 2e6f 7572 5f6c 6f61 645f  = self.our_load_
+000027d0: 6d6f 6465 6c28 7365 6c66 2e6d 6f64 656c  model(self.model
+000027e0: 5f72 6567 696f 6e5f 6469 725f 705f 656e  _region_dir_p_en
+000027f0: 7329 0a20 2020 2020 2020 2020 2020 2073  s).            s
+00002800: 656c 662e 6d6f 6465 6c5f 7265 6769 6f6e  elf.model_region
+00002810: 5f70 3220 3d20 7365 6c66 2e6f 7572 5f6c  _p2 = self.our_l
+00002820: 6f61 645f 6d6f 6465 6c28 7365 6c66 2e6d  oad_model(self.m
+00002830: 6f64 656c 5f72 6567 696f 6e5f 6469 725f  odel_region_dir_
+00002840: 7032 290a 2020 2020 2020 2020 2020 2020  p2).            
+00002850: 7365 6c66 2e6d 6f64 656c 5f72 6567 696f  self.model_regio
+00002860: 6e5f 666c 5f6e 7020 3d20 7365 6c66 2e6f  n_fl_np = self.o
+00002870: 7572 5f6c 6f61 645f 6d6f 6465 6c28 7365  ur_load_model(se
+00002880: 6c66 2e6d 6f64 656c 5f72 6567 696f 6e5f  lf.model_region_
+00002890: 6469 725f 6675 6c6c 795f 6e70 290a 2020  dir_fully_np).  
+000028a0: 2020 2020 2020 2020 2020 7365 6c66 2e6d            self.m
+000028b0: 6f64 656c 5f72 6567 696f 6e5f 666c 203d  odel_region_fl =
+000028c0: 2073 656c 662e 6f75 725f 6c6f 6164 5f6d   self.our_load_m
+000028d0: 6f64 656c 2873 656c 662e 6d6f 6465 6c5f  odel(self.model_
+000028e0: 7265 6769 6f6e 5f64 6972 5f66 756c 6c79  region_dir_fully
+000028f0: 290a 2020 2020 2020 2020 2020 2020 7365  ).            se
+00002900: 6c66 2e6d 6f64 656c 5f65 6e68 616e 6365  lf.model_enhance
+00002910: 6d65 6e74 203d 2073 656c 662e 6f75 725f  ment = self.our_
+00002920: 6c6f 6164 5f6d 6f64 656c 2873 656c 662e  load_model(self.
+00002930: 6d6f 6465 6c5f 6469 725f 6f66 5f65 6e68  model_dir_of_enh
+00002940: 616e 6365 6d65 6e74 290a 2020 2020 2020  ancement).      
+00002950: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+00002960: 2020 2073 656c 662e 6c73 5f69 6d67 7320     self.ls_imgs 
+00002970: 203d 206f 732e 6c69 7374 6469 7228 7365   = os.listdir(se
+00002980: 6c66 2e64 6972 5f69 6e29 0a20 2020 2020  lf.dir_in).     
+00002990: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+000029a0: 0a20 2020 2064 6566 205f 6361 6368 655f  .    def _cache_
+000029b0: 696d 6167 6573 2873 656c 662c 2069 6d61  images(self, ima
+000029c0: 6765 5f66 696c 656e 616d 653d 4e6f 6e65  ge_filename=None
+000029d0: 2c20 696d 6167 655f 7069 6c3d 4e6f 6e65  , image_pil=None
+000029e0: 293a 0a20 2020 2020 2020 2072 6574 203d  ):.        ret =
+000029f0: 207b 7d0a 2020 2020 2020 2020 6966 2069   {}.        if i
+00002a00: 6d61 6765 5f66 696c 656e 616d 653a 0a20  mage_filename:. 
+00002a10: 2020 2020 2020 2020 2020 2072 6574 5b27             ret['
+00002a20: 696d 6727 5d20 3d20 6376 322e 696d 7265  img'] = cv2.imre
+00002a30: 6164 2869 6d61 6765 5f66 696c 656e 616d  ad(image_filenam
+00002a40: 6529 0a20 2020 2020 2020 2020 2020 2073  e).            s
+00002a50: 656c 662e 6470 6920 3d20 6368 6563 6b5f  elf.dpi = check_
+00002a60: 6470 6928 696d 6167 655f 6669 6c65 6e61  dpi(image_filena
+00002a70: 6d65 290a 2020 2020 2020 2020 656c 7365  me).        else
+00002a80: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+00002a90: 745b 2769 6d67 275d 203d 2070 696c 3263  t['img'] = pil2c
+00002aa0: 7628 696d 6167 655f 7069 6c29 0a20 2020  v(image_pil).   
+00002ab0: 2020 2020 2020 2020 2073 656c 662e 6470           self.dp
+00002ac0: 6920 3d20 6368 6563 6b5f 6470 6928 696d  i = check_dpi(im
+00002ad0: 6167 655f 7069 6c29 0a20 2020 2020 2020  age_pil).       
+00002ae0: 2072 6574 5b27 696d 675f 6772 6179 7363   ret['img_graysc
+00002af0: 616c 6527 5d20 3d20 6376 322e 6376 7443  ale'] = cv2.cvtC
+00002b00: 6f6c 6f72 2872 6574 5b27 696d 6727 5d2c  olor(ret['img'],
+00002b10: 2063 7632 2e43 4f4c 4f52 5f42 4752 3247   cv2.COLOR_BGR2G
+00002b20: 5241 5929 0a20 2020 2020 2020 2066 6f72  RAY).        for
+00002b30: 2070 7265 6669 7820 696e 2028 2727 2c20   prefix in ('', 
+00002b40: 2027 5f67 7261 7973 6361 6c65 2729 3a0a   '_grayscale'):.
+00002b50: 2020 2020 2020 2020 2020 2020 7265 745b              ret[
+00002b60: 6627 696d 677b 7072 6566 6978 7d5f 7569  f'img{prefix}_ui
+00002b70: 6e74 3827 5d20 3d20 7265 745b 6627 696d  nt8'] = ret[f'im
+00002b80: 677b 7072 6566 6978 7d27 5d2e 6173 7479  g{prefix}'].asty
+00002b90: 7065 286e 702e 7569 6e74 3829 0a20 2020  pe(np.uint8).   
+00002ba0: 2020 2020 2072 6574 7572 6e20 7265 740a       return ret.
+00002bb0: 2020 2020 6465 6620 7265 7365 745f 6669      def reset_fi
+00002bc0: 6c65 5f6e 616d 655f 6469 7228 7365 6c66  le_name_dir(self
+00002bd0: 2c20 696d 6167 655f 6669 6c65 6e61 6d65  , image_filename
+00002be0: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00002bf0: 5f69 6d67 7320 3d20 7365 6c66 2e5f 6361  _imgs = self._ca
+00002c00: 6368 655f 696d 6167 6573 2869 6d61 6765  che_images(image
+00002c10: 5f66 696c 656e 616d 653d 696d 6167 655f  _filename=image_
+00002c20: 6669 6c65 6e61 6d65 290a 2020 2020 2020  filename).      
+00002c30: 2020 7365 6c66 2e69 6d61 6765 5f66 696c    self.image_fil
+00002c40: 656e 616d 6520 3d20 696d 6167 655f 6669  ename = image_fi
+00002c50: 6c65 6e61 6d65 0a20 2020 2020 2020 200a  lename.        .
+00002c60: 2020 2020 2020 2020 7365 6c66 2e70 6c6f          self.plo
+00002c70: 7474 6572 203d 204e 6f6e 6520 6966 206e  tter = None if n
+00002c80: 6f74 2073 656c 662e 656e 6162 6c65 5f70  ot self.enable_p
+00002c90: 6c6f 7474 696e 6720 656c 7365 2045 796e  lotting else Eyn
+00002ca0: 6f6c 6c61 6850 6c6f 7474 6572 280a 2020  ollahPlotter(.  
+00002cb0: 2020 2020 2020 2020 2020 6469 725f 6f75            dir_ou
+00002cc0: 743d 7365 6c66 2e64 6972 5f6f 7574 2c0a  t=self.dir_out,.
+00002cd0: 2020 2020 2020 2020 2020 2020 6469 725f              dir_
+00002ce0: 6f66 5f61 6c6c 3d73 656c 662e 6469 725f  of_all=self.dir_
+00002cf0: 6f66 5f61 6c6c 2c0a 2020 2020 2020 2020  of_all,.        
+00002d00: 2020 2020 6469 725f 7361 7665 5f70 6167      dir_save_pag
+00002d10: 653d 7365 6c66 2e64 6972 5f73 6176 655f  e=self.dir_save_
+00002d20: 7061 6765 2c0a 2020 2020 2020 2020 2020  page,.          
+00002d30: 2020 6469 725f 6f66 5f64 6573 6b65 7765    dir_of_deskewe
+00002d40: 643d 7365 6c66 2e64 6972 5f6f 665f 6465  d=self.dir_of_de
+00002d50: 736b 6577 6564 2c0a 2020 2020 2020 2020  skewed,.        
+00002d60: 2020 2020 6469 725f 6f66 5f63 726f 7070      dir_of_cropp
+00002d70: 6564 5f69 6d61 6765 733d 7365 6c66 2e64  ed_images=self.d
+00002d80: 6972 5f6f 665f 6372 6f70 7065 645f 696d  ir_of_cropped_im
+00002d90: 6167 6573 2c0a 2020 2020 2020 2020 2020  ages,.          
+00002da0: 2020 6469 725f 6f66 5f6c 6179 6f75 743d    dir_of_layout=
+00002db0: 7365 6c66 2e64 6972 5f6f 665f 6c61 796f  self.dir_of_layo
+00002dc0: 7574 2c0a 2020 2020 2020 2020 2020 2020  ut,.            
+00002dd0: 696d 6167 655f 6669 6c65 6e61 6d65 5f73  image_filename_s
+00002de0: 7465 6d3d 5061 7468 2850 6174 6828 696d  tem=Path(Path(im
+00002df0: 6167 655f 6669 6c65 6e61 6d65 292e 6e61  age_filename).na
+00002e00: 6d65 292e 7374 656d 290a 2020 2020 2020  me).stem).      
+00002e10: 2020 0a20 2020 2020 2020 2073 656c 662e    .        self.
+00002e20: 7772 6974 6572 203d 2045 796e 6f6c 6c61  writer = Eynolla
+00002e30: 6858 6d6c 5772 6974 6572 280a 2020 2020  hXmlWriter(.    
+00002e40: 2020 2020 2020 2020 6469 725f 6f75 743d          dir_out=
+00002e50: 7365 6c66 2e64 6972 5f6f 7574 2c0a 2020  self.dir_out,.  
+00002e60: 2020 2020 2020 2020 2020 696d 6167 655f            image_
+00002e70: 6669 6c65 6e61 6d65 3d73 656c 662e 696d  filename=self.im
+00002e80: 6167 655f 6669 6c65 6e61 6d65 2c0a 2020  age_filename,.  
+00002e90: 2020 2020 2020 2020 2020 6375 7276 6564            curved
+00002ea0: 5f6c 696e 653d 7365 6c66 2e63 7572 7665  _line=self.curve
+00002eb0: 645f 6c69 6e65 2c0a 2020 2020 2020 2020  d_line,.        
+00002ec0: 2020 2020 7465 7874 6c69 6e65 5f6c 6967      textline_lig
+00002ed0: 6874 203d 2073 656c 662e 7465 7874 6c69  ht = self.textli
+00002ee0: 6e65 5f6c 6967 6874 2c0a 2020 2020 2020  ne_light,.      
+00002ef0: 2020 2020 2020 7063 6774 733d 7365 6c66        pcgts=self
+00002f00: 2e70 6367 7473 290a 2020 2020 6465 6620  .pcgts).    def 
+00002f10: 696d 7265 6164 2873 656c 662c 2067 7261  imread(self, gra
+00002f20: 7973 6361 6c65 3d46 616c 7365 2c20 7569  yscale=False, ui
+00002f30: 6e74 383d 5472 7565 293a 0a20 2020 2020  nt8=True):.     
+00002f40: 2020 206b 6579 203d 2027 696d 6727 0a20     key = 'img'. 
+00002f50: 2020 2020 2020 2069 6620 6772 6179 7363         if graysc
+00002f60: 616c 653a 0a20 2020 2020 2020 2020 2020  ale:.           
+00002f70: 206b 6579 202b 3d20 275f 6772 6179 7363   key += '_graysc
+00002f80: 616c 6527 0a20 2020 2020 2020 2069 6620  ale'.        if 
+00002f90: 7569 6e74 383a 0a20 2020 2020 2020 2020  uint8:.         
+00002fa0: 2020 206b 6579 202b 3d20 275f 7569 6e74     key += '_uint
+00002fb0: 3827 0a20 2020 2020 2020 2072 6574 7572  8'.        retur
+00002fc0: 6e20 7365 6c66 2e5f 696d 6773 5b6b 6579  n self._imgs[key
+00002fd0: 5d2e 636f 7079 2829 0a20 2020 200a 2020  ].copy().    .  
+00002fe0: 2020 6465 6620 6973 4e61 4e28 7365 6c66    def isNaN(self
+00002ff0: 2c20 6e75 6d29 3a0a 2020 2020 2020 2020  , num):.        
+00003000: 7265 7475 726e 206e 756d 2021 3d20 6e75  return num != nu
+00003010: 6d0a 0a0a 2020 2020 6465 6620 7072 6564  m...    def pred
+00003020: 6963 745f 656e 6861 6e63 656d 656e 7428  ict_enhancement(
+00003030: 7365 6c66 2c20 696d 6729 3a0a 2020 2020  self, img):.    
+00003040: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
+00003050: 6465 6275 6728 2265 6e74 6572 2070 7265  debug("enter pre
+00003060: 6469 6374 5f65 6e68 616e 6365 6d65 6e74  dict_enhancement
+00003070: 2229 0a20 2020 2020 2020 206d 6f64 656c  ").        model
+00003080: 5f65 6e68 616e 6365 6d65 6e74 2c20 7365  _enhancement, se
+00003090: 7373 696f 6e5f 656e 6861 6e63 656d 656e  ssion_enhancemen
+000030a0: 7420 3d20 7365 6c66 2e73 7461 7274 5f6e  t = self.start_n
+000030b0: 6577 5f73 6573 7369 6f6e 5f61 6e64 5f6d  ew_session_and_m
+000030c0: 6f64 656c 2873 656c 662e 6d6f 6465 6c5f  odel(self.model_
+000030d0: 6469 725f 6f66 5f65 6e68 616e 6365 6d65  dir_of_enhanceme
+000030e0: 6e74 290a 0a20 2020 2020 2020 2069 6d67  nt)..        img
+000030f0: 5f68 6569 6768 745f 6d6f 6465 6c20 3d20  _height_model = 
+00003100: 6d6f 6465 6c5f 656e 6861 6e63 656d 656e  model_enhancemen
+00003110: 742e 6c61 7965 7273 5b6c 656e 286d 6f64  t.layers[len(mod
+00003120: 656c 5f65 6e68 616e 6365 6d65 6e74 2e6c  el_enhancement.l
+00003130: 6179 6572 7329 202d 2031 5d2e 6f75 7470  ayers) - 1].outp
+00003140: 7574 5f73 6861 7065 5b31 5d0a 2020 2020  ut_shape[1].    
+00003150: 2020 2020 696d 675f 7769 6474 685f 6d6f      img_width_mo
+00003160: 6465 6c20 3d20 6d6f 6465 6c5f 656e 6861  del = model_enha
+00003170: 6e63 656d 656e 742e 6c61 7965 7273 5b6c  ncement.layers[l
+00003180: 656e 286d 6f64 656c 5f65 6e68 616e 6365  en(model_enhance
+00003190: 6d65 6e74 2e6c 6179 6572 7329 202d 2031  ment.layers) - 1
+000031a0: 5d2e 6f75 7470 7574 5f73 6861 7065 5b32  ].output_shape[2
+000031b0: 5d0a 2020 2020 2020 2020 6966 2069 6d67  ].        if img
+000031c0: 2e73 6861 7065 5b30 5d20 3c20 696d 675f  .shape[0] < img_
+000031d0: 6865 6967 6874 5f6d 6f64 656c 3a0a 2020  height_model:.  
+000031e0: 2020 2020 2020 2020 2020 696d 6720 3d20            img = 
+000031f0: 6376 322e 7265 7369 7a65 2869 6d67 2c20  cv2.resize(img, 
+00003200: 2869 6d67 2e73 6861 7065 5b31 5d2c 2069  (img.shape[1], i
+00003210: 6d67 5f77 6964 7468 5f6d 6f64 656c 292c  mg_width_model),
+00003220: 2069 6e74 6572 706f 6c61 7469 6f6e 3d63   interpolation=c
+00003230: 7632 2e49 4e54 4552 5f4e 4541 5245 5354  v2.INTER_NEAREST
+00003240: 290a 0a20 2020 2020 2020 2069 6620 696d  )..        if im
+00003250: 672e 7368 6170 655b 315d 203c 2069 6d67  g.shape[1] < img
+00003260: 5f77 6964 7468 5f6d 6f64 656c 3a0a 2020  _width_model:.  
+00003270: 2020 2020 2020 2020 2020 696d 6720 3d20            img = 
+00003280: 6376 322e 7265 7369 7a65 2869 6d67 2c20  cv2.resize(img, 
+00003290: 2869 6d67 5f68 6569 6768 745f 6d6f 6465  (img_height_mode
+000032a0: 6c2c 2069 6d67 2e73 6861 7065 5b30 5d29  l, img.shape[0])
+000032b0: 2c20 696e 7465 7270 6f6c 6174 696f 6e3d  , interpolation=
+000032c0: 6376 322e 494e 5445 525f 4e45 4152 4553  cv2.INTER_NEARES
+000032d0: 5429 0a20 2020 2020 2020 206d 6172 6769  T).        margi
+000032e0: 6e20 3d20 696e 7428 3020 2a20 696d 675f  n = int(0 * img_
+000032f0: 7769 6474 685f 6d6f 6465 6c29 0a20 2020  width_model).   
+00003300: 2020 2020 2077 6964 7468 5f6d 6964 203d       width_mid =
+00003310: 2069 6d67 5f77 6964 7468 5f6d 6f64 656c   img_width_model
+00003320: 202d 2032 202a 206d 6172 6769 6e0a 2020   - 2 * margin.  
+00003330: 2020 2020 2020 6865 6967 6874 5f6d 6964        height_mid
+00003340: 203d 2069 6d67 5f68 6569 6768 745f 6d6f   = img_height_mo
+00003350: 6465 6c20 2d20 3220 2a20 6d61 7267 696e  del - 2 * margin
+00003360: 0a20 2020 2020 2020 2069 6d67 203d 2069  .        img = i
+00003370: 6d67 202f 2066 6c6f 6174 2832 3535 2e30  mg / float(255.0
+00003380: 290a 0a20 2020 2020 2020 2069 6d67 5f68  )..        img_h
+00003390: 203d 2069 6d67 2e73 6861 7065 5b30 5d0a   = img.shape[0].
+000033a0: 2020 2020 2020 2020 696d 675f 7720 3d20          img_w = 
+000033b0: 696d 672e 7368 6170 655b 315d 0a0a 2020  img.shape[1]..  
+000033c0: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
+000033d0: 5f74 7275 6520 3d20 6e70 2e7a 6572 6f73  _true = np.zeros
+000033e0: 2828 696d 675f 682c 2069 6d67 5f77 2c20  ((img_h, img_w, 
+000033f0: 3329 290a 2020 2020 2020 2020 6e78 6620  3)).        nxf 
+00003400: 3d20 696d 675f 7720 2f20 666c 6f61 7428  = img_w / float(
+00003410: 7769 6474 685f 6d69 6429 0a20 2020 2020  width_mid).     
+00003420: 2020 206e 7966 203d 2069 6d67 5f68 202f     nyf = img_h /
+00003430: 2066 6c6f 6174 2868 6569 6768 745f 6d69   float(height_mi
+00003440: 6429 0a0a 2020 2020 2020 2020 6e78 6620  d)..        nxf 
+00003450: 3d20 696e 7428 6e78 6629 202b 2031 2069  = int(nxf) + 1 i
+00003460: 6620 6e78 6620 3e20 696e 7428 6e78 6629  f nxf > int(nxf)
+00003470: 2065 6c73 6520 696e 7428 6e78 6629 0a20   else int(nxf). 
+00003480: 2020 2020 2020 206e 7966 203d 2069 6e74         nyf = int
+00003490: 286e 7966 2920 2b20 3120 6966 206e 7966  (nyf) + 1 if nyf
+000034a0: 203e 2069 6e74 286e 7966 2920 656c 7365   > int(nyf) else
+000034b0: 2069 6e74 286e 7966 290a 0a20 2020 2020   int(nyf)..     
+000034c0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+000034d0: 6528 6e78 6629 3a0a 2020 2020 2020 2020  e(nxf):.        
+000034e0: 2020 2020 666f 7220 6a20 696e 2072 616e      for j in ran
+000034f0: 6765 286e 7966 293a 0a20 2020 2020 2020  ge(nyf):.       
+00003500: 2020 2020 2020 2020 2069 6620 6920 3d3d           if i ==
+00003510: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00003520: 2020 2020 2020 2020 696e 6465 785f 785f          index_x_
+00003530: 6420 3d20 6920 2a20 7769 6474 685f 6d69  d = i * width_mi
+00003540: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00003550: 2020 2020 2020 696e 6465 785f 785f 7520        index_x_u 
+00003560: 3d20 696e 6465 785f 785f 6420 2b20 696d  = index_x_d + im
+00003570: 675f 7769 6474 685f 6d6f 6465 6c0a 2020  g_width_model.  
+00003580: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00003590: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000035a0: 2020 2020 2020 2020 696e 6465 785f 785f          index_x_
+000035b0: 6420 3d20 6920 2a20 7769 6474 685f 6d69  d = i * width_mi
+000035c0: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+000035d0: 2020 2020 2020 696e 6465 785f 785f 7520        index_x_u 
+000035e0: 3d20 696e 6465 785f 785f 6420 2b20 696d  = index_x_d + im
+000035f0: 675f 7769 6474 685f 6d6f 6465 6c0a 2020  g_width_model.  
+00003600: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00003610: 206a 203d 3d20 303a 0a20 2020 2020 2020   j == 0:.       
+00003620: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+00003630: 6578 5f79 5f64 203d 206a 202a 2068 6569  ex_y_d = j * hei
+00003640: 6768 745f 6d69 640a 2020 2020 2020 2020  ght_mid.        
+00003650: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+00003660: 785f 795f 7520 3d20 696e 6465 785f 795f  x_y_u = index_y_
+00003670: 6420 2b20 696d 675f 6865 6967 6874 5f6d  d + img_height_m
+00003680: 6f64 656c 0a20 2020 2020 2020 2020 2020  odel.           
+00003690: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000036a0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000036b0: 6e64 6578 5f79 5f64 203d 206a 202a 2068  ndex_y_d = j * h
+000036c0: 6569 6768 745f 6d69 640a 2020 2020 2020  eight_mid.      
+000036d0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+000036e0: 6465 785f 795f 7520 3d20 696e 6465 785f  dex_y_u = index_
+000036f0: 795f 6420 2b20 696d 675f 6865 6967 6874  y_d + img_height
+00003700: 5f6d 6f64 656c 0a0a 2020 2020 2020 2020  _model..        
+00003710: 2020 2020 2020 2020 6966 2069 6e64 6578          if index
+00003720: 5f78 5f75 203e 2069 6d67 5f77 3a0a 2020  _x_u > img_w:.  
+00003730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003740: 2020 696e 6465 785f 785f 7520 3d20 696d    index_x_u = im
+00003750: 675f 770a 2020 2020 2020 2020 2020 2020  g_w.            
+00003760: 2020 2020 2020 2020 696e 6465 785f 785f          index_x_
+00003770: 6420 3d20 696d 675f 7720 2d20 696d 675f  d = img_w - img_
+00003780: 7769 6474 685f 6d6f 6465 6c0a 2020 2020  width_model.    
+00003790: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+000037a0: 6e64 6578 5f79 5f75 203e 2069 6d67 5f68  ndex_y_u > img_h
+000037b0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000037c0: 2020 2020 2020 696e 6465 785f 795f 7520        index_y_u 
+000037d0: 3d20 696d 675f 680a 2020 2020 2020 2020  = img_h.        
+000037e0: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+000037f0: 785f 795f 6420 3d20 696d 675f 6820 2d20  x_y_d = img_h - 
+00003800: 696d 675f 6865 6967 6874 5f6d 6f64 656c  img_height_model
+00003810: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+00003820: 2020 696d 675f 7061 7463 6820 3d20 696d    img_patch = im
+00003830: 675b 696e 6465 785f 795f 643a 696e 6465  g[index_y_d:inde
+00003840: 785f 795f 752c 2069 6e64 6578 5f78 5f64  x_y_u, index_x_d
+00003850: 3a69 6e64 6578 5f78 5f75 2c20 3a5d 0a20  :index_x_u, :]. 
+00003860: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+00003870: 6162 656c 5f70 5f70 7265 6420 3d20 6d6f  abel_p_pred = mo
+00003880: 6465 6c5f 656e 6861 6e63 656d 656e 742e  del_enhancement.
+00003890: 7072 6564 6963 7428 696d 675f 7061 7463  predict(img_patc
+000038a0: 682e 7265 7368 6170 6528 312c 2069 6d67  h.reshape(1, img
+000038b0: 5f70 6174 6368 2e73 6861 7065 5b30 5d2c  _patch.shape[0],
+000038c0: 2069 6d67 5f70 6174 6368 2e73 6861 7065   img_patch.shape
+000038d0: 5b31 5d2c 2069 6d67 5f70 6174 6368 2e73  [1], img_patch.s
+000038e0: 6861 7065 5b32 5d29 2c0a 2020 2020 2020  hape[2]),.      
+000038f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003900: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003920: 2020 2076 6572 626f 7365 3d30 290a 0a20     verbose=0).. 
+00003930: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00003940: 6567 203d 206c 6162 656c 5f70 5f70 7265  eg = label_p_pre
+00003950: 645b 302c 203a 2c20 3a2c 203a 5d0a 2020  d[0, :, :, :].  
+00003960: 2020 2020 2020 2020 2020 2020 2020 7365                se
+00003970: 6720 3d20 7365 6720 2a20 3235 350a 0a20  g = seg * 255.. 
+00003980: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00003990: 6620 6920 3d3d 2030 2061 6e64 206a 203d  f i == 0 and j =
+000039a0: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+000039b0: 2020 2020 2020 2020 2073 6567 203d 2073           seg = s
+000039c0: 6567 5b30 203a 2073 6567 2e73 6861 7065  eg[0 : seg.shape
+000039d0: 5b30 5d20 2d20 6d61 7267 696e 2c20 3020  [0] - margin, 0 
+000039e0: 3a20 7365 672e 7368 6170 655b 315d 202d  : seg.shape[1] -
+000039f0: 206d 6172 6769 6e5d 0a20 2020 2020 2020   margin].       
+00003a00: 2020 2020 2020 2020 2020 2020 2070 7265               pre
+00003a10: 6469 6374 696f 6e5f 7472 7565 5b69 6e64  diction_true[ind
+00003a20: 6578 5f79 5f64 202b 2030 203a 2069 6e64  ex_y_d + 0 : ind
+00003a30: 6578 5f79 5f75 202d 206d 6172 6769 6e2c  ex_y_u - margin,
+00003a40: 2069 6e64 6578 5f78 5f64 202b 2030 203a   index_x_d + 0 :
+00003a50: 2069 6e64 6578 5f78 5f75 202d 206d 6172   index_x_u - mar
+00003a60: 6769 6e2c 203a 5d20 3d20 7365 670a 2020  gin, :] = seg.  
+00003a70: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00003a80: 6966 2069 203d 3d20 6e78 6620 2d20 3120  if i == nxf - 1 
+00003a90: 616e 6420 6a20 3d3d 206e 7966 202d 2031  and j == nyf - 1
+00003aa0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00003ab0: 2020 2020 2020 7365 6720 3d20 7365 675b        seg = seg[
+00003ac0: 6d61 7267 696e 203a 2073 6567 2e73 6861  margin : seg.sha
+00003ad0: 7065 5b30 5d20 2d20 302c 206d 6172 6769  pe[0] - 0, margi
+00003ae0: 6e20 3a20 7365 672e 7368 6170 655b 315d  n : seg.shape[1]
+00003af0: 202d 2030 5d0a 2020 2020 2020 2020 2020   - 0].          
+00003b00: 2020 2020 2020 2020 2020 7072 6564 6963            predic
+00003b10: 7469 6f6e 5f74 7275 655b 696e 6465 785f  tion_true[index_
+00003b20: 795f 6420 2b20 6d61 7267 696e 203a 2069  y_d + margin : i
+00003b30: 6e64 6578 5f79 5f75 202d 2030 2c20 696e  ndex_y_u - 0, in
+00003b40: 6465 785f 785f 6420 2b20 6d61 7267 696e  dex_x_d + margin
+00003b50: 203a 2069 6e64 6578 5f78 5f75 202d 2030   : index_x_u - 0
+00003b60: 2c20 3a5d 203d 2073 6567 0a20 2020 2020  , :] = seg.     
+00003b70: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00003b80: 6920 3d3d 2030 2061 6e64 206a 203d 3d20  i == 0 and j == 
+00003b90: 6e79 6620 2d20 313a 0a20 2020 2020 2020  nyf - 1:.       
+00003ba0: 2020 2020 2020 2020 2020 2020 2073 6567               seg
+00003bb0: 203d 2073 6567 5b6d 6172 6769 6e20 3a20   = seg[margin : 
+00003bc0: 7365 672e 7368 6170 655b 305d 202d 2030  seg.shape[0] - 0
+00003bd0: 2c20 3020 3a20 7365 672e 7368 6170 655b  , 0 : seg.shape[
+00003be0: 315d 202d 206d 6172 6769 6e5d 0a20 2020  1] - margin].   
+00003bf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003c00: 2070 7265 6469 6374 696f 6e5f 7472 7565   prediction_true
+00003c10: 5b69 6e64 6578 5f79 5f64 202b 206d 6172  [index_y_d + mar
+00003c20: 6769 6e20 3a20 696e 6465 785f 795f 7520  gin : index_y_u 
+00003c30: 2d20 302c 2069 6e64 6578 5f78 5f64 202b  - 0, index_x_d +
+00003c40: 2030 203a 2069 6e64 6578 5f78 5f75 202d   0 : index_x_u -
+00003c50: 206d 6172 6769 6e2c 203a 5d20 3d20 7365   margin, :] = se
+00003c60: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
+00003c70: 2020 656c 6966 2069 203d 3d20 6e78 6620    elif i == nxf 
+00003c80: 2d20 3120 616e 6420 6a20 3d3d 2030 3a0a  - 1 and j == 0:.
+00003c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003ca0: 2020 2020 7365 6720 3d20 7365 675b 3020      seg = seg[0 
+00003cb0: 3a20 7365 672e 7368 6170 655b 305d 202d  : seg.shape[0] -
+00003cc0: 206d 6172 6769 6e2c 206d 6172 6769 6e20   margin, margin 
+00003cd0: 3a20 7365 672e 7368 6170 655b 315d 202d  : seg.shape[1] -
+00003ce0: 2030 5d0a 2020 2020 2020 2020 2020 2020   0].            
+00003cf0: 2020 2020 2020 2020 7072 6564 6963 7469          predicti
+00003d00: 6f6e 5f74 7275 655b 696e 6465 785f 795f  on_true[index_y_
+00003d10: 6420 2b20 3020 3a20 696e 6465 785f 795f  d + 0 : index_y_
+00003d20: 7520 2d20 6d61 7267 696e 2c20 696e 6465  u - margin, inde
+00003d30: 785f 785f 6420 2b20 6d61 7267 696e 203a  x_x_d + margin :
+00003d40: 2069 6e64 6578 5f78 5f75 202d 2030 2c20   index_x_u - 0, 
+00003d50: 3a5d 203d 2073 6567 0a20 2020 2020 2020  :] = seg.       
+00003d60: 2020 2020 2020 2020 2065 6c69 6620 6920           elif i 
+00003d70: 3d3d 2030 2061 6e64 206a 2021 3d20 3020  == 0 and j != 0 
+00003d80: 616e 6420 6a20 213d 206e 7966 202d 2031  and j != nyf - 1
+00003d90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00003da0: 2020 2020 2020 7365 6720 3d20 7365 675b        seg = seg[
+00003db0: 6d61 7267 696e 203a 2073 6567 2e73 6861  margin : seg.sha
+00003dc0: 7065 5b30 5d20 2d20 6d61 7267 696e 2c20  pe[0] - margin, 
+00003dd0: 3020 3a20 7365 672e 7368 6170 655b 315d  0 : seg.shape[1]
+00003de0: 202d 206d 6172 6769 6e5d 0a20 2020 2020   - margin].     
+00003df0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00003e00: 7265 6469 6374 696f 6e5f 7472 7565 5b69  rediction_true[i
+00003e10: 6e64 6578 5f79 5f64 202b 206d 6172 6769  ndex_y_d + margi
+00003e20: 6e20 3a20 696e 6465 785f 795f 7520 2d20  n : index_y_u - 
+00003e30: 6d61 7267 696e 2c20 696e 6465 785f 785f  margin, index_x_
+00003e40: 6420 2b20 3020 3a20 696e 6465 785f 785f  d + 0 : index_x_
+00003e50: 7520 2d20 6d61 7267 696e 2c20 3a5d 203d  u - margin, :] =
+00003e60: 2073 6567 0a20 2020 2020 2020 2020 2020   seg.           
+00003e70: 2020 2020 2065 6c69 6620 6920 3d3d 206e       elif i == n
+00003e80: 7866 202d 2031 2061 6e64 206a 2021 3d20  xf - 1 and j != 
+00003e90: 3020 616e 6420 6a20 213d 206e 7966 202d  0 and j != nyf -
+00003ea0: 2031 3a0a 2020 2020 2020 2020 2020 2020   1:.            
+00003eb0: 2020 2020 2020 2020 7365 6720 3d20 7365          seg = se
+00003ec0: 675b 6d61 7267 696e 203a 2073 6567 2e73  g[margin : seg.s
+00003ed0: 6861 7065 5b30 5d20 2d20 6d61 7267 696e  hape[0] - margin
+00003ee0: 2c20 6d61 7267 696e 203a 2073 6567 2e73  , margin : seg.s
+00003ef0: 6861 7065 5b31 5d20 2d20 305d 0a20 2020  hape[1] - 0].   
+00003f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003f10: 2070 7265 6469 6374 696f 6e5f 7472 7565   prediction_true
+00003f20: 5b69 6e64 6578 5f79 5f64 202b 206d 6172  [index_y_d + mar
+00003f30: 6769 6e20 3a20 696e 6465 785f 795f 7520  gin : index_y_u 
+00003f40: 2d20 6d61 7267 696e 2c20 696e 6465 785f  - margin, index_
+00003f50: 785f 6420 2b20 6d61 7267 696e 203a 2069  x_d + margin : i
+00003f60: 6e64 6578 5f78 5f75 202d 2030 2c20 3a5d  ndex_x_u - 0, :]
+00003f70: 203d 2073 6567 0a20 2020 2020 2020 2020   = seg.         
+00003f80: 2020 2020 2020 2065 6c69 6620 6920 213d         elif i !=
+00003f90: 2030 2061 6e64 2069 2021 3d20 6e78 6620   0 and i != nxf 
+00003fa0: 2d20 3120 616e 6420 6a20 3d3d 2030 3a0a  - 1 and j == 0:.
+00003fb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00003fc0: 2020 2020 7365 6720 3d20 7365 675b 3020      seg = seg[0 
+00003fd0: 3a20 7365 672e 7368 6170 655b 305d 202d  : seg.shape[0] -
+00003fe0: 206d 6172 6769 6e2c 206d 6172 6769 6e20   margin, margin 
+00003ff0: 3a20 7365 672e 7368 6170 655b 315d 202d  : seg.shape[1] -
+00004000: 206d 6172 6769 6e5d 0a20 2020 2020 2020   margin].       
+00004010: 2020 2020 2020 2020 2020 2020 2070 7265               pre
+00004020: 6469 6374 696f 6e5f 7472 7565 5b69 6e64  diction_true[ind
+00004030: 6578 5f79 5f64 202b 2030 203a 2069 6e64  ex_y_d + 0 : ind
+00004040: 6578 5f79 5f75 202d 206d 6172 6769 6e2c  ex_y_u - margin,
+00004050: 2069 6e64 6578 5f78 5f64 202b 206d 6172   index_x_d + mar
+00004060: 6769 6e20 3a20 696e 6465 785f 785f 7520  gin : index_x_u 
+00004070: 2d20 6d61 7267 696e 2c20 3a5d 203d 2073  - margin, :] = s
+00004080: 6567 0a20 2020 2020 2020 2020 2020 2020  eg.             
+00004090: 2020 2065 6c69 6620 6920 213d 2030 2061     elif i != 0 a
+000040a0: 6e64 2069 2021 3d20 6e78 6620 2d20 3120  nd i != nxf - 1 
+000040b0: 616e 6420 6a20 3d3d 206e 7966 202d 2031  and j == nyf - 1
+000040c0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000040d0: 2020 2020 2020 7365 6720 3d20 7365 675b        seg = seg[
+000040e0: 6d61 7267 696e 203a 2073 6567 2e73 6861  margin : seg.sha
+000040f0: 7065 5b30 5d20 2d20 302c 206d 6172 6769  pe[0] - 0, margi
+00004100: 6e20 3a20 7365 672e 7368 6170 655b 315d  n : seg.shape[1]
+00004110: 202d 206d 6172 6769 6e5d 0a20 2020 2020   - margin].     
+00004120: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00004130: 7265 6469 6374 696f 6e5f 7472 7565 5b69  rediction_true[i
+00004140: 6e64 6578 5f79 5f64 202b 206d 6172 6769  ndex_y_d + margi
+00004150: 6e20 3a20 696e 6465 785f 795f 7520 2d20  n : index_y_u - 
+00004160: 302c 2069 6e64 6578 5f78 5f64 202b 206d  0, index_x_d + m
+00004170: 6172 6769 6e20 3a20 696e 6465 785f 785f  argin : index_x_
+00004180: 7520 2d20 6d61 7267 696e 2c20 3a5d 203d  u - margin, :] =
+00004190: 2073 6567 0a20 2020 2020 2020 2020 2020   seg.           
+000041a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+000041b0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000041c0: 6567 203d 2073 6567 5b6d 6172 6769 6e20  eg = seg[margin 
+000041d0: 3a20 7365 672e 7368 6170 655b 305d 202d  : seg.shape[0] -
+000041e0: 206d 6172 6769 6e2c 206d 6172 6769 6e20   margin, margin 
+000041f0: 3a20 7365 672e 7368 6170 655b 315d 202d  : seg.shape[1] -
+00004200: 206d 6172 6769 6e5d 0a20 2020 2020 2020   margin].       
+00004210: 2020 2020 2020 2020 2020 2020 2070 7265               pre
+00004220: 6469 6374 696f 6e5f 7472 7565 5b69 6e64  diction_true[ind
+00004230: 6578 5f79 5f64 202b 206d 6172 6769 6e20  ex_y_d + margin 
+00004240: 3a20 696e 6465 785f 795f 7520 2d20 6d61  : index_y_u - ma
+00004250: 7267 696e 2c20 696e 6465 785f 785f 6420  rgin, index_x_d 
+00004260: 2b20 6d61 7267 696e 203a 2069 6e64 6578  + margin : index
+00004270: 5f78 5f75 202d 206d 6172 6769 6e2c 203a  _x_u - margin, :
+00004280: 5d20 3d20 7365 670a 0a20 2020 2020 2020  ] = seg..       
+00004290: 2070 7265 6469 6374 696f 6e5f 7472 7565   prediction_true
+000042a0: 203d 2070 7265 6469 6374 696f 6e5f 7472   = prediction_tr
+000042b0: 7565 2e61 7374 7970 6528 696e 7429 0a20  ue.astype(int). 
+000042c0: 2020 2020 2020 2072 6574 7572 6e20 7072         return pr
+000042d0: 6564 6963 7469 6f6e 5f74 7275 650a 0a20  ediction_true.. 
+000042e0: 2020 2064 6566 2063 616c 6375 6c61 7465     def calculate
+000042f0: 5f77 6964 7468 5f68 6569 6768 745f 6279  _width_height_by
+00004300: 5f63 6f6c 756d 6e73 2873 656c 662c 2069  _columns(self, i
+00004310: 6d67 2c20 6e75 6d5f 636f 6c2c 2077 6964  mg, num_col, wid
+00004320: 7468 5f65 6172 6c79 2c20 6c61 6265 6c5f  th_early, label_
+00004330: 705f 7072 6564 293a 0a20 2020 2020 2020  p_pred):.       
+00004340: 2073 656c 662e 6c6f 6767 6572 2e64 6562   self.logger.deb
+00004350: 7567 2822 656e 7465 7220 6361 6c63 756c  ug("enter calcul
+00004360: 6174 655f 7769 6474 685f 6865 6967 6874  ate_width_height
+00004370: 5f62 795f 636f 6c75 6d6e 7322 290a 2020  _by_columns").  
+00004380: 2020 2020 2020 6966 206e 756d 5f63 6f6c        if num_col
+00004390: 203d 3d20 3120 616e 6420 7769 6474 685f   == 1 and width_
+000043a0: 6561 726c 7920 3c20 3131 3030 3a0a 2020  early < 1100:.  
+000043b0: 2020 2020 2020 2020 2020 696d 675f 775f            img_w_
+000043c0: 6e65 7720 3d20 3230 3030 0a20 2020 2020  new = 2000.     
+000043d0: 2020 2020 2020 2069 6d67 5f68 5f6e 6577         img_h_new
+000043e0: 203d 2069 6e74 2869 6d67 2e73 6861 7065   = int(img.shape
+000043f0: 5b30 5d20 2f20 666c 6f61 7428 696d 672e  [0] / float(img.
+00004400: 7368 6170 655b 315d 2920 2a20 3230 3030  shape[1]) * 2000
+00004410: 290a 2020 2020 2020 2020 656c 6966 206e  ).        elif n
+00004420: 756d 5f63 6f6c 203d 3d20 3120 616e 6420  um_col == 1 and 
+00004430: 7769 6474 685f 6561 726c 7920 3e3d 2032  width_early >= 2
+00004440: 3530 303a 0a20 2020 2020 2020 2020 2020  500:.           
+00004450: 2069 6d67 5f77 5f6e 6577 203d 2032 3030   img_w_new = 200
+00004460: 300a 2020 2020 2020 2020 2020 2020 696d  0.            im
+00004470: 675f 685f 6e65 7720 3d20 696e 7428 696d  g_h_new = int(im
+00004480: 672e 7368 6170 655b 305d 202f 2066 6c6f  g.shape[0] / flo
+00004490: 6174 2869 6d67 2e73 6861 7065 5b31 5d29  at(img.shape[1])
+000044a0: 202a 2032 3030 3029 0a20 2020 2020 2020   * 2000).       
+000044b0: 2065 6c69 6620 6e75 6d5f 636f 6c20 3d3d   elif num_col ==
+000044c0: 2031 2061 6e64 2077 6964 7468 5f65 6172   1 and width_ear
+000044d0: 6c79 203e 3d20 3131 3030 2061 6e64 2077  ly >= 1100 and w
+000044e0: 6964 7468 5f65 6172 6c79 203c 2032 3530  idth_early < 250
+000044f0: 303a 0a20 2020 2020 2020 2020 2020 2069  0:.            i
+00004500: 6d67 5f77 5f6e 6577 203d 2077 6964 7468  mg_w_new = width
+00004510: 5f65 6172 6c79 0a20 2020 2020 2020 2020  _early.         
+00004520: 2020 2069 6d67 5f68 5f6e 6577 203d 2069     img_h_new = i
+00004530: 6e74 2869 6d67 2e73 6861 7065 5b30 5d20  nt(img.shape[0] 
+00004540: 2f20 666c 6f61 7428 696d 672e 7368 6170  / float(img.shap
+00004550: 655b 315d 2920 2a20 7769 6474 685f 6561  e[1]) * width_ea
+00004560: 726c 7929 0a20 2020 2020 2020 2065 6c69  rly).        eli
+00004570: 6620 6e75 6d5f 636f 6c20 3d3d 2032 2061  f num_col == 2 a
+00004580: 6e64 2077 6964 7468 5f65 6172 6c79 203c  nd width_early <
+00004590: 2032 3030 303a 0a20 2020 2020 2020 2020   2000:.         
+000045a0: 2020 2069 6d67 5f77 5f6e 6577 203d 2032     img_w_new = 2
+000045b0: 3430 300a 2020 2020 2020 2020 2020 2020  400.            
+000045c0: 696d 675f 685f 6e65 7720 3d20 696e 7428  img_h_new = int(
+000045d0: 696d 672e 7368 6170 655b 305d 202f 2066  img.shape[0] / f
+000045e0: 6c6f 6174 2869 6d67 2e73 6861 7065 5b31  loat(img.shape[1
+000045f0: 5d29 202a 2032 3430 3029 0a20 2020 2020  ]) * 2400).     
+00004600: 2020 2065 6c69 6620 6e75 6d5f 636f 6c20     elif num_col 
+00004610: 3d3d 2032 2061 6e64 2077 6964 7468 5f65  == 2 and width_e
+00004620: 6172 6c79 203e 3d20 3335 3030 3a0a 2020  arly >= 3500:.  
+00004630: 2020 2020 2020 2020 2020 696d 675f 775f            img_w_
+00004640: 6e65 7720 3d20 3234 3030 0a20 2020 2020  new = 2400.     
+00004650: 2020 2020 2020 2069 6d67 5f68 5f6e 6577         img_h_new
+00004660: 203d 2069 6e74 2869 6d67 2e73 6861 7065   = int(img.shape
+00004670: 5b30 5d20 2f20 666c 6f61 7428 696d 672e  [0] / float(img.
+00004680: 7368 6170 655b 315d 2920 2a20 3234 3030  shape[1]) * 2400
+00004690: 290a 2020 2020 2020 2020 656c 6966 206e  ).        elif n
+000046a0: 756d 5f63 6f6c 203d 3d20 3220 616e 6420  um_col == 2 and 
+000046b0: 7769 6474 685f 6561 726c 7920 3e3d 2032  width_early >= 2
+000046c0: 3030 3020 616e 6420 7769 6474 685f 6561  000 and width_ea
+000046d0: 726c 7920 3c20 3335 3030 3a0a 2020 2020  rly < 3500:.    
+000046e0: 2020 2020 2020 2020 696d 675f 775f 6e65          img_w_ne
+000046f0: 7720 3d20 7769 6474 685f 6561 726c 790a  w = width_early.
+00004700: 2020 2020 2020 2020 2020 2020 696d 675f              img_
+00004710: 685f 6e65 7720 3d20 696e 7428 696d 672e  h_new = int(img.
+00004720: 7368 6170 655b 305d 202f 2066 6c6f 6174  shape[0] / float
+00004730: 2869 6d67 2e73 6861 7065 5b31 5d29 202a  (img.shape[1]) *
+00004740: 2077 6964 7468 5f65 6172 6c79 290a 2020   width_early).  
+00004750: 2020 2020 2020 656c 6966 206e 756d 5f63        elif num_c
+00004760: 6f6c 203d 3d20 3320 616e 6420 7769 6474  ol == 3 and widt
+00004770: 685f 6561 726c 7920 3c20 3230 3030 3a0a  h_early < 2000:.
+00004780: 2020 2020 2020 2020 2020 2020 696d 675f              img_
+00004790: 775f 6e65 7720 3d20 3330 3030 0a20 2020  w_new = 3000.   
+000047a0: 2020 2020 2020 2020 2069 6d67 5f68 5f6e           img_h_n
+000047b0: 6577 203d 2069 6e74 2869 6d67 2e73 6861  ew = int(img.sha
+000047c0: 7065 5b30 5d20 2f20 666c 6f61 7428 696d  pe[0] / float(im
+000047d0: 672e 7368 6170 655b 315d 2920 2a20 3330  g.shape[1]) * 30
+000047e0: 3030 290a 2020 2020 2020 2020 656c 6966  00).        elif
+000047f0: 206e 756d 5f63 6f6c 203d 3d20 3320 616e   num_col == 3 an
+00004800: 6420 7769 6474 685f 6561 726c 7920 3e3d  d width_early >=
+00004810: 2034 3030 303a 0a20 2020 2020 2020 2020   4000:.         
+00004820: 2020 2069 6d67 5f77 5f6e 6577 203d 2033     img_w_new = 3
+00004830: 3030 300a 2020 2020 2020 2020 2020 2020  000.            
+00004840: 696d 675f 685f 6e65 7720 3d20 696e 7428  img_h_new = int(
+00004850: 696d 672e 7368 6170 655b 305d 202f 2066  img.shape[0] / f
+00004860: 6c6f 6174 2869 6d67 2e73 6861 7065 5b31  loat(img.shape[1
+00004870: 5d29 202a 2033 3030 3029 0a20 2020 2020  ]) * 3000).     
+00004880: 2020 2065 6c69 6620 6e75 6d5f 636f 6c20     elif num_col 
+00004890: 3d3d 2033 2061 6e64 2077 6964 7468 5f65  == 3 and width_e
+000048a0: 6172 6c79 203e 3d20 3230 3030 2061 6e64  arly >= 2000 and
+000048b0: 2077 6964 7468 5f65 6172 6c79 203c 2034   width_early < 4
+000048c0: 3030 303a 0a20 2020 2020 2020 2020 2020  000:.           
+000048d0: 2069 6d67 5f77 5f6e 6577 203d 2077 6964   img_w_new = wid
+000048e0: 7468 5f65 6172 6c79 0a20 2020 2020 2020  th_early.       
+000048f0: 2020 2020 2069 6d67 5f68 5f6e 6577 203d       img_h_new =
+00004900: 2069 6e74 2869 6d67 2e73 6861 7065 5b30   int(img.shape[0
+00004910: 5d20 2f20 666c 6f61 7428 696d 672e 7368  ] / float(img.sh
+00004920: 6170 655b 315d 2920 2a20 7769 6474 685f  ape[1]) * width_
+00004930: 6561 726c 7929 0a20 2020 2020 2020 2065  early).        e
+00004940: 6c69 6620 6e75 6d5f 636f 6c20 3d3d 2034  lif num_col == 4
+00004950: 2061 6e64 2077 6964 7468 5f65 6172 6c79   and width_early
+00004960: 203c 2032 3530 303a 0a20 2020 2020 2020   < 2500:.       
+00004970: 2020 2020 2069 6d67 5f77 5f6e 6577 203d       img_w_new =
+00004980: 2034 3030 300a 2020 2020 2020 2020 2020   4000.          
+00004990: 2020 696d 675f 685f 6e65 7720 3d20 696e    img_h_new = in
+000049a0: 7428 696d 672e 7368 6170 655b 305d 202f  t(img.shape[0] /
+000049b0: 2066 6c6f 6174 2869 6d67 2e73 6861 7065   float(img.shape
+000049c0: 5b31 5d29 202a 2034 3030 3029 0a20 2020  [1]) * 4000).   
+000049d0: 2020 2020 2065 6c69 6620 6e75 6d5f 636f       elif num_co
+000049e0: 6c20 3d3d 2034 2061 6e64 2077 6964 7468  l == 4 and width
+000049f0: 5f65 6172 6c79 203e 3d20 3530 3030 3a0a  _early >= 5000:.
+00004a00: 2020 2020 2020 2020 2020 2020 696d 675f              img_
+00004a10: 775f 6e65 7720 3d20 3430 3030 0a20 2020  w_new = 4000.   
+00004a20: 2020 2020 2020 2020 2069 6d67 5f68 5f6e           img_h_n
+00004a30: 6577 203d 2069 6e74 2869 6d67 2e73 6861  ew = int(img.sha
+00004a40: 7065 5b30 5d20 2f20 666c 6f61 7428 696d  pe[0] / float(im
+00004a50: 672e 7368 6170 655b 315d 2920 2a20 3430  g.shape[1]) * 40
+00004a60: 3030 290a 2020 2020 2020 2020 656c 6966  00).        elif
+00004a70: 206e 756d 5f63 6f6c 203d 3d20 3420 616e   num_col == 4 an
+00004a80: 6420 7769 6474 685f 6561 726c 7920 3e3d  d width_early >=
+00004a90: 2032 3530 3020 616e 6420 7769 6474 685f   2500 and width_
+00004aa0: 6561 726c 7920 3c20 3530 3030 3a0a 2020  early < 5000:.  
+00004ab0: 2020 2020 2020 2020 2020 696d 675f 775f            img_w_
+00004ac0: 6e65 7720 3d20 7769 6474 685f 6561 726c  new = width_earl
+00004ad0: 790a 2020 2020 2020 2020 2020 2020 696d  y.            im
+00004ae0: 675f 685f 6e65 7720 3d20 696e 7428 696d  g_h_new = int(im
+00004af0: 672e 7368 6170 655b 305d 202f 2066 6c6f  g.shape[0] / flo
+00004b00: 6174 2869 6d67 2e73 6861 7065 5b31 5d29  at(img.shape[1])
+00004b10: 202a 2077 6964 7468 5f65 6172 6c79 290a   * width_early).
+00004b20: 2020 2020 2020 2020 656c 6966 206e 756d          elif num
+00004b30: 5f63 6f6c 203d 3d20 3520 616e 6420 7769  _col == 5 and wi
+00004b40: 6474 685f 6561 726c 7920 3c20 3337 3030  dth_early < 3700
+00004b50: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
+00004b60: 675f 775f 6e65 7720 3d20 3530 3030 0a20  g_w_new = 5000. 
+00004b70: 2020 2020 2020 2020 2020 2069 6d67 5f68             img_h
+00004b80: 5f6e 6577 203d 2069 6e74 2869 6d67 2e73  _new = int(img.s
+00004b90: 6861 7065 5b30 5d20 2f20 666c 6f61 7428  hape[0] / float(
+00004ba0: 696d 672e 7368 6170 655b 315d 2920 2a20  img.shape[1]) * 
+00004bb0: 3530 3030 290a 2020 2020 2020 2020 656c  5000).        el
+00004bc0: 6966 206e 756d 5f63 6f6c 203d 3d20 3520  if num_col == 5 
+00004bd0: 616e 6420 7769 6474 685f 6561 726c 7920  and width_early 
+00004be0: 3e3d 2037 3030 303a 0a20 2020 2020 2020  >= 7000:.       
+00004bf0: 2020 2020 2069 6d67 5f77 5f6e 6577 203d       img_w_new =
+00004c00: 2035 3030 300a 2020 2020 2020 2020 2020   5000.          
+00004c10: 2020 696d 675f 685f 6e65 7720 3d20 696e    img_h_new = in
+00004c20: 7428 696d 672e 7368 6170 655b 305d 202f  t(img.shape[0] /
+00004c30: 2066 6c6f 6174 2869 6d67 2e73 6861 7065   float(img.shape
+00004c40: 5b31 5d29 202a 2035 3030 3029 0a20 2020  [1]) * 5000).   
+00004c50: 2020 2020 2065 6c69 6620 6e75 6d5f 636f       elif num_co
+00004c60: 6c20 3d3d 2035 2061 6e64 2077 6964 7468  l == 5 and width
+00004c70: 5f65 6172 6c79 203e 3d20 3337 3030 2061  _early >= 3700 a
+00004c80: 6e64 2077 6964 7468 5f65 6172 6c79 203c  nd width_early <
+00004c90: 2037 3030 303a 0a20 2020 2020 2020 2020   7000:.         
+00004ca0: 2020 2069 6d67 5f77 5f6e 6577 203d 2077     img_w_new = w
+00004cb0: 6964 7468 5f65 6172 6c79 0a20 2020 2020  idth_early.     
+00004cc0: 2020 2020 2020 2069 6d67 5f68 5f6e 6577         img_h_new
+00004cd0: 203d 2069 6e74 2869 6d67 2e73 6861 7065   = int(img.shape
+00004ce0: 5b30 5d20 2f20 666c 6f61 7428 696d 672e  [0] / float(img.
+00004cf0: 7368 6170 655b 315d 2920 2a20 7769 6474  shape[1]) * widt
+00004d00: 685f 6561 726c 7929 0a20 2020 2020 2020  h_early).       
+00004d10: 2065 6c69 6620 6e75 6d5f 636f 6c20 3d3d   elif num_col ==
+00004d20: 2036 2061 6e64 2077 6964 7468 5f65 6172   6 and width_ear
+00004d30: 6c79 203c 2034 3530 303a 0a20 2020 2020  ly < 4500:.     
+00004d40: 2020 2020 2020 2069 6d67 5f77 5f6e 6577         img_w_new
+00004d50: 203d 2036 3530 3020 2023 2035 3430 300a   = 6500  # 5400.
+00004d60: 2020 2020 2020 2020 2020 2020 696d 675f              img_
+00004d70: 685f 6e65 7720 3d20 696e 7428 696d 672e  h_new = int(img.
+00004d80: 7368 6170 655b 305d 202f 2066 6c6f 6174  shape[0] / float
+00004d90: 2869 6d67 2e73 6861 7065 5b31 5d29 202a  (img.shape[1]) *
+00004da0: 2036 3530 3029 0a20 2020 2020 2020 2065   6500).        e
+00004db0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00004dc0: 2069 6d67 5f77 5f6e 6577 203d 2077 6964   img_w_new = wid
+00004dd0: 7468 5f65 6172 6c79 0a20 2020 2020 2020  th_early.       
+00004de0: 2020 2020 2069 6d67 5f68 5f6e 6577 203d       img_h_new =
+00004df0: 2069 6e74 2869 6d67 2e73 6861 7065 5b30   int(img.shape[0
+00004e00: 5d20 2f20 666c 6f61 7428 696d 672e 7368  ] / float(img.sh
+00004e10: 6170 655b 315d 2920 2a20 7769 6474 685f  ape[1]) * width_
+00004e20: 6561 726c 7929 0a0a 2020 2020 2020 2020  early)..        
+00004e30: 6966 206c 6162 656c 5f70 5f70 7265 645b  if label_p_pred[
+00004e40: 305d 5b69 6e74 286e 756d 5f63 6f6c 202d  0][int(num_col -
+00004e50: 2031 295d 203c 2030 2e39 2061 6e64 2069   1)] < 0.9 and i
+00004e60: 6d67 5f77 5f6e 6577 203c 2077 6964 7468  mg_w_new < width
+00004e70: 5f65 6172 6c79 3a0a 2020 2020 2020 2020  _early:.        
+00004e80: 2020 2020 696d 675f 6e65 7720 3d20 6e70      img_new = np
+00004e90: 2e63 6f70 7928 696d 6729 0a20 2020 2020  .copy(img).     
+00004ea0: 2020 2020 2020 206e 756d 5f63 6f6c 756d         num_colum
+00004eb0: 6e5f 6973 5f63 6c61 7373 6966 6965 6420  n_is_classified 
+00004ec0: 3d20 4661 6c73 650a 2020 2020 2020 2020  = False.        
+00004ed0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00004ee0: 2020 696d 675f 6e65 7720 3d20 7265 7369    img_new = resi
+00004ef0: 7a65 5f69 6d61 6765 2869 6d67 2c20 696d  ze_image(img, im
+00004f00: 675f 685f 6e65 772c 2069 6d67 5f77 5f6e  g_h_new, img_w_n
+00004f10: 6577 290a 2020 2020 2020 2020 2020 2020  ew).            
+00004f20: 6e75 6d5f 636f 6c75 6d6e 5f69 735f 636c  num_column_is_cl
+00004f30: 6173 7369 6669 6564 203d 2054 7275 650a  assified = True.
+00004f40: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+00004f50: 696d 675f 6e65 772c 206e 756d 5f63 6f6c  img_new, num_col
+00004f60: 756d 6e5f 6973 5f63 6c61 7373 6966 6965  umn_is_classifie
+00004f70: 640a 0a20 2020 2064 6566 2072 6573 697a  d..    def resiz
+00004f80: 655f 696d 6167 655f 7769 7468 5f63 6f6c  e_image_with_col
+00004f90: 756d 6e5f 636c 6173 7369 6669 6572 2873  umn_classifier(s
+00004fa0: 656c 662c 2069 735f 696d 6167 655f 656e  elf, is_image_en
+00004fb0: 6861 6e63 6564 2c20 696d 675f 6269 6e29  hanced, img_bin)
+00004fc0: 3a0a 2020 2020 2020 2020 7365 6c66 2e6c  :.        self.l
+00004fd0: 6f67 6765 722e 6465 6275 6728 2265 6e74  ogger.debug("ent
+00004fe0: 6572 2072 6573 697a 655f 696d 6167 655f  er resize_image_
+00004ff0: 7769 7468 5f63 6f6c 756d 6e5f 636c 6173  with_column_clas
+00005000: 7369 6669 6572 2229 0a20 2020 2020 2020  sifier").       
+00005010: 2069 6620 7365 6c66 2e69 6e70 7574 5f62   if self.input_b
+00005020: 696e 6172 793a 0a20 2020 2020 2020 2020  inary:.         
+00005030: 2020 2069 6d67 203d 206e 702e 636f 7079     img = np.copy
+00005040: 2869 6d67 5f62 696e 290a 2020 2020 2020  (img_bin).      
+00005050: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00005060: 2020 2020 696d 6720 3d20 7365 6c66 2e69      img = self.i
+00005070: 6d72 6561 6428 290a 0a20 2020 2020 2020  mread()..       
+00005080: 205f 2c20 7061 6765 5f63 6f6f 7264 203d   _, page_coord =
+00005090: 2073 656c 662e 6561 726c 795f 7061 6765   self.early_page
+000050a0: 5f66 6f72 5f6e 756d 5f6f 665f 636f 6c75  _for_num_of_colu
+000050b0: 6d6e 5f63 6c61 7373 6966 6963 6174 696f  mn_classificatio
+000050c0: 6e28 696d 6729 0a20 2020 2020 2020 2069  n(img).        i
+000050d0: 6620 6e6f 7420 7365 6c66 2e64 6972 5f69  f not self.dir_i
+000050e0: 6e3a 0a20 2020 2020 2020 2020 2020 206d  n:.            m
+000050f0: 6f64 656c 5f6e 756d 5f63 6c61 7373 6966  odel_num_classif
+00005100: 6965 722c 2073 6573 7369 6f6e 5f63 6f6c  ier, session_col
+00005110: 5f63 6c61 7373 6966 6965 7220 3d20 7365  _classifier = se
+00005120: 6c66 2e73 7461 7274 5f6e 6577 5f73 6573  lf.start_new_ses
+00005130: 7369 6f6e 5f61 6e64 5f6d 6f64 656c 2873  sion_and_model(s
+00005140: 656c 662e 6d6f 6465 6c5f 6469 725f 6f66  elf.model_dir_of
+00005150: 5f63 6f6c 5f63 6c61 7373 6966 6965 7229  _col_classifier)
+00005160: 0a20 2020 2020 2020 2069 6620 7365 6c66  .        if self
+00005170: 2e69 6e70 7574 5f62 696e 6172 793a 0a20  .input_binary:. 
+00005180: 2020 2020 2020 2020 2020 2069 6d67 5f69             img_i
+00005190: 6e20 3d20 6e70 2e63 6f70 7928 696d 6729  n = np.copy(img)
+000051a0: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
+000051b0: 5f69 6e20 3d20 696d 675f 696e 202f 2032  _in = img_in / 2
+000051c0: 3535 2e30 0a20 2020 2020 2020 2020 2020  55.0.           
+000051d0: 2077 6964 7468 5f65 6172 6c79 203d 2069   width_early = i
+000051e0: 6d67 5f69 6e2e 7368 6170 655b 315d 0a20  mg_in.shape[1]. 
+000051f0: 2020 2020 2020 2020 2020 2069 6d67 5f69             img_i
+00005200: 6e20 3d20 6376 322e 7265 7369 7a65 2869  n = cv2.resize(i
+00005210: 6d67 5f69 6e2c 2028 3434 382c 2034 3438  mg_in, (448, 448
+00005220: 292c 2069 6e74 6572 706f 6c61 7469 6f6e  ), interpolation
+00005230: 3d63 7632 2e49 4e54 4552 5f4e 4541 5245  =cv2.INTER_NEARE
+00005240: 5354 290a 2020 2020 2020 2020 2020 2020  ST).            
+00005250: 696d 675f 696e 203d 2069 6d67 5f69 6e2e  img_in = img_in.
+00005260: 7265 7368 6170 6528 312c 2034 3438 2c20  reshape(1, 448, 
+00005270: 3434 382c 2033 290a 2020 2020 2020 2020  448, 3).        
+00005280: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00005290: 2020 696d 675f 3163 6820 3d20 7365 6c66    img_1ch = self
+000052a0: 2e69 6d72 6561 6428 6772 6179 7363 616c  .imread(grayscal
+000052b0: 653d 5472 7565 2c20 7569 6e74 383d 4661  e=True, uint8=Fa
+000052c0: 6c73 6529 0a20 2020 2020 2020 2020 2020  lse).           
+000052d0: 2077 6964 7468 5f65 6172 6c79 203d 2069   width_early = i
+000052e0: 6d67 5f31 6368 2e73 6861 7065 5b31 5d0a  mg_1ch.shape[1].
+000052f0: 2020 2020 2020 2020 2020 2020 696d 675f              img_
+00005300: 3163 6820 3d20 696d 675f 3163 685b 7061  1ch = img_1ch[pa
+00005310: 6765 5f63 6f6f 7264 5b30 5d20 3a20 7061  ge_coord[0] : pa
+00005320: 6765 5f63 6f6f 7264 5b31 5d2c 2070 6167  ge_coord[1], pag
+00005330: 655f 636f 6f72 645b 325d 203a 2070 6167  e_coord[2] : pag
+00005340: 655f 636f 6f72 645b 335d 5d0a 0a20 2020  e_coord[3]]..   
+00005350: 2020 2020 2020 2020 2023 2070 6c74 2e69           # plt.i
+00005360: 6d73 686f 7728 696d 675f 3163 6829 0a20  mshow(img_1ch). 
+00005370: 2020 2020 2020 2020 2020 2023 2070 6c74             # plt
+00005380: 2e73 686f 7728 290a 2020 2020 2020 2020  .show().        
+00005390: 2020 2020 696d 675f 3163 6820 3d20 696d      img_1ch = im
+000053a0: 675f 3163 6820 2f20 3235 352e 300a 0a20  g_1ch / 255.0.. 
+000053b0: 2020 2020 2020 2020 2020 2069 6d67 5f31             img_1
+000053c0: 6368 203d 2063 7632 2e72 6573 697a 6528  ch = cv2.resize(
+000053d0: 696d 675f 3163 682c 2028 3434 382c 2034  img_1ch, (448, 4
+000053e0: 3438 292c 2069 6e74 6572 706f 6c61 7469  48), interpolati
+000053f0: 6f6e 3d63 7632 2e49 4e54 4552 5f4e 4541  on=cv2.INTER_NEA
+00005400: 5245 5354 290a 0a20 2020 2020 2020 2020  REST)..         
+00005410: 2020 2069 6d67 5f69 6e20 3d20 6e70 2e7a     img_in = np.z
+00005420: 6572 6f73 2828 312c 2069 6d67 5f31 6368  eros((1, img_1ch
+00005430: 2e73 6861 7065 5b30 5d2c 2069 6d67 5f31  .shape[0], img_1
+00005440: 6368 2e73 6861 7065 5b31 5d2c 2033 2929  ch.shape[1], 3))
+00005450: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
+00005460: 5f69 6e5b 302c 203a 2c20 3a2c 2030 5d20  _in[0, :, :, 0] 
+00005470: 3d20 696d 675f 3163 685b 3a2c 203a 5d0a  = img_1ch[:, :].
+00005480: 2020 2020 2020 2020 2020 2020 696d 675f              img_
+00005490: 696e 5b30 2c20 3a2c 203a 2c20 315d 203d  in[0, :, :, 1] =
+000054a0: 2069 6d67 5f31 6368 5b3a 2c20 3a5d 0a20   img_1ch[:, :]. 
+000054b0: 2020 2020 2020 2020 2020 2069 6d67 5f69             img_i
+000054c0: 6e5b 302c 203a 2c20 3a2c 2032 5d20 3d20  n[0, :, :, 2] = 
+000054d0: 696d 675f 3163 685b 3a2c 203a 5d0a 0a20  img_1ch[:, :].. 
+000054e0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+000054f0: 6c66 2e64 6972 5f69 6e3a 0a20 2020 2020  lf.dir_in:.     
+00005500: 2020 2020 2020 206c 6162 656c 5f70 5f70         label_p_p
+00005510: 7265 6420 3d20 6d6f 6465 6c5f 6e75 6d5f  red = model_num_
+00005520: 636c 6173 7369 6669 6572 2e70 7265 6469  classifier.predi
+00005530: 6374 2869 6d67 5f69 6e2c 2076 6572 626f  ct(img_in, verbo
+00005540: 7365 3d30 290a 2020 2020 2020 2020 656c  se=0).        el
+00005550: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00005560: 6c61 6265 6c5f 705f 7072 6564 203d 2073  label_p_pred = s
+00005570: 656c 662e 6d6f 6465 6c5f 636c 6173 7369  elf.model_classi
+00005580: 6669 6572 2e70 7265 6469 6374 2869 6d67  fier.predict(img
+00005590: 5f69 6e2c 2076 6572 626f 7365 3d30 290a  _in, verbose=0).
+000055a0: 0a20 2020 2020 2020 206e 756d 5f63 6f6c  .        num_col
+000055b0: 203d 206e 702e 6172 676d 6178 286c 6162   = np.argmax(lab
+000055c0: 656c 5f70 5f70 7265 645b 305d 2920 2b20  el_p_pred[0]) + 
+000055d0: 310a 0a20 2020 2020 2020 2073 656c 662e  1..        self.
+000055e0: 6c6f 6767 6572 2e69 6e66 6f28 2246 6f75  logger.info("Fou
+000055f0: 6e64 2025 7320 636f 6c75 6d6e 7320 2825  nd %s columns (%
+00005600: 7329 222c 206e 756d 5f63 6f6c 2c20 6c61  s)", num_col, la
+00005610: 6265 6c5f 705f 7072 6564 290a 0a20 2020  bel_p_pred)..   
+00005620: 2020 2020 2069 6d67 5f6e 6577 2c20 5f20       img_new, _ 
+00005630: 3d20 7365 6c66 2e63 616c 6375 6c61 7465  = self.calculate
+00005640: 5f77 6964 7468 5f68 6569 6768 745f 6279  _width_height_by
+00005650: 5f63 6f6c 756d 6e73 2869 6d67 2c20 6e75  _columns(img, nu
+00005660: 6d5f 636f 6c2c 2077 6964 7468 5f65 6172  m_col, width_ear
+00005670: 6c79 2c20 6c61 6265 6c5f 705f 7072 6564  ly, label_p_pred
+00005680: 290a 0a20 2020 2020 2020 2069 6620 696d  )..        if im
+00005690: 675f 6e65 772e 7368 6170 655b 315d 203e  g_new.shape[1] >
+000056a0: 2069 6d67 2e73 6861 7065 5b31 5d3a 0a20   img.shape[1]:. 
+000056b0: 2020 2020 2020 2020 2020 2069 6d67 5f6e             img_n
+000056c0: 6577 203d 2073 656c 662e 7072 6564 6963  ew = self.predic
+000056d0: 745f 656e 6861 6e63 656d 656e 7428 696d  t_enhancement(im
+000056e0: 675f 6e65 7729 0a20 2020 2020 2020 2020  g_new).         
+000056f0: 2020 2069 735f 696d 6167 655f 656e 6861     is_image_enha
+00005700: 6e63 6564 203d 2054 7275 650a 0a20 2020  nced = True..   
+00005710: 2020 2020 2072 6574 7572 6e20 696d 672c       return img,
+00005720: 2069 6d67 5f6e 6577 2c20 6973 5f69 6d61   img_new, is_ima
+00005730: 6765 5f65 6e68 616e 6365 640a 0a20 2020  ge_enhanced..   
+00005740: 2064 6566 2072 6573 697a 655f 616e 645f   def resize_and_
+00005750: 656e 6861 6e63 655f 696d 6167 655f 7769  enhance_image_wi
+00005760: 7468 5f63 6f6c 756d 6e5f 636c 6173 7369  th_column_classi
+00005770: 6669 6572 2873 656c 662c 6c69 6768 745f  fier(self,light_
+00005780: 7665 7273 696f 6e29 3a0a 2020 2020 2020  version):.      
+00005790: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
+000057a0: 6275 6728 2265 6e74 6572 2072 6573 697a  bug("enter resiz
+000057b0: 655f 616e 645f 656e 6861 6e63 655f 696d  e_and_enhance_im
+000057c0: 6167 655f 7769 7468 5f63 6f6c 756d 6e5f  age_with_column_
+000057d0: 636c 6173 7369 6669 6572 2229 0a20 2020  classifier").   
+000057e0: 2020 2020 2064 7069 203d 2073 656c 662e       dpi = self.
+000057f0: 6470 690a 2020 2020 2020 2020 7365 6c66  dpi.        self
+00005800: 2e6c 6f67 6765 722e 696e 666f 2822 4465  .logger.info("De
+00005810: 7465 6374 6564 2025 7320 4450 4922 2c20  tected %s DPI", 
+00005820: 6470 6929 0a20 2020 2020 2020 2069 6620  dpi).        if 
+00005830: 7365 6c66 2e69 6e70 7574 5f62 696e 6172  self.input_binar
+00005840: 793a 0a20 2020 2020 2020 2020 2020 2069  y:.            i
+00005850: 6d67 203d 2073 656c 662e 696d 7265 6164  mg = self.imread
+00005860: 2829 0a20 2020 2020 2020 2020 2020 2069  ().            i
+00005870: 6620 7365 6c66 2e64 6972 5f69 6e3a 0a20  f self.dir_in:. 
+00005880: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00005890: 7265 6469 6374 696f 6e5f 6269 6e20 3d20  rediction_bin = 
+000058a0: 7365 6c66 2e64 6f5f 7072 6564 6963 7469  self.do_predicti
+000058b0: 6f6e 2854 7275 652c 2069 6d67 2c20 7365  on(True, img, se
+000058c0: 6c66 2e6d 6f64 656c 5f62 696e 290a 2020  lf.model_bin).  
+000058d0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+000058e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000058f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00005900: 206d 6f64 656c 5f62 696e 2c20 7365 7373   model_bin, sess
+00005910: 696f 6e5f 6269 6e20 3d20 7365 6c66 2e73  ion_bin = self.s
+00005920: 7461 7274 5f6e 6577 5f73 6573 7369 6f6e  tart_new_session
+00005930: 5f61 6e64 5f6d 6f64 656c 2873 656c 662e  _and_model(self.
+00005940: 6d6f 6465 6c5f 6469 725f 6f66 5f62 696e  model_dir_of_bin
+00005950: 6172 697a 6174 696f 6e29 0a20 2020 2020  arization).     
+00005960: 2020 2020 2020 2020 2020 2070 7265 6469             predi
+00005970: 6374 696f 6e5f 6269 6e20 3d20 7365 6c66  ction_bin = self
+00005980: 2e64 6f5f 7072 6564 6963 7469 6f6e 2854  .do_prediction(T
+00005990: 7275 652c 2069 6d67 2c20 6d6f 6465 6c5f  rue, img, model_
+000059a0: 6269 6e29 0a20 2020 2020 2020 2020 2020  bin).           
+000059b0: 200a 2020 2020 2020 2020 2020 2020 7072   .            pr
+000059c0: 6564 6963 7469 6f6e 5f62 696e 3d70 7265  ediction_bin=pre
+000059d0: 6469 6374 696f 6e5f 6269 6e5b 3a2c 3a2c  diction_bin[:,:,
+000059e0: 305d 0a20 2020 2020 2020 2020 2020 2070  0].            p
+000059f0: 7265 6469 6374 696f 6e5f 6269 6e20 3d20  rediction_bin = 
+00005a00: 2870 7265 6469 6374 696f 6e5f 6269 6e5b  (prediction_bin[
+00005a10: 3a2c 3a5d 3d3d 3029 2a31 0a20 2020 2020  :,:]==0)*1.     
+00005a20: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
+00005a30: 6e5f 6269 6e20 3d20 7072 6564 6963 7469  n_bin = predicti
+00005a40: 6f6e 5f62 696e 2a32 3535 0a20 2020 2020  on_bin*255.     
+00005a50: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00005a60: 2020 2020 7072 6564 6963 7469 6f6e 5f62      prediction_b
+00005a70: 696e 203d 6e70 2e72 6570 6561 7428 7072  in =np.repeat(pr
+00005a80: 6564 6963 7469 6f6e 5f62 696e 5b3a 2c20  ediction_bin[:, 
+00005a90: 3a2c 206e 702e 6e65 7761 7869 735d 2c20  :, np.newaxis], 
+00005aa0: 332c 2061 7869 733d 3229 0a0a 2020 2020  3, axis=2)..    
+00005ab0: 2020 2020 2020 2020 7072 6564 6963 7469          predicti
+00005ac0: 6f6e 5f62 696e 203d 2070 7265 6469 6374  on_bin = predict
+00005ad0: 696f 6e5f 6269 6e2e 6173 7479 7065 286e  ion_bin.astype(n
+00005ae0: 702e 7569 6e74 3829 0a20 2020 2020 2020  p.uint8).       
+00005af0: 2020 2020 2069 6d67 3d20 6e70 2e63 6f70       img= np.cop
+00005b00: 7928 7072 6564 6963 7469 6f6e 5f62 696e  y(prediction_bin
+00005b10: 290a 2020 2020 2020 2020 2020 2020 696d  ).            im
+00005b20: 675f 6269 6e20 3d20 6e70 2e63 6f70 7928  g_bin = np.copy(
+00005b30: 7072 6564 6963 7469 6f6e 5f62 696e 290a  prediction_bin).
+00005b40: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00005b50: 2020 2020 2020 2020 2020 696d 6720 3d20            img = 
+00005b60: 7365 6c66 2e69 6d72 6561 6428 290a 2020  self.imread().  
+00005b70: 2020 2020 2020 2020 2020 696d 675f 6269            img_bi
+00005b80: 6e20 3d20 4e6f 6e65 0a0a 2020 2020 2020  n = None..      
+00005b90: 2020 7431 203d 2074 696d 652e 7469 6d65    t1 = time.time
+00005ba0: 2829 0a20 2020 2020 2020 205f 2c20 7061  ().        _, pa
+00005bb0: 6765 5f63 6f6f 7264 203d 2073 656c 662e  ge_coord = self.
+00005bc0: 6561 726c 795f 7061 6765 5f66 6f72 5f6e  early_page_for_n
+00005bd0: 756d 5f6f 665f 636f 6c75 6d6e 5f63 6c61  um_of_column_cla
+00005be0: 7373 6966 6963 6174 696f 6e28 696d 675f  ssification(img_
+00005bf0: 6269 6e29 0a20 2020 2020 2020 2069 6620  bin).        if 
+00005c00: 6e6f 7420 7365 6c66 2e64 6972 5f69 6e3a  not self.dir_in:
+00005c10: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
+00005c20: 656c 5f6e 756d 5f63 6c61 7373 6966 6965  el_num_classifie
+00005c30: 722c 2073 6573 7369 6f6e 5f63 6f6c 5f63  r, session_col_c
+00005c40: 6c61 7373 6966 6965 7220 3d20 7365 6c66  lassifier = self
+00005c50: 2e73 7461 7274 5f6e 6577 5f73 6573 7369  .start_new_sessi
+00005c60: 6f6e 5f61 6e64 5f6d 6f64 656c 2873 656c  on_and_model(sel
+00005c70: 662e 6d6f 6465 6c5f 6469 725f 6f66 5f63  f.model_dir_of_c
+00005c80: 6f6c 5f63 6c61 7373 6966 6965 7229 0a20  ol_classifier). 
+00005c90: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00005ca0: 6966 2073 656c 662e 696e 7075 745f 6269  if self.input_bi
+00005cb0: 6e61 7279 3a0a 2020 2020 2020 2020 2020  nary:.          
+00005cc0: 2020 696d 675f 696e 203d 206e 702e 636f    img_in = np.co
+00005cd0: 7079 2869 6d67 290a 2020 2020 2020 2020  py(img).        
+00005ce0: 2020 2020 7769 6474 685f 6561 726c 7920      width_early 
+00005cf0: 3d20 696d 675f 696e 2e73 6861 7065 5b31  = img_in.shape[1
+00005d00: 5d0a 2020 2020 2020 2020 2020 2020 696d  ].            im
+00005d10: 675f 696e 203d 2069 6d67 5f69 6e20 2f20  g_in = img_in / 
+00005d20: 3235 352e 300a 2020 2020 2020 2020 2020  255.0.          
+00005d30: 2020 696d 675f 696e 203d 2063 7632 2e72    img_in = cv2.r
+00005d40: 6573 697a 6528 696d 675f 696e 2c20 2834  esize(img_in, (4
+00005d50: 3438 2c20 3434 3829 2c20 696e 7465 7270  48, 448), interp
+00005d60: 6f6c 6174 696f 6e3d 6376 322e 494e 5445  olation=cv2.INTE
+00005d70: 525f 4e45 4152 4553 5429 0a20 2020 2020  R_NEAREST).     
+00005d80: 2020 2020 2020 2069 6d67 5f69 6e20 3d20         img_in = 
+00005d90: 696d 675f 696e 2e72 6573 6861 7065 2831  img_in.reshape(1
+00005da0: 2c20 3434 382c 2034 3438 2c20 3329 0a20  , 448, 448, 3). 
+00005db0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00005dc0: 2020 2020 2020 2020 2069 6d67 5f31 6368           img_1ch
+00005dd0: 203d 2073 656c 662e 696d 7265 6164 2867   = self.imread(g
+00005de0: 7261 7973 6361 6c65 3d54 7275 6529 0a20  rayscale=True). 
+00005df0: 2020 2020 2020 2020 2020 2077 6964 7468             width
+00005e00: 5f65 6172 6c79 203d 2069 6d67 5f31 6368  _early = img_1ch
+00005e10: 2e73 6861 7065 5b31 5d0a 2020 2020 2020  .shape[1].      
+00005e20: 2020 2020 2020 696d 675f 3163 6820 3d20        img_1ch = 
+00005e30: 696d 675f 3163 685b 7061 6765 5f63 6f6f  img_1ch[page_coo
+00005e40: 7264 5b30 5d20 3a20 7061 6765 5f63 6f6f  rd[0] : page_coo
+00005e50: 7264 5b31 5d2c 2070 6167 655f 636f 6f72  rd[1], page_coor
+00005e60: 645b 325d 203a 2070 6167 655f 636f 6f72  d[2] : page_coor
+00005e70: 645b 335d 5d0a 0a20 2020 2020 2020 2020  d[3]]..         
+00005e80: 2020 2069 6d67 5f31 6368 203d 2069 6d67     img_1ch = img
+00005e90: 5f31 6368 202f 2032 3535 2e30 0a20 2020  _1ch / 255.0.   
+00005ea0: 2020 2020 2020 2020 2069 6d67 5f31 6368           img_1ch
+00005eb0: 203d 2063 7632 2e72 6573 697a 6528 696d   = cv2.resize(im
+00005ec0: 675f 3163 682c 2028 3434 382c 2034 3438  g_1ch, (448, 448
+00005ed0: 292c 2069 6e74 6572 706f 6c61 7469 6f6e  ), interpolation
+00005ee0: 3d63 7632 2e49 4e54 4552 5f4e 4541 5245  =cv2.INTER_NEARE
+00005ef0: 5354 290a 2020 2020 2020 2020 2020 2020  ST).            
+00005f00: 696d 675f 696e 203d 206e 702e 7a65 726f  img_in = np.zero
+00005f10: 7328 2831 2c20 696d 675f 3163 682e 7368  s((1, img_1ch.sh
+00005f20: 6170 655b 305d 2c20 696d 675f 3163 682e  ape[0], img_1ch.
+00005f30: 7368 6170 655b 315d 2c20 3329 290a 2020  shape[1], 3)).  
+00005f40: 2020 2020 2020 2020 2020 696d 675f 696e            img_in
+00005f50: 5b30 2c20 3a2c 203a 2c20 305d 203d 2069  [0, :, :, 0] = i
+00005f60: 6d67 5f31 6368 5b3a 2c20 3a5d 0a20 2020  mg_1ch[:, :].   
+00005f70: 2020 2020 2020 2020 2069 6d67 5f69 6e5b           img_in[
+00005f80: 302c 203a 2c20 3a2c 2031 5d20 3d20 696d  0, :, :, 1] = im
+00005f90: 675f 3163 685b 3a2c 203a 5d0a 2020 2020  g_1ch[:, :].    
+00005fa0: 2020 2020 2020 2020 696d 675f 696e 5b30          img_in[0
+00005fb0: 2c20 3a2c 203a 2c20 325d 203d 2069 6d67  , :, :, 2] = img
+00005fc0: 5f31 6368 5b3a 2c20 3a5d 0a0a 0a20 2020  _1ch[:, :]...   
+00005fd0: 2020 2020 2069 6620 7365 6c66 2e64 6972       if self.dir
+00005fe0: 5f69 6e3a 0a20 2020 2020 2020 2020 2020  _in:.           
+00005ff0: 206c 6162 656c 5f70 5f70 7265 6420 3d20   label_p_pred = 
+00006000: 7365 6c66 2e6d 6f64 656c 5f63 6c61 7373  self.model_class
+00006010: 6966 6965 722e 7072 6564 6963 7428 696d  ifier.predict(im
+00006020: 675f 696e 2c20 7665 7262 6f73 653d 3029  g_in, verbose=0)
+00006030: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00006040: 2020 2020 2020 2020 2020 206c 6162 656c             label
+00006050: 5f70 5f70 7265 6420 3d20 6d6f 6465 6c5f  _p_pred = model_
+00006060: 6e75 6d5f 636c 6173 7369 6669 6572 2e70  num_classifier.p
+00006070: 7265 6469 6374 2869 6d67 5f69 6e2c 2076  redict(img_in, v
+00006080: 6572 626f 7365 3d30 290a 2020 2020 2020  erbose=0).      
+00006090: 2020 6e75 6d5f 636f 6c20 3d20 6e70 2e61    num_col = np.a
+000060a0: 7267 6d61 7828 6c61 6265 6c5f 705f 7072  rgmax(label_p_pr
+000060b0: 6564 5b30 5d29 202b 2031 0a20 2020 2020  ed[0]) + 1.     
+000060c0: 2020 200a 2020 2020 2020 2020 7365 6c66     .        self
+000060d0: 2e6c 6f67 6765 722e 696e 666f 2822 466f  .logger.info("Fo
+000060e0: 756e 6420 2564 2063 6f6c 756d 6e73 2028  und %d columns (
+000060f0: 2573 2922 2c20 6e75 6d5f 636f 6c2c 206e  %s)", num_col, n
+00006100: 702e 6172 6f75 6e64 286c 6162 656c 5f70  p.around(label_p
+00006110: 5f70 7265 642c 2064 6563 696d 616c 733d  _pred, decimals=
+00006120: 3529 290a 0a20 2020 2020 2020 2069 6620  5))..        if 
+00006130: 6470 6920 3c20 4450 495f 5448 5245 5348  dpi < DPI_THRESH
+00006140: 4f4c 443a 0a20 2020 2020 2020 2020 2020  OLD:.           
+00006150: 2069 6d67 5f6e 6577 2c20 6e75 6d5f 636f   img_new, num_co
+00006160: 6c75 6d6e 5f69 735f 636c 6173 7369 6669  lumn_is_classifi
+00006170: 6564 203d 2073 656c 662e 6361 6c63 756c  ed = self.calcul
+00006180: 6174 655f 7769 6474 685f 6865 6967 6874  ate_width_height
+00006190: 5f62 795f 636f 6c75 6d6e 7328 696d 672c  _by_columns(img,
+000061a0: 206e 756d 5f63 6f6c 2c20 7769 6474 685f   num_col, width_
+000061b0: 6561 726c 792c 206c 6162 656c 5f70 5f70  early, label_p_p
+000061c0: 7265 6429 0a20 2020 2020 2020 2020 2020  red).           
+000061d0: 2069 6620 6c69 6768 745f 7665 7273 696f   if light_versio
+000061e0: 6e3a 0a20 2020 2020 2020 2020 2020 2020  n:.             
+000061f0: 2020 2069 6d61 6765 5f72 6573 203d 206e     image_res = n
+00006200: 702e 636f 7079 2869 6d67 5f6e 6577 290a  p.copy(img_new).
+00006210: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00006220: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00006230: 2020 696d 6167 655f 7265 7320 3d20 7365    image_res = se
+00006240: 6c66 2e70 7265 6469 6374 5f65 6e68 616e  lf.predict_enhan
+00006250: 6365 6d65 6e74 2869 6d67 5f6e 6577 290a  cement(img_new).
+00006260: 2020 2020 2020 2020 2020 2020 6973 5f69              is_i
+00006270: 6d61 6765 5f65 6e68 616e 6365 6420 3d20  mage_enhanced = 
+00006280: 5472 7565 0a20 2020 2020 2020 2065 6c73  True.        els
+00006290: 653a 0a20 2020 2020 2020 2020 2020 206e  e:.            n
+000062a0: 756d 5f63 6f6c 756d 6e5f 6973 5f63 6c61  um_column_is_cla
+000062b0: 7373 6966 6965 6420 3d20 5472 7565 0a20  ssified = True. 
+000062c0: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+000062d0: 5f72 6573 203d 206e 702e 636f 7079 2869  _res = np.copy(i
+000062e0: 6d67 290a 2020 2020 2020 2020 2020 2020  mg).            
+000062f0: 6973 5f69 6d61 6765 5f65 6e68 616e 6365  is_image_enhance
+00006300: 6420 3d20 4661 6c73 650a 0a20 2020 2020  d = False..     
+00006310: 2020 2073 656c 662e 6c6f 6767 6572 2e64     self.logger.d
+00006320: 6562 7567 2822 6578 6974 2072 6573 697a  ebug("exit resiz
+00006330: 655f 616e 645f 656e 6861 6e63 655f 696d  e_and_enhance_im
+00006340: 6167 655f 7769 7468 5f63 6f6c 756d 6e5f  age_with_column_
+00006350: 636c 6173 7369 6669 6572 2229 0a20 2020  classifier").   
+00006360: 2020 2020 2072 6574 7572 6e20 6973 5f69       return is_i
+00006370: 6d61 6765 5f65 6e68 616e 6365 642c 2069  mage_enhanced, i
+00006380: 6d67 2c20 696d 6167 655f 7265 732c 206e  mg, image_res, n
+00006390: 756d 5f63 6f6c 2c20 6e75 6d5f 636f 6c75  um_col, num_colu
+000063a0: 6d6e 5f69 735f 636c 6173 7369 6669 6564  mn_is_classified
+000063b0: 2c20 696d 675f 6269 6e0a 0a20 2020 2023  , img_bin..    #
+000063c0: 2070 796c 696e 743a 2064 6973 6162 6c65   pylint: disable
+000063d0: 3d61 7474 7269 6275 7465 2d64 6566 696e  =attribute-defin
+000063e0: 6564 2d6f 7574 7369 6465 2d69 6e69 740a  ed-outside-init.
+000063f0: 2020 2020 6465 6620 6765 745f 696d 6167      def get_imag
+00006400: 655f 616e 645f 7363 616c 6573 2873 656c  e_and_scales(sel
+00006410: 662c 2069 6d67 5f6f 7267 2c20 696d 675f  f, img_org, img_
+00006420: 7265 732c 2073 6361 6c65 293a 0a20 2020  res, scale):.   
+00006430: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
+00006440: 2e64 6562 7567 2822 656e 7465 7220 6765  .debug("enter ge
+00006450: 745f 696d 6167 655f 616e 645f 7363 616c  t_image_and_scal
+00006460: 6573 2229 0a20 2020 2020 2020 2073 656c  es").        sel
+00006470: 662e 696d 6167 6520 3d20 6e70 2e63 6f70  f.image = np.cop
+00006480: 7928 696d 675f 7265 7329 0a20 2020 2020  y(img_res).     
+00006490: 2020 2073 656c 662e 696d 6167 655f 6f72     self.image_or
+000064a0: 6720 3d20 6e70 2e63 6f70 7928 696d 675f  g = np.copy(img_
+000064b0: 6f72 6729 0a20 2020 2020 2020 2073 656c  org).        sel
+000064c0: 662e 6865 6967 6874 5f6f 7267 203d 2073  f.height_org = s
+000064d0: 656c 662e 696d 6167 652e 7368 6170 655b  elf.image.shape[
+000064e0: 305d 0a20 2020 2020 2020 2073 656c 662e  0].        self.
+000064f0: 7769 6474 685f 6f72 6720 3d20 7365 6c66  width_org = self
+00006500: 2e69 6d61 6765 2e73 6861 7065 5b31 5d0a  .image.shape[1].
+00006510: 0a20 2020 2020 2020 2073 656c 662e 696d  .        self.im
+00006520: 675f 6869 6768 745f 696e 7420 3d20 696e  g_hight_int = in
+00006530: 7428 7365 6c66 2e69 6d61 6765 2e73 6861  t(self.image.sha
+00006540: 7065 5b30 5d20 2a20 7363 616c 6529 0a20  pe[0] * scale). 
+00006550: 2020 2020 2020 2073 656c 662e 696d 675f         self.img_
+00006560: 7769 6474 685f 696e 7420 3d20 696e 7428  width_int = int(
+00006570: 7365 6c66 2e69 6d61 6765 2e73 6861 7065  self.image.shape
+00006580: 5b31 5d20 2a20 7363 616c 6529 0a20 2020  [1] * scale).   
+00006590: 2020 2020 2073 656c 662e 7363 616c 655f       self.scale_
+000065a0: 7920 3d20 7365 6c66 2e69 6d67 5f68 6967  y = self.img_hig
+000065b0: 6874 5f69 6e74 202f 2066 6c6f 6174 2873  ht_int / float(s
+000065c0: 656c 662e 696d 6167 652e 7368 6170 655b  elf.image.shape[
+000065d0: 305d 290a 2020 2020 2020 2020 7365 6c66  0]).        self
+000065e0: 2e73 6361 6c65 5f78 203d 2073 656c 662e  .scale_x = self.
+000065f0: 696d 675f 7769 6474 685f 696e 7420 2f20  img_width_int / 
+00006600: 666c 6f61 7428 7365 6c66 2e69 6d61 6765  float(self.image
+00006610: 2e73 6861 7065 5b31 5d29 0a0a 2020 2020  .shape[1])..    
+00006620: 2020 2020 7365 6c66 2e69 6d61 6765 203d      self.image =
+00006630: 2072 6573 697a 655f 696d 6167 6528 7365   resize_image(se
+00006640: 6c66 2e69 6d61 6765 2c20 7365 6c66 2e69  lf.image, self.i
+00006650: 6d67 5f68 6967 6874 5f69 6e74 2c20 7365  mg_hight_int, se
+00006660: 6c66 2e69 6d67 5f77 6964 7468 5f69 6e74  lf.img_width_int
+00006670: 290a 0a20 2020 2020 2020 2023 2041 6c73  )..        # Als
+00006680: 6f20 7365 7420 666f 7220 7468 6520 706c  o set for the pl
+00006690: 6f74 7465 720a 2020 2020 2020 2020 6966  otter.        if
+000066a0: 2073 656c 662e 706c 6f74 7465 723a 0a20   self.plotter:. 
+000066b0: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+000066c0: 706c 6f74 7465 722e 696d 6167 655f 6f72  plotter.image_or
+000066d0: 6720 3d20 7365 6c66 2e69 6d61 6765 5f6f  g = self.image_o
+000066e0: 7267 0a20 2020 2020 2020 2020 2020 2073  rg.            s
+000066f0: 656c 662e 706c 6f74 7465 722e 7363 616c  elf.plotter.scal
+00006700: 655f 7920 3d20 7365 6c66 2e73 6361 6c65  e_y = self.scale
+00006710: 5f79 0a20 2020 2020 2020 2020 2020 2073  _y.            s
+00006720: 656c 662e 706c 6f74 7465 722e 7363 616c  elf.plotter.scal
+00006730: 655f 7820 3d20 7365 6c66 2e73 6361 6c65  e_x = self.scale
+00006740: 5f78 0a20 2020 2020 2020 2023 2041 6c73  _x.        # Als
+00006750: 6f20 7365 7420 666f 7220 7468 6520 7772  o set for the wr
+00006760: 6974 6572 0a20 2020 2020 2020 2073 656c  iter.        sel
+00006770: 662e 7772 6974 6572 2e69 6d61 6765 5f6f  f.writer.image_o
+00006780: 7267 203d 2073 656c 662e 696d 6167 655f  rg = self.image_
+00006790: 6f72 670a 2020 2020 2020 2020 7365 6c66  org.        self
+000067a0: 2e77 7269 7465 722e 7363 616c 655f 7920  .writer.scale_y 
+000067b0: 3d20 7365 6c66 2e73 6361 6c65 5f79 0a20  = self.scale_y. 
+000067c0: 2020 2020 2020 2073 656c 662e 7772 6974         self.writ
+000067d0: 6572 2e73 6361 6c65 5f78 203d 2073 656c  er.scale_x = sel
+000067e0: 662e 7363 616c 655f 780a 2020 2020 2020  f.scale_x.      
+000067f0: 2020 7365 6c66 2e77 7269 7465 722e 6865    self.writer.he
+00006800: 6967 6874 5f6f 7267 203d 2073 656c 662e  ight_org = self.
+00006810: 6865 6967 6874 5f6f 7267 0a20 2020 2020  height_org.     
+00006820: 2020 2073 656c 662e 7772 6974 6572 2e77     self.writer.w
+00006830: 6964 7468 5f6f 7267 203d 2073 656c 662e  idth_org = self.
+00006840: 7769 6474 685f 6f72 670a 0a20 2020 2064  width_org..    d
+00006850: 6566 2067 6574 5f69 6d61 6765 5f61 6e64  ef get_image_and
+00006860: 5f73 6361 6c65 735f 6166 7465 725f 656e  _scales_after_en
+00006870: 6861 6e63 696e 6728 7365 6c66 2c20 696d  hancing(self, im
+00006880: 675f 6f72 672c 2069 6d67 5f72 6573 293a  g_org, img_res):
+00006890: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+000068a0: 6767 6572 2e64 6562 7567 2822 656e 7465  gger.debug("ente
+000068b0: 7220 6765 745f 696d 6167 655f 616e 645f  r get_image_and_
+000068c0: 7363 616c 6573 5f61 6674 6572 5f65 6e68  scales_after_enh
+000068d0: 616e 6369 6e67 2229 0a20 2020 2020 2020  ancing").       
+000068e0: 2073 656c 662e 696d 6167 6520 3d20 6e70   self.image = np
+000068f0: 2e63 6f70 7928 696d 675f 7265 7329 0a20  .copy(img_res). 
+00006900: 2020 2020 2020 2073 656c 662e 696d 6167         self.imag
+00006910: 6520 3d20 7365 6c66 2e69 6d61 6765 2e61  e = self.image.a
+00006920: 7374 7970 6528 6e70 2e75 696e 7438 290a  stype(np.uint8).
+00006930: 2020 2020 2020 2020 7365 6c66 2e69 6d61          self.ima
+00006940: 6765 5f6f 7267 203d 206e 702e 636f 7079  ge_org = np.copy
+00006950: 2869 6d67 5f6f 7267 290a 2020 2020 2020  (img_org).      
+00006960: 2020 7365 6c66 2e68 6569 6768 745f 6f72    self.height_or
+00006970: 6720 3d20 7365 6c66 2e69 6d61 6765 5f6f  g = self.image_o
+00006980: 7267 2e73 6861 7065 5b30 5d0a 2020 2020  rg.shape[0].    
+00006990: 2020 2020 7365 6c66 2e77 6964 7468 5f6f      self.width_o
+000069a0: 7267 203d 2073 656c 662e 696d 6167 655f  rg = self.image_
+000069b0: 6f72 672e 7368 6170 655b 315d 0a0a 2020  org.shape[1]..  
+000069c0: 2020 2020 2020 7365 6c66 2e73 6361 6c65        self.scale
+000069d0: 5f79 203d 2069 6d67 5f72 6573 2e73 6861  _y = img_res.sha
+000069e0: 7065 5b30 5d20 2f20 666c 6f61 7428 7365  pe[0] / float(se
+000069f0: 6c66 2e69 6d61 6765 5f6f 7267 2e73 6861  lf.image_org.sha
+00006a00: 7065 5b30 5d29 0a20 2020 2020 2020 2073  pe[0]).        s
+00006a10: 656c 662e 7363 616c 655f 7820 3d20 696d  elf.scale_x = im
+00006a20: 675f 7265 732e 7368 6170 655b 315d 202f  g_res.shape[1] /
+00006a30: 2066 6c6f 6174 2873 656c 662e 696d 6167   float(self.imag
+00006a40: 655f 6f72 672e 7368 6170 655b 315d 290a  e_org.shape[1]).
+00006a50: 0a20 2020 2020 2020 2023 2041 6c73 6f20  .        # Also 
+00006a60: 7365 7420 666f 7220 7468 6520 706c 6f74  set for the plot
+00006a70: 7465 720a 2020 2020 2020 2020 6966 2073  ter.        if s
+00006a80: 656c 662e 706c 6f74 7465 723a 0a20 2020  elf.plotter:.   
+00006a90: 2020 2020 2020 2020 2073 656c 662e 706c           self.pl
+00006aa0: 6f74 7465 722e 696d 6167 655f 6f72 6720  otter.image_org 
+00006ab0: 3d20 7365 6c66 2e69 6d61 6765 5f6f 7267  = self.image_org
+00006ac0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00006ad0: 662e 706c 6f74 7465 722e 7363 616c 655f  f.plotter.scale_
+00006ae0: 7920 3d20 7365 6c66 2e73 6361 6c65 5f79  y = self.scale_y
+00006af0: 0a20 2020 2020 2020 2020 2020 2073 656c  .            sel
+00006b00: 662e 706c 6f74 7465 722e 7363 616c 655f  f.plotter.scale_
+00006b10: 7820 3d20 7365 6c66 2e73 6361 6c65 5f78  x = self.scale_x
+00006b20: 0a20 2020 2020 2020 2023 2041 6c73 6f20  .        # Also 
+00006b30: 7365 7420 666f 7220 7468 6520 7772 6974  set for the writ
+00006b40: 6572 0a20 2020 2020 2020 2073 656c 662e  er.        self.
+00006b50: 7772 6974 6572 2e69 6d61 6765 5f6f 7267  writer.image_org
+00006b60: 203d 2073 656c 662e 696d 6167 655f 6f72   = self.image_or
+00006b70: 670a 2020 2020 2020 2020 7365 6c66 2e77  g.        self.w
+00006b80: 7269 7465 722e 7363 616c 655f 7920 3d20  riter.scale_y = 
+00006b90: 7365 6c66 2e73 6361 6c65 5f79 0a20 2020  self.scale_y.   
+00006ba0: 2020 2020 2073 656c 662e 7772 6974 6572       self.writer
+00006bb0: 2e73 6361 6c65 5f78 203d 2073 656c 662e  .scale_x = self.
+00006bc0: 7363 616c 655f 780a 2020 2020 2020 2020  scale_x.        
+00006bd0: 7365 6c66 2e77 7269 7465 722e 6865 6967  self.writer.heig
+00006be0: 6874 5f6f 7267 203d 2073 656c 662e 6865  ht_org = self.he
+00006bf0: 6967 6874 5f6f 7267 0a20 2020 2020 2020  ight_org.       
+00006c00: 2073 656c 662e 7772 6974 6572 2e77 6964   self.writer.wid
+00006c10: 7468 5f6f 7267 203d 2073 656c 662e 7769  th_org = self.wi
+00006c20: 6474 685f 6f72 670a 0a20 2020 2064 6566  dth_org..    def
+00006c30: 2073 7461 7274 5f6e 6577 5f73 6573 7369   start_new_sessi
+00006c40: 6f6e 5f61 6e64 5f6d 6f64 656c 5f6f 6c64  on_and_model_old
+00006c50: 2873 656c 662c 206d 6f64 656c 5f64 6972  (self, model_dir
+00006c60: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00006c70: 6c6f 6767 6572 2e64 6562 7567 2822 656e  logger.debug("en
+00006c80: 7465 7220 7374 6172 745f 6e65 775f 7365  ter start_new_se
+00006c90: 7373 696f 6e5f 616e 645f 6d6f 6465 6c20  ssion_and_model 
+00006ca0: 286d 6f64 656c 5f64 6972 3d25 7329 222c  (model_dir=%s)",
+00006cb0: 206d 6f64 656c 5f64 6972 290a 2020 2020   model_dir).    
+00006cc0: 2020 2020 636f 6e66 6967 203d 2074 662e      config = tf.
+00006cd0: 436f 6e66 6967 5072 6f74 6f28 290a 2020  ConfigProto().  
+00006ce0: 2020 2020 2020 636f 6e66 6967 2e67 7075        config.gpu
+00006cf0: 5f6f 7074 696f 6e73 2e61 6c6c 6f77 5f67  _options.allow_g
+00006d00: 726f 7774 6820 3d20 5472 7565 0a0a 2020  rowth = True..  
+00006d10: 2020 2020 2020 7365 7373 696f 6e20 3d20        session = 
+00006d20: 7466 2e49 6e74 6572 6163 7469 7665 5365  tf.InteractiveSe
+00006d30: 7373 696f 6e28 290a 2020 2020 2020 2020  ssion().        
+00006d40: 6d6f 6465 6c20 3d20 6c6f 6164 5f6d 6f64  model = load_mod
+00006d50: 656c 286d 6f64 656c 5f64 6972 2c20 636f  el(model_dir, co
+00006d60: 6d70 696c 653d 4661 6c73 6529 0a0a 2020  mpile=False)..  
+00006d70: 2020 2020 2020 7265 7475 726e 206d 6f64        return mod
+00006d80: 656c 2c20 7365 7373 696f 6e0a 0a20 2020  el, session..   
+00006d90: 200a 2020 2020 6465 6620 7374 6172 745f   .    def start_
+00006da0: 6e65 775f 7365 7373 696f 6e5f 616e 645f  new_session_and_
+00006db0: 6d6f 6465 6c28 7365 6c66 2c20 6d6f 6465  model(self, mode
+00006dc0: 6c5f 6469 7229 3a0a 2020 2020 2020 2020  l_dir):.        
+00006dd0: 7365 6c66 2e6c 6f67 6765 722e 6465 6275  self.logger.debu
+00006de0: 6728 2265 6e74 6572 2073 7461 7274 5f6e  g("enter start_n
+00006df0: 6577 5f73 6573 7369 6f6e 5f61 6e64 5f6d  ew_session_and_m
+00006e00: 6f64 656c 2028 6d6f 6465 6c5f 6469 723d  odel (model_dir=
+00006e10: 2573 2922 2c20 6d6f 6465 6c5f 6469 7229  %s)", model_dir)
+00006e20: 0a20 2020 2020 2020 2023 6770 755f 6f70  .        #gpu_op
+00006e30: 7469 6f6e 7320 3d20 7466 2e63 6f6d 7061  tions = tf.compa
+00006e40: 742e 7631 2e47 5055 4f70 7469 6f6e 7328  t.v1.GPUOptions(
+00006e50: 616c 6c6f 775f 6772 6f77 7468 3d54 7275  allow_growth=Tru
+00006e60: 6529 0a20 2020 2020 2020 2023 6770 755f  e).        #gpu_
+00006e70: 6f70 7469 6f6e 7320 3d20 7466 2e63 6f6d  options = tf.com
+00006e80: 7061 742e 7631 2e47 5055 4f70 7469 6f6e  pat.v1.GPUOption
+00006e90: 7328 7065 725f 7072 6f63 6573 735f 6770  s(per_process_gp
+00006ea0: 755f 6d65 6d6f 7279 5f66 7261 6374 696f  u_memory_fractio
+00006eb0: 6e3d 372e 372c 2061 6c6c 6f77 5f67 726f  n=7.7, allow_gro
+00006ec0: 7774 683d 5472 7565 290a 2020 2020 2020  wth=True).      
+00006ed0: 2020 2373 6573 7369 6f6e 203d 2074 662e    #session = tf.
+00006ee0: 636f 6d70 6174 2e76 312e 5365 7373 696f  compat.v1.Sessio
+00006ef0: 6e28 636f 6e66 6967 3d74 662e 636f 6d70  n(config=tf.comp
+00006f00: 6174 2e76 312e 436f 6e66 6967 5072 6f74  at.v1.ConfigProt
+00006f10: 6f28 6770 755f 6f70 7469 6f6e 733d 6770  o(gpu_options=gp
+00006f20: 755f 6f70 7469 6f6e 7329 290a 2020 2020  u_options)).    
+00006f30: 2020 2020 7068 7973 6963 616c 5f64 6576      physical_dev
+00006f40: 6963 6573 203d 2074 662e 636f 6e66 6967  ices = tf.config
+00006f50: 2e6c 6973 745f 7068 7973 6963 616c 5f64  .list_physical_d
+00006f60: 6576 6963 6573 2827 4750 5527 290a 2020  evices('GPU').  
+00006f70: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+00006f80: 2020 2020 2020 2066 6f72 2064 6576 6963         for devic
+00006f90: 6520 696e 2070 6879 7369 6361 6c5f 6465  e in physical_de
+00006fa0: 7669 6365 733a 0a20 2020 2020 2020 2020  vices:.         
+00006fb0: 2020 2020 2020 2074 662e 636f 6e66 6967         tf.config
+00006fc0: 2e65 7870 6572 696d 656e 7461 6c2e 7365  .experimental.se
+00006fd0: 745f 6d65 6d6f 7279 5f67 726f 7774 6828  t_memory_growth(
+00006fe0: 6465 7669 6365 2c20 5472 7565 290a 2020  device, True).  
+00006ff0: 2020 2020 2020 6578 6365 7074 3a0a 2020        except:.  
+00007000: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+00007010: 6f67 6765 722e 7761 726e 696e 6728 226e  ogger.warning("n
+00007020: 6f20 4750 5520 6465 7669 6365 2061 7661  o GPU device ava
+00007030: 696c 6162 6c65 2229 0a0a 2020 2020 2020  ilable")..      
+00007040: 2020 6966 206d 6f64 656c 5f64 6972 2e65    if model_dir.e
+00007050: 6e64 7377 6974 6828 272e 6835 2729 2061  ndswith('.h5') a
+00007060: 6e64 2050 6174 6828 6d6f 6465 6c5f 6469  nd Path(model_di
+00007070: 725b 3a2d 335d 292e 6578 6973 7473 2829  r[:-3]).exists()
+00007080: 3a0a 2020 2020 2020 2020 2020 2020 2320  :.            # 
+00007090: 7072 6566 6572 2053 6176 6564 4d6f 6465  prefer SavedMode
+000070a0: 6c20 6f76 6572 2048 4446 3520 666f 726d  l over HDF5 form
+000070b0: 6174 2069 6620 6974 2065 7869 7374 730a  at if it exists.
+000070c0: 2020 2020 2020 2020 2020 2020 6d6f 6465              mode
+000070d0: 6c5f 6469 7220 3d20 6d6f 6465 6c5f 6469  l_dir = model_di
+000070e0: 725b 3a2d 335d 0a20 2020 2020 2020 2069  r[:-3].        i
+000070f0: 6620 6d6f 6465 6c5f 6469 7220 696e 2073  f model_dir in s
+00007100: 656c 662e 6d6f 6465 6c73 3a0a 2020 2020  elf.models:.    
+00007110: 2020 2020 2020 2020 6d6f 6465 6c20 3d20          model = 
+00007120: 7365 6c66 2e6d 6f64 656c 735b 6d6f 6465  self.models[mode
+00007130: 6c5f 6469 725d 0a20 2020 2020 2020 2065  l_dir].        e
+00007140: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00007150: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
+00007160: 2020 2020 2020 6d6f 6465 6c20 3d20 6c6f        model = lo
+00007170: 6164 5f6d 6f64 656c 286d 6f64 656c 5f64  ad_model(model_d
+00007180: 6972 2c20 636f 6d70 696c 653d 4661 6c73  ir, compile=Fals
+00007190: 6529 0a20 2020 2020 2020 2020 2020 2020  e).             
+000071a0: 2020 2073 656c 662e 6d6f 6465 6c73 5b6d     self.models[m
+000071b0: 6f64 656c 5f64 6972 5d20 3d20 6d6f 6465  odel_dir] = mode
+000071c0: 6c0a 2020 2020 2020 2020 2020 2020 6578  l.            ex
+000071d0: 6365 7074 3a0a 2020 2020 2020 2020 2020  cept:.          
+000071e0: 2020 2020 2020 6d6f 6465 6c20 3d20 6c6f        model = lo
+000071f0: 6164 5f6d 6f64 656c 286d 6f64 656c 5f64  ad_model(model_d
+00007200: 6972 202c 2063 6f6d 7069 6c65 3d46 616c  ir , compile=Fal
+00007210: 7365 2c63 7573 746f 6d5f 6f62 6a65 6374  se,custom_object
+00007220: 7320 3d20 7b22 5061 7463 6845 6e63 6f64  s = {"PatchEncod
+00007230: 6572 223a 2050 6174 6368 456e 636f 6465  er": PatchEncode
+00007240: 722c 2022 5061 7463 6865 7322 3a20 5061  r, "Patches": Pa
+00007250: 7463 6865 737d 290a 2020 2020 2020 2020  tches}).        
+00007260: 2020 2020 2020 2020 7365 6c66 2e6d 6f64          self.mod
+00007270: 656c 735b 6d6f 6465 6c5f 6469 725d 203d  els[model_dir] =
+00007280: 206d 6f64 656c 0a0a 0a20 2020 2020 2020   model...       
+00007290: 2072 6574 7572 6e20 6d6f 6465 6c2c 204e   return model, N
+000072a0: 6f6e 650a 0a20 2020 2064 6566 2064 6f5f  one..    def do_
+000072b0: 7072 6564 6963 7469 6f6e 2873 656c 662c  prediction(self,
+000072c0: 2070 6174 6368 6573 2c20 696d 672c 206d   patches, img, m
+000072d0: 6f64 656c 2c20 6d61 7267 696e 616c 5f6f  odel, marginal_o
+000072e0: 665f 7061 7463 685f 7065 7263 656e 743d  f_patch_percent=
+000072f0: 302e 3129 3a0a 2020 2020 2020 2020 7365  0.1):.        se
+00007300: 6c66 2e6c 6f67 6765 722e 6465 6275 6728  lf.logger.debug(
+00007310: 2265 6e74 6572 2064 6f5f 7072 6564 6963  "enter do_predic
+00007320: 7469 6f6e 2229 0a0a 2020 2020 2020 2020  tion")..        
+00007330: 696d 675f 6865 6967 6874 5f6d 6f64 656c  img_height_model
+00007340: 203d 206d 6f64 656c 2e6c 6179 6572 735b   = model.layers[
+00007350: 6c65 6e28 6d6f 6465 6c2e 6c61 7965 7273  len(model.layers
+00007360: 2920 2d20 315d 2e6f 7574 7075 745f 7368  ) - 1].output_sh
+00007370: 6170 655b 315d 0a20 2020 2020 2020 2069  ape[1].        i
+00007380: 6d67 5f77 6964 7468 5f6d 6f64 656c 203d  mg_width_model =
+00007390: 206d 6f64 656c 2e6c 6179 6572 735b 6c65   model.layers[le
+000073a0: 6e28 6d6f 6465 6c2e 6c61 7965 7273 2920  n(model.layers) 
+000073b0: 2d20 315d 2e6f 7574 7075 745f 7368 6170  - 1].output_shap
+000073c0: 655b 325d 0a0a 2020 2020 2020 2020 6966  e[2]..        if
+000073d0: 206e 6f74 2070 6174 6368 6573 3a0a 2020   not patches:.  
+000073e0: 2020 2020 2020 2020 2020 696d 675f 685f            img_h_
+000073f0: 7061 6765 203d 2069 6d67 2e73 6861 7065  page = img.shape
+00007400: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+00007410: 696d 675f 775f 7061 6765 203d 2069 6d67  img_w_page = img
+00007420: 2e73 6861 7065 5b31 5d0a 2020 2020 2020  .shape[1].      
+00007430: 2020 2020 2020 696d 6720 3d20 696d 6720        img = img 
+00007440: 2f20 666c 6f61 7428 3235 352e 3029 0a20  / float(255.0). 
+00007450: 2020 2020 2020 2020 2020 2069 6d67 203d             img =
+00007460: 2072 6573 697a 655f 696d 6167 6528 696d   resize_image(im
+00007470: 672c 2069 6d67 5f68 6569 6768 745f 6d6f  g, img_height_mo
+00007480: 6465 6c2c 2069 6d67 5f77 6964 7468 5f6d  del, img_width_m
+00007490: 6f64 656c 290a 0a20 2020 2020 2020 2020  odel)..         
+000074a0: 2020 206c 6162 656c 5f70 5f70 7265 6420     label_p_pred 
+000074b0: 3d20 6d6f 6465 6c2e 7072 6564 6963 7428  = model.predict(
+000074c0: 696d 672e 7265 7368 6170 6528 312c 2069  img.reshape(1, i
+000074d0: 6d67 2e73 6861 7065 5b30 5d2c 2069 6d67  mg.shape[0], img
+000074e0: 2e73 6861 7065 5b31 5d2c 2069 6d67 2e73  .shape[1], img.s
+000074f0: 6861 7065 5b32 5d29 2c0a 2020 2020 2020  hape[2]),.      
+00007500: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007520: 2020 2076 6572 626f 7365 3d30 290a 0a20     verbose=0).. 
+00007530: 2020 2020 2020 2020 2020 2073 6567 203d             seg =
+00007540: 206e 702e 6172 676d 6178 286c 6162 656c   np.argmax(label
+00007550: 5f70 5f70 7265 642c 2061 7869 733d 3329  _p_pred, axis=3)
+00007560: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+00007570: 7365 675f 636f 6c6f 7220 3d20 6e70 2e72  seg_color = np.r
+00007580: 6570 6561 7428 7365 675b 3a2c 203a 2c20  epeat(seg[:, :, 
+00007590: 6e70 2e6e 6577 6178 6973 5d2c 2033 2c20  np.newaxis], 3, 
+000075a0: 6178 6973 3d32 290a 2020 2020 2020 2020  axis=2).        
+000075b0: 2020 2020 7072 6564 6963 7469 6f6e 5f74      prediction_t
+000075c0: 7275 6520 3d20 7265 7369 7a65 5f69 6d61  rue = resize_ima
+000075d0: 6765 2873 6567 5f63 6f6c 6f72 2c20 696d  ge(seg_color, im
+000075e0: 675f 685f 7061 6765 2c20 696d 675f 775f  g_h_page, img_w_
+000075f0: 7061 6765 290a 2020 2020 2020 2020 2020  page).          
+00007600: 2020 7072 6564 6963 7469 6f6e 5f74 7275    prediction_tru
+00007610: 6520 3d20 7072 6564 6963 7469 6f6e 5f74  e = prediction_t
+00007620: 7275 652e 6173 7479 7065 286e 702e 7569  rue.astype(np.ui
+00007630: 6e74 3829 0a0a 0a20 2020 2020 2020 2065  nt8)...        e
+00007640: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00007650: 2069 6620 696d 672e 7368 6170 655b 305d   if img.shape[0]
+00007660: 203c 2069 6d67 5f68 6569 6768 745f 6d6f   < img_height_mo
+00007670: 6465 6c3a 0a20 2020 2020 2020 2020 2020  del:.           
+00007680: 2020 2020 2069 6d67 203d 2072 6573 697a       img = resiz
+00007690: 655f 696d 6167 6528 696d 672c 2069 6d67  e_image(img, img
+000076a0: 5f68 6569 6768 745f 6d6f 6465 6c2c 2069  _height_model, i
+000076b0: 6d67 2e73 6861 7065 5b31 5d29 0a0a 2020  mg.shape[1])..  
+000076c0: 2020 2020 2020 2020 2020 6966 2069 6d67            if img
+000076d0: 2e73 6861 7065 5b31 5d20 3c20 696d 675f  .shape[1] < img_
+000076e0: 7769 6474 685f 6d6f 6465 6c3a 0a20 2020  width_model:.   
+000076f0: 2020 2020 2020 2020 2020 2020 2069 6d67               img
+00007700: 203d 2072 6573 697a 655f 696d 6167 6528   = resize_image(
+00007710: 696d 672c 2069 6d67 2e73 6861 7065 5b30  img, img.shape[0
+00007720: 5d2c 2069 6d67 5f77 6964 7468 5f6d 6f64  ], img_width_mod
+00007730: 656c 290a 0a20 2020 2020 2020 2020 2020  el)..           
+00007740: 2073 656c 662e 6c6f 6767 6572 2e64 6562   self.logger.deb
+00007750: 7567 2822 5061 7463 6820 7369 7a65 3a20  ug("Patch size: 
+00007760: 2573 7825 7322 2c20 696d 675f 6865 6967  %sx%s", img_heig
+00007770: 6874 5f6d 6f64 656c 2c20 696d 675f 7769  ht_model, img_wi
+00007780: 6474 685f 6d6f 6465 6c29 0a20 2020 2020  dth_model).     
+00007790: 2020 2020 2020 206d 6172 6769 6e20 3d20         margin = 
+000077a0: 696e 7428 6d61 7267 696e 616c 5f6f 665f  int(marginal_of_
+000077b0: 7061 7463 685f 7065 7263 656e 7420 2a20  patch_percent * 
+000077c0: 696d 675f 6865 6967 6874 5f6d 6f64 656c  img_height_model
+000077d0: 290a 2020 2020 2020 2020 2020 2020 7769  ).            wi
+000077e0: 6474 685f 6d69 6420 3d20 696d 675f 7769  dth_mid = img_wi
+000077f0: 6474 685f 6d6f 6465 6c20 2d20 3220 2a20  dth_model - 2 * 
+00007800: 6d61 7267 696e 0a20 2020 2020 2020 2020  margin.         
+00007810: 2020 2068 6569 6768 745f 6d69 6420 3d20     height_mid = 
+00007820: 696d 675f 6865 6967 6874 5f6d 6f64 656c  img_height_model
+00007830: 202d 2032 202a 206d 6172 6769 6e0a 2020   - 2 * margin.  
+00007840: 2020 2020 2020 2020 2020 696d 6720 3d20            img = 
+00007850: 696d 6720 2f20 666c 6f61 7428 3235 352e  img / float(255.
+00007860: 3029 0a20 2020 2020 2020 2020 2020 2069  0).            i
+00007870: 6d67 203d 2069 6d67 2e61 7374 7970 6528  mg = img.astype(
+00007880: 6e70 2e66 6c6f 6174 3136 290a 2020 2020  np.float16).    
+00007890: 2020 2020 2020 2020 696d 675f 6820 3d20          img_h = 
+000078a0: 696d 672e 7368 6170 655b 305d 0a20 2020  img.shape[0].   
+000078b0: 2020 2020 2020 2020 2069 6d67 5f77 203d           img_w =
+000078c0: 2069 6d67 2e73 6861 7065 5b31 5d0a 2020   img.shape[1].  
+000078d0: 2020 2020 2020 2020 2020 7072 6564 6963            predic
+000078e0: 7469 6f6e 5f74 7275 6520 3d20 6e70 2e7a  tion_true = np.z
+000078f0: 6572 6f73 2828 696d 675f 682c 2069 6d67  eros((img_h, img
+00007900: 5f77 2c20 3329 290a 2020 2020 2020 2020  _w, 3)).        
+00007910: 2020 2020 6d61 736b 5f74 7275 6520 3d20      mask_true = 
+00007920: 6e70 2e7a 6572 6f73 2828 696d 675f 682c  np.zeros((img_h,
+00007930: 2069 6d67 5f77 2929 0a20 2020 2020 2020   img_w)).       
+00007940: 2020 2020 206e 7866 203d 2069 6d67 5f77       nxf = img_w
+00007950: 202f 2066 6c6f 6174 2877 6964 7468 5f6d   / float(width_m
+00007960: 6964 290a 2020 2020 2020 2020 2020 2020  id).            
+00007970: 6e79 6620 3d20 696d 675f 6820 2f20 666c  nyf = img_h / fl
+00007980: 6f61 7428 6865 6967 6874 5f6d 6964 290a  oat(height_mid).
+00007990: 2020 2020 2020 2020 2020 2020 6e78 6620              nxf 
+000079a0: 3d20 696e 7428 6e78 6629 202b 2031 2069  = int(nxf) + 1 i
+000079b0: 6620 6e78 6620 3e20 696e 7428 6e78 6629  f nxf > int(nxf)
+000079c0: 2065 6c73 6520 696e 7428 6e78 6629 0a20   else int(nxf). 
+000079d0: 2020 2020 2020 2020 2020 206e 7966 203d             nyf =
+000079e0: 2069 6e74 286e 7966 2920 2b20 3120 6966   int(nyf) + 1 if
+000079f0: 206e 7966 203e 2069 6e74 286e 7966 2920   nyf > int(nyf) 
+00007a00: 656c 7365 2069 6e74 286e 7966 290a 0a20  else int(nyf).. 
+00007a10: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+00007a20: 2069 6e20 7261 6e67 6528 6e78 6629 3a0a   in range(nxf):.
+00007a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007a40: 666f 7220 6a20 696e 2072 616e 6765 286e  for j in range(n
+00007a50: 7966 293a 0a20 2020 2020 2020 2020 2020  yf):.           
+00007a60: 2020 2020 2020 2020 2069 6620 6920 3d3d           if i ==
+00007a70: 2030 3a0a 2020 2020 2020 2020 2020 2020   0:.            
+00007a80: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+00007a90: 785f 785f 6420 3d20 6920 2a20 7769 6474  x_x_d = i * widt
+00007aa0: 685f 6d69 640a 2020 2020 2020 2020 2020  h_mid.          
+00007ab0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00007ac0: 6465 785f 785f 7520 3d20 696e 6465 785f  dex_x_u = index_
+00007ad0: 785f 6420 2b20 696d 675f 7769 6474 685f  x_d + img_width_
+00007ae0: 6d6f 6465 6c0a 2020 2020 2020 2020 2020  model.          
+00007af0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+00007b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007b10: 2020 2020 2020 2020 696e 6465 785f 785f          index_x_
+00007b20: 6420 3d20 6920 2a20 7769 6474 685f 6d69  d = i * width_mi
+00007b30: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00007b40: 2020 2020 2020 2020 2020 696e 6465 785f            index_
+00007b50: 785f 7520 3d20 696e 6465 785f 785f 6420  x_u = index_x_d 
+00007b60: 2b20 696d 675f 7769 6474 685f 6d6f 6465  + img_width_mode
+00007b70: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
+00007b80: 2020 2020 2020 6966 206a 203d 3d20 303a        if j == 0:
+00007b90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00007ba0: 2020 2020 2020 2020 2069 6e64 6578 5f79           index_y
+00007bb0: 5f64 203d 206a 202a 2068 6569 6768 745f  _d = j * height_
+00007bc0: 6d69 640a 2020 2020 2020 2020 2020 2020  mid.            
+00007bd0: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+00007be0: 785f 795f 7520 3d20 696e 6465 785f 795f  x_y_u = index_y_
+00007bf0: 6420 2b20 696d 675f 6865 6967 6874 5f6d  d + img_height_m
+00007c00: 6f64 656c 0a20 2020 2020 2020 2020 2020  odel.           
+00007c10: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00007c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007c30: 2020 2020 2020 2069 6e64 6578 5f79 5f64         index_y_d
+00007c40: 203d 206a 202a 2068 6569 6768 745f 6d69   = j * height_mi
+00007c50: 640a 2020 2020 2020 2020 2020 2020 2020  d.              
+00007c60: 2020 2020 2020 2020 2020 696e 6465 785f            index_
+00007c70: 795f 7520 3d20 696e 6465 785f 795f 6420  y_u = index_y_d 
+00007c80: 2b20 696d 675f 6865 6967 6874 5f6d 6f64  + img_height_mod
+00007c90: 656c 0a20 2020 2020 2020 2020 2020 2020  el.             
+00007ca0: 2020 2020 2020 2069 6620 696e 6465 785f         if index_
+00007cb0: 785f 7520 3e20 696d 675f 773a 0a20 2020  x_u > img_w:.   
+00007cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007cd0: 2020 2020 2069 6e64 6578 5f78 5f75 203d       index_x_u =
+00007ce0: 2069 6d67 5f77 0a20 2020 2020 2020 2020   img_w.         
+00007cf0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00007d00: 6e64 6578 5f78 5f64 203d 2069 6d67 5f77  ndex_x_d = img_w
+00007d10: 202d 2069 6d67 5f77 6964 7468 5f6d 6f64   - img_width_mod
+00007d20: 656c 0a20 2020 2020 2020 2020 2020 2020  el.             
+00007d30: 2020 2020 2020 2069 6620 696e 6465 785f         if index_
+00007d40: 795f 7520 3e20 696d 675f 683a 0a20 2020  y_u > img_h:.   
+00007d50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007d60: 2020 2020 2069 6e64 6578 5f79 5f75 203d       index_y_u =
+00007d70: 2069 6d67 5f68 0a20 2020 2020 2020 2020   img_h.         
+00007d80: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+00007d90: 6e64 6578 5f79 5f64 203d 2069 6d67 5f68  ndex_y_d = img_h
+00007da0: 202d 2069 6d67 5f68 6569 6768 745f 6d6f   - img_height_mo
+00007db0: 6465 6c0a 0a20 2020 2020 2020 2020 2020  del..           
+00007dc0: 2020 2020 2020 2020 2069 6d67 5f70 6174           img_pat
+00007dd0: 6368 203d 2069 6d67 5b69 6e64 6578 5f79  ch = img[index_y
+00007de0: 5f64 3a69 6e64 6578 5f79 5f75 2c20 696e  _d:index_y_u, in
+00007df0: 6465 785f 785f 643a 696e 6465 785f 785f  dex_x_d:index_x_
+00007e00: 752c 203a 5d0a 2020 2020 2020 2020 2020  u, :].          
+00007e10: 2020 2020 2020 2020 2020 6c61 6265 6c5f            label_
+00007e20: 705f 7072 6564 203d 206d 6f64 656c 2e70  p_pred = model.p
+00007e30: 7265 6469 6374 2869 6d67 5f70 6174 6368  redict(img_patch
+00007e40: 2e72 6573 6861 7065 2831 2c20 696d 675f  .reshape(1, img_
+00007e50: 7061 7463 682e 7368 6170 655b 305d 2c20  patch.shape[0], 
+00007e60: 696d 675f 7061 7463 682e 7368 6170 655b  img_patch.shape[
+00007e70: 315d 2c20 696d 675f 7061 7463 682e 7368  1], img_patch.sh
+00007e80: 6170 655b 325d 292c 0a20 2020 2020 2020  ape[2]),.       
+00007e90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007eb0: 2020 2020 2020 2020 2020 7665 7262 6f73            verbos
+00007ec0: 653d 3029 0a20 2020 2020 2020 2020 2020  e=0).           
+00007ed0: 2020 2020 2020 2020 2073 6567 203d 206e           seg = n
+00007ee0: 702e 6172 676d 6178 286c 6162 656c 5f70  p.argmax(label_p
+00007ef0: 5f70 7265 642c 2061 7869 733d 3329 5b30  _pred, axis=3)[0
+00007f00: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00007f10: 2020 2020 2020 7365 675f 636f 6c6f 7220        seg_color 
+00007f20: 3d20 6e70 2e72 6570 6561 7428 7365 675b  = np.repeat(seg[
+00007f30: 3a2c 203a 2c20 6e70 2e6e 6577 6178 6973  :, :, np.newaxis
+00007f40: 5d2c 2033 2c20 6178 6973 3d32 290a 0a20  ], 3, axis=2).. 
+00007f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f60: 2020 2069 6620 6920 3d3d 2030 2061 6e64     if i == 0 and
+00007f70: 206a 203d 3d20 303a 0a20 2020 2020 2020   j == 0:.       
+00007f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00007f90: 2073 6567 5f63 6f6c 6f72 203d 2073 6567   seg_color = seg
+00007fa0: 5f63 6f6c 6f72 5b30 203a 2073 6567 5f63  _color[0 : seg_c
+00007fb0: 6f6c 6f72 2e73 6861 7065 5b30 5d20 2d20  olor.shape[0] - 
+00007fc0: 6d61 7267 696e 2c20 3020 3a20 7365 675f  margin, 0 : seg_
+00007fd0: 636f 6c6f 722e 7368 6170 655b 315d 202d  color.shape[1] -
+00007fe0: 206d 6172 6769 6e2c 203a 5d0a 2020 2020   margin, :].    
+00007ff0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008000: 2020 2020 2373 6567 203d 2073 6567 5b30      #seg = seg[0
+00008010: 203a 2073 6567 2e73 6861 7065 5b30 5d20   : seg.shape[0] 
+00008020: 2d20 6d61 7267 696e 2c20 3020 3a20 7365  - margin, 0 : se
+00008030: 672e 7368 6170 655b 315d 202d 206d 6172  g.shape[1] - mar
+00008040: 6769 6e5d 0a20 2020 2020 2020 2020 2020  gin].           
+00008050: 2020 2020 2020 2020 2020 2020 2023 6d61               #ma
+00008060: 736b 5f74 7275 655b 696e 6465 785f 795f  sk_true[index_y_
+00008070: 6420 2b20 3020 3a20 696e 6465 785f 795f  d + 0 : index_y_
+00008080: 7520 2d20 6d61 7267 696e 2c20 696e 6465  u - margin, inde
+00008090: 785f 785f 6420 2b20 3020 3a20 696e 6465  x_x_d + 0 : inde
+000080a0: 785f 785f 7520 2d20 6d61 7267 696e 5d20  x_x_u - margin] 
+000080b0: 3d20 7365 670a 2020 2020 2020 2020 2020  = seg.          
+000080c0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000080d0: 6564 6963 7469 6f6e 5f74 7275 655b 696e  ediction_true[in
+000080e0: 6465 785f 795f 6420 2b20 3020 3a20 696e  dex_y_d + 0 : in
+000080f0: 6465 785f 795f 7520 2d20 6d61 7267 696e  dex_y_u - margin
+00008100: 2c20 696e 6465 785f 785f 6420 2b20 3020  , index_x_d + 0 
+00008110: 3a20 696e 6465 785f 785f 7520 2d20 6d61  : index_x_u - ma
+00008120: 7267 696e 2c20 3a5d 203d 2073 6567 5f63  rgin, :] = seg_c
+00008130: 6f6c 6f72 0a20 2020 2020 2020 2020 2020  olor.           
+00008140: 2020 2020 2020 2020 2065 6c69 6620 6920           elif i 
+00008150: 3d3d 206e 7866 202d 2031 2061 6e64 206a  == nxf - 1 and j
+00008160: 203d 3d20 6e79 6620 2d20 313a 0a20 2020   == nyf - 1:.   
+00008170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008180: 2020 2020 2073 6567 5f63 6f6c 6f72 203d       seg_color =
+00008190: 2073 6567 5f63 6f6c 6f72 5b6d 6172 6769   seg_color[margi
+000081a0: 6e20 3a20 7365 675f 636f 6c6f 722e 7368  n : seg_color.sh
+000081b0: 6170 655b 305d 202d 2030 2c20 6d61 7267  ape[0] - 0, marg
+000081c0: 696e 203a 2073 6567 5f63 6f6c 6f72 2e73  in : seg_color.s
+000081d0: 6861 7065 5b31 5d20 2d20 302c 203a 5d0a  hape[1] - 0, :].
+000081e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000081f0: 2020 2020 2020 2020 2373 6567 203d 2073          #seg = s
+00008200: 6567 5b6d 6172 6769 6e20 3a20 7365 672e  eg[margin : seg.
+00008210: 7368 6170 655b 305d 202d 2030 2c20 6d61  shape[0] - 0, ma
+00008220: 7267 696e 203a 2073 6567 2e73 6861 7065  rgin : seg.shape
+00008230: 5b31 5d20 2d20 305d 0a20 2020 2020 2020  [1] - 0].       
+00008240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008250: 2023 6d61 736b 5f74 7275 655b 696e 6465   #mask_true[inde
+00008260: 785f 795f 6420 2b20 6d61 7267 696e 203a  x_y_d + margin :
+00008270: 2069 6e64 6578 5f79 5f75 202d 2030 2c20   index_y_u - 0, 
+00008280: 696e 6465 785f 785f 6420 2b20 6d61 7267  index_x_d + marg
+00008290: 696e 203a 2069 6e64 6578 5f78 5f75 202d  in : index_x_u -
+000082a0: 2030 5d20 3d20 7365 670a 2020 2020 2020   0] = seg.      
+000082b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000082c0: 2020 7072 6564 6963 7469 6f6e 5f74 7275    prediction_tru
+000082d0: 655b 696e 6465 785f 795f 6420 2b20 6d61  e[index_y_d + ma
+000082e0: 7267 696e 203a 2069 6e64 6578 5f79 5f75  rgin : index_y_u
+000082f0: 202d 2030 2c20 696e 6465 785f 785f 6420   - 0, index_x_d 
+00008300: 2b20 6d61 7267 696e 203a 2069 6e64 6578  + margin : index
+00008310: 5f78 5f75 202d 2030 2c20 3a5d 203d 2073  _x_u - 0, :] = s
+00008320: 6567 5f63 6f6c 6f72 0a20 2020 2020 2020  eg_color.       
+00008330: 2020 2020 2020 2020 2020 2020 2065 6c69               eli
+00008340: 6620 6920 3d3d 2030 2061 6e64 206a 203d  f i == 0 and j =
+00008350: 3d20 6e79 6620 2d20 313a 0a20 2020 2020  = nyf - 1:.     
+00008360: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008370: 2020 2073 6567 5f63 6f6c 6f72 203d 2073     seg_color = s
+00008380: 6567 5f63 6f6c 6f72 5b6d 6172 6769 6e20  eg_color[margin 
+00008390: 3a20 7365 675f 636f 6c6f 722e 7368 6170  : seg_color.shap
+000083a0: 655b 305d 202d 2030 2c20 3020 3a20 7365  e[0] - 0, 0 : se
+000083b0: 675f 636f 6c6f 722e 7368 6170 655b 315d  g_color.shape[1]
+000083c0: 202d 206d 6172 6769 6e2c 203a 5d0a 2020   - margin, :].  
+000083d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000083e0: 2020 2020 2020 2373 6567 203d 2073 6567        #seg = seg
+000083f0: 5b6d 6172 6769 6e20 3a20 7365 672e 7368  [margin : seg.sh
+00008400: 6170 655b 305d 202d 2030 2c20 3020 3a20  ape[0] - 0, 0 : 
+00008410: 7365 672e 7368 6170 655b 315d 202d 206d  seg.shape[1] - m
+00008420: 6172 6769 6e5d 0a20 2020 2020 2020 2020  argin].         
+00008430: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+00008440: 6d61 736b 5f74 7275 655b 696e 6465 785f  mask_true[index_
+00008450: 795f 6420 2b20 6d61 7267 696e 203a 2069  y_d + margin : i
+00008460: 6e64 6578 5f79 5f75 202d 2030 2c20 696e  ndex_y_u - 0, in
+00008470: 6465 785f 785f 6420 2b20 3020 3a20 696e  dex_x_d + 0 : in
+00008480: 6465 785f 785f 7520 2d20 6d61 7267 696e  dex_x_u - margin
+00008490: 5d20 3d20 7365 670a 2020 2020 2020 2020  ] = seg.        
+000084a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000084b0: 7072 6564 6963 7469 6f6e 5f74 7275 655b  prediction_true[
+000084c0: 696e 6465 785f 795f 6420 2b20 6d61 7267  index_y_d + marg
+000084d0: 696e 203a 2069 6e64 6578 5f79 5f75 202d  in : index_y_u -
+000084e0: 2030 2c20 696e 6465 785f 785f 6420 2b20   0, index_x_d + 
+000084f0: 3020 3a20 696e 6465 785f 785f 7520 2d20  0 : index_x_u - 
+00008500: 6d61 7267 696e 2c20 3a5d 203d 2073 6567  margin, :] = seg
+00008510: 5f63 6f6c 6f72 0a20 2020 2020 2020 2020  _color.         
+00008520: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+00008530: 6920 3d3d 206e 7866 202d 2031 2061 6e64  i == nxf - 1 and
+00008540: 206a 203d 3d20 303a 0a20 2020 2020 2020   j == 0:.       
+00008550: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008560: 2073 6567 5f63 6f6c 6f72 203d 2073 6567   seg_color = seg
+00008570: 5f63 6f6c 6f72 5b30 203a 2073 6567 5f63  _color[0 : seg_c
+00008580: 6f6c 6f72 2e73 6861 7065 5b30 5d20 2d20  olor.shape[0] - 
+00008590: 6d61 7267 696e 2c20 6d61 7267 696e 203a  margin, margin :
+000085a0: 2073 6567 5f63 6f6c 6f72 2e73 6861 7065   seg_color.shape
+000085b0: 5b31 5d20 2d20 302c 203a 5d0a 2020 2020  [1] - 0, :].    
+000085c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000085d0: 2020 2020 2373 6567 203d 2073 6567 5b30      #seg = seg[0
+000085e0: 203a 2073 6567 2e73 6861 7065 5b30 5d20   : seg.shape[0] 
+000085f0: 2d20 6d61 7267 696e 2c20 6d61 7267 696e  - margin, margin
+00008600: 203a 2073 6567 2e73 6861 7065 5b31 5d20   : seg.shape[1] 
+00008610: 2d20 305d 0a20 2020 2020 2020 2020 2020  - 0].           
+00008620: 2020 2020 2020 2020 2020 2020 2023 6d61               #ma
+00008630: 736b 5f74 7275 655b 696e 6465 785f 795f  sk_true[index_y_
+00008640: 6420 2b20 3020 3a20 696e 6465 785f 795f  d + 0 : index_y_
+00008650: 7520 2d20 6d61 7267 696e 2c20 696e 6465  u - margin, inde
+00008660: 785f 785f 6420 2b20 6d61 7267 696e 203a  x_x_d + margin :
+00008670: 2069 6e64 6578 5f78 5f75 202d 2030 5d20   index_x_u - 0] 
+00008680: 3d20 7365 670a 2020 2020 2020 2020 2020  = seg.          
+00008690: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000086a0: 6564 6963 7469 6f6e 5f74 7275 655b 696e  ediction_true[in
+000086b0: 6465 785f 795f 6420 2b20 3020 3a20 696e  dex_y_d + 0 : in
+000086c0: 6465 785f 795f 7520 2d20 6d61 7267 696e  dex_y_u - margin
+000086d0: 2c20 696e 6465 785f 785f 6420 2b20 6d61  , index_x_d + ma
+000086e0: 7267 696e 203a 2069 6e64 6578 5f78 5f75  rgin : index_x_u
+000086f0: 202d 2030 2c20 3a5d 203d 2073 6567 5f63   - 0, :] = seg_c
+00008700: 6f6c 6f72 0a20 2020 2020 2020 2020 2020  olor.           
+00008710: 2020 2020 2020 2020 2065 6c69 6620 6920           elif i 
+00008720: 3d3d 2030 2061 6e64 206a 2021 3d20 3020  == 0 and j != 0 
+00008730: 616e 6420 6a20 213d 206e 7966 202d 2031  and j != nyf - 1
+00008740: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008750: 2020 2020 2020 2020 2020 7365 675f 636f            seg_co
+00008760: 6c6f 7220 3d20 7365 675f 636f 6c6f 725b  lor = seg_color[
+00008770: 6d61 7267 696e 203a 2073 6567 5f63 6f6c  margin : seg_col
+00008780: 6f72 2e73 6861 7065 5b30 5d20 2d20 6d61  or.shape[0] - ma
+00008790: 7267 696e 2c20 3020 3a20 7365 675f 636f  rgin, 0 : seg_co
+000087a0: 6c6f 722e 7368 6170 655b 315d 202d 206d  lor.shape[1] - m
+000087b0: 6172 6769 6e2c 203a 5d0a 2020 2020 2020  argin, :].      
+000087c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000087d0: 2020 2373 6567 203d 2073 6567 5b6d 6172    #seg = seg[mar
+000087e0: 6769 6e20 3a20 7365 672e 7368 6170 655b  gin : seg.shape[
+000087f0: 305d 202d 206d 6172 6769 6e2c 2030 203a  0] - margin, 0 :
+00008800: 2073 6567 2e73 6861 7065 5b31 5d20 2d20   seg.shape[1] - 
+00008810: 6d61 7267 696e 5d0a 2020 2020 2020 2020  margin].        
+00008820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008830: 236d 6173 6b5f 7472 7565 5b69 6e64 6578  #mask_true[index
+00008840: 5f79 5f64 202b 206d 6172 6769 6e20 3a20  _y_d + margin : 
+00008850: 696e 6465 785f 795f 7520 2d20 6d61 7267  index_y_u - marg
+00008860: 696e 2c20 696e 6465 785f 785f 6420 2b20  in, index_x_d + 
+00008870: 3020 3a20 696e 6465 785f 785f 7520 2d20  0 : index_x_u - 
+00008880: 6d61 7267 696e 5d20 3d20 7365 670a 2020  margin] = seg.  
+00008890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000088a0: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
+000088b0: 5f74 7275 655b 696e 6465 785f 795f 6420  _true[index_y_d 
+000088c0: 2b20 6d61 7267 696e 203a 2069 6e64 6578  + margin : index
+000088d0: 5f79 5f75 202d 206d 6172 6769 6e2c 2069  _y_u - margin, i
+000088e0: 6e64 6578 5f78 5f64 202b 2030 203a 2069  ndex_x_d + 0 : i
+000088f0: 6e64 6578 5f78 5f75 202d 206d 6172 6769  ndex_x_u - margi
+00008900: 6e2c 203a 5d20 3d20 7365 675f 636f 6c6f  n, :] = seg_colo
+00008910: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+00008920: 2020 2020 2020 656c 6966 2069 203d 3d20        elif i == 
+00008930: 6e78 6620 2d20 3120 616e 6420 6a20 213d  nxf - 1 and j !=
+00008940: 2030 2061 6e64 206a 2021 3d20 6e79 6620   0 and j != nyf 
+00008950: 2d20 313a 0a20 2020 2020 2020 2020 2020  - 1:.           
+00008960: 2020 2020 2020 2020 2020 2020 2073 6567               seg
+00008970: 5f63 6f6c 6f72 203d 2073 6567 5f63 6f6c  _color = seg_col
+00008980: 6f72 5b6d 6172 6769 6e20 3a20 7365 675f  or[margin : seg_
+00008990: 636f 6c6f 722e 7368 6170 655b 305d 202d  color.shape[0] -
+000089a0: 206d 6172 6769 6e2c 206d 6172 6769 6e20   margin, margin 
+000089b0: 3a20 7365 675f 636f 6c6f 722e 7368 6170  : seg_color.shap
+000089c0: 655b 315d 202d 2030 2c20 3a5d 0a20 2020  e[1] - 0, :].   
+000089d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000089e0: 2020 2020 2023 7365 6720 3d20 7365 675b       #seg = seg[
+000089f0: 6d61 7267 696e 203a 2073 6567 2e73 6861  margin : seg.sha
+00008a00: 7065 5b30 5d20 2d20 6d61 7267 696e 2c20  pe[0] - margin, 
+00008a10: 6d61 7267 696e 203a 2073 6567 2e73 6861  margin : seg.sha
+00008a20: 7065 5b31 5d20 2d20 305d 0a20 2020 2020  pe[1] - 0].     
+00008a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008a40: 2020 2023 6d61 736b 5f74 7275 655b 696e     #mask_true[in
+00008a50: 6465 785f 795f 6420 2b20 6d61 7267 696e  dex_y_d + margin
+00008a60: 203a 2069 6e64 6578 5f79 5f75 202d 206d   : index_y_u - m
+00008a70: 6172 6769 6e2c 2069 6e64 6578 5f78 5f64  argin, index_x_d
+00008a80: 202b 206d 6172 6769 6e20 3a20 696e 6465   + margin : inde
+00008a90: 785f 785f 7520 2d20 305d 203d 2073 6567  x_x_u - 0] = seg
+00008aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008ab0: 2020 2020 2020 2020 2070 7265 6469 6374           predict
+00008ac0: 696f 6e5f 7472 7565 5b69 6e64 6578 5f79  ion_true[index_y
+00008ad0: 5f64 202b 206d 6172 6769 6e20 3a20 696e  _d + margin : in
+00008ae0: 6465 785f 795f 7520 2d20 6d61 7267 696e  dex_y_u - margin
+00008af0: 2c20 696e 6465 785f 785f 6420 2b20 6d61  , index_x_d + ma
+00008b00: 7267 696e 203a 2069 6e64 6578 5f78 5f75  rgin : index_x_u
+00008b10: 202d 2030 2c20 3a5d 203d 2073 6567 5f63   - 0, :] = seg_c
+00008b20: 6f6c 6f72 0a20 2020 2020 2020 2020 2020  olor.           
+00008b30: 2020 2020 2020 2020 2065 6c69 6620 6920           elif i 
+00008b40: 213d 2030 2061 6e64 2069 2021 3d20 6e78  != 0 and i != nx
+00008b50: 6620 2d20 3120 616e 6420 6a20 3d3d 2030  f - 1 and j == 0
+00008b60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00008b70: 2020 2020 2020 2020 2020 7365 675f 636f            seg_co
+00008b80: 6c6f 7220 3d20 7365 675f 636f 6c6f 725b  lor = seg_color[
+00008b90: 3020 3a20 7365 675f 636f 6c6f 722e 7368  0 : seg_color.sh
+00008ba0: 6170 655b 305d 202d 206d 6172 6769 6e2c  ape[0] - margin,
+00008bb0: 206d 6172 6769 6e20 3a20 7365 675f 636f   margin : seg_co
+00008bc0: 6c6f 722e 7368 6170 655b 315d 202d 206d  lor.shape[1] - m
+00008bd0: 6172 6769 6e2c 203a 5d0a 2020 2020 2020  argin, :].      
+00008be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008bf0: 2020 2373 6567 203d 2073 6567 5b30 203a    #seg = seg[0 :
+00008c00: 2073 6567 2e73 6861 7065 5b30 5d20 2d20   seg.shape[0] - 
+00008c10: 6d61 7267 696e 2c20 6d61 7267 696e 203a  margin, margin :
+00008c20: 2073 6567 2e73 6861 7065 5b31 5d20 2d20   seg.shape[1] - 
+00008c30: 6d61 7267 696e 5d0a 2020 2020 2020 2020  margin].        
+00008c40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008c50: 236d 6173 6b5f 7472 7565 5b69 6e64 6578  #mask_true[index
+00008c60: 5f79 5f64 202b 2030 203a 2069 6e64 6578  _y_d + 0 : index
+00008c70: 5f79 5f75 202d 206d 6172 6769 6e2c 2069  _y_u - margin, i
+00008c80: 6e64 6578 5f78 5f64 202b 206d 6172 6769  ndex_x_d + margi
+00008c90: 6e20 3a20 696e 6465 785f 785f 7520 2d20  n : index_x_u - 
+00008ca0: 6d61 7267 696e 5d20 3d20 7365 670a 2020  margin] = seg.  
+00008cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008cc0: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
+00008cd0: 5f74 7275 655b 696e 6465 785f 795f 6420  _true[index_y_d 
+00008ce0: 2b20 3020 3a20 696e 6465 785f 795f 7520  + 0 : index_y_u 
+00008cf0: 2d20 6d61 7267 696e 2c20 696e 6465 785f  - margin, index_
+00008d00: 785f 6420 2b20 6d61 7267 696e 203a 2069  x_d + margin : i
+00008d10: 6e64 6578 5f78 5f75 202d 206d 6172 6769  ndex_x_u - margi
+00008d20: 6e2c 203a 5d20 3d20 7365 675f 636f 6c6f  n, :] = seg_colo
+00008d30: 720a 2020 2020 2020 2020 2020 2020 2020  r.              
+00008d40: 2020 2020 2020 656c 6966 2069 2021 3d20        elif i != 
+00008d50: 3020 616e 6420 6920 213d 206e 7866 202d  0 and i != nxf -
+00008d60: 2031 2061 6e64 206a 203d 3d20 6e79 6620   1 and j == nyf 
+00008d70: 2d20 313a 0a20 2020 2020 2020 2020 2020  - 1:.           
+00008d80: 2020 2020 2020 2020 2020 2020 2073 6567               seg
+00008d90: 5f63 6f6c 6f72 203d 2073 6567 5f63 6f6c  _color = seg_col
+00008da0: 6f72 5b6d 6172 6769 6e20 3a20 7365 675f  or[margin : seg_
+00008db0: 636f 6c6f 722e 7368 6170 655b 305d 202d  color.shape[0] -
+00008dc0: 2030 2c20 6d61 7267 696e 203a 2073 6567   0, margin : seg
+00008dd0: 5f63 6f6c 6f72 2e73 6861 7065 5b31 5d20  _color.shape[1] 
+00008de0: 2d20 6d61 7267 696e 2c20 3a5d 0a20 2020  - margin, :].   
+00008df0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008e00: 2020 2020 2023 7365 6720 3d20 7365 675b       #seg = seg[
+00008e10: 6d61 7267 696e 203a 2073 6567 2e73 6861  margin : seg.sha
+00008e20: 7065 5b30 5d20 2d20 302c 206d 6172 6769  pe[0] - 0, margi
+00008e30: 6e20 3a20 7365 672e 7368 6170 655b 315d  n : seg.shape[1]
+00008e40: 202d 206d 6172 6769 6e5d 0a20 2020 2020   - margin].     
+00008e50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008e60: 2020 2023 6d61 736b 5f74 7275 655b 696e     #mask_true[in
+00008e70: 6465 785f 795f 6420 2b20 6d61 7267 696e  dex_y_d + margin
+00008e80: 203a 2069 6e64 6578 5f79 5f75 202d 2030   : index_y_u - 0
+00008e90: 2c20 696e 6465 785f 785f 6420 2b20 6d61  , index_x_d + ma
+00008ea0: 7267 696e 203a 2069 6e64 6578 5f78 5f75  rgin : index_x_u
+00008eb0: 202d 206d 6172 6769 6e5d 203d 2073 6567   - margin] = seg
+00008ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00008ed0: 2020 2020 2020 2020 2070 7265 6469 6374           predict
+00008ee0: 696f 6e5f 7472 7565 5b69 6e64 6578 5f79  ion_true[index_y
+00008ef0: 5f64 202b 206d 6172 6769 6e20 3a20 696e  _d + margin : in
+00008f00: 6465 785f 795f 7520 2d20 302c 2069 6e64  dex_y_u - 0, ind
+00008f10: 6578 5f78 5f64 202b 206d 6172 6769 6e20  ex_x_d + margin 
+00008f20: 3a20 696e 6465 785f 785f 7520 2d20 6d61  : index_x_u - ma
+00008f30: 7267 696e 2c20 3a5d 203d 2073 6567 5f63  rgin, :] = seg_c
+00008f40: 6f6c 6f72 0a20 2020 2020 2020 2020 2020  olor.           
+00008f50: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00008f60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008f70: 2020 2020 2020 2073 6567 5f63 6f6c 6f72         seg_color
+00008f80: 203d 2073 6567 5f63 6f6c 6f72 5b6d 6172   = seg_color[mar
+00008f90: 6769 6e20 3a20 7365 675f 636f 6c6f 722e  gin : seg_color.
+00008fa0: 7368 6170 655b 305d 202d 206d 6172 6769  shape[0] - margi
+00008fb0: 6e2c 206d 6172 6769 6e20 3a20 7365 675f  n, margin : seg_
+00008fc0: 636f 6c6f 722e 7368 6170 655b 315d 202d  color.shape[1] -
+00008fd0: 206d 6172 6769 6e2c 203a 5d0a 2020 2020   margin, :].    
+00008fe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00008ff0: 2020 2020 2373 6567 203d 2073 6567 5b6d      #seg = seg[m
+00009000: 6172 6769 6e20 3a20 7365 672e 7368 6170  argin : seg.shap
+00009010: 655b 305d 202d 206d 6172 6769 6e2c 206d  e[0] - margin, m
+00009020: 6172 6769 6e20 3a20 7365 672e 7368 6170  argin : seg.shap
+00009030: 655b 315d 202d 206d 6172 6769 6e5d 0a20  e[1] - margin]. 
+00009040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009050: 2020 2020 2020 2023 6d61 736b 5f74 7275         #mask_tru
+00009060: 655b 696e 6465 785f 795f 6420 2b20 6d61  e[index_y_d + ma
+00009070: 7267 696e 203a 2069 6e64 6578 5f79 5f75  rgin : index_y_u
+00009080: 202d 206d 6172 6769 6e2c 2069 6e64 6578   - margin, index
+00009090: 5f78 5f64 202b 206d 6172 6769 6e20 3a20  _x_d + margin : 
+000090a0: 696e 6465 785f 785f 7520 2d20 6d61 7267  index_x_u - marg
+000090b0: 696e 5d20 3d20 7365 670a 2020 2020 2020  in] = seg.      
+000090c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000090d0: 2020 7072 6564 6963 7469 6f6e 5f74 7275    prediction_tru
+000090e0: 655b 696e 6465 785f 795f 6420 2b20 6d61  e[index_y_d + ma
+000090f0: 7267 696e 203a 2069 6e64 6578 5f79 5f75  rgin : index_y_u
+00009100: 202d 206d 6172 6769 6e2c 2069 6e64 6578   - margin, index
+00009110: 5f78 5f64 202b 206d 6172 6769 6e20 3a20  _x_d + margin : 
+00009120: 696e 6465 785f 785f 7520 2d20 6d61 7267  index_x_u - marg
+00009130: 696e 2c20 3a5d 203d 2073 6567 5f63 6f6c  in, :] = seg_col
+00009140: 6f72 0a0a 2020 2020 2020 2020 2020 2020  or..            
+00009150: 7072 6564 6963 7469 6f6e 5f74 7275 6520  prediction_true 
+00009160: 3d20 7072 6564 6963 7469 6f6e 5f74 7275  = prediction_tru
+00009170: 652e 6173 7479 7065 286e 702e 7569 6e74  e.astype(np.uint
+00009180: 3829 0a20 2020 2020 2020 2023 6465 6c20  8).        #del 
+00009190: 6d6f 6465 6c0a 2020 2020 2020 2020 2367  model.        #g
+000091a0: 632e 636f 6c6c 6563 7428 290a 2020 2020  c.collect().    
+000091b0: 2020 2020 7265 7475 726e 2070 7265 6469      return predi
+000091c0: 6374 696f 6e5f 7472 7565 0a20 2020 2064  ction_true.    d
+000091d0: 6566 2064 6f5f 7072 6564 6963 7469 6f6e  ef do_prediction
+000091e0: 5f6e 6577 5f63 6f6e 6365 7074 2873 656c  _new_concept(sel
+000091f0: 662c 2070 6174 6368 6573 2c20 696d 672c  f, patches, img,
+00009200: 206d 6f64 656c 2c20 6d61 7267 696e 616c   model, marginal
+00009210: 5f6f 665f 7061 7463 685f 7065 7263 656e  _of_patch_percen
+00009220: 743d 302e 3129 3a0a 2020 2020 2020 2020  t=0.1):.        
+00009230: 7365 6c66 2e6c 6f67 6765 722e 6465 6275  self.logger.debu
+00009240: 6728 2265 6e74 6572 2064 6f5f 7072 6564  g("enter do_pred
+00009250: 6963 7469 6f6e 2229 0a0a 2020 2020 2020  iction")..      
+00009260: 2020 696d 675f 6865 6967 6874 5f6d 6f64    img_height_mod
+00009270: 656c 203d 206d 6f64 656c 2e6c 6179 6572  el = model.layer
+00009280: 735b 6c65 6e28 6d6f 6465 6c2e 6c61 7965  s[len(model.laye
+00009290: 7273 2920 2d20 315d 2e6f 7574 7075 745f  rs) - 1].output_
+000092a0: 7368 6170 655b 315d 0a20 2020 2020 2020  shape[1].       
+000092b0: 2069 6d67 5f77 6964 7468 5f6d 6f64 656c   img_width_model
+000092c0: 203d 206d 6f64 656c 2e6c 6179 6572 735b   = model.layers[
+000092d0: 6c65 6e28 6d6f 6465 6c2e 6c61 7965 7273  len(model.layers
+000092e0: 2920 2d20 315d 2e6f 7574 7075 745f 7368  ) - 1].output_sh
+000092f0: 6170 655b 325d 0a0a 2020 2020 2020 2020  ape[2]..        
+00009300: 6966 206e 6f74 2070 6174 6368 6573 3a0a  if not patches:.
+00009310: 2020 2020 2020 2020 2020 2020 696d 675f              img_
+00009320: 685f 7061 6765 203d 2069 6d67 2e73 6861  h_page = img.sha
+00009330: 7065 5b30 5d0a 2020 2020 2020 2020 2020  pe[0].          
+00009340: 2020 696d 675f 775f 7061 6765 203d 2069    img_w_page = i
+00009350: 6d67 2e73 6861 7065 5b31 5d0a 2020 2020  mg.shape[1].    
+00009360: 2020 2020 2020 2020 696d 6720 3d20 696d          img = im
+00009370: 6720 2f20 666c 6f61 7428 3235 352e 3029  g / float(255.0)
+00009380: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
+00009390: 203d 2072 6573 697a 655f 696d 6167 6528   = resize_image(
+000093a0: 696d 672c 2069 6d67 5f68 6569 6768 745f  img, img_height_
+000093b0: 6d6f 6465 6c2c 2069 6d67 5f77 6964 7468  model, img_width
+000093c0: 5f6d 6f64 656c 290a 0a20 2020 2020 2020  _model)..       
+000093d0: 2020 2020 206c 6162 656c 5f70 5f70 7265       label_p_pre
+000093e0: 6420 3d20 6d6f 6465 6c2e 7072 6564 6963  d = model.predic
+000093f0: 7428 696d 672e 7265 7368 6170 6528 312c  t(img.reshape(1,
+00009400: 2069 6d67 2e73 6861 7065 5b30 5d2c 2069   img.shape[0], i
+00009410: 6d67 2e73 6861 7065 5b31 5d2c 2069 6d67  mg.shape[1], img
+00009420: 2e73 6861 7065 5b32 5d29 290a 0a0a 2020  .shape[2]))...  
+00009430: 2020 2020 2020 2020 2020 7365 6720 3d20            seg = 
+00009440: 6e70 2e61 7267 6d61 7828 6c61 6265 6c5f  np.argmax(label_
+00009450: 705f 7072 6564 2c20 6178 6973 3d33 295b  p_pred, axis=3)[
+00009460: 305d 0a20 2020 2020 2020 2020 2020 2073  0].            s
+00009470: 6567 5f63 6f6c 6f72 203d 206e 702e 7265  eg_color = np.re
+00009480: 7065 6174 2873 6567 5b3a 2c20 3a2c 206e  peat(seg[:, :, n
+00009490: 702e 6e65 7761 7869 735d 2c20 332c 2061  p.newaxis], 3, a
+000094a0: 7869 733d 3229 0a20 2020 2020 2020 2020  xis=2).         
+000094b0: 2020 2070 7265 6469 6374 696f 6e5f 7472     prediction_tr
+000094c0: 7565 203d 2072 6573 697a 655f 696d 6167  ue = resize_imag
+000094d0: 6528 7365 675f 636f 6c6f 722c 2069 6d67  e(seg_color, img
+000094e0: 5f68 5f70 6167 652c 2069 6d67 5f77 5f70  _h_page, img_w_p
+000094f0: 6167 6529 0a20 2020 2020 2020 2020 2020  age).           
+00009500: 2070 7265 6469 6374 696f 6e5f 7472 7565   prediction_true
+00009510: 203d 2070 7265 6469 6374 696f 6e5f 7472   = prediction_tr
+00009520: 7565 2e61 7374 7970 6528 6e70 2e75 696e  ue.astype(np.uin
+00009530: 7438 290a 0a0a 2020 2020 2020 2020 656c  t8)...        el
+00009540: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00009550: 6966 2069 6d67 2e73 6861 7065 5b30 5d20  if img.shape[0] 
+00009560: 3c20 696d 675f 6865 6967 6874 5f6d 6f64  < img_height_mod
+00009570: 656c 3a0a 2020 2020 2020 2020 2020 2020  el:.            
+00009580: 2020 2020 696d 6720 3d20 7265 7369 7a65      img = resize
+00009590: 5f69 6d61 6765 2869 6d67 2c20 696d 675f  _image(img, img_
+000095a0: 6865 6967 6874 5f6d 6f64 656c 2c20 696d  height_model, im
+000095b0: 672e 7368 6170 655b 315d 290a 0a20 2020  g.shape[1])..   
+000095c0: 2020 2020 2020 2020 2069 6620 696d 672e           if img.
+000095d0: 7368 6170 655b 315d 203c 2069 6d67 5f77  shape[1] < img_w
+000095e0: 6964 7468 5f6d 6f64 656c 3a0a 2020 2020  idth_model:.    
+000095f0: 2020 2020 2020 2020 2020 2020 696d 6720              img 
+00009600: 3d20 7265 7369 7a65 5f69 6d61 6765 2869  = resize_image(i
+00009610: 6d67 2c20 696d 672e 7368 6170 655b 305d  mg, img.shape[0]
+00009620: 2c20 696d 675f 7769 6474 685f 6d6f 6465  , img_width_mode
+00009630: 6c29 0a0a 2020 2020 2020 2020 2020 2020  l)..            
+00009640: 7365 6c66 2e6c 6f67 6765 722e 6465 6275  self.logger.debu
+00009650: 6728 2250 6174 6368 2073 697a 653a 2025  g("Patch size: %
+00009660: 7378 2573 222c 2069 6d67 5f68 6569 6768  sx%s", img_heigh
+00009670: 745f 6d6f 6465 6c2c 2069 6d67 5f77 6964  t_model, img_wid
+00009680: 7468 5f6d 6f64 656c 290a 2020 2020 2020  th_model).      
+00009690: 2020 2020 2020 6d61 7267 696e 203d 2069        margin = i
+000096a0: 6e74 286d 6172 6769 6e61 6c5f 6f66 5f70  nt(marginal_of_p
+000096b0: 6174 6368 5f70 6572 6365 6e74 202a 2069  atch_percent * i
+000096c0: 6d67 5f68 6569 6768 745f 6d6f 6465 6c29  mg_height_model)
+000096d0: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
+000096e0: 7468 5f6d 6964 203d 2069 6d67 5f77 6964  th_mid = img_wid
+000096f0: 7468 5f6d 6f64 656c 202d 2032 202a 206d  th_model - 2 * m
+00009700: 6172 6769 6e0a 2020 2020 2020 2020 2020  argin.          
+00009710: 2020 6865 6967 6874 5f6d 6964 203d 2069    height_mid = i
+00009720: 6d67 5f68 6569 6768 745f 6d6f 6465 6c20  mg_height_model 
+00009730: 2d20 3220 2a20 6d61 7267 696e 0a20 2020  - 2 * margin.   
+00009740: 2020 2020 2020 2020 2069 6d67 203d 2069           img = i
+00009750: 6d67 202f 2066 6c6f 6174 2832 3535 2e30  mg / float(255.0
+00009760: 290a 2020 2020 2020 2020 2020 2020 696d  ).            im
+00009770: 6720 3d20 696d 672e 6173 7479 7065 286e  g = img.astype(n
+00009780: 702e 666c 6f61 7431 3629 0a20 2020 2020  p.float16).     
+00009790: 2020 2020 2020 2069 6d67 5f68 203d 2069         img_h = i
+000097a0: 6d67 2e73 6861 7065 5b30 5d0a 2020 2020  mg.shape[0].    
+000097b0: 2020 2020 2020 2020 696d 675f 7720 3d20          img_w = 
+000097c0: 696d 672e 7368 6170 655b 315d 0a20 2020  img.shape[1].   
+000097d0: 2020 2020 2020 2020 2070 7265 6469 6374           predict
+000097e0: 696f 6e5f 7472 7565 203d 206e 702e 7a65  ion_true = np.ze
+000097f0: 726f 7328 2869 6d67 5f68 2c20 696d 675f  ros((img_h, img_
+00009800: 772c 2033 2929 0a20 2020 2020 2020 2020  w, 3)).         
+00009810: 2020 206d 6173 6b5f 7472 7565 203d 206e     mask_true = n
+00009820: 702e 7a65 726f 7328 2869 6d67 5f68 2c20  p.zeros((img_h, 
+00009830: 696d 675f 7729 290a 2020 2020 2020 2020  img_w)).        
+00009840: 2020 2020 6e78 6620 3d20 696d 675f 7720      nxf = img_w 
+00009850: 2f20 666c 6f61 7428 7769 6474 685f 6d69  / float(width_mi
+00009860: 6429 0a20 2020 2020 2020 2020 2020 206e  d).            n
+00009870: 7966 203d 2069 6d67 5f68 202f 2066 6c6f  yf = img_h / flo
+00009880: 6174 2868 6569 6768 745f 6d69 6429 0a20  at(height_mid). 
+00009890: 2020 2020 2020 2020 2020 206e 7866 203d             nxf =
+000098a0: 2069 6e74 286e 7866 2920 2b20 3120 6966   int(nxf) + 1 if
+000098b0: 206e 7866 203e 2069 6e74 286e 7866 2920   nxf > int(nxf) 
+000098c0: 656c 7365 2069 6e74 286e 7866 290a 2020  else int(nxf).  
+000098d0: 2020 2020 2020 2020 2020 6e79 6620 3d20            nyf = 
+000098e0: 696e 7428 6e79 6629 202b 2031 2069 6620  int(nyf) + 1 if 
+000098f0: 6e79 6620 3e20 696e 7428 6e79 6629 2065  nyf > int(nyf) e
+00009900: 6c73 6520 696e 7428 6e79 6629 0a0a 2020  lse int(nyf)..  
+00009910: 2020 2020 2020 2020 2020 666f 7220 6920            for i 
+00009920: 696e 2072 616e 6765 286e 7866 293a 0a20  in range(nxf):. 
+00009930: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00009940: 6f72 206a 2069 6e20 7261 6e67 6528 6e79  or j in range(ny
+00009950: 6629 3a0a 2020 2020 2020 2020 2020 2020  f):.            
+00009960: 2020 2020 2020 2020 6966 2069 203d 3d20          if i == 
+00009970: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00009980: 2020 2020 2020 2020 2020 2069 6e64 6578             index
+00009990: 5f78 5f64 203d 2069 202a 2077 6964 7468  _x_d = i * width
+000099a0: 5f6d 6964 0a20 2020 2020 2020 2020 2020  _mid.           
+000099b0: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+000099c0: 6578 5f78 5f75 203d 2069 6e64 6578 5f78  ex_x_u = index_x
+000099d0: 5f64 202b 2069 6d67 5f77 6964 7468 5f6d  _d + img_width_m
+000099e0: 6f64 656c 0a20 2020 2020 2020 2020 2020  odel.           
+000099f0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+00009a00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009a10: 2020 2020 2020 2069 6e64 6578 5f78 5f64         index_x_d
+00009a20: 203d 2069 202a 2077 6964 7468 5f6d 6964   = i * width_mid
+00009a30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009a40: 2020 2020 2020 2020 2069 6e64 6578 5f78           index_x
+00009a50: 5f75 203d 2069 6e64 6578 5f78 5f64 202b  _u = index_x_d +
+00009a60: 2069 6d67 5f77 6964 7468 5f6d 6f64 656c   img_width_model
+00009a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009a80: 2020 2020 2069 6620 6a20 3d3d 2030 3a0a       if j == 0:.
+00009a90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009aa0: 2020 2020 2020 2020 696e 6465 785f 795f          index_y_
+00009ab0: 6420 3d20 6a20 2a20 6865 6967 6874 5f6d  d = j * height_m
+00009ac0: 6964 0a20 2020 2020 2020 2020 2020 2020  id.             
+00009ad0: 2020 2020 2020 2020 2020 2069 6e64 6578             index
+00009ae0: 5f79 5f75 203d 2069 6e64 6578 5f79 5f64  _y_u = index_y_d
+00009af0: 202b 2069 6d67 5f68 6569 6768 745f 6d6f   + img_height_mo
+00009b00: 6465 6c0a 2020 2020 2020 2020 2020 2020  del.            
+00009b10: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00009b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009b30: 2020 2020 2020 696e 6465 785f 795f 6420        index_y_d 
+00009b40: 3d20 6a20 2a20 6865 6967 6874 5f6d 6964  = j * height_mid
+00009b50: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009b60: 2020 2020 2020 2020 2069 6e64 6578 5f79           index_y
+00009b70: 5f75 203d 2069 6e64 6578 5f79 5f64 202b  _u = index_y_d +
+00009b80: 2069 6d67 5f68 6569 6768 745f 6d6f 6465   img_height_mode
+00009b90: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
+00009ba0: 2020 2020 2020 6966 2069 6e64 6578 5f78        if index_x
+00009bb0: 5f75 203e 2069 6d67 5f77 3a0a 2020 2020  _u > img_w:.    
+00009bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009bd0: 2020 2020 696e 6465 785f 785f 7520 3d20      index_x_u = 
+00009be0: 696d 675f 770a 2020 2020 2020 2020 2020  img_w.          
+00009bf0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00009c00: 6465 785f 785f 6420 3d20 696d 675f 7720  dex_x_d = img_w 
+00009c10: 2d20 696d 675f 7769 6474 685f 6d6f 6465  - img_width_mode
+00009c20: 6c0a 2020 2020 2020 2020 2020 2020 2020  l.              
+00009c30: 2020 2020 2020 6966 2069 6e64 6578 5f79        if index_y
+00009c40: 5f75 203e 2069 6d67 5f68 3a0a 2020 2020  _u > img_h:.    
+00009c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009c60: 2020 2020 696e 6465 785f 795f 7520 3d20      index_y_u = 
+00009c70: 696d 675f 680a 2020 2020 2020 2020 2020  img_h.          
+00009c80: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00009c90: 6465 785f 795f 6420 3d20 696d 675f 6820  dex_y_d = img_h 
+00009ca0: 2d20 696d 675f 6865 6967 6874 5f6d 6f64  - img_height_mod
+00009cb0: 656c 0a0a 2020 2020 2020 2020 2020 2020  el..            
+00009cc0: 2020 2020 2020 2020 696d 675f 7061 7463          img_patc
+00009cd0: 6820 3d20 696d 675b 696e 6465 785f 795f  h = img[index_y_
+00009ce0: 643a 696e 6465 785f 795f 752c 2069 6e64  d:index_y_u, ind
+00009cf0: 6578 5f78 5f64 3a69 6e64 6578 5f78 5f75  ex_x_d:index_x_u
+00009d00: 2c20 3a5d 0a20 2020 2020 2020 2020 2020  , :].           
+00009d10: 2020 2020 2020 2020 206c 6162 656c 5f70           label_p
+00009d20: 5f70 7265 6420 3d20 6d6f 6465 6c2e 7072  _pred = model.pr
+00009d30: 6564 6963 7428 696d 675f 7061 7463 682e  edict(img_patch.
+00009d40: 7265 7368 6170 6528 312c 2069 6d67 5f70  reshape(1, img_p
+00009d50: 6174 6368 2e73 6861 7065 5b30 5d2c 2069  atch.shape[0], i
+00009d60: 6d67 5f70 6174 6368 2e73 6861 7065 5b31  mg_patch.shape[1
+00009d70: 5d2c 2069 6d67 5f70 6174 6368 2e73 6861  ], img_patch.sha
+00009d80: 7065 5b32 5d29 2c0a 2020 2020 2020 2020  pe[2]),.        
+00009d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009db0: 2020 2020 2020 2020 2076 6572 626f 7365           verbose
+00009dc0: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
+00009dd0: 2020 2020 2020 2020 7365 6720 3d20 6e70          seg = np
+00009de0: 2e61 7267 6d61 7828 6c61 6265 6c5f 705f  .argmax(label_p_
+00009df0: 7072 6564 2c20 6178 6973 3d33 295b 305d  pred, axis=3)[0]
+00009e00: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009e10: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+00009e20: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00009e30: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00009e40: 6567 5f6e 6f74 5f62 6173 6520 3d20 6c61  eg_not_base = la
+00009e50: 6265 6c5f 705f 7072 6564 5b30 2c3a 2c3a  bel_p_pred[0,:,:
+00009e60: 2c34 5d0a 2020 2020 2020 2020 2020 2020  ,4].            
+00009e70: 2020 2020 2020 2020 2323 7365 6732 203d          ##seg2 =
+00009e80: 202d 6c61 6265 6c5f 705f 7072 6564 5b30   -label_p_pred[0
+00009e90: 2c3a 2c3a 2c32 5d0a 2020 2020 2020 2020  ,:,:,2].        
+00009ea0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00009eb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009ec0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00009ed0: 2020 2020 2020 7365 675f 6e6f 745f 6261        seg_not_ba
+00009ee0: 7365 5b73 6567 5f6e 6f74 5f62 6173 653e  se[seg_not_base>
+00009ef0: 302e 3033 5d20 3d31 0a20 2020 2020 2020  0.03] =1.       
+00009f00: 2020 2020 2020 2020 2020 2020 2073 6567               seg
+00009f10: 5f6e 6f74 5f62 6173 655b 7365 675f 6e6f  _not_base[seg_no
+00009f20: 745f 6261 7365 3c31 5d20 3d30 0a20 2020  t_base<1] =0.   
+00009f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f40: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00009f50: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+00009f60: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00009f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00009f80: 7365 675f 7465 7374 203d 206c 6162 656c  seg_test = label
+00009f90: 5f70 5f70 7265 645b 302c 3a2c 3a2c 315d  _p_pred[0,:,:,1]
+00009fa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00009fb0: 2020 2020 2023 2373 6567 3220 3d20 2d6c       ##seg2 = -l
+00009fc0: 6162 656c 5f70 5f70 7265 645b 302c 3a2c  abel_p_pred[0,:,
+00009fd0: 3a2c 325d 0a20 2020 2020 2020 2020 2020  :,2].           
+00009fe0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+00009ff0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+0000a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a010: 2020 2073 6567 5f74 6573 745b 7365 675f     seg_test[seg_
+0000a020: 7465 7374 3e30 2e37 355d 203d 310a 2020  test>0.75] =1.  
+0000a030: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a040: 2020 7365 675f 7465 7374 5b73 6567 5f74    seg_test[seg_t
+0000a050: 6573 743c 315d 203d 300a 2020 2020 2020  est<1] =0.      
+0000a060: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+0000a070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a080: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+0000a090: 2020 2020 2020 2020 7365 675f 6c69 6e65          seg_line
+0000a0a0: 203d 206c 6162 656c 5f70 5f70 7265 645b   = label_p_pred[
+0000a0b0: 302c 3a2c 3a2c 335d 0a20 2020 2020 2020  0,:,:,3].       
+0000a0c0: 2020 2020 2020 2020 2020 2020 2023 2373               ##s
+0000a0d0: 6567 3220 3d20 2d6c 6162 656c 5f70 5f70  eg2 = -label_p_p
+0000a0e0: 7265 645b 302c 3a2c 3a2c 325d 0a20 2020  red[0,:,:,2].   
+0000a0f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a100: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+0000a110: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0000a120: 2020 2020 2020 2020 2020 2073 6567 5f6c             seg_l
+0000a130: 696e 655b 7365 675f 6c69 6e65 3e30 2e31  ine[seg_line>0.1
+0000a140: 5d20 3d31 0a20 2020 2020 2020 2020 2020  ] =1.           
+0000a150: 2020 2020 2020 2020 2073 6567 5f6c 696e           seg_lin
+0000a160: 655b 7365 675f 6c69 6e65 3c31 5d20 3d30  e[seg_line<1] =0
+0000a170: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a180: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+0000a190: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0000a1a0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000a1b0: 6567 5f62 6163 6b67 726f 756e 6420 3d20  eg_background = 
+0000a1c0: 6c61 6265 6c5f 705f 7072 6564 5b30 2c3a  label_p_pred[0,:
+0000a1d0: 2c3a 2c30 5d0a 2020 2020 2020 2020 2020  ,:,0].          
+0000a1e0: 2020 2020 2020 2020 2020 2323 7365 6732            ##seg2
+0000a1f0: 203d 202d 6c61 6265 6c5f 705f 7072 6564   = -label_p_pred
+0000a200: 5b30 2c3a 2c3a 2c32 5d0a 2020 2020 2020  [0,:,:,2].      
+0000a210: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+0000a220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a230: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+0000a240: 2020 2020 2020 2020 7365 675f 6261 636b          seg_back
+0000a250: 6772 6f75 6e64 5b73 6567 5f62 6163 6b67  ground[seg_backg
+0000a260: 726f 756e 643e 302e 3235 5d20 3d31 0a20  round>0.25] =1. 
+0000a270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a280: 2020 2073 6567 5f62 6163 6b67 726f 756e     seg_backgroun
+0000a290: 645b 7365 675f 6261 636b 6772 6f75 6e64  d[seg_background
+0000a2a0: 3c31 5d20 3d30 0a20 2020 2020 2020 2020  <1] =0.         
+0000a2b0: 2020 2020 2020 2020 2020 2023 2373 6567             ##seg
+0000a2c0: 203d 2073 6567 2b73 6567 320a 2020 2020   = seg+seg2.    
+0000a2d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a2e0: 2373 6567 203d 206c 6162 656c 5f70 5f70  #seg = label_p_p
+0000a2f0: 7265 645b 302c 3a2c 3a2c 325d 0a20 2020  red[0,:,:,2].   
+0000a300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a310: 2023 7365 675b 7365 673e 302e 345d 203d   #seg[seg>0.4] =
+0000a320: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+0000a330: 2020 2020 2020 2373 6567 5b73 6567 3c31        #seg[seg<1
+0000a340: 5d20 3d30 0a20 2020 2020 2020 2020 2020  ] =0.           
+0000a350: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0000a360: 2020 2020 2020 2020 2020 2020 2020 2323                ##
+0000a370: 706c 742e 696d 7368 6f77 2873 6567 5f74  plt.imshow(seg_t
+0000a380: 6573 7429 0a20 2020 2020 2020 2020 2020  est).           
+0000a390: 2020 2020 2020 2020 2023 2370 6c74 2e73           ##plt.s
+0000a3a0: 686f 7728 290a 2020 2020 2020 2020 2020  how().          
+0000a3b0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0000a3c0: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0000a3d0: 2370 6c74 2e69 6d73 686f 7728 7365 675f  #plt.imshow(seg_
+0000a3e0: 6261 636b 6772 6f75 6e64 290a 2020 2020  background).    
+0000a3f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a400: 2323 706c 742e 7368 6f77 2829 0a20 2020  ##plt.show().   
+0000a410: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a420: 2023 7365 675b 7365 673d 3d31 5d3d 300a   #seg[seg==1]=0.
+0000a430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a440: 2020 2020 2373 6567 5b73 6567 5f74 6573      #seg[seg_tes
+0000a450: 743d 3d31 5d3d 310a 2020 2020 2020 2020  t==1]=1.        
+0000a460: 2020 2020 2020 2020 2020 2020 7365 675b              seg[
+0000a470: 7365 675f 6e6f 745f 6261 7365 3d3d 315d  seg_not_base==1]
+0000a480: 3d34 0a20 2020 2020 2020 2020 2020 2020  =4.             
+0000a490: 2020 2020 2020 2073 6567 5b73 6567 5f62         seg[seg_b
+0000a4a0: 6163 6b67 726f 756e 643d 3d31 5d3d 300a  ackground==1]=0.
+0000a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a4c0: 2020 2020 7365 675b 2873 6567 5f6c 696e      seg[(seg_lin
+0000a4d0: 653d 3d31 2920 2620 2873 6567 3d3d 3029  e==1) & (seg==0)
+0000a4e0: 5d3d 330a 2020 2020 2020 2020 2020 2020  ]=3.            
+0000a4f0: 2020 2020 2020 2020 7365 675f 636f 6c6f          seg_colo
+0000a500: 7220 3d20 6e70 2e72 6570 6561 7428 7365  r = np.repeat(se
+0000a510: 675b 3a2c 203a 2c20 6e70 2e6e 6577 6178  g[:, :, np.newax
+0000a520: 6973 5d2c 2033 2c20 6178 6973 3d32 290a  is], 3, axis=2).
+0000a530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000a540: 2020 2020 2069 6620 6920 3d3d 2030 2061       if i == 0 a
+0000a550: 6e64 206a 203d 3d20 303a 0a20 2020 2020  nd j == 0:.     
+0000a560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a570: 2020 2073 6567 5f63 6f6c 6f72 203d 2073     seg_color = s
+0000a580: 6567 5f63 6f6c 6f72 5b30 203a 2073 6567  eg_color[0 : seg
+0000a590: 5f63 6f6c 6f72 2e73 6861 7065 5b30 5d20  _color.shape[0] 
+0000a5a0: 2d20 6d61 7267 696e 2c20 3020 3a20 7365  - margin, 0 : se
+0000a5b0: 675f 636f 6c6f 722e 7368 6170 655b 315d  g_color.shape[1]
+0000a5c0: 202d 206d 6172 6769 6e2c 203a 5d0a 2020   - margin, :].  
+0000a5d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a5e0: 2020 2020 2020 7365 6720 3d20 7365 675b        seg = seg[
+0000a5f0: 3020 3a20 7365 672e 7368 6170 655b 305d  0 : seg.shape[0]
+0000a600: 202d 206d 6172 6769 6e2c 2030 203a 2073   - margin, 0 : s
+0000a610: 6567 2e73 6861 7065 5b31 5d20 2d20 6d61  eg.shape[1] - ma
+0000a620: 7267 696e 5d0a 2020 2020 2020 2020 2020  rgin].          
+0000a630: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+0000a640: 736b 5f74 7275 655b 696e 6465 785f 795f  sk_true[index_y_
+0000a650: 6420 2b20 3020 3a20 696e 6465 785f 795f  d + 0 : index_y_
+0000a660: 7520 2d20 6d61 7267 696e 2c20 696e 6465  u - margin, inde
+0000a670: 785f 785f 6420 2b20 3020 3a20 696e 6465  x_x_d + 0 : inde
+0000a680: 785f 785f 7520 2d20 6d61 7267 696e 5d20  x_x_u - margin] 
+0000a690: 3d20 7365 670a 2020 2020 2020 2020 2020  = seg.          
+0000a6a0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0000a6b0: 6564 6963 7469 6f6e 5f74 7275 655b 696e  ediction_true[in
+0000a6c0: 6465 785f 795f 6420 2b20 3020 3a20 696e  dex_y_d + 0 : in
+0000a6d0: 6465 785f 795f 7520 2d20 6d61 7267 696e  dex_y_u - margin
+0000a6e0: 2c20 696e 6465 785f 785f 6420 2b20 3020  , index_x_d + 0 
+0000a6f0: 3a20 696e 6465 785f 785f 7520 2d20 6d61  : index_x_u - ma
+0000a700: 7267 696e 2c20 3a5d 203d 2073 6567 5f63  rgin, :] = seg_c
+0000a710: 6f6c 6f72 0a20 2020 2020 2020 2020 2020  olor.           
+0000a720: 2020 2020 2020 2020 2065 6c69 6620 6920           elif i 
+0000a730: 3d3d 206e 7866 202d 2031 2061 6e64 206a  == nxf - 1 and j
+0000a740: 203d 3d20 6e79 6620 2d20 313a 0a20 2020   == nyf - 1:.   
+0000a750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a760: 2020 2020 2073 6567 5f63 6f6c 6f72 203d       seg_color =
+0000a770: 2073 6567 5f63 6f6c 6f72 5b6d 6172 6769   seg_color[margi
+0000a780: 6e20 3a20 7365 675f 636f 6c6f 722e 7368  n : seg_color.sh
+0000a790: 6170 655b 305d 202d 2030 2c20 6d61 7267  ape[0] - 0, marg
+0000a7a0: 696e 203a 2073 6567 5f63 6f6c 6f72 2e73  in : seg_color.s
+0000a7b0: 6861 7065 5b31 5d20 2d20 302c 203a 5d0a  hape[1] - 0, :].
+0000a7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a7d0: 2020 2020 2020 2020 7365 6720 3d20 7365          seg = se
+0000a7e0: 675b 6d61 7267 696e 203a 2073 6567 2e73  g[margin : seg.s
+0000a7f0: 6861 7065 5b30 5d20 2d20 302c 206d 6172  hape[0] - 0, mar
+0000a800: 6769 6e20 3a20 7365 672e 7368 6170 655b  gin : seg.shape[
+0000a810: 315d 202d 2030 5d0a 2020 2020 2020 2020  1] - 0].        
+0000a820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a830: 6d61 736b 5f74 7275 655b 696e 6465 785f  mask_true[index_
+0000a840: 795f 6420 2b20 6d61 7267 696e 203a 2069  y_d + margin : i
+0000a850: 6e64 6578 5f79 5f75 202d 2030 2c20 696e  ndex_y_u - 0, in
+0000a860: 6465 785f 785f 6420 2b20 6d61 7267 696e  dex_x_d + margin
+0000a870: 203a 2069 6e64 6578 5f78 5f75 202d 2030   : index_x_u - 0
+0000a880: 5d20 3d20 7365 670a 2020 2020 2020 2020  ] = seg.        
+0000a890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a8a0: 7072 6564 6963 7469 6f6e 5f74 7275 655b  prediction_true[
+0000a8b0: 696e 6465 785f 795f 6420 2b20 6d61 7267  index_y_d + marg
+0000a8c0: 696e 203a 2069 6e64 6578 5f79 5f75 202d  in : index_y_u -
+0000a8d0: 2030 2c20 696e 6465 785f 785f 6420 2b20   0, index_x_d + 
+0000a8e0: 6d61 7267 696e 203a 2069 6e64 6578 5f78  margin : index_x
+0000a8f0: 5f75 202d 2030 2c20 3a5d 203d 2073 6567  _u - 0, :] = seg
+0000a900: 5f63 6f6c 6f72 0a20 2020 2020 2020 2020  _color.         
+0000a910: 2020 2020 2020 2020 2020 2065 6c69 6620             elif 
+0000a920: 6920 3d3d 2030 2061 6e64 206a 203d 3d20  i == 0 and j == 
+0000a930: 6e79 6620 2d20 313a 0a20 2020 2020 2020  nyf - 1:.       
+0000a940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a950: 2073 6567 5f63 6f6c 6f72 203d 2073 6567   seg_color = seg
+0000a960: 5f63 6f6c 6f72 5b6d 6172 6769 6e20 3a20  _color[margin : 
+0000a970: 7365 675f 636f 6c6f 722e 7368 6170 655b  seg_color.shape[
+0000a980: 305d 202d 2030 2c20 3020 3a20 7365 675f  0] - 0, 0 : seg_
+0000a990: 636f 6c6f 722e 7368 6170 655b 315d 202d  color.shape[1] -
+0000a9a0: 206d 6172 6769 6e2c 203a 5d0a 2020 2020   margin, :].    
+0000a9b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000a9c0: 2020 2020 7365 6720 3d20 7365 675b 6d61      seg = seg[ma
+0000a9d0: 7267 696e 203a 2073 6567 2e73 6861 7065  rgin : seg.shape
+0000a9e0: 5b30 5d20 2d20 302c 2030 203a 2073 6567  [0] - 0, 0 : seg
+0000a9f0: 2e73 6861 7065 5b31 5d20 2d20 6d61 7267  .shape[1] - marg
+0000aa00: 696e 5d0a 2020 2020 2020 2020 2020 2020  in].            
+0000aa10: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
+0000aa20: 5f74 7275 655b 696e 6465 785f 795f 6420  _true[index_y_d 
+0000aa30: 2b20 6d61 7267 696e 203a 2069 6e64 6578  + margin : index
+0000aa40: 5f79 5f75 202d 2030 2c20 696e 6465 785f  _y_u - 0, index_
+0000aa50: 785f 6420 2b20 3020 3a20 696e 6465 785f  x_d + 0 : index_
+0000aa60: 785f 7520 2d20 6d61 7267 696e 5d20 3d20  x_u - margin] = 
+0000aa70: 7365 670a 2020 2020 2020 2020 2020 2020  seg.            
+0000aa80: 2020 2020 2020 2020 2020 2020 7072 6564              pred
+0000aa90: 6963 7469 6f6e 5f74 7275 655b 696e 6465  iction_true[inde
+0000aaa0: 785f 795f 6420 2b20 6d61 7267 696e 203a  x_y_d + margin :
+0000aab0: 2069 6e64 6578 5f79 5f75 202d 2030 2c20   index_y_u - 0, 
+0000aac0: 696e 6465 785f 785f 6420 2b20 3020 3a20  index_x_d + 0 : 
+0000aad0: 696e 6465 785f 785f 7520 2d20 6d61 7267  index_x_u - marg
+0000aae0: 696e 2c20 3a5d 203d 2073 6567 5f63 6f6c  in, :] = seg_col
+0000aaf0: 6f72 0a20 2020 2020 2020 2020 2020 2020  or.             
+0000ab00: 2020 2020 2020 2065 6c69 6620 6920 3d3d         elif i ==
+0000ab10: 206e 7866 202d 2031 2061 6e64 206a 203d   nxf - 1 and j =
+0000ab20: 3d20 303a 0a20 2020 2020 2020 2020 2020  = 0:.           
+0000ab30: 2020 2020 2020 2020 2020 2020 2073 6567               seg
+0000ab40: 5f63 6f6c 6f72 203d 2073 6567 5f63 6f6c  _color = seg_col
+0000ab50: 6f72 5b30 203a 2073 6567 5f63 6f6c 6f72  or[0 : seg_color
+0000ab60: 2e73 6861 7065 5b30 5d20 2d20 6d61 7267  .shape[0] - marg
+0000ab70: 696e 2c20 6d61 7267 696e 203a 2073 6567  in, margin : seg
+0000ab80: 5f63 6f6c 6f72 2e73 6861 7065 5b31 5d20  _color.shape[1] 
+0000ab90: 2d20 302c 203a 5d0a 2020 2020 2020 2020  - 0, :].        
+0000aba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000abb0: 7365 6720 3d20 7365 675b 3020 3a20 7365  seg = seg[0 : se
+0000abc0: 672e 7368 6170 655b 305d 202d 206d 6172  g.shape[0] - mar
+0000abd0: 6769 6e2c 206d 6172 6769 6e20 3a20 7365  gin, margin : se
+0000abe0: 672e 7368 6170 655b 315d 202d 2030 5d0a  g.shape[1] - 0].
+0000abf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac00: 2020 2020 2020 2020 6d61 736b 5f74 7275          mask_tru
+0000ac10: 655b 696e 6465 785f 795f 6420 2b20 3020  e[index_y_d + 0 
+0000ac20: 3a20 696e 6465 785f 795f 7520 2d20 6d61  : index_y_u - ma
+0000ac30: 7267 696e 2c20 696e 6465 785f 785f 6420  rgin, index_x_d 
+0000ac40: 2b20 6d61 7267 696e 203a 2069 6e64 6578  + margin : index
+0000ac50: 5f78 5f75 202d 2030 5d20 3d20 7365 670a  _x_u - 0] = seg.
+0000ac60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ac70: 2020 2020 2020 2020 7072 6564 6963 7469          predicti
+0000ac80: 6f6e 5f74 7275 655b 696e 6465 785f 795f  on_true[index_y_
+0000ac90: 6420 2b20 3020 3a20 696e 6465 785f 795f  d + 0 : index_y_
+0000aca0: 7520 2d20 6d61 7267 696e 2c20 696e 6465  u - margin, inde
+0000acb0: 785f 785f 6420 2b20 6d61 7267 696e 203a  x_x_d + margin :
+0000acc0: 2069 6e64 6578 5f78 5f75 202d 2030 2c20   index_x_u - 0, 
+0000acd0: 3a5d 203d 2073 6567 5f63 6f6c 6f72 0a20  :] = seg_color. 
+0000ace0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000acf0: 2020 2065 6c69 6620 6920 3d3d 2030 2061     elif i == 0 a
+0000ad00: 6e64 206a 2021 3d20 3020 616e 6420 6a20  nd j != 0 and j 
+0000ad10: 213d 206e 7966 202d 2031 3a0a 2020 2020  != nyf - 1:.    
+0000ad20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000ad30: 2020 2020 7365 675f 636f 6c6f 7220 3d20      seg_color = 
+0000ad40: 7365 675f 636f 6c6f 725b 6d61 7267 696e  seg_color[margin
+0000ad50: 203a 2073 6567 5f63 6f6c 6f72 2e73 6861   : seg_color.sha
+0000ad60: 7065 5b30 5d20 2d20 6d61 7267 696e 2c20  pe[0] - margin, 
+0000ad70: 3020 3a20 7365 675f 636f 6c6f 722e 7368  0 : seg_color.sh
+0000ad80: 6170 655b 315d 202d 206d 6172 6769 6e2c  ape[1] - margin,
+0000ad90: 203a 5d0a 2020 2020 2020 2020 2020 2020   :].            
+0000ada0: 2020 2020 2020 2020 2020 2020 7365 6720              seg 
+0000adb0: 3d20 7365 675b 6d61 7267 696e 203a 2073  = seg[margin : s
+0000adc0: 6567 2e73 6861 7065 5b30 5d20 2d20 6d61  eg.shape[0] - ma
+0000add0: 7267 696e 2c20 3020 3a20 7365 672e 7368  rgin, 0 : seg.sh
+0000ade0: 6170 655b 315d 202d 206d 6172 6769 6e5d  ape[1] - margin]
+0000adf0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000ae00: 2020 2020 2020 2020 206d 6173 6b5f 7472           mask_tr
+0000ae10: 7565 5b69 6e64 6578 5f79 5f64 202b 206d  ue[index_y_d + m
+0000ae20: 6172 6769 6e20 3a20 696e 6465 785f 795f  argin : index_y_
+0000ae30: 7520 2d20 6d61 7267 696e 2c20 696e 6465  u - margin, inde
+0000ae40: 785f 785f 6420 2b20 3020 3a20 696e 6465  x_x_d + 0 : inde
+0000ae50: 785f 785f 7520 2d20 6d61 7267 696e 5d20  x_x_u - margin] 
+0000ae60: 3d20 7365 670a 2020 2020 2020 2020 2020  = seg.          
+0000ae70: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+0000ae80: 6564 6963 7469 6f6e 5f74 7275 655b 696e  ediction_true[in
+0000ae90: 6465 785f 795f 6420 2b20 6d61 7267 696e  dex_y_d + margin
+0000aea0: 203a 2069 6e64 6578 5f79 5f75 202d 206d   : index_y_u - m
+0000aeb0: 6172 6769 6e2c 2069 6e64 6578 5f78 5f64  argin, index_x_d
+0000aec0: 202b 2030 203a 2069 6e64 6578 5f78 5f75   + 0 : index_x_u
+0000aed0: 202d 206d 6172 6769 6e2c 203a 5d20 3d20   - margin, :] = 
+0000aee0: 7365 675f 636f 6c6f 720a 2020 2020 2020  seg_color.      
+0000aef0: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0000af00: 6966 2069 203d 3d20 6e78 6620 2d20 3120  if i == nxf - 1 
+0000af10: 616e 6420 6a20 213d 2030 2061 6e64 206a  and j != 0 and j
+0000af20: 2021 3d20 6e79 6620 2d20 313a 0a20 2020   != nyf - 1:.   
+0000af30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000af40: 2020 2020 2073 6567 5f63 6f6c 6f72 203d       seg_color =
+0000af50: 2073 6567 5f63 6f6c 6f72 5b6d 6172 6769   seg_color[margi
+0000af60: 6e20 3a20 7365 675f 636f 6c6f 722e 7368  n : seg_color.sh
+0000af70: 6170 655b 305d 202d 206d 6172 6769 6e2c  ape[0] - margin,
+0000af80: 206d 6172 6769 6e20 3a20 7365 675f 636f   margin : seg_co
+0000af90: 6c6f 722e 7368 6170 655b 315d 202d 2030  lor.shape[1] - 0
+0000afa0: 2c20 3a5d 0a20 2020 2020 2020 2020 2020  , :].           
+0000afb0: 2020 2020 2020 2020 2020 2020 2073 6567               seg
+0000afc0: 203d 2073 6567 5b6d 6172 6769 6e20 3a20   = seg[margin : 
+0000afd0: 7365 672e 7368 6170 655b 305d 202d 206d  seg.shape[0] - m
+0000afe0: 6172 6769 6e2c 206d 6172 6769 6e20 3a20  argin, margin : 
+0000aff0: 7365 672e 7368 6170 655b 315d 202d 2030  seg.shape[1] - 0
+0000b000: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0000b010: 2020 2020 2020 2020 2020 6d61 736b 5f74            mask_t
+0000b020: 7275 655b 696e 6465 785f 795f 6420 2b20  rue[index_y_d + 
+0000b030: 6d61 7267 696e 203a 2069 6e64 6578 5f79  margin : index_y
+0000b040: 5f75 202d 206d 6172 6769 6e2c 2069 6e64  _u - margin, ind
+0000b050: 6578 5f78 5f64 202b 206d 6172 6769 6e20  ex_x_d + margin 
+0000b060: 3a20 696e 6465 785f 785f 7520 2d20 305d  : index_x_u - 0]
+0000b070: 203d 2073 6567 0a20 2020 2020 2020 2020   = seg.         
+0000b080: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0000b090: 7265 6469 6374 696f 6e5f 7472 7565 5b69  rediction_true[i
+0000b0a0: 6e64 6578 5f79 5f64 202b 206d 6172 6769  ndex_y_d + margi
+0000b0b0: 6e20 3a20 696e 6465 785f 795f 7520 2d20  n : index_y_u - 
+0000b0c0: 6d61 7267 696e 2c20 696e 6465 785f 785f  margin, index_x_
+0000b0d0: 6420 2b20 6d61 7267 696e 203a 2069 6e64  d + margin : ind
+0000b0e0: 6578 5f78 5f75 202d 2030 2c20 3a5d 203d  ex_x_u - 0, :] =
+0000b0f0: 2073 6567 5f63 6f6c 6f72 0a20 2020 2020   seg_color.     
+0000b100: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+0000b110: 6c69 6620 6920 213d 2030 2061 6e64 2069  lif i != 0 and i
+0000b120: 2021 3d20 6e78 6620 2d20 3120 616e 6420   != nxf - 1 and 
+0000b130: 6a20 3d3d 2030 3a0a 2020 2020 2020 2020  j == 0:.        
+0000b140: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b150: 7365 675f 636f 6c6f 7220 3d20 7365 675f  seg_color = seg_
+0000b160: 636f 6c6f 725b 3020 3a20 7365 675f 636f  color[0 : seg_co
+0000b170: 6c6f 722e 7368 6170 655b 305d 202d 206d  lor.shape[0] - m
+0000b180: 6172 6769 6e2c 206d 6172 6769 6e20 3a20  argin, margin : 
+0000b190: 7365 675f 636f 6c6f 722e 7368 6170 655b  seg_color.shape[
+0000b1a0: 315d 202d 206d 6172 6769 6e2c 203a 5d0a  1] - margin, :].
 0000b1b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b1c0: 2020 2020 2020 2020 6966 2061 6273 2873          if abs(s
-0000b1d0: 6c6f 7065 5f66 6f72 5f61 6c6c 2920 3c20  lope_for_all) < 
-0000b1e0: 302e 353a 0a20 2020 2020 2020 2020 2020  0.5:.           
-0000b1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b200: 2073 6c6f 7065 5f66 6f72 5f61 6c6c 203d   slope_for_all =
-0000b210: 205b 736c 6f70 655f 6465 736b 6577 5d5b   [slope_deskew][
-0000b220: 305d 0a0a 2020 2020 2020 2020 2020 2020  0]..            
-0000b230: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
-0000b240: 7469 6f6e 2061 7320 7768 793a 0a20 2020  tion as why:.   
-0000b250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b260: 2073 656c 662e 6c6f 6767 6572 2e65 7272   self.logger.err
-0000b270: 6f72 2877 6879 290a 2020 2020 2020 2020  or(why).        
-0000b280: 2020 2020 2020 2020 2020 2020 736c 6f70              slop
-0000b290: 655f 666f 725f 616c 6c20 3d20 4d41 585f  e_for_all = MAX_
-0000b2a0: 534c 4f50 450a 0a20 2020 2020 2020 2020  SLOPE..         
-0000b2b0: 2020 2020 2020 2069 6620 736c 6f70 655f         if slope_
-0000b2c0: 666f 725f 616c 6c20 3d3d 204d 4158 5f53  for_all == MAX_S
-0000b2d0: 4c4f 5045 3a0a 2020 2020 2020 2020 2020  LOPE:.          
-0000b2e0: 2020 2020 2020 2020 2020 736c 6f70 655f            slope_
-0000b2f0: 666f 725f 616c 6c20 3d20 5b73 6c6f 7065  for_all = [slope
-0000b300: 5f64 6573 6b65 775d 5b30 5d0a 2020 2020  _deskew][0].    
-0000b310: 2020 2020 2020 2020 2020 2020 736c 6f70              slop
-0000b320: 6573 5f70 6572 5f65 6163 685f 7375 6270  es_per_each_subp
-0000b330: 726f 6365 7373 2e61 7070 656e 6428 736c  rocess.append(sl
-0000b340: 6f70 655f 666f 725f 616c 6c29 0a0a 2020  ope_for_all)..  
-0000b350: 2020 2020 2020 2020 2020 696e 6465 785f            index_
-0000b360: 6279 5f74 6578 745f 7265 6769 6f6e 5f63  by_text_region_c
-0000b370: 6f6e 746f 7572 732e 6170 7065 6e64 2869  ontours.append(i
-0000b380: 6e64 6578 6573 5f72 5f63 6f6e 5f70 6572  ndexes_r_con_per
-0000b390: 5f70 726f 5b6d 765d 290a 2020 2020 2020  _pro[mv]).      
-0000b3a0: 2020 2020 2020 5f2c 2063 726f 705f 636f        _, crop_co
-0000b3b0: 6f72 203d 2063 726f 705f 696d 6167 655f  or = crop_image_
-0000b3c0: 696e 7369 6465 5f62 6f78 2862 6f78 6573  inside_box(boxes
-0000b3d0: 5f74 6578 745b 6d76 5d2c 2069 6d61 6765  _text[mv], image
-0000b3e0: 5f70 6167 655f 726f 7461 7465 6429 0a0a  _page_rotated)..
-0000b3f0: 2020 2020 2020 2020 2020 2020 6966 2061              if a
-0000b400: 6273 2873 6c6f 7065 5f66 6f72 5f61 6c6c  bs(slope_for_all
-0000b410: 2920 3c20 3435 3a0a 2020 2020 2020 2020  ) < 45:.        
-0000b420: 2020 2020 2020 2020 2320 616c 6c5f 626f          # all_bo
-0000b430: 785f 636f 6f72 642e 6170 7065 6e64 2863  x_coord.append(c
-0000b440: 726f 705f 636f 6f72 290a 2020 2020 2020  rop_coor).      
-0000b450: 2020 2020 2020 2020 2020 7465 7874 6c69            textli
-0000b460: 6e65 5f72 6567 696f 6e5f 696e 5f69 6d61  ne_region_in_ima
-0000b470: 6765 203d 206e 702e 7a65 726f 7328 7465  ge = np.zeros(te
-0000b480: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745f  xtline_mask_tot_
-0000b490: 6561 2e73 6861 7065 290a 2020 2020 2020  ea.shape).      
-0000b4a0: 2020 2020 2020 2020 2020 636e 745f 6f5f            cnt_o_
-0000b4b0: 745f 6d61 7820 3d20 636f 6e74 6f75 7273  t_max = contours
-0000b4c0: 5f70 6172 5f70 6572 5f70 726f 6365 7373  _par_per_process
-0000b4d0: 5b6d 765d 0a20 2020 2020 2020 2020 2020  [mv].           
-0000b4e0: 2020 2020 2078 2c20 792c 2077 2c20 6820       x, y, w, h 
-0000b4f0: 3d20 6376 322e 626f 756e 6469 6e67 5265  = cv2.boundingRe
-0000b500: 6374 2863 6e74 5f6f 5f74 5f6d 6178 290a  ct(cnt_o_t_max).
-0000b510: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b520: 6d61 736b 5f62 6967 6765 7374 203d 206e  mask_biggest = n
-0000b530: 702e 7a65 726f 7328 6d61 736b 5f74 6578  p.zeros(mask_tex
-0000b540: 7473 5f6f 6e6c 792e 7368 6170 6529 0a20  ts_only.shape). 
-0000b550: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000b560: 6173 6b5f 6269 6767 6573 7420 3d20 6376  ask_biggest = cv
-0000b570: 322e 6669 6c6c 506f 6c79 286d 6173 6b5f  2.fillPoly(mask_
-0000b580: 6269 6767 6573 742c 2070 7473 3d5b 636e  biggest, pts=[cn
-0000b590: 745f 6f5f 745f 6d61 785d 2c20 636f 6c6f  t_o_t_max], colo
-0000b5a0: 723d 2831 2c20 312c 2031 2929 0a20 2020  r=(1, 1, 1)).   
-0000b5b0: 2020 2020 2020 2020 2020 2020 206d 6173               mas
-0000b5c0: 6b5f 7265 6769 6f6e 5f69 6e5f 7061 7463  k_region_in_patc
-0000b5d0: 685f 7265 6769 6f6e 203d 206d 6173 6b5f  h_region = mask_
-0000b5e0: 6269 6767 6573 745b 7920 3a20 7920 2b20  biggest[y : y + 
-0000b5f0: 682c 2078 203a 2078 202b 2077 5d0a 2020  h, x : x + w].  
-0000b600: 2020 2020 2020 2020 2020 2020 2020 7465                te
-0000b610: 7874 6c69 6e65 5f62 6967 6765 7374 5f72  xtline_biggest_r
-0000b620: 6567 696f 6e20 3d20 6d61 736b 5f62 6967  egion = mask_big
-0000b630: 6765 7374 202a 2074 6578 746c 696e 655f  gest * textline_
-0000b640: 6d61 736b 5f74 6f74 5f65 610a 0a20 2020  mask_tot_ea..   
-0000b650: 2020 2020 2020 2020 2020 2020 2023 2070               # p
-0000b660: 7269 6e74 2873 6c6f 7065 5f66 6f72 5f61  rint(slope_for_a
-0000b670: 6c6c 2c27 736c 6f70 655f 666f 725f 616c  ll,'slope_for_al
-0000b680: 6c27 290a 2020 2020 2020 2020 2020 2020  l').            
-0000b690: 2020 2020 7465 7874 6c69 6e65 5f72 6f74      textline_rot
-0000b6a0: 6174 6564 5f73 6570 6172 6174 6564 203d  ated_separated =
-0000b6b0: 2073 6570 6172 6174 655f 6c69 6e65 735f   separate_lines_
-0000b6c0: 6e65 7732 2874 6578 746c 696e 655f 6269  new2(textline_bi
-0000b6d0: 6767 6573 745f 7265 6769 6f6e 5b79 203a  ggest_region[y :
-0000b6e0: 2079 202b 2068 2c20 7820 3a20 7820 2b20   y + h, x : x + 
-0000b6f0: 775d 2c20 302c 206e 756d 5f63 6f6c 2c20  w], 0, num_col, 
-0000b700: 736c 6f70 655f 666f 725f 616c 6c2c 2070  slope_for_all, p
-0000b710: 6c6f 7474 6572 3d73 656c 662e 706c 6f74  lotter=self.plot
-0000b720: 7465 7229 0a0a 2020 2020 2020 2020 2020  ter)..          
-0000b730: 2020 2020 2020 2320 6e65 7720 6c69 6e65        # new line
-0000b740: 2061 6464 6564 0a20 2020 2020 2020 2020   added.         
-0000b750: 2020 2020 2020 2023 2370 7269 6e74 286e         ##print(n
-0000b760: 702e 7368 6170 6528 7465 7874 6c69 6e65  p.shape(textline
-0000b770: 5f72 6f74 6174 6564 5f73 6570 6172 6174  _rotated_separat
-0000b780: 6564 292c 6e70 2e73 6861 7065 286d 6173  ed),np.shape(mas
-0000b790: 6b5f 6269 6767 6573 7429 290a 2020 2020  k_biggest)).    
-0000b7a0: 2020 2020 2020 2020 2020 2020 7465 7874              text
-0000b7b0: 6c69 6e65 5f72 6f74 6174 6564 5f73 6570  line_rotated_sep
-0000b7c0: 6172 6174 6564 5b6d 6173 6b5f 7265 6769  arated[mask_regi
-0000b7d0: 6f6e 5f69 6e5f 7061 7463 685f 7265 6769  on_in_patch_regi
-0000b7e0: 6f6e 5b3a 2c20 3a5d 2021 3d20 315d 203d  on[:, :] != 1] =
-0000b7f0: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-0000b800: 2020 2023 2074 696c 6c20 6865 7265 0a0a     # till here..
-0000b810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b820: 7465 7874 6c69 6e65 5f63 6e74 5f73 6570  textline_cnt_sep
-0000b830: 6172 6174 6564 5b79 203a 2079 202b 2068  arated[y : y + h
-0000b840: 2c20 7820 3a20 7820 2b20 775d 203d 2074  , x : x + w] = t
-0000b850: 6578 746c 696e 655f 726f 7461 7465 645f  extline_rotated_
-0000b860: 7365 7061 7261 7465 640a 2020 2020 2020  separated.      
-0000b870: 2020 2020 2020 2020 2020 7465 7874 6c69            textli
-0000b880: 6e65 5f72 6567 696f 6e5f 696e 5f69 6d61  ne_region_in_ima
-0000b890: 6765 5b79 203a 2079 202b 2068 2c20 7820  ge[y : y + h, x 
-0000b8a0: 3a20 7820 2b20 775d 203d 2074 6578 746c  : x + w] = textl
-0000b8b0: 696e 655f 726f 7461 7465 645f 7365 7061  ine_rotated_sepa
-0000b8c0: 7261 7465 640a 0a20 2020 2020 2020 2020  rated..         
-0000b8d0: 2020 2020 2020 2023 2070 6c74 2e69 6d73         # plt.ims
-0000b8e0: 686f 7728 7465 7874 6c69 6e65 5f72 6567  how(textline_reg
-0000b8f0: 696f 6e5f 696e 5f69 6d61 6765 290a 2020  ion_in_image).  
-0000b900: 2020 2020 2020 2020 2020 2020 2020 2320                # 
-0000b910: 706c 742e 7368 6f77 2829 0a20 2020 2020  plt.show().     
-0000b920: 2020 2020 2020 2020 2020 2023 2070 6c74             # plt
-0000b930: 2e69 6d73 686f 7728 7465 7874 6c69 6e65  .imshow(textline
-0000b940: 5f63 6e74 5f73 6570 6172 6174 6564 290a  _cnt_separated).
-0000b950: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000b960: 2320 706c 742e 7368 6f77 2829 0a0a 2020  # plt.show()..  
-0000b970: 2020 2020 2020 2020 2020 2020 2020 7069                pi
-0000b980: 7865 6c5f 696d 6720 3d20 310a 2020 2020  xel_img = 1.    
-0000b990: 2020 2020 2020 2020 2020 2020 636e 745f              cnt_
-0000b9a0: 7465 7874 6c69 6e65 735f 696e 5f69 6d61  textlines_in_ima
-0000b9b0: 6765 203d 2072 6574 7572 6e5f 636f 6e74  ge = return_cont
-0000b9c0: 6f75 7273 5f6f 665f 696e 7465 7265 7374  ours_of_interest
-0000b9d0: 6564 5f74 6578 746c 696e 6528 7465 7874  ed_textline(text
-0000b9e0: 6c69 6e65 5f72 6567 696f 6e5f 696e 5f69  line_region_in_i
-0000b9f0: 6d61 6765 2c20 7069 7865 6c5f 696d 6729  mage, pixel_img)
-0000ba00: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0000ba10: 2020 7465 7874 6c69 6e65 735f 636e 745f    textlines_cnt_
-0000ba20: 7065 725f 7265 6769 6f6e 203d 205b 5d0a  per_region = [].
-0000ba30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ba40: 666f 7220 6a6a 6a6a 2069 6e20 7261 6e67  for jjjj in rang
-0000ba50: 6528 6c65 6e28 636e 745f 7465 7874 6c69  e(len(cnt_textli
-0000ba60: 6e65 735f 696e 5f69 6d61 6765 2929 3a0a  nes_in_image)):.
-0000ba70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ba80: 2020 2020 6d61 736b 5f62 6967 6765 7374      mask_biggest
-0000ba90: 3220 3d20 6e70 2e7a 6572 6f73 286d 6173  2 = np.zeros(mas
-0000baa0: 6b5f 7465 7874 735f 6f6e 6c79 2e73 6861  k_texts_only.sha
-0000bab0: 7065 290a 2020 2020 2020 2020 2020 2020  pe).            
-0000bac0: 2020 2020 2020 2020 6d61 736b 5f62 6967          mask_big
-0000bad0: 6765 7374 3220 3d20 6376 322e 6669 6c6c  gest2 = cv2.fill
-0000bae0: 506f 6c79 286d 6173 6b5f 6269 6767 6573  Poly(mask_bigges
-0000baf0: 7432 2c20 7074 733d 5b63 6e74 5f74 6578  t2, pts=[cnt_tex
-0000bb00: 746c 696e 6573 5f69 6e5f 696d 6167 655b  tlines_in_image[
-0000bb10: 6a6a 6a6a 5d5d 2c20 636f 6c6f 723d 2831  jjjj]], color=(1
-0000bb20: 2c20 312c 2031 2929 0a20 2020 2020 2020  , 1, 1)).       
-0000bb30: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000bb40: 6e75 6d5f 636f 6c20 2b20 3120 3d3d 2031  num_col + 1 == 1
-0000bb50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000bb60: 2020 2020 2020 2020 2020 6d61 736b 5f62            mask_b
-0000bb70: 6967 6765 7374 3220 3d20 6376 322e 6469  iggest2 = cv2.di
-0000bb80: 6c61 7465 286d 6173 6b5f 6269 6767 6573  late(mask_bigges
-0000bb90: 7432 2c20 4b45 524e 454c 2c20 6974 6572  t2, KERNEL, iter
-0000bba0: 6174 696f 6e73 3d35 290a 2020 2020 2020  ations=5).      
-0000bbb0: 2020 2020 2020 2020 2020 2020 2020 656c                el
-0000bbc0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
-0000bbd0: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
-0000bbe0: 5f62 6967 6765 7374 3220 3d20 6376 322e  _biggest2 = cv2.
-0000bbf0: 6469 6c61 7465 286d 6173 6b5f 6269 6767  dilate(mask_bigg
-0000bc00: 6573 7432 2c20 4b45 524e 454c 2c20 6974  est2, KERNEL, it
-0000bc10: 6572 6174 696f 6e73 3d34 290a 0a20 2020  erations=4)..   
-0000bc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc30: 2070 6978 656c 5f69 6d67 203d 2031 0a20   pixel_img = 1. 
-0000bc40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bc50: 2020 206d 6173 6b5f 6269 6767 6573 7432     mask_biggest2
-0000bc60: 203d 2072 6573 697a 655f 696d 6167 6528   = resize_image(
-0000bc70: 6d61 736b 5f62 6967 6765 7374 322c 2069  mask_biggest2, i
-0000bc80: 6e74 286d 6173 6b5f 6269 6767 6573 7432  nt(mask_biggest2
-0000bc90: 2e73 6861 7065 5b30 5d20 2a20 7363 616c  .shape[0] * scal
-0000bca0: 655f 7061 7229 2c20 696e 7428 6d61 736b  e_par), int(mask
-0000bcb0: 5f62 6967 6765 7374 322e 7368 6170 655b  _biggest2.shape[
-0000bcc0: 315d 202a 2073 6361 6c65 5f70 6172 2929  1] * scale_par))
-0000bcd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000bce0: 2020 2020 2063 6e74 5f74 6578 746c 696e       cnt_textlin
-0000bcf0: 6573 5f69 6e5f 696d 6167 655f 696e 6420  es_in_image_ind 
-0000bd00: 3d20 7265 7475 726e 5f63 6f6e 746f 7572  = return_contour
-0000bd10: 735f 6f66 5f69 6e74 6572 6573 7465 645f  s_of_interested_
-0000bd20: 7465 7874 6c69 6e65 286d 6173 6b5f 6269  textline(mask_bi
-0000bd30: 6767 6573 7432 2c20 7069 7865 6c5f 696d  ggest2, pixel_im
-0000bd40: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
-0000bd50: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0000bd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bd70: 2020 2020 7465 7874 6c69 6e65 735f 636e      textlines_cn
-0000bd80: 745f 7065 725f 7265 6769 6f6e 2e61 7070  t_per_region.app
-0000bd90: 656e 6428 636e 745f 7465 7874 6c69 6e65  end(cnt_textline
-0000bda0: 735f 696e 5f69 6d61 6765 5f69 6e64 5b30  s_in_image_ind[0
-0000bdb0: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
-0000bdc0: 2020 2020 2020 2065 7863 6570 7420 4578         except Ex
-0000bdd0: 6365 7074 696f 6e20 6173 2077 6879 3a0a  ception as why:.
-0000bde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000bdf0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0000be00: 6765 722e 6572 726f 7228 7768 7929 0a20  ger.error(why). 
-0000be10: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000be20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000be30: 2061 6464 5f62 6f78 6573 5f63 6f6f 725f   add_boxes_coor_
-0000be40: 696e 746f 5f74 6578 746c 696e 6573 203d  into_textlines =
-0000be50: 2054 7275 650a 2020 2020 2020 2020 2020   True.          
-0000be60: 2020 2020 2020 7465 7874 6c69 6e65 735f        textlines_
-0000be70: 636e 745f 7065 725f 7265 6769 6f6e 203d  cnt_per_region =
-0000be80: 2074 6578 746c 696e 655f 636f 6e74 6f75   textline_contou
-0000be90: 7273 5f70 6f73 7470 726f 6365 7373 696e  rs_postprocessin
-0000bea0: 6728 616c 6c5f 7465 7874 5f72 6567 696f  g(all_text_regio
-0000beb0: 6e5f 7261 772c 2073 6c6f 7065 5f66 6f72  n_raw, slope_for
-0000bec0: 5f61 6c6c 2c20 636f 6e74 6f75 7273 5f70  _all, contours_p
-0000bed0: 6172 5f70 6572 5f70 726f 6365 7373 5b6d  ar_per_process[m
-0000bee0: 765d 2c20 626f 7865 735f 7465 7874 5b6d  v], boxes_text[m
-0000bef0: 765d 2c20 6164 645f 626f 7865 735f 636f  v], add_boxes_co
-0000bf00: 6f72 5f69 6e74 6f5f 7465 7874 6c69 6e65  or_into_textline
-0000bf10: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
-0000bf20: 2020 2061 6464 5f62 6f78 6573 5f63 6f6f     add_boxes_coo
-0000bf30: 725f 696e 746f 5f74 6578 746c 696e 6573  r_into_textlines
-0000bf40: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
-0000bf50: 2020 2020 2020 2020 2023 2070 7269 6e74           # print
-0000bf60: 286e 702e 7368 6170 6528 7465 7874 6c69  (np.shape(textli
-0000bf70: 6e65 735f 636e 745f 7065 725f 7265 6769  nes_cnt_per_regi
-0000bf80: 6f6e 292c 2774 6578 746c 696e 6573 5f63  on),'textlines_c
-0000bf90: 6e74 5f70 6572 5f72 6567 696f 6e27 290a  nt_per_region').
-0000bfa0: 0a20 2020 2020 2020 2020 2020 2074 6578  .            tex
-0000bfb0: 746c 696e 6573 5f72 6563 7461 6e67 6c65  tlines_rectangle
-0000bfc0: 735f 7065 725f 6561 6368 5f73 7562 7072  s_per_each_subpr
-0000bfd0: 6f63 6573 732e 6170 7065 6e64 2874 6578  ocess.append(tex
-0000bfe0: 746c 696e 6573 5f63 6e74 5f70 6572 5f72  tlines_cnt_per_r
-0000bff0: 6567 696f 6e29 0a20 2020 2020 2020 2020  egion).         
-0000c000: 2020 2062 6f75 6e64 696e 675f 626f 785f     bounding_box_
-0000c010: 6f66 5f74 6578 7472 6567 696f 6e5f 7065  of_textregion_pe
-0000c020: 725f 6561 6368 5f73 7562 7072 6f63 6573  r_each_subproces
-0000c030: 732e 6170 7065 6e64 2862 6f78 6573 5f74  s.append(boxes_t
-0000c040: 6578 745b 6d76 5d29 0a20 2020 2020 2020  ext[mv]).       
-0000c050: 2020 2020 2063 6f6e 746f 7572 735f 7465       contours_te
-0000c060: 7874 7265 6769 6f6e 5f70 6572 5f65 6163  xtregion_per_eac
-0000c070: 685f 7375 6270 726f 6365 7373 2e61 7070  h_subprocess.app
-0000c080: 656e 6428 636f 6e74 6f75 7273 5f70 6572  end(contours_per
-0000c090: 5f70 726f 6365 7373 5b6d 765d 290a 2020  _process[mv]).  
-0000c0a0: 2020 2020 2020 2020 2020 636f 6e74 6f75            contou
-0000c0b0: 7273 5f74 6578 7472 6567 696f 6e5f 7061  rs_textregion_pa
-0000c0c0: 725f 7065 725f 6561 6368 5f73 7562 7072  r_per_each_subpr
-0000c0d0: 6f63 6573 732e 6170 7065 6e64 2863 6f6e  ocess.append(con
-0000c0e0: 746f 7572 735f 7061 725f 7065 725f 7072  tours_par_per_pr
-0000c0f0: 6f63 6573 735b 6d76 5d29 0a20 2020 2020  ocess[mv]).     
-0000c100: 2020 2020 2020 2061 6c6c 5f62 6f78 5f63         all_box_c
-0000c110: 6f6f 7264 5f70 6572 5f70 726f 6365 7373  oord_per_process
-0000c120: 2e61 7070 656e 6428 6372 6f70 5f63 6f6f  .append(crop_coo
-0000c130: 7229 0a0a 2020 2020 2020 2020 7175 6575  r)..        queu
-0000c140: 655f 6f66 5f61 6c6c 5f70 6172 616d 732e  e_of_all_params.
-0000c150: 7075 7428 5b74 6578 746c 696e 6573 5f72  put([textlines_r
-0000c160: 6563 7461 6e67 6c65 735f 7065 725f 6561  ectangles_per_ea
-0000c170: 6368 5f73 7562 7072 6f63 6573 732c 2062  ch_subprocess, b
-0000c180: 6f75 6e64 696e 675f 626f 785f 6f66 5f74  ounding_box_of_t
-0000c190: 6578 7472 6567 696f 6e5f 7065 725f 6561  extregion_per_ea
-0000c1a0: 6368 5f73 7562 7072 6f63 6573 732c 2063  ch_subprocess, c
-0000c1b0: 6f6e 746f 7572 735f 7465 7874 7265 6769  ontours_textregi
-0000c1c0: 6f6e 5f70 6572 5f65 6163 685f 7375 6270  on_per_each_subp
-0000c1d0: 726f 6365 7373 2c20 636f 6e74 6f75 7273  rocess, contours
-0000c1e0: 5f74 6578 7472 6567 696f 6e5f 7061 725f  _textregion_par_
-0000c1f0: 7065 725f 6561 6368 5f73 7562 7072 6f63  per_each_subproc
-0000c200: 6573 732c 2061 6c6c 5f62 6f78 5f63 6f6f  ess, all_box_coo
-0000c210: 7264 5f70 6572 5f70 726f 6365 7373 2c20  rd_per_process, 
-0000c220: 696e 6465 785f 6279 5f74 6578 745f 7265  index_by_text_re
-0000c230: 6769 6f6e 5f63 6f6e 746f 7572 732c 2073  gion_contours, s
-0000c240: 6c6f 7065 735f 7065 725f 6561 6368 5f73  lopes_per_each_s
-0000c250: 7562 7072 6f63 6573 735d 290a 0a20 2020  ubprocess])..   
-0000c260: 2064 6566 2064 6f5f 776f 726b 5f6f 665f   def do_work_of_
-0000c270: 736c 6f70 6573 5f6e 6577 2873 656c 662c  slopes_new(self,
-0000c280: 2071 7565 7565 5f6f 665f 616c 6c5f 7061   queue_of_all_pa
-0000c290: 7261 6d73 2c20 626f 7865 735f 7465 7874  rams, boxes_text
-0000c2a0: 2c20 7465 7874 6c69 6e65 5f6d 6173 6b5f  , textline_mask_
-0000c2b0: 746f 745f 6561 2c20 636f 6e74 6f75 7273  tot_ea, contours
-0000c2c0: 5f70 6572 5f70 726f 6365 7373 2c20 636f  _per_process, co
-0000c2d0: 6e74 6f75 7273 5f70 6172 5f70 6572 5f70  ntours_par_per_p
-0000c2e0: 726f 6365 7373 2c20 696e 6465 7865 735f  rocess, indexes_
-0000c2f0: 725f 636f 6e5f 7065 725f 7072 6f2c 2069  r_con_per_pro, i
-0000c300: 6d61 6765 5f70 6167 655f 726f 7461 7465  mage_page_rotate
-0000c310: 642c 2073 6c6f 7065 5f64 6573 6b65 7729  d, slope_deskew)
-0000c320: 3a0a 2020 2020 2020 2020 7365 6c66 2e6c  :.        self.l
-0000c330: 6f67 6765 722e 6465 6275 6728 2765 6e74  ogger.debug('ent
-0000c340: 6572 2064 6f5f 776f 726b 5f6f 665f 736c  er do_work_of_sl
-0000c350: 6f70 6573 5f6e 6577 2729 0a20 2020 2020  opes_new').     
-0000c360: 2020 2073 6c6f 7065 735f 7065 725f 6561     slopes_per_ea
-0000c370: 6368 5f73 7562 7072 6f63 6573 7320 3d20  ch_subprocess = 
-0000c380: 5b5d 0a20 2020 2020 2020 2062 6f75 6e64  [].        bound
-0000c390: 696e 675f 626f 785f 6f66 5f74 6578 7472  ing_box_of_textr
-0000c3a0: 6567 696f 6e5f 7065 725f 6561 6368 5f73  egion_per_each_s
-0000c3b0: 7562 7072 6f63 6573 7320 3d20 5b5d 0a20  ubprocess = []. 
-0000c3c0: 2020 2020 2020 2074 6578 746c 696e 6573         textlines
-0000c3d0: 5f72 6563 7461 6e67 6c65 735f 7065 725f  _rectangles_per_
-0000c3e0: 6561 6368 5f73 7562 7072 6f63 6573 7320  each_subprocess 
-0000c3f0: 3d20 5b5d 0a20 2020 2020 2020 2063 6f6e  = [].        con
-0000c400: 746f 7572 735f 7465 7874 7265 6769 6f6e  tours_textregion
-0000c410: 5f70 6572 5f65 6163 685f 7375 6270 726f  _per_each_subpro
-0000c420: 6365 7373 203d 205b 5d0a 2020 2020 2020  cess = [].      
-0000c430: 2020 636f 6e74 6f75 7273 5f74 6578 7472    contours_textr
-0000c440: 6567 696f 6e5f 7061 725f 7065 725f 6561  egion_par_per_ea
-0000c450: 6368 5f73 7562 7072 6f63 6573 7320 3d20  ch_subprocess = 
-0000c460: 5b5d 0a20 2020 2020 2020 2061 6c6c 5f62  [].        all_b
-0000c470: 6f78 5f63 6f6f 7264 5f70 6572 5f70 726f  ox_coord_per_pro
-0000c480: 6365 7373 203d 205b 5d0a 2020 2020 2020  cess = [].      
-0000c490: 2020 696e 6465 785f 6279 5f74 6578 745f    index_by_text_
-0000c4a0: 7265 6769 6f6e 5f63 6f6e 746f 7572 7320  region_contours 
-0000c4b0: 3d20 5b5d 0a20 2020 2020 2020 2066 6f72  = [].        for
-0000c4c0: 206d 7620 696e 2072 616e 6765 286c 656e   mv in range(len
-0000c4d0: 2862 6f78 6573 5f74 6578 7429 293a 0a20  (boxes_text)):. 
-0000c4e0: 2020 2020 2020 2020 2020 205f 2c20 6372             _, cr
-0000c4f0: 6f70 5f63 6f6f 7220 3d20 6372 6f70 5f69  op_coor = crop_i
-0000c500: 6d61 6765 5f69 6e73 6964 655f 626f 7828  mage_inside_box(
-0000c510: 626f 7865 735f 7465 7874 5b6d 765d 2c69  boxes_text[mv],i
-0000c520: 6d61 6765 5f70 6167 655f 726f 7461 7465  mage_page_rotate
-0000c530: 6429 0a20 2020 2020 2020 2020 2020 206d  d).            m
-0000c540: 6173 6b5f 7465 7874 6c69 6e65 203d 206e  ask_textline = n
-0000c550: 702e 7a65 726f 7328 2874 6578 746c 696e  p.zeros((textlin
-0000c560: 655f 6d61 736b 5f74 6f74 5f65 612e 7368  e_mask_tot_ea.sh
-0000c570: 6170 6529 290a 2020 2020 2020 2020 2020  ape)).          
-0000c580: 2020 6d61 736b 5f74 6578 746c 696e 6520    mask_textline 
-0000c590: 3d20 6376 322e 6669 6c6c 506f 6c79 286d  = cv2.fillPoly(m
-0000c5a0: 6173 6b5f 7465 7874 6c69 6e65 2c70 7473  ask_textline,pts
-0000c5b0: 3d5b 636f 6e74 6f75 7273 5f70 6572 5f70  =[contours_per_p
-0000c5c0: 726f 6365 7373 5b6d 765d 5d2c 636f 6c6f  rocess[mv]],colo
-0000c5d0: 723d 2831 2c31 2c31 2929 0a20 2020 2020  r=(1,1,1)).     
-0000c5e0: 2020 2020 2020 2061 6c6c 5f74 6578 745f         all_text_
-0000c5f0: 7265 6769 6f6e 5f72 6177 203d 2028 7465  region_raw = (te
-0000c600: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745f  xtline_mask_tot_
-0000c610: 6561 2a6d 6173 6b5f 7465 7874 6c69 6e65  ea*mask_textline
-0000c620: 5b3a 2c3a 5d29 5b62 6f78 6573 5f74 6578  [:,:])[boxes_tex
-0000c630: 745b 6d76 5d5b 315d 3a62 6f78 6573 5f74  t[mv][1]:boxes_t
-0000c640: 6578 745b 6d76 5d5b 315d 2b62 6f78 6573  ext[mv][1]+boxes
-0000c650: 5f74 6578 745b 6d76 5d5b 335d 202c 2062  _text[mv][3] , b
-0000c660: 6f78 6573 5f74 6578 745b 6d76 5d5b 305d  oxes_text[mv][0]
-0000c670: 3a62 6f78 6573 5f74 6578 745b 6d76 5d5b  :boxes_text[mv][
-0000c680: 305d 2b62 6f78 6573 5f74 6578 745b 6d76  0]+boxes_text[mv
-0000c690: 5d5b 325d 205d 0a20 2020 2020 2020 2020  ][2] ].         
-0000c6a0: 2020 2061 6c6c 5f74 6578 745f 7265 6769     all_text_regi
-0000c6b0: 6f6e 5f72 6177 3d61 6c6c 5f74 6578 745f  on_raw=all_text_
-0000c6c0: 7265 6769 6f6e 5f72 6177 2e61 7374 7970  region_raw.astyp
-0000c6d0: 6528 6e70 2e75 696e 7438 290a 2020 2020  e(np.uint8).    
-0000c6e0: 2020 2020 2020 2020 696d 675f 696e 745f          img_int_
-0000c6f0: 703d 616c 6c5f 7465 7874 5f72 6567 696f  p=all_text_regio
-0000c700: 6e5f 7261 775b 3a2c 3a5d 2373 656c 662e  n_raw[:,:]#self.
-0000c710: 616c 6c5f 7465 7874 5f72 6567 696f 6e5f  all_text_region_
-0000c720: 7261 775b 6d76 5d0a 2020 2020 2020 2020  raw[mv].        
-0000c730: 2020 2020 696d 675f 696e 745f 703d 6376      img_int_p=cv
-0000c740: 322e 6572 6f64 6528 696d 675f 696e 745f  2.erode(img_int_
-0000c750: 702c 4b45 524e 454c 2c69 7465 7261 7469  p,KERNEL,iterati
-0000c760: 6f6e 7320 3d20 3229 0a0a 2020 2020 2020  ons = 2)..      
-0000c770: 2020 2020 2020 6966 2069 6d67 5f69 6e74        if img_int
-0000c780: 5f70 2e73 6861 7065 5b30 5d2f 696d 675f  _p.shape[0]/img_
-0000c790: 696e 745f 702e 7368 6170 655b 315d 3c30  int_p.shape[1]<0
-0000c7a0: 2e31 3a0a 2020 2020 2020 2020 2020 2020  .1:.            
-0000c7b0: 2020 2020 736c 6f70 6573 5f70 6572 5f65      slopes_per_e
-0000c7c0: 6163 685f 7375 6270 726f 6365 7373 2e61  ach_subprocess.a
-0000c7d0: 7070 656e 6428 3029 0a20 2020 2020 2020  ppend(0).       
-0000c7e0: 2020 2020 2020 2020 2073 6c6f 7065 5f66           slope_f
-0000c7f0: 6f72 5f61 6c6c 203d 205b 736c 6f70 655f  or_all = [slope_
-0000c800: 6465 736b 6577 5d5b 305d 0a20 2020 2020  deskew][0].     
-0000c810: 2020 2020 2020 2020 2020 2061 6c6c 5f74             all_t
-0000c820: 6578 745f 7265 6769 6f6e 5f72 6177 203d  ext_region_raw =
-0000c830: 2074 6578 746c 696e 655f 6d61 736b 5f74   textline_mask_t
-0000c840: 6f74 5f65 615b 626f 7865 735f 7465 7874  ot_ea[boxes_text
-0000c850: 5b6d 765d 5b31 5d20 3a20 626f 7865 735f  [mv][1] : boxes_
-0000c860: 7465 7874 5b6d 765d 5b31 5d20 2b20 626f  text[mv][1] + bo
-0000c870: 7865 735f 7465 7874 5b6d 765d 5b33 5d2c  xes_text[mv][3],
-0000c880: 2062 6f78 6573 5f74 6578 745b 6d76 5d5b   boxes_text[mv][
-0000c890: 305d 203a 2062 6f78 6573 5f74 6578 745b  0] : boxes_text[
-0000c8a0: 6d76 5d5b 305d 202b 2062 6f78 6573 5f74  mv][0] + boxes_t
-0000c8b0: 6578 745b 6d76 5d5b 325d 5d0a 2020 2020  ext[mv][2]].    
-0000c8c0: 2020 2020 2020 2020 2020 2020 636e 745f              cnt_
-0000c8d0: 636c 6561 6e5f 726f 7420 3d20 7465 7874  clean_rot = text
-0000c8e0: 6c69 6e65 5f63 6f6e 746f 7572 735f 706f  line_contours_po
-0000c8f0: 7374 7072 6f63 6573 7369 6e67 2861 6c6c  stprocessing(all
-0000c900: 5f74 6578 745f 7265 6769 6f6e 5f72 6177  _text_region_raw
-0000c910: 2c20 736c 6f70 655f 666f 725f 616c 6c2c  , slope_for_all,
-0000c920: 2063 6f6e 746f 7572 735f 7061 725f 7065   contours_par_pe
-0000c930: 725f 7072 6f63 6573 735b 6d76 5d2c 2062  r_process[mv], b
-0000c940: 6f78 6573 5f74 6578 745b 6d76 5d2c 2030  oxes_text[mv], 0
-0000c950: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000c960: 2020 7465 7874 6c69 6e65 735f 7265 6374    textlines_rect
-0000c970: 616e 676c 6573 5f70 6572 5f65 6163 685f  angles_per_each_
-0000c980: 7375 6270 726f 6365 7373 2e61 7070 656e  subprocess.appen
-0000c990: 6428 636e 745f 636c 6561 6e5f 726f 7429  d(cnt_clean_rot)
-0000c9a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000c9b0: 2069 6e64 6578 5f62 795f 7465 7874 5f72   index_by_text_r
-0000c9c0: 6567 696f 6e5f 636f 6e74 6f75 7273 2e61  egion_contours.a
-0000c9d0: 7070 656e 6428 696e 6465 7865 735f 725f  ppend(indexes_r_
-0000c9e0: 636f 6e5f 7065 725f 7072 6f5b 6d76 5d29  con_per_pro[mv])
-0000c9f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000ca00: 2062 6f75 6e64 696e 675f 626f 785f 6f66   bounding_box_of
-0000ca10: 5f74 6578 7472 6567 696f 6e5f 7065 725f  _textregion_per_
-0000ca20: 6561 6368 5f73 7562 7072 6f63 6573 732e  each_subprocess.
-0000ca30: 6170 7065 6e64 2862 6f78 6573 5f74 6578  append(boxes_tex
-0000ca40: 745b 6d76 5d29 0a20 2020 2020 2020 2020  t[mv]).         
-0000ca50: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-0000ca60: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-0000ca70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ca80: 2020 7465 7874 6c69 6e65 5f63 6f6e 2c20    textline_con, 
-0000ca90: 6869 6572 6172 6368 7920 3d20 7265 7475  hierarchy = retu
-0000caa0: 726e 5f63 6f6e 746f 7572 735f 6f66 5f69  rn_contours_of_i
-0000cab0: 6d61 6765 2869 6d67 5f69 6e74 5f70 290a  mage(img_int_p).
-0000cac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cad0: 2020 2020 7465 7874 6c69 6e65 5f63 6f6e      textline_con
-0000cae0: 5f66 696c 203d 2066 696c 7465 725f 636f  _fil = filter_co
-0000caf0: 6e74 6f75 7273 5f61 7265 615f 6f66 5f69  ntours_area_of_i
-0000cb00: 6d61 6765 2869 6d67 5f69 6e74 5f70 2c20  mage(img_int_p, 
-0000cb10: 7465 7874 6c69 6e65 5f63 6f6e 2c20 6869  textline_con, hi
-0000cb20: 6572 6172 6368 792c 206d 6178 5f61 7265  erarchy, max_are
-0000cb30: 613d 312c 206d 696e 5f61 7265 613d 302e  a=1, min_area=0.
-0000cb40: 3030 3030 3829 0a20 2020 2020 2020 2020  00008).         
-0000cb50: 2020 2020 2020 2020 2020 2079 5f64 6966             y_dif
-0000cb60: 665f 6d65 616e 203d 2066 696e 645f 636f  f_mean = find_co
-0000cb70: 6e74 6f75 7273 5f6d 6561 6e5f 795f 6469  ntours_mean_y_di
-0000cb80: 6666 2874 6578 746c 696e 655f 636f 6e5f  ff(textline_con_
-0000cb90: 6669 6c29 0a20 2020 2020 2020 2020 2020  fil).           
-0000cba0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-0000cbb0: 2e69 734e 614e 2879 5f64 6966 665f 6d65  .isNaN(y_diff_me
-0000cbc0: 616e 293a 0a20 2020 2020 2020 2020 2020  an):.           
-0000cbd0: 2020 2020 2020 2020 2020 2020 2073 6c6f               slo
-0000cbe0: 7065 5f66 6f72 5f61 6c6c 203d 204d 4158  pe_for_all = MAX
-0000cbf0: 5f53 4c4f 5045 0a20 2020 2020 2020 2020  _SLOPE.         
-0000cc00: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-0000cc10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cc20: 2020 2020 2020 2020 2073 6967 6d61 5f64           sigma_d
-0000cc30: 6573 203d 2069 6e74 2879 5f64 6966 665f  es = int(y_diff_
-0000cc40: 6d65 616e 202a 2028 342e 3020 2f20 3430  mean * (4.0 / 40
-0000cc50: 2e30 2929 0a20 2020 2020 2020 2020 2020  .0)).           
-0000cc60: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000cc70: 7369 676d 615f 6465 7320 3c20 313a 0a20  sigma_des < 1:. 
-0000cc80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cc90: 2020 2020 2020 2020 2020 2073 6967 6d61             sigma
-0000cca0: 5f64 6573 203d 2031 0a20 2020 2020 2020  _des = 1.       
-0000ccb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ccc0: 2069 6d67 5f69 6e74 5f70 5b69 6d67 5f69   img_int_p[img_i
-0000ccd0: 6e74 5f70 203e 2030 5d20 3d20 310a 2020  nt_p > 0] = 1.  
-0000cce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ccf0: 2020 2020 2020 736c 6f70 655f 666f 725f        slope_for_
-0000cd00: 616c 6c20 3d20 7265 7475 726e 5f64 6573  all = return_des
-0000cd10: 6b65 775f 736c 6f70 2869 6d67 5f69 6e74  kew_slop(img_int
-0000cd20: 5f70 2c20 7369 676d 615f 6465 732c 2070  _p, sigma_des, p
-0000cd30: 6c6f 7474 6572 3d73 656c 662e 706c 6f74  lotter=self.plot
-0000cd40: 7465 7229 0a20 2020 2020 2020 2020 2020  ter).           
-0000cd50: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-0000cd60: 6162 7328 736c 6f70 655f 666f 725f 616c  abs(slope_for_al
-0000cd70: 6c29 203c 3d20 302e 353a 0a20 2020 2020  l) <= 0.5:.     
-0000cd80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cd90: 2020 2020 2020 2073 6c6f 7065 5f66 6f72         slope_for
-0000cda0: 5f61 6c6c 203d 205b 736c 6f70 655f 6465  _all = [slope_de
-0000cdb0: 736b 6577 5d5b 305d 0a20 2020 2020 2020  skew][0].       
-0000cdc0: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0000cdd0: 4578 6365 7074 696f 6e20 6173 2077 6879  Exception as why
-0000cde0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0000cdf0: 2020 2020 2020 7365 6c66 2e6c 6f67 6765        self.logge
-0000ce00: 722e 6572 726f 7228 7768 7929 0a20 2020  r.error(why).   
-0000ce10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ce20: 2073 6c6f 7065 5f66 6f72 5f61 6c6c 203d   slope_for_all =
-0000ce30: 204d 4158 5f53 4c4f 5045 0a20 2020 2020   MAX_SLOPE.     
-0000ce40: 2020 2020 2020 2020 2020 2069 6620 736c             if sl
-0000ce50: 6f70 655f 666f 725f 616c 6c20 3d3d 204d  ope_for_all == M
-0000ce60: 4158 5f53 4c4f 5045 3a0a 2020 2020 2020  AX_SLOPE:.      
-0000ce70: 2020 2020 2020 2020 2020 2020 2020 736c                sl
-0000ce80: 6f70 655f 666f 725f 616c 6c20 3d20 5b73  ope_for_all = [s
-0000ce90: 6c6f 7065 5f64 6573 6b65 775d 5b30 5d0a  lope_deskew][0].
-0000cea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ceb0: 736c 6f70 6573 5f70 6572 5f65 6163 685f  slopes_per_each_
-0000cec0: 7375 6270 726f 6365 7373 2e61 7070 656e  subprocess.appen
-0000ced0: 6428 736c 6f70 655f 666f 725f 616c 6c29  d(slope_for_all)
-0000cee0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000cef0: 206d 6173 6b5f 6f6e 6c79 5f63 6f6e 5f72   mask_only_con_r
-0000cf00: 6567 696f 6e20 3d20 6e70 2e7a 6572 6f73  egion = np.zeros
-0000cf10: 2874 6578 746c 696e 655f 6d61 736b 5f74  (textline_mask_t
-0000cf20: 6f74 5f65 612e 7368 6170 6529 0a20 2020  ot_ea.shape).   
-0000cf30: 2020 2020 2020 2020 2020 2020 206d 6173               mas
-0000cf40: 6b5f 6f6e 6c79 5f63 6f6e 5f72 6567 696f  k_only_con_regio
-0000cf50: 6e20 3d20 6376 322e 6669 6c6c 506f 6c79  n = cv2.fillPoly
-0000cf60: 286d 6173 6b5f 6f6e 6c79 5f63 6f6e 5f72  (mask_only_con_r
-0000cf70: 6567 696f 6e2c 2070 7473 3d5b 636f 6e74  egion, pts=[cont
-0000cf80: 6f75 7273 5f70 6172 5f70 6572 5f70 726f  ours_par_per_pro
-0000cf90: 6365 7373 5b6d 765d 5d2c 2063 6f6c 6f72  cess[mv]], color
-0000cfa0: 3d28 312c 2031 2c20 3129 290a 0a20 2020  =(1, 1, 1))..   
-0000cfb0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
-0000cfc0: 6c74 2e69 6d73 686f 7728 6d61 736b 5f6f  lt.imshow(mask_o
-0000cfd0: 6e6c 795f 636f 6e5f 7265 6769 6f6e 290a  nly_con_region).
-0000cfe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000cff0: 2320 706c 742e 7368 6f77 2829 0a20 2020  # plt.show().   
-0000d000: 2020 2020 2020 2020 2020 2020 2061 6c6c               all
-0000d010: 5f74 6578 745f 7265 6769 6f6e 5f72 6177  _text_region_raw
-0000d020: 203d 206e 702e 636f 7079 2874 6578 746c   = np.copy(textl
-0000d030: 696e 655f 6d61 736b 5f74 6f74 5f65 615b  ine_mask_tot_ea[
-0000d040: 626f 7865 735f 7465 7874 5b6d 765d 5b31  boxes_text[mv][1
-0000d050: 5d20 3a20 626f 7865 735f 7465 7874 5b6d  ] : boxes_text[m
-0000d060: 765d 5b31 5d20 2b20 626f 7865 735f 7465  v][1] + boxes_te
-0000d070: 7874 5b6d 765d 5b33 5d2c 2062 6f78 6573  xt[mv][3], boxes
-0000d080: 5f74 6578 745b 6d76 5d5b 305d 203a 2062  _text[mv][0] : b
-0000d090: 6f78 6573 5f74 6578 745b 6d76 5d5b 305d  oxes_text[mv][0]
-0000d0a0: 202b 2062 6f78 6573 5f74 6578 745b 6d76   + boxes_text[mv
-0000d0b0: 5d5b 325d 5d29 0a20 2020 2020 2020 2020  ][2]]).         
-0000d0c0: 2020 2020 2020 206d 6173 6b5f 6f6e 6c79         mask_only
-0000d0d0: 5f63 6f6e 5f72 6567 696f 6e20 3d20 6d61  _con_region = ma
-0000d0e0: 736b 5f6f 6e6c 795f 636f 6e5f 7265 6769  sk_only_con_regi
-0000d0f0: 6f6e 5b62 6f78 6573 5f74 6578 745b 6d76  on[boxes_text[mv
-0000d100: 5d5b 315d 203a 2062 6f78 6573 5f74 6578  ][1] : boxes_tex
-0000d110: 745b 6d76 5d5b 315d 202b 2062 6f78 6573  t[mv][1] + boxes
-0000d120: 5f74 6578 745b 6d76 5d5b 335d 2c20 626f  _text[mv][3], bo
-0000d130: 7865 735f 7465 7874 5b6d 765d 5b30 5d20  xes_text[mv][0] 
-0000d140: 3a20 626f 7865 735f 7465 7874 5b6d 765d  : boxes_text[mv]
-0000d150: 5b30 5d20 2b20 626f 7865 735f 7465 7874  [0] + boxes_text
-0000d160: 5b6d 765d 5b32 5d5d 0a0a 2020 2020 2020  [mv][2]]..      
-0000d170: 2020 2020 2020 2020 2020 2323 706c 742e            ##plt.
-0000d180: 696d 7368 6f77 2874 6578 746c 696e 655f  imshow(textline_
-0000d190: 6d61 736b 5f74 6f74 5f65 6129 0a20 2020  mask_tot_ea).   
-0000d1a0: 2020 2020 2020 2020 2020 2020 2023 2370               ##p
-0000d1b0: 6c74 2e73 686f 7728 290a 2020 2020 2020  lt.show().      
-0000d1c0: 2020 2020 2020 2020 2020 2323 706c 742e            ##plt.
-0000d1d0: 696d 7368 6f77 2861 6c6c 5f74 6578 745f  imshow(all_text_
-0000d1e0: 7265 6769 6f6e 5f72 6177 290a 2020 2020  region_raw).    
-0000d1f0: 2020 2020 2020 2020 2020 2020 2323 706c              ##pl
-0000d200: 742e 7368 6f77 2829 0a20 2020 2020 2020  t.show().       
-0000d210: 2020 2020 2020 2020 2023 2370 6c74 2e69           ##plt.i
-0000d220: 6d73 686f 7728 6d61 736b 5f6f 6e6c 795f  mshow(mask_only_
-0000d230: 636f 6e5f 7265 6769 6f6e 290a 2020 2020  con_region).    
-0000d240: 2020 2020 2020 2020 2020 2020 2323 706c              ##pl
-0000d250: 742e 7368 6f77 2829 0a0a 2020 2020 2020  t.show()..      
-0000d260: 2020 2020 2020 2020 2020 616c 6c5f 7465            all_te
-0000d270: 7874 5f72 6567 696f 6e5f 7261 775b 6d61  xt_region_raw[ma
-0000d280: 736b 5f6f 6e6c 795f 636f 6e5f 7265 6769  sk_only_con_regi
-0000d290: 6f6e 203d 3d20 305d 203d 2030 0a20 2020  on == 0] = 0.   
-0000d2a0: 2020 2020 2020 2020 2020 2020 2063 6e74               cnt
-0000d2b0: 5f63 6c65 616e 5f72 6f74 203d 2074 6578  _clean_rot = tex
-0000d2c0: 746c 696e 655f 636f 6e74 6f75 7273 5f70  tline_contours_p
-0000d2d0: 6f73 7470 726f 6365 7373 696e 6728 616c  ostprocessing(al
-0000d2e0: 6c5f 7465 7874 5f72 6567 696f 6e5f 7261  l_text_region_ra
-0000d2f0: 772c 2073 6c6f 7065 5f66 6f72 5f61 6c6c  w, slope_for_all
-0000d300: 2c20 636f 6e74 6f75 7273 5f70 6172 5f70  , contours_par_p
-0000d310: 6572 5f70 726f 6365 7373 5b6d 765d 2c20  er_process[mv], 
-0000d320: 626f 7865 735f 7465 7874 5b6d 765d 290a  boxes_text[mv]).
-0000d330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000d340: 2074 6578 746c 696e 6573 5f72 6563 7461   textlines_recta
-0000d350: 6e67 6c65 735f 7065 725f 6561 6368 5f73  ngles_per_each_s
-0000d360: 7562 7072 6f63 6573 732e 6170 7065 6e64  ubprocess.append
-0000d370: 2863 6e74 5f63 6c65 616e 5f72 6f74 290a  (cnt_clean_rot).
-0000d380: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d390: 696e 6465 785f 6279 5f74 6578 745f 7265  index_by_text_re
-0000d3a0: 6769 6f6e 5f63 6f6e 746f 7572 732e 6170  gion_contours.ap
-0000d3b0: 7065 6e64 2869 6e64 6578 6573 5f72 5f63  pend(indexes_r_c
-0000d3c0: 6f6e 5f70 6572 5f70 726f 5b6d 765d 290a  on_per_pro[mv]).
-0000d3d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000d3e0: 626f 756e 6469 6e67 5f62 6f78 5f6f 665f  bounding_box_of_
-0000d3f0: 7465 7874 7265 6769 6f6e 5f70 6572 5f65  textregion_per_e
-0000d400: 6163 685f 7375 6270 726f 6365 7373 2e61  ach_subprocess.a
-0000d410: 7070 656e 6428 626f 7865 735f 7465 7874  ppend(boxes_text
-0000d420: 5b6d 765d 290a 0a20 2020 2020 2020 2020  [mv])..         
-0000d430: 2020 2063 6f6e 746f 7572 735f 7465 7874     contours_text
-0000d440: 7265 6769 6f6e 5f70 6572 5f65 6163 685f  region_per_each_
-0000d450: 7375 6270 726f 6365 7373 2e61 7070 656e  subprocess.appen
-0000d460: 6428 636f 6e74 6f75 7273 5f70 6572 5f70  d(contours_per_p
-0000d470: 726f 6365 7373 5b6d 765d 290a 2020 2020  rocess[mv]).    
-0000d480: 2020 2020 2020 2020 636f 6e74 6f75 7273          contours
-0000d490: 5f74 6578 7472 6567 696f 6e5f 7061 725f  _textregion_par_
-0000d4a0: 7065 725f 6561 6368 5f73 7562 7072 6f63  per_each_subproc
-0000d4b0: 6573 732e 6170 7065 6e64 2863 6f6e 746f  ess.append(conto
-0000d4c0: 7572 735f 7061 725f 7065 725f 7072 6f63  urs_par_per_proc
-0000d4d0: 6573 735b 6d76 5d29 0a20 2020 2020 2020  ess[mv]).       
-0000d4e0: 2020 2020 2061 6c6c 5f62 6f78 5f63 6f6f       all_box_coo
-0000d4f0: 7264 5f70 6572 5f70 726f 6365 7373 2e61  rd_per_process.a
-0000d500: 7070 656e 6428 6372 6f70 5f63 6f6f 7229  ppend(crop_coor)
-0000d510: 0a20 2020 2020 2020 2071 7565 7565 5f6f  .        queue_o
-0000d520: 665f 616c 6c5f 7061 7261 6d73 2e70 7574  f_all_params.put
-0000d530: 285b 736c 6f70 6573 5f70 6572 5f65 6163  ([slopes_per_eac
-0000d540: 685f 7375 6270 726f 6365 7373 2c20 7465  h_subprocess, te
-0000d550: 7874 6c69 6e65 735f 7265 6374 616e 676c  xtlines_rectangl
-0000d560: 6573 5f70 6572 5f65 6163 685f 7375 6270  es_per_each_subp
-0000d570: 726f 6365 7373 2c20 626f 756e 6469 6e67  rocess, bounding
-0000d580: 5f62 6f78 5f6f 665f 7465 7874 7265 6769  _box_of_textregi
-0000d590: 6f6e 5f70 6572 5f65 6163 685f 7375 6270  on_per_each_subp
-0000d5a0: 726f 6365 7373 2c20 636f 6e74 6f75 7273  rocess, contours
-0000d5b0: 5f74 6578 7472 6567 696f 6e5f 7065 725f  _textregion_per_
-0000d5c0: 6561 6368 5f73 7562 7072 6f63 6573 732c  each_subprocess,
-0000d5d0: 2063 6f6e 746f 7572 735f 7465 7874 7265   contours_textre
-0000d5e0: 6769 6f6e 5f70 6172 5f70 6572 5f65 6163  gion_par_per_eac
-0000d5f0: 685f 7375 6270 726f 6365 7373 2c20 616c  h_subprocess, al
-0000d600: 6c5f 626f 785f 636f 6f72 645f 7065 725f  l_box_coord_per_
-0000d610: 7072 6f63 6573 732c 2069 6e64 6578 5f62  process, index_b
-0000d620: 795f 7465 7874 5f72 6567 696f 6e5f 636f  y_text_region_co
-0000d630: 6e74 6f75 7273 5d29 0a0a 2020 2020 6465  ntours])..    de
-0000d640: 6620 7465 7874 6c69 6e65 5f63 6f6e 746f  f textline_conto
-0000d650: 7572 7328 7365 6c66 2c20 696d 672c 2070  urs(self, img, p
-0000d660: 6174 6368 6573 2c20 7363 616c 6572 5f68  atches, scaler_h
-0000d670: 2c20 7363 616c 6572 5f77 293a 0a20 2020  , scaler_w):.   
-0000d680: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
-0000d690: 2e64 6562 7567 2827 656e 7465 7220 7465  .debug('enter te
-0000d6a0: 7874 6c69 6e65 5f63 6f6e 746f 7572 7327  xtline_contours'
-0000d6b0: 290a 0a20 2020 2020 2020 206d 6f64 656c  )..        model
-0000d6c0: 5f74 6578 746c 696e 652c 2073 6573 7369  _textline, sessi
-0000d6d0: 6f6e 5f74 6578 746c 696e 6520 3d20 7365  on_textline = se
-0000d6e0: 6c66 2e73 7461 7274 5f6e 6577 5f73 6573  lf.start_new_ses
-0000d6f0: 7369 6f6e 5f61 6e64 5f6d 6f64 656c 2873  sion_and_model(s
-0000d700: 656c 662e 6d6f 6465 6c5f 7465 7874 6c69  elf.model_textli
-0000d710: 6e65 5f64 6972 2069 6620 7061 7463 6865  ne_dir if patche
-0000d720: 7320 656c 7365 2073 656c 662e 6d6f 6465  s else self.mode
-0000d730: 6c5f 7465 7874 6c69 6e65 5f64 6972 5f6e  l_textline_dir_n
-0000d740: 7029 0a20 2020 2020 2020 2069 6d67 203d  p).        img =
-0000d750: 2069 6d67 2e61 7374 7970 6528 6e70 2e75   img.astype(np.u
-0000d760: 696e 7438 290a 2020 2020 2020 2020 696d  int8).        im
-0000d770: 675f 6f72 6720 3d20 6e70 2e63 6f70 7928  g_org = np.copy(
-0000d780: 696d 6729 0a20 2020 2020 2020 2069 6d67  img).        img
-0000d790: 5f68 203d 2069 6d67 5f6f 7267 2e73 6861  _h = img_org.sha
-0000d7a0: 7065 5b30 5d0a 2020 2020 2020 2020 696d  pe[0].        im
-0000d7b0: 675f 7720 3d20 696d 675f 6f72 672e 7368  g_w = img_org.sh
-0000d7c0: 6170 655b 315d 0a20 2020 2020 2020 2069  ape[1].        i
-0000d7d0: 6d67 203d 2072 6573 697a 655f 696d 6167  mg = resize_imag
-0000d7e0: 6528 696d 675f 6f72 672c 2069 6e74 2869  e(img_org, int(i
-0000d7f0: 6d67 5f6f 7267 2e73 6861 7065 5b30 5d20  mg_org.shape[0] 
-0000d800: 2a20 7363 616c 6572 5f68 292c 2069 6e74  * scaler_h), int
-0000d810: 2869 6d67 5f6f 7267 2e73 6861 7065 5b31  (img_org.shape[1
-0000d820: 5d20 2a20 7363 616c 6572 5f77 2929 0a20  ] * scaler_w)). 
-0000d830: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
-0000d840: 6e5f 7465 7874 6c69 6e65 203d 2073 656c  n_textline = sel
-0000d850: 662e 646f 5f70 7265 6469 6374 696f 6e28  f.do_prediction(
-0000d860: 7061 7463 6865 732c 2069 6d67 2c20 6d6f  patches, img, mo
-0000d870: 6465 6c5f 7465 7874 6c69 6e65 290a 2020  del_textline).  
-0000d880: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
-0000d890: 5f74 6578 746c 696e 6520 3d20 7265 7369  _textline = resi
-0000d8a0: 7a65 5f69 6d61 6765 2870 7265 6469 6374  ze_image(predict
-0000d8b0: 696f 6e5f 7465 7874 6c69 6e65 2c20 696d  ion_textline, im
-0000d8c0: 675f 682c 2069 6d67 5f77 290a 2020 2020  g_h, img_w).    
-0000d8d0: 2020 2020 7072 6564 6963 7469 6f6e 5f74      prediction_t
-0000d8e0: 6578 746c 696e 655f 6c6f 6e67 7368 6f74  extline_longshot
-0000d8f0: 203d 2073 656c 662e 646f 5f70 7265 6469   = self.do_predi
-0000d900: 6374 696f 6e28 4661 6c73 652c 2069 6d67  ction(False, img
-0000d910: 2c20 6d6f 6465 6c5f 7465 7874 6c69 6e65  , model_textline
-0000d920: 290a 2020 2020 2020 2020 7072 6564 6963  ).        predic
-0000d930: 7469 6f6e 5f74 6578 746c 696e 655f 6c6f  tion_textline_lo
-0000d940: 6e67 7368 6f74 5f74 7275 655f 7369 7a65  ngshot_true_size
-0000d950: 203d 2072 6573 697a 655f 696d 6167 6528   = resize_image(
-0000d960: 7072 6564 6963 7469 6f6e 5f74 6578 746c  prediction_textl
-0000d970: 696e 655f 6c6f 6e67 7368 6f74 2c20 696d  ine_longshot, im
-0000d980: 675f 682c 2069 6d67 5f77 290a 0a20 2020  g_h, img_w)..   
-0000d990: 2020 2020 2072 6574 7572 6e20 7072 6564       return pred
-0000d9a0: 6963 7469 6f6e 5f74 6578 746c 696e 655b  iction_textline[
-0000d9b0: 3a2c 203a 2c20 305d 2c20 7072 6564 6963  :, :, 0], predic
-0000d9c0: 7469 6f6e 5f74 6578 746c 696e 655f 6c6f  tion_textline_lo
-0000d9d0: 6e67 7368 6f74 5f74 7275 655f 7369 7a65  ngshot_true_size
-0000d9e0: 5b3a 2c20 3a2c 2030 5d0a 0a20 2020 2064  [:, :, 0]..    d
-0000d9f0: 6566 2064 6f5f 776f 726b 5f6f 665f 736c  ef do_work_of_sl
-0000da00: 6f70 6573 2873 656c 662c 2071 2c20 706f  opes(self, q, po
-0000da10: 6c79 2c20 626f 785f 7375 622c 2062 6f78  ly, box_sub, box
-0000da20: 6573 5f70 6572 5f70 726f 6365 7373 2c20  es_per_process, 
-0000da30: 7465 7874 6c69 6e65 5f6d 6173 6b5f 746f  textline_mask_to
-0000da40: 742c 2063 6f6e 746f 7572 735f 7065 725f  t, contours_per_
-0000da50: 7072 6f63 6573 7329 3a0a 2020 2020 2020  process):.      
-0000da60: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
-0000da70: 6275 6728 2765 6e74 6572 2064 6f5f 776f  bug('enter do_wo
-0000da80: 726b 5f6f 665f 736c 6f70 6573 2729 0a20  rk_of_slopes'). 
-0000da90: 2020 2020 2020 2073 6c6f 7065 5f62 6967         slope_big
-0000daa0: 6765 7374 203d 2030 0a20 2020 2020 2020  gest = 0.       
-0000dab0: 2073 6c6f 7065 735f 7375 6220 3d20 5b5d   slopes_sub = []
-0000dac0: 0a20 2020 2020 2020 2062 6f78 6573 5f73  .        boxes_s
-0000dad0: 7562 5f6e 6577 203d 205b 5d0a 2020 2020  ub_new = [].    
-0000dae0: 2020 2020 706f 6c79 5f73 7562 203d 205b      poly_sub = [
-0000daf0: 5d0a 2020 2020 2020 2020 666f 7220 6d76  ].        for mv
-0000db00: 2069 6e20 7261 6e67 6528 6c65 6e28 626f   in range(len(bo
-0000db10: 7865 735f 7065 725f 7072 6f63 6573 7329  xes_per_process)
-0000db20: 293a 0a20 2020 2020 2020 2020 2020 2063  ):.            c
-0000db30: 726f 705f 696d 672c 205f 203d 2063 726f  rop_img, _ = cro
-0000db40: 705f 696d 6167 655f 696e 7369 6465 5f62  p_image_inside_b
-0000db50: 6f78 2862 6f78 6573 5f70 6572 5f70 726f  ox(boxes_per_pro
-0000db60: 6365 7373 5b6d 765d 2c20 6e70 2e72 6570  cess[mv], np.rep
-0000db70: 6561 7428 7465 7874 6c69 6e65 5f6d 6173  eat(textline_mas
-0000db80: 6b5f 746f 745b 3a2c 203a 2c20 6e70 2e6e  k_tot[:, :, np.n
-0000db90: 6577 6178 6973 5d2c 2033 2c20 6178 6973  ewaxis], 3, axis
-0000dba0: 3d32 2929 0a20 2020 2020 2020 2020 2020  =2)).           
-0000dbb0: 2063 726f 705f 696d 6720 3d20 6372 6f70   crop_img = crop
-0000dbc0: 5f69 6d67 5b3a 2c20 3a2c 2030 5d0a 2020  _img[:, :, 0].  
-0000dbd0: 2020 2020 2020 2020 2020 6372 6f70 5f69            crop_i
-0000dbe0: 6d67 203d 2063 7632 2e65 726f 6465 2863  mg = cv2.erode(c
-0000dbf0: 726f 705f 696d 672c 204b 4552 4e45 4c2c  rop_img, KERNEL,
-0000dc00: 2069 7465 7261 7469 6f6e 733d 3229 0a20   iterations=2). 
-0000dc10: 2020 2020 2020 2020 2020 2074 7279 3a0a             try:.
-0000dc20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000dc30: 7465 7874 6c69 6e65 5f63 6f6e 2c20 6869  textline_con, hi
-0000dc40: 6572 6172 6368 7920 3d20 7265 7475 726e  erarchy = return
-0000dc50: 5f63 6f6e 746f 7572 735f 6f66 5f69 6d61  _contours_of_ima
-0000dc60: 6765 2863 726f 705f 696d 6729 0a20 2020  ge(crop_img).   
-0000dc70: 2020 2020 2020 2020 2020 2020 2074 6578               tex
-0000dc80: 746c 696e 655f 636f 6e5f 6669 6c20 3d20  tline_con_fil = 
-0000dc90: 6669 6c74 6572 5f63 6f6e 746f 7572 735f  filter_contours_
-0000dca0: 6172 6561 5f6f 665f 696d 6167 6528 6372  area_of_image(cr
-0000dcb0: 6f70 5f69 6d67 2c20 7465 7874 6c69 6e65  op_img, textline
-0000dcc0: 5f63 6f6e 2c20 6869 6572 6172 6368 792c  _con, hierarchy,
-0000dcd0: 206d 6178 5f61 7265 613d 312c 206d 696e   max_area=1, min
-0000dce0: 5f61 7265 613d 302e 3030 3038 290a 2020  _area=0.0008).  
-0000dcf0: 2020 2020 2020 2020 2020 2020 2020 795f                y_
-0000dd00: 6469 6666 5f6d 6561 6e20 3d20 6669 6e64  diff_mean = find
-0000dd10: 5f63 6f6e 746f 7572 735f 6d65 616e 5f79  _contours_mean_y
-0000dd20: 5f64 6966 6628 7465 7874 6c69 6e65 5f63  _diff(textline_c
-0000dd30: 6f6e 5f66 696c 290a 2020 2020 2020 2020  on_fil).        
-0000dd40: 2020 2020 2020 2020 7369 676d 615f 6465          sigma_de
-0000dd50: 7320 3d20 6d61 7828 312c 2069 6e74 2879  s = max(1, int(y
-0000dd60: 5f64 6966 665f 6d65 616e 202a 2028 342e  _diff_mean * (4.
-0000dd70: 3020 2f20 3430 2e30 2929 290a 2020 2020  0 / 40.0))).    
-0000dd80: 2020 2020 2020 2020 2020 2020 6372 6f70              crop
-0000dd90: 5f69 6d67 5b63 726f 705f 696d 6720 3e20  _img[crop_img > 
-0000dda0: 305d 203d 2031 0a20 2020 2020 2020 2020  0] = 1.         
-0000ddb0: 2020 2020 2020 2073 6c6f 7065 5f63 6f72         slope_cor
-0000ddc0: 7265 7370 6f6e 6469 6e67 5f74 6578 7472  responding_textr
-0000ddd0: 6567 696f 6e20 3d20 7265 7475 726e 5f64  egion = return_d
-0000dde0: 6573 6b65 775f 736c 6f70 2863 726f 705f  eskew_slop(crop_
-0000ddf0: 696d 672c 2073 6967 6d61 5f64 6573 2c20  img, sigma_des, 
-0000de00: 706c 6f74 7465 723d 7365 6c66 2e70 6c6f  plotter=self.plo
-0000de10: 7474 6572 290a 2020 2020 2020 2020 2020  tter).          
-0000de20: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-0000de30: 6f6e 2061 7320 7768 793a 0a20 2020 2020  on as why:.     
-0000de40: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-0000de50: 6c6f 6767 6572 2e65 7272 6f72 2877 6879  logger.error(why
-0000de60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0000de70: 2020 736c 6f70 655f 636f 7272 6573 706f    slope_correspo
-0000de80: 6e64 696e 675f 7465 7874 7265 6769 6f6e  nding_textregion
-0000de90: 203d 204d 4158 5f53 4c4f 5045 0a0a 2020   = MAX_SLOPE..  
-0000dea0: 2020 2020 2020 2020 2020 6966 2073 6c6f            if slo
-0000deb0: 7065 5f63 6f72 7265 7370 6f6e 6469 6e67  pe_corresponding
-0000dec0: 5f74 6578 7472 6567 696f 6e20 3d3d 204d  _textregion == M
-0000ded0: 4158 5f53 4c4f 5045 3a0a 2020 2020 2020  AX_SLOPE:.      
-0000dee0: 2020 2020 2020 2020 2020 736c 6f70 655f            slope_
-0000def0: 636f 7272 6573 706f 6e64 696e 675f 7465  corresponding_te
-0000df00: 7874 7265 6769 6f6e 203d 2073 6c6f 7065  xtregion = slope
-0000df10: 5f62 6967 6765 7374 0a20 2020 2020 2020  _biggest.       
-0000df20: 2020 2020 2073 6c6f 7065 735f 7375 622e       slopes_sub.
-0000df30: 6170 7065 6e64 2873 6c6f 7065 5f63 6f72  append(slope_cor
-0000df40: 7265 7370 6f6e 6469 6e67 5f74 6578 7472  responding_textr
-0000df50: 6567 696f 6e29 0a0a 2020 2020 2020 2020  egion)..        
-0000df60: 2020 2020 636e 745f 636c 6561 6e5f 726f      cnt_clean_ro
-0000df70: 7420 3d20 7465 7874 6c69 6e65 5f63 6f6e  t = textline_con
-0000df80: 746f 7572 735f 706f 7374 7072 6f63 6573  tours_postproces
-0000df90: 7369 6e67 2863 726f 705f 696d 672c 2073  sing(crop_img, s
-0000dfa0: 6c6f 7065 5f63 6f72 7265 7370 6f6e 6469  lope_correspondi
-0000dfb0: 6e67 5f74 6578 7472 6567 696f 6e2c 2063  ng_textregion, c
-0000dfc0: 6f6e 746f 7572 735f 7065 725f 7072 6f63  ontours_per_proc
-0000dfd0: 6573 735b 6d76 5d2c 2062 6f78 6573 5f70  ess[mv], boxes_p
-0000dfe0: 6572 5f70 726f 6365 7373 5b6d 765d 290a  er_process[mv]).
-0000dff0: 0a20 2020 2020 2020 2020 2020 2070 6f6c  .            pol
-0000e000: 795f 7375 622e 6170 7065 6e64 2863 6e74  y_sub.append(cnt
-0000e010: 5f63 6c65 616e 5f72 6f74 290a 2020 2020  _clean_rot).    
-0000e020: 2020 2020 2020 2020 626f 7865 735f 7375          boxes_su
-0000e030: 625f 6e65 772e 6170 7065 6e64 2862 6f78  b_new.append(box
-0000e040: 6573 5f70 6572 5f70 726f 6365 7373 5b6d  es_per_process[m
-0000e050: 765d 290a 0a20 2020 2020 2020 2071 2e70  v])..        q.p
-0000e060: 7574 2873 6c6f 7065 735f 7375 6229 0a20  ut(slopes_sub). 
-0000e070: 2020 2020 2020 2070 6f6c 792e 7075 7428         poly.put(
-0000e080: 706f 6c79 5f73 7562 290a 2020 2020 2020  poly_sub).      
-0000e090: 2020 626f 785f 7375 622e 7075 7428 626f    box_sub.put(bo
-0000e0a0: 7865 735f 7375 625f 6e65 7729 0a0a 2020  xes_sub_new)..  
-0000e0b0: 2020 6465 6620 6765 745f 7265 6769 6f6e    def get_region
-0000e0c0: 735f 6672 6f6d 5f78 795f 326d 6f64 656c  s_from_xy_2model
-0000e0d0: 7328 7365 6c66 2c69 6d67 2c69 735f 696d  s(self,img,is_im
-0000e0e0: 6167 655f 656e 6861 6e63 6564 2c20 6e75  age_enhanced, nu
-0000e0f0: 6d5f 636f 6c5f 636c 6173 7369 6669 6572  m_col_classifier
-0000e100: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
-0000e110: 6c6f 6767 6572 2e64 6562 7567 2822 656e  logger.debug("en
-0000e120: 7465 7220 6765 745f 7265 6769 6f6e 735f  ter get_regions_
-0000e130: 6672 6f6d 5f78 795f 326d 6f64 656c 7322  from_xy_2models"
-0000e140: 290a 2020 2020 2020 2020 6572 6f73 696f  ).        erosio
-0000e150: 6e5f 6875 7274 7320 3d20 4661 6c73 650a  n_hurts = False.
-0000e160: 2020 2020 2020 2020 696d 675f 6f72 6720          img_org 
-0000e170: 3d20 6e70 2e63 6f70 7928 696d 6729 0a20  = np.copy(img). 
-0000e180: 2020 2020 2020 2069 6d67 5f68 6569 6768         img_heigh
-0000e190: 745f 6820 3d20 696d 675f 6f72 672e 7368  t_h = img_org.sh
-0000e1a0: 6170 655b 305d 0a20 2020 2020 2020 2069  ape[0].        i
-0000e1b0: 6d67 5f77 6964 7468 5f68 203d 2069 6d67  mg_width_h = img
-0000e1c0: 5f6f 7267 2e73 6861 7065 5b31 5d0a 0a20  _org.shape[1].. 
-0000e1d0: 2020 2020 2020 206d 6f64 656c 5f72 6567         model_reg
-0000e1e0: 696f 6e2c 2073 6573 7369 6f6e 5f72 6567  ion, session_reg
-0000e1f0: 696f 6e20 3d20 7365 6c66 2e73 7461 7274  ion = self.start
-0000e200: 5f6e 6577 5f73 6573 7369 6f6e 5f61 6e64  _new_session_and
-0000e210: 5f6d 6f64 656c 2873 656c 662e 6d6f 6465  _model(self.mode
-0000e220: 6c5f 7265 6769 6f6e 5f64 6972 5f70 5f65  l_region_dir_p_e
-0000e230: 6e73 290a 0a20 2020 2020 2020 2072 6174  ns)..        rat
-0000e240: 696f 5f79 3d31 2e33 0a20 2020 2020 2020  io_y=1.3.       
-0000e250: 2072 6174 696f 5f78 3d31 0a0a 2020 2020   ratio_x=1..    
-0000e260: 2020 2020 696d 6720 3d20 7265 7369 7a65      img = resize
-0000e270: 5f69 6d61 6765 2869 6d67 5f6f 7267 2c20  _image(img_org, 
-0000e280: 696e 7428 696d 675f 6f72 672e 7368 6170  int(img_org.shap
-0000e290: 655b 305d 2a72 6174 696f 5f79 292c 2069  e[0]*ratio_y), i
-0000e2a0: 6e74 2869 6d67 5f6f 7267 2e73 6861 7065  nt(img_org.shape
-0000e2b0: 5b31 5d2a 7261 7469 6f5f 7829 290a 0a20  [1]*ratio_x)).. 
-0000e2c0: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
-0000e2d0: 6e5f 7265 6769 6f6e 735f 6f72 675f 7920  n_regions_org_y 
-0000e2e0: 3d20 7365 6c66 2e64 6f5f 7072 6564 6963  = self.do_predic
-0000e2f0: 7469 6f6e 2854 7275 652c 2069 6d67 2c20  tion(True, img, 
-0000e300: 6d6f 6465 6c5f 7265 6769 6f6e 290a 2020  model_region).  
-0000e310: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
-0000e320: 5f72 6567 696f 6e73 5f6f 7267 5f79 203d  _regions_org_y =
-0000e330: 2072 6573 697a 655f 696d 6167 6528 7072   resize_image(pr
-0000e340: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
-0000e350: 5f6f 7267 5f79 2c20 696d 675f 6865 6967  _org_y, img_heig
-0000e360: 6874 5f68 2c20 696d 675f 7769 6474 685f  ht_h, img_width_
-0000e370: 6820 290a 0a20 2020 2020 2020 2023 706c  h )..        #pl
-0000e380: 742e 696d 7368 6f77 2870 7265 6469 6374  t.imshow(predict
-0000e390: 696f 6e5f 7265 6769 6f6e 735f 6f72 675f  ion_regions_org_
-0000e3a0: 795b 3a2c 3a2c 305d 290a 2020 2020 2020  y[:,:,0]).      
-0000e3b0: 2020 2370 6c74 2e73 686f 7728 290a 2020    #plt.show().  
-0000e3c0: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
-0000e3d0: 5f72 6567 696f 6e73 5f6f 7267 5f79 203d  _regions_org_y =
-0000e3e0: 2070 7265 6469 6374 696f 6e5f 7265 6769   prediction_regi
-0000e3f0: 6f6e 735f 6f72 675f 795b 3a2c 3a2c 305d  ons_org_y[:,:,0]
-0000e400: 0a20 2020 2020 2020 206d 6173 6b5f 7a65  .        mask_ze
-0000e410: 726f 735f 7920 3d20 2870 7265 6469 6374  ros_y = (predict
-0000e420: 696f 6e5f 7265 6769 6f6e 735f 6f72 675f  ion_regions_org_
-0000e430: 795b 3a2c 3a5d 3d3d 3029 2a31 0a20 2020  y[:,:]==0)*1.   
-0000e440: 2020 2020 200a 2020 2020 2020 2020 2323       .        ##
-0000e450: 696d 675f 6f6e 6c79 5f72 6567 696f 6e73  img_only_regions
-0000e460: 5f77 6974 685f 7365 7020 3d20 2820 2870  _with_sep = ( (p
-0000e470: 7265 6469 6374 696f 6e5f 7265 6769 6f6e  rediction_region
-0000e480: 735f 6f72 675f 795b 3a2c 3a5d 2021 3d20  s_org_y[:,:] != 
-0000e490: 3329 2026 2028 7072 6564 6963 7469 6f6e  3) & (prediction
-0000e4a0: 5f72 6567 696f 6e73 5f6f 7267 5f79 5b3a  _regions_org_y[:
-0000e4b0: 2c3a 5d20 213d 2030 2920 292a 310a 2020  ,:] != 0) )*1.  
-0000e4c0: 2020 2020 2020 696d 675f 6f6e 6c79 5f72        img_only_r
-0000e4d0: 6567 696f 6e73 5f77 6974 685f 7365 7020  egions_with_sep 
-0000e4e0: 3d20 2820 7072 6564 6963 7469 6f6e 5f72  = ( prediction_r
-0000e4f0: 6567 696f 6e73 5f6f 7267 5f79 5b3a 2c3a  egions_org_y[:,:
-0000e500: 5d20 3d3d 2031 2029 2a31 0a20 2020 2020  ] == 1 )*1.     
-0000e510: 2020 2069 6d67 5f6f 6e6c 795f 7265 6769     img_only_regi
-0000e520: 6f6e 735f 7769 7468 5f73 6570 203d 2069  ons_with_sep = i
-0000e530: 6d67 5f6f 6e6c 795f 7265 6769 6f6e 735f  mg_only_regions_
-0000e540: 7769 7468 5f73 6570 2e61 7374 7970 6528  with_sep.astype(
-0000e550: 6e70 2e75 696e 7438 290a 2020 2020 2020  np.uint8).      
-0000e560: 2020 0a20 2020 2020 2020 2074 7279 3a0a    .        try:.
-0000e570: 2020 2020 2020 2020 2020 2020 696d 675f              img_
-0000e580: 6f6e 6c79 5f72 6567 696f 6e73 203d 2063  only_regions = c
-0000e590: 7632 2e65 726f 6465 2869 6d67 5f6f 6e6c  v2.erode(img_onl
-0000e5a0: 795f 7265 6769 6f6e 735f 7769 7468 5f73  y_regions_with_s
-0000e5b0: 6570 5b3a 2c3a 5d2c 204b 4552 4e45 4c2c  ep[:,:], KERNEL,
-0000e5c0: 2069 7465 7261 7469 6f6e 733d 3230 290a   iterations=20).
-0000e5d0: 0a20 2020 2020 2020 2020 2020 205f 2c20  .            _, 
-0000e5e0: 5f20 3d20 6669 6e64 5f6e 756d 5f63 6f6c  _ = find_num_col
-0000e5f0: 2869 6d67 5f6f 6e6c 795f 7265 6769 6f6e  (img_only_region
-0000e600: 732c 206e 756d 5f63 6f6c 5f63 6c61 7373  s, num_col_class
-0000e610: 6966 6965 722c 2073 656c 662e 7461 626c  ifier, self.tabl
-0000e620: 6573 2c20 6d75 6c74 6970 6c69 6572 3d36  es, multiplier=6
-0000e630: 2e30 290a 2020 2020 2020 2020 2020 2020  .0).            
-0000e640: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
-0000e650: 203d 2072 6573 697a 655f 696d 6167 6528   = resize_image(
-0000e660: 696d 675f 6f72 672c 2069 6e74 2869 6d67  img_org, int(img
-0000e670: 5f6f 7267 2e73 6861 7065 5b30 5d29 2c20  _org.shape[0]), 
-0000e680: 696e 7428 696d 675f 6f72 672e 7368 6170  int(img_org.shap
-0000e690: 655b 315d 2a28 312e 3220 6966 2069 735f  e[1]*(1.2 if is_
-0000e6a0: 696d 6167 655f 656e 6861 6e63 6564 2065  image_enhanced e
-0000e6b0: 6c73 6520 3129 2929 0a0a 2020 2020 2020  lse 1)))..      
-0000e6c0: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
-0000e6d0: 5f72 6567 696f 6e73 5f6f 7267 203d 2073  _regions_org = s
-0000e6e0: 656c 662e 646f 5f70 7265 6469 6374 696f  elf.do_predictio
-0000e6f0: 6e28 5472 7565 2c20 696d 672c 206d 6f64  n(True, img, mod
-0000e700: 656c 5f72 6567 696f 6e29 0a20 2020 2020  el_region).     
-0000e710: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
-0000e720: 6e5f 7265 6769 6f6e 735f 6f72 6720 3d20  n_regions_org = 
-0000e730: 7265 7369 7a65 5f69 6d61 6765 2870 7265  resize_image(pre
-0000e740: 6469 6374 696f 6e5f 7265 6769 6f6e 735f  diction_regions_
-0000e750: 6f72 672c 2069 6d67 5f68 6569 6768 745f  org, img_height_
-0000e760: 682c 2069 6d67 5f77 6964 7468 5f68 2029  h, img_width_h )
-0000e770: 0a0a 2020 2020 2020 2020 2020 2020 2323  ..            ##
-0000e780: 706c 742e 696d 7368 6f77 2870 7265 6469  plt.imshow(predi
-0000e790: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
-0000e7a0: 675b 3a2c 3a2c 305d 290a 2020 2020 2020  g[:,:,0]).      
-0000e7b0: 2020 2020 2020 2323 706c 742e 7368 6f77        ##plt.show
-0000e7c0: 2829 0a20 2020 2020 2020 2020 2020 2070  ().            p
-0000e7d0: 7265 6469 6374 696f 6e5f 7265 6769 6f6e  rediction_region
-0000e7e0: 735f 6f72 673d 7072 6564 6963 7469 6f6e  s_org=prediction
-0000e7f0: 5f72 6567 696f 6e73 5f6f 7267 5b3a 2c3a  _regions_org[:,:
-0000e800: 2c30 5d0a 2020 2020 2020 2020 2020 2020  ,0].            
-0000e810: 7072 6564 6963 7469 6f6e 5f72 6567 696f  prediction_regio
-0000e820: 6e73 5f6f 7267 5b28 7072 6564 6963 7469  ns_org[(predicti
-0000e830: 6f6e 5f72 6567 696f 6e73 5f6f 7267 5b3a  on_regions_org[:
-0000e840: 2c3a 5d3d 3d31 2920 2620 286d 6173 6b5f  ,:]==1) & (mask_
-0000e850: 7a65 726f 735f 795b 3a2c 3a5d 3d3d 3129  zeros_y[:,:]==1)
-0000e860: 5d3d 300a 0a20 2020 2020 2020 2020 2020  ]=0..           
-0000e870: 206d 6f64 656c 5f72 6567 696f 6e2c 2073   model_region, s
-0000e880: 6573 7369 6f6e 5f72 6567 696f 6e20 3d20  ession_region = 
-0000e890: 7365 6c66 2e73 7461 7274 5f6e 6577 5f73  self.start_new_s
-0000e8a0: 6573 7369 6f6e 5f61 6e64 5f6d 6f64 656c  ession_and_model
-0000e8b0: 2873 656c 662e 6d6f 6465 6c5f 7265 6769  (self.model_regi
-0000e8c0: 6f6e 5f64 6972 5f70 3229 0a20 2020 2020  on_dir_p2).     
-0000e8d0: 2020 2020 2020 2069 6d67 203d 2072 6573         img = res
-0000e8e0: 697a 655f 696d 6167 6528 696d 675f 6f72  ize_image(img_or
-0000e8f0: 672c 2069 6e74 2869 6d67 5f6f 7267 2e73  g, int(img_org.s
-0000e900: 6861 7065 5b30 5d29 2c20 696e 7428 696d  hape[0]), int(im
-0000e910: 675f 6f72 672e 7368 6170 655b 315d 2929  g_org.shape[1]))
-0000e920: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
-0000e930: 6469 6374 696f 6e5f 7265 6769 6f6e 735f  diction_regions_
-0000e940: 6f72 6732 203d 2073 656c 662e 646f 5f70  org2 = self.do_p
-0000e950: 7265 6469 6374 696f 6e28 5472 7565 2c20  rediction(True, 
-0000e960: 696d 672c 206d 6f64 656c 5f72 6567 696f  img, model_regio
-0000e970: 6e2c 2030 2e32 290a 2020 2020 2020 2020  n, 0.2).        
-0000e980: 2020 2020 7072 6564 6963 7469 6f6e 5f72      prediction_r
-0000e990: 6567 696f 6e73 5f6f 7267 323d 7265 7369  egions_org2=resi
-0000e9a0: 7a65 5f69 6d61 6765 2870 7265 6469 6374  ze_image(predict
-0000e9b0: 696f 6e5f 7265 6769 6f6e 735f 6f72 6732  ion_regions_org2
-0000e9c0: 2c20 696d 675f 6865 6967 6874 5f68 2c20  , img_height_h, 
-0000e9d0: 696d 675f 7769 6474 685f 6820 290a 0a0a  img_width_h )...
-0000e9e0: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
-0000e9f0: 5f7a 6572 6f73 3220 3d20 2870 7265 6469  _zeros2 = (predi
-0000ea00: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
-0000ea10: 6732 5b3a 2c3a 2c30 5d20 3d3d 2030 290a  g2[:,:,0] == 0).
-0000ea20: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
-0000ea30: 5f6c 696e 6573 3220 3d20 2870 7265 6469  _lines2 = (predi
-0000ea40: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
-0000ea50: 6732 5b3a 2c3a 2c30 5d20 3d3d 2033 290a  g2[:,:,0] == 3).
-0000ea60: 2020 2020 2020 2020 2020 2020 7465 7874              text
-0000ea70: 5f73 756d 655f 6561 726c 7920 3d20 2870  _sume_early = (p
-0000ea80: 7265 6469 6374 696f 6e5f 7265 6769 6f6e  rediction_region
-0000ea90: 735f 6f72 675b 3a2c 3a5d 203d 3d20 3129  s_org[:,:] == 1)
-0000eaa0: 2e73 756d 2829 0a20 2020 2020 2020 2020  .sum().         
-0000eab0: 2020 2070 7265 6469 6374 696f 6e5f 7265     prediction_re
-0000eac0: 6769 6f6e 735f 6f72 675f 636f 7079 203d  gions_org_copy =
-0000ead0: 206e 702e 636f 7079 2870 7265 6469 6374   np.copy(predict
-0000eae0: 696f 6e5f 7265 6769 6f6e 735f 6f72 6729  ion_regions_org)
-0000eaf0: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
-0000eb00: 6469 6374 696f 6e5f 7265 6769 6f6e 735f  diction_regions_
-0000eb10: 6f72 675f 636f 7079 5b28 7072 6564 6963  org_copy[(predic
-0000eb20: 7469 6f6e 5f72 6567 696f 6e73 5f6f 7267  tion_regions_org
-0000eb30: 5f63 6f70 795b 3a2c 3a5d 3d3d 3129 2026  _copy[:,:]==1) &
-0000eb40: 2028 6d61 736b 5f7a 6572 6f73 325b 3a2c   (mask_zeros2[:,
-0000eb50: 3a5d 3d3d 3129 5d20 3d20 300a 2020 2020  :]==1)] = 0.    
-0000eb60: 2020 2020 2020 2020 7465 7874 5f73 756d          text_sum
-0000eb70: 655f 7365 636f 6e64 203d 2028 2870 7265  e_second = ((pre
-0000eb80: 6469 6374 696f 6e5f 7265 6769 6f6e 735f  diction_regions_
-0000eb90: 6f72 675f 636f 7079 5b3a 2c3a 5d3d 3d31  org_copy[:,:]==1
-0000eba0: 292a 3129 2e73 756d 2829 0a0a 2020 2020  )*1).sum()..    
-0000ebb0: 2020 2020 2020 2020 7261 7465 5f74 776f          rate_two
-0000ebc0: 5f6d 6f64 656c 7320 3d20 7465 7874 5f73  _models = text_s
-0000ebd0: 756d 655f 7365 636f 6e64 202f 2066 6c6f  ume_second / flo
-0000ebe0: 6174 2874 6578 745f 7375 6d65 5f65 6172  at(text_sume_ear
-0000ebf0: 6c79 2920 2a20 3130 300a 0a20 2020 2020  ly) * 100..     
-0000ec00: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
-0000ec10: 6572 2e69 6e66 6f28 2272 6174 696f 5f6f  er.info("ratio_o
-0000ec20: 665f 7477 6f5f 6d6f 6465 6c73 3a20 2573  f_two_models: %s
-0000ec30: 222c 2072 6174 655f 7477 6f5f 6d6f 6465  ", rate_two_mode
-0000ec40: 6c73 290a 2020 2020 2020 2020 2020 2020  ls).            
-0000ec50: 6966 206e 6f74 2869 735f 696d 6167 655f  if not(is_image_
-0000ec60: 656e 6861 6e63 6564 2061 6e64 2072 6174  enhanced and rat
-0000ec70: 655f 7477 6f5f 6d6f 6465 6c73 203c 2052  e_two_models < R
-0000ec80: 4154 494f 5f4f 465f 5457 4f5f 4d4f 4445  ATIO_OF_TWO_MODE
-0000ec90: 4c5f 5448 5245 5348 4f4c 4429 3a0a 2020  L_THRESHOLD):.  
-0000eca0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0000ecb0: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
-0000ecc0: 5f6f 7267 203d 206e 702e 636f 7079 2870  _org = np.copy(p
-0000ecd0: 7265 6469 6374 696f 6e5f 7265 6769 6f6e  rediction_region
-0000ece0: 735f 6f72 675f 636f 7079 290a 2020 2020  s_org_copy).    
-0000ecf0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-0000ed00: 2020 2020 2020 2020 200a 0a20 2020 2020           ..     
-0000ed10: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
-0000ed20: 6e5f 7265 6769 6f6e 735f 6f72 675b 286d  n_regions_org[(m
-0000ed30: 6173 6b5f 6c69 6e65 7332 5b3a 2c3a 5d3d  ask_lines2[:,:]=
-0000ed40: 3d31 2920 2620 2870 7265 6469 6374 696f  =1) & (predictio
-0000ed50: 6e5f 7265 6769 6f6e 735f 6f72 675b 3a2c  n_regions_org[:,
-0000ed60: 3a5d 3d3d 3029 5d3d 330a 2020 2020 2020  :]==0)]=3.      
-0000ed70: 2020 2020 2020 6d61 736b 5f6c 696e 6573        mask_lines
-0000ed80: 5f6f 6e6c 793d 2870 7265 6469 6374 696f  _only=(predictio
-0000ed90: 6e5f 7265 6769 6f6e 735f 6f72 675b 3a2c  n_regions_org[:,
-0000eda0: 3a5d 3d3d 3329 2a31 0a20 2020 2020 2020  :]==3)*1.       
-0000edb0: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
-0000edc0: 7265 6769 6f6e 735f 6f72 6720 3d20 6376  regions_org = cv
-0000edd0: 322e 6572 6f64 6528 7072 6564 6963 7469  2.erode(predicti
-0000ede0: 6f6e 5f72 6567 696f 6e73 5f6f 7267 5b3a  on_regions_org[:
-0000edf0: 2c3a 5d2c 204b 4552 4e45 4c2c 2069 7465  ,:], KERNEL, ite
-0000ee00: 7261 7469 6f6e 733d 3229 0a0a 2020 2020  rations=2)..    
-0000ee10: 2020 2020 2020 2020 2370 6c74 2e69 6d73          #plt.ims
-0000ee20: 686f 7728 7465 7874 5f72 6567 696f 6e32  how(text_region2
-0000ee30: 5f31 7374 5f63 6861 6e6e 656c 290a 2020  _1st_channel).  
-0000ee40: 2020 2020 2020 2020 2020 2370 6c74 2e73            #plt.s
-0000ee50: 686f 7728 290a 0a20 2020 2020 2020 2020  how()..         
-0000ee60: 2020 2070 7265 6469 6374 696f 6e5f 7265     prediction_re
-0000ee70: 6769 6f6e 735f 6f72 6720 3d20 6376 322e  gions_org = cv2.
-0000ee80: 6469 6c61 7465 2870 7265 6469 6374 696f  dilate(predictio
-0000ee90: 6e5f 7265 6769 6f6e 735f 6f72 675b 3a2c  n_regions_org[:,
-0000eea0: 3a5d 2c20 4b45 524e 454c 2c20 6974 6572  :], KERNEL, iter
-0000eeb0: 6174 696f 6e73 3d32 290a 2020 2020 2020  ations=2).      
-0000eec0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-0000eed0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-0000eee0: 6966 2072 6174 655f 7477 6f5f 6d6f 6465  if rate_two_mode
-0000eef0: 6c73 3c3d 3430 3a0a 2020 2020 2020 2020  ls<=40:.        
-0000ef00: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
-0000ef10: 696e 7075 745f 6269 6e61 7279 3a0a 2020  input_binary:.  
-0000ef20: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000ef30: 2020 7072 6564 6963 7469 6f6e 5f62 696e    prediction_bin
-0000ef40: 203d 206e 702e 636f 7079 2869 6d67 5f6f   = np.copy(img_o
-0000ef50: 7267 290a 2020 2020 2020 2020 2020 2020  rg).            
-0000ef60: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0000ef70: 2020 2020 2020 2020 2020 2020 2020 6d6f                mo
-0000ef80: 6465 6c5f 6269 6e2c 2073 6573 7369 6f6e  del_bin, session
-0000ef90: 5f62 696e 203d 2073 656c 662e 7374 6172  _bin = self.star
-0000efa0: 745f 6e65 775f 7365 7373 696f 6e5f 616e  t_new_session_an
-0000efb0: 645f 6d6f 6465 6c28 7365 6c66 2e6d 6f64  d_model(self.mod
-0000efc0: 656c 5f64 6972 5f6f 665f 6269 6e61 7269  el_dir_of_binari
-0000efd0: 7a61 7469 6f6e 290a 2020 2020 2020 2020  zation).        
-0000efe0: 2020 2020 2020 2020 2020 2020 7072 6564              pred
-0000eff0: 6963 7469 6f6e 5f62 696e 203d 2073 656c  iction_bin = sel
-0000f000: 662e 646f 5f70 7265 6469 6374 696f 6e28  f.do_prediction(
-0000f010: 5472 7565 2c20 696d 675f 6f72 672c 206d  True, img_org, m
-0000f020: 6f64 656c 5f62 696e 290a 2020 2020 2020  odel_bin).      
-0000f030: 2020 2020 2020 2020 2020 2020 2020 7072                pr
-0000f040: 6564 6963 7469 6f6e 5f62 696e 203d 2072  ediction_bin = r
-0000f050: 6573 697a 655f 696d 6167 6528 7072 6564  esize_image(pred
-0000f060: 6963 7469 6f6e 5f62 696e 2c20 696d 675f  iction_bin, img_
-0000f070: 6865 6967 6874 5f68 2c20 696d 675f 7769  height_h, img_wi
-0000f080: 6474 685f 6820 290a 2020 2020 2020 2020  dth_h ).        
-0000f090: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-0000f0a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f0b0: 2070 7265 6469 6374 696f 6e5f 6269 6e3d   prediction_bin=
-0000f0c0: 7072 6564 6963 7469 6f6e 5f62 696e 5b3a  prediction_bin[:
-0000f0d0: 2c3a 2c30 5d0a 2020 2020 2020 2020 2020  ,:,0].          
-0000f0e0: 2020 2020 2020 2020 2020 7072 6564 6963            predic
-0000f0f0: 7469 6f6e 5f62 696e 203d 2028 7072 6564  tion_bin = (pred
-0000f100: 6963 7469 6f6e 5f62 696e 5b3a 2c3a 5d3d  iction_bin[:,:]=
-0000f110: 3d30 292a 310a 2020 2020 2020 2020 2020  =0)*1.          
-0000f120: 2020 2020 2020 2020 2020 7072 6564 6963            predic
-0000f130: 7469 6f6e 5f62 696e 203d 2070 7265 6469  tion_bin = predi
-0000f140: 6374 696f 6e5f 6269 6e2a 3235 350a 2020  ction_bin*255.  
-0000f150: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f160: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
-0000f170: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
-0000f180: 6e5f 6269 6e20 3d6e 702e 7265 7065 6174  n_bin =np.repeat
-0000f190: 2870 7265 6469 6374 696f 6e5f 6269 6e5b  (prediction_bin[
-0000f1a0: 3a2c 203a 2c20 6e70 2e6e 6577 6178 6973  :, :, np.newaxis
-0000f1b0: 5d2c 2033 2c20 6178 6973 3d32 290a 0a20  ], 3, axis=2).. 
-0000f1c0: 2020 2020 2020 2020 2020 2020 2020 200a                 .
-0000f1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0000f1e0: 6d6f 6465 6c5f 7265 6769 6f6e 2c20 7365  model_region, se
-0000f1f0: 7373 696f 6e5f 7265 6769 6f6e 203d 2073  ssion_region = s
-0000f200: 656c 662e 7374 6172 745f 6e65 775f 7365  elf.start_new_se
-0000f210: 7373 696f 6e5f 616e 645f 6d6f 6465 6c28  ssion_and_model(
-0000f220: 7365 6c66 2e6d 6f64 656c 5f72 6567 696f  self.model_regio
-0000f230: 6e5f 6469 725f 705f 656e 7329 0a20 2020  n_dir_p_ens).   
-0000f240: 2020 2020 2020 2020 2020 2020 2072 6174               rat
-0000f250: 696f 5f79 3d31 0a20 2020 2020 2020 2020  io_y=1.         
-0000f260: 2020 2020 2020 2072 6174 696f 5f78 3d31         ratio_x=1
-0000f270: 0a0a 0a20 2020 2020 2020 2020 2020 2020  ...             
-0000f280: 2020 2069 6d67 203d 2072 6573 697a 655f     img = resize_
-0000f290: 696d 6167 6528 7072 6564 6963 7469 6f6e  image(prediction
-0000f2a0: 5f62 696e 2c20 696e 7428 696d 675f 6f72  _bin, int(img_or
-0000f2b0: 672e 7368 6170 655b 305d 2a72 6174 696f  g.shape[0]*ratio
-0000f2c0: 5f79 292c 2069 6e74 2869 6d67 5f6f 7267  _y), int(img_org
-0000f2d0: 2e73 6861 7065 5b31 5d2a 7261 7469 6f5f  .shape[1]*ratio_
-0000f2e0: 7829 290a 0a20 2020 2020 2020 2020 2020  x))..           
-0000f2f0: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
-0000f300: 7265 6769 6f6e 735f 6f72 6720 3d20 7365  regions_org = se
-0000f310: 6c66 2e64 6f5f 7072 6564 6963 7469 6f6e  lf.do_prediction
-0000f320: 2854 7275 652c 2069 6d67 2c20 6d6f 6465  (True, img, mode
-0000f330: 6c5f 7265 6769 6f6e 290a 2020 2020 2020  l_region).      
-0000f340: 2020 2020 2020 2020 2020 7072 6564 6963            predic
-0000f350: 7469 6f6e 5f72 6567 696f 6e73 5f6f 7267  tion_regions_org
-0000f360: 203d 2072 6573 697a 655f 696d 6167 6528   = resize_image(
-0000f370: 7072 6564 6963 7469 6f6e 5f72 6567 696f  prediction_regio
-0000f380: 6e73 5f6f 7267 2c20 696d 675f 6865 6967  ns_org, img_heig
-0000f390: 6874 5f68 2c20 696d 675f 7769 6474 685f  ht_h, img_width_
-0000f3a0: 6820 290a 2020 2020 2020 2020 2020 2020  h ).            
-0000f3b0: 2020 2020 7072 6564 6963 7469 6f6e 5f72      prediction_r
-0000f3c0: 6567 696f 6e73 5f6f 7267 3d70 7265 6469  egions_org=predi
-0000f3d0: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
-0000f3e0: 675b 3a2c 3a2c 305d 0a20 2020 2020 2020  g[:,:,0].       
-0000f3f0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0000f400: 2020 2020 2020 2020 2020 6d61 736b 5f6c            mask_l
-0000f410: 696e 6573 5f6f 6e6c 793d 2870 7265 6469  ines_only=(predi
-0000f420: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
-0000f430: 675b 3a2c 3a5d 3d3d 3329 2a31 0a20 2020  g[:,:]==3)*1.   
-0000f440: 2020 2020 2020 2020 2020 2020 200a 2020               .  
-0000f450: 2020 2020 2020 2020 2020 6d61 736b 5f74            mask_t
-0000f460: 6578 7473 5f6f 6e6c 793d 2870 7265 6469  exts_only=(predi
-0000f470: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
-0000f480: 675b 3a2c 3a5d 3d3d 3129 2a31 0a20 2020  g[:,:]==1)*1.   
-0000f490: 2020 2020 2020 2020 206d 6173 6b5f 696d           mask_im
-0000f4a0: 6167 6573 5f6f 6e6c 793d 2870 7265 6469  ages_only=(predi
-0000f4b0: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
-0000f4c0: 675b 3a2c 3a5d 3d3d 3229 2a31 0a20 2020  g[:,:]==2)*1.   
-0000f4d0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0000f4e0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-0000f4f0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-0000f500: 706f 6c79 676f 6e73 5f6c 696e 6573 5f78  polygons_lines_x
-0000f510: 6d6c 2c20 6869 725f 6c69 6e65 735f 786d  ml, hir_lines_xm
-0000f520: 6c20 3d20 7265 7475 726e 5f63 6f6e 746f  l = return_conto
-0000f530: 7572 735f 6f66 5f69 6d61 6765 286d 6173  urs_of_image(mas
-0000f540: 6b5f 6c69 6e65 735f 6f6e 6c79 290a 2020  k_lines_only).  
-0000f550: 2020 2020 2020 2020 2020 706f 6c79 676f            polygo
-0000f560: 6e73 5f6c 696e 6573 5f78 6d6c 203d 2074  ns_lines_xml = t
-0000f570: 6578 746c 696e 655f 636f 6e5f 6669 6c20  extline_con_fil 
-0000f580: 3d20 6669 6c74 6572 5f63 6f6e 746f 7572  = filter_contour
-0000f590: 735f 6172 6561 5f6f 665f 696d 6167 6528  s_area_of_image(
-0000f5a0: 6d61 736b 5f6c 696e 6573 5f6f 6e6c 792c  mask_lines_only,
-0000f5b0: 2070 6f6c 7967 6f6e 735f 6c69 6e65 735f   polygons_lines_
-0000f5c0: 786d 6c2c 2068 6972 5f6c 696e 6573 5f78  xml, hir_lines_x
-0000f5d0: 6d6c 2c20 6d61 785f 6172 6561 3d31 2c20  ml, max_area=1, 
-0000f5e0: 6d69 6e5f 6172 6561 3d30 2e30 3030 3031  min_area=0.00001
-0000f5f0: 290a 0a20 2020 2020 2020 2020 2020 2070  )..            p
-0000f600: 6f6c 7967 6f6e 735f 6f66 5f6f 6e6c 795f  olygons_of_only_
-0000f610: 7465 7874 7320 3d20 7265 7475 726e 5f63  texts = return_c
-0000f620: 6f6e 746f 7572 735f 6f66 5f69 6e74 6572  ontours_of_inter
-0000f630: 6573 7465 645f 7265 6769 6f6e 286d 6173  ested_region(mas
-0000f640: 6b5f 7465 7874 735f 6f6e 6c79 2c20 312c  k_texts_only, 1,
-0000f650: 2030 2e30 3030 3031 290a 2020 2020 2020   0.00001).      
-0000f660: 2020 2020 2020 706f 6c79 676f 6e73 5f6f        polygons_o
-0000f670: 665f 6f6e 6c79 5f6c 696e 6573 203d 2072  f_only_lines = r
-0000f680: 6574 7572 6e5f 636f 6e74 6f75 7273 5f6f  eturn_contours_o
-0000f690: 665f 696e 7465 7265 7374 6564 5f72 6567  f_interested_reg
-0000f6a0: 696f 6e28 6d61 736b 5f6c 696e 6573 5f6f  ion(mask_lines_o
-0000f6b0: 6e6c 792c 2031 2c20 302e 3030 3030 3129  nly, 1, 0.00001)
-0000f6c0: 0a0a 2020 2020 2020 2020 2020 2020 7465  ..            te
-0000f6d0: 7874 5f72 6567 696f 6e73 5f70 5f74 7275  xt_regions_p_tru
-0000f6e0: 6520 3d20 6e70 2e7a 6572 6f73 2870 7265  e = np.zeros(pre
-0000f6f0: 6469 6374 696f 6e5f 7265 6769 6f6e 735f  diction_regions_
-0000f700: 6f72 672e 7368 6170 6529 0a20 2020 2020  org.shape).     
-0000f710: 2020 2020 2020 2074 6578 745f 7265 6769         text_regi
-0000f720: 6f6e 735f 705f 7472 7565 203d 2063 7632  ons_p_true = cv2
-0000f730: 2e66 696c 6c50 6f6c 7928 7465 7874 5f72  .fillPoly(text_r
-0000f740: 6567 696f 6e73 5f70 5f74 7275 652c 7074  egions_p_true,pt
-0000f750: 7320 3d20 706f 6c79 676f 6e73 5f6f 665f  s = polygons_of_
-0000f760: 6f6e 6c79 5f6c 696e 6573 2c20 636f 6c6f  only_lines, colo
-0000f770: 723d 2833 2c20 332c 2033 2929 0a20 2020  r=(3, 3, 3)).   
-0000f780: 2020 2020 2020 2020 2074 6578 745f 7265           text_re
-0000f790: 6769 6f6e 735f 705f 7472 7565 5b3a 2c3a  gions_p_true[:,:
-0000f7a0: 5d5b 6d61 736b 5f69 6d61 6765 735f 6f6e  ][mask_images_on
-0000f7b0: 6c79 5b3a 2c3a 5d20 3d3d 2031 5d20 3d20  ly[:,:] == 1] = 
-0000f7c0: 320a 0a20 2020 2020 2020 2020 2020 2074  2..            t
-0000f7d0: 6578 745f 7265 6769 6f6e 735f 705f 7472  ext_regions_p_tr
-0000f7e0: 7565 3d63 7632 2e66 696c 6c50 6f6c 7928  ue=cv2.fillPoly(
-0000f7f0: 7465 7874 5f72 6567 696f 6e73 5f70 5f74  text_regions_p_t
-0000f800: 7275 652c 7074 733d 706f 6c79 676f 6e73  rue,pts=polygons
-0000f810: 5f6f 665f 6f6e 6c79 5f74 6578 7473 2c20  _of_only_texts, 
-0000f820: 636f 6c6f 723d 2831 2c31 2c31 2929 0a0a  color=(1,1,1))..
-0000f830: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0000f840: 726e 2074 6578 745f 7265 6769 6f6e 735f  rn text_regions_
-0000f850: 705f 7472 7565 2c20 6572 6f73 696f 6e5f  p_true, erosion_
-0000f860: 6875 7274 732c 2070 6f6c 7967 6f6e 735f  hurts, polygons_
-0000f870: 6c69 6e65 735f 786d 6c0a 2020 2020 2020  lines_xml.      
-0000f880: 2020 6578 6365 7074 3a0a 2020 2020 2020    except:.      
-0000f890: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-0000f8a0: 2020 2069 6620 7365 6c66 2e69 6e70 7574     if self.input
-0000f8b0: 5f62 696e 6172 793a 0a20 2020 2020 2020  _binary:.       
-0000f8c0: 2020 2020 2020 2020 2070 7265 6469 6374           predict
-0000f8d0: 696f 6e5f 6269 6e20 3d20 6e70 2e63 6f70  ion_bin = np.cop
-0000f8e0: 7928 696d 675f 6f72 6729 0a20 2020 2020  y(img_org).     
-0000f8f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0000f900: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
-0000f910: 656c 5f62 696e 2c20 7365 7373 696f 6e5f  el_bin, session_
-0000f920: 6269 6e20 3d20 7365 6c66 2e73 7461 7274  bin = self.start
-0000f930: 5f6e 6577 5f73 6573 7369 6f6e 5f61 6e64  _new_session_and
-0000f940: 5f6d 6f64 656c 2873 656c 662e 6d6f 6465  _model(self.mode
-0000f950: 6c5f 6469 725f 6f66 5f62 696e 6172 697a  l_dir_of_binariz
-0000f960: 6174 696f 6e29 0a20 2020 2020 2020 2020  ation).         
-0000f970: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
-0000f980: 6e5f 6269 6e20 3d20 7365 6c66 2e64 6f5f  n_bin = self.do_
-0000f990: 7072 6564 6963 7469 6f6e 2854 7275 652c  prediction(True,
-0000f9a0: 2069 6d67 5f6f 7267 2c20 6d6f 6465 6c5f   img_org, model_
-0000f9b0: 6269 6e29 0a20 2020 2020 2020 2020 2020  bin).           
-0000f9c0: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
-0000f9d0: 6269 6e20 3d20 7265 7369 7a65 5f69 6d61  bin = resize_ima
-0000f9e0: 6765 2870 7265 6469 6374 696f 6e5f 6269  ge(prediction_bi
-0000f9f0: 6e2c 2069 6d67 5f68 6569 6768 745f 682c  n, img_height_h,
-0000fa00: 2069 6d67 5f77 6964 7468 5f68 2029 0a20   img_width_h ). 
-0000fa10: 2020 2020 2020 2020 2020 2020 2020 2070                 p
-0000fa20: 7265 6469 6374 696f 6e5f 6269 6e3d 7072  rediction_bin=pr
-0000fa30: 6564 6963 7469 6f6e 5f62 696e 5b3a 2c3a  ediction_bin[:,:
-0000fa40: 2c30 5d0a 2020 2020 2020 2020 2020 2020  ,0].            
-0000fa50: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-0000fa60: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
-0000fa70: 6269 6e20 3d20 2870 7265 6469 6374 696f  bin = (predictio
-0000fa80: 6e5f 6269 6e5b 3a2c 3a5d 3d3d 3029 2a31  n_bin[:,:]==0)*1
-0000fa90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0000faa0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-0000fab0: 2020 7072 6564 6963 7469 6f6e 5f62 696e    prediction_bin
-0000fac0: 203d 2070 7265 6469 6374 696f 6e5f 6269   = prediction_bi
-0000fad0: 6e2a 3235 350a 2020 2020 2020 2020 2020  n*255.          
-0000fae0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-0000faf0: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
-0000fb00: 6e5f 6269 6e20 3d6e 702e 7265 7065 6174  n_bin =np.repeat
-0000fb10: 2870 7265 6469 6374 696f 6e5f 6269 6e5b  (prediction_bin[
-0000fb20: 3a2c 203a 2c20 6e70 2e6e 6577 6178 6973  :, :, np.newaxis
-0000fb30: 5d2c 2033 2c20 6178 6973 3d32 290a 0a20  ], 3, axis=2).. 
-0000fb40: 2020 2020 2020 2020 2020 2020 2020 206d                 m
-0000fb50: 6f64 656c 5f72 6567 696f 6e2c 2073 6573  odel_region, ses
-0000fb60: 7369 6f6e 5f72 6567 696f 6e20 3d20 7365  sion_region = se
-0000fb70: 6c66 2e73 7461 7274 5f6e 6577 5f73 6573  lf.start_new_ses
-0000fb80: 7369 6f6e 5f61 6e64 5f6d 6f64 656c 2873  sion_and_model(s
-0000fb90: 656c 662e 6d6f 6465 6c5f 7265 6769 6f6e  elf.model_region
-0000fba0: 5f64 6972 5f70 5f65 6e73 290a 2020 2020  _dir_p_ens).    
-0000fbb0: 2020 2020 2020 2020 7261 7469 6f5f 793d          ratio_y=
-0000fbc0: 310a 2020 2020 2020 2020 2020 2020 7261  1.            ra
-0000fbd0: 7469 6f5f 783d 310a 0a0a 2020 2020 2020  tio_x=1...      
-0000fbe0: 2020 2020 2020 696d 6720 3d20 7265 7369        img = resi
-0000fbf0: 7a65 5f69 6d61 6765 2870 7265 6469 6374  ze_image(predict
-0000fc00: 696f 6e5f 6269 6e2c 2069 6e74 2869 6d67  ion_bin, int(img
-0000fc10: 5f6f 7267 2e73 6861 7065 5b30 5d2a 7261  _org.shape[0]*ra
-0000fc20: 7469 6f5f 7929 2c20 696e 7428 696d 675f  tio_y), int(img_
-0000fc30: 6f72 672e 7368 6170 655b 315d 2a72 6174  org.shape[1]*rat
-0000fc40: 696f 5f78 2929 0a0a 2020 2020 2020 2020  io_x))..        
-0000fc50: 2020 2020 7072 6564 6963 7469 6f6e 5f72      prediction_r
-0000fc60: 6567 696f 6e73 5f6f 7267 203d 2073 656c  egions_org = sel
-0000fc70: 662e 646f 5f70 7265 6469 6374 696f 6e28  f.do_prediction(
-0000fc80: 5472 7565 2c20 696d 672c 206d 6f64 656c  True, img, model
-0000fc90: 5f72 6567 696f 6e29 0a20 2020 2020 2020  _region).       
-0000fca0: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
-0000fcb0: 7265 6769 6f6e 735f 6f72 6720 3d20 7265  regions_org = re
-0000fcc0: 7369 7a65 5f69 6d61 6765 2870 7265 6469  size_image(predi
-0000fcd0: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
-0000fce0: 672c 2069 6d67 5f68 6569 6768 745f 682c  g, img_height_h,
-0000fcf0: 2069 6d67 5f77 6964 7468 5f68 2029 0a20   img_width_h ). 
-0000fd00: 2020 2020 2020 2020 2020 2070 7265 6469             predi
-0000fd10: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
-0000fd20: 673d 7072 6564 6963 7469 6f6e 5f72 6567  g=prediction_reg
-0000fd30: 696f 6e73 5f6f 7267 5b3a 2c3a 2c30 5d0a  ions_org[:,:,0].
-0000fd40: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-0000fd50: 2020 2020 2020 2020 2023 6d61 736b 5f6c           #mask_l
-0000fd60: 696e 6573 5f6f 6e6c 793d 2870 7265 6469  ines_only=(predi
-0000fd70: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
-0000fd80: 675b 3a2c 3a5d 3d3d 3329 2a31 0a20 2020  g[:,:]==3)*1.   
-0000fd90: 2020 2020 2020 2020 2023 696d 6720 3d20           #img = 
-0000fda0: 7265 7369 7a65 5f69 6d61 6765 2869 6d67  resize_image(img
-0000fdb0: 5f6f 7267 2c20 696e 7428 696d 675f 6f72  _org, int(img_or
-0000fdc0: 672e 7368 6170 655b 305d 2a31 292c 2069  g.shape[0]*1), i
-0000fdd0: 6e74 2869 6d67 5f6f 7267 2e73 6861 7065  nt(img_org.shape
-0000fde0: 5b31 5d2a 3129 290a 2020 2020 2020 2020  [1]*1)).        
-0000fdf0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-0000fe00: 2023 7072 6564 6963 7469 6f6e 5f72 6567   #prediction_reg
-0000fe10: 696f 6e73 5f6f 7267 203d 2073 656c 662e  ions_org = self.
-0000fe20: 646f 5f70 7265 6469 6374 696f 6e28 5472  do_prediction(Tr
-0000fe30: 7565 2c20 696d 672c 206d 6f64 656c 5f72  ue, img, model_r
-0000fe40: 6567 696f 6e29 0a20 2020 2020 2020 2020  egion).         
-0000fe50: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-0000fe60: 2370 7265 6469 6374 696f 6e5f 7265 6769  #prediction_regi
-0000fe70: 6f6e 735f 6f72 6720 3d20 7265 7369 7a65  ons_org = resize
-0000fe80: 5f69 6d61 6765 2870 7265 6469 6374 696f  _image(predictio
-0000fe90: 6e5f 7265 6769 6f6e 735f 6f72 672c 2069  n_regions_org, i
-0000fea0: 6d67 5f68 6569 6768 745f 682c 2069 6d67  mg_height_h, img
-0000feb0: 5f77 6964 7468 5f68 2029 0a20 2020 2020  _width_h ).     
-0000fec0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0000fed0: 2020 2020 2370 7265 6469 6374 696f 6e5f      #prediction_
-0000fee0: 7265 6769 6f6e 735f 6f72 6720 3d20 7072  regions_org = pr
-0000fef0: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
-0000ff00: 5f6f 7267 5b3a 2c3a 2c30 5d0a 2020 2020  _org[:,:,0].    
-0000ff10: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0000ff20: 2020 2020 2023 7072 6564 6963 7469 6f6e       #prediction
-0000ff30: 5f72 6567 696f 6e73 5f6f 7267 5b28 7072  _regions_org[(pr
-0000ff40: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
-0000ff50: 5f6f 7267 5b3a 2c3a 5d20 3d3d 2031 2920  _org[:,:] == 1) 
-0000ff60: 2620 286d 6173 6b5f 7a65 726f 735f 795b  & (mask_zeros_y[
-0000ff70: 3a2c 3a5d 203d 3d20 3129 5d3d 300a 2020  :,:] == 1)]=0.  
-0000ff80: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-0000ff90: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0000ffa0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-0000ffb0: 206d 6173 6b5f 6c69 6e65 735f 6f6e 6c79   mask_lines_only
-0000ffc0: 203d 2028 7072 6564 6963 7469 6f6e 5f72   = (prediction_r
-0000ffd0: 6567 696f 6e73 5f6f 7267 5b3a 2c3a 5d20  egions_org[:,:] 
-0000ffe0: 3d3d 3329 2a31 0a20 2020 2020 2020 2020  ==3)*1.         
-0000fff0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-00010000: 6d61 736b 5f74 6578 7473 5f6f 6e6c 7920  mask_texts_only 
-00010010: 3d20 2870 7265 6469 6374 696f 6e5f 7265  = (prediction_re
-00010020: 6769 6f6e 735f 6f72 675b 3a2c 3a5d 203d  gions_org[:,:] =
-00010030: 3d31 292a 310a 2020 2020 2020 2020 2020  =1)*1.          
-00010040: 2020 0a20 2020 2020 2020 2020 2020 206d    .            m
-00010050: 6173 6b5f 696d 6167 6573 5f6f 6e6c 793d  ask_images_only=
-00010060: 2870 7265 6469 6374 696f 6e5f 7265 6769  (prediction_regi
-00010070: 6f6e 735f 6f72 675b 3a2c 3a5d 203d 3d32  ons_org[:,:] ==2
-00010080: 292a 310a 2020 2020 2020 2020 2020 2020  )*1.            
-00010090: 0a20 2020 2020 2020 2020 2020 2070 6f6c  .            pol
-000100a0: 7967 6f6e 735f 6c69 6e65 735f 786d 6c2c  ygons_lines_xml,
-000100b0: 2068 6972 5f6c 696e 6573 5f78 6d6c 203d   hir_lines_xml =
-000100c0: 2072 6574 7572 6e5f 636f 6e74 6f75 7273   return_contours
-000100d0: 5f6f 665f 696d 6167 6528 6d61 736b 5f6c  _of_image(mask_l
-000100e0: 696e 6573 5f6f 6e6c 7929 0a20 2020 2020  ines_only).     
-000100f0: 2020 2020 2020 2070 6f6c 7967 6f6e 735f         polygons_
-00010100: 6c69 6e65 735f 786d 6c20 3d20 7465 7874  lines_xml = text
-00010110: 6c69 6e65 5f63 6f6e 5f66 696c 203d 2066  line_con_fil = f
-00010120: 696c 7465 725f 636f 6e74 6f75 7273 5f61  ilter_contours_a
-00010130: 7265 615f 6f66 5f69 6d61 6765 286d 6173  rea_of_image(mas
-00010140: 6b5f 6c69 6e65 735f 6f6e 6c79 2c20 706f  k_lines_only, po
-00010150: 6c79 676f 6e73 5f6c 696e 6573 5f78 6d6c  lygons_lines_xml
-00010160: 2c20 6869 725f 6c69 6e65 735f 786d 6c2c  , hir_lines_xml,
-00010170: 206d 6178 5f61 7265 613d 312c 206d 696e   max_area=1, min
-00010180: 5f61 7265 613d 302e 3030 3030 3129 0a20  _area=0.00001). 
-00010190: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-000101a0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-000101b0: 2020 2020 2070 6f6c 7967 6f6e 735f 6f66       polygons_of
-000101c0: 5f6f 6e6c 795f 7465 7874 7320 3d20 7265  _only_texts = re
-000101d0: 7475 726e 5f63 6f6e 746f 7572 735f 6f66  turn_contours_of
-000101e0: 5f69 6e74 6572 6573 7465 645f 7265 6769  _interested_regi
-000101f0: 6f6e 286d 6173 6b5f 7465 7874 735f 6f6e  on(mask_texts_on
-00010200: 6c79 2c31 2c30 2e30 3030 3031 290a 2020  ly,1,0.00001).  
-00010210: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-00010220: 2020 2020 2020 2070 6f6c 7967 6f6e 735f         polygons_
-00010230: 6f66 5f6f 6e6c 795f 6c69 6e65 7320 3d20  of_only_lines = 
-00010240: 7265 7475 726e 5f63 6f6e 746f 7572 735f  return_contours_
-00010250: 6f66 5f69 6e74 6572 6573 7465 645f 7265  of_interested_re
-00010260: 6769 6f6e 286d 6173 6b5f 6c69 6e65 735f  gion(mask_lines_
-00010270: 6f6e 6c79 2c31 2c30 2e30 3030 3031 290a  only,1,0.00001).
-00010280: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-00010290: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-000102a0: 2020 2020 2020 7465 7874 5f72 6567 696f        text_regio
-000102b0: 6e73 5f70 5f74 7275 6520 3d20 6e70 2e7a  ns_p_true = np.z
-000102c0: 6572 6f73 2870 7265 6469 6374 696f 6e5f  eros(prediction_
-000102d0: 7265 6769 6f6e 735f 6f72 672e 7368 6170  regions_org.shap
-000102e0: 6529 0a20 2020 2020 2020 2020 2020 200a  e).            .
-000102f0: 2020 2020 2020 2020 2020 2020 7465 7874              text
-00010300: 5f72 6567 696f 6e73 5f70 5f74 7275 6520  _regions_p_true 
-00010310: 3d20 6376 322e 6669 6c6c 506f 6c79 2874  = cv2.fillPoly(t
-00010320: 6578 745f 7265 6769 6f6e 735f 705f 7472  ext_regions_p_tr
-00010330: 7565 2c20 7074 7320 3d20 706f 6c79 676f  ue, pts = polygo
-00010340: 6e73 5f6f 665f 6f6e 6c79 5f6c 696e 6573  ns_of_only_lines
-00010350: 2c20 636f 6c6f 723d 2833 2c33 2c33 2929  , color=(3,3,3))
-00010360: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
-00010370: 2020 2020 2020 2020 2020 7465 7874 5f72            text_r
-00010380: 6567 696f 6e73 5f70 5f74 7275 655b 3a2c  egions_p_true[:,
-00010390: 3a5d 5b6d 6173 6b5f 696d 6167 6573 5f6f  :][mask_images_o
-000103a0: 6e6c 795b 3a2c 3a5d 203d 3d20 315d 203d  nly[:,:] == 1] =
-000103b0: 2032 0a20 2020 2020 2020 2020 2020 200a   2.            .
-000103c0: 2020 2020 2020 2020 2020 2020 7465 7874              text
-000103d0: 5f72 6567 696f 6e73 5f70 5f74 7275 6520  _regions_p_true 
-000103e0: 3d20 6376 322e 6669 6c6c 506f 6c79 2874  = cv2.fillPoly(t
-000103f0: 6578 745f 7265 6769 6f6e 735f 705f 7472  ext_regions_p_tr
-00010400: 7565 2c20 7074 7320 3d20 706f 6c79 676f  ue, pts = polygo
-00010410: 6e73 5f6f 665f 6f6e 6c79 5f74 6578 7473  ns_of_only_texts
-00010420: 2c20 636f 6c6f 723d 2831 2c31 2c31 2929  , color=(1,1,1))
-00010430: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
-00010440: 2020 2020 2020 2020 2020 6572 6f73 696f            erosio
-00010450: 6e5f 6875 7274 7320 3d20 5472 7565 0a0a  n_hurts = True..
-00010460: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-00010470: 726e 2074 6578 745f 7265 6769 6f6e 735f  rn text_regions_
-00010480: 705f 7472 7565 2c20 6572 6f73 696f 6e5f  p_true, erosion_
-00010490: 6875 7274 732c 2070 6f6c 7967 6f6e 735f  hurts, polygons_
-000104a0: 6c69 6e65 735f 786d 6c0a 0a20 2020 2064  lines_xml..    d
-000104b0: 6566 2064 6f5f 6f72 6465 725f 6f66 5f72  ef do_order_of_r
-000104c0: 6567 696f 6e73 5f66 756c 6c5f 6c61 796f  egions_full_layo
-000104d0: 7574 2873 656c 662c 2063 6f6e 746f 7572  ut(self, contour
-000104e0: 735f 6f6e 6c79 5f74 6578 745f 7061 7265  s_only_text_pare
-000104f0: 6e74 2c20 636f 6e74 6f75 7273 5f6f 6e6c  nt, contours_onl
-00010500: 795f 7465 7874 5f70 6172 656e 745f 682c  y_text_parent_h,
-00010510: 2062 6f78 6573 2c20 7465 7874 6c69 6e65   boxes, textline
-00010520: 5f6d 6173 6b5f 746f 7429 3a0a 2020 2020  _mask_tot):.    
-00010530: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
-00010540: 6465 6275 6728 2265 6e74 6572 2064 6f5f  debug("enter do_
-00010550: 6f72 6465 725f 6f66 5f72 6567 696f 6e73  order_of_regions
-00010560: 5f66 756c 6c5f 6c61 796f 7574 2229 0a20  _full_layout"). 
-00010570: 2020 2020 2020 2063 785f 7465 7874 5f6f         cx_text_o
-00010580: 6e6c 792c 2063 795f 7465 7874 5f6f 6e6c  nly, cy_text_onl
-00010590: 792c 2078 5f6d 696e 5f74 6578 745f 6f6e  y, x_min_text_on
-000105a0: 6c79 2c20 5f2c 205f 2c20 5f2c 2079 5f63  ly, _, _, _, y_c
-000105b0: 6f72 5f78 5f6d 696e 5f6d 6169 6e20 3d20  or_x_min_main = 
-000105c0: 6669 6e64 5f6e 6577 5f66 6561 7475 7265  find_new_feature
-000105d0: 735f 6f66 5f63 6f6e 746f 7572 7328 636f  s_of_contours(co
-000105e0: 6e74 6f75 7273 5f6f 6e6c 795f 7465 7874  ntours_only_text
-000105f0: 5f70 6172 656e 7429 0a20 2020 2020 2020  _parent).       
-00010600: 2063 785f 7465 7874 5f6f 6e6c 795f 682c   cx_text_only_h,
-00010610: 2063 795f 7465 7874 5f6f 6e6c 795f 682c   cy_text_only_h,
-00010620: 2078 5f6d 696e 5f74 6578 745f 6f6e 6c79   x_min_text_only
-00010630: 5f68 2c20 5f2c 205f 2c20 5f2c 2079 5f63  _h, _, _, _, y_c
-00010640: 6f72 5f78 5f6d 696e 5f6d 6169 6e5f 6820  or_x_min_main_h 
-00010650: 3d20 6669 6e64 5f6e 6577 5f66 6561 7475  = find_new_featu
-00010660: 7265 735f 6f66 5f63 6f6e 746f 7572 7328  res_of_contours(
-00010670: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
-00010680: 7874 5f70 6172 656e 745f 6829 0a0a 2020  xt_parent_h)..  
-00010690: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
-000106a0: 2020 2020 2020 2061 7267 5f74 6578 745f         arg_text_
-000106b0: 636f 6e20 3d20 5b5d 0a20 2020 2020 2020  con = [].       
-000106c0: 2020 2020 2066 6f72 2069 6920 696e 2072       for ii in r
-000106d0: 616e 6765 286c 656e 2863 785f 7465 7874  ange(len(cx_text
-000106e0: 5f6f 6e6c 7929 293a 0a20 2020 2020 2020  _only)):.       
-000106f0: 2020 2020 2020 2020 2066 6f72 206a 6a20           for jj 
-00010700: 696e 2072 616e 6765 286c 656e 2862 6f78  in range(len(box
-00010710: 6573 2929 3a0a 2020 2020 2020 2020 2020  es)):.          
-00010720: 2020 2020 2020 2020 2020 6966 2028 785f            if (x_
-00010730: 6d69 6e5f 7465 7874 5f6f 6e6c 795b 6969  min_text_only[ii
-00010740: 5d20 2b20 3830 2920 3e3d 2062 6f78 6573  ] + 80) >= boxes
-00010750: 5b6a 6a5d 5b30 5d20 616e 6420 2878 5f6d  [jj][0] and (x_m
-00010760: 696e 5f74 6578 745f 6f6e 6c79 5b69 695d  in_text_only[ii]
-00010770: 202b 2038 3029 203c 2062 6f78 6573 5b6a   + 80) < boxes[j
-00010780: 6a5d 5b31 5d20 616e 6420 795f 636f 725f  j][1] and y_cor_
-00010790: 785f 6d69 6e5f 6d61 696e 5b69 695d 203e  x_min_main[ii] >
-000107a0: 3d20 626f 7865 735b 6a6a 5d5b 325d 2061  = boxes[jj][2] a
-000107b0: 6e64 2079 5f63 6f72 5f78 5f6d 696e 5f6d  nd y_cor_x_min_m
-000107c0: 6169 6e5b 6969 5d20 3c20 626f 7865 735b  ain[ii] < boxes[
-000107d0: 6a6a 5d5b 335d 3a0a 2020 2020 2020 2020  jj][3]:.        
-000107e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000107f0: 6172 675f 7465 7874 5f63 6f6e 2e61 7070  arg_text_con.app
-00010800: 656e 6428 6a6a 290a 2020 2020 2020 2020  end(jj).        
-00010810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010820: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
-00010830: 2020 6172 6773 5f63 6f6e 746f 7572 7320    args_contours 
-00010840: 3d20 6e70 2e61 7272 6179 2872 616e 6765  = np.array(range
-00010850: 286c 656e 2861 7267 5f74 6578 745f 636f  (len(arg_text_co
-00010860: 6e29 2929 0a20 2020 2020 2020 2020 2020  n))).           
-00010870: 2061 7267 5f74 6578 745f 636f 6e5f 6820   arg_text_con_h 
-00010880: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00010890: 2066 6f72 2069 6920 696e 2072 616e 6765   for ii in range
-000108a0: 286c 656e 2863 785f 7465 7874 5f6f 6e6c  (len(cx_text_onl
-000108b0: 795f 6829 293a 0a20 2020 2020 2020 2020  y_h)):.         
-000108c0: 2020 2020 2020 2066 6f72 206a 6a20 696e         for jj in
-000108d0: 2072 616e 6765 286c 656e 2862 6f78 6573   range(len(boxes
-000108e0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-000108f0: 2020 2020 2020 2020 6966 2028 785f 6d69          if (x_mi
-00010900: 6e5f 7465 7874 5f6f 6e6c 795f 685b 6969  n_text_only_h[ii
-00010910: 5d20 2b20 3830 2920 3e3d 2062 6f78 6573  ] + 80) >= boxes
-00010920: 5b6a 6a5d 5b30 5d20 616e 6420 2878 5f6d  [jj][0] and (x_m
-00010930: 696e 5f74 6578 745f 6f6e 6c79 5f68 5b69  in_text_only_h[i
-00010940: 695d 202b 2038 3029 203c 2062 6f78 6573  i] + 80) < boxes
-00010950: 5b6a 6a5d 5b31 5d20 616e 6420 795f 636f  [jj][1] and y_co
-00010960: 725f 785f 6d69 6e5f 6d61 696e 5f68 5b69  r_x_min_main_h[i
-00010970: 695d 203e 3d20 626f 7865 735b 6a6a 5d5b  i] >= boxes[jj][
-00010980: 325d 2061 6e64 2079 5f63 6f72 5f78 5f6d  2] and y_cor_x_m
-00010990: 696e 5f6d 6169 6e5f 685b 6969 5d20 3c20  in_main_h[ii] < 
-000109a0: 626f 7865 735b 6a6a 5d5b 335d 3a0a 2020  boxes[jj][3]:.  
-000109b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000109c0: 2020 2020 2020 6172 675f 7465 7874 5f63        arg_text_c
-000109d0: 6f6e 5f68 2e61 7070 656e 6428 6a6a 290a  on_h.append(jj).
-000109e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000109f0: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
-00010a00: 2020 2020 2020 2020 2020 6172 6773 5f63            args_c
-00010a10: 6f6e 746f 7572 735f 6820 3d20 6e70 2e61  ontours_h = np.a
-00010a20: 7272 6179 2872 616e 6765 286c 656e 2861  rray(range(len(a
-00010a30: 7267 5f74 6578 745f 636f 6e5f 6829 2929  rg_text_con_h)))
-00010a40: 0a0a 2020 2020 2020 2020 2020 2020 6f72  ..            or
-00010a50: 6465 725f 6279 5f63 6f6e 5f68 6561 6420  der_by_con_head 
-00010a60: 3d20 6e70 2e7a 6572 6f73 286c 656e 2861  = np.zeros(len(a
-00010a70: 7267 5f74 6578 745f 636f 6e5f 6829 290a  rg_text_con_h)).
-00010a80: 2020 2020 2020 2020 2020 2020 6f72 6465              orde
-00010a90: 725f 6279 5f63 6f6e 5f6d 6169 6e20 3d20  r_by_con_main = 
-00010aa0: 6e70 2e7a 6572 6f73 286c 656e 2861 7267  np.zeros(len(arg
-00010ab0: 5f74 6578 745f 636f 6e29 290a 0a20 2020  _text_con))..   
-00010ac0: 2020 2020 2020 2020 2072 6566 5f70 6f69           ref_poi
-00010ad0: 6e74 203d 2030 0a20 2020 2020 2020 2020  nt = 0.         
-00010ae0: 2020 206f 7264 6572 5f6f 665f 7465 7874     order_of_text
-00010af0: 735f 746f 7420 3d20 5b5d 0a20 2020 2020  s_tot = [].     
-00010b00: 2020 2020 2020 2069 645f 6f66 5f74 6578         id_of_tex
-00010b10: 7473 5f74 6f74 203d 205b 5d0a 2020 2020  ts_tot = [].    
-00010b20: 2020 2020 2020 2020 666f 7220 6969 6a20          for iij 
-00010b30: 696e 2072 616e 6765 286c 656e 2862 6f78  in range(len(box
-00010b40: 6573 2929 3a0a 0a20 2020 2020 2020 2020  es)):..         
-00010b50: 2020 2020 2020 2061 7267 735f 636f 6e74         args_cont
-00010b60: 6f75 7273 5f62 6f78 203d 2061 7267 735f  ours_box = args_
-00010b70: 636f 6e74 6f75 7273 5b6e 702e 6172 7261  contours[np.arra
-00010b80: 7928 6172 675f 7465 7874 5f63 6f6e 2920  y(arg_text_con) 
-00010b90: 3d3d 2069 696a 5d0a 2020 2020 2020 2020  == iij].        
-00010ba0: 2020 2020 2020 2020 6172 6773 5f63 6f6e          args_con
-00010bb0: 746f 7572 735f 626f 785f 6820 3d20 6172  tours_box_h = ar
-00010bc0: 6773 5f63 6f6e 746f 7572 735f 685b 6e70  gs_contours_h[np
-00010bd0: 2e61 7272 6179 2861 7267 5f74 6578 745f  .array(arg_text_
-00010be0: 636f 6e5f 6829 203d 3d20 6969 6a5d 0a20  con_h) == iij]. 
-00010bf0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-00010c00: 6f6e 5f69 6e74 6572 5f62 6f78 203d 205b  on_inter_box = [
-00010c10: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00010c20: 2020 636f 6e5f 696e 7465 725f 626f 785f    con_inter_box_
-00010c30: 6820 3d20 5b5d 0a0a 2020 2020 2020 2020  h = []..        
-00010c40: 2020 2020 2020 2020 666f 7220 626f 7820          for box 
-00010c50: 696e 2061 7267 735f 636f 6e74 6f75 7273  in args_contours
-00010c60: 5f62 6f78 3a0a 2020 2020 2020 2020 2020  _box:.          
-00010c70: 2020 2020 2020 2020 2020 636f 6e5f 696e            con_in
-00010c80: 7465 725f 626f 782e 6170 7065 6e64 2863  ter_box.append(c
-00010c90: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
-00010ca0: 745f 7061 7265 6e74 5b62 6f78 5d29 0a0a  t_parent[box])..
-00010cb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010cc0: 666f 7220 626f 7820 696e 2061 7267 735f  for box in args_
-00010cd0: 636f 6e74 6f75 7273 5f62 6f78 5f68 3a0a  contours_box_h:.
-00010ce0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010cf0: 2020 2020 636f 6e5f 696e 7465 725f 626f      con_inter_bo
-00010d00: 785f 682e 6170 7065 6e64 2863 6f6e 746f  x_h.append(conto
-00010d10: 7572 735f 6f6e 6c79 5f74 6578 745f 7061  urs_only_text_pa
-00010d20: 7265 6e74 5f68 5b62 6f78 5d29 0a0a 2020  rent_h[box])..  
-00010d30: 2020 2020 2020 2020 2020 2020 2020 696e                in
-00010d40: 6465 7865 735f 736f 7274 6564 2c20 6d61  dexes_sorted, ma
-00010d50: 7472 6978 5f6f 665f 6f72 6465 7273 2c20  trix_of_orders, 
-00010d60: 6b69 6e64 5f6f 665f 7465 7874 735f 736f  kind_of_texts_so
-00010d70: 7274 6564 2c20 696e 6465 785f 6279 5f6b  rted, index_by_k
-00010d80: 696e 645f 736f 7274 6564 203d 206f 7264  ind_sorted = ord
-00010d90: 6572 5f6f 665f 7265 6769 6f6e 7328 7465  er_of_regions(te
-00010da0: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745b  xtline_mask_tot[
-00010db0: 696e 7428 626f 7865 735b 6969 6a5d 5b32  int(boxes[iij][2
-00010dc0: 5d29 203a 2069 6e74 2862 6f78 6573 5b69  ]) : int(boxes[i
-00010dd0: 696a 5d5b 335d 292c 2069 6e74 2862 6f78  ij][3]), int(box
-00010de0: 6573 5b69 696a 5d5b 305d 2920 3a20 696e  es[iij][0]) : in
-00010df0: 7428 626f 7865 735b 6969 6a5d 5b31 5d29  t(boxes[iij][1])
-00010e00: 5d2c 2063 6f6e 5f69 6e74 6572 5f62 6f78  ], con_inter_box
-00010e10: 2c20 636f 6e5f 696e 7465 725f 626f 785f  , con_inter_box_
-00010e20: 682c 2062 6f78 6573 5b69 696a 5d5b 325d  h, boxes[iij][2]
-00010e30: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-00010e40: 2020 206f 7264 6572 5f6f 665f 7465 7874     order_of_text
-00010e50: 732c 2069 645f 6f66 5f74 6578 7473 203d  s, id_of_texts =
-00010e60: 206f 7264 6572 5f61 6e64 5f69 645f 6f66   order_and_id_of
-00010e70: 5f74 6578 7473 2863 6f6e 5f69 6e74 6572  _texts(con_inter
-00010e80: 5f62 6f78 2c20 636f 6e5f 696e 7465 725f  _box, con_inter_
-00010e90: 626f 785f 682c 206d 6174 7269 785f 6f66  box_h, matrix_of
-00010ea0: 5f6f 7264 6572 732c 2069 6e64 6578 6573  _orders, indexes
-00010eb0: 5f73 6f72 7465 642c 2069 6e64 6578 5f62  _sorted, index_b
-00010ec0: 795f 6b69 6e64 5f73 6f72 7465 642c 206b  y_kind_sorted, k
-00010ed0: 696e 645f 6f66 5f74 6578 7473 5f73 6f72  ind_of_texts_sor
-00010ee0: 7465 642c 2072 6566 5f70 6f69 6e74 290a  ted, ref_point).
-00010ef0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00010f00: 2069 6e64 6578 6573 5f73 6f72 7465 645f   indexes_sorted_
-00010f10: 6d61 696e 203d 206e 702e 6172 7261 7928  main = np.array(
-00010f20: 696e 6465 7865 735f 736f 7274 6564 295b  indexes_sorted)[
-00010f30: 6e70 2e61 7272 6179 286b 696e 645f 6f66  np.array(kind_of
-00010f40: 5f74 6578 7473 5f73 6f72 7465 6429 203d  _texts_sorted) =
-00010f50: 3d20 315d 0a20 2020 2020 2020 2020 2020  = 1].           
-00010f60: 2020 2020 2069 6e64 6578 6573 5f62 795f       indexes_by_
-00010f70: 7479 7065 5f6d 6169 6e20 3d20 6e70 2e61  type_main = np.a
-00010f80: 7272 6179 2869 6e64 6578 5f62 795f 6b69  rray(index_by_ki
-00010f90: 6e64 5f73 6f72 7465 6429 5b6e 702e 6172  nd_sorted)[np.ar
-00010fa0: 7261 7928 6b69 6e64 5f6f 665f 7465 7874  ray(kind_of_text
-00010fb0: 735f 736f 7274 6564 2920 3d3d 2031 5d0a  s_sorted) == 1].
-00010fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00010fd0: 696e 6465 7865 735f 736f 7274 6564 5f68  indexes_sorted_h
-00010fe0: 6561 6420 3d20 6e70 2e61 7272 6179 2869  ead = np.array(i
-00010ff0: 6e64 6578 6573 5f73 6f72 7465 6429 5b6e  ndexes_sorted)[n
-00011000: 702e 6172 7261 7928 6b69 6e64 5f6f 665f  p.array(kind_of_
-00011010: 7465 7874 735f 736f 7274 6564 2920 3d3d  texts_sorted) ==
-00011020: 2032 5d0a 2020 2020 2020 2020 2020 2020   2].            
-00011030: 2020 2020 696e 6465 7865 735f 6279 5f74      indexes_by_t
-00011040: 7970 655f 6865 6164 203d 206e 702e 6172  ype_head = np.ar
-00011050: 7261 7928 696e 6465 785f 6279 5f6b 696e  ray(index_by_kin
-00011060: 645f 736f 7274 6564 295b 6e70 2e61 7272  d_sorted)[np.arr
-00011070: 6179 286b 696e 645f 6f66 5f74 6578 7473  ay(kind_of_texts
-00011080: 5f73 6f72 7465 6429 203d 3d20 325d 0a0a  _sorted) == 2]..
-00011090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110a0: 666f 7220 7a61 686c 6572 2c20 5f20 696e  for zahler, _ in
-000110b0: 2065 6e75 6d65 7261 7465 2861 7267 735f   enumerate(args_
-000110c0: 636f 6e74 6f75 7273 5f62 6f78 293a 0a20  contours_box):. 
-000110d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000110e0: 2020 2061 7267 5f6f 7264 6572 5f76 203d     arg_order_v =
-000110f0: 2069 6e64 6578 6573 5f73 6f72 7465 645f   indexes_sorted_
-00011100: 6d61 696e 5b7a 6168 6c65 725d 0a20 2020  main[zahler].   
-00011110: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011120: 206f 7264 6572 5f62 795f 636f 6e5f 6d61   order_by_con_ma
-00011130: 696e 5b61 7267 735f 636f 6e74 6f75 7273  in[args_contours
-00011140: 5f62 6f78 5b69 6e64 6578 6573 5f62 795f  _box[indexes_by_
-00011150: 7479 7065 5f6d 6169 6e5b 7a61 686c 6572  type_main[zahler
-00011160: 5d5d 5d20 3d20 6e70 2e77 6865 7265 2869  ]]] = np.where(i
-00011170: 6e64 6578 6573 5f73 6f72 7465 6420 3d3d  ndexes_sorted ==
-00011180: 2061 7267 5f6f 7264 6572 5f76 295b 305d   arg_order_v)[0]
-00011190: 5b30 5d20 2b20 7265 665f 706f 696e 740a  [0] + ref_point.
-000111a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000111b0: 2066 6f72 207a 6168 6c65 722c 205f 2069   for zahler, _ i
-000111c0: 6e20 656e 756d 6572 6174 6528 6172 6773  n enumerate(args
-000111d0: 5f63 6f6e 746f 7572 735f 626f 785f 6829  _contours_box_h)
-000111e0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000111f0: 2020 2020 2020 6172 675f 6f72 6465 725f        arg_order_
-00011200: 7620 3d20 696e 6465 7865 735f 736f 7274  v = indexes_sort
-00011210: 6564 5f68 6561 645b 7a61 686c 6572 5d0a  ed_head[zahler].
-00011220: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011230: 2020 2020 6f72 6465 725f 6279 5f63 6f6e      order_by_con
-00011240: 5f68 6561 645b 6172 6773 5f63 6f6e 746f  _head[args_conto
-00011250: 7572 735f 626f 785f 685b 696e 6465 7865  urs_box_h[indexe
-00011260: 735f 6279 5f74 7970 655f 6865 6164 5b7a  s_by_type_head[z
-00011270: 6168 6c65 725d 5d5d 203d 206e 702e 7768  ahler]]] = np.wh
-00011280: 6572 6528 696e 6465 7865 735f 736f 7274  ere(indexes_sort
-00011290: 6564 203d 3d20 6172 675f 6f72 6465 725f  ed == arg_order_
-000112a0: 7629 5b30 5d5b 305d 202b 2072 6566 5f70  v)[0][0] + ref_p
-000112b0: 6f69 6e74 0a0a 2020 2020 2020 2020 2020  oint..          
-000112c0: 2020 2020 2020 666f 7220 6a6a 6920 696e        for jji in
-000112d0: 2072 616e 6765 286c 656e 2869 645f 6f66   range(len(id_of
-000112e0: 5f74 6578 7473 2929 3a0a 2020 2020 2020  _texts)):.      
-000112f0: 2020 2020 2020 2020 2020 2020 2020 6f72                or
-00011300: 6465 725f 6f66 5f74 6578 7473 5f74 6f74  der_of_texts_tot
-00011310: 2e61 7070 656e 6428 6f72 6465 725f 6f66  .append(order_of
-00011320: 5f74 6578 7473 5b6a 6a69 5d20 2b20 7265  _texts[jji] + re
-00011330: 665f 706f 696e 7429 0a20 2020 2020 2020  f_point).       
-00011340: 2020 2020 2020 2020 2020 2020 2069 645f               id_
-00011350: 6f66 5f74 6578 7473 5f74 6f74 2e61 7070  of_texts_tot.app
-00011360: 656e 6428 6964 5f6f 665f 7465 7874 735b  end(id_of_texts[
-00011370: 6a6a 695d 290a 2020 2020 2020 2020 2020  jji]).          
-00011380: 2020 2020 2020 7265 665f 706f 696e 7420        ref_point 
-00011390: 2b3d 206c 656e 2869 645f 6f66 5f74 6578  += len(id_of_tex
-000113a0: 7473 290a 0a20 2020 2020 2020 2020 2020  ts)..           
-000113b0: 206f 7264 6572 5f6f 665f 7465 7874 735f   order_of_texts_
-000113c0: 746f 7420 3d20 5b5d 0a20 2020 2020 2020  tot = [].       
-000113d0: 2020 2020 2066 6f72 2074 6a31 2069 6e20       for tj1 in 
-000113e0: 7261 6e67 6528 6c65 6e28 636f 6e74 6f75  range(len(contou
-000113f0: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
-00011400: 656e 7429 293a 0a20 2020 2020 2020 2020  ent)):.         
-00011410: 2020 2020 2020 206f 7264 6572 5f6f 665f         order_of_
-00011420: 7465 7874 735f 746f 742e 6170 7065 6e64  texts_tot.append
-00011430: 2869 6e74 286f 7264 6572 5f62 795f 636f  (int(order_by_co
-00011440: 6e5f 6d61 696e 5b74 6a31 5d29 290a 0a20  n_main[tj1])).. 
-00011450: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
-00011460: 6a31 2069 6e20 7261 6e67 6528 6c65 6e28  j1 in range(len(
-00011470: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
-00011480: 7874 5f70 6172 656e 745f 6829 293a 0a20  xt_parent_h)):. 
-00011490: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-000114a0: 7264 6572 5f6f 665f 7465 7874 735f 746f  rder_of_texts_to
-000114b0: 742e 6170 7065 6e64 2869 6e74 286f 7264  t.append(int(ord
-000114c0: 6572 5f62 795f 636f 6e5f 6865 6164 5b74  er_by_con_head[t
-000114d0: 6a31 5d29 290a 0a20 2020 2020 2020 2020  j1]))..         
-000114e0: 2020 206f 7264 6572 5f74 6578 745f 6e65     order_text_ne
-000114f0: 7720 3d20 5b5d 0a20 2020 2020 2020 2020  w = [].         
-00011500: 2020 2066 6f72 2069 6969 2069 6e20 7261     for iii in ra
-00011510: 6e67 6528 6c65 6e28 6f72 6465 725f 6f66  nge(len(order_of
-00011520: 5f74 6578 7473 5f74 6f74 2929 3a0a 2020  _texts_tot)):.  
-00011530: 2020 2020 2020 2020 2020 2020 2020 6f72                or
-00011540: 6465 725f 7465 7874 5f6e 6577 2e61 7070  der_text_new.app
-00011550: 656e 6428 6e70 2e77 6865 7265 286e 702e  end(np.where(np.
-00011560: 6172 7261 7928 6f72 6465 725f 6f66 5f74  array(order_of_t
-00011570: 6578 7473 5f74 6f74 2920 3d3d 2069 6969  exts_tot) == iii
-00011580: 295b 305d 5b30 5d29 0a0a 2020 2020 2020  )[0][0])..      
-00011590: 2020 6578 6365 7074 2045 7863 6570 7469    except Excepti
-000115a0: 6f6e 2061 7320 7768 793a 0a20 2020 2020  on as why:.     
-000115b0: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
-000115c0: 6572 2e65 7272 6f72 2877 6879 290a 2020  er.error(why).  
-000115d0: 2020 2020 2020 2020 2020 6172 675f 7465            arg_te
-000115e0: 7874 5f63 6f6e 203d 205b 5d0a 2020 2020  xt_con = [].    
-000115f0: 2020 2020 2020 2020 666f 7220 6969 2069          for ii i
-00011600: 6e20 7261 6e67 6528 6c65 6e28 6378 5f74  n range(len(cx_t
-00011610: 6578 745f 6f6e 6c79 2929 3a0a 2020 2020  ext_only)):.    
-00011620: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00011630: 6a6a 2069 6e20 7261 6e67 6528 6c65 6e28  jj in range(len(
-00011640: 626f 7865 7329 293a 0a20 2020 2020 2020  boxes)):.       
-00011650: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00011660: 6378 5f74 6578 745f 6f6e 6c79 5b69 695d  cx_text_only[ii]
-00011670: 203e 3d20 626f 7865 735b 6a6a 5d5b 305d   >= boxes[jj][0]
-00011680: 2061 6e64 2063 785f 7465 7874 5f6f 6e6c   and cx_text_onl
-00011690: 795b 6969 5d20 3c20 626f 7865 735b 6a6a  y[ii] < boxes[jj
-000116a0: 5d5b 315d 2061 6e64 2063 795f 7465 7874  ][1] and cy_text
-000116b0: 5f6f 6e6c 795b 6969 5d20 3e3d 2062 6f78  _only[ii] >= box
-000116c0: 6573 5b6a 6a5d 5b32 5d20 616e 6420 6379  es[jj][2] and cy
-000116d0: 5f74 6578 745f 6f6e 6c79 5b69 695d 203c  _text_only[ii] <
-000116e0: 2062 6f78 6573 5b6a 6a5d 5b33 5d3a 2020   boxes[jj][3]:  
-000116f0: 2320 7468 6973 2069 7320 7661 6c69 6420  # this is valid 
-00011700: 6966 2074 6865 2063 656e 7465 7220 6f66  if the center of
-00011710: 2072 6567 696f 6e20 6964 656e 7469 6679   region identify
-00011720: 2069 6e20 7768 6963 6820 626f 7820 6974   in which box it
-00011730: 2069 7320 6c6f 6361 7465 640a 2020 2020   is located.    
-00011740: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011750: 2020 2020 6172 675f 7465 7874 5f63 6f6e      arg_text_con
-00011760: 2e61 7070 656e 6428 6a6a 290a 2020 2020  .append(jj).    
-00011770: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011780: 2020 2020 6272 6561 6b0a 2020 2020 2020      break.      
-00011790: 2020 2020 2020 6172 6773 5f63 6f6e 746f        args_conto
-000117a0: 7572 7320 3d20 6e70 2e61 7272 6179 2872  urs = np.array(r
-000117b0: 616e 6765 286c 656e 2861 7267 5f74 6578  ange(len(arg_tex
-000117c0: 745f 636f 6e29 2929 0a0a 2020 2020 2020  t_con)))..      
-000117d0: 2020 2020 2020 6f72 6465 725f 6279 5f63        order_by_c
-000117e0: 6f6e 5f6d 6169 6e20 3d20 6e70 2e7a 6572  on_main = np.zer
-000117f0: 6f73 286c 656e 2861 7267 5f74 6578 745f  os(len(arg_text_
-00011800: 636f 6e29 290a 0a20 2020 2020 2020 2020  con))..         
-00011810: 2020 2023 2323 2323 2323 2323 2323 2323     #############
-00011820: 2323 2323 2323 2323 2323 2323 2323 2323  ################
-00011830: 2068 6561 640a 0a20 2020 2020 2020 2020   head..         
-00011840: 2020 2061 7267 5f74 6578 745f 636f 6e5f     arg_text_con_
-00011850: 6820 3d20 5b5d 0a20 2020 2020 2020 2020  h = [].         
-00011860: 2020 2066 6f72 2069 6920 696e 2072 616e     for ii in ran
-00011870: 6765 286c 656e 2863 785f 7465 7874 5f6f  ge(len(cx_text_o
-00011880: 6e6c 795f 6829 293a 0a20 2020 2020 2020  nly_h)):.       
-00011890: 2020 2020 2020 2020 2066 6f72 206a 6a20           for jj 
-000118a0: 696e 2072 616e 6765 286c 656e 2862 6f78  in range(len(box
-000118b0: 6573 2929 3a0a 2020 2020 2020 2020 2020  es)):.          
-000118c0: 2020 2020 2020 2020 2020 6966 2063 785f            if cx_
-000118d0: 7465 7874 5f6f 6e6c 795f 685b 6969 5d20  text_only_h[ii] 
-000118e0: 3e3d 2062 6f78 6573 5b6a 6a5d 5b30 5d20  >= boxes[jj][0] 
-000118f0: 616e 6420 6378 5f74 6578 745f 6f6e 6c79  and cx_text_only
-00011900: 5f68 5b69 695d 203c 2062 6f78 6573 5b6a  _h[ii] < boxes[j
-00011910: 6a5d 5b31 5d20 616e 6420 6379 5f74 6578  j][1] and cy_tex
-00011920: 745f 6f6e 6c79 5f68 5b69 695d 203e 3d20  t_only_h[ii] >= 
-00011930: 626f 7865 735b 6a6a 5d5b 325d 2061 6e64  boxes[jj][2] and
-00011940: 2063 795f 7465 7874 5f6f 6e6c 795f 685b   cy_text_only_h[
-00011950: 6969 5d20 3c20 626f 7865 735b 6a6a 5d5b  ii] < boxes[jj][
-00011960: 335d 3a20 2023 2074 6869 7320 6973 2076  3]:  # this is v
-00011970: 616c 6964 2069 6620 7468 6520 6365 6e74  alid if the cent
-00011980: 6572 206f 6620 7265 6769 6f6e 2069 6465  er of region ide
-00011990: 6e74 6966 7920 696e 2077 6869 6368 2062  ntify in which b
-000119a0: 6f78 2069 7420 6973 206c 6f63 6174 6564  ox it is located
-000119b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000119c0: 2020 2020 2020 2020 2061 7267 5f74 6578           arg_tex
-000119d0: 745f 636f 6e5f 682e 6170 7065 6e64 286a  t_con_h.append(j
-000119e0: 6a29 0a20 2020 2020 2020 2020 2020 2020  j).             
-000119f0: 2020 2020 2020 2020 2020 2062 7265 616b             break
-00011a00: 0a20 2020 2020 2020 2020 2020 2061 7267  .            arg
-00011a10: 735f 636f 6e74 6f75 7273 5f68 203d 206e  s_contours_h = n
-00011a20: 702e 6172 7261 7928 7261 6e67 6528 6c65  p.array(range(le
-00011a30: 6e28 6172 675f 7465 7874 5f63 6f6e 5f68  n(arg_text_con_h
-00011a40: 2929 290a 0a20 2020 2020 2020 2020 2020  )))..           
-00011a50: 206f 7264 6572 5f62 795f 636f 6e5f 6865   order_by_con_he
-00011a60: 6164 203d 206e 702e 7a65 726f 7328 6c65  ad = np.zeros(le
-00011a70: 6e28 6172 675f 7465 7874 5f63 6f6e 5f68  n(arg_text_con_h
-00011a80: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
-00011a90: 7265 665f 706f 696e 7420 3d20 300a 2020  ref_point = 0.  
-00011aa0: 2020 2020 2020 2020 2020 6f72 6465 725f            order_
-00011ab0: 6f66 5f74 6578 7473 5f74 6f74 203d 205b  of_texts_tot = [
-00011ac0: 5d0a 2020 2020 2020 2020 2020 2020 6964  ].            id
-00011ad0: 5f6f 665f 7465 7874 735f 746f 7420 3d20  _of_texts_tot = 
-00011ae0: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
-00011af0: 6f72 2069 696a 2c20 5f20 696e 2065 6e75  or iij, _ in enu
-00011b00: 6d65 7261 7465 2862 6f78 6573 293a 0a20  merate(boxes):. 
-00011b10: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-00011b20: 7267 735f 636f 6e74 6f75 7273 5f62 6f78  rgs_contours_box
-00011b30: 203d 2061 7267 735f 636f 6e74 6f75 7273   = args_contours
-00011b40: 5b6e 702e 6172 7261 7928 6172 675f 7465  [np.array(arg_te
-00011b50: 7874 5f63 6f6e 2920 3d3d 2069 696a 5d0a  xt_con) == iij].
-00011b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011b70: 6172 6773 5f63 6f6e 746f 7572 735f 626f  args_contours_bo
-00011b80: 785f 6820 3d20 6172 6773 5f63 6f6e 746f  x_h = args_conto
-00011b90: 7572 735f 685b 6e70 2e61 7272 6179 2861  urs_h[np.array(a
-00011ba0: 7267 5f74 6578 745f 636f 6e5f 6829 203d  rg_text_con_h) =
-00011bb0: 3d20 6969 6a5d 0a20 2020 2020 2020 2020  = iij].         
-00011bc0: 2020 2020 2020 2063 6f6e 5f69 6e74 6572         con_inter
-00011bd0: 5f62 6f78 203d 205b 5d0a 2020 2020 2020  _box = [].      
-00011be0: 2020 2020 2020 2020 2020 636f 6e5f 696e            con_in
-00011bf0: 7465 725f 626f 785f 6820 3d20 5b5d 0a0a  ter_box_h = []..
-00011c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c10: 666f 7220 626f 7820 696e 2061 7267 735f  for box in args_
-00011c20: 636f 6e74 6f75 7273 5f62 6f78 3a0a 2020  contours_box:.  
-00011c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00011c40: 2020 636f 6e5f 696e 7465 725f 626f 782e    con_inter_box.
-00011c50: 6170 7065 6e64 2863 6f6e 746f 7572 735f  append(contours_
-00011c60: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
-00011c70: 5b62 6f78 5d29 0a0a 2020 2020 2020 2020  [box])..        
-00011c80: 2020 2020 2020 2020 666f 7220 626f 7820          for box 
-00011c90: 696e 2061 7267 735f 636f 6e74 6f75 7273  in args_contours
-00011ca0: 5f62 6f78 5f68 3a0a 2020 2020 2020 2020  _box_h:.        
-00011cb0: 2020 2020 2020 2020 2020 2020 636f 6e5f              con_
-00011cc0: 696e 7465 725f 626f 785f 682e 6170 7065  inter_box_h.appe
-00011cd0: 6e64 2863 6f6e 746f 7572 735f 6f6e 6c79  nd(contours_only
-00011ce0: 5f74 6578 745f 7061 7265 6e74 5f68 5b62  _text_parent_h[b
-00011cf0: 6f78 5d29 0a0a 2020 2020 2020 2020 2020  ox])..          
-00011d00: 2020 2020 2020 696e 6465 7865 735f 736f        indexes_so
-00011d10: 7274 6564 2c20 6d61 7472 6978 5f6f 665f  rted, matrix_of_
-00011d20: 6f72 6465 7273 2c20 6b69 6e64 5f6f 665f  orders, kind_of_
-00011d30: 7465 7874 735f 736f 7274 6564 2c20 696e  texts_sorted, in
-00011d40: 6465 785f 6279 5f6b 696e 645f 736f 7274  dex_by_kind_sort
-00011d50: 6564 203d 206f 7264 6572 5f6f 665f 7265  ed = order_of_re
-00011d60: 6769 6f6e 7328 7465 7874 6c69 6e65 5f6d  gions(textline_m
-00011d70: 6173 6b5f 746f 745b 696e 7428 626f 7865  ask_tot[int(boxe
-00011d80: 735b 6969 6a5d 5b32 5d29 203a 2069 6e74  s[iij][2]) : int
-00011d90: 2862 6f78 6573 5b69 696a 5d5b 335d 292c  (boxes[iij][3]),
-00011da0: 2069 6e74 2862 6f78 6573 5b69 696a 5d5b   int(boxes[iij][
-00011db0: 305d 2920 3a20 696e 7428 626f 7865 735b  0]) : int(boxes[
-00011dc0: 6969 6a5d 5b31 5d29 5d2c 2063 6f6e 5f69  iij][1])], con_i
-00011dd0: 6e74 6572 5f62 6f78 2c20 636f 6e5f 696e  nter_box, con_in
-00011de0: 7465 725f 626f 785f 682c 2062 6f78 6573  ter_box_h, boxes
-00011df0: 5b69 696a 5d5b 325d 290a 0a20 2020 2020  [iij][2])..     
-00011e00: 2020 2020 2020 2020 2020 206f 7264 6572             order
-00011e10: 5f6f 665f 7465 7874 732c 2069 645f 6f66  _of_texts, id_of
-00011e20: 5f74 6578 7473 203d 206f 7264 6572 5f61  _texts = order_a
-00011e30: 6e64 5f69 645f 6f66 5f74 6578 7473 2863  nd_id_of_texts(c
-00011e40: 6f6e 5f69 6e74 6572 5f62 6f78 2c20 636f  on_inter_box, co
-00011e50: 6e5f 696e 7465 725f 626f 785f 682c 206d  n_inter_box_h, m
-00011e60: 6174 7269 785f 6f66 5f6f 7264 6572 732c  atrix_of_orders,
-00011e70: 2069 6e64 6578 6573 5f73 6f72 7465 642c   indexes_sorted,
-00011e80: 2069 6e64 6578 5f62 795f 6b69 6e64 5f73   index_by_kind_s
-00011e90: 6f72 7465 642c 206b 696e 645f 6f66 5f74  orted, kind_of_t
-00011ea0: 6578 7473 5f73 6f72 7465 642c 2072 6566  exts_sorted, ref
-00011eb0: 5f70 6f69 6e74 290a 0a20 2020 2020 2020  _point)..       
-00011ec0: 2020 2020 2020 2020 2069 6e64 6578 6573           indexes
-00011ed0: 5f73 6f72 7465 645f 6d61 696e 203d 206e  _sorted_main = n
-00011ee0: 702e 6172 7261 7928 696e 6465 7865 735f  p.array(indexes_
-00011ef0: 736f 7274 6564 295b 6e70 2e61 7272 6179  sorted)[np.array
-00011f00: 286b 696e 645f 6f66 5f74 6578 7473 5f73  (kind_of_texts_s
-00011f10: 6f72 7465 6429 203d 3d20 315d 0a20 2020  orted) == 1].   
-00011f20: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
-00011f30: 6578 6573 5f62 795f 7479 7065 5f6d 6169  exes_by_type_mai
-00011f40: 6e20 3d20 6e70 2e61 7272 6179 2869 6e64  n = np.array(ind
-00011f50: 6578 5f62 795f 6b69 6e64 5f73 6f72 7465  ex_by_kind_sorte
-00011f60: 6429 5b6e 702e 6172 7261 7928 6b69 6e64  d)[np.array(kind
-00011f70: 5f6f 665f 7465 7874 735f 736f 7274 6564  _of_texts_sorted
-00011f80: 2920 3d3d 2031 5d0a 2020 2020 2020 2020  ) == 1].        
-00011f90: 2020 2020 2020 2020 696e 6465 7865 735f          indexes_
-00011fa0: 736f 7274 6564 5f68 6561 6420 3d20 6e70  sorted_head = np
-00011fb0: 2e61 7272 6179 2869 6e64 6578 6573 5f73  .array(indexes_s
-00011fc0: 6f72 7465 6429 5b6e 702e 6172 7261 7928  orted)[np.array(
-00011fd0: 6b69 6e64 5f6f 665f 7465 7874 735f 736f  kind_of_texts_so
-00011fe0: 7274 6564 2920 3d3d 2032 5d0a 2020 2020  rted) == 2].    
-00011ff0: 2020 2020 2020 2020 2020 2020 696e 6465              inde
-00012000: 7865 735f 6279 5f74 7970 655f 6865 6164  xes_by_type_head
-00012010: 203d 206e 702e 6172 7261 7928 696e 6465   = np.array(inde
-00012020: 785f 6279 5f6b 696e 645f 736f 7274 6564  x_by_kind_sorted
-00012030: 295b 6e70 2e61 7272 6179 286b 696e 645f  )[np.array(kind_
-00012040: 6f66 5f74 6578 7473 5f73 6f72 7465 6429  of_texts_sorted)
-00012050: 203d 3d20 325d 0a0a 2020 2020 2020 2020   == 2]..        
-00012060: 2020 2020 2020 2020 666f 7220 7a61 686c          for zahl
-00012070: 6572 2c20 5f20 696e 2065 6e75 6d65 7261  er, _ in enumera
-00012080: 7465 2861 7267 735f 636f 6e74 6f75 7273  te(args_contours
-00012090: 5f62 6f78 293a 0a20 2020 2020 2020 2020  _box):.         
-000120a0: 2020 2020 2020 2020 2020 2061 7267 5f6f             arg_o
-000120b0: 7264 6572 5f76 203d 2069 6e64 6578 6573  rder_v = indexes
-000120c0: 5f73 6f72 7465 645f 6d61 696e 5b7a 6168  _sorted_main[zah
-000120d0: 6c65 725d 0a20 2020 2020 2020 2020 2020  ler].           
-000120e0: 2020 2020 2020 2020 206f 7264 6572 5f62           order_b
-000120f0: 795f 636f 6e5f 6d61 696e 5b61 7267 735f  y_con_main[args_
-00012100: 636f 6e74 6f75 7273 5f62 6f78 5b69 6e64  contours_box[ind
-00012110: 6578 6573 5f62 795f 7479 7065 5f6d 6169  exes_by_type_mai
-00012120: 6e5b 7a61 686c 6572 5d5d 5d20 3d20 6e70  n[zahler]]] = np
-00012130: 2e77 6865 7265 2869 6e64 6578 6573 5f73  .where(indexes_s
-00012140: 6f72 7465 6420 3d3d 2061 7267 5f6f 7264  orted == arg_ord
-00012150: 6572 5f76 295b 305d 5b30 5d20 2b20 7265  er_v)[0][0] + re
-00012160: 665f 706f 696e 740a 0a20 2020 2020 2020  f_point..       
-00012170: 2020 2020 2020 2020 2066 6f72 207a 6168           for zah
-00012180: 6c65 722c 205f 2069 6e20 656e 756d 6572  ler, _ in enumer
-00012190: 6174 6528 6172 6773 5f63 6f6e 746f 7572  ate(args_contour
-000121a0: 735f 626f 785f 6829 3a0a 2020 2020 2020  s_box_h):.      
-000121b0: 2020 2020 2020 2020 2020 2020 2020 6172                ar
-000121c0: 675f 6f72 6465 725f 7620 3d20 696e 6465  g_order_v = inde
-000121d0: 7865 735f 736f 7274 6564 5f68 6561 645b  xes_sorted_head[
-000121e0: 7a61 686c 6572 5d0a 2020 2020 2020 2020  zahler].        
-000121f0: 2020 2020 2020 2020 2020 2020 6f72 6465              orde
-00012200: 725f 6279 5f63 6f6e 5f68 6561 645b 6172  r_by_con_head[ar
-00012210: 6773 5f63 6f6e 746f 7572 735f 626f 785f  gs_contours_box_
-00012220: 685b 696e 6465 7865 735f 6279 5f74 7970  h[indexes_by_typ
-00012230: 655f 6865 6164 5b7a 6168 6c65 725d 5d5d  e_head[zahler]]]
-00012240: 203d 206e 702e 7768 6572 6528 696e 6465   = np.where(inde
-00012250: 7865 735f 736f 7274 6564 203d 3d20 6172  xes_sorted == ar
-00012260: 675f 6f72 6465 725f 7629 5b30 5d5b 305d  g_order_v)[0][0]
-00012270: 202b 2072 6566 5f70 6f69 6e74 0a0a 2020   + ref_point..  
-00012280: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00012290: 7220 6a6a 692c 205f 2069 6e20 656e 756d  r jji, _ in enum
-000122a0: 6572 6174 6528 6964 5f6f 665f 7465 7874  erate(id_of_text
-000122b0: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
-000122c0: 2020 2020 2020 2020 6f72 6465 725f 6f66          order_of
-000122d0: 5f74 6578 7473 5f74 6f74 2e61 7070 656e  _texts_tot.appen
-000122e0: 6428 6f72 6465 725f 6f66 5f74 6578 7473  d(order_of_texts
-000122f0: 5b6a 6a69 5d20 2b20 7265 665f 706f 696e  [jji] + ref_poin
-00012300: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
-00012310: 2020 2020 2020 2069 645f 6f66 5f74 6578         id_of_tex
-00012320: 7473 5f74 6f74 2e61 7070 656e 6428 6964  ts_tot.append(id
-00012330: 5f6f 665f 7465 7874 735b 6a6a 695d 290a  _of_texts[jji]).
-00012340: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012350: 7265 665f 706f 696e 7420 2b3d 206c 656e  ref_point += len
-00012360: 2869 645f 6f66 5f74 6578 7473 290a 0a20  (id_of_texts).. 
-00012370: 2020 2020 2020 2020 2020 206f 7264 6572             order
-00012380: 5f6f 665f 7465 7874 735f 746f 7420 3d20  _of_texts_tot = 
-00012390: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
-000123a0: 6f72 2074 6a31 2069 6e20 7261 6e67 6528  or tj1 in range(
-000123b0: 6c65 6e28 636f 6e74 6f75 7273 5f6f 6e6c  len(contours_onl
-000123c0: 795f 7465 7874 5f70 6172 656e 7429 293a  y_text_parent)):
-000123d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000123e0: 206f 7264 6572 5f6f 665f 7465 7874 735f   order_of_texts_
-000123f0: 746f 742e 6170 7065 6e64 2869 6e74 286f  tot.append(int(o
-00012400: 7264 6572 5f62 795f 636f 6e5f 6d61 696e  rder_by_con_main
-00012410: 5b74 6a31 5d29 290a 0a20 2020 2020 2020  [tj1]))..       
-00012420: 2020 2020 2066 6f72 2074 6a31 2069 6e20       for tj1 in 
-00012430: 7261 6e67 6528 6c65 6e28 636f 6e74 6f75  range(len(contou
-00012440: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
-00012450: 656e 745f 6829 293a 0a20 2020 2020 2020  ent_h)):.       
-00012460: 2020 2020 2020 2020 206f 7264 6572 5f6f           order_o
-00012470: 665f 7465 7874 735f 746f 742e 6170 7065  f_texts_tot.appe
-00012480: 6e64 2869 6e74 286f 7264 6572 5f62 795f  nd(int(order_by_
-00012490: 636f 6e5f 6865 6164 5b74 6a31 5d29 290a  con_head[tj1])).
-000124a0: 0a20 2020 2020 2020 2020 2020 206f 7264  .            ord
-000124b0: 6572 5f74 6578 745f 6e65 7720 3d20 5b5d  er_text_new = []
-000124c0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-000124d0: 2069 6969 2069 6e20 7261 6e67 6528 6c65   iii in range(le
-000124e0: 6e28 6f72 6465 725f 6f66 5f74 6578 7473  n(order_of_texts
-000124f0: 5f74 6f74 2929 3a0a 2020 2020 2020 2020  _tot)):.        
-00012500: 2020 2020 2020 2020 6f72 6465 725f 7465          order_te
-00012510: 7874 5f6e 6577 2e61 7070 656e 6428 6e70  xt_new.append(np
-00012520: 2e77 6865 7265 286e 702e 6172 7261 7928  .where(np.array(
-00012530: 6f72 6465 725f 6f66 5f74 6578 7473 5f74  order_of_texts_t
-00012540: 6f74 2920 3d3d 2069 6969 295b 305d 5b30  ot) == iii)[0][0
-00012550: 5d29 0a20 2020 2020 2020 2072 6574 7572  ]).        retur
-00012560: 6e20 6f72 6465 725f 7465 7874 5f6e 6577  n order_text_new
-00012570: 2c20 6964 5f6f 665f 7465 7874 735f 746f  , id_of_texts_to
-00012580: 740a 0a20 2020 2064 6566 2064 6f5f 6f72  t..    def do_or
-00012590: 6465 725f 6f66 5f72 6567 696f 6e73 5f6e  der_of_regions_n
-000125a0: 6f5f 6675 6c6c 5f6c 6179 6f75 7428 7365  o_full_layout(se
-000125b0: 6c66 2c20 636f 6e74 6f75 7273 5f6f 6e6c  lf, contours_onl
-000125c0: 795f 7465 7874 5f70 6172 656e 742c 2063  y_text_parent, c
-000125d0: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
-000125e0: 745f 7061 7265 6e74 5f68 2c20 626f 7865  t_parent_h, boxe
-000125f0: 732c 2074 6578 746c 696e 655f 6d61 736b  s, textline_mask
-00012600: 5f74 6f74 293a 0a20 2020 2020 2020 2073  _tot):.        s
-00012610: 656c 662e 6c6f 6767 6572 2e64 6562 7567  elf.logger.debug
-00012620: 2822 656e 7465 7220 646f 5f6f 7264 6572  ("enter do_order
-00012630: 5f6f 665f 7265 6769 6f6e 735f 6e6f 5f66  _of_regions_no_f
-00012640: 756c 6c5f 6c61 796f 7574 2229 0a20 2020  ull_layout").   
-00012650: 2020 2020 2063 785f 7465 7874 5f6f 6e6c       cx_text_onl
-00012660: 792c 2063 795f 7465 7874 5f6f 6e6c 792c  y, cy_text_only,
-00012670: 2078 5f6d 696e 5f74 6578 745f 6f6e 6c79   x_min_text_only
-00012680: 2c20 5f2c 205f 2c20 5f2c 2079 5f63 6f72  , _, _, _, y_cor
-00012690: 5f78 5f6d 696e 5f6d 6169 6e20 3d20 6669  _x_min_main = fi
-000126a0: 6e64 5f6e 6577 5f66 6561 7475 7265 735f  nd_new_features_
-000126b0: 6f66 5f63 6f6e 746f 7572 7328 636f 6e74  of_contours(cont
-000126c0: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
-000126d0: 6172 656e 7429 0a0a 2020 2020 2020 2020  arent)..        
-000126e0: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-000126f0: 2061 7267 5f74 6578 745f 636f 6e20 3d20   arg_text_con = 
-00012700: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
-00012710: 6f72 2069 6920 696e 2072 616e 6765 286c  or ii in range(l
-00012720: 656e 2863 785f 7465 7874 5f6f 6e6c 7929  en(cx_text_only)
-00012730: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00012740: 2020 2066 6f72 206a 6a20 696e 2072 616e     for jj in ran
-00012750: 6765 286c 656e 2862 6f78 6573 2929 3a0a  ge(len(boxes)):.
-00012760: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00012770: 2020 2020 6966 2028 785f 6d69 6e5f 7465      if (x_min_te
-00012780: 7874 5f6f 6e6c 795b 6969 5d20 2b20 3830  xt_only[ii] + 80
-00012790: 2920 3e3d 2062 6f78 6573 5b6a 6a5d 5b30  ) >= boxes[jj][0
-000127a0: 5d20 616e 6420 2878 5f6d 696e 5f74 6578  ] and (x_min_tex
-000127b0: 745f 6f6e 6c79 5b69 695d 202b 2038 3029  t_only[ii] + 80)
-000127c0: 203c 2062 6f78 6573 5b6a 6a5d 5b31 5d20   < boxes[jj][1] 
-000127d0: 616e 6420 795f 636f 725f 785f 6d69 6e5f  and y_cor_x_min_
-000127e0: 6d61 696e 5b69 695d 203e 3d20 626f 7865  main[ii] >= boxe
-000127f0: 735b 6a6a 5d5b 325d 2061 6e64 2079 5f63  s[jj][2] and y_c
-00012800: 6f72 5f78 5f6d 696e 5f6d 6169 6e5b 6969  or_x_min_main[ii
-00012810: 5d20 3c20 626f 7865 735b 6a6a 5d5b 335d  ] < boxes[jj][3]
-00012820: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00012830: 2020 2020 2020 2020 2020 6172 675f 7465            arg_te
-00012840: 7874 5f63 6f6e 2e61 7070 656e 6428 6a6a  xt_con.append(jj
-00012850: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00012860: 2020 2020 2020 2020 2020 6272 6561 6b0a            break.
-00012870: 2020 2020 2020 2020 2020 2020 6172 6773              args
-00012880: 5f63 6f6e 746f 7572 7320 3d20 6e70 2e61  _contours = np.a
-00012890: 7272 6179 2872 616e 6765 286c 656e 2861  rray(range(len(a
-000128a0: 7267 5f74 6578 745f 636f 6e29 2929 0a20  rg_text_con))). 
-000128b0: 2020 2020 2020 2020 2020 206f 7264 6572             order
-000128c0: 5f62 795f 636f 6e5f 6d61 696e 203d 206e  _by_con_main = n
-000128d0: 702e 7a65 726f 7328 6c65 6e28 6172 675f  p.zeros(len(arg_
-000128e0: 7465 7874 5f63 6f6e 2929 0a0a 2020 2020  text_con))..    
-000128f0: 2020 2020 2020 2020 7265 665f 706f 696e          ref_poin
-00012900: 7420 3d20 300a 2020 2020 2020 2020 2020  t = 0.          
-00012910: 2020 6f72 6465 725f 6f66 5f74 6578 7473    order_of_texts
-00012920: 5f74 6f74 203d 205b 5d0a 2020 2020 2020  _tot = [].      
-00012930: 2020 2020 2020 6964 5f6f 665f 7465 7874        id_of_text
-00012940: 735f 746f 7420 3d20 5b5d 0a20 2020 2020  s_tot = [].     
-00012950: 2020 2020 2020 2066 6f72 2069 696a 2069         for iij i
-00012960: 6e20 7261 6e67 6528 6c65 6e28 626f 7865  n range(len(boxe
-00012970: 7329 293a 0a20 2020 2020 2020 2020 2020  s)):.           
-00012980: 2020 2020 2061 7267 735f 636f 6e74 6f75       args_contou
-00012990: 7273 5f62 6f78 203d 2061 7267 735f 636f  rs_box = args_co
-000129a0: 6e74 6f75 7273 5b6e 702e 6172 7261 7928  ntours[np.array(
-000129b0: 6172 675f 7465 7874 5f63 6f6e 2920 3d3d  arg_text_con) ==
-000129c0: 2069 696a 5d0a 2020 2020 2020 2020 2020   iij].          
-000129d0: 2020 2020 2020 636f 6e5f 696e 7465 725f        con_inter_
-000129e0: 626f 7820 3d20 5b5d 0a20 2020 2020 2020  box = [].       
-000129f0: 2020 2020 2020 2020 2063 6f6e 5f69 6e74           con_int
-00012a00: 6572 5f62 6f78 5f68 203d 205b 5d0a 2020  er_box_h = [].  
-00012a10: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00012a20: 7220 6920 696e 2072 616e 6765 286c 656e  r i in range(len
-00012a30: 2861 7267 735f 636f 6e74 6f75 7273 5f62  (args_contours_b
-00012a40: 6f78 2929 3a0a 2020 2020 2020 2020 2020  ox)):.          
-00012a50: 2020 2020 2020 2020 2020 636f 6e5f 696e            con_in
-00012a60: 7465 725f 626f 782e 6170 7065 6e64 2863  ter_box.append(c
-00012a70: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
-00012a80: 745f 7061 7265 6e74 5b61 7267 735f 636f  t_parent[args_co
-00012a90: 6e74 6f75 7273 5f62 6f78 5b69 5d5d 290a  ntours_box[i]]).
-00012aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012ab0: 2069 6e64 6578 6573 5f73 6f72 7465 642c   indexes_sorted,
-00012ac0: 206d 6174 7269 785f 6f66 5f6f 7264 6572   matrix_of_order
-00012ad0: 732c 206b 696e 645f 6f66 5f74 6578 7473  s, kind_of_texts
-00012ae0: 5f73 6f72 7465 642c 2069 6e64 6578 5f62  _sorted, index_b
-00012af0: 795f 6b69 6e64 5f73 6f72 7465 6420 3d20  y_kind_sorted = 
-00012b00: 6f72 6465 725f 6f66 5f72 6567 696f 6e73  order_of_regions
-00012b10: 2874 6578 746c 696e 655f 6d61 736b 5f74  (textline_mask_t
-00012b20: 6f74 5b69 6e74 2862 6f78 6573 5b69 696a  ot[int(boxes[iij
-00012b30: 5d5b 325d 2920 3a20 696e 7428 626f 7865  ][2]) : int(boxe
-00012b40: 735b 6969 6a5d 5b33 5d29 2c20 696e 7428  s[iij][3]), int(
-00012b50: 626f 7865 735b 6969 6a5d 5b30 5d29 203a  boxes[iij][0]) :
-00012b60: 2069 6e74 2862 6f78 6573 5b69 696a 5d5b   int(boxes[iij][
-00012b70: 315d 295d 2c20 636f 6e5f 696e 7465 725f  1])], con_inter_
-00012b80: 626f 782c 2063 6f6e 5f69 6e74 6572 5f62  box, con_inter_b
-00012b90: 6f78 5f68 2c20 626f 7865 735b 6969 6a5d  ox_h, boxes[iij]
-00012ba0: 5b32 5d29 0a0a 2020 2020 2020 2020 2020  [2])..          
-00012bb0: 2020 2020 2020 6f72 6465 725f 6f66 5f74        order_of_t
-00012bc0: 6578 7473 2c20 6964 5f6f 665f 7465 7874  exts, id_of_text
-00012bd0: 7320 3d20 6f72 6465 725f 616e 645f 6964  s = order_and_id
-00012be0: 5f6f 665f 7465 7874 7328 636f 6e5f 696e  _of_texts(con_in
-00012bf0: 7465 725f 626f 782c 2063 6f6e 5f69 6e74  ter_box, con_int
-00012c00: 6572 5f62 6f78 5f68 2c20 6d61 7472 6978  er_box_h, matrix
-00012c10: 5f6f 665f 6f72 6465 7273 2c20 696e 6465  _of_orders, inde
-00012c20: 7865 735f 736f 7274 6564 2c20 696e 6465  xes_sorted, inde
-00012c30: 785f 6279 5f6b 696e 645f 736f 7274 6564  x_by_kind_sorted
-00012c40: 2c20 6b69 6e64 5f6f 665f 7465 7874 735f  , kind_of_texts_
-00012c50: 736f 7274 6564 2c20 7265 665f 706f 696e  sorted, ref_poin
-00012c60: 7429 0a0a 2020 2020 2020 2020 2020 2020  t)..            
-00012c70: 2020 2020 696e 6465 7865 735f 736f 7274      indexes_sort
-00012c80: 6564 5f6d 6169 6e20 3d20 6e70 2e61 7272  ed_main = np.arr
-00012c90: 6179 2869 6e64 6578 6573 5f73 6f72 7465  ay(indexes_sorte
-00012ca0: 6429 5b6e 702e 6172 7261 7928 6b69 6e64  d)[np.array(kind
-00012cb0: 5f6f 665f 7465 7874 735f 736f 7274 6564  _of_texts_sorted
-00012cc0: 2920 3d3d 2031 5d0a 2020 2020 2020 2020  ) == 1].        
-00012cd0: 2020 2020 2020 2020 696e 6465 7865 735f          indexes_
-00012ce0: 6279 5f74 7970 655f 6d61 696e 203d 206e  by_type_main = n
-00012cf0: 702e 6172 7261 7928 696e 6465 785f 6279  p.array(index_by
-00012d00: 5f6b 696e 645f 736f 7274 6564 295b 6e70  _kind_sorted)[np
-00012d10: 2e61 7272 6179 286b 696e 645f 6f66 5f74  .array(kind_of_t
-00012d20: 6578 7473 5f73 6f72 7465 6429 203d 3d20  exts_sorted) == 
-00012d30: 315d 0a0a 2020 2020 2020 2020 2020 2020  1]..            
-00012d40: 2020 2020 666f 7220 7a61 686c 6572 2c20      for zahler, 
-00012d50: 5f20 696e 2065 6e75 6d65 7261 7465 2861  _ in enumerate(a
-00012d60: 7267 735f 636f 6e74 6f75 7273 5f62 6f78  rgs_contours_box
-00012d70: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00012d80: 2020 2020 2020 2061 7267 5f6f 7264 6572         arg_order
-00012d90: 5f76 203d 2069 6e64 6578 6573 5f73 6f72  _v = indexes_sor
-00012da0: 7465 645f 6d61 696e 5b7a 6168 6c65 725d  ted_main[zahler]
-00012db0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00012dc0: 2020 2020 206f 7264 6572 5f62 795f 636f       order_by_co
-00012dd0: 6e5f 6d61 696e 5b61 7267 735f 636f 6e74  n_main[args_cont
-00012de0: 6f75 7273 5f62 6f78 5b69 6e64 6578 6573  ours_box[indexes
-00012df0: 5f62 795f 7479 7065 5f6d 6169 6e5b 7a61  _by_type_main[za
-00012e00: 686c 6572 5d5d 5d20 3d20 6e70 2e77 6865  hler]]] = np.whe
-00012e10: 7265 2869 6e64 6578 6573 5f73 6f72 7465  re(indexes_sorte
-00012e20: 6420 3d3d 2061 7267 5f6f 7264 6572 5f76  d == arg_order_v
-00012e30: 295b 305d 5b30 5d20 2b20 7265 665f 706f  )[0][0] + ref_po
-00012e40: 696e 740a 0a20 2020 2020 2020 2020 2020  int..           
-00012e50: 2020 2020 2066 6f72 206a 6a69 2c20 5f20       for jji, _ 
-00012e60: 696e 2065 6e75 6d65 7261 7465 2869 645f  in enumerate(id_
-00012e70: 6f66 5f74 6578 7473 293a 0a20 2020 2020  of_texts):.     
-00012e80: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00012e90: 7264 6572 5f6f 665f 7465 7874 735f 746f  rder_of_texts_to
-00012ea0: 742e 6170 7065 6e64 286f 7264 6572 5f6f  t.append(order_o
-00012eb0: 665f 7465 7874 735b 6a6a 695d 202b 2072  f_texts[jji] + r
-00012ec0: 6566 5f70 6f69 6e74 290a 2020 2020 2020  ef_point).      
-00012ed0: 2020 2020 2020 2020 2020 2020 2020 6964                id
-00012ee0: 5f6f 665f 7465 7874 735f 746f 742e 6170  _of_texts_tot.ap
-00012ef0: 7065 6e64 2869 645f 6f66 5f74 6578 7473  pend(id_of_texts
-00012f00: 5b6a 6a69 5d29 0a20 2020 2020 2020 2020  [jji]).         
-00012f10: 2020 2020 2020 2072 6566 5f70 6f69 6e74         ref_point
-00012f20: 202b 3d20 6c65 6e28 6964 5f6f 665f 7465   += len(id_of_te
-00012f30: 7874 7329 0a0a 2020 2020 2020 2020 2020  xts)..          
-00012f40: 2020 6f72 6465 725f 6f66 5f74 6578 7473    order_of_texts
-00012f50: 5f74 6f74 203d 205b 5d0a 2020 2020 2020  _tot = [].      
-00012f60: 2020 2020 2020 666f 7220 746a 3120 696e        for tj1 in
-00012f70: 2072 616e 6765 286c 656e 2863 6f6e 746f   range(len(conto
-00012f80: 7572 735f 6f6e 6c79 5f74 6578 745f 7061  urs_only_text_pa
-00012f90: 7265 6e74 2929 3a0a 2020 2020 2020 2020  rent)):.        
-00012fa0: 2020 2020 2020 2020 6f72 6465 725f 6f66          order_of
-00012fb0: 5f74 6578 7473 5f74 6f74 2e61 7070 656e  _texts_tot.appen
-00012fc0: 6428 696e 7428 6f72 6465 725f 6279 5f63  d(int(order_by_c
-00012fd0: 6f6e 5f6d 6169 6e5b 746a 315d 2929 0a0a  on_main[tj1]))..
-00012fe0: 2020 2020 2020 2020 2020 2020 6f72 6465              orde
-00012ff0: 725f 7465 7874 5f6e 6577 203d 205b 5d0a  r_text_new = [].
-00013000: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-00013010: 6969 6920 696e 2072 616e 6765 286c 656e  iii in range(len
-00013020: 286f 7264 6572 5f6f 665f 7465 7874 735f  (order_of_texts_
-00013030: 746f 7429 293a 0a20 2020 2020 2020 2020  tot)):.         
-00013040: 2020 2020 2020 206f 7264 6572 5f74 6578         order_tex
-00013050: 745f 6e65 772e 6170 7065 6e64 286e 702e  t_new.append(np.
-00013060: 7768 6572 6528 6e70 2e61 7272 6179 286f  where(np.array(o
-00013070: 7264 6572 5f6f 665f 7465 7874 735f 746f  rder_of_texts_to
-00013080: 7429 203d 3d20 6969 6929 5b30 5d5b 305d  t) == iii)[0][0]
-00013090: 290a 2020 2020 2020 2020 0a20 2020 2020  ).        .     
-000130a0: 2020 2065 7863 6570 7420 4578 6365 7074     except Except
-000130b0: 696f 6e20 6173 2077 6879 3a0a 2020 2020  ion as why:.    
-000130c0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-000130d0: 6765 722e 6572 726f 7228 7768 7929 0a20  ger.error(why). 
-000130e0: 2020 2020 2020 2020 2020 2061 7267 5f74             arg_t
-000130f0: 6578 745f 636f 6e20 3d20 5b5d 0a20 2020  ext_con = [].   
-00013100: 2020 2020 2020 2020 2066 6f72 2069 6920           for ii 
-00013110: 696e 2072 616e 6765 286c 656e 2863 785f  in range(len(cx_
-00013120: 7465 7874 5f6f 6e6c 7929 293a 0a20 2020  text_only)):.   
-00013130: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00013140: 206a 6a20 696e 2072 616e 6765 286c 656e   jj in range(len
-00013150: 2862 6f78 6573 2929 3a0a 2020 2020 2020  (boxes)):.      
-00013160: 2020 2020 2020 2020 2020 2020 2020 6966                if
-00013170: 2063 785f 7465 7874 5f6f 6e6c 795b 6969   cx_text_only[ii
-00013180: 5d20 3e3d 2062 6f78 6573 5b6a 6a5d 5b30  ] >= boxes[jj][0
-00013190: 5d20 616e 6420 6378 5f74 6578 745f 6f6e  ] and cx_text_on
-000131a0: 6c79 5b69 695d 203c 2062 6f78 6573 5b6a  ly[ii] < boxes[j
-000131b0: 6a5d 5b31 5d20 616e 6420 6379 5f74 6578  j][1] and cy_tex
-000131c0: 745f 6f6e 6c79 5b69 695d 203e 3d20 626f  t_only[ii] >= bo
-000131d0: 7865 735b 6a6a 5d5b 325d 2061 6e64 2063  xes[jj][2] and c
-000131e0: 795f 7465 7874 5f6f 6e6c 795b 6969 5d20  y_text_only[ii] 
-000131f0: 3c20 626f 7865 735b 6a6a 5d5b 335d 3a20  < boxes[jj][3]: 
-00013200: 2023 2074 6869 7320 6973 2076 616c 6964   # this is valid
-00013210: 2069 6620 7468 6520 6365 6e74 6572 206f   if the center o
-00013220: 6620 7265 6769 6f6e 2069 6465 6e74 6966  f region identif
-00013230: 7920 696e 2077 6869 6368 2062 6f78 2069  y in which box i
-00013240: 7420 6973 206c 6f63 6174 6564 0a20 2020  t is located.   
-00013250: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013260: 2020 2020 2061 7267 5f74 6578 745f 636f       arg_text_co
-00013270: 6e2e 6170 7065 6e64 286a 6a29 0a20 2020  n.append(jj).   
-00013280: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013290: 2020 2020 2062 7265 616b 0a20 2020 2020       break.     
-000132a0: 2020 2020 2020 2061 7267 735f 636f 6e74         args_cont
-000132b0: 6f75 7273 203d 206e 702e 6172 7261 7928  ours = np.array(
-000132c0: 7261 6e67 6528 6c65 6e28 6172 675f 7465  range(len(arg_te
-000132d0: 7874 5f63 6f6e 2929 290a 0a20 2020 2020  xt_con)))..     
-000132e0: 2020 2020 2020 206f 7264 6572 5f62 795f         order_by_
-000132f0: 636f 6e5f 6d61 696e 203d 206e 702e 7a65  con_main = np.ze
-00013300: 726f 7328 6c65 6e28 6172 675f 7465 7874  ros(len(arg_text
-00013310: 5f63 6f6e 2929 0a0a 2020 2020 2020 2020  _con))..        
-00013320: 2020 2020 7265 665f 706f 696e 7420 3d20      ref_point = 
-00013330: 300a 2020 2020 2020 2020 2020 2020 6f72  0.            or
-00013340: 6465 725f 6f66 5f74 6578 7473 5f74 6f74  der_of_texts_tot
-00013350: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
-00013360: 2020 6964 5f6f 665f 7465 7874 735f 746f    id_of_texts_to
-00013370: 7420 3d20 5b5d 0a20 2020 2020 2020 2020  t = [].         
-00013380: 2020 2066 6f72 2069 696a 2069 6e20 7261     for iij in ra
-00013390: 6e67 6528 6c65 6e28 626f 7865 7329 293a  nge(len(boxes)):
-000133a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000133b0: 2061 7267 735f 636f 6e74 6f75 7273 5f62   args_contours_b
-000133c0: 6f78 203d 2061 7267 735f 636f 6e74 6f75  ox = args_contou
-000133d0: 7273 5b6e 702e 6172 7261 7928 6172 675f  rs[np.array(arg_
-000133e0: 7465 7874 5f63 6f6e 2920 3d3d 2069 696a  text_con) == iij
-000133f0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-00013400: 2020 636f 6e5f 696e 7465 725f 626f 7820    con_inter_box 
-00013410: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
-00013420: 2020 2020 2063 6f6e 5f69 6e74 6572 5f62       con_inter_b
-00013430: 6f78 5f68 203d 205b 5d0a 0a20 2020 2020  ox_h = []..     
-00013440: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-00013450: 2069 6e20 7261 6e67 6528 6c65 6e28 6172   in range(len(ar
-00013460: 6773 5f63 6f6e 746f 7572 735f 626f 7829  gs_contours_box)
-00013470: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
-00013480: 2020 2020 2020 2063 6f6e 5f69 6e74 6572         con_inter
-00013490: 5f62 6f78 2e61 7070 656e 6428 636f 6e74  _box.append(cont
-000134a0: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
-000134b0: 6172 656e 745b 6172 6773 5f63 6f6e 746f  arent[args_conto
-000134c0: 7572 735f 626f 785b 695d 5d29 0a0a 2020  urs_box[i]])..  
-000134d0: 2020 2020 2020 2020 2020 2020 2020 696e                in
-000134e0: 6465 7865 735f 736f 7274 6564 2c20 6d61  dexes_sorted, ma
-000134f0: 7472 6978 5f6f 665f 6f72 6465 7273 2c20  trix_of_orders, 
-00013500: 6b69 6e64 5f6f 665f 7465 7874 735f 736f  kind_of_texts_so
-00013510: 7274 6564 2c20 696e 6465 785f 6279 5f6b  rted, index_by_k
-00013520: 696e 645f 736f 7274 6564 203d 206f 7264  ind_sorted = ord
-00013530: 6572 5f6f 665f 7265 6769 6f6e 7328 7465  er_of_regions(te
-00013540: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745b  xtline_mask_tot[
-00013550: 696e 7428 626f 7865 735b 6969 6a5d 5b32  int(boxes[iij][2
-00013560: 5d29 203a 2069 6e74 2862 6f78 6573 5b69  ]) : int(boxes[i
-00013570: 696a 5d5b 335d 292c 2069 6e74 2862 6f78  ij][3]), int(box
-00013580: 6573 5b69 696a 5d5b 305d 2920 3a20 696e  es[iij][0]) : in
-00013590: 7428 626f 7865 735b 6969 6a5d 5b31 5d29  t(boxes[iij][1])
-000135a0: 5d2c 2063 6f6e 5f69 6e74 6572 5f62 6f78  ], con_inter_box
-000135b0: 2c20 636f 6e5f 696e 7465 725f 626f 785f  , con_inter_box_
-000135c0: 682c 2062 6f78 6573 5b69 696a 5d5b 325d  h, boxes[iij][2]
-000135d0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
-000135e0: 2020 206f 7264 6572 5f6f 665f 7465 7874     order_of_text
-000135f0: 732c 2069 645f 6f66 5f74 6578 7473 203d  s, id_of_texts =
-00013600: 206f 7264 6572 5f61 6e64 5f69 645f 6f66   order_and_id_of
-00013610: 5f74 6578 7473 2863 6f6e 5f69 6e74 6572  _texts(con_inter
-00013620: 5f62 6f78 2c20 636f 6e5f 696e 7465 725f  _box, con_inter_
-00013630: 626f 785f 682c 206d 6174 7269 785f 6f66  box_h, matrix_of
-00013640: 5f6f 7264 6572 732c 2069 6e64 6578 6573  _orders, indexes
-00013650: 5f73 6f72 7465 642c 2069 6e64 6578 5f62  _sorted, index_b
-00013660: 795f 6b69 6e64 5f73 6f72 7465 642c 206b  y_kind_sorted, k
-00013670: 696e 645f 6f66 5f74 6578 7473 5f73 6f72  ind_of_texts_sor
-00013680: 7465 642c 2072 6566 5f70 6f69 6e74 290a  ted, ref_point).
-00013690: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000136a0: 2069 6e64 6578 6573 5f73 6f72 7465 645f   indexes_sorted_
-000136b0: 6d61 696e 203d 206e 702e 6172 7261 7928  main = np.array(
-000136c0: 696e 6465 7865 735f 736f 7274 6564 295b  indexes_sorted)[
-000136d0: 6e70 2e61 7272 6179 286b 696e 645f 6f66  np.array(kind_of
-000136e0: 5f74 6578 7473 5f73 6f72 7465 6429 203d  _texts_sorted) =
-000136f0: 3d20 315d 0a20 2020 2020 2020 2020 2020  = 1].           
-00013700: 2020 2020 2069 6e64 6578 6573 5f62 795f       indexes_by_
-00013710: 7479 7065 5f6d 6169 6e20 3d20 6e70 2e61  type_main = np.a
-00013720: 7272 6179 2869 6e64 6578 5f62 795f 6b69  rray(index_by_ki
-00013730: 6e64 5f73 6f72 7465 6429 5b6e 702e 6172  nd_sorted)[np.ar
-00013740: 7261 7928 6b69 6e64 5f6f 665f 7465 7874  ray(kind_of_text
-00013750: 735f 736f 7274 6564 2920 3d3d 2031 5d0a  s_sorted) == 1].
-00013760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013770: 2066 6f72 207a 6168 6c65 722c 205f 2069   for zahler, _ i
-00013780: 6e20 656e 756d 6572 6174 6528 6172 6773  n enumerate(args
-00013790: 5f63 6f6e 746f 7572 735f 626f 7829 3a0a  _contours_box):.
-000137a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000137b0: 2020 2020 6172 675f 6f72 6465 725f 7620      arg_order_v 
-000137c0: 3d20 696e 6465 7865 735f 736f 7274 6564  = indexes_sorted
-000137d0: 5f6d 6169 6e5b 7a61 686c 6572 5d0a 2020  _main[zahler].  
-000137e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000137f0: 2020 6f72 6465 725f 6279 5f63 6f6e 5f6d    order_by_con_m
-00013800: 6169 6e5b 6172 6773 5f63 6f6e 746f 7572  ain[args_contour
-00013810: 735f 626f 785b 696e 6465 7865 735f 6279  s_box[indexes_by
-00013820: 5f74 7970 655f 6d61 696e 5b7a 6168 6c65  _type_main[zahle
-00013830: 725d 5d5d 203d 206e 702e 7768 6572 6528  r]]] = np.where(
-00013840: 696e 6465 7865 735f 736f 7274 6564 203d  indexes_sorted =
-00013850: 3d20 6172 675f 6f72 6465 725f 7629 5b30  = arg_order_v)[0
-00013860: 5d5b 305d 202b 2072 6566 5f70 6f69 6e74  ][0] + ref_point
-00013870: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00013880: 2020 666f 7220 6a6a 692c 205f 2069 6e20    for jji, _ in 
-00013890: 656e 756d 6572 6174 6528 6964 5f6f 665f  enumerate(id_of_
-000138a0: 7465 7874 7329 3a0a 2020 2020 2020 2020  texts):.        
-000138b0: 2020 2020 2020 2020 2020 2020 6f72 6465              orde
-000138c0: 725f 6f66 5f74 6578 7473 5f74 6f74 2e61  r_of_texts_tot.a
-000138d0: 7070 656e 6428 6f72 6465 725f 6f66 5f74  ppend(order_of_t
-000138e0: 6578 7473 5b6a 6a69 5d20 2b20 7265 665f  exts[jji] + ref_
-000138f0: 706f 696e 7429 0a20 2020 2020 2020 2020  point).         
-00013900: 2020 2020 2020 2020 2020 2069 645f 6f66             id_of
-00013910: 5f74 6578 7473 5f74 6f74 2e61 7070 656e  _texts_tot.appen
-00013920: 6428 6964 5f6f 665f 7465 7874 735b 6a6a  d(id_of_texts[jj
-00013930: 695d 290a 2020 2020 2020 2020 2020 2020  i]).            
-00013940: 2020 2020 7265 665f 706f 696e 7420 2b3d      ref_point +=
-00013950: 206c 656e 2869 645f 6f66 5f74 6578 7473   len(id_of_texts
-00013960: 290a 0a20 2020 2020 2020 2020 2020 206f  )..            o
-00013970: 7264 6572 5f6f 665f 7465 7874 735f 746f  rder_of_texts_to
-00013980: 7420 3d20 5b5d 0a20 2020 2020 2020 2020  t = [].         
-00013990: 2020 2066 6f72 2074 6a31 2069 6e20 7261     for tj1 in ra
-000139a0: 6e67 6528 6c65 6e28 636f 6e74 6f75 7273  nge(len(contours
-000139b0: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
-000139c0: 7429 293a 0a20 2020 2020 2020 2020 2020  t)):.           
-000139d0: 2020 2020 206f 7264 6572 5f6f 665f 7465       order_of_te
-000139e0: 7874 735f 746f 742e 6170 7065 6e64 2869  xts_tot.append(i
-000139f0: 6e74 286f 7264 6572 5f62 795f 636f 6e5f  nt(order_by_con_
-00013a00: 6d61 696e 5b74 6a31 5d29 290a 0a20 2020  main[tj1]))..   
-00013a10: 2020 2020 2020 2020 206f 7264 6572 5f74           order_t
-00013a20: 6578 745f 6e65 7720 3d20 5b5d 0a20 2020  ext_new = [].   
-00013a30: 2020 2020 2020 2020 2066 6f72 2069 6969           for iii
-00013a40: 2069 6e20 7261 6e67 6528 6c65 6e28 6f72   in range(len(or
-00013a50: 6465 725f 6f66 5f74 6578 7473 5f74 6f74  der_of_texts_tot
-00013a60: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
-00013a70: 2020 2020 6f72 6465 725f 7465 7874 5f6e      order_text_n
-00013a80: 6577 2e61 7070 656e 6428 6e70 2e77 6865  ew.append(np.whe
-00013a90: 7265 286e 702e 6172 7261 7928 6f72 6465  re(np.array(orde
-00013aa0: 725f 6f66 5f74 6578 7473 5f74 6f74 2920  r_of_texts_tot) 
-00013ab0: 3d3d 2069 6969 295b 305d 5b30 5d29 0a20  == iii)[0][0]). 
-00013ac0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00013ad0: 7265 7475 726e 206f 7264 6572 5f74 6578  return order_tex
-00013ae0: 745f 6e65 772c 2069 645f 6f66 5f74 6578  t_new, id_of_tex
-00013af0: 7473 5f74 6f74 0a20 2020 2064 6566 2063  ts_tot.    def c
-00013b00: 6865 636b 5f69 6f75 5f6f 665f 626f 756e  heck_iou_of_boun
-00013b10: 6469 6e67 5f62 6f78 5f61 6e64 5f63 6f6e  ding_box_and_con
-00013b20: 746f 7572 5f66 6f72 5f74 6162 6c65 7328  tour_for_tables(
-00013b30: 7365 6c66 2c20 6c61 796f 7574 2c20 7461  self, layout, ta
-00013b40: 626c 655f 7072 6564 6963 7469 6f6e 5f65  ble_prediction_e
-00013b50: 6172 6c79 2c20 7069 7865 6c5f 7461 6265  arly, pixel_tabe
-00013b60: 6c2c 206e 756d 5f63 6f6c 5f63 6c61 7373  l, num_col_class
-00013b70: 6966 6965 7229 3a0a 2020 2020 2020 2020  ifier):.        
-00013b80: 6c61 796f 7574 5f6f 7267 2020 3d20 6e70  layout_org  = np
-00013b90: 2e63 6f70 7928 6c61 796f 7574 290a 2020  .copy(layout).  
-00013ba0: 2020 2020 2020 6c61 796f 7574 5f6f 7267        layout_org
-00013bb0: 5b3a 2c3a 2c30 5d5b 6c61 796f 7574 5f6f  [:,:,0][layout_o
-00013bc0: 7267 5b3a 2c3a 2c30 5d3d 3d70 6978 656c  rg[:,:,0]==pixel
-00013bd0: 5f74 6162 656c 5d20 3d20 300a 2020 2020  _tabel] = 0.    
-00013be0: 2020 2020 6c61 796f 7574 203d 2028 6c61      layout = (la
-00013bf0: 796f 7574 5b3a 2c3a 2c30 5d3d 3d70 6978  yout[:,:,0]==pix
-00013c00: 656c 5f74 6162 656c 292a 310a 0a20 2020  el_tabel)*1..   
-00013c10: 2020 2020 206c 6179 6f75 7420 3d6e 702e       layout =np.
-00013c20: 7265 7065 6174 286c 6179 6f75 745b 3a2c  repeat(layout[:,
-00013c30: 203a 2c20 6e70 2e6e 6577 6178 6973 5d2c   :, np.newaxis],
-00013c40: 2033 2c20 6178 6973 3d32 290a 2020 2020   3, axis=2).    
-00013c50: 2020 2020 6c61 796f 7574 203d 206c 6179      layout = lay
-00013c60: 6f75 742e 6173 7479 7065 286e 702e 7569  out.astype(np.ui
-00013c70: 6e74 3829 0a20 2020 2020 2020 2069 6d67  nt8).        img
-00013c80: 7261 7920 3d20 6376 322e 6376 7443 6f6c  ray = cv2.cvtCol
-00013c90: 6f72 286c 6179 6f75 742c 2063 7632 2e43  or(layout, cv2.C
-00013ca0: 4f4c 4f52 5f42 4752 3247 5241 5920 290a  OLOR_BGR2GRAY ).
-00013cb0: 2020 2020 2020 2020 5f2c 2074 6872 6573          _, thres
-00013cc0: 6820 3d20 6376 322e 7468 7265 7368 6f6c  h = cv2.threshol
-00013cd0: 6428 696d 6772 6179 2c20 302c 2032 3535  d(imgray, 0, 255
-00013ce0: 2c20 3029 0a0a 2020 2020 2020 2020 636f  , 0)..        co
-00013cf0: 6e74 6f75 7273 2c20 5f20 3d20 6376 322e  ntours, _ = cv2.
-00013d00: 6669 6e64 436f 6e74 6f75 7273 2874 6872  findContours(thr
-00013d10: 6573 682c 2063 7632 2e52 4554 525f 5452  esh, cv2.RETR_TR
-00013d20: 4545 2c20 6376 322e 4348 4149 4e5f 4150  EE, cv2.CHAIN_AP
-00013d30: 5052 4f58 5f53 494d 504c 4529 0a20 2020  PROX_SIMPLE).   
-00013d40: 2020 2020 2063 6e74 5f73 697a 6520 3d20       cnt_size = 
-00013d50: 6e70 2e61 7272 6179 285b 6376 322e 636f  np.array([cv2.co
-00013d60: 6e74 6f75 7241 7265 6128 636f 6e74 6f75  ntourArea(contou
-00013d70: 7273 5b6a 5d29 2066 6f72 206a 2069 6e20  rs[j]) for j in 
-00013d80: 7261 6e67 6528 6c65 6e28 636f 6e74 6f75  range(len(contou
-00013d90: 7273 2929 5d29 0a20 2020 2020 2020 200a  rs))]).        .
-00013da0: 2020 2020 2020 2020 636f 6e74 6f75 7273          contours
-00013db0: 5f6e 6577 203d 205b 5d0a 2020 2020 2020  _new = [].      
-00013dc0: 2020 666f 7220 6920 696e 2072 616e 6765    for i in range
-00013dd0: 286c 656e 2863 6f6e 746f 7572 7329 293a  (len(contours)):
-00013de0: 0a20 2020 2020 2020 2020 2020 2078 2c20  .            x, 
-00013df0: 792c 2077 2c20 6820 3d20 6376 322e 626f  y, w, h = cv2.bo
-00013e00: 756e 6469 6e67 5265 6374 2863 6f6e 746f  undingRect(conto
-00013e10: 7572 735b 695d 290a 2020 2020 2020 2020  urs[i]).        
-00013e20: 2020 2020 696f 7520 3d20 636e 745f 7369      iou = cnt_si
-00013e30: 7a65 5b69 5d20 2f66 6c6f 6174 2877 2a68  ze[i] /float(w*h
-00013e40: 2920 2a31 3030 0a20 2020 2020 2020 2020  ) *100.         
-00013e50: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-00013e60: 6966 2069 6f75 3c38 303a 0a20 2020 2020  if iou<80:.     
-00013e70: 2020 2020 2020 2020 2020 206c 6179 6f75             layou
-00013e80: 745f 636f 6e74 6f75 7220 3d20 6e70 2e7a  t_contour = np.z
-00013e90: 6572 6f73 2828 6c61 796f 7574 5f6f 7267  eros((layout_org
-00013ea0: 2e73 6861 7065 5b30 5d2c 206c 6179 6f75  .shape[0], layou
-00013eb0: 745f 6f72 672e 7368 6170 655b 315d 2929  t_org.shape[1]))
-00013ec0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013ed0: 206c 6179 6f75 745f 636f 6e74 6f75 723d   layout_contour=
-00013ee0: 2063 7632 2e66 696c 6c50 6f6c 7928 6c61   cv2.fillPoly(la
-00013ef0: 796f 7574 5f63 6f6e 746f 7572 2c70 7473  yout_contour,pts
-00013f00: 3d5b 636f 6e74 6f75 7273 5b69 5d5d 202c  =[contours[i]] ,
-00013f10: 636f 6c6f 723d 2831 2c31 2c31 2929 0a20  color=(1,1,1)). 
-00013f20: 2020 2020 2020 2020 2020 2020 2020 200a                 .
-00013f30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00013f40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013f50: 206c 6179 6f75 745f 636f 6e74 6f75 725f   layout_contour_
-00013f60: 7375 6d20 3d20 6c61 796f 7574 5f63 6f6e  sum = layout_con
-00013f70: 746f 7572 2e73 756d 2861 7869 733d 3029  tour.sum(axis=0)
-00013f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00013f90: 206c 6179 6f75 745f 636f 6e74 6f75 725f   layout_contour_
-00013fa0: 7375 6d5f 6469 6666 203d 206e 702e 6469  sum_diff = np.di
-00013fb0: 6666 286c 6179 6f75 745f 636f 6e74 6f75  ff(layout_contou
-00013fc0: 725f 7375 6d29 0a20 2020 2020 2020 2020  r_sum).         
-00013fd0: 2020 2020 2020 206c 6179 6f75 745f 636f         layout_co
-00013fe0: 6e74 6f75 725f 7375 6d5f 6469 6666 3d20  ntour_sum_diff= 
-00013ff0: 6e70 2e61 6273 286c 6179 6f75 745f 636f  np.abs(layout_co
-00014000: 6e74 6f75 725f 7375 6d5f 6469 6666 290a  ntour_sum_diff).
-00014010: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014020: 6c61 796f 7574 5f63 6f6e 746f 7572 5f73  layout_contour_s
-00014030: 756d 5f64 6966 665f 736d 6f6f 7468 6564  um_diff_smoothed
-00014040: 3d20 6761 7573 7369 616e 5f66 696c 7465  = gaussian_filte
-00014050: 7231 6428 6c61 796f 7574 5f63 6f6e 746f  r1d(layout_conto
-00014060: 7572 5f73 756d 5f64 6966 662c 2031 3029  ur_sum_diff, 10)
-00014070: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00014080: 2020 7065 616b 732c 205f 203d 2066 696e    peaks, _ = fin
-00014090: 645f 7065 616b 7328 6c61 796f 7574 5f63  d_peaks(layout_c
-000140a0: 6f6e 746f 7572 5f73 756d 5f64 6966 665f  ontour_sum_diff_
-000140b0: 736d 6f6f 7468 6564 2c20 6865 6967 6874  smoothed, height
-000140c0: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
-000140d0: 2020 2020 7065 616b 733d 2070 6561 6b73      peaks= peaks
-000140e0: 5b6c 6179 6f75 745f 636f 6e74 6f75 725f  [layout_contour_
-000140f0: 7375 6d5f 6469 6666 5f73 6d6f 6f74 6865  sum_diff_smoothe
-00014100: 645b 7065 616b 735d 3e34 5d0a 2020 2020  d[peaks]>4].    
-00014110: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-00014120: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-00014130: 206a 2069 6e20 7261 6e67 6528 6c65 6e28   j in range(len(
-00014140: 7065 616b 7329 293a 0a20 2020 2020 2020  peaks)):.       
-00014150: 2020 2020 2020 2020 2020 2020 206c 6179               lay
-00014160: 6f75 745f 636f 6e74 6f75 725b 3a2c 7065  out_contour[:,pe
-00014170: 616b 735b 6a5d 2d33 2b31 3a70 6561 6b73  aks[j]-3+1:peaks
-00014180: 5b6a 5d2b 312b 335d 203d 2030 0a20 2020  [j]+1+3] = 0.   
-00014190: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000141a0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-000141b0: 2020 6c61 796f 7574 5f63 6f6e 746f 7572    layout_contour
-000141c0: 3d63 7632 2e65 726f 6465 286c 6179 6f75  =cv2.erode(layou
-000141d0: 745f 636f 6e74 6f75 725b 3a2c 3a5d 2c20  t_contour[:,:], 
-000141e0: 4b45 524e 454c 2c20 6974 6572 6174 696f  KERNEL, iteratio
-000141f0: 6e73 3d35 290a 2020 2020 2020 2020 2020  ns=5).          
-00014200: 2020 2020 2020 6c61 796f 7574 5f63 6f6e        layout_con
-00014210: 746f 7572 3d63 7632 2e64 696c 6174 6528  tour=cv2.dilate(
-00014220: 6c61 796f 7574 5f63 6f6e 746f 7572 5b3a  layout_contour[:
-00014230: 2c3a 5d2c 204b 4552 4e45 4c2c 2069 7465  ,:], KERNEL, ite
-00014240: 7261 7469 6f6e 733d 3529 0a20 2020 2020  rations=5).     
-00014250: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-00014260: 2020 2020 2020 2020 2020 2020 6c61 796f              layo
-00014270: 7574 5f63 6f6e 746f 7572 203d 6e70 2e72  ut_contour =np.r
-00014280: 6570 6561 7428 6c61 796f 7574 5f63 6f6e  epeat(layout_con
-00014290: 746f 7572 5b3a 2c20 3a2c 206e 702e 6e65  tour[:, :, np.ne
-000142a0: 7761 7869 735d 2c20 332c 2061 7869 733d  waxis], 3, axis=
-000142b0: 3229 0a20 2020 2020 2020 2020 2020 2020  2).             
-000142c0: 2020 206c 6179 6f75 745f 636f 6e74 6f75     layout_contou
-000142d0: 7220 3d20 6c61 796f 7574 5f63 6f6e 746f  r = layout_conto
-000142e0: 7572 2e61 7374 7970 6528 6e70 2e75 696e  ur.astype(np.uin
-000142f0: 7438 290a 2020 2020 2020 2020 2020 2020  t8).            
-00014300: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-00014310: 2020 2020 2069 6d67 7261 7920 3d20 6376       imgray = cv
-00014320: 322e 6376 7443 6f6c 6f72 286c 6179 6f75  2.cvtColor(layou
-00014330: 745f 636f 6e74 6f75 722c 2063 7632 2e43  t_contour, cv2.C
-00014340: 4f4c 4f52 5f42 4752 3247 5241 5920 290a  OLOR_BGR2GRAY ).
-00014350: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014360: 5f2c 2074 6872 6573 6820 3d20 6376 322e  _, thresh = cv2.
-00014370: 7468 7265 7368 6f6c 6428 696d 6772 6179  threshold(imgray
-00014380: 2c20 302c 2032 3535 2c20 3029 0a0a 2020  , 0, 255, 0)..  
-00014390: 2020 2020 2020 2020 2020 2020 2020 636f                co
-000143a0: 6e74 6f75 7273 5f73 6570 2c20 5f20 3d20  ntours_sep, _ = 
-000143b0: 6376 322e 6669 6e64 436f 6e74 6f75 7273  cv2.findContours
-000143c0: 2874 6872 6573 682c 2063 7632 2e52 4554  (thresh, cv2.RET
-000143d0: 525f 5452 4545 2c20 6376 322e 4348 4149  R_TREE, cv2.CHAI
-000143e0: 4e5f 4150 5052 4f58 5f53 494d 504c 4529  N_APPROX_SIMPLE)
-000143f0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00014400: 2020 666f 7220 6a69 2069 6e20 7261 6e67    for ji in rang
-00014410: 6528 6c65 6e28 636f 6e74 6f75 7273 5f73  e(len(contours_s
-00014420: 6570 2920 293a 0a20 2020 2020 2020 2020  ep) ):.         
-00014430: 2020 2020 2020 2020 2020 2063 6f6e 746f             conto
-00014440: 7572 735f 6e65 772e 6170 7065 6e64 2863  urs_new.append(c
-00014450: 6f6e 746f 7572 735f 7365 705b 6a69 5d29  ontours_sep[ji])
-00014460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00014470: 2020 2020 2069 6620 6e75 6d5f 636f 6c5f       if num_col_
-00014480: 636c 6173 7369 6669 6572 3e3d 323a 0a20  classifier>=2:. 
-00014490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000144a0: 2020 2020 2020 206f 6e6c 795f 7265 6365         only_rece
-000144b0: 6e74 5f63 6f6e 746f 7572 5f69 6d61 6765  nt_contour_image
-000144c0: 203d 206e 702e 7a65 726f 7328 286c 6179   = np.zeros((lay
-000144d0: 6f75 742e 7368 6170 655b 305d 2c6c 6179  out.shape[0],lay
-000144e0: 6f75 742e 7368 6170 655b 315d 2929 0a20  out.shape[1])). 
-000144f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014500: 2020 2020 2020 206f 6e6c 795f 7265 6365         only_rece
-00014510: 6e74 5f63 6f6e 746f 7572 5f69 6d61 6765  nt_contour_image
-00014520: 3d20 6376 322e 6669 6c6c 506f 6c79 286f  = cv2.fillPoly(o
-00014530: 6e6c 795f 7265 6365 6e74 5f63 6f6e 746f  nly_recent_conto
-00014540: 7572 5f69 6d61 6765 2c70 7473 3d5b 636f  ur_image,pts=[co
-00014550: 6e74 6f75 7273 5f73 6570 5b6a 695d 5d20  ntours_sep[ji]] 
-00014560: 2c63 6f6c 6f72 3d28 312c 312c 3129 290a  ,color=(1,1,1)).
-00014570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014580: 2020 2020 2020 2020 7461 626c 655f 7069          table_pi
-00014590: 7865 6c73 5f6d 6173 6b65 645f 6672 6f6d  xels_masked_from
-000145a0: 5f65 6172 6c79 5f70 7265 203d 206f 6e6c  _early_pre = onl
-000145b0: 795f 7265 6365 6e74 5f63 6f6e 746f 7572  y_recent_contour
-000145c0: 5f69 6d61 6765 5b3a 2c3a 5d2a 7461 626c  _image[:,:]*tabl
-000145d0: 655f 7072 6564 6963 7469 6f6e 5f65 6172  e_prediction_ear
-000145e0: 6c79 5b3a 2c3a 5d0a 2020 2020 2020 2020  ly[:,:].        
-000145f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014600: 696f 755f 696e 203d 2074 6162 6c65 5f70  iou_in = table_p
-00014610: 6978 656c 735f 6d61 736b 6564 5f66 726f  ixels_masked_fro
-00014620: 6d5f 6561 726c 795f 7072 652e 7375 6d28  m_early_pre.sum(
-00014630: 2920 2f66 6c6f 6174 286f 6e6c 795f 7265  ) /float(only_re
-00014640: 6365 6e74 5f63 6f6e 746f 7572 5f69 6d61  cent_contour_ima
-00014650: 6765 2e73 756d 2829 2920 2a31 3030 0a20  ge.sum()) *100. 
-00014660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014670: 2020 2020 2020 2023 7072 696e 7428 696f         #print(io
-00014680: 755f 696e 2c27 696f 755f 696e 5f69 6e31  u_in,'iou_in_in1
-00014690: 2729 0a20 2020 2020 2020 2020 2020 2020  ').             
-000146a0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-000146b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000146c0: 2020 2020 6966 2069 6f75 5f69 6e3e 3330      if iou_in>30
-000146d0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-000146e0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-000146f0: 796f 7574 5f6f 7267 3d20 6376 322e 6669  yout_org= cv2.fi
-00014700: 6c6c 506f 6c79 286c 6179 6f75 745f 6f72  llPoly(layout_or
-00014710: 672c 7074 733d 5b63 6f6e 746f 7572 735f  g,pts=[contours_
-00014720: 7365 705b 6a69 5d5d 202c 636f 6c6f 723d  sep[ji]] ,color=
-00014730: 2870 6978 656c 5f74 6162 656c 2c70 6978  (pixel_tabel,pix
-00014740: 656c 5f74 6162 656c 2c70 6978 656c 5f74  el_tabel,pixel_t
-00014750: 6162 656c 2929 0a20 2020 2020 2020 2020  abel)).         
-00014760: 2020 2020 2020 2020 2020 2020 2020 2065                 e
-00014770: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
-00014780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014790: 2070 6173 730a 2020 2020 2020 2020 2020   pass.          
-000147a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000147b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147c0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-000147d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000147e0: 206c 6179 6f75 745f 6f72 673d 2063 7632   layout_org= cv2
-000147f0: 2e66 696c 6c50 6f6c 7928 6c61 796f 7574  .fillPoly(layout
-00014800: 5f6f 7267 2c70 7473 3d5b 636f 6e74 6f75  _org,pts=[contou
-00014810: 7273 5f73 6570 5b6a 695d 5d20 2c63 6f6c  rs_sep[ji]] ,col
-00014820: 6f72 3d28 7069 7865 6c5f 7461 6265 6c2c  or=(pixel_tabel,
-00014830: 7069 7865 6c5f 7461 6265 6c2c 7069 7865  pixel_tabel,pixe
-00014840: 6c5f 7461 6265 6c29 290a 2020 2020 2020  l_tabel)).      
-00014850: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
-00014860: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00014870: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
-00014880: 746f 7572 735f 6e65 772e 6170 7065 6e64  tours_new.append
-00014890: 2863 6f6e 746f 7572 735b 695d 290a 2020  (contours[i]).  
-000148a0: 2020 2020 2020 2020 2020 2020 2020 6966                if
-000148b0: 206e 756d 5f63 6f6c 5f63 6c61 7373 6966   num_col_classif
-000148c0: 6965 723e 3d32 3a0a 2020 2020 2020 2020  ier>=2:.        
-000148d0: 2020 2020 2020 2020 2020 2020 6f6e 6c79              only
-000148e0: 5f72 6563 656e 745f 636f 6e74 6f75 725f  _recent_contour_
-000148f0: 696d 6167 6520 3d20 6e70 2e7a 6572 6f73  image = np.zeros
-00014900: 2828 6c61 796f 7574 2e73 6861 7065 5b30  ((layout.shape[0
-00014910: 5d2c 6c61 796f 7574 2e73 6861 7065 5b31  ],layout.shape[1
-00014920: 5d29 290a 2020 2020 2020 2020 2020 2020  ])).            
-00014930: 2020 2020 2020 2020 6f6e 6c79 5f72 6563          only_rec
-00014940: 656e 745f 636f 6e74 6f75 725f 696d 6167  ent_contour_imag
-00014950: 653d 2063 7632 2e66 696c 6c50 6f6c 7928  e= cv2.fillPoly(
-00014960: 6f6e 6c79 5f72 6563 656e 745f 636f 6e74  only_recent_cont
-00014970: 6f75 725f 696d 6167 652c 7074 733d 5b63  our_image,pts=[c
-00014980: 6f6e 746f 7572 735b 695d 5d20 2c63 6f6c  ontours[i]] ,col
-00014990: 6f72 3d28 312c 312c 3129 290a 2020 2020  or=(1,1,1)).    
-000149a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000149b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000149c0: 2020 2020 2074 6162 6c65 5f70 6978 656c       table_pixel
-000149d0: 735f 6d61 736b 6564 5f66 726f 6d5f 6561  s_masked_from_ea
-000149e0: 726c 795f 7072 6520 3d20 6f6e 6c79 5f72  rly_pre = only_r
-000149f0: 6563 656e 745f 636f 6e74 6f75 725f 696d  ecent_contour_im
-00014a00: 6167 655b 3a2c 3a5d 2a74 6162 6c65 5f70  age[:,:]*table_p
-00014a10: 7265 6469 6374 696f 6e5f 6561 726c 795b  rediction_early[
-00014a20: 3a2c 3a5d 0a20 2020 2020 2020 2020 2020  :,:].           
-00014a30: 2020 2020 2020 2020 2069 6f75 5f69 6e20           iou_in 
-00014a40: 3d20 7461 626c 655f 7069 7865 6c73 5f6d  = table_pixels_m
-00014a50: 6173 6b65 645f 6672 6f6d 5f65 6172 6c79  asked_from_early
-00014a60: 5f70 7265 2e73 756d 2829 202f 666c 6f61  _pre.sum() /floa
-00014a70: 7428 6f6e 6c79 5f72 6563 656e 745f 636f  t(only_recent_co
-00014a80: 6e74 6f75 725f 696d 6167 652e 7375 6d28  ntour_image.sum(
-00014a90: 2929 202a 3130 300a 2020 2020 2020 2020  )) *100.        
-00014aa0: 2020 2020 2020 2020 2020 2020 2370 7269              #pri
-00014ab0: 6e74 2869 6f75 5f69 6e2c 2769 6f75 5f69  nt(iou_in,'iou_i
-00014ac0: 6e27 290a 2020 2020 2020 2020 2020 2020  n').            
-00014ad0: 2020 2020 2020 2020 6966 2069 6f75 5f69          if iou_i
-00014ae0: 6e3e 3330 3a0a 2020 2020 2020 2020 2020  n>30:.          
-00014af0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
-00014b00: 796f 7574 5f6f 7267 3d20 6376 322e 6669  yout_org= cv2.fi
-00014b10: 6c6c 506f 6c79 286c 6179 6f75 745f 6f72  llPoly(layout_or
-00014b20: 672c 7074 733d 5b63 6f6e 746f 7572 735b  g,pts=[contours[
-00014b30: 695d 5d20 2c63 6f6c 6f72 3d28 7069 7865  i]] ,color=(pixe
-00014b40: 6c5f 7461 6265 6c2c 7069 7865 6c5f 7461  l_tabel,pixel_ta
-00014b50: 6265 6c2c 7069 7865 6c5f 7461 6265 6c29  bel,pixel_tabel)
-00014b60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00014b70: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
-00014b80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014b90: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-00014ba0: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00014bb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014bc0: 2020 206c 6179 6f75 745f 6f72 673d 2063     layout_org= c
-00014bd0: 7632 2e66 696c 6c50 6f6c 7928 6c61 796f  v2.fillPoly(layo
-00014be0: 7574 5f6f 7267 2c70 7473 3d5b 636f 6e74  ut_org,pts=[cont
-00014bf0: 6f75 7273 5b69 5d5d 202c 636f 6c6f 723d  ours[i]] ,color=
-00014c00: 2870 6978 656c 5f74 6162 656c 2c70 6978  (pixel_tabel,pix
-00014c10: 656c 5f74 6162 656c 2c70 6978 656c 5f74  el_tabel,pixel_t
-00014c20: 6162 656c 2929 0a20 2020 2020 2020 2020  abel)).         
-00014c30: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00014c40: 7265 7475 726e 206c 6179 6f75 745f 6f72  return layout_or
-00014c50: 672c 2063 6f6e 746f 7572 735f 6e65 770a  g, contours_new.
-00014c60: 2020 2020 6465 6620 6465 6c65 7465 5f73      def delete_s
-00014c70: 6570 6172 6174 6f72 5f61 726f 756e 6428  eparator_around(
-00014c80: 7365 6c66 2c73 706c 6974 6572 5f79 2c70  self,spliter_y,p
-00014c90: 6561 6b73 5f6e 6567 2c69 6d61 6765 5f62  eaks_neg,image_b
-00014ca0: 795f 7265 6769 6f6e 2c20 7069 7865 6c5f  y_region, pixel_
-00014cb0: 6c69 6e65 2c20 7069 7865 6c5f 7461 626c  line, pixel_tabl
-00014cc0: 6529 3a0a 2020 2020 2020 2020 2320 666f  e):.        # fo
-00014cd0: 726d 6174 206f 6620 7375 6262 6f78 6573  rmat of subboxes
-00014ce0: 3a20 626f 783d 5b78 312c 2078 3220 2c20  : box=[x1, x2 , 
-00014cf0: 7931 2c20 7932 5d0a 2020 2020 2020 2020  y1, y2].        
-00014d00: 7069 785f 6465 6c20 3d20 3130 300a 2020  pix_del = 100.  
-00014d10: 2020 2020 2020 6966 206c 656e 2869 6d61        if len(ima
-00014d20: 6765 5f62 795f 7265 6769 6f6e 2e73 6861  ge_by_region.sha
-00014d30: 7065 293d 3d33 3a0a 2020 2020 2020 2020  pe)==3:.        
-00014d40: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
-00014d50: 6765 286c 656e 2873 706c 6974 6572 5f79  ge(len(spliter_y
-00014d60: 292d 3129 3a0a 2020 2020 2020 2020 2020  )-1):.          
-00014d70: 2020 2020 2020 666f 7220 6a20 696e 2072        for j in r
-00014d80: 616e 6765 2831 2c6c 656e 2870 6561 6b73  ange(1,len(peaks
-00014d90: 5f6e 6567 5b69 5d29 2d31 293a 0a20 2020  _neg[i])-1):.   
-00014da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014db0: 2069 6d61 6765 5f62 795f 7265 6769 6f6e   image_by_region
-00014dc0: 5b69 6e74 2873 706c 6974 6572 5f79 5b69  [int(spliter_y[i
-00014dd0: 5d29 3a69 6e74 2873 706c 6974 6572 5f79  ]):int(spliter_y
-00014de0: 5b69 2b31 5d29 2c70 6561 6b73 5f6e 6567  [i+1]),peaks_neg
-00014df0: 5b69 5d5b 6a5d 2d70 6978 5f64 656c 3a70  [i][j]-pix_del:p
-00014e00: 6561 6b73 5f6e 6567 5b69 5d5b 6a5d 2b70  eaks_neg[i][j]+p
-00014e10: 6978 5f64 656c 2c30 5d5b 696d 6167 655f  ix_del,0][image_
-00014e20: 6279 5f72 6567 696f 6e5b 696e 7428 7370  by_region[int(sp
-00014e30: 6c69 7465 725f 795b 695d 293a 696e 7428  liter_y[i]):int(
-00014e40: 7370 6c69 7465 725f 795b 692b 315d 292c  spliter_y[i+1]),
-00014e50: 7065 616b 735f 6e65 675b 695d 5b6a 5d2d  peaks_neg[i][j]-
-00014e60: 7069 785f 6465 6c3a 7065 616b 735f 6e65  pix_del:peaks_ne
-00014e70: 675b 695d 5b6a 5d2b 7069 785f 6465 6c2c  g[i][j]+pix_del,
-00014e80: 305d 3d3d 7069 7865 6c5f 6c69 6e65 205d  0]==pixel_line ]
-00014e90: 3d30 0a20 2020 2020 2020 2020 2020 2020  =0.             
-00014ea0: 2020 2020 2020 2069 6d61 6765 5f62 795f         image_by_
-00014eb0: 7265 6769 6f6e 5b73 706c 6974 6572 5f79  region[spliter_y
-00014ec0: 5b69 5d3a 7370 6c69 7465 725f 795b 692b  [i]:spliter_y[i+
-00014ed0: 315d 2c70 6561 6b73 5f6e 6567 5b69 5d5b  1],peaks_neg[i][
-00014ee0: 6a5d 2d70 6978 5f64 656c 3a70 6561 6b73  j]-pix_del:peaks
-00014ef0: 5f6e 6567 5b69 5d5b 6a5d 2b70 6978 5f64  _neg[i][j]+pix_d
-00014f00: 656c 2c30 5d5b 696d 6167 655f 6279 5f72  el,0][image_by_r
-00014f10: 6567 696f 6e5b 696e 7428 7370 6c69 7465  egion[int(splite
-00014f20: 725f 795b 695d 293a 696e 7428 7370 6c69  r_y[i]):int(spli
-00014f30: 7465 725f 795b 692b 315d 292c 7065 616b  ter_y[i+1]),peak
-00014f40: 735f 6e65 675b 695d 5b6a 5d2d 7069 785f  s_neg[i][j]-pix_
-00014f50: 6465 6c3a 7065 616b 735f 6e65 675b 695d  del:peaks_neg[i]
-00014f60: 5b6a 5d2b 7069 785f 6465 6c2c 315d 3d3d  [j]+pix_del,1]==
-00014f70: 7069 7865 6c5f 6c69 6e65 205d 3d30 0a20  pixel_line ]=0. 
-00014f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00014f90: 2020 2069 6d61 6765 5f62 795f 7265 6769     image_by_regi
-00014fa0: 6f6e 5b73 706c 6974 6572 5f79 5b69 5d3a  on[spliter_y[i]:
-00014fb0: 7370 6c69 7465 725f 795b 692b 315d 2c70  spliter_y[i+1],p
-00014fc0: 6561 6b73 5f6e 6567 5b69 5d5b 6a5d 2d70  eaks_neg[i][j]-p
-00014fd0: 6978 5f64 656c 3a70 6561 6b73 5f6e 6567  ix_del:peaks_neg
-00014fe0: 5b69 5d5b 6a5d 2b70 6978 5f64 656c 2c30  [i][j]+pix_del,0
-00014ff0: 5d5b 696d 6167 655f 6279 5f72 6567 696f  ][image_by_regio
-00015000: 6e5b 696e 7428 7370 6c69 7465 725f 795b  n[int(spliter_y[
-00015010: 695d 293a 696e 7428 7370 6c69 7465 725f  i]):int(spliter_
-00015020: 795b 692b 315d 292c 7065 616b 735f 6e65  y[i+1]),peaks_ne
-00015030: 675b 695d 5b6a 5d2d 7069 785f 6465 6c3a  g[i][j]-pix_del:
-00015040: 7065 616b 735f 6e65 675b 695d 5b6a 5d2b  peaks_neg[i][j]+
-00015050: 7069 785f 6465 6c2c 325d 3d3d 7069 7865  pix_del,2]==pixe
-00015060: 6c5f 6c69 6e65 205d 3d30 0a20 2020 2020  l_line ]=0.     
-00015070: 2020 2020 2020 2020 2020 2020 2020 200a                 .
-00015080: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015090: 2020 2020 696d 6167 655f 6279 5f72 6567      image_by_reg
-000150a0: 696f 6e5b 696e 7428 7370 6c69 7465 725f  ion[int(spliter_
-000150b0: 795b 695d 293a 696e 7428 7370 6c69 7465  y[i]):int(splite
-000150c0: 725f 795b 692b 315d 292c 7065 616b 735f  r_y[i+1]),peaks_
-000150d0: 6e65 675b 695d 5b6a 5d2d 7069 785f 6465  neg[i][j]-pix_de
-000150e0: 6c3a 7065 616b 735f 6e65 675b 695d 5b6a  l:peaks_neg[i][j
-000150f0: 5d2b 7069 785f 6465 6c2c 305d 5b69 6d61  ]+pix_del,0][ima
-00015100: 6765 5f62 795f 7265 6769 6f6e 5b69 6e74  ge_by_region[int
-00015110: 2873 706c 6974 6572 5f79 5b69 5d29 3a69  (spliter_y[i]):i
-00015120: 6e74 2873 706c 6974 6572 5f79 5b69 2b31  nt(spliter_y[i+1
-00015130: 5d29 2c70 6561 6b73 5f6e 6567 5b69 5d5b  ]),peaks_neg[i][
-00015140: 6a5d 2d70 6978 5f64 656c 3a70 6561 6b73  j]-pix_del:peaks
-00015150: 5f6e 6567 5b69 5d5b 6a5d 2b70 6978 5f64  _neg[i][j]+pix_d
-00015160: 656c 2c30 5d3d 3d70 6978 656c 5f74 6162  el,0]==pixel_tab
-00015170: 6c65 205d 3d30 0a20 2020 2020 2020 2020  le ]=0.         
-00015180: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-00015190: 5f62 795f 7265 6769 6f6e 5b69 6e74 2873  _by_region[int(s
-000151a0: 706c 6974 6572 5f79 5b69 5d29 3a69 6e74  pliter_y[i]):int
-000151b0: 2873 706c 6974 6572 5f79 5b69 2b31 5d29  (spliter_y[i+1])
-000151c0: 2c70 6561 6b73 5f6e 6567 5b69 5d5b 6a5d  ,peaks_neg[i][j]
-000151d0: 2d70 6978 5f64 656c 3a70 6561 6b73 5f6e  -pix_del:peaks_n
-000151e0: 6567 5b69 5d5b 6a5d 2b70 6978 5f64 656c  eg[i][j]+pix_del
-000151f0: 2c30 5d5b 696d 6167 655f 6279 5f72 6567  ,0][image_by_reg
-00015200: 696f 6e5b 696e 7428 7370 6c69 7465 725f  ion[int(spliter_
-00015210: 795b 695d 293a 696e 7428 7370 6c69 7465  y[i]):int(splite
-00015220: 725f 795b 692b 315d 292c 7065 616b 735f  r_y[i+1]),peaks_
-00015230: 6e65 675b 695d 5b6a 5d2d 7069 785f 6465  neg[i][j]-pix_de
-00015240: 6c3a 7065 616b 735f 6e65 675b 695d 5b6a  l:peaks_neg[i][j
-00015250: 5d2b 7069 785f 6465 6c2c 315d 3d3d 7069  ]+pix_del,1]==pi
-00015260: 7865 6c5f 7461 626c 6520 5d3d 300a 2020  xel_table ]=0.  
-00015270: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015280: 2020 696d 6167 655f 6279 5f72 6567 696f    image_by_regio
-00015290: 6e5b 696e 7428 7370 6c69 7465 725f 795b  n[int(spliter_y[
-000152a0: 695d 293a 696e 7428 7370 6c69 7465 725f  i]):int(spliter_
-000152b0: 795b 692b 315d 292c 7065 616b 735f 6e65  y[i+1]),peaks_ne
-000152c0: 675b 695d 5b6a 5d2d 7069 785f 6465 6c3a  g[i][j]-pix_del:
-000152d0: 7065 616b 735f 6e65 675b 695d 5b6a 5d2b  peaks_neg[i][j]+
-000152e0: 7069 785f 6465 6c2c 305d 5b69 6d61 6765  pix_del,0][image
-000152f0: 5f62 795f 7265 6769 6f6e 5b69 6e74 2873  _by_region[int(s
-00015300: 706c 6974 6572 5f79 5b69 5d29 3a69 6e74  pliter_y[i]):int
-00015310: 2873 706c 6974 6572 5f79 5b69 2b31 5d29  (spliter_y[i+1])
-00015320: 2c70 6561 6b73 5f6e 6567 5b69 5d5b 6a5d  ,peaks_neg[i][j]
-00015330: 2d70 6978 5f64 656c 3a70 6561 6b73 5f6e  -pix_del:peaks_n
-00015340: 6567 5b69 5d5b 6a5d 2b70 6978 5f64 656c  eg[i][j]+pix_del
-00015350: 2c32 5d3d 3d70 6978 656c 5f74 6162 6c65  ,2]==pixel_table
-00015360: 205d 3d30 0a20 2020 2020 2020 2065 6c73   ]=0.        els
-00015370: 653a 0a20 2020 2020 2020 2020 2020 2066  e:.            f
-00015380: 6f72 2069 2069 6e20 7261 6e67 6528 6c65  or i in range(le
-00015390: 6e28 7370 6c69 7465 725f 7929 2d31 293a  n(spliter_y)-1):
-000153a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000153b0: 2066 6f72 206a 2069 6e20 7261 6e67 6528   for j in range(
-000153c0: 312c 6c65 6e28 7065 616b 735f 6e65 675b  1,len(peaks_neg[
-000153d0: 695d 292d 3129 3a0a 2020 2020 2020 2020  i])-1):.        
-000153e0: 2020 2020 2020 2020 2020 2020 696d 6167              imag
-000153f0: 655f 6279 5f72 6567 696f 6e5b 696e 7428  e_by_region[int(
-00015400: 7370 6c69 7465 725f 795b 695d 293a 696e  spliter_y[i]):in
-00015410: 7428 7370 6c69 7465 725f 795b 692b 315d  t(spliter_y[i+1]
-00015420: 292c 7065 616b 735f 6e65 675b 695d 5b6a  ),peaks_neg[i][j
-00015430: 5d2d 7069 785f 6465 6c3a 7065 616b 735f  ]-pix_del:peaks_
-00015440: 6e65 675b 695d 5b6a 5d2b 7069 785f 6465  neg[i][j]+pix_de
-00015450: 6c5d 5b69 6d61 6765 5f62 795f 7265 6769  l][image_by_regi
-00015460: 6f6e 5b69 6e74 2873 706c 6974 6572 5f79  on[int(spliter_y
-00015470: 5b69 5d29 3a69 6e74 2873 706c 6974 6572  [i]):int(spliter
-00015480: 5f79 5b69 2b31 5d29 2c70 6561 6b73 5f6e  _y[i+1]),peaks_n
-00015490: 6567 5b69 5d5b 6a5d 2d70 6978 5f64 656c  eg[i][j]-pix_del
-000154a0: 3a70 6561 6b73 5f6e 6567 5b69 5d5b 6a5d  :peaks_neg[i][j]
-000154b0: 2b70 6978 5f64 656c 5d3d 3d70 6978 656c  +pix_del]==pixel
-000154c0: 5f6c 696e 6520 5d3d 300a 2020 2020 2020  _line ]=0.      
-000154d0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-000154e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000154f0: 2020 2069 6d61 6765 5f62 795f 7265 6769     image_by_regi
-00015500: 6f6e 5b69 6e74 2873 706c 6974 6572 5f79  on[int(spliter_y
-00015510: 5b69 5d29 3a69 6e74 2873 706c 6974 6572  [i]):int(spliter
-00015520: 5f79 5b69 2b31 5d29 2c70 6561 6b73 5f6e  _y[i+1]),peaks_n
-00015530: 6567 5b69 5d5b 6a5d 2d70 6978 5f64 656c  eg[i][j]-pix_del
-00015540: 3a70 6561 6b73 5f6e 6567 5b69 5d5b 6a5d  :peaks_neg[i][j]
-00015550: 2b70 6978 5f64 656c 5d5b 696d 6167 655f  +pix_del][image_
-00015560: 6279 5f72 6567 696f 6e5b 696e 7428 7370  by_region[int(sp
-00015570: 6c69 7465 725f 795b 695d 293a 696e 7428  liter_y[i]):int(
-00015580: 7370 6c69 7465 725f 795b 692b 315d 292c  spliter_y[i+1]),
-00015590: 7065 616b 735f 6e65 675b 695d 5b6a 5d2d  peaks_neg[i][j]-
-000155a0: 7069 785f 6465 6c3a 7065 616b 735f 6e65  pix_del:peaks_ne
-000155b0: 675b 695d 5b6a 5d2b 7069 785f 6465 6c5d  g[i][j]+pix_del]
-000155c0: 3d3d 7069 7865 6c5f 7461 626c 6520 5d3d  ==pixel_table ]=
-000155d0: 300a 2020 2020 2020 2020 7265 7475 726e  0.        return
-000155e0: 2069 6d61 6765 5f62 795f 7265 6769 6f6e   image_by_region
-000155f0: 0a20 2020 2064 6566 2061 6464 5f74 6162  .    def add_tab
-00015600: 6c65 735f 6865 7572 6973 7469 635f 746f  les_heuristic_to
-00015610: 5f6c 6179 6f75 7428 7365 6c66 2c20 696d  _layout(self, im
-00015620: 6167 655f 7265 6769 6f6e 735f 6572 616c  age_regions_eral
-00015630: 795f 702c 626f 7865 732c 2073 6c6f 7065  y_p,boxes, slope
-00015640: 5f6d 6561 6e5f 686f 722c 2073 706c 6974  _mean_hor, split
-00015650: 6572 5f79 2c70 6561 6b73 5f6e 6567 5f74  er_y,peaks_neg_t
-00015660: 6f74 2c20 696d 6167 655f 7265 7669 7365  ot, image_revise
-00015670: 642c 206e 756d 5f63 6f6c 5f63 6c61 7373  d, num_col_class
-00015680: 6966 6965 722c 206d 696e 5f61 7265 612c  ifier, min_area,
-00015690: 2070 6978 656c 5f6c 696e 6529 3a0a 2020   pixel_line):.  
-000156a0: 2020 2020 2020 7069 7865 6c5f 7461 626c        pixel_tabl
-000156b0: 6520 3d31 300a 2020 2020 2020 2020 696d  e =10.        im
-000156c0: 6167 655f 7265 7669 7365 645f 3120 3d20  age_revised_1 = 
-000156d0: 7365 6c66 2e64 656c 6574 655f 7365 7061  self.delete_sepa
-000156e0: 7261 746f 725f 6172 6f75 6e64 2873 706c  rator_around(spl
-000156f0: 6974 6572 5f79 2c20 7065 616b 735f 6e65  iter_y, peaks_ne
-00015700: 675f 746f 742c 2069 6d61 6765 5f72 6576  g_tot, image_rev
-00015710: 6973 6564 2c20 7069 7865 6c5f 6c69 6e65  ised, pixel_line
-00015720: 2c20 7069 7865 6c5f 7461 626c 6529 0a20  , pixel_table). 
-00015730: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00015740: 7472 793a 0a20 2020 2020 2020 2020 2020  try:.           
-00015750: 2069 6d61 6765 5f72 6576 6973 6564 5f31   image_revised_1
-00015760: 5b3a 2c3a 3330 5d5b 696d 6167 655f 7265  [:,:30][image_re
-00015770: 7669 7365 645f 315b 3a2c 3a33 305d 3d3d  vised_1[:,:30]==
-00015780: 7069 7865 6c5f 6c69 6e65 5d20 3d20 300a  pixel_line] = 0.
-00015790: 2020 2020 2020 2020 2020 2020 696d 6167              imag
-000157a0: 655f 7265 7669 7365 645f 315b 3a2c 696d  e_revised_1[:,im
-000157b0: 6167 655f 7265 7669 7365 645f 312e 7368  age_revised_1.sh
-000157c0: 6170 655b 315d 2d33 303a 5d5b 696d 6167  ape[1]-30:][imag
-000157d0: 655f 7265 7669 7365 645f 315b 3a2c 696d  e_revised_1[:,im
-000157e0: 6167 655f 7265 7669 7365 645f 312e 7368  age_revised_1.sh
-000157f0: 6170 655b 315d 2d33 303a 5d3d 3d70 6978  ape[1]-30:]==pix
-00015800: 656c 5f6c 696e 655d 203d 2030 0a20 2020  el_line] = 0.   
-00015810: 2020 2020 2065 7863 6570 743a 0a20 2020       except:.   
-00015820: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
-00015830: 2020 2020 2020 0a20 2020 2020 2020 2069        .        i
-00015840: 6d67 5f63 6f6d 6d5f 6520 3d20 6e70 2e7a  mg_comm_e = np.z
-00015850: 6572 6f73 2869 6d61 6765 5f72 6576 6973  eros(image_revis
-00015860: 6564 5f31 2e73 6861 7065 290a 2020 2020  ed_1.shape).    
-00015870: 2020 2020 696d 675f 636f 6d6d 203d 206e      img_comm = n
-00015880: 702e 7265 7065 6174 2869 6d67 5f63 6f6d  p.repeat(img_com
-00015890: 6d5f 655b 3a2c 203a 2c20 6e70 2e6e 6577  m_e[:, :, np.new
-000158a0: 6178 6973 5d2c 2033 2c20 6178 6973 3d32  axis], 3, axis=2
-000158b0: 290a 0a20 2020 2020 2020 2066 6f72 2069  )..        for i
-000158c0: 6e64 6976 2069 6e20 6e70 2e75 6e69 7175  ndiv in np.uniqu
-000158d0: 6528 696d 6167 655f 7265 7669 7365 645f  e(image_revised_
-000158e0: 3129 3a0a 2020 2020 2020 2020 2020 2020  1):.            
-000158f0: 696d 6167 655f 636f 6c3d 2869 6d61 6765  image_col=(image
-00015900: 5f72 6576 6973 6564 5f31 3d3d 696e 6469  _revised_1==indi
-00015910: 7629 2a32 3535 0a20 2020 2020 2020 2020  v)*255.         
-00015920: 2020 2069 6d67 5f63 6f6d 6d5f 696e 3d6e     img_comm_in=n
-00015930: 702e 7265 7065 6174 2869 6d61 6765 5f63  p.repeat(image_c
-00015940: 6f6c 5b3a 2c20 3a2c 206e 702e 6e65 7761  ol[:, :, np.newa
-00015950: 7869 735d 2c20 332c 2061 7869 733d 3229  xis], 3, axis=2)
-00015960: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
-00015970: 5f63 6f6d 6d5f 696e 3d69 6d67 5f63 6f6d  _comm_in=img_com
-00015980: 6d5f 696e 2e61 7374 7970 6528 6e70 2e75  m_in.astype(np.u
-00015990: 696e 7438 290a 0a20 2020 2020 2020 2020  int8)..         
-000159a0: 2020 2069 6d67 7261 7920 3d20 6376 322e     imgray = cv2.
-000159b0: 6376 7443 6f6c 6f72 2869 6d67 5f63 6f6d  cvtColor(img_com
-000159c0: 6d5f 696e 2c20 6376 322e 434f 4c4f 525f  m_in, cv2.COLOR_
-000159d0: 4247 5232 4752 4159 290a 2020 2020 2020  BGR2GRAY).      
-000159e0: 2020 2020 2020 7265 742c 2074 6872 6573        ret, thres
-000159f0: 6820 3d20 6376 322e 7468 7265 7368 6f6c  h = cv2.threshol
-00015a00: 6428 696d 6772 6179 2c20 302c 2032 3535  d(imgray, 0, 255
-00015a10: 2c20 3029 0a20 2020 2020 2020 2020 2020  , 0).           
-00015a20: 2063 6f6e 746f 7572 732c 6869 7261 7263   contours,hirarc
-00015a30: 6879 3d63 7632 2e66 696e 6443 6f6e 746f  hy=cv2.findConto
-00015a40: 7572 7328 7468 7265 7368 2e63 6f70 7928  urs(thresh.copy(
-00015a50: 292c 2063 7632 2e52 4554 525f 5452 4545  ), cv2.RETR_TREE
-00015a60: 2c63 7632 2e43 4841 494e 5f41 5050 524f  ,cv2.CHAIN_APPRO
-00015a70: 585f 5349 4d50 4c45 290a 0a20 2020 2020  X_SIMPLE)..     
-00015a80: 2020 2020 2020 2069 6620 696e 6469 763d         if indiv=
-00015a90: 3d70 6978 656c 5f74 6162 6c65 3a0a 2020  =pixel_table:.  
-00015aa0: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
-00015ab0: 696e 5f63 6f6e 746f 7572 7320 3d20 6669  in_contours = fi
-00015ac0: 6c74 6572 5f63 6f6e 746f 7572 735f 6172  lter_contours_ar
-00015ad0: 6561 5f6f 665f 696d 6167 655f 7461 626c  ea_of_image_tabl
-00015ae0: 6573 2874 6872 6573 682c 2063 6f6e 746f  es(thresh, conto
-00015af0: 7572 732c 2068 6972 6172 6368 792c 206d  urs, hirarchy, m
-00015b00: 6178 5f61 7265 6120 3d20 312c 206d 696e  ax_area = 1, min
-00015b10: 5f61 7265 6120 3d20 302e 3030 3129 0a20  _area = 0.001). 
-00015b20: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
-00015b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015b40: 206d 6169 6e5f 636f 6e74 6f75 7273 203d   main_contours =
-00015b50: 2066 696c 7465 725f 636f 6e74 6f75 7273   filter_contours
-00015b60: 5f61 7265 615f 6f66 5f69 6d61 6765 5f74  _area_of_image_t
-00015b70: 6162 6c65 7328 7468 7265 7368 2c20 636f  ables(thresh, co
-00015b80: 6e74 6f75 7273 2c20 6869 7261 7263 6879  ntours, hirarchy
-00015b90: 2c20 6d61 785f 6172 6561 203d 2031 2c20  , max_area = 1, 
-00015ba0: 6d69 6e5f 6172 6561 203d 206d 696e 5f61  min_area = min_a
-00015bb0: 7265 6129 0a0a 2020 2020 2020 2020 2020  rea)..          
-00015bc0: 2020 696d 675f 636f 6d6d 203d 2063 7632    img_comm = cv2
-00015bd0: 2e66 696c 6c50 6f6c 7928 696d 675f 636f  .fillPoly(img_co
-00015be0: 6d6d 2c20 7074 7320 3d20 6d61 696e 5f63  mm, pts = main_c
-00015bf0: 6f6e 746f 7572 732c 2063 6f6c 6f72 203d  ontours, color =
-00015c00: 2028 696e 6469 762c 2069 6e64 6976 2c20   (indiv, indiv, 
-00015c10: 696e 6469 7629 290a 2020 2020 2020 2020  indiv)).        
-00015c20: 2020 2020 696d 675f 636f 6d6d 203d 2069      img_comm = i
-00015c30: 6d67 5f63 6f6d 6d2e 6173 7479 7065 286e  mg_comm.astype(n
-00015c40: 702e 7569 6e74 3829 0a20 2020 2020 2020  p.uint8).       
-00015c50: 2020 2020 200a 2020 2020 2020 2020 6966       .        if
-00015c60: 206e 6f74 2073 656c 662e 6973 4e61 4e28   not self.isNaN(
-00015c70: 736c 6f70 655f 6d65 616e 5f68 6f72 293a  slope_mean_hor):
-00015c80: 0a20 2020 2020 2020 2020 2020 2069 6d61  .            ima
-00015c90: 6765 5f72 6576 6973 6564 5f6c 6173 7420  ge_revised_last 
-00015ca0: 3d20 6e70 2e7a 6572 6f73 2828 696d 6167  = np.zeros((imag
-00015cb0: 655f 7265 6769 6f6e 735f 6572 616c 795f  e_regions_eraly_
-00015cc0: 702e 7368 6170 655b 305d 2c20 696d 6167  p.shape[0], imag
-00015cd0: 655f 7265 6769 6f6e 735f 6572 616c 795f  e_regions_eraly_
-00015ce0: 702e 7368 6170 655b 315d 2c33 2929 0a20  p.shape[1],3)). 
-00015cf0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
-00015d00: 2069 6e20 7261 6e67 6528 6c65 6e28 626f   in range(len(bo
-00015d10: 7865 7329 293a 0a20 2020 2020 2020 2020  xes)):.         
-00015d20: 2020 2020 2020 2069 6d61 6765 5f62 6f78         image_box
-00015d30: 3d69 6d67 5f63 6f6d 6d5b 696e 7428 626f  =img_comm[int(bo
-00015d40: 7865 735b 695d 5b32 5d29 3a69 6e74 2862  xes[i][2]):int(b
-00015d50: 6f78 6573 5b69 5d5b 335d 292c 696e 7428  oxes[i][3]),int(
-00015d60: 626f 7865 735b 695d 5b30 5d29 3a69 6e74  boxes[i][0]):int
-00015d70: 2862 6f78 6573 5b69 5d5b 315d 292c 3a5d  (boxes[i][1]),:]
-00015d80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00015d90: 2074 7279 3a0a 2020 2020 2020 2020 2020   try:.          
-00015da0: 2020 2020 2020 2020 2020 696d 6167 655f            image_
-00015db0: 626f 785f 7461 6265 6c73 5f31 3d28 696d  box_tabels_1=(im
-00015dc0: 6167 655f 626f 785b 3a2c 3a2c 305d 3d3d  age_box[:,:,0]==
-00015dd0: 7069 7865 6c5f 7461 626c 6529 2a31 0a20  pixel_table)*1. 
-00015de0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015df0: 2020 2063 6f6e 746f 7572 735f 7461 622c     contours_tab,
-00015e00: 5f3d 7265 7475 726e 5f63 6f6e 746f 7572  _=return_contour
-00015e10: 735f 6f66 5f69 6d61 6765 2869 6d61 6765  s_of_image(image
-00015e20: 5f62 6f78 5f74 6162 656c 735f 3129 0a20  _box_tabels_1). 
-00015e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015e40: 2020 2063 6f6e 746f 7572 735f 7461 623d     contours_tab=
-00015e50: 6669 6c74 6572 5f63 6f6e 746f 7572 735f  filter_contours_
-00015e60: 6172 6561 5f6f 665f 696d 6167 655f 7461  area_of_image_ta
-00015e70: 626c 6573 2869 6d61 6765 5f62 6f78 5f74  bles(image_box_t
-00015e80: 6162 656c 735f 312c 636f 6e74 6f75 7273  abels_1,contours
-00015e90: 5f74 6162 2c5f 2c31 2c30 2e30 3033 290a  _tab,_,1,0.003).
-00015ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00015eb0: 2020 2020 696d 6167 655f 626f 785f 7461      image_box_ta
-00015ec0: 6265 6c73 5f31 3d28 696d 6167 655f 626f  bels_1=(image_bo
-00015ed0: 785b 3a2c 3a2c 305d 3d3d 7069 7865 6c5f  x[:,:,0]==pixel_
-00015ee0: 6c69 6e65 292a 310a 0a20 2020 2020 2020  line)*1..       
-00015ef0: 2020 2020 2020 2020 2020 2020 2069 6d61               ima
-00015f00: 6765 5f62 6f78 5f74 6162 656c 735f 616e  ge_box_tabels_an
-00015f10: 645f 6d5f 7465 7874 3d28 2028 696d 6167  d_m_text=( (imag
-00015f20: 655f 626f 785b 3a2c 3a2c 305d 3d3d 7069  e_box[:,:,0]==pi
-00015f30: 7865 6c5f 7461 626c 6529 207c 2028 696d  xel_table) | (im
-00015f40: 6167 655f 626f 785b 3a2c 3a2c 305d 3d3d  age_box[:,:,0]==
-00015f50: 3129 2029 2a31 0a20 2020 2020 2020 2020  1) )*1.         
-00015f60: 2020 2020 2020 2020 2020 2069 6d61 6765             image
-00015f70: 5f62 6f78 5f74 6162 656c 735f 616e 645f  _box_tabels_and_
-00015f80: 6d5f 7465 7874 3d69 6d61 6765 5f62 6f78  m_text=image_box
-00015f90: 5f74 6162 656c 735f 616e 645f 6d5f 7465  _tabels_and_m_te
-00015fa0: 7874 2e61 7374 7970 6528 6e70 2e75 696e  xt.astype(np.uin
-00015fb0: 7438 290a 0a20 2020 2020 2020 2020 2020  t8)..           
-00015fc0: 2020 2020 2020 2020 2069 6d61 6765 5f62           image_b
-00015fd0: 6f78 5f74 6162 656c 735f 313d 696d 6167  ox_tabels_1=imag
-00015fe0: 655f 626f 785f 7461 6265 6c73 5f31 2e61  e_box_tabels_1.a
-00015ff0: 7374 7970 6528 6e70 2e75 696e 7438 290a  stype(np.uint8).
-00016000: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016010: 2020 2020 696d 6167 655f 626f 785f 7461      image_box_ta
-00016020: 6265 6c73 5f31 203d 2063 7632 2e64 696c  bels_1 = cv2.dil
-00016030: 6174 6528 696d 6167 655f 626f 785f 7461  ate(image_box_ta
-00016040: 6265 6c73 5f31 2c4b 4552 4e45 4c2c 6974  bels_1,KERNEL,it
-00016050: 6572 6174 696f 6e73 203d 2035 290a 0a20  erations = 5).. 
-00016060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016070: 2020 2063 6f6e 746f 7572 735f 7461 626c     contours_tabl
-00016080: 655f 6d5f 7465 7874 2c5f 3d72 6574 7572  e_m_text,_=retur
-00016090: 6e5f 636f 6e74 6f75 7273 5f6f 665f 696d  n_contours_of_im
-000160a0: 6167 6528 696d 6167 655f 626f 785f 7461  age(image_box_ta
-000160b0: 6265 6c73 5f61 6e64 5f6d 5f74 6578 7429  bels_and_m_text)
-000160c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000160d0: 2020 2020 2069 6d61 6765 5f62 6f78 5f74       image_box_t
-000160e0: 6162 656c 733d 6e70 2e72 6570 6561 7428  abels=np.repeat(
-000160f0: 696d 6167 655f 626f 785f 7461 6265 6c73  image_box_tabels
-00016100: 5f31 5b3a 2c20 3a2c 206e 702e 6e65 7761  _1[:, :, np.newa
-00016110: 7869 735d 2c20 332c 2061 7869 733d 3229  xis], 3, axis=2)
-00016120: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00016130: 2020 2020 2020 696d 6167 655f 626f 785f        image_box_
-00016140: 7461 6265 6c73 3d69 6d61 6765 5f62 6f78  tabels=image_box
-00016150: 5f74 6162 656c 732e 6173 7479 7065 286e  _tabels.astype(n
-00016160: 702e 7569 6e74 3829 0a20 2020 2020 2020  p.uint8).       
-00016170: 2020 2020 2020 2020 2020 2020 2069 6d67               img
-00016180: 7261 7920 3d20 6376 322e 6376 7443 6f6c  ray = cv2.cvtCol
-00016190: 6f72 2869 6d61 6765 5f62 6f78 5f74 6162  or(image_box_tab
-000161a0: 656c 732c 2063 7632 2e43 4f4c 4f52 5f42  els, cv2.COLOR_B
-000161b0: 4752 3247 5241 5929 0a20 2020 2020 2020  GR2GRAY).       
-000161c0: 2020 2020 2020 2020 2020 2020 2072 6574               ret
-000161d0: 2c20 7468 7265 7368 203d 2063 7632 2e74  , thresh = cv2.t
-000161e0: 6872 6573 686f 6c64 2869 6d67 7261 792c  hreshold(imgray,
-000161f0: 2030 2c20 3235 352c 2030 290a 0a20 2020   0, 255, 0)..   
-00016200: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016210: 2063 6f6e 746f 7572 735f 6c69 6e65 2c68   contours_line,h
-00016220: 6965 7261 6368 793d 6376 322e 6669 6e64  ierachy=cv2.find
-00016230: 436f 6e74 6f75 7273 2874 6872 6573 682c  Contours(thresh,
-00016240: 6376 322e 5245 5452 5f54 5245 452c 6376  cv2.RETR_TREE,cv
-00016250: 322e 4348 4149 4e5f 4150 5052 4f58 5f53  2.CHAIN_APPROX_S
-00016260: 494d 504c 4529 0a0a 2020 2020 2020 2020  IMPLE)..        
-00016270: 2020 2020 2020 2020 2020 2020 795f 6d69              y_mi
-00016280: 6e5f 6d61 696e 5f6c 696e 6520 2c79 5f6d  n_main_line ,y_m
-00016290: 6178 5f6d 6169 6e5f 6c69 6e65 3d66 696e  ax_main_line=fin
-000162a0: 645f 6665 6174 7572 6573 5f6f 665f 636f  d_features_of_co
-000162b0: 6e74 6f75 7273 2863 6f6e 746f 7572 735f  ntours(contours_
-000162c0: 6c69 6e65 290a 2020 2020 2020 2020 2020  line).          
-000162d0: 2020 2020 2020 2020 2020 795f 6d69 6e5f            y_min_
-000162e0: 6d61 696e 5f74 6162 202c 795f 6d61 785f  main_tab ,y_max_
-000162f0: 6d61 696e 5f74 6162 3d66 696e 645f 6665  main_tab=find_fe
-00016300: 6174 7572 6573 5f6f 665f 636f 6e74 6f75  atures_of_contou
-00016310: 7273 2863 6f6e 746f 7572 735f 7461 6229  rs(contours_tab)
-00016320: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-00016330: 2020 2020 2020 6378 5f74 6162 5f6d 5f74        cx_tab_m_t
-00016340: 6578 742c 6379 5f74 6162 5f6d 5f74 6578  ext,cy_tab_m_tex
-00016350: 7420 2c78 5f6d 696e 5f74 6162 5f6d 5f74  t ,x_min_tab_m_t
-00016360: 6578 7420 2c20 785f 6d61 785f 7461 625f  ext , x_max_tab_
-00016370: 6d5f 7465 7874 2c20 795f 6d69 6e5f 7461  m_text, y_min_ta
-00016380: 625f 6d5f 7465 7874 202c 795f 6d61 785f  b_m_text ,y_max_
-00016390: 7461 625f 6d5f 7465 7874 2c20 5f3d 2066  tab_m_text, _= f
-000163a0: 696e 645f 6e65 775f 6665 6174 7572 6573  ind_new_features
-000163b0: 5f6f 665f 636f 6e74 6f75 7273 2863 6f6e  _of_contours(con
-000163c0: 746f 7572 735f 7461 626c 655f 6d5f 7465  tours_table_m_te
-000163d0: 7874 290a 2020 2020 2020 2020 2020 2020  xt).            
-000163e0: 2020 2020 2020 2020 6378 5f74 6162 6c2c          cx_tabl,
-000163f0: 6379 5f74 6162 6c20 2c78 5f6d 696e 5f74  cy_tabl ,x_min_t
-00016400: 6162 6c20 2c20 785f 6d61 785f 7461 626c  abl , x_max_tabl
-00016410: 2c20 795f 6d69 6e5f 7461 626c 202c 795f  , y_min_tabl ,y_
-00016420: 6d61 785f 7461 626c 2c5f 3d20 6669 6e64  max_tabl,_= find
-00016430: 5f6e 6577 5f66 6561 7475 7265 735f 6f66  _new_features_of
-00016440: 5f63 6f6e 746f 7572 7328 636f 6e74 6f75  _contours(contou
-00016450: 7273 5f74 6162 290a 0a20 2020 2020 2020  rs_tab)..       
-00016460: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-00016470: 6c65 6e28 795f 6d69 6e5f 6d61 696e 5f74  len(y_min_main_t
-00016480: 6162 2029 3e30 3a0a 2020 2020 2020 2020  ab )>0:.        
-00016490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000164a0: 795f 646f 776e 5f74 6162 733d 5b5d 0a20  y_down_tabs=[]. 
-000164b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000164c0: 2020 2020 2020 2079 5f75 705f 7461 6273         y_up_tabs
-000164d0: 3d5b 5d0a 0a20 2020 2020 2020 2020 2020  =[]..           
-000164e0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
-000164f0: 2069 5f74 2069 6e20 7261 6e67 6528 6c65   i_t in range(le
-00016500: 6e28 795f 6d69 6e5f 6d61 696e 5f74 6162  n(y_min_main_tab
-00016510: 2029 293a 0a20 2020 2020 2020 2020 2020   )):.           
-00016520: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016530: 2079 5f64 6f77 6e5f 7461 623d 5b5d 0a20   y_down_tab=[]. 
-00016540: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016550: 2020 2020 2020 2020 2020 2079 5f75 705f             y_up_
-00016560: 7461 623d 5b5d 0a20 2020 2020 2020 2020  tab=[].         
-00016570: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016580: 2020 2066 6f72 2069 5f6c 2069 6e20 7261     for i_l in ra
-00016590: 6e67 6528 6c65 6e28 795f 6d69 6e5f 6d61  nge(len(y_min_ma
-000165a0: 696e 5f6c 696e 6529 293a 0a20 2020 2020  in_line)):.     
-000165b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000165c0: 2020 2020 2020 2020 2020 2069 6620 795f             if y_
-000165d0: 6d69 6e5f 6d61 696e 5f74 6162 5b69 5f74  min_main_tab[i_t
-000165e0: 5d3e 795f 6d69 6e5f 6d61 696e 5f6c 696e  ]>y_min_main_lin
-000165f0: 655b 695f 6c5d 2061 6e64 2020 795f 6d61  e[i_l] and  y_ma
-00016600: 785f 6d61 696e 5f74 6162 5b69 5f74 5d3e  x_main_tab[i_t]>
-00016610: 795f 6d69 6e5f 6d61 696e 5f6c 696e 655b  y_min_main_line[
-00016620: 695f 6c5d 2061 6e64 2079 5f6d 696e 5f6d  i_l] and y_min_m
-00016630: 6169 6e5f 7461 625b 695f 745d 3e79 5f6d  ain_tab[i_t]>y_m
-00016640: 6178 5f6d 6169 6e5f 6c69 6e65 5b69 5f6c  ax_main_line[i_l
-00016650: 5d20 616e 6420 795f 6d61 785f 6d61 696e  ] and y_max_main
-00016660: 5f74 6162 5b69 5f74 5d3e 795f 6d69 6e5f  _tab[i_t]>y_min_
-00016670: 6d61 696e 5f6c 696e 655b 695f 6c5d 3a0a  main_line[i_l]:.
-00016680: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016690: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000166a0: 2020 2020 7061 7373 0a20 2020 2020 2020      pass.       
-000166b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000166c0: 2020 2020 2020 2020 2065 6c69 6620 795f           elif y_
-000166d0: 6d69 6e5f 6d61 696e 5f74 6162 5b69 5f74  min_main_tab[i_t
-000166e0: 5d3c 795f 6d61 785f 6d61 696e 5f6c 696e  ]<y_max_main_lin
-000166f0: 655b 695f 6c5d 2061 6e64 2079 5f6d 6178  e[i_l] and y_max
-00016700: 5f6d 6169 6e5f 7461 625b 695f 745d 3c79  _main_tab[i_t]<y
-00016710: 5f6d 6178 5f6d 6169 6e5f 6c69 6e65 5b69  _max_main_line[i
-00016720: 5f6c 5d20 616e 6420 795f 6d61 785f 6d61  _l] and y_max_ma
-00016730: 696e 5f74 6162 5b69 5f74 5d3c 795f 6d69  in_tab[i_t]<y_mi
-00016740: 6e5f 6d61 696e 5f6c 696e 655b 695f 6c5d  n_main_line[i_l]
-00016750: 2061 6e64 2079 5f6d 696e 5f6d 6169 6e5f   and y_min_main_
-00016760: 7461 625b 695f 745d 3c79 5f6d 696e 5f6d  tab[i_t]<y_min_m
-00016770: 6169 6e5f 6c69 6e65 5b69 5f6c 5d3a 0a20  ain_line[i_l]:. 
-00016780: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016790: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000167a0: 2020 2070 6173 730a 2020 2020 2020 2020     pass.        
-000167b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000167c0: 2020 2020 2020 2020 656c 6966 206e 702e          elif np.
-000167d0: 6162 7328 795f 6d61 785f 6d61 696e 5f6c  abs(y_max_main_l
-000167e0: 696e 655b 695f 6c5d 2d79 5f6d 696e 5f6d  ine[i_l]-y_min_m
-000167f0: 6169 6e5f 6c69 6e65 5b69 5f6c 5d29 3c31  ain_line[i_l])<1
-00016800: 3030 3a0a 2020 2020 2020 2020 2020 2020  00:.            
-00016810: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016820: 2020 2020 2020 2020 7061 7373 0a20 2020          pass.   
-00016830: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016840: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00016850: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00016860: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016870: 2020 2020 2020 2079 5f75 705f 7461 622e         y_up_tab.
-00016880: 6170 7065 6e64 286e 702e 6d69 6e28 5b79  append(np.min([y
-00016890: 5f6d 696e 5f6d 6169 6e5f 6c69 6e65 5b69  _min_main_line[i
-000168a0: 5f6c 5d2c 2079 5f6d 696e 5f6d 6169 6e5f  _l], y_min_main_
-000168b0: 7461 625b 695f 745d 205d 2920 2029 0a20  tab[i_t] ])  ). 
-000168c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000168e0: 2020 2079 5f64 6f77 6e5f 7461 622e 6170     y_down_tab.ap
-000168f0: 7065 6e64 2820 6e70 2e6d 6178 285b 2079  pend( np.max([ y
-00016900: 5f6d 6178 5f6d 6169 6e5f 6c69 6e65 5b69  _max_main_line[i
-00016910: 5f6c 5d2c 795f 6d61 785f 6d61 696e 5f74  _l],y_max_main_t
-00016920: 6162 5b69 5f74 5d20 5d29 2029 0a0a 2020  ab[i_t] ]) )..  
-00016930: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016940: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-00016950: 2879 5f75 705f 7461 6229 3d3d 303a 0a20  (y_up_tab)==0:. 
-00016960: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016970: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00016980: 5f75 705f 7461 6273 2e61 7070 656e 6428  _up_tabs.append(
-00016990: 795f 6d69 6e5f 6d61 696e 5f74 6162 5b69  y_min_main_tab[i
-000169a0: 5f74 5d29 0a20 2020 2020 2020 2020 2020  _t]).           
-000169b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000169c0: 2020 2020 2079 5f64 6f77 6e5f 7461 6273       y_down_tabs
-000169d0: 2e61 7070 656e 6428 795f 6d61 785f 6d61  .append(y_max_ma
-000169e0: 696e 5f74 6162 5b69 5f74 5d29 0a20 2020  in_tab[i_t]).   
-000169f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a00: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
-00016a10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a20: 2020 2020 2020 2020 2020 2020 2020 2079                 y
-00016a30: 5f75 705f 7461 6273 2e61 7070 656e 6428  _up_tabs.append(
-00016a40: 6e70 2e6d 696e 2879 5f75 705f 7461 6229  np.min(y_up_tab)
-00016a50: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-00016a60: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016a70: 2020 795f 646f 776e 5f74 6162 732e 6170    y_down_tabs.ap
-00016a80: 7065 6e64 286e 702e 6d61 7828 795f 646f  pend(np.max(y_do
-00016a90: 776e 5f74 6162 2929 0a20 2020 2020 2020  wn_tab)).       
-00016aa0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
-00016ab0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00016ac0: 2020 2020 2020 2020 2020 2079 5f64 6f77             y_dow
-00016ad0: 6e5f 7461 6273 3d5b 5d0a 2020 2020 2020  n_tabs=[].      
-00016ae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016af0: 2020 795f 7570 5f74 6162 733d 5b5d 0a20    y_up_tabs=[]. 
-00016b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00016b10: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-00016b20: 2020 2020 2020 2020 2020 2020 6578 6365              exce
-00016b30: 7074 3a0a 2020 2020 2020 2020 2020 2020  pt:.            
-00016b40: 2020 2020 2020 2020 795f 646f 776e 5f74          y_down_t
-00016b50: 6162 733d 5b5d 0a20 2020 2020 2020 2020  abs=[].         
-00016b60: 2020 2020 2020 2020 2020 2079 5f75 705f             y_up_
-00016b70: 7461 6273 3d5b 5d0a 0a20 2020 2020 2020  tabs=[]..       
-00016b80: 2020 2020 2020 2020 2066 6f72 2069 6920           for ii 
-00016b90: 696e 2072 616e 6765 286c 656e 2879 5f75  in range(len(y_u
-00016ba0: 705f 7461 6273 2929 3a0a 2020 2020 2020  p_tabs)):.      
-00016bb0: 2020 2020 2020 2020 2020 2020 2020 696d                im
-00016bc0: 6167 655f 626f 785b 795f 7570 5f74 6162  age_box[y_up_tab
-00016bd0: 735b 6969 5d3a 795f 646f 776e 5f74 6162  s[ii]:y_down_tab
-00016be0: 735b 6969 5d2c 3a2c 305d 3d70 6978 656c  s[ii],:,0]=pixel
-00016bf0: 5f74 6162 6c65 0a0a 2020 2020 2020 2020  _table..        
-00016c00: 2020 2020 2020 2020 696d 6167 655f 7265          image_re
-00016c10: 7669 7365 645f 6c61 7374 5b69 6e74 2862  vised_last[int(b
-00016c20: 6f78 6573 5b69 5d5b 325d 293a 696e 7428  oxes[i][2]):int(
-00016c30: 626f 7865 735b 695d 5b33 5d29 2c69 6e74  boxes[i][3]),int
-00016c40: 2862 6f78 6573 5b69 5d5b 305d 293a 696e  (boxes[i][0]):in
-00016c50: 7428 626f 7865 735b 695d 5b31 5d29 2c3a  t(boxes[i][1]),:
-00016c60: 5d3d 696d 6167 655f 626f 785b 3a2c 3a2c  ]=image_box[:,:,
-00016c70: 3a5d 0a20 2020 2020 2020 2065 6c73 653a  :].        else:
-00016c80: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
-00016c90: 2069 2069 6e20 7261 6e67 6528 6c65 6e28   i in range(len(
-00016ca0: 626f 7865 7329 293a 0a0a 2020 2020 2020  boxes)):..      
-00016cb0: 2020 2020 2020 2020 2020 696d 6167 655f            image_
-00016cc0: 626f 783d 696d 675f 636f 6d6d 5b69 6e74  box=img_comm[int
-00016cd0: 2862 6f78 6573 5b69 5d5b 325d 293a 696e  (boxes[i][2]):in
-00016ce0: 7428 626f 7865 735b 695d 5b33 5d29 2c69  t(boxes[i][3]),i
-00016cf0: 6e74 2862 6f78 6573 5b69 5d5b 305d 293a  nt(boxes[i][0]):
-00016d00: 696e 7428 626f 7865 735b 695d 5b31 5d29  int(boxes[i][1])
-00016d10: 2c3a 5d0a 2020 2020 2020 2020 2020 2020  ,:].            
-00016d20: 2020 2020 696d 6167 655f 7265 7669 7365      image_revise
-00016d30: 645f 6c61 7374 5b69 6e74 2862 6f78 6573  d_last[int(boxes
-00016d40: 5b69 5d5b 325d 293a 696e 7428 626f 7865  [i][2]):int(boxe
-00016d50: 735b 695d 5b33 5d29 2c69 6e74 2862 6f78  s[i][3]),int(box
-00016d60: 6573 5b69 5d5b 305d 293a 696e 7428 626f  es[i][0]):int(bo
-00016d70: 7865 735b 695d 5b31 5d29 2c3a 5d3d 696d  xes[i][1]),:]=im
-00016d80: 6167 655f 626f 785b 3a2c 3a2c 3a5d 0a20  age_box[:,:,:]. 
-00016d90: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00016da0: 6966 206e 756d 5f63 6f6c 5f63 6c61 7373  if num_col_class
-00016db0: 6966 6965 723d 3d31 3a0a 2020 2020 2020  ifier==1:.      
-00016dc0: 2020 2020 2020 696d 675f 7461 626c 6573        img_tables
-00016dd0: 5f63 6f6c 5f31 3d28 2069 6d61 6765 5f72  _col_1=( image_r
-00016de0: 6576 6973 6564 5f6c 6173 745b 3a2c 3a2c  evised_last[:,:,
-00016df0: 305d 3d3d 7069 7865 6c5f 7461 626c 6520  0]==pixel_table 
-00016e00: 292a 310a 2020 2020 2020 2020 2020 2020  )*1.            
-00016e10: 696d 675f 7461 626c 6573 5f63 6f6c 5f31  img_tables_col_1
-00016e20: 3d69 6d67 5f74 6162 6c65 735f 636f 6c5f  =img_tables_col_
-00016e30: 312e 6173 7479 7065 286e 702e 7569 6e74  1.astype(np.uint
-00016e40: 3829 0a20 2020 2020 2020 2020 2020 2063  8).            c
-00016e50: 6f6e 746f 7572 735f 7461 626c 655f 636f  ontours_table_co
-00016e60: 6c31 2c5f 3d72 6574 7572 6e5f 636f 6e74  l1,_=return_cont
-00016e70: 6f75 7273 5f6f 665f 696d 6167 6528 696d  ours_of_image(im
-00016e80: 675f 7461 626c 6573 5f63 6f6c 5f31 290a  g_tables_col_1).
-00016e90: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-00016ea0: 2020 2020 2020 2020 205f 2c5f 202c 5f20           _,_ ,_ 
-00016eb0: 2c20 5f2c 2079 5f6d 696e 5f74 6162 5f63  , _, y_min_tab_c
-00016ec0: 6f6c 3120 2c79 5f6d 6178 5f74 6162 5f63  ol1 ,y_max_tab_c
-00016ed0: 6f6c 312c 205f 3d20 6669 6e64 5f6e 6577  ol1, _= find_new
-00016ee0: 5f66 6561 7475 7265 735f 6f66 5f63 6f6e  _features_of_con
-00016ef0: 746f 7572 7328 636f 6e74 6f75 7273 5f74  tours(contours_t
-00016f00: 6162 6c65 5f63 6f6c 3129 0a20 2020 2020  able_col1).     
-00016f10: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00016f20: 2020 2020 6966 206c 656e 2879 5f6d 696e      if len(y_min
-00016f30: 5f74 6162 5f63 6f6c 3129 3e30 3a0a 2020  _tab_col1)>0:.  
-00016f40: 2020 2020 2020 2020 2020 2020 2020 666f                fo
-00016f50: 7220 696a 7620 696e 2072 616e 6765 286c  r ijv in range(l
-00016f60: 656e 2879 5f6d 696e 5f74 6162 5f63 6f6c  en(y_min_tab_col
-00016f70: 3129 293a 0a20 2020 2020 2020 2020 2020  1)):.           
-00016f80: 2020 2020 2020 2020 2069 6d61 6765 5f72           image_r
-00016f90: 6576 6973 6564 5f6c 6173 745b 696e 7428  evised_last[int(
-00016fa0: 795f 6d69 6e5f 7461 625f 636f 6c31 5b69  y_min_tab_col1[i
-00016fb0: 6a76 5d29 3a69 6e74 2879 5f6d 6178 5f74  jv]):int(y_max_t
-00016fc0: 6162 5f63 6f6c 315b 696a 765d 292c 3a2c  ab_col1[ijv]),:,
-00016fd0: 3a5d 3d70 6978 656c 5f74 6162 6c65 0a20  :]=pixel_table. 
-00016fe0: 2020 2020 2020 2072 6574 7572 6e20 696d         return im
-00016ff0: 6167 655f 7265 7669 7365 645f 6c61 7374  age_revised_last
-00017000: 0a20 2020 2064 6566 2064 6f5f 6f72 6465  .    def do_orde
-00017010: 725f 6f66 5f72 6567 696f 6e73 2873 656c  r_of_regions(sel
-00017020: 662c 202a 6172 6773 2c20 2a2a 6b77 6172  f, *args, **kwar
-00017030: 6773 293a 0a20 2020 2020 2020 2069 6620  gs):.        if 
-00017040: 7365 6c66 2e66 756c 6c5f 6c61 796f 7574  self.full_layout
-00017050: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-00017060: 7475 726e 2073 656c 662e 646f 5f6f 7264  turn self.do_ord
-00017070: 6572 5f6f 665f 7265 6769 6f6e 735f 6675  er_of_regions_fu
-00017080: 6c6c 5f6c 6179 6f75 7428 2a61 7267 732c  ll_layout(*args,
-00017090: 202a 2a6b 7761 7267 7329 0a20 2020 2020   **kwargs).     
-000170a0: 2020 2072 6574 7572 6e20 7365 6c66 2e64     return self.d
-000170b0: 6f5f 6f72 6465 725f 6f66 5f72 6567 696f  o_order_of_regio
-000170c0: 6e73 5f6e 6f5f 6675 6c6c 5f6c 6179 6f75  ns_no_full_layou
-000170d0: 7428 2a61 7267 732c 202a 2a6b 7761 7267  t(*args, **kwarg
-000170e0: 7329 0a20 2020 200a 2020 2020 6465 6620  s).    .    def 
-000170f0: 6765 745f 7461 626c 6573 5f66 726f 6d5f  get_tables_from_
-00017100: 6d6f 6465 6c28 7365 6c66 2c20 696d 672c  model(self, img,
-00017110: 206e 756d 5f63 6f6c 5f63 6c61 7373 6966   num_col_classif
-00017120: 6965 7229 3a0a 2020 2020 2020 2020 696d  ier):.        im
-00017130: 675f 6f72 6720 3d20 6e70 2e63 6f70 7928  g_org = np.copy(
-00017140: 696d 6729 0a20 2020 2020 2020 200a 2020  img).        .  
-00017150: 2020 2020 2020 696d 675f 6865 6967 6874        img_height
-00017160: 5f68 203d 2069 6d67 5f6f 7267 2e73 6861  _h = img_org.sha
-00017170: 7065 5b30 5d0a 2020 2020 2020 2020 696d  pe[0].        im
-00017180: 675f 7769 6474 685f 6820 3d20 696d 675f  g_width_h = img_
-00017190: 6f72 672e 7368 6170 655b 315d 0a20 2020  org.shape[1].   
-000171a0: 2020 2020 200a 2020 2020 2020 2020 6d6f       .        mo
-000171b0: 6465 6c5f 7265 6769 6f6e 2c20 7365 7373  del_region, sess
-000171c0: 696f 6e5f 7265 6769 6f6e 203d 2073 656c  ion_region = sel
-000171d0: 662e 7374 6172 745f 6e65 775f 7365 7373  f.start_new_sess
-000171e0: 696f 6e5f 616e 645f 6d6f 6465 6c28 7365  ion_and_model(se
-000171f0: 6c66 2e6d 6f64 656c 5f74 6162 6c65 7329  lf.model_tables)
-00017200: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00017210: 2020 7061 7463 6865 7320 3d20 4661 6c73    patches = Fals
-00017220: 650a 2020 2020 2020 2020 0a20 2020 2020  e.        .     
-00017230: 2020 2069 6620 6e75 6d5f 636f 6c5f 636c     if num_col_cl
-00017240: 6173 7369 6669 6572 203c 2034 2061 6e64  assifier < 4 and
-00017250: 206e 756d 5f63 6f6c 5f63 6c61 7373 6966   num_col_classif
-00017260: 6965 7220 3e20 323a 0a20 2020 2020 2020  ier > 2:.       
-00017270: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
-00017280: 7461 626c 6520 3d20 7365 6c66 2e64 6f5f  table = self.do_
-00017290: 7072 6564 6963 7469 6f6e 2870 6174 6368  prediction(patch
-000172a0: 6573 2c20 696d 672c 206d 6f64 656c 5f72  es, img, model_r
-000172b0: 6567 696f 6e29 0a20 2020 2020 2020 2020  egion).         
-000172c0: 2020 2070 7265 5f75 7064 6f77 6e20 3d20     pre_updown = 
-000172d0: 7365 6c66 2e64 6f5f 7072 6564 6963 7469  self.do_predicti
-000172e0: 6f6e 2870 6174 6368 6573 2c20 6376 322e  on(patches, cv2.
-000172f0: 666c 6970 2869 6d67 5b3a 2c3a 2c3a 5d2c  flip(img[:,:,:],
-00017300: 202d 3129 2c20 6d6f 6465 6c5f 7265 6769   -1), model_regi
-00017310: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
-00017320: 7072 655f 7570 646f 776e 203d 2063 7632  pre_updown = cv2
-00017330: 2e66 6c69 7028 7072 655f 7570 646f 776e  .flip(pre_updown
-00017340: 2c20 2d31 290a 2020 2020 2020 2020 2020  , -1).          
-00017350: 2020 0a20 2020 2020 2020 2020 2020 2070    .            p
-00017360: 7265 6469 6374 696f 6e5f 7461 626c 655b  rediction_table[
-00017370: 3a2c 3a2c 305d 5b70 7265 5f75 7064 6f77  :,:,0][pre_updow
-00017380: 6e5b 3a2c 3a2c 305d 3d3d 315d 3d31 0a20  n[:,:,0]==1]=1. 
-00017390: 2020 2020 2020 2020 2020 2070 7265 6469             predi
-000173a0: 6374 696f 6e5f 7461 626c 6520 3d20 7072  ction_table = pr
-000173b0: 6564 6963 7469 6f6e 5f74 6162 6c65 2e61  ediction_table.a
-000173c0: 7374 7970 6528 6e70 2e69 6e74 3136 290a  stype(np.int16).
-000173d0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
-000173e0: 2020 2020 2065 6c69 6620 6e75 6d5f 636f       elif num_co
-000173f0: 6c5f 636c 6173 7369 6669 6572 203d 3d32  l_classifier ==2
-00017400: 3a0a 2020 2020 2020 2020 2020 2020 6865  :.            he
-00017410: 6967 6874 5f65 7874 203d 2030 2369 6e74  ight_ext = 0#int
-00017420: 2820 696d 672e 7368 6170 655b 305d 2f34  ( img.shape[0]/4
-00017430: 2e20 290a 2020 2020 2020 2020 2020 2020  . ).            
-00017440: 685f 7374 6172 7420 3d20 696e 7428 6865  h_start = int(he
-00017450: 6967 6874 5f65 7874 2f32 2e29 0a20 2020  ight_ext/2.).   
-00017460: 2020 2020 2020 2020 2077 6964 7468 5f65           width_e
-00017470: 7874 203d 2069 6e74 2820 696d 672e 7368  xt = int( img.sh
-00017480: 6170 655b 315d 2f38 2e20 290a 2020 2020  ape[1]/8. ).    
-00017490: 2020 2020 2020 2020 775f 7374 6172 7420          w_start 
-000174a0: 3d20 696e 7428 7769 6474 685f 6578 742f  = int(width_ext/
-000174b0: 322e 290a 2020 2020 2020 2020 0a20 2020  2.).        .   
-000174c0: 2020 2020 2020 2020 2068 6569 6768 745f           height_
-000174d0: 6e65 7720 3d20 696d 672e 7368 6170 655b  new = img.shape[
-000174e0: 305d 2b68 6569 6768 745f 6578 740a 2020  0]+height_ext.  
-000174f0: 2020 2020 2020 2020 2020 7769 6474 685f            width_
-00017500: 6e65 7720 3d20 696d 672e 7368 6170 655b  new = img.shape[
-00017510: 315d 2b77 6964 7468 5f65 7874 0a20 2020  1]+width_ext.   
-00017520: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-00017530: 2020 2020 2020 696d 675f 6e65 7720 3d6e        img_new =n
-00017540: 702e 6f6e 6573 2828 6865 6967 6874 5f6e  p.ones((height_n
-00017550: 6577 2c77 6964 7468 5f6e 6577 2c69 6d67  ew,width_new,img
-00017560: 2e73 6861 7065 5b32 5d29 292e 6173 7479  .shape[2])).asty
-00017570: 7065 2866 6c6f 6174 292a 300a 2020 2020  pe(float)*0.    
-00017580: 2020 2020 2020 2020 696d 675f 6e65 775b          img_new[
-00017590: 685f 7374 6172 743a 685f 7374 6172 742b  h_start:h_start+
-000175a0: 696d 672e 7368 6170 655b 305d 202c 775f  img.shape[0] ,w_
-000175b0: 7374 6172 743a 2077 5f73 7461 7274 2b69  start: w_start+i
-000175c0: 6d67 2e73 6861 7065 5b31 5d2c 203a 205d  mg.shape[1], : ]
-000175d0: 203d 696d 675b 3a2c 3a2c 3a5d 0a0a 2020   =img[:,:,:]..  
-000175e0: 2020 2020 2020 2020 2020 7072 6564 6963            predic
-000175f0: 7469 6f6e 5f65 7874 203d 2073 656c 662e  tion_ext = self.
-00017600: 646f 5f70 7265 6469 6374 696f 6e28 7061  do_prediction(pa
-00017610: 7463 6865 732c 2069 6d67 5f6e 6577 2c20  tches, img_new, 
-00017620: 6d6f 6465 6c5f 7265 6769 6f6e 290a 2020  model_region).  
-00017630: 2020 2020 2020 2020 2020 7072 655f 7570            pre_up
-00017640: 646f 776e 203d 2073 656c 662e 646f 5f70  down = self.do_p
-00017650: 7265 6469 6374 696f 6e28 7061 7463 6865  rediction(patche
-00017660: 732c 2063 7632 2e66 6c69 7028 696d 675f  s, cv2.flip(img_
-00017670: 6e65 775b 3a2c 3a2c 3a5d 2c20 2d31 292c  new[:,:,:], -1),
-00017680: 206d 6f64 656c 5f72 6567 696f 6e29 0a20   model_region). 
-00017690: 2020 2020 2020 2020 2020 2070 7265 5f75             pre_u
-000176a0: 7064 6f77 6e20 3d20 6376 322e 666c 6970  pdown = cv2.flip
-000176b0: 2870 7265 5f75 7064 6f77 6e2c 202d 3129  (pre_updown, -1)
-000176c0: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
-000176d0: 2020 2020 2020 2020 2020 7072 6564 6963            predic
-000176e0: 7469 6f6e 5f74 6162 6c65 203d 2070 7265  tion_table = pre
-000176f0: 6469 6374 696f 6e5f 6578 745b 685f 7374  diction_ext[h_st
-00017700: 6172 743a 685f 7374 6172 742b 696d 672e  art:h_start+img.
-00017710: 7368 6170 655b 305d 202c 775f 7374 6172  shape[0] ,w_star
-00017720: 743a 2077 5f73 7461 7274 2b69 6d67 2e73  t: w_start+img.s
-00017730: 6861 7065 5b31 5d2c 203a 205d 0a20 2020  hape[1], : ].   
-00017740: 2020 2020 2020 2020 2070 7265 6469 6374           predict
-00017750: 696f 6e5f 7461 626c 655f 7570 646f 776e  ion_table_updown
-00017760: 203d 2070 7265 5f75 7064 6f77 6e5b 685f   = pre_updown[h_
-00017770: 7374 6172 743a 685f 7374 6172 742b 696d  start:h_start+im
-00017780: 672e 7368 6170 655b 305d 202c 775f 7374  g.shape[0] ,w_st
-00017790: 6172 743a 2077 5f73 7461 7274 2b69 6d67  art: w_start+img
-000177a0: 2e73 6861 7065 5b31 5d2c 203a 205d 0a20  .shape[1], : ]. 
-000177b0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-000177c0: 2020 2020 2020 2020 7072 6564 6963 7469          predicti
-000177d0: 6f6e 5f74 6162 6c65 5b3a 2c3a 2c30 5d5b  on_table[:,:,0][
-000177e0: 7072 6564 6963 7469 6f6e 5f74 6162 6c65  prediction_table
-000177f0: 5f75 7064 6f77 6e5b 3a2c 3a2c 305d 3d3d  _updown[:,:,0]==
-00017800: 315d 3d31 0a20 2020 2020 2020 2020 2020  1]=1.           
-00017810: 2070 7265 6469 6374 696f 6e5f 7461 626c   prediction_tabl
-00017820: 6520 3d20 7072 6564 6963 7469 6f6e 5f74  e = prediction_t
-00017830: 6162 6c65 2e61 7374 7970 6528 6e70 2e69  able.astype(np.i
-00017840: 6e74 3136 290a 0a20 2020 2020 2020 2065  nt16)..        e
-00017850: 6c69 6620 6e75 6d5f 636f 6c5f 636c 6173  lif num_col_clas
-00017860: 7369 6669 6572 203d 3d31 3a0a 2020 2020  sifier ==1:.    
-00017870: 2020 2020 2020 2020 6865 6967 6874 5f65          height_e
-00017880: 7874 203d 2030 2320 696e 7428 2069 6d67  xt = 0# int( img
-00017890: 2e73 6861 7065 5b30 5d2f 342e 2029 0a20  .shape[0]/4. ). 
-000178a0: 2020 2020 2020 2020 2020 2068 5f73 7461             h_sta
-000178b0: 7274 203d 2069 6e74 2868 6569 6768 745f  rt = int(height_
-000178c0: 6578 742f 322e 290a 2020 2020 2020 2020  ext/2.).        
-000178d0: 2020 2020 7769 6474 685f 6578 7420 3d20      width_ext = 
-000178e0: 696e 7428 2069 6d67 2e73 6861 7065 5b31  int( img.shape[1
-000178f0: 5d2f 342e 2029 0a20 2020 2020 2020 2020  ]/4. ).         
-00017900: 2020 2077 5f73 7461 7274 203d 2069 6e74     w_start = int
-00017910: 2877 6964 7468 5f65 7874 2f32 2e29 0a20  (width_ext/2.). 
-00017920: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-00017930: 2020 2020 6865 6967 6874 5f6e 6577 203d      height_new =
-00017940: 2069 6d67 2e73 6861 7065 5b30 5d2b 6865   img.shape[0]+he
-00017950: 6967 6874 5f65 7874 0a20 2020 2020 2020  ight_ext.       
-00017960: 2020 2020 2077 6964 7468 5f6e 6577 203d       width_new =
-00017970: 2069 6d67 2e73 6861 7065 5b31 5d2b 7769   img.shape[1]+wi
-00017980: 6474 685f 6578 740a 2020 2020 2020 2020  dth_ext.        
-00017990: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-000179a0: 2069 6d67 5f6e 6577 203d 6e70 2e6f 6e65   img_new =np.one
-000179b0: 7328 2868 6569 6768 745f 6e65 772c 7769  s((height_new,wi
-000179c0: 6474 685f 6e65 772c 696d 672e 7368 6170  dth_new,img.shap
-000179d0: 655b 325d 2929 2e61 7374 7970 6528 666c  e[2])).astype(fl
-000179e0: 6f61 7429 2a30 0a20 2020 2020 2020 2020  oat)*0.         
-000179f0: 2020 2069 6d67 5f6e 6577 5b68 5f73 7461     img_new[h_sta
-00017a00: 7274 3a68 5f73 7461 7274 2b69 6d67 2e73  rt:h_start+img.s
-00017a10: 6861 7065 5b30 5d20 2c77 5f73 7461 7274  hape[0] ,w_start
-00017a20: 3a20 775f 7374 6172 742b 696d 672e 7368  : w_start+img.sh
-00017a30: 6170 655b 315d 2c20 3a20 5d20 3d69 6d67  ape[1], : ] =img
-00017a40: 5b3a 2c3a 2c3a 5d0a 0a20 2020 2020 2020  [:,:,:]..       
-00017a50: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
-00017a60: 6578 7420 3d20 7365 6c66 2e64 6f5f 7072  ext = self.do_pr
-00017a70: 6564 6963 7469 6f6e 2870 6174 6368 6573  ediction(patches
-00017a80: 2c20 696d 675f 6e65 772c 206d 6f64 656c  , img_new, model
-00017a90: 5f72 6567 696f 6e29 0a20 2020 2020 2020  _region).       
-00017aa0: 2020 2020 2070 7265 5f75 7064 6f77 6e20       pre_updown 
-00017ab0: 3d20 7365 6c66 2e64 6f5f 7072 6564 6963  = self.do_predic
-00017ac0: 7469 6f6e 2870 6174 6368 6573 2c20 6376  tion(patches, cv
-00017ad0: 322e 666c 6970 2869 6d67 5f6e 6577 5b3a  2.flip(img_new[:
-00017ae0: 2c3a 2c3a 5d2c 202d 3129 2c20 6d6f 6465  ,:,:], -1), mode
-00017af0: 6c5f 7265 6769 6f6e 290a 2020 2020 2020  l_region).      
-00017b00: 2020 2020 2020 7072 655f 7570 646f 776e        pre_updown
-00017b10: 203d 2063 7632 2e66 6c69 7028 7072 655f   = cv2.flip(pre_
-00017b20: 7570 646f 776e 2c20 2d31 290a 2020 2020  updown, -1).    
-00017b30: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-00017b40: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
-00017b50: 7461 626c 6520 3d20 7072 6564 6963 7469  table = predicti
-00017b60: 6f6e 5f65 7874 5b68 5f73 7461 7274 3a68  on_ext[h_start:h
-00017b70: 5f73 7461 7274 2b69 6d67 2e73 6861 7065  _start+img.shape
-00017b80: 5b30 5d20 2c77 5f73 7461 7274 3a20 775f  [0] ,w_start: w_
-00017b90: 7374 6172 742b 696d 672e 7368 6170 655b  start+img.shape[
-00017ba0: 315d 2c20 3a20 5d0a 2020 2020 2020 2020  1], : ].        
-00017bb0: 2020 2020 7072 6564 6963 7469 6f6e 5f74      prediction_t
-00017bc0: 6162 6c65 5f75 7064 6f77 6e20 3d20 7072  able_updown = pr
-00017bd0: 655f 7570 646f 776e 5b68 5f73 7461 7274  e_updown[h_start
-00017be0: 3a68 5f73 7461 7274 2b69 6d67 2e73 6861  :h_start+img.sha
-00017bf0: 7065 5b30 5d20 2c77 5f73 7461 7274 3a20  pe[0] ,w_start: 
-00017c00: 775f 7374 6172 742b 696d 672e 7368 6170  w_start+img.shap
-00017c10: 655b 315d 2c20 3a20 5d0a 2020 2020 2020  e[1], : ].      
-00017c20: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-00017c30: 2020 2070 7265 6469 6374 696f 6e5f 7461     prediction_ta
-00017c40: 626c 655b 3a2c 3a2c 305d 5b70 7265 6469  ble[:,:,0][predi
-00017c50: 6374 696f 6e5f 7461 626c 655f 7570 646f  ction_table_updo
-00017c60: 776e 5b3a 2c3a 2c30 5d3d 3d31 5d3d 310a  wn[:,:,0]==1]=1.
-00017c70: 2020 2020 2020 2020 2020 2020 7072 6564              pred
-00017c80: 6963 7469 6f6e 5f74 6162 6c65 203d 2070  iction_table = p
-00017c90: 7265 6469 6374 696f 6e5f 7461 626c 652e  rediction_table.
-00017ca0: 6173 7479 7065 286e 702e 696e 7431 3629  astype(np.int16)
-00017cb0: 0a0a 2020 2020 2020 2020 656c 7365 3a0a  ..        else:.
-00017cc0: 2020 2020 2020 2020 2020 2020 7072 6564              pred
-00017cd0: 6963 7469 6f6e 5f74 6162 6c65 203d 206e  iction_table = n
-00017ce0: 702e 7a65 726f 7328 696d 672e 7368 6170  p.zeros(img.shap
-00017cf0: 6529 0a20 2020 2020 2020 2020 2020 2069  e).            i
-00017d00: 6d67 5f77 5f68 616c 6620 3d20 696e 7428  mg_w_half = int(
-00017d10: 696d 672e 7368 6170 655b 315d 2f32 2e29  img.shape[1]/2.)
-00017d20: 0a0a 2020 2020 2020 2020 2020 2020 7072  ..            pr
-00017d30: 6531 203d 2073 656c 662e 646f 5f70 7265  e1 = self.do_pre
-00017d40: 6469 6374 696f 6e28 7061 7463 6865 732c  diction(patches,
-00017d50: 2069 6d67 5b3a 2c30 3a69 6d67 5f77 5f68   img[:,0:img_w_h
-00017d60: 616c 662c 3a5d 2c20 6d6f 6465 6c5f 7265  alf,:], model_re
-00017d70: 6769 6f6e 290a 2020 2020 2020 2020 2020  gion).          
-00017d80: 2020 7072 6532 203d 2073 656c 662e 646f    pre2 = self.do
-00017d90: 5f70 7265 6469 6374 696f 6e28 7061 7463  _prediction(patc
-00017da0: 6865 732c 2069 6d67 5b3a 2c69 6d67 5f77  hes, img[:,img_w
-00017db0: 5f68 616c 663a 2c3a 5d2c 206d 6f64 656c  _half:,:], model
-00017dc0: 5f72 6567 696f 6e29 0a20 2020 2020 2020  _region).       
-00017dd0: 2020 2020 2070 7265 5f66 756c 6c20 3d20       pre_full = 
-00017de0: 7365 6c66 2e64 6f5f 7072 6564 6963 7469  self.do_predicti
-00017df0: 6f6e 2870 6174 6368 6573 2c20 696d 675b  on(patches, img[
-00017e00: 3a2c 3a2c 3a5d 2c20 6d6f 6465 6c5f 7265  :,:,:], model_re
-00017e10: 6769 6f6e 290a 2020 2020 2020 2020 2020  gion).          
-00017e20: 2020 7072 655f 7570 646f 776e 203d 2073    pre_updown = s
-00017e30: 656c 662e 646f 5f70 7265 6469 6374 696f  elf.do_predictio
-00017e40: 6e28 7061 7463 6865 732c 2063 7632 2e66  n(patches, cv2.f
-00017e50: 6c69 7028 696d 675b 3a2c 3a2c 3a5d 2c20  lip(img[:,:,:], 
-00017e60: 2d31 292c 206d 6f64 656c 5f72 6567 696f  -1), model_regio
-00017e70: 6e29 0a20 2020 2020 2020 2020 2020 2070  n).            p
-00017e80: 7265 5f75 7064 6f77 6e20 3d20 6376 322e  re_updown = cv2.
-00017e90: 666c 6970 2870 7265 5f75 7064 6f77 6e2c  flip(pre_updown,
-00017ea0: 202d 3129 0a20 2020 2020 2020 2020 2020   -1).           
-00017eb0: 200a 2020 2020 2020 2020 2020 2020 7072   .            pr
-00017ec0: 6564 6963 7469 6f6e 5f74 6162 6c65 5f66  ediction_table_f
-00017ed0: 756c 6c5f 6572 6f64 6520 3d20 6376 322e  ull_erode = cv2.
-00017ee0: 6572 6f64 6528 7072 655f 6675 6c6c 5b3a  erode(pre_full[:
-00017ef0: 2c3a 2c30 5d2c 204b 4552 4e45 4c2c 2069  ,:,0], KERNEL, i
-00017f00: 7465 7261 7469 6f6e 733d 3429 0a20 2020  terations=4).   
-00017f10: 2020 2020 2020 2020 2070 7265 6469 6374           predict
-00017f20: 696f 6e5f 7461 626c 655f 6675 6c6c 5f65  ion_table_full_e
-00017f30: 726f 6465 203d 2063 7632 2e64 696c 6174  rode = cv2.dilat
-00017f40: 6528 7072 6564 6963 7469 6f6e 5f74 6162  e(prediction_tab
-00017f50: 6c65 5f66 756c 6c5f 6572 6f64 652c 204b  le_full_erode, K
-00017f60: 4552 4e45 4c2c 2069 7465 7261 7469 6f6e  ERNEL, iteration
-00017f70: 733d 3429 0a20 2020 2020 2020 2020 2020  s=4).           
-00017f80: 200a 2020 2020 2020 2020 2020 2020 7072   .            pr
-00017f90: 6564 6963 7469 6f6e 5f74 6162 6c65 5f66  ediction_table_f
-00017fa0: 756c 6c5f 7570 646f 776e 5f65 726f 6465  ull_updown_erode
-00017fb0: 203d 2063 7632 2e65 726f 6465 2870 7265   = cv2.erode(pre
-00017fc0: 5f75 7064 6f77 6e5b 3a2c 3a2c 305d 2c20  _updown[:,:,0], 
-00017fd0: 4b45 524e 454c 2c20 6974 6572 6174 696f  KERNEL, iteratio
-00017fe0: 6e73 3d34 290a 2020 2020 2020 2020 2020  ns=4).          
-00017ff0: 2020 7072 6564 6963 7469 6f6e 5f74 6162    prediction_tab
-00018000: 6c65 5f66 756c 6c5f 7570 646f 776e 5f65  le_full_updown_e
-00018010: 726f 6465 203d 2063 7632 2e64 696c 6174  rode = cv2.dilat
-00018020: 6528 7072 6564 6963 7469 6f6e 5f74 6162  e(prediction_tab
-00018030: 6c65 5f66 756c 6c5f 7570 646f 776e 5f65  le_full_updown_e
-00018040: 726f 6465 2c20 4b45 524e 454c 2c20 6974  rode, KERNEL, it
-00018050: 6572 6174 696f 6e73 3d34 290a 0a20 2020  erations=4)..   
-00018060: 2020 2020 2020 2020 2070 7265 6469 6374           predict
-00018070: 696f 6e5f 7461 626c 655b 3a2c 303a 696d  ion_table[:,0:im
-00018080: 675f 775f 6861 6c66 2c3a 5d20 3d20 7072  g_w_half,:] = pr
-00018090: 6531 5b3a 2c3a 2c3a 5d0a 2020 2020 2020  e1[:,:,:].      
-000180a0: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
-000180b0: 5f74 6162 6c65 5b3a 2c69 6d67 5f77 5f68  _table[:,img_w_h
-000180c0: 616c 663a 2c3a 5d20 3d20 7072 6532 5b3a  alf:,:] = pre2[:
-000180d0: 2c3a 2c3a 5d0a 2020 2020 2020 2020 2020  ,:,:].          
-000180e0: 2020 0a20 2020 2020 2020 2020 2020 2070    .            p
-000180f0: 7265 6469 6374 696f 6e5f 7461 626c 655b  rediction_table[
-00018100: 3a2c 3a2c 305d 5b70 7265 6469 6374 696f  :,:,0][predictio
-00018110: 6e5f 7461 626c 655f 6675 6c6c 5f65 726f  n_table_full_ero
-00018120: 6465 5b3a 2c3a 5d3d 3d31 5d3d 310a 2020  de[:,:]==1]=1.  
-00018130: 2020 2020 2020 2020 2020 7072 6564 6963            predic
-00018140: 7469 6f6e 5f74 6162 6c65 5b3a 2c3a 2c30  tion_table[:,:,0
-00018150: 5d5b 7072 6564 6963 7469 6f6e 5f74 6162  ][prediction_tab
-00018160: 6c65 5f66 756c 6c5f 7570 646f 776e 5f65  le_full_updown_e
-00018170: 726f 6465 5b3a 2c3a 5d3d 3d31 5d3d 310a  rode[:,:]==1]=1.
-00018180: 2020 2020 2020 2020 2020 2020 7072 6564              pred
-00018190: 6963 7469 6f6e 5f74 6162 6c65 203d 2070  iction_table = p
-000181a0: 7265 6469 6374 696f 6e5f 7461 626c 652e  rediction_table.
-000181b0: 6173 7479 7065 286e 702e 696e 7431 3629  astype(np.int16)
-000181c0: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
-000181d0: 2020 2020 2020 2370 7265 6469 6374 696f        #predictio
-000181e0: 6e5f 7461 626c 655f 6572 6f64 6520 3d20  n_table_erode = 
-000181f0: 6376 322e 6572 6f64 6528 7072 6564 6963  cv2.erode(predic
-00018200: 7469 6f6e 5f74 6162 6c65 5b3a 2c3a 2c30  tion_table[:,:,0
-00018210: 5d2c 2073 656c 662e 6b65 726e 656c 2c20  ], self.kernel, 
-00018220: 6974 6572 6174 696f 6e73 3d36 290a 2020  iterations=6).  
-00018230: 2020 2020 2020 2370 7265 6469 6374 696f        #predictio
-00018240: 6e5f 7461 626c 655f 6572 6f64 6520 3d20  n_table_erode = 
-00018250: 6376 322e 6469 6c61 7465 2870 7265 6469  cv2.dilate(predi
-00018260: 6374 696f 6e5f 7461 626c 655f 6572 6f64  ction_table_erod
-00018270: 652c 2073 656c 662e 6b65 726e 656c 2c20  e, self.kernel, 
-00018280: 6974 6572 6174 696f 6e73 3d36 290a 2020  iterations=6).  
-00018290: 2020 2020 2020 0a20 2020 2020 2020 2070        .        p
-000182a0: 7265 6469 6374 696f 6e5f 7461 626c 655f  rediction_table_
-000182b0: 6572 6f64 6520 3d20 6376 322e 6572 6f64  erode = cv2.erod
-000182c0: 6528 7072 6564 6963 7469 6f6e 5f74 6162  e(prediction_tab
-000182d0: 6c65 5b3a 2c3a 2c30 5d2c 204b 4552 4e45  le[:,:,0], KERNE
-000182e0: 4c2c 2069 7465 7261 7469 6f6e 733d 3230  L, iterations=20
-000182f0: 290a 2020 2020 2020 2020 7072 6564 6963  ).        predic
-00018300: 7469 6f6e 5f74 6162 6c65 5f65 726f 6465  tion_table_erode
-00018310: 203d 2063 7632 2e64 696c 6174 6528 7072   = cv2.dilate(pr
-00018320: 6564 6963 7469 6f6e 5f74 6162 6c65 5f65  ediction_table_e
-00018330: 726f 6465 2c20 4b45 524e 454c 2c20 6974  rode, KERNEL, it
-00018340: 6572 6174 696f 6e73 3d32 3029 0a0a 2020  erations=20)..  
-00018350: 2020 2020 2020 7265 7475 726e 2070 7265        return pre
-00018360: 6469 6374 696f 6e5f 7461 626c 655f 6572  diction_table_er
-00018370: 6f64 652e 6173 7479 7065 286e 702e 696e  ode.astype(np.in
-00018380: 7431 3629 0a0a 2020 2020 6465 6620 7275  t16)..    def ru
-00018390: 6e5f 6772 6170 6869 6373 5f61 6e64 5f63  n_graphics_and_c
-000183a0: 6f6c 756d 6e73 2873 656c 662c 2074 6578  olumns(self, tex
-000183b0: 745f 7265 6769 6f6e 735f 705f 312c 206e  t_regions_p_1, n
-000183c0: 756d 5f63 6f6c 5f63 6c61 7373 6966 6965  um_col_classifie
-000183d0: 722c 206e 756d 5f63 6f6c 756d 6e5f 6973  r, num_column_is
-000183e0: 5f63 6c61 7373 6966 6965 642c 2065 726f  _classified, ero
-000183f0: 7369 6f6e 5f68 7572 7473 293a 0a20 2020  sion_hurts):.   
-00018400: 2020 2020 2069 6d67 5f67 203d 2073 656c       img_g = sel
-00018410: 662e 696d 7265 6164 2867 7261 7973 6361  f.imread(graysca
-00018420: 6c65 3d54 7275 652c 2075 696e 7438 3d54  le=True, uint8=T
-00018430: 7275 6529 0a0a 2020 2020 2020 2020 696d  rue)..        im
-00018440: 675f 6733 203d 206e 702e 7a65 726f 7328  g_g3 = np.zeros(
-00018450: 2869 6d67 5f67 2e73 6861 7065 5b30 5d2c  (img_g.shape[0],
-00018460: 2069 6d67 5f67 2e73 6861 7065 5b31 5d2c   img_g.shape[1],
-00018470: 2033 2929 0a20 2020 2020 2020 2069 6d67   3)).        img
-00018480: 5f67 3320 3d20 696d 675f 6733 2e61 7374  _g3 = img_g3.ast
-00018490: 7970 6528 6e70 2e75 696e 7438 290a 2020  ype(np.uint8).  
-000184a0: 2020 2020 2020 696d 675f 6733 5b3a 2c20        img_g3[:, 
-000184b0: 3a2c 2030 5d20 3d20 696d 675f 675b 3a2c  :, 0] = img_g[:,
-000184c0: 203a 5d0a 2020 2020 2020 2020 696d 675f   :].        img_
-000184d0: 6733 5b3a 2c20 3a2c 2031 5d20 3d20 696d  g3[:, :, 1] = im
-000184e0: 675f 675b 3a2c 203a 5d0a 2020 2020 2020  g_g[:, :].      
-000184f0: 2020 696d 675f 6733 5b3a 2c20 3a2c 2032    img_g3[:, :, 2
-00018500: 5d20 3d20 696d 675f 675b 3a2c 203a 5d0a  ] = img_g[:, :].
-00018510: 0a20 2020 2020 2020 2069 6d61 6765 5f70  .        image_p
-00018520: 6167 652c 2070 6167 655f 636f 6f72 642c  age, page_coord,
-00018530: 2063 6f6e 745f 7061 6765 203d 2073 656c   cont_page = sel
-00018540: 662e 6578 7472 6163 745f 7061 6765 2829  f.extract_page()
-00018550: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00018560: 2020 6966 2073 656c 662e 7461 626c 6573    if self.tables
-00018570: 3a0a 2020 2020 2020 2020 2020 2020 7461  :.            ta
-00018580: 626c 655f 7072 6564 6963 7469 6f6e 203d  ble_prediction =
-00018590: 2073 656c 662e 6765 745f 7461 626c 6573   self.get_tables
-000185a0: 5f66 726f 6d5f 6d6f 6465 6c28 696d 6167  _from_model(imag
-000185b0: 655f 7061 6765 2c20 6e75 6d5f 636f 6c5f  e_page, num_col_
-000185c0: 636c 6173 7369 6669 6572 290a 2020 2020  classifier).    
-000185d0: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-000185e0: 2020 2020 2020 7461 626c 655f 7072 6564        table_pred
-000185f0: 6963 7469 6f6e 203d 2028 6e70 2e7a 6572  iction = (np.zer
-00018600: 6f73 2828 696d 6167 655f 7061 6765 2e73  os((image_page.s
-00018610: 6861 7065 5b30 5d2c 2069 6d61 6765 5f70  hape[0], image_p
-00018620: 6167 652e 7368 6170 655b 315d 2929 292e  age.shape[1]))).
-00018630: 6173 7479 7065 286e 702e 696e 7431 3629  astype(np.int16)
-00018640: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-00018650: 2020 6966 2073 656c 662e 706c 6f74 7465    if self.plotte
-00018660: 723a 0a20 2020 2020 2020 2020 2020 2073  r:.            s
-00018670: 656c 662e 706c 6f74 7465 722e 7361 7665  elf.plotter.save
-00018680: 5f70 6167 655f 696d 6167 6528 696d 6167  _page_image(imag
-00018690: 655f 7061 6765 290a 0a20 2020 2020 2020  e_page)..       
-000186a0: 2074 6578 745f 7265 6769 6f6e 735f 705f   text_regions_p_
-000186b0: 3120 3d20 7465 7874 5f72 6567 696f 6e73  1 = text_regions
-000186c0: 5f70 5f31 5b70 6167 655f 636f 6f72 645b  _p_1[page_coord[
-000186d0: 305d 203a 2070 6167 655f 636f 6f72 645b  0] : page_coord[
-000186e0: 315d 2c20 7061 6765 5f63 6f6f 7264 5b32  1], page_coord[2
-000186f0: 5d20 3a20 7061 6765 5f63 6f6f 7264 5b33  ] : page_coord[3
-00018700: 5d5d 0a20 2020 2020 2020 206d 6173 6b5f  ]].        mask_
-00018710: 696d 6167 6573 203d 2028 7465 7874 5f72  images = (text_r
-00018720: 6567 696f 6e73 5f70 5f31 5b3a 2c20 3a5d  egions_p_1[:, :]
-00018730: 203d 3d20 3229 202a 2031 0a20 2020 2020   == 2) * 1.     
-00018740: 2020 206d 6173 6b5f 696d 6167 6573 203d     mask_images =
-00018750: 206d 6173 6b5f 696d 6167 6573 2e61 7374   mask_images.ast
-00018760: 7970 6528 6e70 2e75 696e 7438 290a 2020  ype(np.uint8).  
-00018770: 2020 2020 2020 6d61 736b 5f69 6d61 6765        mask_image
-00018780: 7320 3d20 6376 322e 6572 6f64 6528 6d61  s = cv2.erode(ma
-00018790: 736b 5f69 6d61 6765 735b 3a2c 203a 5d2c  sk_images[:, :],
-000187a0: 204b 4552 4e45 4c2c 2069 7465 7261 7469   KERNEL, iterati
-000187b0: 6f6e 733d 3130 290a 2020 2020 2020 2020  ons=10).        
-000187c0: 6d61 736b 5f6c 696e 6573 203d 2028 7465  mask_lines = (te
-000187d0: 7874 5f72 6567 696f 6e73 5f70 5f31 5b3a  xt_regions_p_1[:
-000187e0: 2c20 3a5d 203d 3d20 3329 202a 2031 0a20  , :] == 3) * 1. 
-000187f0: 2020 2020 2020 206d 6173 6b5f 6c69 6e65         mask_line
-00018800: 7320 3d20 6d61 736b 5f6c 696e 6573 2e61  s = mask_lines.a
-00018810: 7374 7970 6528 6e70 2e75 696e 7438 290a  stype(np.uint8).
-00018820: 2020 2020 2020 2020 696d 675f 6f6e 6c79          img_only
-00018830: 5f72 6567 696f 6e73 5f77 6974 685f 7365  _regions_with_se
-00018840: 7020 3d20 2828 7465 7874 5f72 6567 696f  p = ((text_regio
-00018850: 6e73 5f70 5f31 5b3a 2c20 3a5d 2021 3d20  ns_p_1[:, :] != 
-00018860: 3329 2026 2028 7465 7874 5f72 6567 696f  3) & (text_regio
-00018870: 6e73 5f70 5f31 5b3a 2c20 3a5d 2021 3d20  ns_p_1[:, :] != 
-00018880: 3029 2920 2a20 310a 2020 2020 2020 2020  0)) * 1.        
-00018890: 696d 675f 6f6e 6c79 5f72 6567 696f 6e73  img_only_regions
-000188a0: 5f77 6974 685f 7365 7020 3d20 696d 675f  _with_sep = img_
-000188b0: 6f6e 6c79 5f72 6567 696f 6e73 5f77 6974  only_regions_wit
-000188c0: 685f 7365 702e 6173 7479 7065 286e 702e  h_sep.astype(np.
-000188d0: 7569 6e74 3829 0a20 2020 2020 2020 200a  uint8).        .
-000188e0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-000188f0: 2069 6620 6572 6f73 696f 6e5f 6875 7274   if erosion_hurt
-00018900: 733a 0a20 2020 2020 2020 2020 2020 2069  s:.            i
-00018910: 6d67 5f6f 6e6c 795f 7265 6769 6f6e 7320  mg_only_regions 
-00018920: 3d20 6e70 2e63 6f70 7928 696d 675f 6f6e  = np.copy(img_on
-00018930: 6c79 5f72 6567 696f 6e73 5f77 6974 685f  ly_regions_with_
-00018940: 7365 705b 3a2c 3a5d 290a 2020 2020 2020  sep[:,:]).      
-00018950: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-00018960: 2020 2020 696d 675f 6f6e 6c79 5f72 6567      img_only_reg
-00018970: 696f 6e73 203d 2063 7632 2e65 726f 6465  ions = cv2.erode
-00018980: 2869 6d67 5f6f 6e6c 795f 7265 6769 6f6e  (img_only_region
-00018990: 735f 7769 7468 5f73 6570 5b3a 2c3a 5d2c  s_with_sep[:,:],
-000189a0: 204b 4552 4e45 4c2c 2069 7465 7261 7469   KERNEL, iterati
-000189b0: 6f6e 733d 3629 0a20 2020 2020 2020 2020  ons=6).         
-000189c0: 2020 200a 2020 2020 2020 2020 0a20 2020     .        .   
-000189d0: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
-000189e0: 2020 2020 2020 6e75 6d5f 636f 6c2c 205f        num_col, _
-000189f0: 203d 2066 696e 645f 6e75 6d5f 636f 6c28   = find_num_col(
-00018a00: 696d 675f 6f6e 6c79 5f72 6567 696f 6e73  img_only_regions
-00018a10: 2c20 6e75 6d5f 636f 6c5f 636c 6173 7369  , num_col_classi
-00018a20: 6669 6572 2c20 7365 6c66 2e74 6162 6c65  fier, self.table
-00018a30: 732c 206d 756c 7469 706c 6965 723d 362e  s, multiplier=6.
-00018a40: 3029 0a20 2020 2020 2020 2020 2020 206e  0).            n
-00018a50: 756d 5f63 6f6c 203d 206e 756d 5f63 6f6c  um_col = num_col
-00018a60: 202b 2031 0a20 2020 2020 2020 2020 2020   + 1.           
-00018a70: 2069 6620 6e6f 7420 6e75 6d5f 636f 6c75   if not num_colu
-00018a80: 6d6e 5f69 735f 636c 6173 7369 6669 6564  mn_is_classified
-00018a90: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-00018aa0: 2020 6e75 6d5f 636f 6c5f 636c 6173 7369    num_col_classi
-00018ab0: 6669 6572 203d 206e 756d 5f63 6f6c 202b  fier = num_col +
-00018ac0: 2031 0a20 2020 2020 2020 2065 7863 6570   1.        excep
-00018ad0: 7420 4578 6365 7074 696f 6e20 6173 2077  t Exception as w
-00018ae0: 6879 3a0a 2020 2020 2020 2020 2020 2020  hy:.            
-00018af0: 7365 6c66 2e6c 6f67 6765 722e 6572 726f  self.logger.erro
-00018b00: 7228 7768 7929 0a20 2020 2020 2020 2020  r(why).         
-00018b10: 2020 206e 756d 5f63 6f6c 203d 204e 6f6e     num_col = Non
-00018b20: 650a 2020 2020 2020 2020 7265 7475 726e  e.        return
-00018b30: 206e 756d 5f63 6f6c 2c20 6e75 6d5f 636f   num_col, num_co
-00018b40: 6c5f 636c 6173 7369 6669 6572 2c20 696d  l_classifier, im
-00018b50: 675f 6f6e 6c79 5f72 6567 696f 6e73 2c20  g_only_regions, 
-00018b60: 7061 6765 5f63 6f6f 7264 2c20 696d 6167  page_coord, imag
-00018b70: 655f 7061 6765 2c20 6d61 736b 5f69 6d61  e_page, mask_ima
-00018b80: 6765 732c 206d 6173 6b5f 6c69 6e65 732c  ges, mask_lines,
-00018b90: 2074 6578 745f 7265 6769 6f6e 735f 705f   text_regions_p_
-00018ba0: 312c 2063 6f6e 745f 7061 6765 2c20 7461  1, cont_page, ta
-00018bb0: 626c 655f 7072 6564 6963 7469 6f6e 0a0a  ble_prediction..
-00018bc0: 2020 2020 6465 6620 7275 6e5f 656e 6861      def run_enha
-00018bd0: 6e63 656d 656e 7428 7365 6c66 293a 0a20  ncement(self):. 
-00018be0: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
-00018bf0: 6572 2e69 6e66 6f28 2252 6573 697a 696e  er.info("Resizin
-00018c00: 6720 616e 6420 656e 6861 6e63 696e 6720  g and enhancing 
-00018c10: 696d 6167 652e 2e2e 2229 0a20 2020 2020  image...").     
-00018c20: 2020 2069 735f 696d 6167 655f 656e 6861     is_image_enha
-00018c30: 6e63 6564 2c20 696d 675f 6f72 672c 2069  nced, img_org, i
-00018c40: 6d67 5f72 6573 2c20 6e75 6d5f 636f 6c5f  mg_res, num_col_
-00018c50: 636c 6173 7369 6669 6572 2c20 6e75 6d5f  classifier, num_
-00018c60: 636f 6c75 6d6e 5f69 735f 636c 6173 7369  column_is_classi
-00018c70: 6669 6564 2c20 696d 675f 6269 6e20 3d20  fied, img_bin = 
-00018c80: 7365 6c66 2e72 6573 697a 655f 616e 645f  self.resize_and_
-00018c90: 656e 6861 6e63 655f 696d 6167 655f 7769  enhance_image_wi
-00018ca0: 7468 5f63 6f6c 756d 6e5f 636c 6173 7369  th_column_classi
-00018cb0: 6669 6572 2829 0a20 2020 2020 2020 2073  fier().        s
-00018cc0: 656c 662e 6c6f 6767 6572 2e69 6e66 6f28  elf.logger.info(
-00018cd0: 2249 6d61 6765 2077 6173 2025 7365 6e68  "Image was %senh
-00018ce0: 616e 6365 642e 222c 2027 2720 6966 2069  anced.", '' if i
-00018cf0: 735f 696d 6167 655f 656e 6861 6e63 6564  s_image_enhanced
-00018d00: 2065 6c73 6520 276e 6f74 2027 290a 0a20   else 'not ').. 
-00018d10: 2020 2020 2020 2073 6361 6c65 203d 2031         scale = 1
-00018d20: 0a20 2020 2020 2020 2069 6620 6973 5f69  .        if is_i
-00018d30: 6d61 6765 5f65 6e68 616e 6365 643a 0a20  mage_enhanced:. 
-00018d40: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00018d50: 6c66 2e61 6c6c 6f77 5f65 6e68 616e 6365  lf.allow_enhance
-00018d60: 6d65 6e74 3a0a 2020 2020 2020 2020 2020  ment:.          
-00018d70: 2020 2020 2020 696d 675f 7265 7320 3d20        img_res = 
-00018d80: 696d 675f 7265 732e 6173 7479 7065 286e  img_res.astype(n
-00018d90: 702e 7569 6e74 3829 0a20 2020 2020 2020  p.uint8).       
-00018da0: 2020 2020 2020 2020 2073 656c 662e 6765           self.ge
-00018db0: 745f 696d 6167 655f 616e 645f 7363 616c  t_image_and_scal
-00018dc0: 6573 2869 6d67 5f6f 7267 2c20 696d 675f  es(img_org, img_
-00018dd0: 7265 732c 2073 6361 6c65 290a 2020 2020  res, scale).    
-00018de0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
-00018df0: 656c 662e 706c 6f74 7465 723a 0a20 2020  elf.plotter:.   
-00018e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00018e10: 2073 656c 662e 706c 6f74 7465 722e 7361   self.plotter.sa
-00018e20: 7665 5f65 6e68 616e 6365 645f 696d 6167  ve_enhanced_imag
-00018e30: 6528 696d 675f 7265 7329 0a20 2020 2020  e(img_res).     
-00018e40: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-00018e50: 2020 2020 2020 2020 2020 2020 2073 656c               sel
-00018e60: 662e 6765 745f 696d 6167 655f 616e 645f  f.get_image_and_
-00018e70: 7363 616c 6573 5f61 6674 6572 5f65 6e68  scales_after_enh
-00018e80: 616e 6369 6e67 2869 6d67 5f6f 7267 2c20  ancing(img_org, 
-00018e90: 696d 675f 7265 7329 0a20 2020 2020 2020  img_res).       
-00018ea0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-00018eb0: 2020 2069 6620 7365 6c66 2e61 6c6c 6f77     if self.allow
-00018ec0: 5f65 6e68 616e 6365 6d65 6e74 3a0a 2020  _enhancement:.  
-00018ed0: 2020 2020 2020 2020 2020 2020 2020 7365                se
-00018ee0: 6c66 2e67 6574 5f69 6d61 6765 5f61 6e64  lf.get_image_and
-00018ef0: 5f73 6361 6c65 7328 696d 675f 6f72 672c  _scales(img_org,
-00018f00: 2069 6d67 5f72 6573 2c20 7363 616c 6529   img_res, scale)
-00018f10: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-00018f20: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-00018f30: 2020 2073 656c 662e 6765 745f 696d 6167     self.get_imag
-00018f40: 655f 616e 645f 7363 616c 6573 2869 6d67  e_and_scales(img
-00018f50: 5f6f 7267 2c20 696d 675f 7265 732c 2073  _org, img_res, s
-00018f60: 6361 6c65 290a 2020 2020 2020 2020 2020  cale).          
-00018f70: 2020 6966 2073 656c 662e 616c 6c6f 775f    if self.allow_
-00018f80: 7363 616c 696e 673a 0a20 2020 2020 2020  scaling:.       
-00018f90: 2020 2020 2020 2020 2069 6d67 5f6f 7267           img_org
-00018fa0: 2c20 696d 675f 7265 732c 2069 735f 696d  , img_res, is_im
-00018fb0: 6167 655f 656e 6861 6e63 6564 203d 2073  age_enhanced = s
-00018fc0: 656c 662e 7265 7369 7a65 5f69 6d61 6765  elf.resize_image
-00018fd0: 5f77 6974 685f 636f 6c75 6d6e 5f63 6c61  _with_column_cla
-00018fe0: 7373 6966 6965 7228 6973 5f69 6d61 6765  ssifier(is_image
-00018ff0: 5f65 6e68 616e 6365 642c 2069 6d67 5f62  _enhanced, img_b
-00019000: 696e 290a 2020 2020 2020 2020 2020 2020  in).            
-00019010: 2020 2020 7365 6c66 2e67 6574 5f69 6d61      self.get_ima
-00019020: 6765 5f61 6e64 5f73 6361 6c65 735f 6166  ge_and_scales_af
-00019030: 7465 725f 656e 6861 6e63 696e 6728 696d  ter_enhancing(im
-00019040: 675f 6f72 672c 2069 6d67 5f72 6573 290a  g_org, img_res).
-00019050: 2020 2020 2020 2020 7265 7475 726e 2069          return i
-00019060: 6d67 5f72 6573 2c20 6973 5f69 6d61 6765  mg_res, is_image
-00019070: 5f65 6e68 616e 6365 642c 206e 756d 5f63  _enhanced, num_c
-00019080: 6f6c 5f63 6c61 7373 6966 6965 722c 206e  ol_classifier, n
-00019090: 756d 5f63 6f6c 756d 6e5f 6973 5f63 6c61  um_column_is_cla
-000190a0: 7373 6966 6965 640a 0a20 2020 2064 6566  ssified..    def
-000190b0: 2072 756e 5f74 6578 746c 696e 6528 7365   run_textline(se
-000190c0: 6c66 2c20 696d 6167 655f 7061 6765 293a  lf, image_page):
-000190d0: 0a20 2020 2020 2020 2073 6361 6c65 725f  .        scaler_
-000190e0: 685f 7465 7874 6c69 6e65 203d 2031 2020  h_textline = 1  
-000190f0: 2320 312e 3223 312e 320a 2020 2020 2020  # 1.2#1.2.      
-00019100: 2020 7363 616c 6572 5f77 5f74 6578 746c    scaler_w_textl
-00019110: 696e 6520 3d20 3120 2023 2030 2e39 2331  ine = 1  # 0.9#1
-00019120: 0a20 2020 2020 2020 2074 6578 746c 696e  .        textlin
-00019130: 655f 6d61 736b 5f74 6f74 5f65 612c 205f  e_mask_tot_ea, _
-00019140: 203d 2073 656c 662e 7465 7874 6c69 6e65   = self.textline
-00019150: 5f63 6f6e 746f 7572 7328 696d 6167 655f  _contours(image_
-00019160: 7061 6765 2c20 5472 7565 2c20 7363 616c  page, True, scal
-00019170: 6572 5f68 5f74 6578 746c 696e 652c 2073  er_h_textline, s
-00019180: 6361 6c65 725f 775f 7465 7874 6c69 6e65  caler_w_textline
-00019190: 290a 0a20 2020 2020 2020 2069 6620 7365  )..        if se
-000191a0: 6c66 2e70 6c6f 7474 6572 3a0a 2020 2020  lf.plotter:.    
-000191b0: 2020 2020 2020 2020 7365 6c66 2e70 6c6f          self.plo
-000191c0: 7474 6572 2e73 6176 655f 706c 6f74 5f6f  tter.save_plot_o
-000191d0: 665f 7465 7874 6c69 6e65 7328 7465 7874  f_textlines(text
-000191e0: 6c69 6e65 5f6d 6173 6b5f 746f 745f 6561  line_mask_tot_ea
-000191f0: 2c20 696d 6167 655f 7061 6765 290a 2020  , image_page).  
-00019200: 2020 2020 2020 7265 7475 726e 2074 6578        return tex
-00019210: 746c 696e 655f 6d61 736b 5f74 6f74 5f65  tline_mask_tot_e
-00019220: 610a 0a20 2020 2064 6566 2072 756e 5f64  a..    def run_d
-00019230: 6573 6b65 7728 7365 6c66 2c20 7465 7874  eskew(self, text
-00019240: 6c69 6e65 5f6d 6173 6b5f 746f 745f 6561  line_mask_tot_ea
-00019250: 293a 0a20 2020 2020 2020 2073 6967 6d61  ):.        sigma
-00019260: 203d 2032 0a20 2020 2020 2020 206d 6169   = 2.        mai
-00019270: 6e5f 7061 6765 5f64 6573 6b65 7720 3d20  n_page_deskew = 
-00019280: 5472 7565 0a20 2020 2020 2020 2073 6c6f  True.        slo
-00019290: 7065 5f64 6573 6b65 7720 3d20 7265 7475  pe_deskew = retu
-000192a0: 726e 5f64 6573 6b65 775f 736c 6f70 2863  rn_deskew_slop(c
-000192b0: 7632 2e65 726f 6465 2874 6578 746c 696e  v2.erode(textlin
-000192c0: 655f 6d61 736b 5f74 6f74 5f65 612c 204b  e_mask_tot_ea, K
-000192d0: 4552 4e45 4c2c 2069 7465 7261 7469 6f6e  ERNEL, iteration
-000192e0: 733d 3229 2c20 7369 676d 612c 206d 6169  s=2), sigma, mai
-000192f0: 6e5f 7061 6765 5f64 6573 6b65 772c 2070  n_page_deskew, p
-00019300: 6c6f 7474 6572 3d73 656c 662e 706c 6f74  lotter=self.plot
-00019310: 7465 7229 0a20 2020 2020 2020 2073 6c6f  ter).        slo
-00019320: 7065 5f66 6972 7374 203d 2030 0a0a 2020  pe_first = 0..  
-00019330: 2020 2020 2020 6966 2073 656c 662e 706c        if self.pl
-00019340: 6f74 7465 723a 0a20 2020 2020 2020 2020  otter:.         
-00019350: 2020 2073 656c 662e 706c 6f74 7465 722e     self.plotter.
-00019360: 7361 7665 5f64 6573 6b65 7765 645f 696d  save_deskewed_im
-00019370: 6167 6528 736c 6f70 655f 6465 736b 6577  age(slope_deskew
-00019380: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
-00019390: 6f67 6765 722e 696e 666f 2822 736c 6f70  ogger.info("slop
-000193a0: 655f 6465 736b 6577 3a20 252e 3266 c2b0  e_deskew: %.2f..
-000193b0: 222c 2073 6c6f 7065 5f64 6573 6b65 7729  ", slope_deskew)
-000193c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
-000193d0: 736c 6f70 655f 6465 736b 6577 2c20 736c  slope_deskew, sl
-000193e0: 6f70 655f 6669 7273 740a 0a20 2020 2064  ope_first..    d
-000193f0: 6566 2072 756e 5f6d 6172 6769 6e61 6c73  ef run_marginals
-00019400: 2873 656c 662c 2069 6d61 6765 5f70 6167  (self, image_pag
-00019410: 652c 2074 6578 746c 696e 655f 6d61 736b  e, textline_mask
-00019420: 5f74 6f74 5f65 612c 206d 6173 6b5f 696d  _tot_ea, mask_im
-00019430: 6167 6573 2c20 6d61 736b 5f6c 696e 6573  ages, mask_lines
-00019440: 2c20 6e75 6d5f 636f 6c5f 636c 6173 7369  , num_col_classi
-00019450: 6669 6572 2c20 736c 6f70 655f 6465 736b  fier, slope_desk
-00019460: 6577 2c20 7465 7874 5f72 6567 696f 6e73  ew, text_regions
-00019470: 5f70 5f31 2c20 7461 626c 655f 7072 6564  _p_1, table_pred
-00019480: 6963 7469 6f6e 293a 0a20 2020 2020 2020  iction):.       
-00019490: 2069 6d61 6765 5f70 6167 655f 726f 7461   image_page_rota
-000194a0: 7465 642c 2074 6578 746c 696e 655f 6d61  ted, textline_ma
-000194b0: 736b 5f74 6f74 203d 2069 6d61 6765 5f70  sk_tot = image_p
-000194c0: 6167 655b 3a2c 203a 5d2c 2074 6578 746c  age[:, :], textl
-000194d0: 696e 655f 6d61 736b 5f74 6f74 5f65 615b  ine_mask_tot_ea[
-000194e0: 3a2c 203a 5d0a 2020 2020 2020 2020 7465  :, :].        te
-000194f0: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745b  xtline_mask_tot[
-00019500: 6d61 736b 5f69 6d61 6765 735b 3a2c 203a  mask_images[:, :
-00019510: 5d20 3d3d 2031 5d20 3d20 300a 0a20 2020  ] == 1] = 0..   
-00019520: 2020 2020 2074 6578 745f 7265 6769 6f6e       text_region
-00019530: 735f 705f 315b 6d61 736b 5f6c 696e 6573  s_p_1[mask_lines
-00019540: 5b3a 2c20 3a5d 203d 3d20 315d 203d 2033  [:, :] == 1] = 3
-00019550: 0a20 2020 2020 2020 2074 6578 745f 7265  .        text_re
-00019560: 6769 6f6e 735f 7020 3d20 7465 7874 5f72  gions_p = text_r
-00019570: 6567 696f 6e73 5f70 5f31 5b3a 2c20 3a5d  egions_p_1[:, :]
-00019580: 0a20 2020 2020 2020 2074 6578 745f 7265  .        text_re
-00019590: 6769 6f6e 735f 7020 3d20 6e70 2e61 7272  gions_p = np.arr
-000195a0: 6179 2874 6578 745f 7265 6769 6f6e 735f  ay(text_regions_
-000195b0: 7029 0a0a 2020 2020 2020 2020 6966 206e  p)..        if n
-000195c0: 756d 5f63 6f6c 5f63 6c61 7373 6966 6965  um_col_classifie
-000195d0: 7220 696e 2028 312c 2032 293a 0a20 2020  r in (1, 2):.   
-000195e0: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
-000195f0: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00019600: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
-00019610: 7061 7261 746f 7273 203d 2028 7465 7874  parators = (text
-00019620: 5f72 6567 696f 6e73 5f70 5b3a 2c20 3a5d  _regions_p[:, :]
-00019630: 203d 3d20 3129 202a 2031 0a20 2020 2020   == 1) * 1.     
-00019640: 2020 2020 2020 2020 2020 2069 6620 7365             if se
-00019650: 6c66 2e74 6162 6c65 733a 0a20 2020 2020  lf.tables:.     
-00019660: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00019670: 6567 696f 6e73 5f77 6974 686f 7574 5f73  egions_without_s
-00019680: 6570 6172 6174 6f72 735b 7461 626c 655f  eparators[table_
-00019690: 7072 6564 6963 7469 6f6e 3d3d 315d 203d  prediction==1] =
-000196a0: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
-000196b0: 2020 2072 6567 696f 6e73 5f77 6974 686f     regions_witho
-000196c0: 7574 5f73 6570 6172 6174 6f72 7320 3d20  ut_separators = 
-000196d0: 7265 6769 6f6e 735f 7769 7468 6f75 745f  regions_without_
-000196e0: 7365 7061 7261 746f 7273 2e61 7374 7970  separators.astyp
-000196f0: 6528 6e70 2e75 696e 7438 290a 2020 2020  e(np.uint8).    
-00019700: 2020 2020 2020 2020 2020 2020 7465 7874              text
-00019710: 5f72 6567 696f 6e73 5f70 203d 2067 6574  _regions_p = get
-00019720: 5f6d 6172 6769 6e61 6c73 2872 6f74 6174  _marginals(rotat
-00019730: 655f 696d 6167 6528 7265 6769 6f6e 735f  e_image(regions_
-00019740: 7769 7468 6f75 745f 7365 7061 7261 746f  without_separato
-00019750: 7273 2c20 736c 6f70 655f 6465 736b 6577  rs, slope_deskew
-00019760: 292c 2074 6578 745f 7265 6769 6f6e 735f  ), text_regions_
-00019770: 702c 206e 756d 5f63 6f6c 5f63 6c61 7373  p, num_col_class
-00019780: 6966 6965 722c 2073 6c6f 7065 5f64 6573  ifier, slope_des
-00019790: 6b65 772c 206b 6572 6e65 6c3d 4b45 524e  kew, kernel=KERN
-000197a0: 454c 290a 2020 2020 2020 2020 2020 2020  EL).            
-000197b0: 6578 6365 7074 2045 7863 6570 7469 6f6e  except Exception
-000197c0: 2061 7320 653a 0a20 2020 2020 2020 2020   as e:.         
-000197d0: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
-000197e0: 6572 2e65 7272 6f72 2822 6578 6365 7074  er.error("except
-000197f0: 696f 6e20 2573 222c 2065 290a 0a20 2020  ion %s", e)..   
-00019800: 2020 2020 2069 6620 7365 6c66 2e70 6c6f       if self.plo
-00019810: 7474 6572 3a0a 2020 2020 2020 2020 2020  tter:.          
-00019820: 2020 7365 6c66 2e70 6c6f 7474 6572 2e73    self.plotter.s
-00019830: 6176 655f 706c 6f74 5f6f 665f 6c61 796f  ave_plot_of_layo
-00019840: 7574 5f6d 6169 6e5f 616c 6c28 7465 7874  ut_main_all(text
-00019850: 5f72 6567 696f 6e73 5f70 2c20 696d 6167  _regions_p, imag
-00019860: 655f 7061 6765 290a 2020 2020 2020 2020  e_page).        
-00019870: 2020 2020 7365 6c66 2e70 6c6f 7474 6572      self.plotter
-00019880: 2e73 6176 655f 706c 6f74 5f6f 665f 6c61  .save_plot_of_la
-00019890: 796f 7574 5f6d 6169 6e28 7465 7874 5f72  yout_main(text_r
-000198a0: 6567 696f 6e73 5f70 2c20 696d 6167 655f  egions_p, image_
-000198b0: 7061 6765 290a 2020 2020 2020 2020 7265  page).        re
-000198c0: 7475 726e 2074 6578 746c 696e 655f 6d61  turn textline_ma
-000198d0: 736b 5f74 6f74 2c20 7465 7874 5f72 6567  sk_tot, text_reg
-000198e0: 696f 6e73 5f70 2c20 696d 6167 655f 7061  ions_p, image_pa
-000198f0: 6765 5f72 6f74 6174 6564 0a0a 2020 2020  ge_rotated..    
-00019900: 6465 6620 7275 6e5f 626f 7865 735f 6e6f  def run_boxes_no
-00019910: 5f66 756c 6c5f 6c61 796f 7574 2873 656c  _full_layout(sel
-00019920: 662c 2069 6d61 6765 5f70 6167 652c 2074  f, image_page, t
-00019930: 6578 746c 696e 655f 6d61 736b 5f74 6f74  extline_mask_tot
-00019940: 2c20 7465 7874 5f72 6567 696f 6e73 5f70  , text_regions_p
-00019950: 2c20 736c 6f70 655f 6465 736b 6577 2c20  , slope_deskew, 
-00019960: 6e75 6d5f 636f 6c5f 636c 6173 7369 6669  num_col_classifi
-00019970: 6572 2c20 7461 626c 655f 7072 6564 6963  er, table_predic
-00019980: 7469 6f6e 2c20 6572 6f73 696f 6e5f 6875  tion, erosion_hu
-00019990: 7274 7329 3a0a 2020 2020 2020 2020 7365  rts):.        se
-000199a0: 6c66 2e6c 6f67 6765 722e 6465 6275 6728  lf.logger.debug(
-000199b0: 2765 6e74 6572 2072 756e 5f62 6f78 6573  'enter run_boxes
-000199c0: 5f6e 6f5f 6675 6c6c 5f6c 6179 6f75 7427  _no_full_layout'
-000199d0: 290a 2020 2020 2020 2020 6966 206e 702e  ).        if np.
-000199e0: 6162 7328 736c 6f70 655f 6465 736b 6577  abs(slope_deskew
-000199f0: 2920 3e3d 2053 4c4f 5045 5f54 4852 4553  ) >= SLOPE_THRES
-00019a00: 484f 4c44 3a0a 2020 2020 2020 2020 2020  HOLD:.          
-00019a10: 2020 5f2c 2074 6578 746c 696e 655f 6d61    _, textline_ma
-00019a20: 736b 5f74 6f74 5f64 2c20 7465 7874 5f72  sk_tot_d, text_r
-00019a30: 6567 696f 6e73 5f70 5f31 5f6e 2c20 7461  egions_p_1_n, ta
-00019a40: 626c 655f 7072 6564 6963 7469 6f6e 5f6e  ble_prediction_n
-00019a50: 203d 2072 6f74 6174 696f 6e5f 6e6f 745f   = rotation_not_
-00019a60: 3930 5f66 756e 6328 696d 6167 655f 7061  90_func(image_pa
-00019a70: 6765 2c20 7465 7874 6c69 6e65 5f6d 6173  ge, textline_mas
-00019a80: 6b5f 746f 742c 2074 6578 745f 7265 6769  k_tot, text_regi
-00019a90: 6f6e 735f 702c 2074 6162 6c65 5f70 7265  ons_p, table_pre
-00019aa0: 6469 6374 696f 6e2c 2073 6c6f 7065 5f64  diction, slope_d
-00019ab0: 6573 6b65 7729 0a20 2020 2020 2020 2020  eskew).         
-00019ac0: 2020 2074 6578 745f 7265 6769 6f6e 735f     text_regions_
-00019ad0: 705f 315f 6e20 3d20 7265 7369 7a65 5f69  p_1_n = resize_i
-00019ae0: 6d61 6765 2874 6578 745f 7265 6769 6f6e  mage(text_region
-00019af0: 735f 705f 315f 6e2c 2074 6578 745f 7265  s_p_1_n, text_re
-00019b00: 6769 6f6e 735f 702e 7368 6170 655b 305d  gions_p.shape[0]
-00019b10: 2c20 7465 7874 5f72 6567 696f 6e73 5f70  , text_regions_p
-00019b20: 2e73 6861 7065 5b31 5d29 0a20 2020 2020  .shape[1]).     
-00019b30: 2020 2020 2020 2074 6578 746c 696e 655f         textline_
-00019b40: 6d61 736b 5f74 6f74 5f64 203d 2072 6573  mask_tot_d = res
-00019b50: 697a 655f 696d 6167 6528 7465 7874 6c69  ize_image(textli
-00019b60: 6e65 5f6d 6173 6b5f 746f 745f 642c 2074  ne_mask_tot_d, t
-00019b70: 6578 745f 7265 6769 6f6e 735f 702e 7368  ext_regions_p.sh
-00019b80: 6170 655b 305d 2c20 7465 7874 5f72 6567  ape[0], text_reg
-00019b90: 696f 6e73 5f70 2e73 6861 7065 5b31 5d29  ions_p.shape[1])
-00019ba0: 0a20 2020 2020 2020 2020 2020 2074 6162  .            tab
-00019bb0: 6c65 5f70 7265 6469 6374 696f 6e5f 6e20  le_prediction_n 
-00019bc0: 3d20 7265 7369 7a65 5f69 6d61 6765 2874  = resize_image(t
-00019bd0: 6162 6c65 5f70 7265 6469 6374 696f 6e5f  able_prediction_
-00019be0: 6e2c 2074 6578 745f 7265 6769 6f6e 735f  n, text_regions_
-00019bf0: 702e 7368 6170 655b 305d 2c20 7465 7874  p.shape[0], text
-00019c00: 5f72 6567 696f 6e73 5f70 2e73 6861 7065  _regions_p.shape
-00019c10: 5b31 5d29 0a20 2020 2020 2020 2020 2020  [1]).           
-00019c20: 2072 6567 696f 6e73 5f77 6974 686f 7574   regions_without
-00019c30: 5f73 6570 6172 6174 6f72 735f 6420 3d20  _separators_d = 
-00019c40: 2874 6578 745f 7265 6769 6f6e 735f 705f  (text_regions_p_
-00019c50: 315f 6e5b 3a2c 203a 5d20 3d3d 2031 2920  1_n[:, :] == 1) 
-00019c60: 2a20 310a 2020 2020 2020 2020 2020 2020  * 1.            
-00019c70: 6966 2073 656c 662e 7461 626c 6573 3a0a  if self.tables:.
-00019c80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00019c90: 7265 6769 6f6e 735f 7769 7468 6f75 745f  regions_without_
-00019ca0: 7365 7061 7261 746f 7273 5f64 5b74 6162  separators_d[tab
-00019cb0: 6c65 5f70 7265 6469 6374 696f 6e5f 6e5b  le_prediction_n[
-00019cc0: 3a2c 3a5d 203d 3d20 315d 203d 2031 0a20  :,:] == 1] = 1. 
-00019cd0: 2020 2020 2020 2072 6567 696f 6e73 5f77         regions_w
-00019ce0: 6974 686f 7574 5f73 6570 6172 6174 6f72  ithout_separator
-00019cf0: 7320 3d20 2874 6578 745f 7265 6769 6f6e  s = (text_region
-00019d00: 735f 705b 3a2c 203a 5d20 3d3d 2031 2920  s_p[:, :] == 1) 
-00019d10: 2a20 3120 2023 2028 2028 7465 7874 5f72  * 1  # ( (text_r
-00019d20: 6567 696f 6e73 5f70 5b3a 2c3a 5d3d 3d31  egions_p[:,:]==1
-00019d30: 2920 7c20 2874 6578 745f 7265 6769 6f6e  ) | (text_region
-00019d40: 735f 705b 3a2c 3a5d 3d3d 3229 2029 2a31  s_p[:,:]==2) )*1
-00019d50: 2023 7365 6c66 2e72 6574 7572 6e5f 7265   #self.return_re
-00019d60: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
-00019d70: 7061 7261 746f 7273 5f6e 6577 2874 6578  parators_new(tex
-00019d80: 745f 7265 6769 6f6e 735f 705b 3a2c 3a2c  t_regions_p[:,:,
-00019d90: 305d 2c69 6d67 5f6f 6e6c 795f 7265 6769  0],img_only_regi
-00019da0: 6f6e 7329 0a20 2020 2020 2020 2069 6620  ons).        if 
-00019db0: 7365 6c66 2e74 6162 6c65 733a 0a20 2020  self.tables:.   
-00019dc0: 2020 2020 2020 2020 2072 6567 696f 6e73           regions
-00019dd0: 5f77 6974 686f 7574 5f73 6570 6172 6174  _without_separat
-00019de0: 6f72 735b 7461 626c 655f 7072 6564 6963  ors[table_predic
-00019df0: 7469 6f6e 203d 3d31 205d 203d 2031 0a20  tion ==1 ] = 1. 
-00019e00: 2020 2020 2020 2069 6620 6e70 2e61 6273         if np.abs
-00019e10: 2873 6c6f 7065 5f64 6573 6b65 7729 203c  (slope_deskew) <
-00019e20: 2053 4c4f 5045 5f54 4852 4553 484f 4c44   SLOPE_THRESHOLD
-00019e30: 3a0a 2020 2020 2020 2020 2020 2020 7465  :.            te
-00019e40: 7874 5f72 6567 696f 6e73 5f70 5f31 5f6e  xt_regions_p_1_n
-00019e50: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
-00019e60: 2020 2020 7465 7874 6c69 6e65 5f6d 6173      textline_mas
-00019e70: 6b5f 746f 745f 6420 3d20 4e6f 6e65 0a20  k_tot_d = None. 
-00019e80: 2020 2020 2020 2020 2020 2072 6567 696f             regio
-00019e90: 6e73 5f77 6974 686f 7574 5f73 6570 6172  ns_without_separ
-00019ea0: 6174 6f72 735f 6420 3d20 4e6f 6e65 0a20  ators_d = None. 
-00019eb0: 2020 2020 2020 2070 6978 656c 5f6c 696e         pixel_lin
-00019ec0: 6573 203d 2033 0a20 2020 2020 2020 2069  es = 3.        i
-00019ed0: 6620 6e70 2e61 6273 2873 6c6f 7065 5f64  f np.abs(slope_d
-00019ee0: 6573 6b65 7729 203c 2053 4c4f 5045 5f54  eskew) < SLOPE_T
-00019ef0: 4852 4553 484f 4c44 3a0a 2020 2020 2020  HRESHOLD:.      
-00019f00: 2020 2020 2020 5f2c 205f 2c20 6d61 7472        _, _, matr
-00019f10: 6978 5f6f 665f 6c69 6e65 735f 6368 2c20  ix_of_lines_ch, 
-00019f20: 7370 6c69 7474 6572 5f79 5f6e 6577 2c20  splitter_y_new, 
-00019f30: 5f20 3d20 6669 6e64 5f6e 756d 6265 725f  _ = find_number_
-00019f40: 6f66 5f63 6f6c 756d 6e73 5f69 6e5f 646f  of_columns_in_do
-00019f50: 6375 6d65 6e74 286e 702e 7265 7065 6174  cument(np.repeat
-00019f60: 2874 6578 745f 7265 6769 6f6e 735f 705b  (text_regions_p[
-00019f70: 3a2c 203a 2c20 6e70 2e6e 6577 6178 6973  :, :, np.newaxis
-00019f80: 5d2c 2033 2c20 6178 6973 3d32 292c 206e  ], 3, axis=2), n
-00019f90: 756d 5f63 6f6c 5f63 6c61 7373 6966 6965  um_col_classifie
-00019fa0: 722c 2073 656c 662e 7461 626c 6573 2c20  r, self.tables, 
-00019fb0: 7069 7865 6c5f 6c69 6e65 7329 0a0a 2020  pixel_lines)..  
-00019fc0: 2020 2020 2020 6966 206e 702e 6162 7328        if np.abs(
-00019fd0: 736c 6f70 655f 6465 736b 6577 2920 3e3d  slope_deskew) >=
-00019fe0: 2053 4c4f 5045 5f54 4852 4553 484f 4c44   SLOPE_THRESHOLD
-00019ff0: 3a0a 2020 2020 2020 2020 2020 2020 5f2c  :.            _,
-0001a000: 205f 2c20 6d61 7472 6978 5f6f 665f 6c69   _, matrix_of_li
-0001a010: 6e65 735f 6368 5f64 2c20 7370 6c69 7474  nes_ch_d, splitt
-0001a020: 6572 5f79 5f6e 6577 5f64 2c20 5f20 3d20  er_y_new_d, _ = 
-0001a030: 6669 6e64 5f6e 756d 6265 725f 6f66 5f63  find_number_of_c
-0001a040: 6f6c 756d 6e73 5f69 6e5f 646f 6375 6d65  olumns_in_docume
-0001a050: 6e74 286e 702e 7265 7065 6174 2874 6578  nt(np.repeat(tex
-0001a060: 745f 7265 6769 6f6e 735f 705f 315f 6e5b  t_regions_p_1_n[
-0001a070: 3a2c 203a 2c20 6e70 2e6e 6577 6178 6973  :, :, np.newaxis
-0001a080: 5d2c 2033 2c20 6178 6973 3d32 292c 206e  ], 3, axis=2), n
-0001a090: 756d 5f63 6f6c 5f63 6c61 7373 6966 6965  um_col_classifie
-0001a0a0: 722c 2073 656c 662e 7461 626c 6573 2c20  r, self.tables, 
-0001a0b0: 7069 7865 6c5f 6c69 6e65 7329 0a0a 2020  pixel_lines)..  
-0001a0c0: 2020 2020 2020 7365 6c66 2e6c 6f67 6765        self.logge
-0001a0d0: 722e 696e 666f 2822 6e75 6d5f 636f 6c5f  r.info("num_col_
-0001a0e0: 636c 6173 7369 6669 6572 3a20 2573 222c  classifier: %s",
-0001a0f0: 206e 756d 5f63 6f6c 5f63 6c61 7373 6966   num_col_classif
-0001a100: 6965 7229 0a0a 2020 2020 2020 2020 6966  ier)..        if
-0001a110: 206e 756d 5f63 6f6c 5f63 6c61 7373 6966   num_col_classif
-0001a120: 6965 7220 3e3d 2033 3a0a 2020 2020 2020  ier >= 3:.      
-0001a130: 2020 2020 2020 6966 206e 702e 6162 7328        if np.abs(
-0001a140: 736c 6f70 655f 6465 736b 6577 2920 3c20  slope_deskew) < 
-0001a150: 534c 4f50 455f 5448 5245 5348 4f4c 443a  SLOPE_THRESHOLD:
-0001a160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001a170: 2072 6567 696f 6e73 5f77 6974 686f 7574   regions_without
-0001a180: 5f73 6570 6172 6174 6f72 7320 3d20 7265  _separators = re
-0001a190: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
-0001a1a0: 7061 7261 746f 7273 2e61 7374 7970 6528  parators.astype(
-0001a1b0: 6e70 2e75 696e 7438 290a 2020 2020 2020  np.uint8).      
-0001a1c0: 2020 2020 2020 2020 2020 7265 6769 6f6e            region
-0001a1d0: 735f 7769 7468 6f75 745f 7365 7061 7261  s_without_separa
-0001a1e0: 746f 7273 203d 2063 7632 2e65 726f 6465  tors = cv2.erode
-0001a1f0: 2872 6567 696f 6e73 5f77 6974 686f 7574  (regions_without
-0001a200: 5f73 6570 6172 6174 6f72 735b 3a2c 203a  _separators[:, :
-0001a210: 5d2c 204b 4552 4e45 4c2c 2069 7465 7261  ], KERNEL, itera
-0001a220: 7469 6f6e 733d 3629 0a20 2020 2020 2020  tions=6).       
-0001a230: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-0001a240: 2020 2020 2020 2020 2020 2072 6567 696f             regio
-0001a250: 6e73 5f77 6974 686f 7574 5f73 6570 6172  ns_without_separ
-0001a260: 6174 6f72 735f 6420 3d20 7265 6769 6f6e  ators_d = region
-0001a270: 735f 7769 7468 6f75 745f 7365 7061 7261  s_without_separa
-0001a280: 746f 7273 5f64 2e61 7374 7970 6528 6e70  tors_d.astype(np
-0001a290: 2e75 696e 7438 290a 2020 2020 2020 2020  .uint8).        
-0001a2a0: 2020 2020 2020 2020 7265 6769 6f6e 735f          regions_
-0001a2b0: 7769 7468 6f75 745f 7365 7061 7261 746f  without_separato
-0001a2c0: 7273 5f64 203d 2063 7632 2e65 726f 6465  rs_d = cv2.erode
-0001a2d0: 2872 6567 696f 6e73 5f77 6974 686f 7574  (regions_without
-0001a2e0: 5f73 6570 6172 6174 6f72 735f 645b 3a2c  _separators_d[:,
-0001a2f0: 203a 5d2c 204b 4552 4e45 4c2c 2069 7465   :], KERNEL, ite
-0001a300: 7261 7469 6f6e 733d 3629 0a20 2020 2020  rations=6).     
-0001a310: 2020 2074 3120 3d20 7469 6d65 2e74 696d     t1 = time.tim
-0001a320: 6528 290a 2020 2020 2020 2020 6966 206e  e().        if n
-0001a330: 702e 6162 7328 736c 6f70 655f 6465 736b  p.abs(slope_desk
-0001a340: 6577 2920 3c20 534c 4f50 455f 5448 5245  ew) < SLOPE_THRE
-0001a350: 5348 4f4c 443a 0a20 2020 2020 2020 2020  SHOLD:.         
-0001a360: 2020 2062 6f78 6573 2c20 7065 616b 735f     boxes, peaks_
-0001a370: 6e65 675f 746f 745f 7461 626c 6573 203d  neg_tot_tables =
-0001a380: 2072 6574 7572 6e5f 626f 7865 735f 6f66   return_boxes_of
-0001a390: 5f69 6d61 6765 735f 6279 5f6f 7264 6572  _images_by_order
-0001a3a0: 5f6f 665f 7265 6164 696e 675f 6e65 7728  _of_reading_new(
-0001a3b0: 7370 6c69 7474 6572 5f79 5f6e 6577 2c20  splitter_y_new, 
-0001a3c0: 7265 6769 6f6e 735f 7769 7468 6f75 745f  regions_without_
-0001a3d0: 7365 7061 7261 746f 7273 2c20 6d61 7472  separators, matr
-0001a3e0: 6978 5f6f 665f 6c69 6e65 735f 6368 2c20  ix_of_lines_ch, 
-0001a3f0: 6e75 6d5f 636f 6c5f 636c 6173 7369 6669  num_col_classifi
-0001a400: 6572 2c20 6572 6f73 696f 6e5f 6875 7274  er, erosion_hurt
-0001a410: 732c 2073 656c 662e 7461 626c 6573 290a  s, self.tables).
-0001a420: 2020 2020 2020 2020 2020 2020 626f 7865              boxe
-0001a430: 735f 6420 3d20 4e6f 6e65 0a20 2020 2020  s_d = None.     
-0001a440: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
-0001a450: 6572 2e64 6562 7567 2822 6c65 6e28 626f  er.debug("len(bo
-0001a460: 7865 7329 3a20 2573 222c 206c 656e 2862  xes): %s", len(b
-0001a470: 6f78 6573 2929 0a20 2020 2020 2020 2020  oxes)).         
-0001a480: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-0001a490: 7465 7874 5f72 6567 696f 6e73 5f70 5f74  text_regions_p_t
-0001a4a0: 6162 6c65 7320 3d20 6e70 2e63 6f70 7928  ables = np.copy(
-0001a4b0: 7465 7874 5f72 6567 696f 6e73 5f70 290a  text_regions_p).
-0001a4c0: 2020 2020 2020 2020 2020 2020 7465 7874              text
-0001a4d0: 5f72 6567 696f 6e73 5f70 5f74 6162 6c65  _regions_p_table
-0001a4e0: 735b 3a2c 3a5d 5b28 7461 626c 655f 7072  s[:,:][(table_pr
-0001a4f0: 6564 6963 7469 6f6e 5b3a 2c3a 5d20 3d3d  ediction[:,:] ==
-0001a500: 2031 295d 203d 2031 300a 2020 2020 2020   1)] = 10.      
-0001a510: 2020 2020 2020 7069 7865 6c5f 6c69 6e65        pixel_line
-0001a520: 203d 2033 0a20 2020 2020 2020 2020 2020   = 3.           
-0001a530: 2069 6d67 5f72 6576 6973 6564 5f74 6162   img_revised_tab
-0001a540: 3220 3d20 7365 6c66 2e61 6464 5f74 6162  2 = self.add_tab
-0001a550: 6c65 735f 6865 7572 6973 7469 635f 746f  les_heuristic_to
-0001a560: 5f6c 6179 6f75 7428 7465 7874 5f72 6567  _layout(text_reg
-0001a570: 696f 6e73 5f70 5f74 6162 6c65 732c 2062  ions_p_tables, b
-0001a580: 6f78 6573 2c20 302c 2073 706c 6974 7465  oxes, 0, splitte
-0001a590: 725f 795f 6e65 772c 2070 6561 6b73 5f6e  r_y_new, peaks_n
-0001a5a0: 6567 5f74 6f74 5f74 6162 6c65 732c 2074  eg_tot_tables, t
-0001a5b0: 6578 745f 7265 6769 6f6e 735f 705f 7461  ext_regions_p_ta
-0001a5c0: 626c 6573 202c 206e 756d 5f63 6f6c 5f63  bles , num_col_c
-0001a5d0: 6c61 7373 6966 6965 7220 2c20 302e 3030  lassifier , 0.00
-0001a5e0: 3030 3035 2c20 7069 7865 6c5f 6c69 6e65  0005, pixel_line
-0001a5f0: 290a 2020 2020 2020 2020 2020 2020 696d  ).            im
-0001a600: 675f 7265 7669 7365 645f 7461 6232 2c20  g_revised_tab2, 
-0001a610: 636f 6e74 6f75 7265 735f 7461 626c 6573  contoures_tables
-0001a620: 203d 2073 656c 662e 6368 6563 6b5f 696f   = self.check_io
-0001a630: 755f 6f66 5f62 6f75 6e64 696e 675f 626f  u_of_bounding_bo
-0001a640: 785f 616e 645f 636f 6e74 6f75 725f 666f  x_and_contour_fo
-0001a650: 725f 7461 626c 6573 2869 6d67 5f72 6576  r_tables(img_rev
-0001a660: 6973 6564 5f74 6162 322c 7461 626c 655f  ised_tab2,table_
-0001a670: 7072 6564 6963 7469 6f6e 2c20 3130 2c20  prediction, 10, 
-0001a680: 6e75 6d5f 636f 6c5f 636c 6173 7369 6669  num_col_classifi
-0001a690: 6572 290a 2020 2020 2020 2020 656c 7365  er).        else
-0001a6a0: 3a0a 2020 2020 2020 2020 2020 2020 626f  :.            bo
-0001a6b0: 7865 735f 642c 2070 6561 6b73 5f6e 6567  xes_d, peaks_neg
-0001a6c0: 5f74 6f74 5f74 6162 6c65 735f 6420 3d20  _tot_tables_d = 
-0001a6d0: 7265 7475 726e 5f62 6f78 6573 5f6f 665f  return_boxes_of_
-0001a6e0: 696d 6167 6573 5f62 795f 6f72 6465 725f  images_by_order_
-0001a6f0: 6f66 5f72 6561 6469 6e67 5f6e 6577 2873  of_reading_new(s
-0001a700: 706c 6974 7465 725f 795f 6e65 775f 642c  plitter_y_new_d,
-0001a710: 2072 6567 696f 6e73 5f77 6974 686f 7574   regions_without
-0001a720: 5f73 6570 6172 6174 6f72 735f 642c 206d  _separators_d, m
-0001a730: 6174 7269 785f 6f66 5f6c 696e 6573 5f63  atrix_of_lines_c
-0001a740: 685f 642c 206e 756d 5f63 6f6c 5f63 6c61  h_d, num_col_cla
-0001a750: 7373 6966 6965 722c 2065 726f 7369 6f6e  ssifier, erosion
-0001a760: 5f68 7572 7473 2c20 7365 6c66 2e74 6162  _hurts, self.tab
-0001a770: 6c65 7329 0a20 2020 2020 2020 2020 2020  les).           
-0001a780: 2062 6f78 6573 203d 204e 6f6e 650a 2020   boxes = None.  
-0001a790: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-0001a7a0: 6f67 6765 722e 6465 6275 6728 226c 656e  ogger.debug("len
-0001a7b0: 2862 6f78 6573 293a 2025 7322 2c20 6c65  (boxes): %s", le
-0001a7c0: 6e28 626f 7865 735f 6429 290a 2020 2020  n(boxes_d)).    
-0001a7d0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0001a7e0: 2020 2020 2074 6578 745f 7265 6769 6f6e       text_region
-0001a7f0: 735f 705f 7461 626c 6573 203d 206e 702e  s_p_tables = np.
-0001a800: 636f 7079 2874 6578 745f 7265 6769 6f6e  copy(text_region
-0001a810: 735f 705f 315f 6e29 0a20 2020 2020 2020  s_p_1_n).       
-0001a820: 2020 2020 2074 6578 745f 7265 6769 6f6e       text_region
-0001a830: 735f 705f 7461 626c 6573 203d 6e70 2e72  s_p_tables =np.r
-0001a840: 6f75 6e64 2874 6578 745f 7265 6769 6f6e  ound(text_region
-0001a850: 735f 705f 7461 626c 6573 290a 2020 2020  s_p_tables).    
-0001a860: 2020 2020 2020 2020 7465 7874 5f72 6567          text_reg
-0001a870: 696f 6e73 5f70 5f74 6162 6c65 735b 3a2c  ions_p_tables[:,
-0001a880: 3a5d 5b28 7465 7874 5f72 6567 696f 6e73  :][(text_regions
-0001a890: 5f70 5f74 6162 6c65 735b 3a2c 3a5d 2021  _p_tables[:,:] !
-0001a8a0: 3d20 3329 2026 2028 7461 626c 655f 7072  = 3) & (table_pr
-0001a8b0: 6564 6963 7469 6f6e 5f6e 5b3a 2c3a 5d20  ediction_n[:,:] 
-0001a8c0: 3d3d 2031 295d 203d 2031 300a 2020 2020  == 1)] = 10.    
-0001a8d0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0001a8e0: 2020 2020 2070 6978 656c 5f6c 696e 6520       pixel_line 
-0001a8f0: 3d20 330a 2020 2020 2020 2020 2020 2020  = 3.            
-0001a900: 696d 675f 7265 7669 7365 645f 7461 6232  img_revised_tab2
-0001a910: 203d 2073 656c 662e 6164 645f 7461 626c   = self.add_tabl
-0001a920: 6573 5f68 6575 7269 7374 6963 5f74 6f5f  es_heuristic_to_
-0001a930: 6c61 796f 7574 2874 6578 745f 7265 6769  layout(text_regi
-0001a940: 6f6e 735f 705f 7461 626c 6573 2c62 6f78  ons_p_tables,box
-0001a950: 6573 5f64 2c30 2c73 706c 6974 7465 725f  es_d,0,splitter_
-0001a960: 795f 6e65 775f 642c 7065 616b 735f 6e65  y_new_d,peaks_ne
-0001a970: 675f 746f 745f 7461 626c 6573 5f64 2c74  g_tot_tables_d,t
-0001a980: 6578 745f 7265 6769 6f6e 735f 705f 7461  ext_regions_p_ta
-0001a990: 626c 6573 2c20 6e75 6d5f 636f 6c5f 636c  bles, num_col_cl
-0001a9a0: 6173 7369 6669 6572 2c20 302e 3030 3030  assifier, 0.0000
-0001a9b0: 3035 2c20 7069 7865 6c5f 6c69 6e65 290a  05, pixel_line).
-0001a9c0: 2020 2020 2020 2020 2020 2020 696d 675f              img_
-0001a9d0: 7265 7669 7365 645f 7461 6232 5f64 2c5f  revised_tab2_d,_
-0001a9e0: 203d 2073 656c 662e 6368 6563 6b5f 696f   = self.check_io
-0001a9f0: 755f 6f66 5f62 6f75 6e64 696e 675f 626f  u_of_bounding_bo
-0001aa00: 785f 616e 645f 636f 6e74 6f75 725f 666f  x_and_contour_fo
-0001aa10: 725f 7461 626c 6573 2869 6d67 5f72 6576  r_tables(img_rev
-0001aa20: 6973 6564 5f74 6162 322c 7461 626c 655f  ised_tab2,table_
-0001aa30: 7072 6564 6963 7469 6f6e 5f6e 2c20 3130  prediction_n, 10
-0001aa40: 2c20 6e75 6d5f 636f 6c5f 636c 6173 7369  , num_col_classi
-0001aa50: 6669 6572 290a 2020 2020 2020 2020 2020  fier).          
-0001aa60: 2020 0a20 2020 2020 2020 2020 2020 2069    .            i
-0001aa70: 6d67 5f72 6576 6973 6564 5f74 6162 325f  mg_revised_tab2_
-0001aa80: 645f 726f 7461 7465 6420 3d20 726f 7461  d_rotated = rota
-0001aa90: 7465 5f69 6d61 6765 2869 6d67 5f72 6576  te_image(img_rev
-0001aaa0: 6973 6564 5f74 6162 325f 642c 202d 736c  ised_tab2_d, -sl
-0001aab0: 6f70 655f 6465 736b 6577 290a 2020 2020  ope_deskew).    
-0001aac0: 2020 2020 2020 2020 696d 675f 7265 7669          img_revi
-0001aad0: 7365 645f 7461 6232 5f64 5f72 6f74 6174  sed_tab2_d_rotat
-0001aae0: 6564 203d 206e 702e 726f 756e 6428 696d  ed = np.round(im
-0001aaf0: 675f 7265 7669 7365 645f 7461 6232 5f64  g_revised_tab2_d
-0001ab00: 5f72 6f74 6174 6564 290a 2020 2020 2020  _rotated).      
-0001ab10: 2020 2020 2020 696d 675f 7265 7669 7365        img_revise
-0001ab20: 645f 7461 6232 5f64 5f72 6f74 6174 6564  d_tab2_d_rotated
-0001ab30: 203d 2069 6d67 5f72 6576 6973 6564 5f74   = img_revised_t
-0001ab40: 6162 325f 645f 726f 7461 7465 642e 6173  ab2_d_rotated.as
-0001ab50: 7479 7065 286e 702e 696e 7438 290a 2020  type(np.int8).  
-0001ab60: 2020 2020 2020 2020 2020 696d 675f 7265            img_re
-0001ab70: 7669 7365 645f 7461 6232 5f64 5f72 6f74  vised_tab2_d_rot
-0001ab80: 6174 6564 203d 2072 6573 697a 655f 696d  ated = resize_im
-0001ab90: 6167 6528 696d 675f 7265 7669 7365 645f  age(img_revised_
-0001aba0: 7461 6232 5f64 5f72 6f74 6174 6564 2c20  tab2_d_rotated, 
-0001abb0: 7465 7874 5f72 6567 696f 6e73 5f70 2e73  text_regions_p.s
-0001abc0: 6861 7065 5b30 5d2c 2074 6578 745f 7265  hape[0], text_re
-0001abd0: 6769 6f6e 735f 702e 7368 6170 655b 315d  gions_p.shape[1]
-0001abe0: 290a 0a20 2020 2020 2020 2073 656c 662e  )..        self.
-0001abf0: 6c6f 6767 6572 2e69 6e66 6f28 2264 6574  logger.info("det
-0001ac00: 6563 7469 6e67 2062 6f78 6573 2074 6f6f  ecting boxes too
-0001ac10: 6b20 252e 3166 7322 2c20 7469 6d65 2e74  k %.1fs", time.t
-0001ac20: 696d 6528 2920 2d20 7431 290a 2020 2020  ime() - t1).    
-0001ac30: 2020 2020 0a20 2020 2020 2020 2069 6620      .        if 
-0001ac40: 7365 6c66 2e74 6162 6c65 733a 0a20 2020  self.tables:.   
-0001ac50: 2020 2020 2020 2020 2069 6620 6e70 2e61           if np.a
-0001ac60: 6273 2873 6c6f 7065 5f64 6573 6b65 7729  bs(slope_deskew)
-0001ac70: 203c 2053 4c4f 5045 5f54 4852 4553 484f   < SLOPE_THRESHO
-0001ac80: 4c44 3a0a 2020 2020 2020 2020 2020 2020  LD:.            
-0001ac90: 2020 2020 696d 675f 7265 7669 7365 645f      img_revised_
-0001aca0: 7461 6220 3d20 6e70 2e63 6f70 7928 696d  tab = np.copy(im
-0001acb0: 675f 7265 7669 7365 645f 7461 6232 5b3a  g_revised_tab2[:
-0001acc0: 2c3a 2c30 5d29 0a20 2020 2020 2020 2020  ,:,0]).         
-0001acd0: 2020 2020 2020 2069 6d67 5f72 6576 6973         img_revis
-0001ace0: 6564 5f74 6162 5b3a 2c3a 5d5b 2874 6578  ed_tab[:,:][(tex
-0001acf0: 745f 7265 6769 6f6e 735f 705b 3a2c 3a5d  t_regions_p[:,:]
-0001ad00: 203d 3d20 3129 2026 2028 696d 675f 7265   == 1) & (img_re
-0001ad10: 7669 7365 645f 7461 625b 3a2c 3a5d 2021  vised_tab[:,:] !
-0001ad20: 3d20 3130 295d 203d 2031 0a20 2020 2020  = 10)] = 1.     
-0001ad30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
-0001ad40: 2020 2020 2020 2020 2020 2020 2069 6d67               img
-0001ad50: 5f72 6576 6973 6564 5f74 6162 203d 206e  _revised_tab = n
-0001ad60: 702e 636f 7079 2874 6578 745f 7265 6769  p.copy(text_regi
-0001ad70: 6f6e 735f 705b 3a2c 3a5d 290a 2020 2020  ons_p[:,:]).    
-0001ad80: 2020 2020 2020 2020 2020 2020 696d 675f              img_
-0001ad90: 7265 7669 7365 645f 7461 625b 3a2c 3a5d  revised_tab[:,:]
-0001ada0: 5b69 6d67 5f72 6576 6973 6564 5f74 6162  [img_revised_tab
-0001adb0: 5b3a 2c3a 5d20 3d3d 2031 305d 203d 2030  [:,:] == 10] = 0
-0001adc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001add0: 2069 6d67 5f72 6576 6973 6564 5f74 6162   img_revised_tab
-0001ade0: 5b3a 2c3a 5d5b 696d 675f 7265 7669 7365  [:,:][img_revise
-0001adf0: 645f 7461 6232 5f64 5f72 6f74 6174 6564  d_tab2_d_rotated
-0001ae00: 5b3a 2c3a 2c30 5d20 3d3d 2031 305d 203d  [:,:,0] == 10] =
-0001ae10: 2031 300a 2020 2020 2020 2020 2020 2020   10.            
-0001ae20: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-0001ae30: 2074 6578 745f 7265 6769 6f6e 735f 705b   text_regions_p[
-0001ae40: 3a2c 3a5d 5b74 6578 745f 7265 6769 6f6e  :,:][text_region
-0001ae50: 735f 705b 3a2c 3a5d 3d3d 3130 5d20 3d20  s_p[:,:]==10] = 
-0001ae60: 300a 2020 2020 2020 2020 2020 2020 7465  0.            te
-0001ae70: 7874 5f72 6567 696f 6e73 5f70 5b3a 2c3a  xt_regions_p[:,:
-0001ae80: 5d5b 696d 675f 7265 7669 7365 645f 7461  ][img_revised_ta
-0001ae90: 625b 3a2c 3a5d 3d3d 3130 5d20 3d20 3130  b[:,:]==10] = 10
-0001aea0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001aeb0: 2020 2020 2020 2020 2020 2069 6d67 5f72             img_r
-0001aec0: 6576 6973 6564 5f74 6162 3d74 6578 745f  evised_tab=text_
-0001aed0: 7265 6769 6f6e 735f 705b 3a2c 3a5d 0a20  regions_p[:,:]. 
-0001aee0: 2020 2020 2020 2023 696d 675f 7265 7669         #img_revi
-0001aef0: 7365 645f 7461 6220 3d20 7465 7874 5f72  sed_tab = text_r
-0001af00: 6567 696f 6e73 5f70 5b3a 2c20 3a5d 0a20  egions_p[:, :]. 
-0001af10: 2020 2020 2020 2070 6f6c 7967 6f6e 735f         polygons_
-0001af20: 6f66 5f69 6d61 6765 7320 3d20 7265 7475  of_images = retu
-0001af30: 726e 5f63 6f6e 746f 7572 735f 6f66 5f69  rn_contours_of_i
-0001af40: 6e74 6572 6573 7465 645f 7265 6769 6f6e  nterested_region
-0001af50: 2869 6d67 5f72 6576 6973 6564 5f74 6162  (img_revised_tab
-0001af60: 2c20 3229 0a0a 2020 2020 2020 2020 7069  , 2)..        pi
-0001af70: 7865 6c5f 696d 6720 3d20 340a 2020 2020  xel_img = 4.    
-0001af80: 2020 2020 6d69 6e5f 6172 6561 5f6d 6172      min_area_mar
-0001af90: 203d 2030 2e30 3030 3031 0a20 2020 2020   = 0.00001.     
-0001afa0: 2020 2070 6f6c 7967 6f6e 735f 6f66 5f6d     polygons_of_m
-0001afb0: 6172 6769 6e61 6c73 203d 2072 6574 7572  arginals = retur
-0001afc0: 6e5f 636f 6e74 6f75 7273 5f6f 665f 696e  n_contours_of_in
-0001afd0: 7465 7265 7374 6564 5f72 6567 696f 6e28  terested_region(
-0001afe0: 7465 7874 5f72 6567 696f 6e73 5f70 2c20  text_regions_p, 
-0001aff0: 7069 7865 6c5f 696d 672c 206d 696e 5f61  pixel_img, min_a
-0001b000: 7265 615f 6d61 7229 0a20 2020 2020 2020  rea_mar).       
-0001b010: 200a 2020 2020 2020 2020 7069 7865 6c5f   .        pixel_
-0001b020: 696d 6720 3d20 3130 0a20 2020 2020 2020  img = 10.       
-0001b030: 2063 6f6e 746f 7572 735f 7461 626c 6573   contours_tables
-0001b040: 203d 2072 6574 7572 6e5f 636f 6e74 6f75   = return_contou
-0001b050: 7273 5f6f 665f 696e 7465 7265 7374 6564  rs_of_interested
-0001b060: 5f72 6567 696f 6e28 7465 7874 5f72 6567  _region(text_reg
-0001b070: 696f 6e73 5f70 2c20 7069 7865 6c5f 696d  ions_p, pixel_im
-0001b080: 672c 206d 696e 5f61 7265 615f 6d61 7229  g, min_area_mar)
-0001b090: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-0001b0a0: 2020 0a20 2020 2020 2020 2073 656c 662e    .        self.
-0001b0b0: 6c6f 6767 6572 2e64 6562 7567 2827 6578  logger.debug('ex
-0001b0c0: 6974 2072 756e 5f62 6f78 6573 5f6e 6f5f  it run_boxes_no_
-0001b0d0: 6675 6c6c 5f6c 6179 6f75 7427 290a 2020  full_layout').  
-0001b0e0: 2020 2020 2020 7265 7475 726e 2070 6f6c        return pol
-0001b0f0: 7967 6f6e 735f 6f66 5f69 6d61 6765 732c  ygons_of_images,
-0001b100: 2069 6d67 5f72 6576 6973 6564 5f74 6162   img_revised_tab
-0001b110: 2c20 7465 7874 5f72 6567 696f 6e73 5f70  , text_regions_p
-0001b120: 5f31 5f6e 2c20 7465 7874 6c69 6e65 5f6d  _1_n, textline_m
-0001b130: 6173 6b5f 746f 745f 642c 2072 6567 696f  ask_tot_d, regio
-0001b140: 6e73 5f77 6974 686f 7574 5f73 6570 6172  ns_without_separ
-0001b150: 6174 6f72 735f 642c 2062 6f78 6573 2c20  ators_d, boxes, 
-0001b160: 626f 7865 735f 642c 2070 6f6c 7967 6f6e  boxes_d, polygon
-0001b170: 735f 6f66 5f6d 6172 6769 6e61 6c73 2c20  s_of_marginals, 
-0001b180: 636f 6e74 6f75 7273 5f74 6162 6c65 730a  contours_tables.
-0001b190: 0a20 2020 2064 6566 2072 756e 5f62 6f78  .    def run_box
-0001b1a0: 6573 5f66 756c 6c5f 6c61 796f 7574 2873  es_full_layout(s
-0001b1b0: 656c 662c 2069 6d61 6765 5f70 6167 652c  elf, image_page,
-0001b1c0: 2074 6578 746c 696e 655f 6d61 736b 5f74   textline_mask_t
-0001b1d0: 6f74 2c20 7465 7874 5f72 6567 696f 6e73  ot, text_regions
-0001b1e0: 5f70 2c20 736c 6f70 655f 6465 736b 6577  _p, slope_deskew
-0001b1f0: 2c20 6e75 6d5f 636f 6c5f 636c 6173 7369  , num_col_classi
-0001b200: 6669 6572 2c20 696d 675f 6f6e 6c79 5f72  fier, img_only_r
-0001b210: 6567 696f 6e73 2c20 7461 626c 655f 7072  egions, table_pr
-0001b220: 6564 6963 7469 6f6e 2c20 6572 6f73 696f  ediction, erosio
-0001b230: 6e5f 6875 7274 7329 3a0a 2020 2020 2020  n_hurts):.      
-0001b240: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
-0001b250: 6275 6728 2765 6e74 6572 2072 756e 5f62  bug('enter run_b
-0001b260: 6f78 6573 5f66 756c 6c5f 6c61 796f 7574  oxes_full_layout
-0001b270: 2729 0a20 2020 2020 2020 200a 2020 2020  ').        .    
-0001b280: 2020 2020 6966 2073 656c 662e 7461 626c      if self.tabl
-0001b290: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
-0001b2a0: 6966 206e 702e 6162 7328 736c 6f70 655f  if np.abs(slope_
-0001b2b0: 6465 736b 6577 2920 3e3d 2053 4c4f 5045  deskew) >= SLOPE
-0001b2c0: 5f54 4852 4553 484f 4c44 3a0a 2020 2020  _THRESHOLD:.    
-0001b2d0: 2020 2020 2020 2020 2020 2020 696d 6167              imag
-0001b2e0: 655f 7061 6765 5f72 6f74 6174 6564 5f6e  e_page_rotated_n
-0001b2f0: 2c74 6578 746c 696e 655f 6d61 736b 5f74  ,textline_mask_t
-0001b300: 6f74 5f64 2c74 6578 745f 7265 6769 6f6e  ot_d,text_region
-0001b310: 735f 705f 315f 6e20 2c20 7461 626c 655f  s_p_1_n , table_
-0001b320: 7072 6564 6963 7469 6f6e 5f6e 203d 2072  prediction_n = r
-0001b330: 6f74 6174 696f 6e5f 6e6f 745f 3930 5f66  otation_not_90_f
-0001b340: 756e 6328 696d 6167 655f 7061 6765 2c20  unc(image_page, 
-0001b350: 7465 7874 6c69 6e65 5f6d 6173 6b5f 746f  textline_mask_to
-0001b360: 742c 2074 6578 745f 7265 6769 6f6e 735f  t, text_regions_
-0001b370: 702c 2074 6162 6c65 5f70 7265 6469 6374  p, table_predict
-0001b380: 696f 6e2c 2073 6c6f 7065 5f64 6573 6b65  ion, slope_deske
-0001b390: 7729 0a20 2020 2020 2020 2020 2020 2020  w).             
-0001b3a0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-0001b3b0: 2020 2020 7465 7874 5f72 6567 696f 6e73      text_regions
-0001b3c0: 5f70 5f31 5f6e 203d 2072 6573 697a 655f  _p_1_n = resize_
-0001b3d0: 696d 6167 6528 7465 7874 5f72 6567 696f  image(text_regio
-0001b3e0: 6e73 5f70 5f31 5f6e 2c74 6578 745f 7265  ns_p_1_n,text_re
-0001b3f0: 6769 6f6e 735f 702e 7368 6170 655b 305d  gions_p.shape[0]
-0001b400: 2c74 6578 745f 7265 6769 6f6e 735f 702e  ,text_regions_p.
-0001b410: 7368 6170 655b 315d 290a 2020 2020 2020  shape[1]).      
-0001b420: 2020 2020 2020 2020 2020 7465 7874 6c69            textli
-0001b430: 6e65 5f6d 6173 6b5f 746f 745f 6420 3d20  ne_mask_tot_d = 
-0001b440: 7265 7369 7a65 5f69 6d61 6765 2874 6578  resize_image(tex
-0001b450: 746c 696e 655f 6d61 736b 5f74 6f74 5f64  tline_mask_tot_d
-0001b460: 2c74 6578 745f 7265 6769 6f6e 735f 702e  ,text_regions_p.
-0001b470: 7368 6170 655b 305d 2c74 6578 745f 7265  shape[0],text_re
-0001b480: 6769 6f6e 735f 702e 7368 6170 655b 315d  gions_p.shape[1]
-0001b490: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001b4a0: 2020 7461 626c 655f 7072 6564 6963 7469    table_predicti
-0001b4b0: 6f6e 5f6e 203d 2072 6573 697a 655f 696d  on_n = resize_im
-0001b4c0: 6167 6528 7461 626c 655f 7072 6564 6963  age(table_predic
-0001b4d0: 7469 6f6e 5f6e 2c74 6578 745f 7265 6769  tion_n,text_regi
-0001b4e0: 6f6e 735f 702e 7368 6170 655b 305d 2c74  ons_p.shape[0],t
-0001b4f0: 6578 745f 7265 6769 6f6e 735f 702e 7368  ext_regions_p.sh
-0001b500: 6170 655b 315d 290a 2020 2020 2020 2020  ape[1]).        
-0001b510: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0001b520: 2020 2020 2020 2020 2072 6567 696f 6e73           regions
-0001b530: 5f77 6974 686f 7574 5f73 6570 6172 6174  _without_separat
-0001b540: 6f72 735f 643d 2874 6578 745f 7265 6769  ors_d=(text_regi
-0001b550: 6f6e 735f 705f 315f 6e5b 3a2c 3a5d 203d  ons_p_1_n[:,:] =
-0001b560: 3d20 3129 2a31 0a20 2020 2020 2020 2020  = 1)*1.         
-0001b570: 2020 2020 2020 2072 6567 696f 6e73 5f77         regions_w
-0001b580: 6974 686f 7574 5f73 6570 6172 6174 6f72  ithout_separator
-0001b590: 735f 645b 7461 626c 655f 7072 6564 6963  s_d[table_predic
-0001b5a0: 7469 6f6e 5f6e 5b3a 2c3a 5d20 3d3d 2031  tion_n[:,:] == 1
-0001b5b0: 5d20 3d20 310a 2020 2020 2020 2020 2020  ] = 1.          
-0001b5c0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-0001b5d0: 2020 2020 2020 2020 7465 7874 5f72 6567          text_reg
-0001b5e0: 696f 6e73 5f70 5f31 5f6e 203d 204e 6f6e  ions_p_1_n = Non
-0001b5f0: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
-0001b600: 2020 7465 7874 6c69 6e65 5f6d 6173 6b5f    textline_mask_
-0001b610: 746f 745f 6420 3d20 4e6f 6e65 0a20 2020  tot_d = None.   
-0001b620: 2020 2020 2020 2020 2020 2020 2072 6567               reg
-0001b630: 696f 6e73 5f77 6974 686f 7574 5f73 6570  ions_without_sep
-0001b640: 6172 6174 6f72 735f 6420 3d20 4e6f 6e65  arators_d = None
-0001b650: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001b660: 200a 2020 2020 2020 2020 2020 2020 7265   .            re
-0001b670: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
-0001b680: 7061 7261 746f 7273 203d 2028 7465 7874  parators = (text
-0001b690: 5f72 6567 696f 6e73 5f70 5b3a 2c3a 5d20  _regions_p[:,:] 
-0001b6a0: 3d3d 2031 292a 3123 2820 2874 6578 745f  == 1)*1#( (text_
-0001b6b0: 7265 6769 6f6e 735f 705b 3a2c 3a5d 3d3d  regions_p[:,:]==
-0001b6c0: 3129 207c 2028 7465 7874 5f72 6567 696f  1) | (text_regio
-0001b6d0: 6e73 5f70 5b3a 2c3a 5d3d 3d32 2920 292a  ns_p[:,:]==2) )*
-0001b6e0: 3120 2373 656c 662e 7265 7475 726e 5f72  1 #self.return_r
-0001b6f0: 6567 696f 6e73 5f77 6974 686f 7574 5f73  egions_without_s
-0001b700: 6570 6572 6174 6f72 735f 6e65 7728 7465  eperators_new(te
-0001b710: 7874 5f72 6567 696f 6e73 5f70 5b3a 2c3a  xt_regions_p[:,:
-0001b720: 2c30 5d2c 696d 675f 6f6e 6c79 5f72 6567  ,0],img_only_reg
-0001b730: 696f 6e73 290a 2020 2020 2020 2020 2020  ions).          
-0001b740: 2020 7265 6769 6f6e 735f 7769 7468 6f75    regions_withou
-0001b750: 745f 7365 7061 7261 746f 7273 5b74 6162  t_separators[tab
-0001b760: 6c65 5f70 7265 6469 6374 696f 6e20 3d3d  le_prediction ==
-0001b770: 2031 5d20 3d20 310a 2020 2020 2020 2020   1] = 1.        
-0001b780: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-0001b790: 2070 6978 656c 5f6c 696e 6573 3d33 0a20   pixel_lines=3. 
-0001b7a0: 2020 2020 2020 2020 2020 2069 6620 6e70             if np
-0001b7b0: 2e61 6273 2873 6c6f 7065 5f64 6573 6b65  .abs(slope_deske
-0001b7c0: 7729 203c 2053 4c4f 5045 5f54 4852 4553  w) < SLOPE_THRES
-0001b7d0: 484f 4c44 3a0a 2020 2020 2020 2020 2020  HOLD:.          
-0001b7e0: 2020 2020 2020 6e75 6d5f 636f 6c2c 2070        num_col, p
-0001b7f0: 6561 6b73 5f6e 6567 5f66 696e 2c20 6d61  eaks_neg_fin, ma
-0001b800: 7472 6978 5f6f 665f 6c69 6e65 735f 6368  trix_of_lines_ch
-0001b810: 2c20 7370 6c69 7474 6572 5f79 5f6e 6577  , splitter_y_new
-0001b820: 2c20 7365 7065 7261 746f 7273 5f63 6c6f  , seperators_clo
-0001b830: 7365 7570 5f6e 203d 2066 696e 645f 6e75  seup_n = find_nu
-0001b840: 6d62 6572 5f6f 665f 636f 6c75 6d6e 735f  mber_of_columns_
-0001b850: 696e 5f64 6f63 756d 656e 7428 6e70 2e72  in_document(np.r
-0001b860: 6570 6561 7428 7465 7874 5f72 6567 696f  epeat(text_regio
-0001b870: 6e73 5f70 5b3a 2c20 3a2c 206e 702e 6e65  ns_p[:, :, np.ne
-0001b880: 7761 7869 735d 2c20 332c 2061 7869 733d  waxis], 3, axis=
-0001b890: 3229 2c20 6e75 6d5f 636f 6c5f 636c 6173  2), num_col_clas
-0001b8a0: 7369 6669 6572 2c20 7365 6c66 2e74 6162  sifier, self.tab
-0001b8b0: 6c65 732c 2070 6978 656c 5f6c 696e 6573  les, pixel_lines
-0001b8c0: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
-0001b8d0: 2020 2020 2020 2020 2020 2069 6620 6e70             if np
-0001b8e0: 2e61 6273 2873 6c6f 7065 5f64 6573 6b65  .abs(slope_deske
-0001b8f0: 7729 203e 3d20 534c 4f50 455f 5448 5245  w) >= SLOPE_THRE
-0001b900: 5348 4f4c 443a 0a20 2020 2020 2020 2020  SHOLD:.         
-0001b910: 2020 2020 2020 206e 756d 5f63 6f6c 5f64         num_col_d
-0001b920: 2c20 7065 616b 735f 6e65 675f 6669 6e5f  , peaks_neg_fin_
-0001b930: 642c 206d 6174 7269 785f 6f66 5f6c 696e  d, matrix_of_lin
-0001b940: 6573 5f63 685f 642c 2073 706c 6974 7465  es_ch_d, splitte
-0001b950: 725f 795f 6e65 775f 642c 2073 6570 6572  r_y_new_d, seper
-0001b960: 6174 6f72 735f 636c 6f73 6575 705f 6e5f  ators_closeup_n_
-0001b970: 6420 3d20 6669 6e64 5f6e 756d 6265 725f  d = find_number_
-0001b980: 6f66 5f63 6f6c 756d 6e73 5f69 6e5f 646f  of_columns_in_do
-0001b990: 6375 6d65 6e74 286e 702e 7265 7065 6174  cument(np.repeat
-0001b9a0: 2874 6578 745f 7265 6769 6f6e 735f 705f  (text_regions_p_
-0001b9b0: 315f 6e5b 3a2c 203a 2c20 6e70 2e6e 6577  1_n[:, :, np.new
-0001b9c0: 6178 6973 5d2c 2033 2c20 6178 6973 3d32  axis], 3, axis=2
-0001b9d0: 292c 6e75 6d5f 636f 6c5f 636c 6173 7369  ),num_col_classi
-0001b9e0: 6669 6572 2c20 7365 6c66 2e74 6162 6c65  fier, self.table
-0001b9f0: 732c 2070 6978 656c 5f6c 696e 6573 290a  s, pixel_lines).
-0001ba00: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
-0001ba10: 6e75 6d5f 636f 6c5f 636c 6173 7369 6669  num_col_classifi
-0001ba20: 6572 3e3d 333a 0a20 2020 2020 2020 2020  er>=3:.         
-0001ba30: 2020 2020 2020 2069 6620 6e70 2e61 6273         if np.abs
-0001ba40: 2873 6c6f 7065 5f64 6573 6b65 7729 203c  (slope_deskew) <
-0001ba50: 2053 4c4f 5045 5f54 4852 4553 484f 4c44   SLOPE_THRESHOLD
-0001ba60: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ba70: 2020 2020 2020 7265 6769 6f6e 735f 7769        regions_wi
-0001ba80: 7468 6f75 745f 7365 7061 7261 746f 7273  thout_separators
-0001ba90: 203d 2072 6567 696f 6e73 5f77 6974 686f   = regions_witho
-0001baa0: 7574 5f73 6570 6172 6174 6f72 732e 6173  ut_separators.as
-0001bab0: 7479 7065 286e 702e 7569 6e74 3829 0a20  type(np.uint8). 
-0001bac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bad0: 2020 2072 6567 696f 6e73 5f77 6974 686f     regions_witho
-0001bae0: 7574 5f73 6570 6172 6174 6f72 7320 3d20  ut_separators = 
-0001baf0: 6376 322e 6572 6f64 6528 7265 6769 6f6e  cv2.erode(region
-0001bb00: 735f 7769 7468 6f75 745f 7365 7061 7261  s_without_separa
-0001bb10: 746f 7273 5b3a 2c3a 5d2c 204b 4552 4e45  tors[:,:], KERNE
-0001bb20: 4c2c 2069 7465 7261 7469 6f6e 733d 3629  L, iterations=6)
-0001bb30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001bb40: 200a 2020 2020 2020 2020 2020 2020 2020   .              
-0001bb50: 2020 6966 206e 702e 6162 7328 736c 6f70    if np.abs(slop
-0001bb60: 655f 6465 736b 6577 2920 3e3d 2053 4c4f  e_deskew) >= SLO
-0001bb70: 5045 5f54 4852 4553 484f 4c44 3a0a 2020  PE_THRESHOLD:.  
-0001bb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bb90: 2020 7265 6769 6f6e 735f 7769 7468 6f75    regions_withou
-0001bba0: 745f 7365 7061 7261 746f 7273 5f64 203d  t_separators_d =
-0001bbb0: 2072 6567 696f 6e73 5f77 6974 686f 7574   regions_without
-0001bbc0: 5f73 6570 6172 6174 6f72 735f 642e 6173  _separators_d.as
-0001bbd0: 7479 7065 286e 702e 7569 6e74 3829 0a20  type(np.uint8). 
-0001bbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bbf0: 2020 2072 6567 696f 6e73 5f77 6974 686f     regions_witho
-0001bc00: 7574 5f73 6570 6172 6174 6f72 735f 6420  ut_separators_d 
-0001bc10: 3d20 6376 322e 6572 6f64 6528 7265 6769  = cv2.erode(regi
-0001bc20: 6f6e 735f 7769 7468 6f75 745f 7365 7061  ons_without_sepa
-0001bc30: 7261 746f 7273 5f64 5b3a 2c3a 5d2c 204b  rators_d[:,:], K
-0001bc40: 4552 4e45 4c2c 2069 7465 7261 7469 6f6e  ERNEL, iteration
-0001bc50: 733d 3629 0a20 2020 2020 2020 2020 2020  s=6).           
-0001bc60: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001bc70: 2020 2020 2020 2070 6173 730a 2020 2020         pass.    
-0001bc80: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0001bc90: 2020 2020 2069 6620 6e70 2e61 6273 2873       if np.abs(s
-0001bca0: 6c6f 7065 5f64 6573 6b65 7729 203c 2053  lope_deskew) < S
-0001bcb0: 4c4f 5045 5f54 4852 4553 484f 4c44 3a0a  LOPE_THRESHOLD:.
-0001bcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bcd0: 626f 7865 732c 2070 6561 6b73 5f6e 6567  boxes, peaks_neg
-0001bce0: 5f74 6f74 5f74 6162 6c65 7320 3d20 7265  _tot_tables = re
-0001bcf0: 7475 726e 5f62 6f78 6573 5f6f 665f 696d  turn_boxes_of_im
-0001bd00: 6167 6573 5f62 795f 6f72 6465 725f 6f66  ages_by_order_of
-0001bd10: 5f72 6561 6469 6e67 5f6e 6577 2873 706c  _reading_new(spl
-0001bd20: 6974 7465 725f 795f 6e65 772c 2072 6567  itter_y_new, reg
-0001bd30: 696f 6e73 5f77 6974 686f 7574 5f73 6570  ions_without_sep
-0001bd40: 6172 6174 6f72 732c 206d 6174 7269 785f  arators, matrix_
-0001bd50: 6f66 5f6c 696e 6573 5f63 682c 206e 756d  of_lines_ch, num
-0001bd60: 5f63 6f6c 5f63 6c61 7373 6966 6965 722c  _col_classifier,
-0001bd70: 2065 726f 7369 6f6e 5f68 7572 7473 2c20   erosion_hurts, 
-0001bd80: 7365 6c66 2e74 6162 6c65 7329 0a20 2020  self.tables).   
-0001bd90: 2020 2020 2020 2020 2020 2020 2074 6578               tex
-0001bda0: 745f 7265 6769 6f6e 735f 705f 7461 626c  t_regions_p_tabl
-0001bdb0: 6573 203d 206e 702e 636f 7079 2874 6578  es = np.copy(tex
-0001bdc0: 745f 7265 6769 6f6e 735f 7029 0a20 2020  t_regions_p).   
-0001bdd0: 2020 2020 2020 2020 2020 2020 2074 6578               tex
-0001bde0: 745f 7265 6769 6f6e 735f 705f 7461 626c  t_regions_p_tabl
-0001bdf0: 6573 5b3a 2c3a 5d5b 2874 6162 6c65 5f70  es[:,:][(table_p
-0001be00: 7265 6469 6374 696f 6e5b 3a2c 3a5d 3d3d  rediction[:,:]==
-0001be10: 3129 5d20 3d20 3130 0a20 2020 2020 2020  1)] = 10.       
-0001be20: 2020 2020 2020 2020 2070 6978 656c 5f6c           pixel_l
-0001be30: 696e 6520 3d20 330a 2020 2020 2020 2020  ine = 3.        
-0001be40: 2020 2020 2020 2020 696d 675f 7265 7669          img_revi
-0001be50: 7365 645f 7461 6232 203d 2073 656c 662e  sed_tab2 = self.
-0001be60: 6164 645f 7461 626c 6573 5f68 6575 7269  add_tables_heuri
-0001be70: 7374 6963 5f74 6f5f 6c61 796f 7574 2874  stic_to_layout(t
-0001be80: 6578 745f 7265 6769 6f6e 735f 705f 7461  ext_regions_p_ta
-0001be90: 626c 6573 2c20 626f 7865 732c 2030 2c20  bles, boxes, 0, 
-0001bea0: 7370 6c69 7474 6572 5f79 5f6e 6577 2c20  splitter_y_new, 
-0001beb0: 7065 616b 735f 6e65 675f 746f 745f 7461  peaks_neg_tot_ta
-0001bec0: 626c 6573 2c20 7465 7874 5f72 6567 696f  bles, text_regio
-0001bed0: 6e73 5f70 5f74 6162 6c65 7320 2c20 6e75  ns_p_tables , nu
-0001bee0: 6d5f 636f 6c5f 636c 6173 7369 6669 6572  m_col_classifier
-0001bef0: 202c 2030 2e30 3030 3030 352c 2070 6978   , 0.000005, pix
-0001bf00: 656c 5f6c 696e 6529 0a20 2020 2020 2020  el_line).       
-0001bf10: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0001bf20: 2020 2020 2020 2020 2020 696d 675f 7265            img_re
-0001bf30: 7669 7365 645f 7461 6232 2c63 6f6e 746f  vised_tab2,conto
-0001bf40: 7572 6573 5f74 6162 6c65 7320 3d20 7365  ures_tables = se
-0001bf50: 6c66 2e63 6865 636b 5f69 6f75 5f6f 665f  lf.check_iou_of_
-0001bf60: 626f 756e 6469 6e67 5f62 6f78 5f61 6e64  bounding_box_and
-0001bf70: 5f63 6f6e 746f 7572 5f66 6f72 5f74 6162  _contour_for_tab
-0001bf80: 6c65 7328 696d 675f 7265 7669 7365 645f  les(img_revised_
-0001bf90: 7461 6232 2c20 7461 626c 655f 7072 6564  tab2, table_pred
-0001bfa0: 6963 7469 6f6e 2c20 3130 2c20 6e75 6d5f  iction, 10, num_
-0001bfb0: 636f 6c5f 636c 6173 7369 6669 6572 290a  col_classifier).
-0001bfc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001bfd0: 0a20 2020 2020 2020 2020 2020 2065 6c73  .            els
-0001bfe0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
-0001bff0: 2020 2062 6f78 6573 5f64 2c20 7065 616b     boxes_d, peak
-0001c000: 735f 6e65 675f 746f 745f 7461 626c 6573  s_neg_tot_tables
-0001c010: 5f64 203d 2072 6574 7572 6e5f 626f 7865  _d = return_boxe
-0001c020: 735f 6f66 5f69 6d61 6765 735f 6279 5f6f  s_of_images_by_o
-0001c030: 7264 6572 5f6f 665f 7265 6164 696e 675f  rder_of_reading_
-0001c040: 6e65 7728 7370 6c69 7474 6572 5f79 5f6e  new(splitter_y_n
-0001c050: 6577 5f64 2c20 7265 6769 6f6e 735f 7769  ew_d, regions_wi
-0001c060: 7468 6f75 745f 7365 7061 7261 746f 7273  thout_separators
-0001c070: 5f64 2c20 6d61 7472 6978 5f6f 665f 6c69  _d, matrix_of_li
-0001c080: 6e65 735f 6368 5f64 2c20 6e75 6d5f 636f  nes_ch_d, num_co
-0001c090: 6c5f 636c 6173 7369 6669 6572 2c20 6572  l_classifier, er
-0001c0a0: 6f73 696f 6e5f 6875 7274 732c 2073 656c  osion_hurts, sel
-0001c0b0: 662e 7461 626c 6573 290a 2020 2020 2020  f.tables).      
-0001c0c0: 2020 2020 2020 2020 2020 7465 7874 5f72            text_r
-0001c0d0: 6567 696f 6e73 5f70 5f74 6162 6c65 7320  egions_p_tables 
-0001c0e0: 3d20 6e70 2e63 6f70 7928 7465 7874 5f72  = np.copy(text_r
-0001c0f0: 6567 696f 6e73 5f70 5f31 5f6e 290a 2020  egions_p_1_n).  
-0001c100: 2020 2020 2020 2020 2020 2020 2020 7465                te
-0001c110: 7874 5f72 6567 696f 6e73 5f70 5f74 6162  xt_regions_p_tab
-0001c120: 6c65 7320 3d20 6e70 2e72 6f75 6e64 2874  les = np.round(t
-0001c130: 6578 745f 7265 6769 6f6e 735f 705f 7461  ext_regions_p_ta
-0001c140: 626c 6573 290a 2020 2020 2020 2020 2020  bles).          
-0001c150: 2020 2020 2020 7465 7874 5f72 6567 696f        text_regio
-0001c160: 6e73 5f70 5f74 6162 6c65 735b 3a2c 3a5d  ns_p_tables[:,:]
-0001c170: 5b28 7465 7874 5f72 6567 696f 6e73 5f70  [(text_regions_p
-0001c180: 5f74 6162 6c65 735b 3a2c 3a5d 213d 3329  _tables[:,:]!=3)
-0001c190: 2026 2028 7461 626c 655f 7072 6564 6963   & (table_predic
-0001c1a0: 7469 6f6e 5f6e 5b3a 2c3a 5d3d 3d31 295d  tion_n[:,:]==1)]
-0001c1b0: 203d 2031 300a 2020 2020 2020 2020 2020   = 10.          
-0001c1c0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-0001c1d0: 2020 2020 2020 2070 6978 656c 5f6c 696e         pixel_lin
-0001c1e0: 6520 3d20 330a 2020 2020 2020 2020 2020  e = 3.          
-0001c1f0: 2020 2020 2020 696d 675f 7265 7669 7365        img_revise
-0001c200: 645f 7461 6232 203d 2073 656c 662e 6164  d_tab2 = self.ad
-0001c210: 645f 7461 626c 6573 5f68 6575 7269 7374  d_tables_heurist
-0001c220: 6963 5f74 6f5f 6c61 796f 7574 2874 6578  ic_to_layout(tex
-0001c230: 745f 7265 6769 6f6e 735f 705f 7461 626c  t_regions_p_tabl
-0001c240: 6573 2c62 6f78 6573 5f64 2c30 2c73 706c  es,boxes_d,0,spl
-0001c250: 6974 7465 725f 795f 6e65 775f 642c 7065  itter_y_new_d,pe
-0001c260: 616b 735f 6e65 675f 746f 745f 7461 626c  aks_neg_tot_tabl
-0001c270: 6573 5f64 2c74 6578 745f 7265 6769 6f6e  es_d,text_region
-0001c280: 735f 705f 7461 626c 6573 2c20 6e75 6d5f  s_p_tables, num_
-0001c290: 636f 6c5f 636c 6173 7369 6669 6572 2c20  col_classifier, 
-0001c2a0: 302e 3030 3030 3035 2c20 7069 7865 6c5f  0.000005, pixel_
-0001c2b0: 6c69 6e65 290a 2020 2020 2020 2020 2020  line).          
-0001c2c0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-0001c2d0: 2020 2020 2020 2069 6d67 5f72 6576 6973         img_revis
-0001c2e0: 6564 5f74 6162 325f 642c 5f20 3d20 7365  ed_tab2_d,_ = se
-0001c2f0: 6c66 2e63 6865 636b 5f69 6f75 5f6f 665f  lf.check_iou_of_
-0001c300: 626f 756e 6469 6e67 5f62 6f78 5f61 6e64  bounding_box_and
-0001c310: 5f63 6f6e 746f 7572 5f66 6f72 5f74 6162  _contour_for_tab
-0001c320: 6c65 7328 696d 675f 7265 7669 7365 645f  les(img_revised_
-0001c330: 7461 6232 2c20 7461 626c 655f 7072 6564  tab2, table_pred
-0001c340: 6963 7469 6f6e 5f6e 2c20 3130 2c20 6e75  iction_n, 10, nu
-0001c350: 6d5f 636f 6c5f 636c 6173 7369 6669 6572  m_col_classifier
-0001c360: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001c370: 2020 696d 675f 7265 7669 7365 645f 7461    img_revised_ta
-0001c380: 6232 5f64 5f72 6f74 6174 6564 203d 2072  b2_d_rotated = r
-0001c390: 6f74 6174 655f 696d 6167 6528 696d 675f  otate_image(img_
-0001c3a0: 7265 7669 7365 645f 7461 6232 5f64 2c20  revised_tab2_d, 
-0001c3b0: 2d73 6c6f 7065 5f64 6573 6b65 7729 0a20  -slope_deskew). 
-0001c3c0: 2020 2020 2020 2020 2020 2020 2020 200a                 .
-0001c3d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001c3e0: 2069 6d67 5f72 6576 6973 6564 5f74 6162   img_revised_tab
-0001c3f0: 325f 645f 726f 7461 7465 6420 3d20 6e70  2_d_rotated = np
-0001c400: 2e72 6f75 6e64 2869 6d67 5f72 6576 6973  .round(img_revis
-0001c410: 6564 5f74 6162 325f 645f 726f 7461 7465  ed_tab2_d_rotate
-0001c420: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
-0001c430: 2020 2069 6d67 5f72 6576 6973 6564 5f74     img_revised_t
-0001c440: 6162 325f 645f 726f 7461 7465 6420 3d20  ab2_d_rotated = 
-0001c450: 696d 675f 7265 7669 7365 645f 7461 6232  img_revised_tab2
-0001c460: 5f64 5f72 6f74 6174 6564 2e61 7374 7970  _d_rotated.astyp
-0001c470: 6528 6e70 2e69 6e74 3829 0a0a 2020 2020  e(np.int8)..    
-0001c480: 2020 2020 2020 2020 2020 2020 696d 675f              img_
-0001c490: 7265 7669 7365 645f 7461 6232 5f64 5f72  revised_tab2_d_r
-0001c4a0: 6f74 6174 6564 203d 2072 6573 697a 655f  otated = resize_
-0001c4b0: 696d 6167 6528 696d 675f 7265 7669 7365  image(img_revise
-0001c4c0: 645f 7461 6232 5f64 5f72 6f74 6174 6564  d_tab2_d_rotated
-0001c4d0: 2c20 7465 7874 5f72 6567 696f 6e73 5f70  , text_regions_p
-0001c4e0: 2e73 6861 7065 5b30 5d2c 2074 6578 745f  .shape[0], text_
-0001c4f0: 7265 6769 6f6e 735f 702e 7368 6170 655b  regions_p.shape[
-0001c500: 315d 290a 0a0a 2020 2020 2020 2020 2020  1])...          
-0001c510: 2020 6966 206e 702e 6162 7328 736c 6f70    if np.abs(slop
-0001c520: 655f 6465 736b 6577 2920 3c20 302e 3133  e_deskew) < 0.13
-0001c530: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001c540: 2020 696d 675f 7265 7669 7365 645f 7461    img_revised_ta
-0001c550: 6220 3d20 6e70 2e63 6f70 7928 696d 675f  b = np.copy(img_
-0001c560: 7265 7669 7365 645f 7461 6232 5b3a 2c3a  revised_tab2[:,:
-0001c570: 2c30 5d29 0a20 2020 2020 2020 2020 2020  ,0]).           
-0001c580: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-0001c590: 2020 2020 2020 2069 6d67 5f72 6576 6973         img_revis
-0001c5a0: 6564 5f74 6162 203d 206e 702e 636f 7079  ed_tab = np.copy
-0001c5b0: 2874 6578 745f 7265 6769 6f6e 735f 705b  (text_regions_p[
-0001c5c0: 3a2c 3a5d 290a 2020 2020 2020 2020 2020  :,:]).          
-0001c5d0: 2020 2020 2020 696d 675f 7265 7669 7365        img_revise
-0001c5e0: 645f 7461 625b 3a2c 3a5d 5b69 6d67 5f72  d_tab[:,:][img_r
-0001c5f0: 6576 6973 6564 5f74 6162 5b3a 2c3a 5d20  evised_tab[:,:] 
-0001c600: 3d3d 2031 305d 203d 2030 0a20 2020 2020  == 10] = 0.     
-0001c610: 2020 2020 2020 2020 2020 2069 6d67 5f72             img_r
-0001c620: 6576 6973 6564 5f74 6162 5b3a 2c3a 5d5b  evised_tab[:,:][
-0001c630: 696d 675f 7265 7669 7365 645f 7461 6232  img_revised_tab2
-0001c640: 5f64 5f72 6f74 6174 6564 5b3a 2c3a 2c30  _d_rotated[:,:,0
-0001c650: 5d20 3d3d 2031 305d 203d 2031 300a 2020  ] == 10] = 10.  
-0001c660: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001c670: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
-0001c680: 2020 2020 2020 200a 2020 2020 2020 2020         .        
-0001c690: 2020 2020 2323 696d 675f 7265 7669 7365      ##img_revise
-0001c6a0: 645f 7461 623d 696d 675f 7265 7669 7365  d_tab=img_revise
-0001c6b0: 645f 7461 6232 5b3a 2c3a 2c30 5d0a 2020  d_tab2[:,:,0].  
-0001c6c0: 2020 2020 2020 2020 2020 2369 6d67 5f72            #img_r
-0001c6d0: 6576 6973 6564 5f74 6162 3d74 6578 745f  evised_tab=text_
-0001c6e0: 7265 6769 6f6e 735f 705b 3a2c 3a5d 0a20  regions_p[:,:]. 
-0001c6f0: 2020 2020 2020 2020 2020 2074 6578 745f             text_
-0001c700: 7265 6769 6f6e 735f 705b 3a2c 3a5d 5b74  regions_p[:,:][t
-0001c710: 6578 745f 7265 6769 6f6e 735f 705b 3a2c  ext_regions_p[:,
-0001c720: 3a5d 3d3d 3130 5d20 3d20 300a 2020 2020  :]==10] = 0.    
-0001c730: 2020 2020 2020 2020 7465 7874 5f72 6567          text_reg
-0001c740: 696f 6e73 5f70 5b3a 2c3a 5d5b 696d 675f  ions_p[:,:][img_
-0001c750: 7265 7669 7365 645f 7461 625b 3a2c 3a5d  revised_tab[:,:]
-0001c760: 3d3d 3130 5d20 3d20 3130 0a20 2020 2020  ==10] = 10.     
-0001c770: 2020 2020 2020 2023 696d 675f 7265 7669         #img_revi
-0001c780: 7365 645f 7461 625b 696d 675f 7265 7669  sed_tab[img_revi
-0001c790: 7365 645f 7461 6232 5b3a 2c3a 2c30 5d3d  sed_tab2[:,:,0]=
-0001c7a0: 3d31 305d 203d 3130 0a20 2020 2020 2020  =10] =10.       
-0001c7b0: 2020 2020 200a 2020 2020 2020 2020 7069       .        pi
-0001c7c0: 7865 6c5f 696d 6720 3d20 340a 2020 2020  xel_img = 4.    
-0001c7d0: 2020 2020 6d69 6e5f 6172 6561 5f6d 6172      min_area_mar
-0001c7e0: 203d 2030 2e30 3030 3031 0a20 2020 2020   = 0.00001.     
-0001c7f0: 2020 2070 6f6c 7967 6f6e 735f 6f66 5f6d     polygons_of_m
-0001c800: 6172 6769 6e61 6c73 203d 2072 6574 7572  arginals = retur
-0001c810: 6e5f 636f 6e74 6f75 7273 5f6f 665f 696e  n_contours_of_in
-0001c820: 7465 7265 7374 6564 5f72 6567 696f 6e28  terested_region(
-0001c830: 7465 7874 5f72 6567 696f 6e73 5f70 2c20  text_regions_p, 
-0001c840: 7069 7865 6c5f 696d 672c 206d 696e 5f61  pixel_img, min_a
-0001c850: 7265 615f 6d61 7229 0a20 2020 2020 2020  rea_mar).       
-0001c860: 200a 2020 2020 2020 2020 7069 7865 6c5f   .        pixel_
-0001c870: 696d 6720 3d20 3130 0a20 2020 2020 2020  img = 10.       
-0001c880: 2063 6f6e 746f 7572 735f 7461 626c 6573   contours_tables
-0001c890: 203d 2072 6574 7572 6e5f 636f 6e74 6f75   = return_contou
-0001c8a0: 7273 5f6f 665f 696e 7465 7265 7374 6564  rs_of_interested
-0001c8b0: 5f72 6567 696f 6e28 7465 7874 5f72 6567  _region(text_reg
-0001c8c0: 696f 6e73 5f70 2c20 7069 7865 6c5f 696d  ions_p, pixel_im
-0001c8d0: 672c 206d 696e 5f61 7265 615f 6d61 7229  g, min_area_mar)
-0001c8e0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-0001c8f0: 2020 2320 7365 7420 6669 7273 7420 6d6f    # set first mo
-0001c900: 6465 6c20 7769 7468 2073 6563 6f6e 6420  del with second 
-0001c910: 6d6f 6465 6c0a 2020 2020 2020 2020 7465  model.        te
-0001c920: 7874 5f72 6567 696f 6e73 5f70 5b3a 2c20  xt_regions_p[:, 
-0001c930: 3a5d 5b74 6578 745f 7265 6769 6f6e 735f  :][text_regions_
-0001c940: 705b 3a2c 203a 5d20 3d3d 2032 5d20 3d20  p[:, :] == 2] = 
-0001c950: 350a 2020 2020 2020 2020 7465 7874 5f72  5.        text_r
-0001c960: 6567 696f 6e73 5f70 5b3a 2c20 3a5d 5b74  egions_p[:, :][t
-0001c970: 6578 745f 7265 6769 6f6e 735f 705b 3a2c  ext_regions_p[:,
-0001c980: 203a 5d20 3d3d 2033 5d20 3d20 360a 2020   :] == 3] = 6.  
-0001c990: 2020 2020 2020 7465 7874 5f72 6567 696f        text_regio
-0001c9a0: 6e73 5f70 5b3a 2c20 3a5d 5b74 6578 745f  ns_p[:, :][text_
-0001c9b0: 7265 6769 6f6e 735f 705b 3a2c 203a 5d20  regions_p[:, :] 
-0001c9c0: 3d3d 2034 5d20 3d20 380a 0a20 2020 2020  == 4] = 8..     
-0001c9d0: 2020 2069 6d61 6765 5f70 6167 6520 3d20     image_page = 
-0001c9e0: 696d 6167 655f 7061 6765 2e61 7374 7970  image_page.astyp
-0001c9f0: 6528 6e70 2e75 696e 7438 290a 0a20 2020  e(np.uint8)..   
-0001ca00: 2020 2020 2072 6567 696f 6e73 5f66 756c       regions_ful
-0001ca10: 6c79 2c20 7265 6769 6f6e 735f 6675 6c6c  ly, regions_full
-0001ca20: 795f 6f6e 6c79 5f64 726f 7020 3d20 7365  y_only_drop = se
-0001ca30: 6c66 2e65 7874 7261 6374 5f74 6578 745f  lf.extract_text_
-0001ca40: 7265 6769 6f6e 7328 696d 6167 655f 7061  regions(image_pa
-0001ca50: 6765 2c20 5472 7565 2c20 636f 6c73 3d6e  ge, True, cols=n
-0001ca60: 756d 5f63 6f6c 5f63 6c61 7373 6966 6965  um_col_classifie
-0001ca70: 7229 0a20 2020 2020 2020 2074 6578 745f  r).        text_
-0001ca80: 7265 6769 6f6e 735f 705b 3a2c 3a5d 5b72  regions_p[:,:][r
-0001ca90: 6567 696f 6e73 5f66 756c 6c79 5b3a 2c3a  egions_fully[:,:
-0001caa0: 2c30 5d3d 3d36 5d3d 360a 2020 2020 2020  ,0]==6]=6.      
-0001cab0: 2020 7265 6769 6f6e 735f 6675 6c6c 795f    regions_fully_
-0001cac0: 6f6e 6c79 5f64 726f 7020 3d20 7075 745f  only_drop = put_
-0001cad0: 6472 6f70 5f6f 7574 5f66 726f 6d5f 6f6e  drop_out_from_on
-0001cae0: 6c79 5f64 726f 705f 6d6f 6465 6c28 7265  ly_drop_model(re
-0001caf0: 6769 6f6e 735f 6675 6c6c 795f 6f6e 6c79  gions_fully_only
-0001cb00: 5f64 726f 702c 2074 6578 745f 7265 6769  _drop, text_regi
-0001cb10: 6f6e 735f 7029 0a20 2020 2020 2020 2072  ons_p).        r
-0001cb20: 6567 696f 6e73 5f66 756c 6c79 5b3a 2c20  egions_fully[:, 
-0001cb30: 3a2c 2030 5d5b 7265 6769 6f6e 735f 6675  :, 0][regions_fu
-0001cb40: 6c6c 795f 6f6e 6c79 5f64 726f 705b 3a2c  lly_only_drop[:,
-0001cb50: 203a 2c20 305d 203d 3d20 345d 203d 2034   :, 0] == 4] = 4
-0001cb60: 0a0a 2020 2020 2020 2020 2320 706c 742e  ..        # plt.
-0001cb70: 696d 7368 6f77 2872 6567 696f 6e73 5f66  imshow(regions_f
-0001cb80: 756c 6c79 5b3a 2c3a 2c30 5d29 0a20 2020  ully[:,:,0]).   
-0001cb90: 2020 2020 2023 2070 6c74 2e73 686f 7728       # plt.show(
-0001cba0: 290a 2020 2020 2020 2020 7265 6769 6f6e  ).        region
-0001cbb0: 735f 6675 6c6c 7920 3d20 7075 7474 5f62  s_fully = putt_b
-0001cbc0: 625f 6f66 5f64 726f 705f 6361 7069 7461  b_of_drop_capita
-0001cbd0: 6c73 5f6f 665f 6d6f 6465 6c5f 696e 5f70  ls_of_model_in_p
-0001cbe0: 6174 6368 6573 5f69 6e5f 6c61 796f 7574  atches_in_layout
-0001cbf0: 2872 6567 696f 6e73 5f66 756c 6c79 290a  (regions_fully).
-0001cc00: 2020 2020 2020 2020 2320 706c 742e 696d          # plt.im
-0001cc10: 7368 6f77 2872 6567 696f 6e73 5f66 756c  show(regions_ful
-0001cc20: 6c79 5b3a 2c3a 2c30 5d29 0a20 2020 2020  ly[:,:,0]).     
-0001cc30: 2020 2023 2070 6c74 2e73 686f 7728 290a     # plt.show().
-0001cc40: 2020 2020 2020 2020 7265 6769 6f6e 735f          regions_
-0001cc50: 6675 6c6c 795f 6e70 2c20 5f20 3d20 7365  fully_np, _ = se
-0001cc60: 6c66 2e65 7874 7261 6374 5f74 6578 745f  lf.extract_text_
-0001cc70: 7265 6769 6f6e 7328 696d 6167 655f 7061  regions(image_pa
-0001cc80: 6765 2c20 4661 6c73 652c 2063 6f6c 733d  ge, False, cols=
-0001cc90: 6e75 6d5f 636f 6c5f 636c 6173 7369 6669  num_col_classifi
-0001cca0: 6572 290a 2020 2020 2020 2020 2320 706c  er).        # pl
-0001ccb0: 742e 696d 7368 6f77 2872 6567 696f 6e73  t.imshow(regions
-0001ccc0: 5f66 756c 6c79 5f6e 705b 3a2c 3a2c 305d  _fully_np[:,:,0]
-0001ccd0: 290a 2020 2020 2020 2020 2320 706c 742e  ).        # plt.
-0001cce0: 7368 6f77 2829 0a20 2020 2020 2020 2069  show().        i
-0001ccf0: 6620 6e75 6d5f 636f 6c5f 636c 6173 7369  f num_col_classi
-0001cd00: 6669 6572 203e 2032 3a0a 2020 2020 2020  fier > 2:.      
-0001cd10: 2020 2020 2020 7265 6769 6f6e 735f 6675        regions_fu
-0001cd20: 6c6c 795f 6e70 5b3a 2c20 3a2c 2030 5d5b  lly_np[:, :, 0][
-0001cd30: 7265 6769 6f6e 735f 6675 6c6c 795f 6e70  regions_fully_np
-0001cd40: 5b3a 2c20 3a2c 2030 5d20 3d3d 2034 5d20  [:, :, 0] == 4] 
-0001cd50: 3d20 300a 2020 2020 2020 2020 656c 7365  = 0.        else
-0001cd60: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
-0001cd70: 6769 6f6e 735f 6675 6c6c 795f 6e70 203d  gions_fully_np =
-0001cd80: 2066 696c 7465 725f 736d 616c 6c5f 6472   filter_small_dr
-0001cd90: 6f70 5f63 6170 6974 616c 735f 6672 6f6d  op_capitals_from
-0001cda0: 5f6e 6f5f 7061 7463 685f 6c61 796f 7574  _no_patch_layout
-0001cdb0: 2872 6567 696f 6e73 5f66 756c 6c79 5f6e  (regions_fully_n
-0001cdc0: 702c 2074 6578 745f 7265 6769 6f6e 735f  p, text_regions_
-0001cdd0: 7029 0a0a 2020 2020 2020 2020 2320 706c  p)..        # pl
-0001cde0: 742e 696d 7368 6f77 2872 6567 696f 6e73  t.imshow(regions
-0001cdf0: 5f66 756c 6c79 5f6e 705b 3a2c 3a2c 305d  _fully_np[:,:,0]
-0001ce00: 290a 2020 2020 2020 2020 2320 706c 742e  ).        # plt.
-0001ce10: 7368 6f77 2829 0a20 2020 2020 2020 2023  show().        #
-0001ce20: 2070 6c74 2e69 6d73 686f 7728 7265 6769   plt.imshow(regi
-0001ce30: 6f6e 735f 6675 6c6c 795b 3a2c 3a2c 305d  ons_fully[:,:,0]
-0001ce40: 290a 2020 2020 2020 2020 2320 706c 742e  ).        # plt.
-0001ce50: 7368 6f77 2829 0a20 2020 2020 2020 2072  show().        r
-0001ce60: 6567 696f 6e73 5f66 756c 6c79 203d 2062  egions_fully = b
-0001ce70: 6f6f 7374 696e 675f 6865 6164 6572 735f  oosting_headers_
-0001ce80: 6279 5f6c 6f6e 6773 686f 745f 7265 6769  by_longshot_regi
-0001ce90: 6f6e 5f73 6567 6d65 6e74 6174 696f 6e28  on_segmentation(
-0001cea0: 7265 6769 6f6e 735f 6675 6c6c 792c 2072  regions_fully, r
-0001ceb0: 6567 696f 6e73 5f66 756c 6c79 5f6e 702c  egions_fully_np,
-0001cec0: 2069 6d67 5f6f 6e6c 795f 7265 6769 6f6e   img_only_region
-0001ced0: 7329 0a20 2020 2020 2020 2023 2070 6c74  s).        # plt
-0001cee0: 2e69 6d73 686f 7728 7265 6769 6f6e 735f  .imshow(regions_
-0001cef0: 6675 6c6c 795b 3a2c 3a2c 305d 290a 2020  fully[:,:,0]).  
-0001cf00: 2020 2020 2020 2320 706c 742e 7368 6f77        # plt.show
-0001cf10: 2829 0a20 2020 2020 2020 2074 6578 745f  ().        text_
-0001cf20: 7265 6769 6f6e 735f 705b 3a2c 203a 5d5b  regions_p[:, :][
-0001cf30: 7265 6769 6f6e 735f 6675 6c6c 795b 3a2c  regions_fully[:,
-0001cf40: 203a 2c20 305d 203d 3d20 345d 203d 2034   :, 0] == 4] = 4
-0001cf50: 0a20 2020 2020 2020 2074 6578 745f 7265  .        text_re
-0001cf60: 6769 6f6e 735f 705b 3a2c 203a 5d5b 7265  gions_p[:, :][re
-0001cf70: 6769 6f6e 735f 6675 6c6c 795f 6e70 5b3a  gions_fully_np[:
-0001cf80: 2c20 3a2c 2030 5d20 3d3d 2034 5d20 3d20  , :, 0] == 4] = 
-0001cf90: 340a 2020 2020 2020 2020 2370 6c74 2e69  4.        #plt.i
-0001cfa0: 6d73 686f 7728 7465 7874 5f72 6567 696f  mshow(text_regio
-0001cfb0: 6e73 5f70 290a 2020 2020 2020 2020 2370  ns_p).        #p
-0001cfc0: 6c74 2e73 686f 7728 290a 2020 2020 2020  lt.show().      
-0001cfd0: 2020 2323 2323 6966 206e 6f74 2073 656c    ####if not sel
-0001cfe0: 662e 7461 626c 6573 3a0a 2020 2020 2020  f.tables:.      
-0001cff0: 2020 6966 206e 702e 6162 7328 736c 6f70    if np.abs(slop
-0001d000: 655f 6465 736b 6577 2920 3e3d 2053 4c4f  e_deskew) >= SLO
-0001d010: 5045 5f54 4852 4553 484f 4c44 3a0a 2020  PE_THRESHOLD:.  
-0001d020: 2020 2020 2020 2020 2020 5f2c 2074 6578            _, tex
-0001d030: 746c 696e 655f 6d61 736b 5f74 6f74 5f64  tline_mask_tot_d
-0001d040: 2c20 7465 7874 5f72 6567 696f 6e73 5f70  , text_regions_p
-0001d050: 5f31 5f6e 2c20 7265 6769 6f6e 735f 6675  _1_n, regions_fu
-0001d060: 6c6c 795f 6e20 3d20 726f 7461 7469 6f6e  lly_n = rotation
-0001d070: 5f6e 6f74 5f39 305f 6675 6e63 5f66 756c  _not_90_func_ful
-0001d080: 6c5f 6c61 796f 7574 2869 6d61 6765 5f70  l_layout(image_p
-0001d090: 6167 652c 2074 6578 746c 696e 655f 6d61  age, textline_ma
-0001d0a0: 736b 5f74 6f74 2c20 7465 7874 5f72 6567  sk_tot, text_reg
-0001d0b0: 696f 6e73 5f70 2c20 7265 6769 6f6e 735f  ions_p, regions_
-0001d0c0: 6675 6c6c 792c 2073 6c6f 7065 5f64 6573  fully, slope_des
-0001d0d0: 6b65 7729 0a0a 2020 2020 2020 2020 2020  kew)..          
-0001d0e0: 2020 7465 7874 5f72 6567 696f 6e73 5f70    text_regions_p
-0001d0f0: 5f31 5f6e 203d 2072 6573 697a 655f 696d  _1_n = resize_im
-0001d100: 6167 6528 7465 7874 5f72 6567 696f 6e73  age(text_regions
-0001d110: 5f70 5f31 5f6e 2c20 7465 7874 5f72 6567  _p_1_n, text_reg
-0001d120: 696f 6e73 5f70 2e73 6861 7065 5b30 5d2c  ions_p.shape[0],
-0001d130: 2074 6578 745f 7265 6769 6f6e 735f 702e   text_regions_p.
-0001d140: 7368 6170 655b 315d 290a 2020 2020 2020  shape[1]).      
-0001d150: 2020 2020 2020 7465 7874 6c69 6e65 5f6d        textline_m
-0001d160: 6173 6b5f 746f 745f 6420 3d20 7265 7369  ask_tot_d = resi
-0001d170: 7a65 5f69 6d61 6765 2874 6578 746c 696e  ze_image(textlin
-0001d180: 655f 6d61 736b 5f74 6f74 5f64 2c20 7465  e_mask_tot_d, te
-0001d190: 7874 5f72 6567 696f 6e73 5f70 2e73 6861  xt_regions_p.sha
-0001d1a0: 7065 5b30 5d2c 2074 6578 745f 7265 6769  pe[0], text_regi
-0001d1b0: 6f6e 735f 702e 7368 6170 655b 315d 290a  ons_p.shape[1]).
-0001d1c0: 2020 2020 2020 2020 2020 2020 7265 6769              regi
-0001d1d0: 6f6e 735f 6675 6c6c 795f 6e20 3d20 7265  ons_fully_n = re
-0001d1e0: 7369 7a65 5f69 6d61 6765 2872 6567 696f  size_image(regio
-0001d1f0: 6e73 5f66 756c 6c79 5f6e 2c20 7465 7874  ns_fully_n, text
-0001d200: 5f72 6567 696f 6e73 5f70 2e73 6861 7065  _regions_p.shape
-0001d210: 5b30 5d2c 2074 6578 745f 7265 6769 6f6e  [0], text_region
-0001d220: 735f 702e 7368 6170 655b 315d 290a 2020  s_p.shape[1]).  
-0001d230: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
-0001d240: 2073 656c 662e 7461 626c 6573 3a0a 2020   self.tables:.  
-0001d250: 2020 2020 2020 2020 2020 2020 2020 7265                re
-0001d260: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
-0001d270: 7061 7261 746f 7273 5f64 203d 2028 7465  parators_d = (te
-0001d280: 7874 5f72 6567 696f 6e73 5f70 5f31 5f6e  xt_regions_p_1_n
-0001d290: 5b3a 2c20 3a5d 203d 3d20 3129 202a 2031  [:, :] == 1) * 1
-0001d2a0: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
-0001d2b0: 2020 2020 2020 2020 2020 2074 6578 745f             text_
-0001d2c0: 7265 6769 6f6e 735f 705f 315f 6e20 3d20  regions_p_1_n = 
-0001d2d0: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
-0001d2e0: 2074 6578 746c 696e 655f 6d61 736b 5f74   textline_mask_t
-0001d2f0: 6f74 5f64 203d 204e 6f6e 650a 2020 2020  ot_d = None.    
-0001d300: 2020 2020 2020 2020 7265 6769 6f6e 735f          regions_
-0001d310: 7769 7468 6f75 745f 7365 7061 7261 746f  without_separato
-0001d320: 7273 5f64 203d 204e 6f6e 650a 2020 2020  rs_d = None.    
-0001d330: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
-0001d340: 7461 626c 6573 3a0a 2020 2020 2020 2020  tables:.        
-0001d350: 2020 2020 7265 6769 6f6e 735f 7769 7468      regions_with
-0001d360: 6f75 745f 7365 7061 7261 746f 7273 203d  out_separators =
-0001d370: 2028 7465 7874 5f72 6567 696f 6e73 5f70   (text_regions_p
-0001d380: 5b3a 2c20 3a5d 203d 3d20 3129 202a 2031  [:, :] == 1) * 1
-0001d390: 0a0a 2020 2020 2020 2020 696d 675f 7265  ..        img_re
-0001d3a0: 7669 7365 645f 7461 6220 3d20 6e70 2e63  vised_tab = np.c
-0001d3b0: 6f70 7928 7465 7874 5f72 6567 696f 6e73  opy(text_regions
-0001d3c0: 5f70 5b3a 2c20 3a5d 290a 2020 2020 2020  _p[:, :]).      
-0001d3d0: 2020 706f 6c79 676f 6e73 5f6f 665f 696d    polygons_of_im
-0001d3e0: 6167 6573 203d 2072 6574 7572 6e5f 636f  ages = return_co
-0001d3f0: 6e74 6f75 7273 5f6f 665f 696e 7465 7265  ntours_of_intere
-0001d400: 7374 6564 5f72 6567 696f 6e28 696d 675f  sted_region(img_
-0001d410: 7265 7669 7365 645f 7461 622c 2035 290a  revised_tab, 5).
-0001d420: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0001d430: 6765 722e 6465 6275 6728 2765 7869 7420  ger.debug('exit 
-0001d440: 7275 6e5f 626f 7865 735f 6675 6c6c 5f6c  run_boxes_full_l
-0001d450: 6179 6f75 7427 290a 2020 2020 2020 2020  ayout').        
-0001d460: 7265 7475 726e 2070 6f6c 7967 6f6e 735f  return polygons_
-0001d470: 6f66 5f69 6d61 6765 732c 2069 6d67 5f72  of_images, img_r
-0001d480: 6576 6973 6564 5f74 6162 2c20 7465 7874  evised_tab, text
-0001d490: 5f72 6567 696f 6e73 5f70 5f31 5f6e 2c20  _regions_p_1_n, 
-0001d4a0: 7465 7874 6c69 6e65 5f6d 6173 6b5f 746f  textline_mask_to
-0001d4b0: 745f 642c 2072 6567 696f 6e73 5f77 6974  t_d, regions_wit
-0001d4c0: 686f 7574 5f73 6570 6172 6174 6f72 735f  hout_separators_
-0001d4d0: 642c 2072 6567 696f 6e73 5f66 756c 6c79  d, regions_fully
-0001d4e0: 2c20 7265 6769 6f6e 735f 7769 7468 6f75  , regions_withou
-0001d4f0: 745f 7365 7061 7261 746f 7273 2c20 706f  t_separators, po
-0001d500: 6c79 676f 6e73 5f6f 665f 6d61 7267 696e  lygons_of_margin
-0001d510: 616c 732c 2063 6f6e 746f 7572 735f 7461  als, contours_ta
-0001d520: 626c 6573 0a0a 2020 2020 6465 6620 7275  bles..    def ru
-0001d530: 6e28 7365 6c66 293a 0a20 2020 2020 2020  n(self):.       
-0001d540: 2022 2222 0a20 2020 2020 2020 2047 6574   """.        Get
-0001d550: 2069 6d61 6765 2061 6e64 2073 6361 6c65   image and scale
-0001d560: 732c 2074 6865 6e20 6578 7472 6163 7420  s, then extract 
-0001d570: 7468 6520 7061 6765 206f 6620 7363 616e  the page of scan
-0001d580: 6e65 6420 696d 6167 650a 2020 2020 2020  ned image.      
-0001d590: 2020 2222 220a 2020 2020 2020 2020 7365    """.        se
-0001d5a0: 6c66 2e6c 6f67 6765 722e 6465 6275 6728  lf.logger.debug(
-0001d5b0: 2265 6e74 6572 2072 756e 2229 0a0a 2020  "enter run")..  
-0001d5c0: 2020 2020 2020 7430 203d 2074 696d 652e        t0 = time.
-0001d5d0: 7469 6d65 2829 0a20 2020 2020 2020 2069  time().        i
-0001d5e0: 6d67 5f72 6573 2c20 6973 5f69 6d61 6765  mg_res, is_image
-0001d5f0: 5f65 6e68 616e 6365 642c 206e 756d 5f63  _enhanced, num_c
-0001d600: 6f6c 5f63 6c61 7373 6966 6965 722c 206e  ol_classifier, n
-0001d610: 756d 5f63 6f6c 756d 6e5f 6973 5f63 6c61  um_column_is_cla
-0001d620: 7373 6966 6965 6420 3d20 7365 6c66 2e72  ssified = self.r
-0001d630: 756e 5f65 6e68 616e 6365 6d65 6e74 2829  un_enhancement()
-0001d640: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
-0001d650: 2020 7365 6c66 2e6c 6f67 6765 722e 696e    self.logger.in
-0001d660: 666f 2822 456e 6861 6e63 696e 6720 746f  fo("Enhancing to
-0001d670: 6f6b 2025 2e31 6673 2022 2c20 7469 6d65  ok %.1fs ", time
-0001d680: 2e74 696d 6528 2920 2d20 7430 290a 0a20  .time() - t0).. 
-0001d690: 2020 2020 2020 2074 3120 3d20 7469 6d65         t1 = time
-0001d6a0: 2e74 696d 6528 290a 2020 2020 2020 2020  .time().        
-0001d6b0: 7465 7874 5f72 6567 696f 6e73 5f70 5f31  text_regions_p_1
-0001d6c0: 202c 6572 6f73 696f 6e5f 6875 7274 732c   ,erosion_hurts,
-0001d6d0: 2070 6f6c 7967 6f6e 735f 6c69 6e65 735f   polygons_lines_
-0001d6e0: 786d 6c20 3d20 7365 6c66 2e67 6574 5f72  xml = self.get_r
-0001d6f0: 6567 696f 6e73 5f66 726f 6d5f 7879 5f32  egions_from_xy_2
-0001d700: 6d6f 6465 6c73 2869 6d67 5f72 6573 2c20  models(img_res, 
-0001d710: 6973 5f69 6d61 6765 5f65 6e68 616e 6365  is_image_enhance
-0001d720: 642c 206e 756d 5f63 6f6c 5f63 6c61 7373  d, num_col_class
-0001d730: 6966 6965 7229 0a20 2020 2020 2020 2073  ifier).        s
-0001d740: 656c 662e 6c6f 6767 6572 2e69 6e66 6f28  elf.logger.info(
-0001d750: 2254 6578 7472 6567 696f 6e20 6465 7465  "Textregion dete
-0001d760: 6374 696f 6e20 746f 6f6b 2025 2e31 6673  ction took %.1fs
-0001d770: 2022 2c20 7469 6d65 2e74 696d 6528 2920   ", time.time() 
-0001d780: 2d20 7431 290a 0a20 2020 2020 2020 2074  - t1)..        t
-0001d790: 3120 3d20 7469 6d65 2e74 696d 6528 290a  1 = time.time().
-0001d7a0: 2020 2020 2020 2020 6e75 6d5f 636f 6c2c          num_col,
-0001d7b0: 206e 756d 5f63 6f6c 5f63 6c61 7373 6966   num_col_classif
-0001d7c0: 6965 722c 2069 6d67 5f6f 6e6c 795f 7265  ier, img_only_re
-0001d7d0: 6769 6f6e 732c 2070 6167 655f 636f 6f72  gions, page_coor
-0001d7e0: 642c 2069 6d61 6765 5f70 6167 652c 206d  d, image_page, m
-0001d7f0: 6173 6b5f 696d 6167 6573 2c20 6d61 736b  ask_images, mask
-0001d800: 5f6c 696e 6573 2c20 7465 7874 5f72 6567  _lines, text_reg
-0001d810: 696f 6e73 5f70 5f31 2c20 636f 6e74 5f70  ions_p_1, cont_p
-0001d820: 6167 652c 2074 6162 6c65 5f70 7265 6469  age, table_predi
-0001d830: 6374 696f 6e20 3d20 5c0a 2020 2020 2020  ction = \.      
-0001d840: 2020 2020 2020 2020 2020 7365 6c66 2e72            self.r
-0001d850: 756e 5f67 7261 7068 6963 735f 616e 645f  un_graphics_and_
-0001d860: 636f 6c75 6d6e 7328 7465 7874 5f72 6567  columns(text_reg
-0001d870: 696f 6e73 5f70 5f31 2c20 6e75 6d5f 636f  ions_p_1, num_co
-0001d880: 6c5f 636c 6173 7369 6669 6572 2c20 6e75  l_classifier, nu
-0001d890: 6d5f 636f 6c75 6d6e 5f69 735f 636c 6173  m_column_is_clas
-0001d8a0: 7369 6669 6564 2c20 6572 6f73 696f 6e5f  sified, erosion_
-0001d8b0: 6875 7274 7329 0a20 2020 2020 2020 2073  hurts).        s
-0001d8c0: 656c 662e 6c6f 6767 6572 2e69 6e66 6f28  elf.logger.info(
-0001d8d0: 2247 7261 7068 6963 7320 6465 7465 6374  "Graphics detect
-0001d8e0: 696f 6e20 746f 6f6b 2025 2e31 6673 2022  ion took %.1fs "
-0001d8f0: 2c20 7469 6d65 2e74 696d 6528 2920 2d20  , time.time() - 
-0001d900: 7431 290a 2020 2020 2020 2020 2373 656c  t1).        #sel
-0001d910: 662e 6c6f 6767 6572 2e69 6e66 6f28 2763  f.logger.info('c
-0001d920: 6f6e 745f 7061 6765 2025 7327 2c20 636f  ont_page %s', co
-0001d930: 6e74 5f70 6167 6529 0a0a 2020 2020 2020  nt_page)..      
-0001d940: 2020 6966 206e 6f74 206e 756d 5f63 6f6c    if not num_col
-0001d950: 3a0a 2020 2020 2020 2020 2020 2020 7365  :.            se
-0001d960: 6c66 2e6c 6f67 6765 722e 696e 666f 2822  lf.logger.info("
-0001d970: 4e6f 2063 6f6c 756d 6e73 2064 6574 6563  No columns detec
-0001d980: 7465 642c 206f 7574 7075 7474 696e 6720  ted, outputting 
-0001d990: 616e 2065 6d70 7479 2050 4147 452d 584d  an empty PAGE-XM
-0001d9a0: 4c22 290a 2020 2020 2020 2020 2020 2020  L").            
-0001d9b0: 7063 6774 7320 3d20 7365 6c66 2e77 7269  pcgts = self.wri
-0001d9c0: 7465 722e 6275 696c 645f 7061 6765 786d  ter.build_pagexm
-0001d9d0: 6c5f 6e6f 5f66 756c 6c5f 6c61 796f 7574  l_no_full_layout
-0001d9e0: 285b 5d2c 2070 6167 655f 636f 6f72 642c  ([], page_coord,
-0001d9f0: 205b 5d2c 205b 5d2c 205b 5d2c 205b 5d2c   [], [], [], [],
-0001da00: 205b 5d2c 205b 5d2c 205b 5d2c 205b 5d2c   [], [], [], [],
-0001da10: 205b 5d2c 205b 5d2c 2063 6f6e 745f 7061   [], [], cont_pa
-0001da20: 6765 2c20 5b5d 2c20 5b5d 290a 2020 2020  ge, [], []).    
-0001da30: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0001da40: 6765 722e 696e 666f 2822 4a6f 6220 646f  ger.info("Job do
-0001da50: 6e65 2069 6e20 252e 3166 7322 2c20 7469  ne in %.1fs", ti
-0001da60: 6d65 2e74 696d 6528 2920 2d20 7431 290a  me.time() - t1).
-0001da70: 2020 2020 2020 2020 2020 2020 7265 7475              retu
-0001da80: 726e 2070 6367 7473 0a0a 2020 2020 2020  rn pcgts..      
-0001da90: 2020 7431 203d 2074 696d 652e 7469 6d65    t1 = time.time
-0001daa0: 2829 0a20 2020 2020 2020 2074 6578 746c  ().        textl
-0001dab0: 696e 655f 6d61 736b 5f74 6f74 5f65 6120  ine_mask_tot_ea 
-0001dac0: 3d20 7365 6c66 2e72 756e 5f74 6578 746c  = self.run_textl
-0001dad0: 696e 6528 696d 6167 655f 7061 6765 290a  ine(image_page).
-0001dae0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0001daf0: 6765 722e 696e 666f 2822 7465 7874 6c69  ger.info("textli
-0001db00: 6e65 2064 6574 6563 7469 6f6e 2074 6f6f  ne detection too
-0001db10: 6b20 252e 3166 7322 2c20 7469 6d65 2e74  k %.1fs", time.t
-0001db20: 696d 6528 2920 2d20 7431 290a 0a20 2020  ime() - t1)..   
-0001db30: 2020 2020 2074 3120 3d20 7469 6d65 2e74       t1 = time.t
-0001db40: 696d 6528 290a 2020 2020 2020 2020 736c  ime().        sl
-0001db50: 6f70 655f 6465 736b 6577 2c20 736c 6f70  ope_deskew, slop
-0001db60: 655f 6669 7273 7420 3d20 7365 6c66 2e72  e_first = self.r
-0001db70: 756e 5f64 6573 6b65 7728 7465 7874 6c69  un_deskew(textli
-0001db80: 6e65 5f6d 6173 6b5f 746f 745f 6561 290a  ne_mask_tot_ea).
-0001db90: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
-0001dba0: 6765 722e 696e 666f 2822 6465 736b 6577  ger.info("deskew
-0001dbb0: 696e 6720 746f 6f6b 2025 2e31 6673 222c  ing took %.1fs",
-0001dbc0: 2074 696d 652e 7469 6d65 2829 202d 2074   time.time() - t
-0001dbd0: 3129 0a20 2020 2020 2020 2074 3120 3d20  1).        t1 = 
-0001dbe0: 7469 6d65 2e74 696d 6528 290a 2020 2020  time.time().    
-0001dbf0: 2020 2020 2370 6c74 2e69 6d73 686f 7728      #plt.imshow(
-0001dc00: 7461 626c 655f 7072 6564 6963 7469 6f6e  table_prediction
-0001dc10: 290a 2020 2020 2020 2020 2370 6c74 2e73  ).        #plt.s
-0001dc20: 686f 7728 290a 0a20 2020 2020 2020 2074  how()..        t
-0001dc30: 6578 746c 696e 655f 6d61 736b 5f74 6f74  extline_mask_tot
-0001dc40: 2c20 7465 7874 5f72 6567 696f 6e73 5f70  , text_regions_p
-0001dc50: 2c20 696d 6167 655f 7061 6765 5f72 6f74  , image_page_rot
-0001dc60: 6174 6564 203d 2073 656c 662e 7275 6e5f  ated = self.run_
-0001dc70: 6d61 7267 696e 616c 7328 696d 6167 655f  marginals(image_
-0001dc80: 7061 6765 2c20 7465 7874 6c69 6e65 5f6d  page, textline_m
-0001dc90: 6173 6b5f 746f 745f 6561 2c20 6d61 736b  ask_tot_ea, mask
-0001dca0: 5f69 6d61 6765 732c 206d 6173 6b5f 6c69  _images, mask_li
-0001dcb0: 6e65 732c 206e 756d 5f63 6f6c 5f63 6c61  nes, num_col_cla
-0001dcc0: 7373 6966 6965 722c 2073 6c6f 7065 5f64  ssifier, slope_d
-0001dcd0: 6573 6b65 772c 2074 6578 745f 7265 6769  eskew, text_regi
-0001dce0: 6f6e 735f 705f 312c 2074 6162 6c65 5f70  ons_p_1, table_p
-0001dcf0: 7265 6469 6374 696f 6e29 0a20 2020 2020  rediction).     
-0001dd00: 2020 2073 656c 662e 6c6f 6767 6572 2e69     self.logger.i
-0001dd10: 6e66 6f28 2264 6574 6563 7469 6f6e 206f  nfo("detection o
-0001dd20: 6620 6d61 7267 696e 616c 7320 746f 6f6b  f marginals took
-0001dd30: 2025 2e31 6673 222c 2074 696d 652e 7469   %.1fs", time.ti
-0001dd40: 6d65 2829 202d 2074 3129 0a20 2020 2020  me() - t1).     
-0001dd50: 2020 2074 3120 3d20 7469 6d65 2e74 696d     t1 = time.tim
-0001dd60: 6528 290a 2020 2020 2020 2020 6966 206e  e().        if n
-0001dd70: 6f74 2073 656c 662e 6675 6c6c 5f6c 6179  ot self.full_lay
-0001dd80: 6f75 743a 0a20 2020 2020 2020 2020 2020  out:.           
-0001dd90: 2070 6f6c 7967 6f6e 735f 6f66 5f69 6d61   polygons_of_ima
-0001dda0: 6765 732c 2069 6d67 5f72 6576 6973 6564  ges, img_revised
-0001ddb0: 5f74 6162 2c20 7465 7874 5f72 6567 696f  _tab, text_regio
-0001ddc0: 6e73 5f70 5f31 5f6e 2c20 7465 7874 6c69  ns_p_1_n, textli
-0001ddd0: 6e65 5f6d 6173 6b5f 746f 745f 642c 2072  ne_mask_tot_d, r
-0001dde0: 6567 696f 6e73 5f77 6974 686f 7574 5f73  egions_without_s
-0001ddf0: 6570 6172 6174 6f72 735f 642c 2062 6f78  eparators_d, box
-0001de00: 6573 2c20 626f 7865 735f 642c 2070 6f6c  es, boxes_d, pol
-0001de10: 7967 6f6e 735f 6f66 5f6d 6172 6769 6e61  ygons_of_margina
-0001de20: 6c73 2c20 636f 6e74 6f75 7273 5f74 6162  ls, contours_tab
-0001de30: 6c65 7320 3d20 7365 6c66 2e72 756e 5f62  les = self.run_b
-0001de40: 6f78 6573 5f6e 6f5f 6675 6c6c 5f6c 6179  oxes_no_full_lay
-0001de50: 6f75 7428 696d 6167 655f 7061 6765 2c20  out(image_page, 
-0001de60: 7465 7874 6c69 6e65 5f6d 6173 6b5f 746f  textline_mask_to
-0001de70: 742c 2074 6578 745f 7265 6769 6f6e 735f  t, text_regions_
-0001de80: 702c 2073 6c6f 7065 5f64 6573 6b65 772c  p, slope_deskew,
-0001de90: 206e 756d 5f63 6f6c 5f63 6c61 7373 6966   num_col_classif
-0001dea0: 6965 722c 2074 6162 6c65 5f70 7265 6469  ier, table_predi
-0001deb0: 6374 696f 6e2c 2065 726f 7369 6f6e 5f68  ction, erosion_h
-0001dec0: 7572 7473 290a 2020 2020 2020 2020 0a20  urts).        . 
-0001ded0: 2020 2020 2020 2069 6620 7365 6c66 2e66         if self.f
-0001dee0: 756c 6c5f 6c61 796f 7574 3a0a 2020 2020  ull_layout:.    
-0001def0: 2020 2020 2020 2020 706f 6c79 676f 6e73          polygons
-0001df00: 5f6f 665f 696d 6167 6573 2c20 696d 675f  _of_images, img_
-0001df10: 7265 7669 7365 645f 7461 622c 2074 6578  revised_tab, tex
-0001df20: 745f 7265 6769 6f6e 735f 705f 315f 6e2c  t_regions_p_1_n,
-0001df30: 2074 6578 746c 696e 655f 6d61 736b 5f74   textline_mask_t
-0001df40: 6f74 5f64 2c20 7265 6769 6f6e 735f 7769  ot_d, regions_wi
-0001df50: 7468 6f75 745f 7365 7061 7261 746f 7273  thout_separators
-0001df60: 5f64 2c20 7265 6769 6f6e 735f 6675 6c6c  _d, regions_full
-0001df70: 792c 2072 6567 696f 6e73 5f77 6974 686f  y, regions_witho
-0001df80: 7574 5f73 6570 6172 6174 6f72 732c 2070  ut_separators, p
-0001df90: 6f6c 7967 6f6e 735f 6f66 5f6d 6172 6769  olygons_of_margi
-0001dfa0: 6e61 6c73 2c20 636f 6e74 6f75 7273 5f74  nals, contours_t
-0001dfb0: 6162 6c65 7320 3d20 7365 6c66 2e72 756e  ables = self.run
-0001dfc0: 5f62 6f78 6573 5f66 756c 6c5f 6c61 796f  _boxes_full_layo
-0001dfd0: 7574 2869 6d61 6765 5f70 6167 652c 2074  ut(image_page, t
-0001dfe0: 6578 746c 696e 655f 6d61 736b 5f74 6f74  extline_mask_tot
-0001dff0: 2c20 7465 7874 5f72 6567 696f 6e73 5f70  , text_regions_p
-0001e000: 2c20 736c 6f70 655f 6465 736b 6577 2c20  , slope_deskew, 
-0001e010: 6e75 6d5f 636f 6c5f 636c 6173 7369 6669  num_col_classifi
-0001e020: 6572 2c20 696d 675f 6f6e 6c79 5f72 6567  er, img_only_reg
-0001e030: 696f 6e73 2c20 7461 626c 655f 7072 6564  ions, table_pred
-0001e040: 6963 7469 6f6e 2c20 6572 6f73 696f 6e5f  iction, erosion_
-0001e050: 6875 7274 7329 0a20 2020 2020 2020 2074  hurts).        t
-0001e060: 6578 745f 6f6e 6c79 203d 2028 2869 6d67  ext_only = ((img
-0001e070: 5f72 6576 6973 6564 5f74 6162 5b3a 2c20  _revised_tab[:, 
-0001e080: 3a5d 203d 3d20 3129 2920 2a20 310a 2020  :] == 1)) * 1.  
-0001e090: 2020 2020 2020 6966 206e 702e 6162 7328        if np.abs(
-0001e0a0: 736c 6f70 655f 6465 736b 6577 2920 3e3d  slope_deskew) >=
-0001e0b0: 2053 4c4f 5045 5f54 4852 4553 484f 4c44   SLOPE_THRESHOLD
-0001e0c0: 3a0a 2020 2020 2020 2020 2020 2020 7465  :.            te
-0001e0d0: 7874 5f6f 6e6c 795f 6420 3d20 2828 7465  xt_only_d = ((te
-0001e0e0: 7874 5f72 6567 696f 6e73 5f70 5f31 5f6e  xt_regions_p_1_n
-0001e0f0: 5b3a 2c20 3a5d 203d 3d20 3129 2920 2a20  [:, :] == 1)) * 
-0001e100: 310a 0a20 2020 2020 2020 206d 696e 5f63  1..        min_c
-0001e110: 6f6e 5f61 7265 6120 3d20 302e 3030 3030  on_area = 0.0000
-0001e120: 3035 0a20 2020 2020 2020 2069 6620 6e70  05.        if np
-0001e130: 2e61 6273 2873 6c6f 7065 5f64 6573 6b65  .abs(slope_deske
-0001e140: 7729 203e 3d20 534c 4f50 455f 5448 5245  w) >= SLOPE_THRE
-0001e150: 5348 4f4c 443a 0a20 2020 2020 2020 2020  SHOLD:.         
-0001e160: 2020 2063 6f6e 746f 7572 735f 6f6e 6c79     contours_only
-0001e170: 5f74 6578 742c 2068 6972 5f6f 6e5f 7465  _text, hir_on_te
-0001e180: 7874 203d 2072 6574 7572 6e5f 636f 6e74  xt = return_cont
-0001e190: 6f75 7273 5f6f 665f 696d 6167 6528 7465  ours_of_image(te
-0001e1a0: 7874 5f6f 6e6c 7929 0a20 2020 2020 2020  xt_only).       
-0001e1b0: 2020 2020 2063 6f6e 746f 7572 735f 6f6e       contours_on
-0001e1c0: 6c79 5f74 6578 745f 7061 7265 6e74 203d  ly_text_parent =
-0001e1d0: 2072 6574 7572 6e5f 7061 7265 6e74 5f63   return_parent_c
-0001e1e0: 6f6e 746f 7572 7328 636f 6e74 6f75 7273  ontours(contours
-0001e1f0: 5f6f 6e6c 795f 7465 7874 2c20 6869 725f  _only_text, hir_
-0001e200: 6f6e 5f74 6578 7429 0a20 2020 2020 2020  on_text).       
-0001e210: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e220: 200a 2020 2020 2020 2020 2020 2020 6966   .            if
-0001e230: 206c 656e 2863 6f6e 746f 7572 735f 6f6e   len(contours_on
-0001e240: 6c79 5f74 6578 745f 7061 7265 6e74 2920  ly_text_parent) 
-0001e250: 3e20 303a 0a20 2020 2020 2020 2020 2020  > 0:.           
-0001e260: 2020 2020 2061 7265 6173 5f63 6e74 5f74       areas_cnt_t
-0001e270: 6578 7420 3d20 6e70 2e61 7272 6179 285b  ext = np.array([
-0001e280: 6376 322e 636f 6e74 6f75 7241 7265 6128  cv2.contourArea(
-0001e290: 6329 2066 6f72 2063 2069 6e20 636f 6e74  c) for c in cont
-0001e2a0: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
-0001e2b0: 6172 656e 745d 290a 2020 2020 2020 2020  arent]).        
-0001e2c0: 2020 2020 2020 2020 6172 6561 735f 636e          areas_cn
-0001e2d0: 745f 7465 7874 203d 2061 7265 6173 5f63  t_text = areas_c
-0001e2e0: 6e74 5f74 6578 7420 2f20 666c 6f61 7428  nt_text / float(
-0001e2f0: 7465 7874 5f6f 6e6c 792e 7368 6170 655b  text_only.shape[
-0001e300: 305d 202a 2074 6578 745f 6f6e 6c79 2e73  0] * text_only.s
-0001e310: 6861 7065 5b31 5d29 0a20 2020 2020 2020  hape[1]).       
-0001e320: 2020 2020 2020 2020 2023 7365 6c66 2e6c           #self.l
-0001e330: 6f67 6765 722e 696e 666f 2827 6172 6561  ogger.info('area
-0001e340: 735f 636e 745f 7465 7874 2025 7327 2c20  s_cnt_text %s', 
-0001e350: 6172 6561 735f 636e 745f 7465 7874 290a  areas_cnt_text).
-0001e360: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e370: 636f 6e74 6f75 7273 5f62 6967 6765 7374  contours_biggest
-0001e380: 203d 2063 6f6e 746f 7572 735f 6f6e 6c79   = contours_only
-0001e390: 5f74 6578 745f 7061 7265 6e74 5b6e 702e  _text_parent[np.
-0001e3a0: 6172 676d 6178 2861 7265 6173 5f63 6e74  argmax(areas_cnt
-0001e3b0: 5f74 6578 7429 5d0a 2020 2020 2020 2020  _text)].        
-0001e3c0: 2020 2020 2020 2020 636f 6e74 6f75 7273          contours
-0001e3d0: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
-0001e3e0: 7420 3d20 5b63 2066 6f72 206a 7a2c 2063  t = [c for jz, c
-0001e3f0: 2069 6e20 656e 756d 6572 6174 6528 636f   in enumerate(co
-0001e400: 6e74 6f75 7273 5f6f 6e6c 795f 7465 7874  ntours_only_text
-0001e410: 5f70 6172 656e 7429 2069 6620 6172 6561  _parent) if area
-0001e420: 735f 636e 745f 7465 7874 5b6a 7a5d 203e  s_cnt_text[jz] >
-0001e430: 206d 696e 5f63 6f6e 5f61 7265 615d 0a20   min_con_area]. 
-0001e440: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0001e450: 7265 6173 5f63 6e74 5f74 6578 745f 7061  reas_cnt_text_pa
-0001e460: 7265 6e74 203d 205b 6172 6561 2066 6f72  rent = [area for
-0001e470: 2061 7265 6120 696e 2061 7265 6173 5f63   area in areas_c
-0001e480: 6e74 5f74 6578 7420 6966 2061 7265 6120  nt_text if area 
-0001e490: 3e20 6d69 6e5f 636f 6e5f 6172 6561 5d0a  > min_con_area].
-0001e4a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e4b0: 2069 6e64 6578 5f63 6f6e 5f70 6172 656e   index_con_paren
-0001e4c0: 7473 203d 206e 702e 6172 6773 6f72 7428  ts = np.argsort(
-0001e4d0: 6172 6561 735f 636e 745f 7465 7874 5f70  areas_cnt_text_p
-0001e4e0: 6172 656e 7429 0a20 2020 2020 2020 2020  arent).         
-0001e4f0: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
-0001e500: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
-0001e510: 203d 206c 6973 7428 6e70 2e61 7272 6179   = list(np.array
-0001e520: 2863 6f6e 746f 7572 735f 6f6e 6c79 5f74  (contours_only_t
-0001e530: 6578 745f 7061 7265 6e74 2c20 6474 7970  ext_parent, dtyp
-0001e540: 653d 6f62 6a65 6374 295b 696e 6465 785f  e=object)[index_
-0001e550: 636f 6e5f 7061 7265 6e74 735d 290a 2020  con_parents]).  
-0001e560: 2020 2020 2020 2020 2020 2020 2020 6172                ar
-0001e570: 6561 735f 636e 745f 7465 7874 5f70 6172  eas_cnt_text_par
-0001e580: 656e 7420 3d20 6c69 7374 286e 702e 6172  ent = list(np.ar
-0001e590: 7261 7928 6172 6561 735f 636e 745f 7465  ray(areas_cnt_te
-0001e5a0: 7874 5f70 6172 656e 7429 5b69 6e64 6578  xt_parent)[index
-0001e5b0: 5f63 6f6e 5f70 6172 656e 7473 5d29 0a0a  _con_parents])..
-0001e5c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e5d0: 6378 5f62 6967 6573 745f 6269 672c 2063  cx_bigest_big, c
-0001e5e0: 795f 6269 6767 6573 745f 6269 672c 205f  y_biggest_big, _
-0001e5f0: 2c20 5f2c 205f 2c20 5f2c 205f 203d 2066  , _, _, _, _ = f
-0001e600: 696e 645f 6e65 775f 6665 6174 7572 6573  ind_new_features
-0001e610: 5f6f 665f 636f 6e74 6f75 7273 285b 636f  _of_contours([co
-0001e620: 6e74 6f75 7273 5f62 6967 6765 7374 5d29  ntours_biggest])
-0001e630: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001e640: 2063 785f 6269 6765 7374 2c20 6379 5f62   cx_bigest, cy_b
-0001e650: 6967 6765 7374 2c20 5f2c 205f 2c20 5f2c  iggest, _, _, _,
-0001e660: 205f 2c20 5f20 3d20 6669 6e64 5f6e 6577   _, _ = find_new
-0001e670: 5f66 6561 7475 7265 735f 6f66 5f63 6f6e  _features_of_con
-0001e680: 746f 7572 7328 636f 6e74 6f75 7273 5f6f  tours(contours_o
-0001e690: 6e6c 795f 7465 7874 5f70 6172 656e 7429  nly_text_parent)
-0001e6a0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001e6b0: 2020 636f 6e74 6f75 7273 5f6f 6e6c 795f    contours_only_
-0001e6c0: 7465 7874 5f64 2c20 6869 725f 6f6e 5f74  text_d, hir_on_t
-0001e6d0: 6578 745f 6420 3d20 7265 7475 726e 5f63  ext_d = return_c
-0001e6e0: 6f6e 746f 7572 735f 6f66 5f69 6d61 6765  ontours_of_image
-0001e6f0: 2874 6578 745f 6f6e 6c79 5f64 290a 2020  (text_only_d).  
-0001e700: 2020 2020 2020 2020 2020 2020 2020 636f                co
-0001e710: 6e74 6f75 7273 5f6f 6e6c 795f 7465 7874  ntours_only_text
-0001e720: 5f70 6172 656e 745f 6420 3d20 7265 7475  _parent_d = retu
-0001e730: 726e 5f70 6172 656e 745f 636f 6e74 6f75  rn_parent_contou
-0001e740: 7273 2863 6f6e 746f 7572 735f 6f6e 6c79  rs(contours_only
-0001e750: 5f74 6578 745f 642c 2068 6972 5f6f 6e5f  _text_d, hir_on_
-0001e760: 7465 7874 5f64 290a 0a20 2020 2020 2020  text_d)..       
-0001e770: 2020 2020 2020 2020 2061 7265 6173 5f63           areas_c
-0001e780: 6e74 5f74 6578 745f 6420 3d20 6e70 2e61  nt_text_d = np.a
-0001e790: 7272 6179 285b 6376 322e 636f 6e74 6f75  rray([cv2.contou
-0001e7a0: 7241 7265 6128 6329 2066 6f72 2063 2069  rArea(c) for c i
-0001e7b0: 6e20 636f 6e74 6f75 7273 5f6f 6e6c 795f  n contours_only_
-0001e7c0: 7465 7874 5f70 6172 656e 745f 645d 290a  text_parent_d]).
-0001e7d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e7e0: 6172 6561 735f 636e 745f 7465 7874 5f64  areas_cnt_text_d
-0001e7f0: 203d 2061 7265 6173 5f63 6e74 5f74 6578   = areas_cnt_tex
-0001e800: 745f 6420 2f20 666c 6f61 7428 7465 7874  t_d / float(text
-0001e810: 5f6f 6e6c 795f 642e 7368 6170 655b 305d  _only_d.shape[0]
-0001e820: 202a 2074 6578 745f 6f6e 6c79 5f64 2e73   * text_only_d.s
-0001e830: 6861 7065 5b31 5d29 0a20 2020 2020 2020  hape[1]).       
-0001e840: 2020 2020 2020 2020 200a 2020 2020 2020           .      
-0001e850: 2020 2020 2020 2020 2020 6966 206c 656e            if len
-0001e860: 2861 7265 6173 5f63 6e74 5f74 6578 745f  (areas_cnt_text_
-0001e870: 6429 3e30 3a0a 2020 2020 2020 2020 2020  d)>0:.          
-0001e880: 2020 2020 2020 2020 2020 636f 6e74 6f75            contou
-0001e890: 7273 5f62 6967 6765 7374 5f64 203d 2063  rs_biggest_d = c
-0001e8a0: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
-0001e8b0: 745f 7061 7265 6e74 5f64 5b6e 702e 6172  t_parent_d[np.ar
-0001e8c0: 676d 6178 2861 7265 6173 5f63 6e74 5f74  gmax(areas_cnt_t
-0001e8d0: 6578 745f 6429 5d0a 2020 2020 2020 2020  ext_d)].        
-0001e8e0: 2020 2020 2020 2020 2020 2020 696e 6465              inde
-0001e8f0: 785f 636f 6e5f 7061 7265 6e74 735f 6420  x_con_parents_d 
-0001e900: 3d20 6e70 2e61 7267 736f 7274 2861 7265  = np.argsort(are
-0001e910: 6173 5f63 6e74 5f74 6578 745f 6429 0a20  as_cnt_text_d). 
-0001e920: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e930: 2020 2063 6f6e 746f 7572 735f 6f6e 6c79     contours_only
-0001e940: 5f74 6578 745f 7061 7265 6e74 5f64 203d  _text_parent_d =
-0001e950: 206c 6973 7428 6e70 2e61 7272 6179 2863   list(np.array(c
-0001e960: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
-0001e970: 745f 7061 7265 6e74 5f64 2c20 6474 7970  t_parent_d, dtyp
-0001e980: 653d 6f62 6a65 6374 295b 696e 6465 785f  e=object)[index_
-0001e990: 636f 6e5f 7061 7265 6e74 735f 645d 290a  con_parents_d]).
-0001e9a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001e9b0: 2020 2020 6172 6561 735f 636e 745f 7465      areas_cnt_te
-0001e9c0: 7874 5f64 203d 206c 6973 7428 6e70 2e61  xt_d = list(np.a
-0001e9d0: 7272 6179 2861 7265 6173 5f63 6e74 5f74  rray(areas_cnt_t
-0001e9e0: 6578 745f 6429 5b69 6e64 6578 5f63 6f6e  ext_d)[index_con
-0001e9f0: 5f70 6172 656e 7473 5f64 5d29 0a0a 2020  _parents_d])..  
-0001ea00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ea10: 2020 6378 5f62 6967 6573 745f 645f 6269    cx_bigest_d_bi
-0001ea20: 672c 2063 795f 6269 6767 6573 745f 645f  g, cy_biggest_d_
-0001ea30: 6269 672c 205f 2c20 5f2c 205f 2c20 5f2c  big, _, _, _, _,
-0001ea40: 205f 203d 2066 696e 645f 6e65 775f 6665   _ = find_new_fe
-0001ea50: 6174 7572 6573 5f6f 665f 636f 6e74 6f75  atures_of_contou
-0001ea60: 7273 285b 636f 6e74 6f75 7273 5f62 6967  rs([contours_big
-0001ea70: 6765 7374 5f64 5d29 0a20 2020 2020 2020  gest_d]).       
-0001ea80: 2020 2020 2020 2020 2020 2020 2063 785f               cx_
-0001ea90: 6269 6765 7374 5f64 2c20 6379 5f62 6967  bigest_d, cy_big
-0001eaa0: 6765 7374 5f64 2c20 5f2c 205f 2c20 5f2c  gest_d, _, _, _,
-0001eab0: 205f 2c20 5f20 3d20 6669 6e64 5f6e 6577   _, _ = find_new
-0001eac0: 5f66 6561 7475 7265 735f 6f66 5f63 6f6e  _features_of_con
-0001ead0: 746f 7572 7328 636f 6e74 6f75 7273 5f6f  tours(contours_o
-0001eae0: 6e6c 795f 7465 7874 5f70 6172 656e 745f  nly_text_parent_
-0001eaf0: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
-0001eb00: 2020 2020 2020 2074 7279 3a0a 2020 2020         try:.    
-0001eb10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eb20: 2020 2020 6966 206c 656e 2863 785f 6269      if len(cx_bi
-0001eb30: 6765 7374 5f64 2920 3e3d 2035 3a0a 2020  gest_d) >= 5:.  
-0001eb40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eb50: 2020 2020 2020 2020 2020 6378 5f62 6967            cx_big
-0001eb60: 6573 745f 645f 6c61 7374 3520 3d20 6378  est_d_last5 = cx
-0001eb70: 5f62 6967 6573 745f 645b 2d35 3a5d 0a20  _bigest_d[-5:]. 
-0001eb80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eb90: 2020 2020 2020 2020 2020 2063 795f 6269             cy_bi
-0001eba0: 6767 6573 745f 645f 6c61 7374 3520 3d20  ggest_d_last5 = 
-0001ebb0: 6379 5f62 6967 6765 7374 5f64 5b2d 353a  cy_biggest_d[-5:
-0001ebc0: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001ebd0: 2020 2020 2020 2020 2020 2020 2020 6469                di
-0001ebe0: 7374 735f 6420 3d20 5b6d 6174 682e 7371  sts_d = [math.sq
-0001ebf0: 7274 2828 6378 5f62 6967 6573 745f 6269  rt((cx_bigest_bi
-0001ec00: 675b 305d 202d 2063 785f 6269 6765 7374  g[0] - cx_bigest
-0001ec10: 5f64 5f6c 6173 7435 5b6a 5d29 202a 2a20  _d_last5[j]) ** 
-0001ec20: 3220 2b20 2863 795f 6269 6767 6573 745f  2 + (cy_biggest_
-0001ec30: 6269 675b 305d 202d 2063 795f 6269 6767  big[0] - cy_bigg
-0001ec40: 6573 745f 645f 6c61 7374 355b 6a5d 2920  est_d_last5[j]) 
-0001ec50: 2a2a 2032 2920 666f 7220 6a20 696e 2072  ** 2) for j in r
-0001ec60: 616e 6765 286c 656e 2863 795f 6269 6767  ange(len(cy_bigg
-0001ec70: 6573 745f 645f 6c61 7374 3529 295d 0a20  est_d_last5))]. 
-0001ec80: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ec90: 2020 2020 2020 2020 2020 2069 6e64 5f6c             ind_l
-0001eca0: 6172 6765 7374 203d 206c 656e 2863 785f  argest = len(cx_
-0001ecb0: 6269 6765 7374 5f64 2920 2d35 202b 206e  bigest_d) -5 + n
-0001ecc0: 702e 6172 676d 696e 2864 6973 7473 5f64  p.argmin(dists_d
-0001ecd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001ece0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0001ecf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed00: 2020 2020 2020 2020 2020 2020 6378 5f62              cx_b
-0001ed10: 6967 6573 745f 645f 6c61 7374 3520 3d20  igest_d_last5 = 
-0001ed20: 6378 5f62 6967 6573 745f 645b 2d6c 656e  cx_bigest_d[-len
-0001ed30: 2863 785f 6269 6765 7374 5f64 293a 5d0a  (cx_bigest_d):].
-0001ed40: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ed50: 2020 2020 2020 2020 2020 2020 6379 5f62              cy_b
-0001ed60: 6967 6765 7374 5f64 5f6c 6173 7435 203d  iggest_d_last5 =
-0001ed70: 2063 795f 6269 6767 6573 745f 645b 2d6c   cy_biggest_d[-l
-0001ed80: 656e 2863 785f 6269 6765 7374 5f64 293a  en(cx_bigest_d):
-0001ed90: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
-0001eda0: 2020 2020 2020 2020 2020 2020 2020 6469                di
-0001edb0: 7374 735f 6420 3d20 5b6d 6174 682e 7371  sts_d = [math.sq
-0001edc0: 7274 2828 6378 5f62 6967 6573 745f 6269  rt((cx_bigest_bi
-0001edd0: 675b 305d 2d63 785f 6269 6765 7374 5f64  g[0]-cx_bigest_d
-0001ede0: 5f6c 6173 7435 5b6a 5d29 2a2a 3220 2b20  _last5[j])**2 + 
-0001edf0: 2863 795f 6269 6767 6573 745f 6269 675b  (cy_biggest_big[
-0001ee00: 305d 2d63 795f 6269 6767 6573 745f 645f  0]-cy_biggest_d_
-0001ee10: 6c61 7374 355b 6a5d 292a 2a32 2920 666f  last5[j])**2) fo
-0001ee20: 7220 6a20 696e 2072 616e 6765 286c 656e  r j in range(len
-0001ee30: 2863 795f 6269 6767 6573 745f 645f 6c61  (cy_biggest_d_la
-0001ee40: 7374 3529 295d 0a20 2020 2020 2020 2020  st5))].         
-0001ee50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ee60: 2020 2069 6e64 5f6c 6172 6765 7374 203d     ind_largest =
-0001ee70: 206c 656e 2863 785f 6269 6765 7374 5f64   len(cx_bigest_d
-0001ee80: 2920 2d20 6c65 6e28 6378 5f62 6967 6573  ) - len(cx_biges
-0001ee90: 745f 6429 202b 206e 702e 6172 676d 696e  t_d) + np.argmin
-0001eea0: 2864 6973 7473 5f64 290a 2020 2020 2020  (dists_d).      
-0001eeb0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001eec0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
-0001eed0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001eee0: 785f 6269 6765 7374 5f64 5f62 6967 5b30  x_bigest_d_big[0
-0001eef0: 5d20 3d20 6378 5f62 6967 6573 745f 645b  ] = cx_bigest_d[
-0001ef00: 696e 645f 6c61 7267 6573 745d 0a20 2020  ind_largest].   
-0001ef10: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001ef20: 2020 2020 2063 795f 6269 6767 6573 745f       cy_biggest_
-0001ef30: 645f 6269 675b 305d 203d 2063 795f 6269  d_big[0] = cy_bi
-0001ef40: 6767 6573 745f 645b 696e 645f 6c61 7267  ggest_d[ind_larg
-0001ef50: 6573 745d 0a20 2020 2020 2020 2020 2020  est].           
-0001ef60: 2020 2020 2020 2020 2065 7863 6570 7420           except 
-0001ef70: 4578 6365 7074 696f 6e20 6173 2077 6879  Exception as why
-0001ef80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001ef90: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
-0001efa0: 6f67 6765 722e 6572 726f 7228 7768 7929  ogger.error(why)
-0001efb0: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001efc0: 2020 2020 2020 2868 2c20 7729 203d 2074        (h, w) = t
-0001efd0: 6578 745f 6f6e 6c79 2e73 6861 7065 5b3a  ext_only.shape[:
-0001efe0: 325d 0a20 2020 2020 2020 2020 2020 2020  2].             
-0001eff0: 2020 2020 2020 2063 656e 7465 7220 3d20         center = 
-0001f000: 2877 202f 2f20 322e 302c 2068 202f 2f20  (w // 2.0, h // 
-0001f010: 322e 3029 0a20 2020 2020 2020 2020 2020  2.0).           
-0001f020: 2020 2020 2020 2020 204d 203d 2063 7632           M = cv2
-0001f030: 2e67 6574 526f 7461 7469 6f6e 4d61 7472  .getRotationMatr
-0001f040: 6978 3244 2863 656e 7465 722c 2073 6c6f  ix2D(center, slo
-0001f050: 7065 5f64 6573 6b65 772c 2031 2e30 290a  pe_deskew, 1.0).
-0001f060: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f070: 2020 2020 4d5f 3232 203d 206e 702e 6172      M_22 = np.ar
-0001f080: 7261 7928 4d29 5b3a 322c 203a 325d 0a20  ray(M)[:2, :2]. 
-0001f090: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f0a0: 2020 2070 5f62 6967 203d 206e 702e 646f     p_big = np.do
-0001f0b0: 7428 4d5f 3232 2c20 5b63 785f 6269 6765  t(M_22, [cx_bige
-0001f0c0: 7374 5f62 6967 2c20 6379 5f62 6967 6765  st_big, cy_bigge
-0001f0d0: 7374 5f62 6967 5d29 0a20 2020 2020 2020  st_big]).       
-0001f0e0: 2020 2020 2020 2020 2020 2020 2078 5f64               x_d
-0001f0f0: 6966 6620 3d20 705f 6269 675b 305d 202d  iff = p_big[0] -
-0001f100: 2063 785f 6269 6765 7374 5f64 5f62 6967   cx_bigest_d_big
-0001f110: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f120: 2020 2020 2079 5f64 6966 6620 3d20 705f       y_diff = p_
-0001f130: 6269 675b 315d 202d 2063 795f 6269 6767  big[1] - cy_bigg
-0001f140: 6573 745f 645f 6269 670a 0a20 2020 2020  est_d_big..     
-0001f150: 2020 2020 2020 2020 2020 2020 2020 2063                 c
-0001f160: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
-0001f170: 745f 7061 7265 6e74 5f64 5f6f 7264 6572  t_parent_d_order
-0001f180: 6564 203d 205b 5d0a 2020 2020 2020 2020  ed = [].        
-0001f190: 2020 2020 2020 2020 2020 2020 666f 7220              for 
-0001f1a0: 6920 696e 2072 616e 6765 286c 656e 2863  i in range(len(c
-0001f1b0: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
-0001f1c0: 745f 7061 7265 6e74 2929 3a0a 2020 2020  t_parent)):.    
-0001f1d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f1e0: 2020 2020 7020 3d20 6e70 2e64 6f74 284d      p = np.dot(M
-0001f1f0: 5f32 322c 205b 6378 5f62 6967 6573 745b  _22, [cx_bigest[
-0001f200: 695d 2c20 6379 5f62 6967 6765 7374 5b69  i], cy_biggest[i
-0001f210: 5d5d 290a 2020 2020 2020 2020 2020 2020  ]]).            
-0001f220: 2020 2020 2020 2020 2020 2020 705b 305d              p[0]
-0001f230: 203d 2070 5b30 5d20 2d20 785f 6469 6666   = p[0] - x_diff
-0001f240: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-0001f250: 2020 2020 2020 2020 2020 2020 705b 315d              p[1]
-0001f260: 203d 2070 5b31 5d20 2d20 795f 6469 6666   = p[1] - y_diff
-0001f270: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
-0001f280: 2020 2020 2020 2020 2020 2020 6469 7374              dist
-0001f290: 7320 3d20 5b6d 6174 682e 7371 7274 2828  s = [math.sqrt((
-0001f2a0: 705b 305d 202d 2063 785f 6269 6765 7374  p[0] - cx_bigest
-0001f2b0: 5f64 5b6a 5d29 202a 2a20 3220 2b20 2870  _d[j]) ** 2 + (p
-0001f2c0: 5b31 5d20 2d20 6379 5f62 6967 6765 7374  [1] - cy_biggest
-0001f2d0: 5f64 5b6a 5d29 202a 2a20 3229 2066 6f72  _d[j]) ** 2) for
-0001f2e0: 206a 2069 6e20 7261 6e67 6528 6c65 6e28   j in range(len(
-0001f2f0: 6378 5f62 6967 6573 745f 6429 295d 0a20  cx_bigest_d))]. 
-0001f300: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f310: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
-0001f320: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
-0001f330: 5f64 5f6f 7264 6572 6564 2e61 7070 656e  _d_ordered.appen
-0001f340: 6428 636f 6e74 6f75 7273 5f6f 6e6c 795f  d(contours_only_
-0001f350: 7465 7874 5f70 6172 656e 745f 645b 6e70  text_parent_d[np
-0001f360: 2e61 7267 6d69 6e28 6469 7374 7329 5d29  .argmin(dists)])
-0001f370: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f380: 2020 2020 2020 2020 2023 2069 6d67 323d           # img2=
-0001f390: 6e70 2e7a 6572 6f73 2828 7465 7874 5f6f  np.zeros((text_o
-0001f3a0: 6e6c 792e 7368 6170 655b 305d 2c74 6578  nly.shape[0],tex
-0001f3b0: 745f 6f6e 6c79 2e73 6861 7065 5b31 5d2c  t_only.shape[1],
-0001f3c0: 3329 290a 2020 2020 2020 2020 2020 2020  3)).            
-0001f3d0: 2020 2020 2020 2020 2020 2020 2320 696d              # im
-0001f3e0: 6732 3d63 7632 2e66 696c 6c50 6f6c 7928  g2=cv2.fillPoly(
-0001f3f0: 696d 6732 2c70 7473 3d5b 636f 6e74 6f75  img2,pts=[contou
-0001f400: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
-0001f410: 656e 745f 645b 6e70 2e61 7267 6d69 6e28  ent_d[np.argmin(
-0001f420: 6469 7374 7329 5d5d 202c 636f 6c6f 723d  dists)]] ,color=
-0001f430: 2831 2c31 2c31 2929 0a20 2020 2020 2020  (1,1,1)).       
-0001f440: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f450: 2023 2070 6c74 2e69 6d73 686f 7728 696d   # plt.imshow(im
-0001f460: 6732 5b3a 2c3a 2c30 5d29 0a20 2020 2020  g2[:,:,0]).     
-0001f470: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f480: 2020 2023 2070 6c74 2e73 686f 7728 290a     # plt.show().
-0001f490: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f4a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
-0001f4b0: 2020 2020 2020 2020 2020 636f 6e74 6f75            contou
-0001f4c0: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
-0001f4d0: 656e 745f 645f 6f72 6465 7265 6420 3d20  ent_d_ordered = 
-0001f4e0: 5b5d 0a20 2020 2020 2020 2020 2020 2020  [].             
-0001f4f0: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
-0001f500: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
-0001f510: 5f64 203d 205b 5d0a 2020 2020 2020 2020  _d = [].        
-0001f520: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0001f530: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
-0001f540: 6172 656e 7420 3d20 5b5d 0a20 2020 2020  arent = [].     
-0001f550: 2020 2020 2020 2020 2020 2020 2020 200a                 .
-0001f560: 2020 2020 2020 2020 2020 2020 656c 7365              else
-0001f570: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
-0001f580: 2020 636f 6e74 6f75 7273 5f6f 6e6c 795f    contours_only_
-0001f590: 7465 7874 5f70 6172 656e 745f 645f 6f72  text_parent_d_or
-0001f5a0: 6465 7265 6420 3d20 5b5d 0a20 2020 2020  dered = [].     
-0001f5b0: 2020 2020 2020 2020 2020 2063 6f6e 746f             conto
-0001f5c0: 7572 735f 6f6e 6c79 5f74 6578 745f 7061  urs_only_text_pa
-0001f5d0: 7265 6e74 5f64 203d 205b 5d0a 2020 2020  rent_d = [].    
-0001f5e0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
-0001f5f0: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
-0001f600: 6172 656e 7420 3d20 5b5d 0a20 2020 2020  arent = [].     
-0001f610: 2020 2020 2020 2020 2020 200a 2020 2020             .    
-0001f620: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
-0001f630: 2020 2020 2020 636f 6e74 6f75 7273 5f6f        contours_o
-0001f640: 6e6c 795f 7465 7874 2c20 6869 725f 6f6e  nly_text, hir_on
-0001f650: 5f74 6578 7420 3d20 7265 7475 726e 5f63  _text = return_c
-0001f660: 6f6e 746f 7572 735f 6f66 5f69 6d61 6765  ontours_of_image
-0001f670: 2874 6578 745f 6f6e 6c79 290a 2020 2020  (text_only).    
-0001f680: 2020 2020 2020 2020 636f 6e74 6f75 7273          contours
-0001f690: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
-0001f6a0: 7420 3d20 7265 7475 726e 5f70 6172 656e  t = return_paren
-0001f6b0: 745f 636f 6e74 6f75 7273 2863 6f6e 746f  t_contours(conto
-0001f6c0: 7572 735f 6f6e 6c79 5f74 6578 742c 2068  urs_only_text, h
-0001f6d0: 6972 5f6f 6e5f 7465 7874 290a 2020 2020  ir_on_text).    
-0001f6e0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
-0001f6f0: 2020 2020 2069 6620 6c65 6e28 636f 6e74       if len(cont
-0001f700: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
-0001f710: 6172 656e 7429 203e 2030 3a0a 2020 2020  arent) > 0:.    
-0001f720: 2020 2020 2020 2020 2020 2020 6172 6561              area
-0001f730: 735f 636e 745f 7465 7874 203d 206e 702e  s_cnt_text = np.
-0001f740: 6172 7261 7928 5b63 7632 2e63 6f6e 746f  array([cv2.conto
-0001f750: 7572 4172 6561 2863 2920 666f 7220 6320  urArea(c) for c 
-0001f760: 696e 2063 6f6e 746f 7572 735f 6f6e 6c79  in contours_only
-0001f770: 5f74 6578 745f 7061 7265 6e74 5d29 0a20  _text_parent]). 
-0001f780: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0001f790: 7265 6173 5f63 6e74 5f74 6578 7420 3d20  reas_cnt_text = 
-0001f7a0: 6172 6561 735f 636e 745f 7465 7874 202f  areas_cnt_text /
-0001f7b0: 2066 6c6f 6174 2874 6578 745f 6f6e 6c79   float(text_only
-0001f7c0: 2e73 6861 7065 5b30 5d20 2a20 7465 7874  .shape[0] * text
-0001f7d0: 5f6f 6e6c 792e 7368 6170 655b 315d 290a  _only.shape[1]).
-0001f7e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001f7f0: 2063 6f6e 746f 7572 735f 6269 6767 6573   contours_bigges
-0001f800: 7420 3d20 636f 6e74 6f75 7273 5f6f 6e6c  t = contours_onl
-0001f810: 795f 7465 7874 5f70 6172 656e 745b 6e70  y_text_parent[np
-0001f820: 2e61 7267 6d61 7828 6172 6561 735f 636e  .argmax(areas_cn
-0001f830: 745f 7465 7874 295d 0a20 2020 2020 2020  t_text)].       
-0001f840: 2020 2020 2020 2020 2063 6f6e 746f 7572           contour
-0001f850: 735f 6f6e 6c79 5f74 6578 745f 7061 7265  s_only_text_pare
-0001f860: 6e74 203d 205b 6320 666f 7220 6a7a 2c20  nt = [c for jz, 
-0001f870: 6320 696e 2065 6e75 6d65 7261 7465 2863  c in enumerate(c
-0001f880: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
-0001f890: 745f 7061 7265 6e74 2920 6966 2061 7265  t_parent) if are
-0001f8a0: 6173 5f63 6e74 5f74 6578 745b 6a7a 5d20  as_cnt_text[jz] 
-0001f8b0: 3e20 6d69 6e5f 636f 6e5f 6172 6561 5d0a  > min_con_area].
-0001f8c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001f8d0: 6172 6561 735f 636e 745f 7465 7874 5f70  areas_cnt_text_p
-0001f8e0: 6172 656e 7420 3d20 5b61 7265 6120 666f  arent = [area fo
-0001f8f0: 7220 6172 6561 2069 6e20 6172 6561 735f  r area in areas_
-0001f900: 636e 745f 7465 7874 2069 6620 6172 6561  cnt_text if area
-0001f910: 203e 206d 696e 5f63 6f6e 5f61 7265 615d   > min_con_area]
-0001f920: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
-0001f930: 2020 696e 6465 785f 636f 6e5f 7061 7265    index_con_pare
-0001f940: 6e74 7320 3d20 6e70 2e61 7267 736f 7274  nts = np.argsort
-0001f950: 2861 7265 6173 5f63 6e74 5f74 6578 745f  (areas_cnt_text_
-0001f960: 7061 7265 6e74 290a 2020 2020 2020 2020  parent).        
-0001f970: 2020 2020 2020 2020 636f 6e74 6f75 7273          contours
-0001f980: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
-0001f990: 7420 3d20 6c69 7374 286e 702e 6172 7261  t = list(np.arra
-0001f9a0: 7928 636f 6e74 6f75 7273 5f6f 6e6c 795f  y(contours_only_
-0001f9b0: 7465 7874 5f70 6172 656e 742c 2064 7479  text_parent, dty
-0001f9c0: 7065 3d6f 626a 6563 7429 5b69 6e64 6578  pe=object)[index
-0001f9d0: 5f63 6f6e 5f70 6172 656e 7473 5d29 0a20  _con_parents]). 
-0001f9e0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
-0001f9f0: 7265 6173 5f63 6e74 5f74 6578 745f 7061  reas_cnt_text_pa
-0001fa00: 7265 6e74 203d 206c 6973 7428 6e70 2e61  rent = list(np.a
-0001fa10: 7272 6179 2861 7265 6173 5f63 6e74 5f74  rray(areas_cnt_t
-0001fa20: 6578 745f 7061 7265 6e74 295b 696e 6465  ext_parent)[inde
-0001fa30: 785f 636f 6e5f 7061 7265 6e74 735d 290a  x_con_parents]).
-0001fa40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-0001fa50: 2063 785f 6269 6765 7374 5f62 6967 2c20   cx_bigest_big, 
-0001fa60: 6379 5f62 6967 6765 7374 5f62 6967 2c20  cy_biggest_big, 
-0001fa70: 5f2c 205f 2c20 5f2c 205f 2c20 5f20 3d20  _, _, _, _, _ = 
-0001fa80: 6669 6e64 5f6e 6577 5f66 6561 7475 7265  find_new_feature
-0001fa90: 735f 6f66 5f63 6f6e 746f 7572 7328 5b63  s_of_contours([c
-0001faa0: 6f6e 746f 7572 735f 6269 6767 6573 745d  ontours_biggest]
-0001fab0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001fac0: 2020 6378 5f62 6967 6573 742c 2063 795f    cx_bigest, cy_
-0001fad0: 6269 6767 6573 742c 205f 2c20 5f2c 205f  biggest, _, _, _
-0001fae0: 2c20 5f2c 205f 203d 2066 696e 645f 6e65  , _, _ = find_ne
-0001faf0: 775f 6665 6174 7572 6573 5f6f 665f 636f  w_features_of_co
-0001fb00: 6e74 6f75 7273 2863 6f6e 746f 7572 735f  ntours(contours_
-0001fb10: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
-0001fb20: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
-0001fb30: 2020 2373 656c 662e 6c6f 6767 6572 2e64    #self.logger.d
-0001fb40: 6562 7567 2827 6172 6561 735f 636e 745f  ebug('areas_cnt_
-0001fb50: 7465 7874 5f70 6172 656e 7420 2573 272c  text_parent %s',
-0001fb60: 2061 7265 6173 5f63 6e74 5f74 6578 745f   areas_cnt_text_
-0001fb70: 7061 7265 6e74 290a 2020 2020 2020 2020  parent).        
-0001fb80: 2020 2020 2020 2020 2320 7365 6c66 2e6c          # self.l
-0001fb90: 6f67 6765 722e 6465 6275 6728 2761 7265  ogger.debug('are
-0001fba0: 6173 5f63 6e74 5f74 6578 745f 7061 7265  as_cnt_text_pare
-0001fbb0: 6e74 5f64 2025 7327 2c20 6172 6561 735f  nt_d %s', areas_
-0001fbc0: 636e 745f 7465 7874 5f70 6172 656e 745f  cnt_text_parent_
-0001fbd0: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
-0001fbe0: 2020 2023 2073 656c 662e 6c6f 6767 6572     # self.logger
-0001fbf0: 2e64 6562 7567 2827 6c65 6e28 636f 6e74  .debug('len(cont
-0001fc00: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
-0001fc10: 6172 656e 7429 2025 7327 2c20 6c65 6e28  arent) %s', len(
-0001fc20: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
-0001fc30: 7874 5f70 6172 656e 745f 6429 290a 2020  xt_parent_d)).  
-0001fc40: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-0001fc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
-0001fc60: 7061 7373 0a0a 2020 2020 2020 2020 7365  pass..        se
-0001fc70: 6c66 2e6c 6f67 6765 722e 696e 666f 2822  lf.logger.info("
-0001fc80: 466f 756e 6420 2564 2074 6578 7420 7265  Found %d text re
-0001fc90: 6769 6f6e 7322 2c20 6c65 6e28 636f 6e74  gions", len(cont
-0001fca0: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
-0001fcb0: 6172 656e 7429 290a 2020 2020 2020 2020  arent)).        
-0001fcc0: 7365 6c66 2e6c 6f67 6765 722e 696e 666f  self.logger.info
-0001fcd0: 2822 466f 756e 6420 2564 206d 6172 6769  ("Found %d margi
-0001fce0: 6e20 7265 6769 6f6e 7322 2c20 6c65 6e28  n regions", len(
-0001fcf0: 706f 6c79 676f 6e73 5f6f 665f 6d61 7267  polygons_of_marg
-0001fd00: 696e 616c 7329 290a 2020 2020 2020 2020  inals)).        
-0001fd10: 7365 6c66 2e6c 6f67 6765 722e 696e 666f  self.logger.info
-0001fd20: 2822 466f 756e 6420 2564 2069 6d61 6765  ("Found %d image
-0001fd30: 2072 6567 696f 6e73 222c 206c 656e 2870   regions", len(p
-0001fd40: 6f6c 7967 6f6e 735f 6f66 5f69 6d61 6765  olygons_of_image
-0001fd50: 7329 290a 2020 2020 2020 2020 7365 6c66  s)).        self
-0001fd60: 2e6c 6f67 6765 722e 696e 666f 2822 466f  .logger.info("Fo
-0001fd70: 756e 6420 2564 2073 6570 6172 6174 6f72  und %d separator
-0001fd80: 206c 696e 6573 222c 206c 656e 2870 6f6c   lines", len(pol
-0001fd90: 7967 6f6e 735f 6c69 6e65 735f 786d 6c29  ygons_lines_xml)
-0001fda0: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
-0001fdb0: 662e 7461 626c 6573 3a0a 2020 2020 2020  f.tables:.      
-0001fdc0: 2020 2020 2020 7365 6c66 2e6c 6f67 6765        self.logge
-0001fdd0: 722e 696e 666f 2822 466f 756e 6420 2564  r.info("Found %d
-0001fde0: 2074 6162 6c65 7322 2c20 6c65 6e28 636f   tables", len(co
-0001fdf0: 6e74 6f75 7273 5f74 6162 6c65 7329 290a  ntours_tables)).
-0001fe00: 0a20 2020 2020 2020 2074 7874 5f63 6f6e  .        txt_con
-0001fe10: 5f6f 7267 203d 2067 6574 5f74 6578 7472  _org = get_textr
-0001fe20: 6567 696f 6e5f 636f 6e74 6f75 7273 5f69  egion_contours_i
-0001fe30: 6e5f 6f72 675f 696d 6167 6528 636f 6e74  n_org_image(cont
-0001fe40: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
-0001fe50: 6172 656e 742c 2073 656c 662e 696d 6167  arent, self.imag
-0001fe60: 652c 2073 6c6f 7065 5f66 6972 7374 290a  e, slope_first).
-0001fe70: 2020 2020 2020 2020 626f 7865 735f 7465          boxes_te
-0001fe80: 7874 2c20 5f20 3d20 6765 745f 7465 7874  xt, _ = get_text
-0001fe90: 5f72 6567 696f 6e5f 626f 7865 735f 6279  _region_boxes_by
-0001fea0: 5f67 6976 656e 5f63 6f6e 746f 7572 7328  _given_contours(
-0001feb0: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
-0001fec0: 7874 5f70 6172 656e 7429 0a20 2020 2020  xt_parent).     
-0001fed0: 2020 2062 6f78 6573 5f6d 6172 6769 6e61     boxes_margina
-0001fee0: 6c73 2c20 5f20 3d20 6765 745f 7465 7874  ls, _ = get_text
-0001fef0: 5f72 6567 696f 6e5f 626f 7865 735f 6279  _region_boxes_by
-0001ff00: 5f67 6976 656e 5f63 6f6e 746f 7572 7328  _given_contours(
-0001ff10: 706f 6c79 676f 6e73 5f6f 665f 6d61 7267  polygons_of_marg
-0001ff20: 696e 616c 7329 0a20 2020 2020 2020 200a  inals).        .
-0001ff30: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
-0001ff40: 656c 662e 6375 7276 6564 5f6c 696e 653a  elf.curved_line:
-0001ff50: 0a20 2020 2020 2020 2020 2020 2073 6c6f  .            slo
-0001ff60: 7065 732c 2061 6c6c 5f66 6f75 6e64 5f74  pes, all_found_t
-0001ff70: 6578 6c69 6e65 5f70 6f6c 7967 6f6e 732c  exline_polygons,
-0001ff80: 2062 6f78 6573 5f74 6578 742c 2074 7874   boxes_text, txt
-0001ff90: 5f63 6f6e 5f6f 7267 2c20 636f 6e74 6f75  _con_org, contou
-0001ffa0: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
-0001ffb0: 656e 742c 2061 6c6c 5f62 6f78 5f63 6f6f  ent, all_box_coo
-0001ffc0: 7264 2c20 696e 6465 785f 6279 5f74 6578  rd, index_by_tex
-0001ffd0: 745f 7061 725f 636f 6e20 3d20 7365 6c66  t_par_con = self
-0001ffe0: 2e67 6574 5f73 6c6f 7065 735f 616e 645f  .get_slopes_and_
-0001fff0: 6465 736b 6577 5f6e 6577 2874 7874 5f63  deskew_new(txt_c
-00020000: 6f6e 5f6f 7267 2c20 636f 6e74 6f75 7273  on_org, contours
-00020010: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
-00020020: 742c 2074 6578 746c 696e 655f 6d61 736b  t, textline_mask
-00020030: 5f74 6f74 5f65 612c 2069 6d61 6765 5f70  _tot_ea, image_p
-00020040: 6167 655f 726f 7461 7465 642c 2062 6f78  age_rotated, box
-00020050: 6573 5f74 6578 742c 2073 6c6f 7065 5f64  es_text, slope_d
-00020060: 6573 6b65 7729 0a20 2020 2020 2020 2020  eskew).         
-00020070: 2020 2073 6c6f 7065 735f 6d61 7267 696e     slopes_margin
-00020080: 616c 732c 2061 6c6c 5f66 6f75 6e64 5f74  als, all_found_t
-00020090: 6578 6c69 6e65 5f70 6f6c 7967 6f6e 735f  exline_polygons_
-000200a0: 6d61 7267 696e 616c 732c 2062 6f78 6573  marginals, boxes
-000200b0: 5f6d 6172 6769 6e61 6c73 2c20 5f2c 2070  _marginals, _, p
-000200c0: 6f6c 7967 6f6e 735f 6f66 5f6d 6172 6769  olygons_of_margi
-000200d0: 6e61 6c73 2c20 616c 6c5f 626f 785f 636f  nals, all_box_co
-000200e0: 6f72 645f 6d61 7267 696e 616c 732c 205f  ord_marginals, _
-000200f0: 203d 2073 656c 662e 6765 745f 736c 6f70   = self.get_slop
-00020100: 6573 5f61 6e64 5f64 6573 6b65 775f 6e65  es_and_deskew_ne
-00020110: 7728 706f 6c79 676f 6e73 5f6f 665f 6d61  w(polygons_of_ma
-00020120: 7267 696e 616c 732c 2070 6f6c 7967 6f6e  rginals, polygon
-00020130: 735f 6f66 5f6d 6172 6769 6e61 6c73 2c20  s_of_marginals, 
-00020140: 7465 7874 6c69 6e65 5f6d 6173 6b5f 746f  textline_mask_to
-00020150: 745f 6561 2c20 696d 6167 655f 7061 6765  t_ea, image_page
-00020160: 5f72 6f74 6174 6564 2c20 626f 7865 735f  _rotated, boxes_
-00020170: 6d61 7267 696e 616c 732c 2073 6c6f 7065  marginals, slope
-00020180: 5f64 6573 6b65 7729 0a20 2020 2020 2020  _deskew).       
-00020190: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
-000201a0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-000201b0: 7363 616c 655f 7061 7261 6d20 3d20 310a  scale_param = 1.
-000201c0: 2020 2020 2020 2020 2020 2020 616c 6c5f              all_
-000201d0: 666f 756e 645f 7465 786c 696e 655f 706f  found_texline_po
-000201e0: 6c79 676f 6e73 2c20 626f 7865 735f 7465  lygons, boxes_te
-000201f0: 7874 2c20 7478 745f 636f 6e5f 6f72 672c  xt, txt_con_org,
-00020200: 2063 6f6e 746f 7572 735f 6f6e 6c79 5f74   contours_only_t
-00020210: 6578 745f 7061 7265 6e74 2c20 616c 6c5f  ext_parent, all_
-00020220: 626f 785f 636f 6f72 642c 2069 6e64 6578  box_coord, index
-00020230: 5f62 795f 7465 7874 5f70 6172 5f63 6f6e  _by_text_par_con
-00020240: 2c20 736c 6f70 6573 203d 2073 656c 662e  , slopes = self.
-00020250: 6765 745f 736c 6f70 6573 5f61 6e64 5f64  get_slopes_and_d
-00020260: 6573 6b65 775f 6e65 775f 6375 7276 6564  eskew_new_curved
-00020270: 2874 7874 5f63 6f6e 5f6f 7267 2c20 636f  (txt_con_org, co
-00020280: 6e74 6f75 7273 5f6f 6e6c 795f 7465 7874  ntours_only_text
-00020290: 5f70 6172 656e 742c 2063 7632 2e65 726f  _parent, cv2.ero
-000202a0: 6465 2874 6578 746c 696e 655f 6d61 736b  de(textline_mask
-000202b0: 5f74 6f74 5f65 612c 206b 6572 6e65 6c3d  _tot_ea, kernel=
-000202c0: 4b45 524e 454c 2c20 6974 6572 6174 696f  KERNEL, iteratio
-000202d0: 6e73 3d31 292c 2069 6d61 6765 5f70 6167  ns=1), image_pag
-000202e0: 655f 726f 7461 7465 642c 2062 6f78 6573  e_rotated, boxes
-000202f0: 5f74 6578 742c 2074 6578 745f 6f6e 6c79  _text, text_only
-00020300: 2c20 6e75 6d5f 636f 6c5f 636c 6173 7369  , num_col_classi
-00020310: 6669 6572 2c20 7363 616c 655f 7061 7261  fier, scale_para
-00020320: 6d2c 2073 6c6f 7065 5f64 6573 6b65 7729  m, slope_deskew)
-00020330: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
-00020340: 5f66 6f75 6e64 5f74 6578 6c69 6e65 5f70  _found_texline_p
-00020350: 6f6c 7967 6f6e 7320 3d20 736d 616c 6c5f  olygons = small_
-00020360: 7465 7874 6c69 6e65 735f 746f 5f70 6172  textlines_to_par
-00020370: 656e 745f 6164 6865 7265 6e63 6532 2861  ent_adherence2(a
-00020380: 6c6c 5f66 6f75 6e64 5f74 6578 6c69 6e65  ll_found_texline
-00020390: 5f70 6f6c 7967 6f6e 732c 2074 6578 746c  _polygons, textl
-000203a0: 696e 655f 6d61 736b 5f74 6f74 5f65 612c  ine_mask_tot_ea,
-000203b0: 206e 756d 5f63 6f6c 5f63 6c61 7373 6966   num_col_classif
-000203c0: 6965 7229 0a20 2020 2020 2020 2020 2020  ier).           
-000203d0: 2061 6c6c 5f66 6f75 6e64 5f74 6578 6c69   all_found_texli
-000203e0: 6e65 5f70 6f6c 7967 6f6e 735f 6d61 7267  ne_polygons_marg
-000203f0: 696e 616c 732c 2062 6f78 6573 5f6d 6172  inals, boxes_mar
-00020400: 6769 6e61 6c73 2c20 5f2c 2070 6f6c 7967  ginals, _, polyg
-00020410: 6f6e 735f 6f66 5f6d 6172 6769 6e61 6c73  ons_of_marginals
-00020420: 2c20 616c 6c5f 626f 785f 636f 6f72 645f  , all_box_coord_
-00020430: 6d61 7267 696e 616c 732c 205f 2c20 736c  marginals, _, sl
-00020440: 6f70 6573 5f6d 6172 6769 6e61 6c73 203d  opes_marginals =
-00020450: 2073 656c 662e 6765 745f 736c 6f70 6573   self.get_slopes
-00020460: 5f61 6e64 5f64 6573 6b65 775f 6e65 775f  _and_deskew_new_
-00020470: 6375 7276 6564 2870 6f6c 7967 6f6e 735f  curved(polygons_
-00020480: 6f66 5f6d 6172 6769 6e61 6c73 2c20 706f  of_marginals, po
-00020490: 6c79 676f 6e73 5f6f 665f 6d61 7267 696e  lygons_of_margin
-000204a0: 616c 732c 2063 7632 2e65 726f 6465 2874  als, cv2.erode(t
-000204b0: 6578 746c 696e 655f 6d61 736b 5f74 6f74  extline_mask_tot
-000204c0: 5f65 612c 206b 6572 6e65 6c3d 4b45 524e  _ea, kernel=KERN
-000204d0: 454c 2c20 6974 6572 6174 696f 6e73 3d31  EL, iterations=1
-000204e0: 292c 2069 6d61 6765 5f70 6167 655f 726f  ), image_page_ro
-000204f0: 7461 7465 642c 2062 6f78 6573 5f6d 6172  tated, boxes_mar
-00020500: 6769 6e61 6c73 2c20 7465 7874 5f6f 6e6c  ginals, text_onl
-00020510: 792c 206e 756d 5f63 6f6c 5f63 6c61 7373  y, num_col_class
-00020520: 6966 6965 722c 2073 6361 6c65 5f70 6172  ifier, scale_par
-00020530: 616d 2c20 736c 6f70 655f 6465 736b 6577  am, slope_deskew
-00020540: 290a 2020 2020 2020 2020 2020 2020 616c  ).            al
-00020550: 6c5f 666f 756e 645f 7465 786c 696e 655f  l_found_texline_
-00020560: 706f 6c79 676f 6e73 5f6d 6172 6769 6e61  polygons_margina
-00020570: 6c73 203d 2073 6d61 6c6c 5f74 6578 746c  ls = small_textl
-00020580: 696e 6573 5f74 6f5f 7061 7265 6e74 5f61  ines_to_parent_a
-00020590: 6468 6572 656e 6365 3228 616c 6c5f 666f  dherence2(all_fo
-000205a0: 756e 645f 7465 786c 696e 655f 706f 6c79  und_texline_poly
-000205b0: 676f 6e73 5f6d 6172 6769 6e61 6c73 2c20  gons_marginals, 
-000205c0: 7465 7874 6c69 6e65 5f6d 6173 6b5f 746f  textline_mask_to
-000205d0: 745f 6561 2c20 6e75 6d5f 636f 6c5f 636c  t_ea, num_col_cl
-000205e0: 6173 7369 6669 6572 290a 0a20 2020 2020  assifier)..     
-000205f0: 2020 2069 6620 7365 6c66 2e66 756c 6c5f     if self.full_
-00020600: 6c61 796f 7574 3a0a 2020 2020 2020 2020  layout:.        
-00020610: 2020 2020 6966 206e 702e 6162 7328 736c      if np.abs(sl
-00020620: 6f70 655f 6465 736b 6577 2920 3e3d 2053  ope_deskew) >= S
-00020630: 4c4f 5045 5f54 4852 4553 484f 4c44 3a0a  LOPE_THRESHOLD:.
-00020640: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020650: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
-00020660: 7874 5f70 6172 656e 745f 645f 6f72 6465  xt_parent_d_orde
-00020670: 7265 6420 3d20 6c69 7374 286e 702e 6172  red = list(np.ar
-00020680: 7261 7928 636f 6e74 6f75 7273 5f6f 6e6c  ray(contours_onl
-00020690: 795f 7465 7874 5f70 6172 656e 745f 645f  y_text_parent_d_
-000206a0: 6f72 6465 7265 642c 2064 7479 7065 3d6f  ordered, dtype=o
-000206b0: 626a 6563 7429 5b69 6e64 6578 5f62 795f  bject)[index_by_
-000206c0: 7465 7874 5f70 6172 5f63 6f6e 5d29 0a20  text_par_con]). 
-000206d0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
-000206e0: 6578 745f 7265 6769 6f6e 735f 702c 2063  ext_regions_p, c
-000206f0: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
-00020700: 745f 7061 7265 6e74 2c20 636f 6e74 6f75  t_parent, contou
-00020710: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
-00020720: 656e 745f 682c 2061 6c6c 5f62 6f78 5f63  ent_h, all_box_c
-00020730: 6f6f 7264 2c20 616c 6c5f 626f 785f 636f  oord, all_box_co
-00020740: 6f72 645f 682c 2061 6c6c 5f66 6f75 6e64  ord_h, all_found
-00020750: 5f74 6578 6c69 6e65 5f70 6f6c 7967 6f6e  _texline_polygon
-00020760: 732c 2061 6c6c 5f66 6f75 6e64 5f74 6578  s, all_found_tex
-00020770: 6c69 6e65 5f70 6f6c 7967 6f6e 735f 682c  line_polygons_h,
-00020780: 2073 6c6f 7065 732c 2073 6c6f 7065 735f   slopes, slopes_
-00020790: 682c 2063 6f6e 746f 7572 735f 6f6e 6c79  h, contours_only
-000207a0: 5f74 6578 745f 7061 7265 6e74 5f64 5f6f  _text_parent_d_o
-000207b0: 7264 6572 6564 2c20 636f 6e74 6f75 7273  rdered, contours
-000207c0: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
-000207d0: 745f 685f 645f 6f72 6465 7265 6420 3d20  t_h_d_ordered = 
-000207e0: 6368 6563 6b5f 616e 795f 7465 7874 5f72  check_any_text_r
-000207f0: 6567 696f 6e5f 696e 5f6d 6f64 656c 5f6f  egion_in_model_o
-00020800: 6e65 5f69 735f 6d61 696e 5f6f 725f 6865  ne_is_main_or_he
-00020810: 6164 6572 2874 6578 745f 7265 6769 6f6e  ader(text_region
-00020820: 735f 702c 2072 6567 696f 6e73 5f66 756c  s_p, regions_ful
-00020830: 6c79 2c20 636f 6e74 6f75 7273 5f6f 6e6c  ly, contours_onl
-00020840: 795f 7465 7874 5f70 6172 656e 742c 2061  y_text_parent, a
-00020850: 6c6c 5f62 6f78 5f63 6f6f 7264 2c20 616c  ll_box_coord, al
-00020860: 6c5f 666f 756e 645f 7465 786c 696e 655f  l_found_texline_
-00020870: 706f 6c79 676f 6e73 2c20 736c 6f70 6573  polygons, slopes
-00020880: 2c20 636f 6e74 6f75 7273 5f6f 6e6c 795f  , contours_only_
-00020890: 7465 7874 5f70 6172 656e 745f 645f 6f72  text_parent_d_or
-000208a0: 6465 7265 6429 0a20 2020 2020 2020 2020  dered).         
-000208b0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-000208c0: 2020 2020 2020 2020 2063 6f6e 746f 7572           contour
-000208d0: 735f 6f6e 6c79 5f74 6578 745f 7061 7265  s_only_text_pare
-000208e0: 6e74 5f64 5f6f 7264 6572 6564 203d 204e  nt_d_ordered = N
-000208f0: 6f6e 650a 2020 2020 2020 2020 2020 2020  one.            
-00020900: 2020 2020 7465 7874 5f72 6567 696f 6e73      text_regions
-00020910: 5f70 2c20 636f 6e74 6f75 7273 5f6f 6e6c  _p, contours_onl
-00020920: 795f 7465 7874 5f70 6172 656e 742c 2063  y_text_parent, c
-00020930: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
-00020940: 745f 7061 7265 6e74 5f68 2c20 616c 6c5f  t_parent_h, all_
-00020950: 626f 785f 636f 6f72 642c 2061 6c6c 5f62  box_coord, all_b
-00020960: 6f78 5f63 6f6f 7264 5f68 2c20 616c 6c5f  ox_coord_h, all_
-00020970: 666f 756e 645f 7465 786c 696e 655f 706f  found_texline_po
-00020980: 6c79 676f 6e73 2c20 616c 6c5f 666f 756e  lygons, all_foun
-00020990: 645f 7465 786c 696e 655f 706f 6c79 676f  d_texline_polygo
-000209a0: 6e73 5f68 2c20 736c 6f70 6573 2c20 736c  ns_h, slopes, sl
-000209b0: 6f70 6573 5f68 2c20 636f 6e74 6f75 7273  opes_h, contours
-000209c0: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
-000209d0: 745f 645f 6f72 6465 7265 642c 2063 6f6e  t_d_ordered, con
-000209e0: 746f 7572 735f 6f6e 6c79 5f74 6578 745f  tours_only_text_
-000209f0: 7061 7265 6e74 5f68 5f64 5f6f 7264 6572  parent_h_d_order
-00020a00: 6564 203d 2063 6865 636b 5f61 6e79 5f74  ed = check_any_t
-00020a10: 6578 745f 7265 6769 6f6e 5f69 6e5f 6d6f  ext_region_in_mo
-00020a20: 6465 6c5f 6f6e 655f 6973 5f6d 6169 6e5f  del_one_is_main_
-00020a30: 6f72 5f68 6561 6465 7228 7465 7874 5f72  or_header(text_r
-00020a40: 6567 696f 6e73 5f70 2c20 7265 6769 6f6e  egions_p, region
-00020a50: 735f 6675 6c6c 792c 2063 6f6e 746f 7572  s_fully, contour
-00020a60: 735f 6f6e 6c79 5f74 6578 745f 7061 7265  s_only_text_pare
-00020a70: 6e74 2c20 616c 6c5f 626f 785f 636f 6f72  nt, all_box_coor
-00020a80: 642c 2061 6c6c 5f66 6f75 6e64 5f74 6578  d, all_found_tex
-00020a90: 6c69 6e65 5f70 6f6c 7967 6f6e 732c 2073  line_polygons, s
-00020aa0: 6c6f 7065 732c 2063 6f6e 746f 7572 735f  lopes, contours_
-00020ab0: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
-00020ac0: 5f64 5f6f 7264 6572 6564 290a 0a20 2020  _d_ordered)..   
-00020ad0: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
-00020ae0: 2e70 6c6f 7474 6572 3a0a 2020 2020 2020  .plotter:.      
-00020af0: 2020 2020 2020 2020 2020 7365 6c66 2e70            self.p
-00020b00: 6c6f 7474 6572 2e73 6176 655f 706c 6f74  lotter.save_plot
-00020b10: 5f6f 665f 6c61 796f 7574 2874 6578 745f  _of_layout(text_
-00020b20: 7265 6769 6f6e 735f 702c 2069 6d61 6765  regions_p, image
-00020b30: 5f70 6167 6529 0a20 2020 2020 2020 2020  _page).         
-00020b40: 2020 2020 2020 2073 656c 662e 706c 6f74         self.plot
-00020b50: 7465 722e 7361 7665 5f70 6c6f 745f 6f66  ter.save_plot_of
-00020b60: 5f6c 6179 6f75 745f 616c 6c28 7465 7874  _layout_all(text
-00020b70: 5f72 6567 696f 6e73 5f70 2c20 696d 6167  _regions_p, imag
-00020b80: 655f 7061 6765 290a 0a20 2020 2020 2020  e_page)..       
-00020b90: 2020 2020 2070 6978 656c 5f69 6d67 203d       pixel_img =
-00020ba0: 2034 0a20 2020 2020 2020 2020 2020 2070   4.            p
-00020bb0: 6f6c 7967 6f6e 735f 6f66 5f64 726f 705f  olygons_of_drop_
-00020bc0: 6361 7069 7461 6c73 203d 2072 6574 7572  capitals = retur
-00020bd0: 6e5f 636f 6e74 6f75 7273 5f6f 665f 696e  n_contours_of_in
-00020be0: 7465 7265 7374 6564 5f72 6567 696f 6e5f  terested_region_
-00020bf0: 6279 5f6d 696e 5f73 697a 6528 7465 7874  by_min_size(text
-00020c00: 5f72 6567 696f 6e73 5f70 2c20 7069 7865  _regions_p, pixe
-00020c10: 6c5f 696d 6729 0a20 2020 2020 2020 2020  l_img).         
-00020c20: 2020 2061 6c6c 5f66 6f75 6e64 5f74 6578     all_found_tex
-00020c30: 6c69 6e65 5f70 6f6c 7967 6f6e 7320 3d20  line_polygons = 
-00020c40: 6164 6865 7265 5f64 726f 705f 6361 7069  adhere_drop_capi
-00020c50: 7461 6c5f 7265 6769 6f6e 5f69 6e74 6f5f  tal_region_into_
-00020c60: 636f 7272 6573 706f 6e64 696e 675f 7465  corresponding_te
-00020c70: 7874 6c69 6e65 2874 6578 745f 7265 6769  xtline(text_regi
-00020c80: 6f6e 735f 702c 2070 6f6c 7967 6f6e 735f  ons_p, polygons_
-00020c90: 6f66 5f64 726f 705f 6361 7069 7461 6c73  of_drop_capitals
-00020ca0: 2c20 636f 6e74 6f75 7273 5f6f 6e6c 795f  , contours_only_
-00020cb0: 7465 7874 5f70 6172 656e 742c 2063 6f6e  text_parent, con
-00020cc0: 746f 7572 735f 6f6e 6c79 5f74 6578 745f  tours_only_text_
-00020cd0: 7061 7265 6e74 5f68 2c20 616c 6c5f 626f  parent_h, all_bo
-00020ce0: 785f 636f 6f72 642c 2061 6c6c 5f62 6f78  x_coord, all_box
-00020cf0: 5f63 6f6f 7264 5f68 2c20 616c 6c5f 666f  _coord_h, all_fo
-00020d00: 756e 645f 7465 786c 696e 655f 706f 6c79  und_texline_poly
-00020d10: 676f 6e73 2c20 616c 6c5f 666f 756e 645f  gons, all_found_
-00020d20: 7465 786c 696e 655f 706f 6c79 676f 6e73  texline_polygons
-00020d30: 5f68 2c20 6b65 726e 656c 3d4b 4552 4e45  _h, kernel=KERNE
-00020d40: 4c2c 2063 7572 7665 645f 6c69 6e65 3d73  L, curved_line=s
-00020d50: 656c 662e 6375 7276 6564 5f6c 696e 6529  elf.curved_line)
-00020d60: 0a0a 2020 2020 2020 2020 2020 2020 2320  ..            # 
-00020d70: 7072 696e 7428 6c65 6e28 636f 6e74 6f75  print(len(contou
-00020d80: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
-00020d90: 656e 745f 6829 2c6c 656e 2863 6f6e 746f  ent_h),len(conto
-00020da0: 7572 735f 6f6e 6c79 5f74 6578 745f 7061  urs_only_text_pa
-00020db0: 7265 6e74 5f68 5f64 5f6f 7264 6572 6564  rent_h_d_ordered
-00020dc0: 292c 2763 6f6e 746f 7572 735f 6f6e 6c79  ),'contours_only
-00020dd0: 5f74 6578 745f 7061 7265 6e74 5f68 2729  _text_parent_h')
-00020de0: 0a20 2020 2020 2020 2020 2020 2070 6978  .            pix
-00020df0: 656c 5f6c 696e 6573 203d 2036 0a20 2020  el_lines = 6.   
-00020e00: 2020 2020 2020 2020 200a 0a20 2020 2020           ..     
-00020e10: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
-00020e20: 6c66 2e68 6561 6465 7273 5f6f 6666 3a0a  lf.headers_off:.
-00020e30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020e40: 6966 206e 702e 6162 7328 736c 6f70 655f  if np.abs(slope_
-00020e50: 6465 736b 6577 2920 3c20 534c 4f50 455f  deskew) < SLOPE_
-00020e60: 5448 5245 5348 4f4c 443a 0a20 2020 2020  THRESHOLD:.     
-00020e70: 2020 2020 2020 2020 2020 2020 2020 206e                 n
-00020e80: 756d 5f63 6f6c 2c20 5f2c 206d 6174 7269  um_col, _, matri
-00020e90: 785f 6f66 5f6c 696e 6573 5f63 682c 2073  x_of_lines_ch, s
-00020ea0: 706c 6974 7465 725f 795f 6e65 772c 205f  plitter_y_new, _
-00020eb0: 203d 2066 696e 645f 6e75 6d62 6572 5f6f   = find_number_o
-00020ec0: 665f 636f 6c75 6d6e 735f 696e 5f64 6f63  f_columns_in_doc
-00020ed0: 756d 656e 7428 6e70 2e72 6570 6561 7428  ument(np.repeat(
-00020ee0: 7465 7874 5f72 6567 696f 6e73 5f70 5b3a  text_regions_p[:
-00020ef0: 2c20 3a2c 206e 702e 6e65 7761 7869 735d  , :, np.newaxis]
-00020f00: 2c20 332c 2061 7869 733d 3229 2c20 6e75  , 3, axis=2), nu
-00020f10: 6d5f 636f 6c5f 636c 6173 7369 6669 6572  m_col_classifier
-00020f20: 2c20 7365 6c66 2e74 6162 6c65 732c 2020  , self.tables,  
-00020f30: 7069 7865 6c5f 6c69 6e65 732c 2063 6f6e  pixel_lines, con
-00020f40: 746f 7572 735f 6f6e 6c79 5f74 6578 745f  tours_only_text_
-00020f50: 7061 7265 6e74 5f68 290a 2020 2020 2020  parent_h).      
-00020f60: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-00020f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00020f80: 2020 2020 5f2c 205f 2c20 6d61 7472 6978      _, _, matrix
-00020f90: 5f6f 665f 6c69 6e65 735f 6368 5f64 2c20  _of_lines_ch_d, 
-00020fa0: 7370 6c69 7474 6572 5f79 5f6e 6577 5f64  splitter_y_new_d
-00020fb0: 2c20 5f20 3d20 6669 6e64 5f6e 756d 6265  , _ = find_numbe
-00020fc0: 725f 6f66 5f63 6f6c 756d 6e73 5f69 6e5f  r_of_columns_in_
-00020fd0: 646f 6375 6d65 6e74 286e 702e 7265 7065  document(np.repe
-00020fe0: 6174 2874 6578 745f 7265 6769 6f6e 735f  at(text_regions_
-00020ff0: 705f 315f 6e5b 3a2c 203a 2c20 6e70 2e6e  p_1_n[:, :, np.n
-00021000: 6577 6178 6973 5d2c 2033 2c20 6178 6973  ewaxis], 3, axis
-00021010: 3d32 292c 206e 756d 5f63 6f6c 5f63 6c61  =2), num_col_cla
-00021020: 7373 6966 6965 722c 2073 656c 662e 7461  ssifier, self.ta
-00021030: 626c 6573 2c20 7069 7865 6c5f 6c69 6e65  bles, pixel_line
-00021040: 732c 2063 6f6e 746f 7572 735f 6f6e 6c79  s, contours_only
-00021050: 5f74 6578 745f 7061 7265 6e74 5f68 5f64  _text_parent_h_d
-00021060: 5f6f 7264 6572 6564 290a 2020 2020 2020  _ordered).      
-00021070: 2020 2020 2020 656c 6966 2073 656c 662e        elif self.
-00021080: 6865 6164 6572 735f 6f66 663a 0a20 2020  headers_off:.   
-00021090: 2020 2020 2020 2020 2020 2020 2069 6620               if 
-000210a0: 6e70 2e61 6273 2873 6c6f 7065 5f64 6573  np.abs(slope_des
-000210b0: 6b65 7729 203c 2053 4c4f 5045 5f54 4852  kew) < SLOPE_THR
-000210c0: 4553 484f 4c44 3a0a 2020 2020 2020 2020  ESHOLD:.        
-000210d0: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
-000210e0: 636f 6c2c 205f 2c20 6d61 7472 6978 5f6f  col, _, matrix_o
-000210f0: 665f 6c69 6e65 735f 6368 2c20 7370 6c69  f_lines_ch, spli
-00021100: 7474 6572 5f79 5f6e 6577 2c20 5f20 3d20  tter_y_new, _ = 
-00021110: 6669 6e64 5f6e 756d 6265 725f 6f66 5f63  find_number_of_c
-00021120: 6f6c 756d 6e73 5f69 6e5f 646f 6375 6d65  olumns_in_docume
-00021130: 6e74 286e 702e 7265 7065 6174 2874 6578  nt(np.repeat(tex
-00021140: 745f 7265 6769 6f6e 735f 705b 3a2c 203a  t_regions_p[:, :
-00021150: 2c20 6e70 2e6e 6577 6178 6973 5d2c 2033  , np.newaxis], 3
-00021160: 2c20 6178 6973 3d32 292c 206e 756d 5f63  , axis=2), num_c
-00021170: 6f6c 5f63 6c61 7373 6966 6965 722c 2073  ol_classifier, s
-00021180: 656c 662e 7461 626c 6573 2c20 2070 6978  elf.tables,  pix
-00021190: 656c 5f6c 696e 6573 290a 2020 2020 2020  el_lines).      
-000211a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000211b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000211c0: 2020 2020 5f2c 205f 2c20 6d61 7472 6978      _, _, matrix
-000211d0: 5f6f 665f 6c69 6e65 735f 6368 5f64 2c20  _of_lines_ch_d, 
-000211e0: 7370 6c69 7474 6572 5f79 5f6e 6577 5f64  splitter_y_new_d
-000211f0: 2c20 5f20 3d20 6669 6e64 5f6e 756d 6265  , _ = find_numbe
-00021200: 725f 6f66 5f63 6f6c 756d 6e73 5f69 6e5f  r_of_columns_in_
-00021210: 646f 6375 6d65 6e74 286e 702e 7265 7065  document(np.repe
-00021220: 6174 2874 6578 745f 7265 6769 6f6e 735f  at(text_regions_
-00021230: 705f 315f 6e5b 3a2c 203a 2c20 6e70 2e6e  p_1_n[:, :, np.n
-00021240: 6577 6178 6973 5d2c 2033 2c20 6178 6973  ewaxis], 3, axis
-00021250: 3d32 292c 206e 756d 5f63 6f6c 5f63 6c61  =2), num_col_cla
-00021260: 7373 6966 6965 722c 2073 656c 662e 7461  ssifier, self.ta
-00021270: 626c 6573 2c20 7069 7865 6c5f 6c69 6e65  bles, pixel_line
-00021280: 7329 0a0a 2020 2020 2020 2020 2020 2020  s)..            
-00021290: 2320 7072 696e 7428 7065 616b 735f 6e65  # print(peaks_ne
-000212a0: 675f 6669 6e2c 7065 616b 735f 6e65 675f  g_fin,peaks_neg_
-000212b0: 6669 6e5f 642c 276e 756d 5f63 6f6c 3227  fin_d,'num_col2'
-000212c0: 290a 2020 2020 2020 2020 2020 2020 2320  ).            # 
-000212d0: 7072 696e 7428 7370 6c69 7474 6572 5f79  print(splitter_y
-000212e0: 5f6e 6577 2c73 706c 6974 7465 725f 795f  _new,splitter_y_
-000212f0: 6e65 775f 642c 276e 756d 5f63 6f6c 5f63  new_d,'num_col_c
-00021300: 6c61 7373 6966 6965 7227 290a 2020 2020  lassifier').    
-00021310: 2020 2020 2020 2020 2320 7072 696e 7428          # print(
-00021320: 6d61 7472 6978 5f6f 665f 6c69 6e65 735f  matrix_of_lines_
-00021330: 6368 2e73 6861 7065 2c6d 6174 7269 785f  ch.shape,matrix_
-00021340: 6f66 5f6c 696e 6573 5f63 685f 642e 7368  of_lines_ch_d.sh
-00021350: 6170 652c 276d 6174 7269 785f 6f66 5f6c  ape,'matrix_of_l
-00021360: 696e 6573 5f63 6827 290a 0a20 2020 2020  ines_ch')..     
-00021370: 2020 2020 2020 2069 6620 6e75 6d5f 636f         if num_co
-00021380: 6c5f 636c 6173 7369 6669 6572 203e 3d20  l_classifier >= 
-00021390: 333a 0a20 2020 2020 2020 2020 2020 2020  3:.             
-000213a0: 2020 2069 6620 6e70 2e61 6273 2873 6c6f     if np.abs(slo
-000213b0: 7065 5f64 6573 6b65 7729 203c 2053 4c4f  pe_deskew) < SLO
-000213c0: 5045 5f54 4852 4553 484f 4c44 3a0a 2020  PE_THRESHOLD:.  
-000213d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000213e0: 2020 7265 6769 6f6e 735f 7769 7468 6f75    regions_withou
-000213f0: 745f 7365 7061 7261 746f 7273 203d 2072  t_separators = r
-00021400: 6567 696f 6e73 5f77 6974 686f 7574 5f73  egions_without_s
-00021410: 6570 6172 6174 6f72 732e 6173 7479 7065  eparators.astype
-00021420: 286e 702e 7569 6e74 3829 0a20 2020 2020  (np.uint8).     
-00021430: 2020 2020 2020 2020 2020 2020 2020 2072                 r
-00021440: 6567 696f 6e73 5f77 6974 686f 7574 5f73  egions_without_s
-00021450: 6570 6172 6174 6f72 7320 3d20 6376 322e  eparators = cv2.
-00021460: 6572 6f64 6528 7265 6769 6f6e 735f 7769  erode(regions_wi
-00021470: 7468 6f75 745f 7365 7061 7261 746f 7273  thout_separators
-00021480: 5b3a 2c20 3a5d 2c20 4b45 524e 454c 2c20  [:, :], KERNEL, 
-00021490: 6974 6572 6174 696f 6e73 3d36 290a 2020  iterations=6).  
-000214a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000214b0: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
-000214c0: 2020 2020 2020 2023 7265 6769 6f6e 735f         #regions_
-000214d0: 7769 7468 6f75 745f 7365 7061 7261 746f  without_separato
-000214e0: 7273 5f30 203d 2072 6567 696f 6e73 5f77  rs_0 = regions_w
-000214f0: 6974 686f 7574 5f73 6570 6172 6174 6f72  ithout_separator
-00021500: 735b 3a2c 203a 5d2e 7375 6d28 6178 6973  s[:, :].sum(axis
-00021510: 3d30 290a 2020 2020 2020 2020 2020 2020  =0).            
-00021520: 2020 2020 2020 2020 236d 6564 615f 6e5f          #meda_n_
-00021530: 7570 646f 776e 203d 2072 6567 696f 6e73  updown = regions
-00021540: 5f77 6974 686f 7574 5f73 6570 6172 6174  _without_separat
-00021550: 6f72 735f 305b 6c65 6e28 7265 6769 6f6e  ors_0[len(region
-00021560: 735f 7769 7468 6f75 745f 7365 7061 7261  s_without_separa
-00021570: 746f 7273 5f30 2920 3a3a 202d 315d 0a20  tors_0) :: -1]. 
-00021580: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021590: 2020 2023 6669 7273 745f 6e6f 6e7a 6572     #first_nonzer
-000215a0: 6f20 3d20 6e65 7874 2828 6920 666f 7220  o = next((i for 
-000215b0: 692c 2078 2069 6e20 656e 756d 6572 6174  i, x in enumerat
-000215c0: 6528 7265 6769 6f6e 735f 7769 7468 6f75  e(regions_withou
-000215d0: 745f 7365 7061 7261 746f 7273 5f30 2920  t_separators_0) 
-000215e0: 6966 2078 292c 2030 290a 2020 2020 2020  if x), 0).      
-000215f0: 2020 2020 2020 2020 2020 2020 2020 236c                #l
-00021600: 6173 745f 6e6f 6e7a 6572 6f20 3d20 6e65  ast_nonzero = ne
-00021610: 7874 2828 6920 666f 7220 692c 2078 2069  xt((i for i, x i
-00021620: 6e20 656e 756d 6572 6174 6528 6d65 6461  n enumerate(meda
-00021630: 5f6e 5f75 7064 6f77 6e29 2069 6620 7829  _n_updown) if x)
-00021640: 2c20 3029 0a20 2020 2020 2020 2020 2020  , 0).           
-00021650: 2020 2020 2020 2020 2023 6c61 7374 5f6e           #last_n
-00021660: 6f6e 7a65 726f 203d 206c 656e 2872 6567  onzero = len(reg
-00021670: 696f 6e73 5f77 6974 686f 7574 5f73 6570  ions_without_sep
-00021680: 6172 6174 6f72 735f 3029 202d 206c 6173  arators_0) - las
-00021690: 745f 6e6f 6e7a 6572 6f0a 2020 2020 2020  t_nonzero.      
-000216a0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
-000216b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000216c0: 2020 2023 7261 6e64 6f6d 5f70 6978 656c     #random_pixel
-000216d0: 735f 666f 725f 696d 6167 6520 3d20 6e70  s_for_image = np
-000216e0: 2e72 616e 646f 6d2e 7261 6e64 6e28 7265  .random.randn(re
-000216f0: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
-00021700: 7061 7261 746f 7273 2e73 6861 7065 5b30  parators.shape[0
-00021710: 5d2c 2072 6567 696f 6e73 5f77 6974 686f  ], regions_witho
-00021720: 7574 5f73 6570 6172 6174 6f72 732e 7368  ut_separators.sh
-00021730: 6170 655b 315d 290a 2020 2020 2020 2020  ape[1]).        
-00021740: 2020 2020 2020 2020 2020 2020 2372 616e              #ran
-00021750: 646f 6d5f 7069 7865 6c73 5f66 6f72 5f69  dom_pixels_for_i
-00021760: 6d61 6765 5b72 616e 646f 6d5f 7069 7865  mage[random_pixe
-00021770: 6c73 5f66 6f72 5f69 6d61 6765 203c 202d  ls_for_image < -
-00021780: 302e 355d 203d 2030 0a20 2020 2020 2020  0.5] = 0.       
-00021790: 2020 2020 2020 2020 2020 2020 2023 7261               #ra
-000217a0: 6e64 6f6d 5f70 6978 656c 735f 666f 725f  ndom_pixels_for_
-000217b0: 696d 6167 655b 7261 6e64 6f6d 5f70 6978  image[random_pix
-000217c0: 656c 735f 666f 725f 696d 6167 6520 213d  els_for_image !=
-000217d0: 2030 5d20 3d20 310a 2020 2020 2020 2020   0] = 1.        
-000217e0: 2020 2020 2020 2020 2020 2020 2372 6567              #reg
-000217f0: 696f 6e73 5f77 6974 686f 7574 5f73 6570  ions_without_sep
-00021800: 6172 6174 6f72 735b 2872 616e 646f 6d5f  arators[(random_
-00021810: 7069 7865 6c73 5f66 6f72 5f69 6d61 6765  pixels_for_image
-00021820: 5b3a 2c20 3a5d 203d 3d20 3129 2026 2028  [:, :] == 1) & (
-00021830: 7465 7874 5f72 6567 696f 6e73 5f70 5b3a  text_regions_p[:
-00021840: 2c20 3a5d 203d 3d20 3529 5d20 3d20 310a  , :] == 5)] = 1.
-00021850: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021860: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-00021870: 2020 2020 2020 2020 2023 7265 6769 6f6e           #region
-00021880: 735f 7769 7468 6f75 745f 7365 7061 7261  s_without_separa
-00021890: 746f 7273 5b3a 2c20 303a 6669 7273 745f  tors[:, 0:first_
-000218a0: 6e6f 6e7a 6572 6f5d 203d 2030 0a20 2020  nonzero] = 0.   
-000218b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000218c0: 2023 7265 6769 6f6e 735f 7769 7468 6f75   #regions_withou
-000218d0: 745f 7365 7061 7261 746f 7273 5b3a 2c20  t_separators[:, 
-000218e0: 6c61 7374 5f6e 6f6e 7a65 726f 3a5d 203d  last_nonzero:] =
-000218f0: 2030 0a20 2020 2020 2020 2020 2020 2020   0.             
-00021900: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
-00021910: 2020 2020 2020 2020 2020 2020 2072 6567               reg
-00021920: 696f 6e73 5f77 6974 686f 7574 5f73 6570  ions_without_sep
-00021930: 6172 6174 6f72 735f 6420 3d20 7265 6769  arators_d = regi
-00021940: 6f6e 735f 7769 7468 6f75 745f 7365 7061  ons_without_sepa
-00021950: 7261 746f 7273 5f64 2e61 7374 7970 6528  rators_d.astype(
-00021960: 6e70 2e75 696e 7438 290a 2020 2020 2020  np.uint8).      
-00021970: 2020 2020 2020 2020 2020 2020 2020 7265                re
-00021980: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
-00021990: 7061 7261 746f 7273 5f64 203d 2063 7632  parators_d = cv2
-000219a0: 2e65 726f 6465 2872 6567 696f 6e73 5f77  .erode(regions_w
-000219b0: 6974 686f 7574 5f73 6570 6172 6174 6f72  ithout_separator
-000219c0: 735f 645b 3a2c 203a 5d2c 204b 4552 4e45  s_d[:, :], KERNE
-000219d0: 4c2c 2069 7465 7261 7469 6f6e 733d 3629  L, iterations=6)
-000219e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-000219f0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
-00021a00: 2020 2020 2020 2020 2020 2372 6567 696f            #regio
-00021a10: 6e73 5f77 6974 686f 7574 5f73 6570 6172  ns_without_separ
-00021a20: 6174 6f72 735f 3020 3d20 7265 6769 6f6e  ators_0 = region
-00021a30: 735f 7769 7468 6f75 745f 7365 7061 7261  s_without_separa
-00021a40: 746f 7273 5f64 5b3a 2c20 3a5d 2e73 756d  tors_d[:, :].sum
-00021a50: 2861 7869 733d 3029 0a20 2020 2020 2020  (axis=0).       
-00021a60: 2020 2020 2020 2020 2020 2020 2023 6d65               #me
-00021a70: 6461 5f6e 5f75 7064 6f77 6e20 3d20 7265  da_n_updown = re
-00021a80: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
-00021a90: 7061 7261 746f 7273 5f30 5b6c 656e 2872  parators_0[len(r
-00021aa0: 6567 696f 6e73 5f77 6974 686f 7574 5f73  egions_without_s
-00021ab0: 6570 6172 6174 6f72 735f 3029 203a 3a20  eparators_0) :: 
-00021ac0: 2d31 5d0a 2020 2020 2020 2020 2020 2020  -1].            
-00021ad0: 2020 2020 2020 2020 2366 6972 7374 5f6e          #first_n
-00021ae0: 6f6e 7a65 726f 203d 206e 6578 7428 2869  onzero = next((i
-00021af0: 2066 6f72 2069 2c20 7820 696e 2065 6e75   for i, x in enu
-00021b00: 6d65 7261 7465 2872 6567 696f 6e73 5f77  merate(regions_w
-00021b10: 6974 686f 7574 5f73 6570 6172 6174 6f72  ithout_separator
-00021b20: 735f 3029 2069 6620 7829 2c20 3029 0a20  s_0) if x), 0). 
-00021b30: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021b40: 2020 2023 6c61 7374 5f6e 6f6e 7a65 726f     #last_nonzero
-00021b50: 203d 206e 6578 7428 2869 2066 6f72 2069   = next((i for i
-00021b60: 2c20 7820 696e 2065 6e75 6d65 7261 7465  , x in enumerate
-00021b70: 286d 6564 615f 6e5f 7570 646f 776e 2920  (meda_n_updown) 
-00021b80: 6966 2078 292c 2030 290a 2020 2020 2020  if x), 0).      
-00021b90: 2020 2020 2020 2020 2020 2020 2020 236c                #l
-00021ba0: 6173 745f 6e6f 6e7a 6572 6f20 3d20 6c65  ast_nonzero = le
-00021bb0: 6e28 7265 6769 6f6e 735f 7769 7468 6f75  n(regions_withou
-00021bc0: 745f 7365 7061 7261 746f 7273 5f30 2920  t_separators_0) 
-00021bd0: 2d20 6c61 7374 5f6e 6f6e 7a65 726f 0a20  - last_nonzero. 
-00021be0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021bf0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
-00021c00: 2020 2020 2020 2020 2372 616e 646f 6d5f          #random_
-00021c10: 7069 7865 6c73 5f66 6f72 5f69 6d61 6765  pixels_for_image
-00021c20: 203d 206e 702e 7261 6e64 6f6d 2e72 616e   = np.random.ran
-00021c30: 646e 2872 6567 696f 6e73 5f77 6974 686f  dn(regions_witho
-00021c40: 7574 5f73 6570 6172 6174 6f72 735f 642e  ut_separators_d.
-00021c50: 7368 6170 655b 305d 2c20 7265 6769 6f6e  shape[0], region
-00021c60: 735f 7769 7468 6f75 745f 7365 7061 7261  s_without_separa
-00021c70: 746f 7273 5f64 2e73 6861 7065 5b31 5d29  tors_d.shape[1])
-00021c80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021c90: 2020 2020 2023 7261 6e64 6f6d 5f70 6978       #random_pix
-00021ca0: 656c 735f 666f 725f 696d 6167 655b 7261  els_for_image[ra
-00021cb0: 6e64 6f6d 5f70 6978 656c 735f 666f 725f  ndom_pixels_for_
-00021cc0: 696d 6167 6520 3c20 2d30 2e35 5d20 3d20  image < -0.5] = 
-00021cd0: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
-00021ce0: 2020 2020 2020 2372 616e 646f 6d5f 7069        #random_pi
-00021cf0: 7865 6c73 5f66 6f72 5f69 6d61 6765 5b72  xels_for_image[r
-00021d00: 616e 646f 6d5f 7069 7865 6c73 5f66 6f72  andom_pixels_for
-00021d10: 5f69 6d61 6765 2021 3d20 305d 203d 2031  _image != 0] = 1
-00021d20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00021d30: 2020 2020 2023 2372 6567 696f 6e73 5f77       ##regions_w
-00021d40: 6974 686f 7574 5f73 6570 6172 6174 6f72  ithout_separator
-00021d50: 735f 645b 2872 616e 646f 6d5f 7069 7865  s_d[(random_pixe
-00021d60: 6c73 5f66 6f72 5f69 6d61 6765 5b3a 2c20  ls_for_image[:, 
-00021d70: 3a5d 203d 3d20 3129 2026 2028 7465 7874  :] == 1) & (text
-00021d80: 5f72 6567 696f 6e73 5f70 5f31 5f6e 5b3a  _regions_p_1_n[:
-00021d90: 2c20 3a5d 203d 3d20 3529 5d20 3d20 310a  , :] == 5)] = 1.
-00021da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021db0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
-00021dc0: 2020 2020 2020 2020 2023 7265 6769 6f6e           #region
-00021dd0: 735f 7769 7468 6f75 745f 7365 7061 7261  s_without_separa
-00021de0: 746f 7273 5f64 5b3a 2c20 303a 6669 7273  tors_d[:, 0:firs
-00021df0: 745f 6e6f 6e7a 6572 6f5d 203d 2030 0a20  t_nonzero] = 0. 
-00021e00: 2020 2020 2020 2020 2020 2020 2020 2020                  
-00021e10: 2020 2023 7265 6769 6f6e 735f 7769 7468     #regions_with
-00021e20: 6f75 745f 7365 7061 7261 746f 7273 5f64  out_separators_d
-00021e30: 5b3a 2c20 6c61 7374 5f6e 6f6e 7a65 726f  [:, last_nonzero
-00021e40: 3a5d 203d 2030 0a0a 2020 2020 2020 2020  :] = 0..        
-00021e50: 2020 2020 6966 206e 702e 6162 7328 736c      if np.abs(sl
-00021e60: 6f70 655f 6465 736b 6577 2920 3c20 534c  ope_deskew) < SL
-00021e70: 4f50 455f 5448 5245 5348 4f4c 443a 0a20  OPE_THRESHOLD:. 
-00021e80: 2020 2020 2020 2020 2020 2020 2020 2062                 b
-00021e90: 6f78 6573 2c20 7065 616b 735f 6e65 675f  oxes, peaks_neg_
-00021ea0: 746f 745f 7461 626c 6573 203d 2072 6574  tot_tables = ret
-00021eb0: 7572 6e5f 626f 7865 735f 6f66 5f69 6d61  urn_boxes_of_ima
-00021ec0: 6765 735f 6279 5f6f 7264 6572 5f6f 665f  ges_by_order_of_
-00021ed0: 7265 6164 696e 675f 6e65 7728 7370 6c69  reading_new(spli
-00021ee0: 7474 6572 5f79 5f6e 6577 2c20 7265 6769  tter_y_new, regi
-00021ef0: 6f6e 735f 7769 7468 6f75 745f 7365 7061  ons_without_sepa
-00021f00: 7261 746f 7273 2c20 6d61 7472 6978 5f6f  rators, matrix_o
-00021f10: 665f 6c69 6e65 735f 6368 2c20 6e75 6d5f  f_lines_ch, num_
-00021f20: 636f 6c5f 636c 6173 7369 6669 6572 2c20  col_classifier, 
-00021f30: 6572 6f73 696f 6e5f 6875 7274 732c 2073  erosion_hurts, s
-00021f40: 656c 662e 7461 626c 6573 290a 2020 2020  elf.tables).    
-00021f50: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
-00021f60: 2020 2020 2020 2020 2020 2020 2020 626f                bo
-00021f70: 7865 735f 642c 2070 6561 6b73 5f6e 6567  xes_d, peaks_neg
-00021f80: 5f74 6f74 5f74 6162 6c65 735f 6420 3d20  _tot_tables_d = 
-00021f90: 7265 7475 726e 5f62 6f78 6573 5f6f 665f  return_boxes_of_
-00021fa0: 696d 6167 6573 5f62 795f 6f72 6465 725f  images_by_order_
-00021fb0: 6f66 5f72 6561 6469 6e67 5f6e 6577 2873  of_reading_new(s
-00021fc0: 706c 6974 7465 725f 795f 6e65 775f 642c  plitter_y_new_d,
-00021fd0: 2072 6567 696f 6e73 5f77 6974 686f 7574   regions_without
-00021fe0: 5f73 6570 6172 6174 6f72 735f 642c 206d  _separators_d, m
-00021ff0: 6174 7269 785f 6f66 5f6c 696e 6573 5f63  atrix_of_lines_c
-00022000: 685f 642c 206e 756d 5f63 6f6c 5f63 6c61  h_d, num_col_cla
-00022010: 7373 6966 6965 722c 2065 726f 7369 6f6e  ssifier, erosion
-00022020: 5f68 7572 7473 2c20 7365 6c66 2e74 6162  _hurts, self.tab
-00022030: 6c65 7329 0a0a 2020 2020 2020 2020 6966  les)..        if
-00022040: 2073 656c 662e 706c 6f74 7465 723a 0a20   self.plotter:. 
-00022050: 2020 2020 2020 2020 2020 2073 656c 662e             self.
-00022060: 706c 6f74 7465 722e 7772 6974 655f 696d  plotter.write_im
-00022070: 6167 6573 5f69 6e74 6f5f 6469 7265 6374  ages_into_direct
-00022080: 6f72 7928 706f 6c79 676f 6e73 5f6f 665f  ory(polygons_of_
-00022090: 696d 6167 6573 2c20 696d 6167 655f 7061  images, image_pa
-000220a0: 6765 290a 0a20 2020 2020 2020 2069 6620  ge)..        if 
-000220b0: 7365 6c66 2e66 756c 6c5f 6c61 796f 7574  self.full_layout
-000220c0: 3a0a 2020 2020 2020 2020 2020 2020 6966  :.            if
-000220d0: 206e 702e 6162 7328 736c 6f70 655f 6465   np.abs(slope_de
-000220e0: 736b 6577 2920 3c20 534c 4f50 455f 5448  skew) < SLOPE_TH
-000220f0: 5245 5348 4f4c 443a 0a20 2020 2020 2020  RESHOLD:.       
-00022100: 2020 2020 2020 2020 206f 7264 6572 5f74           order_t
-00022110: 6578 745f 6e65 772c 2069 645f 6f66 5f74  ext_new, id_of_t
-00022120: 6578 7473 5f74 6f74 203d 2073 656c 662e  exts_tot = self.
-00022130: 646f 5f6f 7264 6572 5f6f 665f 7265 6769  do_order_of_regi
-00022140: 6f6e 7328 636f 6e74 6f75 7273 5f6f 6e6c  ons(contours_onl
-00022150: 795f 7465 7874 5f70 6172 656e 742c 2063  y_text_parent, c
-00022160: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
-00022170: 745f 7061 7265 6e74 5f68 2c20 626f 7865  t_parent_h, boxe
-00022180: 732c 2074 6578 746c 696e 655f 6d61 736b  s, textline_mask
-00022190: 5f74 6f74 290a 2020 2020 2020 2020 2020  _tot).          
-000221a0: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
-000221b0: 2020 2020 2020 2020 6f72 6465 725f 7465          order_te
-000221c0: 7874 5f6e 6577 2c20 6964 5f6f 665f 7465  xt_new, id_of_te
-000221d0: 7874 735f 746f 7420 3d20 7365 6c66 2e64  xts_tot = self.d
-000221e0: 6f5f 6f72 6465 725f 6f66 5f72 6567 696f  o_order_of_regio
-000221f0: 6e73 2863 6f6e 746f 7572 735f 6f6e 6c79  ns(contours_only
-00022200: 5f74 6578 745f 7061 7265 6e74 5f64 5f6f  _text_parent_d_o
-00022210: 7264 6572 6564 2c20 636f 6e74 6f75 7273  rdered, contours
-00022220: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
-00022230: 745f 685f 645f 6f72 6465 7265 642c 2062  t_h_d_ordered, b
-00022240: 6f78 6573 5f64 2c20 7465 7874 6c69 6e65  oxes_d, textline
-00022250: 5f6d 6173 6b5f 746f 745f 6429 0a0a 2020  _mask_tot_d)..  
-00022260: 2020 2020 2020 2020 2020 7063 6774 7320            pcgts 
-00022270: 3d20 7365 6c66 2e77 7269 7465 722e 6275  = self.writer.bu
-00022280: 696c 645f 7061 6765 786d 6c5f 6675 6c6c  ild_pagexml_full
-00022290: 5f6c 6179 6f75 7428 636f 6e74 6f75 7273  _layout(contours
-000222a0: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
-000222b0: 742c 2063 6f6e 746f 7572 735f 6f6e 6c79  t, contours_only
-000222c0: 5f74 6578 745f 7061 7265 6e74 5f68 2c20  _text_parent_h, 
-000222d0: 7061 6765 5f63 6f6f 7264 2c20 6f72 6465  page_coord, orde
-000222e0: 725f 7465 7874 5f6e 6577 2c20 6964 5f6f  r_text_new, id_o
-000222f0: 665f 7465 7874 735f 746f 742c 2061 6c6c  f_texts_tot, all
-00022300: 5f66 6f75 6e64 5f74 6578 6c69 6e65 5f70  _found_texline_p
-00022310: 6f6c 7967 6f6e 732c 2061 6c6c 5f66 6f75  olygons, all_fou
-00022320: 6e64 5f74 6578 6c69 6e65 5f70 6f6c 7967  nd_texline_polyg
-00022330: 6f6e 735f 682c 2061 6c6c 5f62 6f78 5f63  ons_h, all_box_c
-00022340: 6f6f 7264 2c20 616c 6c5f 626f 785f 636f  oord, all_box_co
-00022350: 6f72 645f 682c 2070 6f6c 7967 6f6e 735f  ord_h, polygons_
-00022360: 6f66 5f69 6d61 6765 732c 2063 6f6e 746f  of_images, conto
-00022370: 7572 735f 7461 626c 6573 2c20 706f 6c79  urs_tables, poly
-00022380: 676f 6e73 5f6f 665f 6472 6f70 5f63 6170  gons_of_drop_cap
-00022390: 6974 616c 732c 2070 6f6c 7967 6f6e 735f  itals, polygons_
-000223a0: 6f66 5f6d 6172 6769 6e61 6c73 2c20 616c  of_marginals, al
-000223b0: 6c5f 666f 756e 645f 7465 786c 696e 655f  l_found_texline_
-000223c0: 706f 6c79 676f 6e73 5f6d 6172 6769 6e61  polygons_margina
-000223d0: 6c73 2c20 616c 6c5f 626f 785f 636f 6f72  ls, all_box_coor
-000223e0: 645f 6d61 7267 696e 616c 732c 2073 6c6f  d_marginals, slo
-000223f0: 7065 732c 2073 6c6f 7065 735f 682c 2073  pes, slopes_h, s
-00022400: 6c6f 7065 735f 6d61 7267 696e 616c 732c  lopes_marginals,
-00022410: 2063 6f6e 745f 7061 6765 2c20 706f 6c79   cont_page, poly
-00022420: 676f 6e73 5f6c 696e 6573 5f78 6d6c 290a  gons_lines_xml).
-00022430: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00022440: 2e6c 6f67 6765 722e 696e 666f 2822 4a6f  .logger.info("Jo
-00022450: 6220 646f 6e65 2069 6e20 252e 3166 7322  b done in %.1fs"
-00022460: 2c20 7469 6d65 2e74 696d 6528 2920 2d20  , time.time() - 
-00022470: 7430 290a 2020 2020 2020 2020 2020 2020  t0).            
-00022480: 7265 7475 726e 2070 6367 7473 0a20 2020  return pcgts.   
-00022490: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
-000224a0: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
-000224b0: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
-000224c0: 5f68 203d 204e 6f6e 650a 2020 2020 2020  _h = None.      
-000224d0: 2020 2020 2020 6966 206e 702e 6162 7328        if np.abs(
-000224e0: 736c 6f70 655f 6465 736b 6577 2920 3c20  slope_deskew) < 
-000224f0: 534c 4f50 455f 5448 5245 5348 4f4c 443a  SLOPE_THRESHOLD:
-00022500: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
-00022510: 206f 7264 6572 5f74 6578 745f 6e65 772c   order_text_new,
-00022520: 2069 645f 6f66 5f74 6578 7473 5f74 6f74   id_of_texts_tot
-00022530: 203d 2073 656c 662e 646f 5f6f 7264 6572   = self.do_order
-00022540: 5f6f 665f 7265 6769 6f6e 7328 636f 6e74  _of_regions(cont
-00022550: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
-00022560: 6172 656e 742c 2063 6f6e 746f 7572 735f  arent, contours_
-00022570: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
-00022580: 5f68 2c20 626f 7865 732c 2074 6578 746c  _h, boxes, textl
-00022590: 696e 655f 6d61 736b 5f74 6f74 290a 2020  ine_mask_tot).  
-000225a0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
-000225b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
-000225c0: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
-000225d0: 7874 5f70 6172 656e 745f 645f 6f72 6465  xt_parent_d_orde
-000225e0: 7265 6420 3d20 6c69 7374 286e 702e 6172  red = list(np.ar
-000225f0: 7261 7928 636f 6e74 6f75 7273 5f6f 6e6c  ray(contours_onl
-00022600: 795f 7465 7874 5f70 6172 656e 745f 645f  y_text_parent_d_
-00022610: 6f72 6465 7265 642c 2064 7479 7065 3d6f  ordered, dtype=o
-00022620: 626a 6563 7429 5b69 6e64 6578 5f62 795f  bject)[index_by_
-00022630: 7465 7874 5f70 6172 5f63 6f6e 5d29 0a20  text_par_con]). 
-00022640: 2020 2020 2020 2020 2020 2020 2020 206f                 o
-00022650: 7264 6572 5f74 6578 745f 6e65 772c 2069  rder_text_new, i
-00022660: 645f 6f66 5f74 6578 7473 5f74 6f74 203d  d_of_texts_tot =
-00022670: 2073 656c 662e 646f 5f6f 7264 6572 5f6f   self.do_order_o
-00022680: 665f 7265 6769 6f6e 7328 636f 6e74 6f75  f_regions(contou
-00022690: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
-000226a0: 656e 745f 645f 6f72 6465 7265 642c 2063  ent_d_ordered, c
-000226b0: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
-000226c0: 745f 7061 7265 6e74 5f68 2c20 626f 7865  t_parent_h, boxe
-000226d0: 735f 642c 2074 6578 746c 696e 655f 6d61  s_d, textline_ma
-000226e0: 736b 5f74 6f74 5f64 290a 2020 2020 2020  sk_tot_d).      
-000226f0: 2020 2020 2020 7063 6774 7320 3d20 7365        pcgts = se
-00022700: 6c66 2e77 7269 7465 722e 6275 696c 645f  lf.writer.build_
-00022710: 7061 6765 786d 6c5f 6e6f 5f66 756c 6c5f  pagexml_no_full_
-00022720: 6c61 796f 7574 2874 7874 5f63 6f6e 5f6f  layout(txt_con_o
-00022730: 7267 2c20 7061 6765 5f63 6f6f 7264 2c20  rg, page_coord, 
-00022740: 6f72 6465 725f 7465 7874 5f6e 6577 2c20  order_text_new, 
-00022750: 6964 5f6f 665f 7465 7874 735f 746f 742c  id_of_texts_tot,
-00022760: 2061 6c6c 5f66 6f75 6e64 5f74 6578 6c69   all_found_texli
-00022770: 6e65 5f70 6f6c 7967 6f6e 732c 2061 6c6c  ne_polygons, all
-00022780: 5f62 6f78 5f63 6f6f 7264 2c20 706f 6c79  _box_coord, poly
-00022790: 676f 6e73 5f6f 665f 696d 6167 6573 2c20  gons_of_images, 
-000227a0: 706f 6c79 676f 6e73 5f6f 665f 6d61 7267  polygons_of_marg
-000227b0: 696e 616c 732c 2061 6c6c 5f66 6f75 6e64  inals, all_found
-000227c0: 5f74 6578 6c69 6e65 5f70 6f6c 7967 6f6e  _texline_polygon
-000227d0: 735f 6d61 7267 696e 616c 732c 2061 6c6c  s_marginals, all
-000227e0: 5f62 6f78 5f63 6f6f 7264 5f6d 6172 6769  _box_coord_margi
-000227f0: 6e61 6c73 2c20 736c 6f70 6573 2c20 736c  nals, slopes, sl
-00022800: 6f70 6573 5f6d 6172 6769 6e61 6c73 2c20  opes_marginals, 
-00022810: 636f 6e74 5f70 6167 652c 2070 6f6c 7967  cont_page, polyg
-00022820: 6f6e 735f 6c69 6e65 735f 786d 6c2c 2063  ons_lines_xml, c
-00022830: 6f6e 746f 7572 735f 7461 626c 6573 290a  ontours_tables).
-00022840: 2020 2020 2020 2020 2020 2020 7365 6c66              self
-00022850: 2e6c 6f67 6765 722e 696e 666f 2822 4a6f  .logger.info("Jo
-00022860: 6220 646f 6e65 2069 6e20 252e 3166 7322  b done in %.1fs"
-00022870: 2c20 7469 6d65 2e74 696d 6528 2920 2d20  , time.time() - 
-00022880: 7430 290a 2020 2020 2020 2020 2020 2020  t0).            
-00022890: 7265 7475 726e 2070 6367 7473 0a         return pcgts.
+0000b1c0: 2020 2020 2020 2020 7365 6720 3d20 7365          seg = se
+0000b1d0: 675b 3020 3a20 7365 672e 7368 6170 655b  g[0 : seg.shape[
+0000b1e0: 305d 202d 206d 6172 6769 6e2c 206d 6172  0] - margin, mar
+0000b1f0: 6769 6e20 3a20 7365 672e 7368 6170 655b  gin : seg.shape[
+0000b200: 315d 202d 206d 6172 6769 6e5d 0a20 2020  1] - margin].   
+0000b210: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b220: 2020 2020 206d 6173 6b5f 7472 7565 5b69       mask_true[i
+0000b230: 6e64 6578 5f79 5f64 202b 2030 203a 2069  ndex_y_d + 0 : i
+0000b240: 6e64 6578 5f79 5f75 202d 206d 6172 6769  ndex_y_u - margi
+0000b250: 6e2c 2069 6e64 6578 5f78 5f64 202b 206d  n, index_x_d + m
+0000b260: 6172 6769 6e20 3a20 696e 6465 785f 785f  argin : index_x_
+0000b270: 7520 2d20 6d61 7267 696e 5d20 3d20 7365  u - margin] = se
+0000b280: 670a 2020 2020 2020 2020 2020 2020 2020  g.              
+0000b290: 2020 2020 2020 2020 2020 7072 6564 6963            predic
+0000b2a0: 7469 6f6e 5f74 7275 655b 696e 6465 785f  tion_true[index_
+0000b2b0: 795f 6420 2b20 3020 3a20 696e 6465 785f  y_d + 0 : index_
+0000b2c0: 795f 7520 2d20 6d61 7267 696e 2c20 696e  y_u - margin, in
+0000b2d0: 6465 785f 785f 6420 2b20 6d61 7267 696e  dex_x_d + margin
+0000b2e0: 203a 2069 6e64 6578 5f78 5f75 202d 206d   : index_x_u - m
+0000b2f0: 6172 6769 6e2c 203a 5d20 3d20 7365 675f  argin, :] = seg_
+0000b300: 636f 6c6f 720a 2020 2020 2020 2020 2020  color.          
+0000b310: 2020 2020 2020 2020 2020 656c 6966 2069            elif i
+0000b320: 2021 3d20 3020 616e 6420 6920 213d 206e   != 0 and i != n
+0000b330: 7866 202d 2031 2061 6e64 206a 203d 3d20  xf - 1 and j == 
+0000b340: 6e79 6620 2d20 313a 0a20 2020 2020 2020  nyf - 1:.       
+0000b350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b360: 2073 6567 5f63 6f6c 6f72 203d 2073 6567   seg_color = seg
+0000b370: 5f63 6f6c 6f72 5b6d 6172 6769 6e20 3a20  _color[margin : 
+0000b380: 7365 675f 636f 6c6f 722e 7368 6170 655b  seg_color.shape[
+0000b390: 305d 202d 2030 2c20 6d61 7267 696e 203a  0] - 0, margin :
+0000b3a0: 2073 6567 5f63 6f6c 6f72 2e73 6861 7065   seg_color.shape
+0000b3b0: 5b31 5d20 2d20 6d61 7267 696e 2c20 3a5d  [1] - margin, :]
+0000b3c0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b3d0: 2020 2020 2020 2020 2073 6567 203d 2073           seg = s
+0000b3e0: 6567 5b6d 6172 6769 6e20 3a20 7365 672e  eg[margin : seg.
+0000b3f0: 7368 6170 655b 305d 202d 2030 2c20 6d61  shape[0] - 0, ma
+0000b400: 7267 696e 203a 2073 6567 2e73 6861 7065  rgin : seg.shape
+0000b410: 5b31 5d20 2d20 6d61 7267 696e 5d0a 2020  [1] - margin].  
+0000b420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b430: 2020 2020 2020 6d61 736b 5f74 7275 655b        mask_true[
+0000b440: 696e 6465 785f 795f 6420 2b20 6d61 7267  index_y_d + marg
+0000b450: 696e 203a 2069 6e64 6578 5f79 5f75 202d  in : index_y_u -
+0000b460: 2030 2c20 696e 6465 785f 785f 6420 2b20   0, index_x_d + 
+0000b470: 6d61 7267 696e 203a 2069 6e64 6578 5f78  margin : index_x
+0000b480: 5f75 202d 206d 6172 6769 6e5d 203d 2073  _u - margin] = s
+0000b490: 6567 0a20 2020 2020 2020 2020 2020 2020  eg.             
+0000b4a0: 2020 2020 2020 2020 2020 2070 7265 6469             predi
+0000b4b0: 6374 696f 6e5f 7472 7565 5b69 6e64 6578  ction_true[index
+0000b4c0: 5f79 5f64 202b 206d 6172 6769 6e20 3a20  _y_d + margin : 
+0000b4d0: 696e 6465 785f 795f 7520 2d20 302c 2069  index_y_u - 0, i
+0000b4e0: 6e64 6578 5f78 5f64 202b 206d 6172 6769  ndex_x_d + margi
+0000b4f0: 6e20 3a20 696e 6465 785f 785f 7520 2d20  n : index_x_u - 
+0000b500: 6d61 7267 696e 2c20 3a5d 203d 2073 6567  margin, :] = seg
+0000b510: 5f63 6f6c 6f72 0a20 2020 2020 2020 2020  _color.         
+0000b520: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+0000b530: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000b540: 2020 2020 2020 2020 2073 6567 5f63 6f6c           seg_col
+0000b550: 6f72 203d 2073 6567 5f63 6f6c 6f72 5b6d  or = seg_color[m
+0000b560: 6172 6769 6e20 3a20 7365 675f 636f 6c6f  argin : seg_colo
+0000b570: 722e 7368 6170 655b 305d 202d 206d 6172  r.shape[0] - mar
+0000b580: 6769 6e2c 206d 6172 6769 6e20 3a20 7365  gin, margin : se
+0000b590: 675f 636f 6c6f 722e 7368 6170 655b 315d  g_color.shape[1]
+0000b5a0: 202d 206d 6172 6769 6e2c 203a 5d0a 2020   - margin, :].  
+0000b5b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b5c0: 2020 2020 2020 7365 6720 3d20 7365 675b        seg = seg[
+0000b5d0: 6d61 7267 696e 203a 2073 6567 2e73 6861  margin : seg.sha
+0000b5e0: 7065 5b30 5d20 2d20 6d61 7267 696e 2c20  pe[0] - margin, 
+0000b5f0: 6d61 7267 696e 203a 2073 6567 2e73 6861  margin : seg.sha
+0000b600: 7065 5b31 5d20 2d20 6d61 7267 696e 5d0a  pe[1] - margin].
+0000b610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b620: 2020 2020 2020 2020 6d61 736b 5f74 7275          mask_tru
+0000b630: 655b 696e 6465 785f 795f 6420 2b20 6d61  e[index_y_d + ma
+0000b640: 7267 696e 203a 2069 6e64 6578 5f79 5f75  rgin : index_y_u
+0000b650: 202d 206d 6172 6769 6e2c 2069 6e64 6578   - margin, index
+0000b660: 5f78 5f64 202b 206d 6172 6769 6e20 3a20  _x_d + margin : 
+0000b670: 696e 6465 785f 785f 7520 2d20 6d61 7267  index_x_u - marg
+0000b680: 696e 5d20 3d20 7365 670a 2020 2020 2020  in] = seg.      
+0000b690: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000b6a0: 2020 7072 6564 6963 7469 6f6e 5f74 7275    prediction_tru
+0000b6b0: 655b 696e 6465 785f 795f 6420 2b20 6d61  e[index_y_d + ma
+0000b6c0: 7267 696e 203a 2069 6e64 6578 5f79 5f75  rgin : index_y_u
+0000b6d0: 202d 206d 6172 6769 6e2c 2069 6e64 6578   - margin, index
+0000b6e0: 5f78 5f64 202b 206d 6172 6769 6e20 3a20  _x_d + margin : 
+0000b6f0: 696e 6465 785f 785f 7520 2d20 6d61 7267  index_x_u - marg
+0000b700: 696e 2c20 3a5d 203d 2073 6567 5f63 6f6c  in, :] = seg_col
+0000b710: 6f72 0a0a 2020 2020 2020 2020 2020 2020  or..            
+0000b720: 7072 6564 6963 7469 6f6e 5f74 7275 6520  prediction_true 
+0000b730: 3d20 7072 6564 6963 7469 6f6e 5f74 7275  = prediction_tru
+0000b740: 652e 6173 7479 7065 286e 702e 7569 6e74  e.astype(np.uint
+0000b750: 3829 0a20 2020 2020 2020 2072 6574 7572  8).        retur
+0000b760: 6e20 7072 6564 6963 7469 6f6e 5f74 7275  n prediction_tru
+0000b770: 650a 0a20 2020 2064 6566 2065 7874 7261  e..    def extra
+0000b780: 6374 5f70 6167 6528 7365 6c66 293a 0a20  ct_page(self):. 
+0000b790: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
+0000b7a0: 6572 2e64 6562 7567 2822 656e 7465 7220  er.debug("enter 
+0000b7b0: 6578 7472 6163 745f 7061 6765 2229 0a20  extract_page"). 
+0000b7c0: 2020 2020 2020 2063 6f6e 745f 7061 6765         cont_page
+0000b7d0: 203d 205b 5d0a 2020 2020 2020 2020 6966   = [].        if
+0000b7e0: 206e 6f74 2073 656c 662e 6967 6e6f 7265   not self.ignore
+0000b7f0: 5f70 6167 655f 6578 7472 6163 7469 6f6e  _page_extraction
+0000b800: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
+0000b810: 6720 3d20 6376 322e 4761 7573 7369 616e  g = cv2.Gaussian
+0000b820: 426c 7572 2873 656c 662e 696d 6167 652c  Blur(self.image,
+0000b830: 2028 352c 2035 292c 2030 290a 2020 2020   (5, 5), 0).    
+0000b840: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0000b850: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+0000b860: 2e64 6972 5f69 6e3a 0a20 2020 2020 2020  .dir_in:.       
+0000b870: 2020 2020 2020 2020 206d 6f64 656c 5f70           model_p
+0000b880: 6167 652c 2073 6573 7369 6f6e 5f70 6167  age, session_pag
+0000b890: 6520 3d20 7365 6c66 2e73 7461 7274 5f6e  e = self.start_n
+0000b8a0: 6577 5f73 6573 7369 6f6e 5f61 6e64 5f6d  ew_session_and_m
+0000b8b0: 6f64 656c 2873 656c 662e 6d6f 6465 6c5f  odel(self.model_
+0000b8c0: 7061 6765 5f64 6972 290a 2020 2020 2020  page_dir).      
+0000b8d0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0000b8e0: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+0000b8f0: 6c66 2e64 6972 5f69 6e3a 0a20 2020 2020  lf.dir_in:.     
+0000b900: 2020 2020 2020 2020 2020 2069 6d67 5f70             img_p
+0000b910: 6167 655f 7072 6564 6963 7469 6f6e 203d  age_prediction =
+0000b920: 2073 656c 662e 646f 5f70 7265 6469 6374   self.do_predict
+0000b930: 696f 6e28 4661 6c73 652c 2069 6d67 2c20  ion(False, img, 
+0000b940: 6d6f 6465 6c5f 7061 6765 290a 2020 2020  model_page).    
+0000b950: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000b960: 2020 2020 2020 2020 2020 2020 2020 696d                im
+0000b970: 675f 7061 6765 5f70 7265 6469 6374 696f  g_page_predictio
+0000b980: 6e20 3d20 7365 6c66 2e64 6f5f 7072 6564  n = self.do_pred
+0000b990: 6963 7469 6f6e 2846 616c 7365 2c20 696d  iction(False, im
+0000b9a0: 672c 2073 656c 662e 6d6f 6465 6c5f 7061  g, self.model_pa
+0000b9b0: 6765 290a 2020 2020 2020 2020 2020 2020  ge).            
+0000b9c0: 696d 6772 6179 203d 2063 7632 2e63 7674  imgray = cv2.cvt
+0000b9d0: 436f 6c6f 7228 696d 675f 7061 6765 5f70  Color(img_page_p
+0000b9e0: 7265 6469 6374 696f 6e2c 2063 7632 2e43  rediction, cv2.C
+0000b9f0: 4f4c 4f52 5f42 4752 3247 5241 5929 0a20  OLOR_BGR2GRAY). 
+0000ba00: 2020 2020 2020 2020 2020 205f 2c20 7468             _, th
+0000ba10: 7265 7368 203d 2063 7632 2e74 6872 6573  resh = cv2.thres
+0000ba20: 686f 6c64 2869 6d67 7261 792c 2030 2c20  hold(imgray, 0, 
+0000ba30: 3235 352c 2030 290a 2020 2020 2020 2020  255, 0).        
+0000ba40: 2020 2020 7468 7265 7368 203d 2063 7632      thresh = cv2
+0000ba50: 2e64 696c 6174 6528 7468 7265 7368 2c20  .dilate(thresh, 
+0000ba60: 4b45 524e 454c 2c20 6974 6572 6174 696f  KERNEL, iteratio
+0000ba70: 6e73 3d33 290a 2020 2020 2020 2020 2020  ns=3).          
+0000ba80: 2020 636f 6e74 6f75 7273 2c20 5f20 3d20    contours, _ = 
+0000ba90: 6376 322e 6669 6e64 436f 6e74 6f75 7273  cv2.findContours
+0000baa0: 2874 6872 6573 682c 2063 7632 2e52 4554  (thresh, cv2.RET
+0000bab0: 525f 5452 4545 2c20 6376 322e 4348 4149  R_TREE, cv2.CHAI
+0000bac0: 4e5f 4150 5052 4f58 5f53 494d 504c 4529  N_APPROX_SIMPLE)
+0000bad0: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+0000bae0: 2020 2020 2020 2020 2020 6966 206c 656e            if len
+0000baf0: 2863 6f6e 746f 7572 7329 3e30 3a0a 2020  (contours)>0:.  
+0000bb00: 2020 2020 2020 2020 2020 2020 2020 636e                cn
+0000bb10: 745f 7369 7a65 203d 206e 702e 6172 7261  t_size = np.arra
+0000bb20: 7928 5b63 7632 2e63 6f6e 746f 7572 4172  y([cv2.contourAr
+0000bb30: 6561 2863 6f6e 746f 7572 735b 6a5d 2920  ea(contours[j]) 
+0000bb40: 666f 7220 6a20 696e 2072 616e 6765 286c  for j in range(l
+0000bb50: 656e 2863 6f6e 746f 7572 7329 295d 290a  en(contours))]).
+0000bb60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bb70: 636e 7420 3d20 636f 6e74 6f75 7273 5b6e  cnt = contours[n
+0000bb80: 702e 6172 676d 6178 2863 6e74 5f73 697a  p.argmax(cnt_siz
+0000bb90: 6529 5d0a 2020 2020 2020 2020 2020 2020  e)].            
+0000bba0: 2020 2020 782c 2079 2c20 772c 2068 203d      x, y, w, h =
+0000bbb0: 2063 7632 2e62 6f75 6e64 696e 6752 6563   cv2.boundingRec
+0000bbc0: 7428 636e 7429 0a20 2020 2020 2020 2020  t(cnt).         
+0000bbd0: 2020 2020 2020 2069 6620 7820 3c3d 2033         if x <= 3
+0000bbe0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0000bbf0: 2020 2020 2020 2077 202b 3d20 780a 2020         w += x.  
+0000bc00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bc10: 2020 7820 3d20 300a 2020 2020 2020 2020    x = 0.        
+0000bc20: 2020 2020 2020 2020 6966 2028 7365 6c66          if (self
+0000bc30: 2e69 6d61 6765 2e73 6861 7065 5b31 5d20  .image.shape[1] 
+0000bc40: 2d20 2878 202b 2077 2929 203c 3d20 3330  - (x + w)) <= 30
+0000bc50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000bc60: 2020 2020 2020 7720 3d20 7720 2b20 2873        w = w + (s
+0000bc70: 656c 662e 696d 6167 652e 7368 6170 655b  elf.image.shape[
+0000bc80: 315d 202d 2028 7820 2b20 7729 290a 2020  1] - (x + w)).  
+0000bc90: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0000bca0: 2079 203c 3d20 3330 3a0a 2020 2020 2020   y <= 30:.      
+0000bcb0: 2020 2020 2020 2020 2020 2020 2020 6820                h 
+0000bcc0: 3d20 6820 2b20 790a 2020 2020 2020 2020  = h + y.        
+0000bcd0: 2020 2020 2020 2020 2020 2020 7920 3d20              y = 
+0000bce0: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
+0000bcf0: 2020 6966 2028 7365 6c66 2e69 6d61 6765    if (self.image
+0000bd00: 2e73 6861 7065 5b30 5d20 2d20 2879 202b  .shape[0] - (y +
+0000bd10: 2068 2929 203c 3d20 3330 3a0a 2020 2020   h)) <= 30:.    
+0000bd20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000bd30: 6820 3d20 6820 2b20 2873 656c 662e 696d  h = h + (self.im
+0000bd40: 6167 652e 7368 6170 655b 305d 202d 2028  age.shape[0] - (
+0000bd50: 7920 2b20 6829 290a 0a20 2020 2020 2020  y + h))..       
+0000bd60: 2020 2020 2020 2020 2062 6f78 203d 205b           box = [
+0000bd70: 782c 2079 2c20 772c 2068 5d0a 2020 2020  x, y, w, h].    
+0000bd80: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000bd90: 2020 2020 2020 2020 2020 2020 2020 626f                bo
+0000bda0: 7820 3d20 5b30 2c20 302c 2069 6d67 2e73  x = [0, 0, img.s
+0000bdb0: 6861 7065 5b31 5d2c 2069 6d67 2e73 6861  hape[1], img.sha
+0000bdc0: 7065 5b30 5d5d 0a20 2020 2020 2020 2020  pe[0]].         
+0000bdd0: 2020 2063 726f 7065 645f 7061 6765 2c20     croped_page, 
+0000bde0: 7061 6765 5f63 6f6f 7264 203d 2063 726f  page_coord = cro
+0000bdf0: 705f 696d 6167 655f 696e 7369 6465 5f62  p_image_inside_b
+0000be00: 6f78 2862 6f78 2c20 7365 6c66 2e69 6d61  ox(box, self.ima
+0000be10: 6765 290a 2020 2020 2020 2020 2020 2020  ge).            
+0000be20: 636f 6e74 5f70 6167 652e 6170 7065 6e64  cont_page.append
+0000be30: 286e 702e 6172 7261 7928 5b5b 7061 6765  (np.array([[page
+0000be40: 5f63 6f6f 7264 5b32 5d2c 2070 6167 655f  _coord[2], page_
+0000be50: 636f 6f72 645b 305d 5d2c 205b 7061 6765  coord[0]], [page
+0000be60: 5f63 6f6f 7264 5b33 5d2c 2070 6167 655f  _coord[3], page_
+0000be70: 636f 6f72 645b 305d 5d2c 205b 7061 6765  coord[0]], [page
+0000be80: 5f63 6f6f 7264 5b33 5d2c 2070 6167 655f  _coord[3], page_
+0000be90: 636f 6f72 645b 315d 5d2c 205b 7061 6765  coord[1]], [page
+0000bea0: 5f63 6f6f 7264 5b32 5d2c 2070 6167 655f  _coord[2], page_
+0000beb0: 636f 6f72 645b 315d 5d5d 2929 0a20 2020  coord[1]]])).   
+0000bec0: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0000bed0: 2020 2020 2020 7365 6c66 2e6c 6f67 6765        self.logge
+0000bee0: 722e 6465 6275 6728 2265 7869 7420 6578  r.debug("exit ex
+0000bef0: 7472 6163 745f 7061 6765 2229 0a20 2020  tract_page").   
+0000bf00: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0000bf10: 2020 2020 2020 2062 6f78 203d 205b 302c         box = [0,
+0000bf20: 2030 2c20 7365 6c66 2e69 6d61 6765 2e73   0, self.image.s
+0000bf30: 6861 7065 5b31 5d2c 2073 656c 662e 696d  hape[1], self.im
+0000bf40: 6167 652e 7368 6170 655b 305d 5d0a 2020  age.shape[0]].  
+0000bf50: 2020 2020 2020 2020 2020 6372 6f70 6564            croped
+0000bf60: 5f70 6167 652c 2070 6167 655f 636f 6f72  _page, page_coor
+0000bf70: 6420 3d20 6372 6f70 5f69 6d61 6765 5f69  d = crop_image_i
+0000bf80: 6e73 6964 655f 626f 7828 626f 782c 2073  nside_box(box, s
+0000bf90: 656c 662e 696d 6167 6529 0a20 2020 2020  elf.image).     
+0000bfa0: 2020 2020 2020 2063 6f6e 745f 7061 6765         cont_page
+0000bfb0: 2e61 7070 656e 6428 6e70 2e61 7272 6179  .append(np.array
+0000bfc0: 285b 5b70 6167 655f 636f 6f72 645b 325d  ([[page_coord[2]
+0000bfd0: 2c20 7061 6765 5f63 6f6f 7264 5b30 5d5d  , page_coord[0]]
+0000bfe0: 2c20 5b70 6167 655f 636f 6f72 645b 335d  , [page_coord[3]
+0000bff0: 2c20 7061 6765 5f63 6f6f 7264 5b30 5d5d  , page_coord[0]]
+0000c000: 2c20 5b70 6167 655f 636f 6f72 645b 335d  , [page_coord[3]
+0000c010: 2c20 7061 6765 5f63 6f6f 7264 5b31 5d5d  , page_coord[1]]
+0000c020: 2c20 5b70 6167 655f 636f 6f72 645b 325d  , [page_coord[2]
+0000c030: 2c20 7061 6765 5f63 6f6f 7264 5b31 5d5d  , page_coord[1]]
+0000c040: 5d29 290a 2020 2020 2020 2020 7265 7475  ])).        retu
+0000c050: 726e 2063 726f 7065 645f 7061 6765 2c20  rn croped_page, 
+0000c060: 7061 6765 5f63 6f6f 7264 2c20 636f 6e74  page_coord, cont
+0000c070: 5f70 6167 650a 0a20 2020 2064 6566 2065  _page..    def e
+0000c080: 6172 6c79 5f70 6167 655f 666f 725f 6e75  arly_page_for_nu
+0000c090: 6d5f 6f66 5f63 6f6c 756d 6e5f 636c 6173  m_of_column_clas
+0000c0a0: 7369 6669 6361 7469 6f6e 2873 656c 662c  sification(self,
+0000c0b0: 696d 675f 6269 6e29 3a0a 2020 2020 2020  img_bin):.      
+0000c0c0: 2020 6966 206e 6f74 2073 656c 662e 6967    if not self.ig
+0000c0d0: 6e6f 7265 5f70 6167 655f 6578 7472 6163  nore_page_extrac
+0000c0e0: 7469 6f6e 3a0a 2020 2020 2020 2020 2020  tion:.          
+0000c0f0: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
+0000c100: 6275 6728 2265 6e74 6572 2065 6172 6c79  bug("enter early
+0000c110: 5f70 6167 655f 666f 725f 6e75 6d5f 6f66  _page_for_num_of
+0000c120: 5f63 6f6c 756d 6e5f 636c 6173 7369 6669  _column_classifi
+0000c130: 6361 7469 6f6e 2229 0a20 2020 2020 2020  cation").       
+0000c140: 2020 2020 2069 6620 7365 6c66 2e69 6e70       if self.inp
+0000c150: 7574 5f62 696e 6172 793a 0a20 2020 2020  ut_binary:.     
+0000c160: 2020 2020 2020 2020 2020 2069 6d67 203d             img =
+0000c170: 6e70 2e63 6f70 7928 696d 675f 6269 6e29  np.copy(img_bin)
+0000c180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000c190: 2069 6d67 203d 2069 6d67 2e61 7374 7970   img = img.astyp
+0000c1a0: 6528 6e70 2e75 696e 7438 290a 2020 2020  e(np.uint8).    
+0000c1b0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+0000c1c0: 2020 2020 2020 2020 2020 2020 2020 696d                im
+0000c1d0: 6720 3d20 7365 6c66 2e69 6d72 6561 6428  g = self.imread(
+0000c1e0: 290a 2020 2020 2020 2020 2020 2020 6966  ).            if
+0000c1f0: 206e 6f74 2073 656c 662e 6469 725f 696e   not self.dir_in
+0000c200: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000c210: 2020 6d6f 6465 6c5f 7061 6765 2c20 7365    model_page, se
+0000c220: 7373 696f 6e5f 7061 6765 203d 2073 656c  ssion_page = sel
+0000c230: 662e 7374 6172 745f 6e65 775f 7365 7373  f.start_new_sess
+0000c240: 696f 6e5f 616e 645f 6d6f 6465 6c28 7365  ion_and_model(se
+0000c250: 6c66 2e6d 6f64 656c 5f70 6167 655f 6469  lf.model_page_di
+0000c260: 7229 0a20 2020 2020 2020 2020 2020 2069  r).            i
+0000c270: 6d67 203d 2063 7632 2e47 6175 7373 6961  mg = cv2.Gaussia
+0000c280: 6e42 6c75 7228 696d 672c 2028 352c 2035  nBlur(img, (5, 5
+0000c290: 292c 2030 290a 2020 2020 2020 2020 2020  ), 0).          
+0000c2a0: 2020 0a20 2020 2020 2020 2020 2020 2069    .            i
+0000c2b0: 6620 7365 6c66 2e64 6972 5f69 6e3a 0a20  f self.dir_in:. 
+0000c2c0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000c2d0: 6d67 5f70 6167 655f 7072 6564 6963 7469  mg_page_predicti
+0000c2e0: 6f6e 203d 2073 656c 662e 646f 5f70 7265  on = self.do_pre
+0000c2f0: 6469 6374 696f 6e28 4661 6c73 652c 2069  diction(False, i
+0000c300: 6d67 2c20 7365 6c66 2e6d 6f64 656c 5f70  mg, self.model_p
+0000c310: 6167 6529 0a20 2020 2020 2020 2020 2020  age).           
+0000c320: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0000c330: 2020 2020 2020 2069 6d67 5f70 6167 655f         img_page_
+0000c340: 7072 6564 6963 7469 6f6e 203d 2073 656c  prediction = sel
+0000c350: 662e 646f 5f70 7265 6469 6374 696f 6e28  f.do_prediction(
+0000c360: 4661 6c73 652c 2069 6d67 2c20 6d6f 6465  False, img, mode
+0000c370: 6c5f 7061 6765 290a 0a20 2020 2020 2020  l_page)..       
+0000c380: 2020 2020 2069 6d67 7261 7920 3d20 6376       imgray = cv
+0000c390: 322e 6376 7443 6f6c 6f72 2869 6d67 5f70  2.cvtColor(img_p
+0000c3a0: 6167 655f 7072 6564 6963 7469 6f6e 2c20  age_prediction, 
+0000c3b0: 6376 322e 434f 4c4f 525f 4247 5232 4752  cv2.COLOR_BGR2GR
+0000c3c0: 4159 290a 2020 2020 2020 2020 2020 2020  AY).            
+0000c3d0: 5f2c 2074 6872 6573 6820 3d20 6376 322e  _, thresh = cv2.
+0000c3e0: 7468 7265 7368 6f6c 6428 696d 6772 6179  threshold(imgray
+0000c3f0: 2c20 302c 2032 3535 2c20 3029 0a20 2020  , 0, 255, 0).   
+0000c400: 2020 2020 2020 2020 2074 6872 6573 6820           thresh 
+0000c410: 3d20 6376 322e 6469 6c61 7465 2874 6872  = cv2.dilate(thr
+0000c420: 6573 682c 204b 4552 4e45 4c2c 2069 7465  esh, KERNEL, ite
+0000c430: 7261 7469 6f6e 733d 3329 0a20 2020 2020  rations=3).     
+0000c440: 2020 2020 2020 2063 6f6e 746f 7572 732c         contours,
+0000c450: 205f 203d 2063 7632 2e66 696e 6443 6f6e   _ = cv2.findCon
+0000c460: 746f 7572 7328 7468 7265 7368 2c20 6376  tours(thresh, cv
+0000c470: 322e 5245 5452 5f54 5245 452c 2063 7632  2.RETR_TREE, cv2
+0000c480: 2e43 4841 494e 5f41 5050 524f 585f 5349  .CHAIN_APPROX_SI
+0000c490: 4d50 4c45 290a 2020 2020 2020 2020 2020  MPLE).          
+0000c4a0: 2020 6966 206c 656e 2863 6f6e 746f 7572    if len(contour
+0000c4b0: 7329 3e30 3a0a 2020 2020 2020 2020 2020  s)>0:.          
+0000c4c0: 2020 2020 2020 636e 745f 7369 7a65 203d        cnt_size =
+0000c4d0: 206e 702e 6172 7261 7928 5b63 7632 2e63   np.array([cv2.c
+0000c4e0: 6f6e 746f 7572 4172 6561 2863 6f6e 746f  ontourArea(conto
+0000c4f0: 7572 735b 6a5d 2920 666f 7220 6a20 696e  urs[j]) for j in
+0000c500: 2072 616e 6765 286c 656e 2863 6f6e 746f   range(len(conto
+0000c510: 7572 7329 295d 290a 2020 2020 2020 2020  urs))]).        
+0000c520: 2020 2020 2020 2020 636e 7420 3d20 636f          cnt = co
+0000c530: 6e74 6f75 7273 5b6e 702e 6172 676d 6178  ntours[np.argmax
+0000c540: 2863 6e74 5f73 697a 6529 5d0a 2020 2020  (cnt_size)].    
+0000c550: 2020 2020 2020 2020 2020 2020 782c 2079              x, y
+0000c560: 2c20 772c 2068 203d 2063 7632 2e62 6f75  , w, h = cv2.bou
+0000c570: 6e64 696e 6752 6563 7428 636e 7429 0a20  ndingRect(cnt). 
+0000c580: 2020 2020 2020 2020 2020 2020 2020 2062                 b
+0000c590: 6f78 203d 205b 782c 2079 2c20 772c 2068  ox = [x, y, w, h
+0000c5a0: 5d0a 2020 2020 2020 2020 2020 2020 656c  ].            el
+0000c5b0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0000c5c0: 2020 2020 626f 7820 3d20 5b30 2c20 302c      box = [0, 0,
+0000c5d0: 2069 6d67 2e73 6861 7065 5b31 5d2c 2069   img.shape[1], i
+0000c5e0: 6d67 2e73 6861 7065 5b30 5d5d 0a20 2020  mg.shape[0]].   
+0000c5f0: 2020 2020 2020 2020 2063 726f 7065 645f           croped_
+0000c600: 7061 6765 2c20 7061 6765 5f63 6f6f 7264  page, page_coord
+0000c610: 203d 2063 726f 705f 696d 6167 655f 696e   = crop_image_in
+0000c620: 7369 6465 5f62 6f78 2862 6f78 2c20 696d  side_box(box, im
+0000c630: 6729 0a20 2020 2020 2020 2020 2020 200a  g).            .
+0000c640: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+0000c650: 2e6c 6f67 6765 722e 6465 6275 6728 2265  .logger.debug("e
+0000c660: 7869 7420 6561 726c 795f 7061 6765 5f66  xit early_page_f
+0000c670: 6f72 5f6e 756d 5f6f 665f 636f 6c75 6d6e  or_num_of_column
+0000c680: 5f63 6c61 7373 6966 6963 6174 696f 6e22  _classification"
+0000c690: 290a 2020 2020 2020 2020 656c 7365 3a0a  ).        else:.
+0000c6a0: 2020 2020 2020 2020 2020 2020 696d 6720              img 
+0000c6b0: 3d20 7365 6c66 2e69 6d72 6561 6428 290a  = self.imread().
+0000c6c0: 2020 2020 2020 2020 2020 2020 626f 7820              box 
+0000c6d0: 3d20 5b30 2c20 302c 2069 6d67 2e73 6861  = [0, 0, img.sha
+0000c6e0: 7065 5b31 5d2c 2069 6d67 2e73 6861 7065  pe[1], img.shape
+0000c6f0: 5b30 5d5d 0a20 2020 2020 2020 2020 2020  [0]].           
+0000c700: 2063 726f 7065 645f 7061 6765 2c20 7061   croped_page, pa
+0000c710: 6765 5f63 6f6f 7264 203d 2063 726f 705f  ge_coord = crop_
+0000c720: 696d 6167 655f 696e 7369 6465 5f62 6f78  image_inside_box
+0000c730: 2862 6f78 2c20 696d 6729 0a20 2020 2020  (box, img).     
+0000c740: 2020 2072 6574 7572 6e20 6372 6f70 6564     return croped
+0000c750: 5f70 6167 652c 2070 6167 655f 636f 6f72  _page, page_coor
+0000c760: 640a 0a20 2020 2064 6566 2065 7874 7261  d..    def extra
+0000c770: 6374 5f74 6578 745f 7265 6769 6f6e 7328  ct_text_regions(
+0000c780: 7365 6c66 2c20 696d 672c 2070 6174 6368  self, img, patch
+0000c790: 6573 2c20 636f 6c73 293a 0a20 2020 2020  es, cols):.     
+0000c7a0: 2020 2073 656c 662e 6c6f 6767 6572 2e64     self.logger.d
+0000c7b0: 6562 7567 2822 656e 7465 7220 6578 7472  ebug("enter extr
+0000c7c0: 6163 745f 7465 7874 5f72 6567 696f 6e73  act_text_regions
+0000c7d0: 2229 0a20 2020 2020 2020 2069 6d67 5f68  ").        img_h
+0000c7e0: 6569 6768 745f 6820 3d20 696d 672e 7368  eight_h = img.sh
+0000c7f0: 6170 655b 305d 0a20 2020 2020 2020 2069  ape[0].        i
+0000c800: 6d67 5f77 6964 7468 5f68 203d 2069 6d67  mg_width_h = img
+0000c810: 2e73 6861 7065 5b31 5d0a 2020 2020 2020  .shape[1].      
+0000c820: 2020 6966 206e 6f74 2073 656c 662e 6469    if not self.di
+0000c830: 725f 696e 3a0a 2020 2020 2020 2020 2020  r_in:.          
+0000c840: 2020 6d6f 6465 6c5f 7265 6769 6f6e 2c20    model_region, 
+0000c850: 7365 7373 696f 6e5f 7265 6769 6f6e 203d  session_region =
+0000c860: 2073 656c 662e 7374 6172 745f 6e65 775f   self.start_new_
+0000c870: 7365 7373 696f 6e5f 616e 645f 6d6f 6465  session_and_mode
+0000c880: 6c28 7365 6c66 2e6d 6f64 656c 5f72 6567  l(self.model_reg
+0000c890: 696f 6e5f 6469 725f 6675 6c6c 7920 6966  ion_dir_fully if
+0000c8a0: 2070 6174 6368 6573 2065 6c73 6520 7365   patches else se
+0000c8b0: 6c66 2e6d 6f64 656c 5f72 6567 696f 6e5f  lf.model_region_
+0000c8c0: 6469 725f 6675 6c6c 795f 6e70 290a 2020  dir_fully_np).  
+0000c8d0: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0000c8e0: 2020 2020 2020 2020 6d6f 6465 6c5f 7265          model_re
+0000c8f0: 6769 6f6e 203d 2073 656c 662e 6d6f 6465  gion = self.mode
+0000c900: 6c5f 7265 6769 6f6e 5f66 6c20 6966 2070  l_region_fl if p
+0000c910: 6174 6368 6573 2065 6c73 6520 7365 6c66  atches else self
+0000c920: 2e6d 6f64 656c 5f72 6567 696f 6e5f 666c  .model_region_fl
+0000c930: 5f6e 700a 0a20 2020 2020 2020 2069 6620  _np..        if 
+0000c940: 6e6f 7420 7061 7463 6865 733a 0a20 2020  not patches:.   
+0000c950: 2020 2020 2020 2020 2069 6d67 203d 206f           img = o
+0000c960: 7473 755f 636f 7079 5f62 696e 6172 7928  tsu_copy_binary(
+0000c970: 696d 6729 0a20 2020 2020 2020 2020 2020  img).           
+0000c980: 2069 6d67 203d 2069 6d67 2e61 7374 7970   img = img.astyp
+0000c990: 6528 6e70 2e75 696e 7438 290a 2020 2020  e(np.uint8).    
+0000c9a0: 2020 2020 2020 2020 7072 6564 6963 7469          predicti
+0000c9b0: 6f6e 5f72 6567 696f 6e73 3220 3d20 4e6f  on_regions2 = No
+0000c9c0: 6e65 0a20 2020 2020 2020 2065 6c73 653a  ne.        else:
+0000c9d0: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+0000c9e0: 636f 6c73 203d 3d20 313a 0a20 2020 2020  cols == 1:.     
+0000c9f0: 2020 2020 2020 2020 2020 2069 6d67 3220             img2 
+0000ca00: 3d20 6f74 7375 5f63 6f70 795f 6269 6e61  = otsu_copy_bina
+0000ca10: 7279 2869 6d67 290a 2020 2020 2020 2020  ry(img).        
+0000ca20: 2020 2020 2020 2020 696d 6732 203d 2069          img2 = i
+0000ca30: 6d67 322e 6173 7479 7065 286e 702e 7569  mg2.astype(np.ui
+0000ca40: 6e74 3829 0a20 2020 2020 2020 2020 2020  nt8).           
+0000ca50: 2020 2020 2069 6d67 3220 3d20 7265 7369       img2 = resi
+0000ca60: 7a65 5f69 6d61 6765 2869 6d67 322c 2069  ze_image(img2, i
+0000ca70: 6e74 2869 6d67 5f68 6569 6768 745f 6820  nt(img_height_h 
+0000ca80: 2a20 302e 3729 2c20 696e 7428 696d 675f  * 0.7), int(img_
+0000ca90: 7769 6474 685f 6820 2a20 302e 3729 290a  width_h * 0.7)).
+0000caa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cab0: 6d61 7267 696e 616c 5f6f 665f 7061 7463  marginal_of_patc
+0000cac0: 685f 7065 7263 656e 7420 3d20 302e 310a  h_percent = 0.1.
+0000cad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000cae0: 7072 6564 6963 7469 6f6e 5f72 6567 696f  prediction_regio
+0000caf0: 6e73 3220 3d20 7365 6c66 2e64 6f5f 7072  ns2 = self.do_pr
+0000cb00: 6564 6963 7469 6f6e 2870 6174 6368 6573  ediction(patches
+0000cb10: 2c20 696d 6732 2c20 6d6f 6465 6c5f 7265  , img2, model_re
+0000cb20: 6769 6f6e 2c20 6d61 7267 696e 616c 5f6f  gion, marginal_o
+0000cb30: 665f 7061 7463 685f 7065 7263 656e 7429  f_patch_percent)
+0000cb40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cb50: 2070 7265 6469 6374 696f 6e5f 7265 6769   prediction_regi
+0000cb60: 6f6e 7332 203d 2072 6573 697a 655f 696d  ons2 = resize_im
+0000cb70: 6167 6528 7072 6564 6963 7469 6f6e 5f72  age(prediction_r
+0000cb80: 6567 696f 6e73 322c 2069 6d67 5f68 6569  egions2, img_hei
+0000cb90: 6768 745f 682c 2069 6d67 5f77 6964 7468  ght_h, img_width
+0000cba0: 5f68 290a 0a20 2020 2020 2020 2020 2020  _h)..           
+0000cbb0: 2069 6620 636f 6c73 203d 3d20 323a 0a20   if cols == 2:. 
+0000cbc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000cbd0: 6d67 3220 3d20 6f74 7375 5f63 6f70 795f  mg2 = otsu_copy_
+0000cbe0: 6269 6e61 7279 2869 6d67 290a 2020 2020  binary(img).    
+0000cbf0: 2020 2020 2020 2020 2020 2020 696d 6732              img2
+0000cc00: 203d 2069 6d67 322e 6173 7479 7065 286e   = img2.astype(n
+0000cc10: 702e 7569 6e74 3829 0a20 2020 2020 2020  p.uint8).       
+0000cc20: 2020 2020 2020 2020 2069 6d67 3220 3d20           img2 = 
+0000cc30: 7265 7369 7a65 5f69 6d61 6765 2869 6d67  resize_image(img
+0000cc40: 322c 2069 6e74 2869 6d67 5f68 6569 6768  2, int(img_heigh
+0000cc50: 745f 6820 2a20 302e 3429 2c20 696e 7428  t_h * 0.4), int(
+0000cc60: 696d 675f 7769 6474 685f 6820 2a20 302e  img_width_h * 0.
+0000cc70: 3429 290a 2020 2020 2020 2020 2020 2020  4)).            
+0000cc80: 2020 2020 6d61 7267 696e 616c 5f6f 665f      marginal_of_
+0000cc90: 7061 7463 685f 7065 7263 656e 7420 3d20  patch_percent = 
+0000cca0: 302e 310a 2020 2020 2020 2020 2020 2020  0.1.            
+0000ccb0: 2020 2020 7072 6564 6963 7469 6f6e 5f72      prediction_r
+0000ccc0: 6567 696f 6e73 3220 3d20 7365 6c66 2e64  egions2 = self.d
+0000ccd0: 6f5f 7072 6564 6963 7469 6f6e 2870 6174  o_prediction(pat
+0000cce0: 6368 6573 2c20 696d 6732 2c20 6d6f 6465  ches, img2, mode
+0000ccf0: 6c5f 7265 6769 6f6e 2c20 6d61 7267 696e  l_region, margin
+0000cd00: 616c 5f6f 665f 7061 7463 685f 7065 7263  al_of_patch_perc
+0000cd10: 656e 7429 0a20 2020 2020 2020 2020 2020  ent).           
+0000cd20: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
+0000cd30: 7265 6769 6f6e 7332 203d 2072 6573 697a  regions2 = resiz
+0000cd40: 655f 696d 6167 6528 7072 6564 6963 7469  e_image(predicti
+0000cd50: 6f6e 5f72 6567 696f 6e73 322c 2069 6d67  on_regions2, img
+0000cd60: 5f68 6569 6768 745f 682c 2069 6d67 5f77  _height_h, img_w
+0000cd70: 6964 7468 5f68 290a 0a20 2020 2020 2020  idth_h)..       
+0000cd80: 2020 2020 2065 6c69 6620 636f 6c73 203e       elif cols >
+0000cd90: 2032 3a0a 2020 2020 2020 2020 2020 2020   2:.            
+0000cda0: 2020 2020 696d 6732 203d 206f 7473 755f      img2 = otsu_
+0000cdb0: 636f 7079 5f62 696e 6172 7928 696d 6729  copy_binary(img)
+0000cdc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000cdd0: 2069 6d67 3220 3d20 696d 6732 2e61 7374   img2 = img2.ast
+0000cde0: 7970 6528 6e70 2e75 696e 7438 290a 2020  ype(np.uint8).  
+0000cdf0: 2020 2020 2020 2020 2020 2020 2020 696d                im
+0000ce00: 6732 203d 2072 6573 697a 655f 696d 6167  g2 = resize_imag
+0000ce10: 6528 696d 6732 2c20 696e 7428 696d 675f  e(img2, int(img_
+0000ce20: 6865 6967 6874 5f68 202a 2030 2e33 292c  height_h * 0.3),
+0000ce30: 2069 6e74 2869 6d67 5f77 6964 7468 5f68   int(img_width_h
+0000ce40: 202a 2030 2e33 2929 0a20 2020 2020 2020   * 0.3)).       
+0000ce50: 2020 2020 2020 2020 206d 6172 6769 6e61           margina
+0000ce60: 6c5f 6f66 5f70 6174 6368 5f70 6572 6365  l_of_patch_perce
+0000ce70: 6e74 203d 2030 2e31 0a20 2020 2020 2020  nt = 0.1.       
+0000ce80: 2020 2020 2020 2020 2070 7265 6469 6374           predict
+0000ce90: 696f 6e5f 7265 6769 6f6e 7332 203d 2073  ion_regions2 = s
+0000cea0: 656c 662e 646f 5f70 7265 6469 6374 696f  elf.do_predictio
+0000ceb0: 6e28 7061 7463 6865 732c 2069 6d67 322c  n(patches, img2,
+0000cec0: 206d 6f64 656c 5f72 6567 696f 6e2c 206d   model_region, m
+0000ced0: 6172 6769 6e61 6c5f 6f66 5f70 6174 6368  arginal_of_patch
+0000cee0: 5f70 6572 6365 6e74 290a 2020 2020 2020  _percent).      
+0000cef0: 2020 2020 2020 2020 2020 7072 6564 6963            predic
+0000cf00: 7469 6f6e 5f72 6567 696f 6e73 3220 3d20  tion_regions2 = 
+0000cf10: 7265 7369 7a65 5f69 6d61 6765 2870 7265  resize_image(pre
+0000cf20: 6469 6374 696f 6e5f 7265 6769 6f6e 7332  diction_regions2
+0000cf30: 2c20 696d 675f 6865 6967 6874 5f68 2c20  , img_height_h, 
+0000cf40: 696d 675f 7769 6474 685f 6829 0a0a 2020  img_width_h)..  
+0000cf50: 2020 2020 2020 2020 2020 6966 2063 6f6c            if col
+0000cf60: 7320 3d3d 2032 3a0a 2020 2020 2020 2020  s == 2:.        
+0000cf70: 2020 2020 2020 2020 696d 6720 3d20 6f74          img = ot
+0000cf80: 7375 5f63 6f70 795f 6269 6e61 7279 2869  su_copy_binary(i
+0000cf90: 6d67 290a 2020 2020 2020 2020 2020 2020  mg).            
+0000cfa0: 2020 2020 696d 6720 3d20 696d 672e 6173      img = img.as
+0000cfb0: 7479 7065 286e 702e 7569 6e74 3829 0a20  type(np.uint8). 
+0000cfc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0000cfd0: 6620 696d 675f 7769 6474 685f 6820 3e3d  f img_width_h >=
+0000cfe0: 2032 3030 303a 0a20 2020 2020 2020 2020   2000:.         
+0000cff0: 2020 2020 2020 2020 2020 2069 6d67 203d             img =
+0000d000: 2072 6573 697a 655f 696d 6167 6528 696d   resize_image(im
+0000d010: 672c 2069 6e74 2869 6d67 5f68 6569 6768  g, int(img_heigh
+0000d020: 745f 6820 2a20 302e 3929 2c20 696e 7428  t_h * 0.9), int(
+0000d030: 696d 675f 7769 6474 685f 6820 2a20 302e  img_width_h * 0.
+0000d040: 3929 290a 2020 2020 2020 2020 2020 2020  9)).            
+0000d050: 2020 2020 696d 6720 3d20 696d 672e 6173      img = img.as
+0000d060: 7479 7065 286e 702e 7569 6e74 3829 0a0a  type(np.uint8)..
+0000d070: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+0000d080: 6f6c 7320 3d3d 2031 3a0a 2020 2020 2020  ols == 1:.      
+0000d090: 2020 2020 2020 2020 2020 696d 6720 3d20            img = 
+0000d0a0: 6f74 7375 5f63 6f70 795f 6269 6e61 7279  otsu_copy_binary
+0000d0b0: 2869 6d67 290a 2020 2020 2020 2020 2020  (img).          
+0000d0c0: 2020 2020 2020 696d 6720 3d20 696d 672e        img = img.
+0000d0d0: 6173 7479 7065 286e 702e 7569 6e74 3829  astype(np.uint8)
+0000d0e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d0f0: 2069 6d67 203d 2072 6573 697a 655f 696d   img = resize_im
+0000d100: 6167 6528 696d 672c 2069 6e74 2869 6d67  age(img, int(img
+0000d110: 5f68 6569 6768 745f 6820 2a20 302e 3529  _height_h * 0.5)
+0000d120: 2c20 696e 7428 696d 675f 7769 6474 685f  , int(img_width_
+0000d130: 6820 2a20 302e 3529 290a 2020 2020 2020  h * 0.5)).      
+0000d140: 2020 2020 2020 2020 2020 696d 6720 3d20            img = 
+0000d150: 696d 672e 6173 7479 7065 286e 702e 7569  img.astype(np.ui
+0000d160: 6e74 3829 0a0a 2020 2020 2020 2020 2020  nt8)..          
+0000d170: 2020 6966 2063 6f6c 7320 3d3d 2033 3a0a    if cols == 3:.
+0000d180: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d190: 6966 2028 7365 6c66 2e73 6361 6c65 5f78  if (self.scale_x
+0000d1a0: 203d 3d20 3120 616e 6420 696d 675f 7769   == 1 and img_wi
+0000d1b0: 6474 685f 6820 3e20 3330 3030 2920 6f72  dth_h > 3000) or
+0000d1c0: 2028 7365 6c66 2e73 6361 6c65 5f78 2021   (self.scale_x !
+0000d1d0: 3d20 3120 616e 6420 696d 675f 7769 6474  = 1 and img_widt
+0000d1e0: 685f 6820 3e20 3238 3030 293a 0a20 2020  h_h > 2800):.   
+0000d1f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d200: 2069 6d67 203d 206f 7473 755f 636f 7079   img = otsu_copy
+0000d210: 5f62 696e 6172 7928 696d 6729 0a20 2020  _binary(img).   
+0000d220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d230: 2069 6d67 203d 2069 6d67 2e61 7374 7970   img = img.astyp
+0000d240: 6528 6e70 2e75 696e 7438 290a 2020 2020  e(np.uint8).    
+0000d250: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d260: 696d 6720 3d20 7265 7369 7a65 5f69 6d61  img = resize_ima
+0000d270: 6765 2869 6d67 2c20 696e 7428 696d 675f  ge(img, int(img_
+0000d280: 6865 6967 6874 5f68 202a 2032 3830 3020  height_h * 2800 
+0000d290: 2f20 666c 6f61 7428 696d 675f 7769 6474  / float(img_widt
+0000d2a0: 685f 6829 292c 2032 3830 3029 0a20 2020  h_h)), 2800).   
+0000d2b0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0000d2c0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000d2d0: 2020 2020 2020 2069 6d67 203d 206f 7473         img = ots
+0000d2e0: 755f 636f 7079 5f62 696e 6172 7928 696d  u_copy_binary(im
+0000d2f0: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
+0000d300: 2020 2020 2020 2069 6d67 203d 2069 6d67         img = img
+0000d310: 2e61 7374 7970 6528 6e70 2e75 696e 7438  .astype(np.uint8
+0000d320: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0000d330: 6620 636f 6c73 203d 3d20 343a 0a20 2020  f cols == 4:.   
+0000d340: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0000d350: 2873 656c 662e 7363 616c 655f 7820 3d3d  (self.scale_x ==
+0000d360: 2031 2061 6e64 2069 6d67 5f77 6964 7468   1 and img_width
+0000d370: 5f68 203e 2034 3030 3029 206f 7220 2873  _h > 4000) or (s
+0000d380: 656c 662e 7363 616c 655f 7820 213d 2031  elf.scale_x != 1
+0000d390: 2061 6e64 2069 6d67 5f77 6964 7468 5f68   and img_width_h
+0000d3a0: 203e 2033 3730 3029 3a0a 2020 2020 2020   > 3700):.      
+0000d3b0: 2020 2020 2020 2020 2020 2020 2020 696d                im
+0000d3c0: 6720 3d20 6f74 7375 5f63 6f70 795f 6269  g = otsu_copy_bi
+0000d3d0: 6e61 7279 2869 6d67 290a 2020 2020 2020  nary(img).      
+0000d3e0: 2020 2020 2020 2020 2020 2020 2020 696d                im
+0000d3f0: 6720 3d20 696d 672e 6173 7479 7065 286e  g = img.astype(n
+0000d400: 702e 7569 6e74 3829 0a20 2020 2020 2020  p.uint8).       
+0000d410: 2020 2020 2020 2020 2020 2020 2069 6d67               img
+0000d420: 3d20 7265 7369 7a65 5f69 6d61 6765 2869  = resize_image(i
+0000d430: 6d67 2c20 696e 7428 696d 675f 6865 6967  mg, int(img_heig
+0000d440: 6874 5f68 202a 2033 3730 3020 2f20 666c  ht_h * 3700 / fl
+0000d450: 6f61 7428 696d 675f 7769 6474 685f 6829  oat(img_width_h)
+0000d460: 292c 2033 3730 3029 0a20 2020 2020 2020  ), 3700).       
+0000d470: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0000d480: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d490: 2020 2069 6d67 203d 206f 7473 755f 636f     img = otsu_co
+0000d4a0: 7079 5f62 696e 6172 7928 696d 6729 0a20  py_binary(img). 
+0000d4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d4c0: 2020 2069 6d67 203d 2069 6d67 2e61 7374     img = img.ast
+0000d4d0: 7970 6528 6e70 2e75 696e 7438 290a 2020  ype(np.uint8).  
+0000d4e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d4f0: 2020 696d 673d 2072 6573 697a 655f 696d    img= resize_im
+0000d500: 6167 6528 696d 672c 2069 6e74 2869 6d67  age(img, int(img
+0000d510: 5f68 6569 6768 745f 6820 2a20 302e 3929  _height_h * 0.9)
+0000d520: 2c20 696e 7428 696d 675f 7769 6474 685f  , int(img_width_
+0000d530: 6820 2a20 302e 3929 290a 0a20 2020 2020  h * 0.9))..     
+0000d540: 2020 2020 2020 2069 6620 636f 6c73 203d         if cols =
+0000d550: 3d20 353a 0a20 2020 2020 2020 2020 2020  = 5:.           
+0000d560: 2020 2020 2069 6620 7365 6c66 2e73 6361       if self.sca
+0000d570: 6c65 5f78 203d 3d20 3120 616e 6420 696d  le_x == 1 and im
+0000d580: 675f 7769 6474 685f 6820 3e20 3530 3030  g_width_h > 5000
+0000d590: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000d5a0: 2020 2020 2020 696d 6720 3d20 6f74 7375        img = otsu
+0000d5b0: 5f63 6f70 795f 6269 6e61 7279 2869 6d67  _copy_binary(img
+0000d5c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000d5d0: 2020 2020 2020 696d 6720 3d20 696d 672e        img = img.
+0000d5e0: 6173 7479 7065 286e 702e 7569 6e74 3829  astype(np.uint8)
+0000d5f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d600: 2020 2020 2069 6d67 3d20 7265 7369 7a65       img= resize
+0000d610: 5f69 6d61 6765 2869 6d67 2c20 696e 7428  _image(img, int(
+0000d620: 696d 675f 6865 6967 6874 5f68 202a 2030  img_height_h * 0
+0000d630: 2e37 292c 2069 6e74 2869 6d67 5f77 6964  .7), int(img_wid
+0000d640: 7468 5f68 202a 2030 2e37 2929 0a20 2020  th_h * 0.7)).   
+0000d650: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0000d660: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0000d670: 2020 2020 2020 2069 6d67 203d 206f 7473         img = ots
+0000d680: 755f 636f 7079 5f62 696e 6172 7928 696d  u_copy_binary(im
+0000d690: 6729 0a20 2020 2020 2020 2020 2020 2020  g).             
+0000d6a0: 2020 2020 2020 2069 6d67 203d 2069 6d67         img = img
+0000d6b0: 2e61 7374 7970 6528 6e70 2e75 696e 7438  .astype(np.uint8
+0000d6c0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000d6d0: 2020 2020 2020 696d 673d 2072 6573 697a        img= resiz
+0000d6e0: 655f 696d 6167 6528 696d 672c 2069 6e74  e_image(img, int
+0000d6f0: 2869 6d67 5f68 6569 6768 745f 6820 2a20  (img_height_h * 
+0000d700: 302e 3929 2c20 696e 7428 696d 675f 7769  0.9), int(img_wi
+0000d710: 6474 685f 6820 2a20 302e 3929 2029 0a0a  dth_h * 0.9) )..
+0000d720: 2020 2020 2020 2020 2020 2020 6966 2063              if c
+0000d730: 6f6c 7320 3e3d 2036 3a0a 2020 2020 2020  ols >= 6:.      
+0000d740: 2020 2020 2020 2020 2020 6966 2069 6d67            if img
+0000d750: 5f77 6964 7468 5f68 203e 2035 3630 303a  _width_h > 5600:
+0000d760: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d770: 2020 2020 2069 6d67 203d 206f 7473 755f       img = otsu_
+0000d780: 636f 7079 5f62 696e 6172 7928 696d 6729  copy_binary(img)
+0000d790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000d7a0: 2020 2020 2069 6d67 203d 2069 6d67 2e61       img = img.a
+0000d7b0: 7374 7970 6528 6e70 2e75 696e 7438 290a  stype(np.uint8).
+0000d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d7d0: 2020 2020 696d 673d 2072 6573 697a 655f      img= resize_
+0000d7e0: 696d 6167 6528 696d 672c 2069 6e74 2869  image(img, int(i
+0000d7f0: 6d67 5f68 6569 6768 745f 6820 2a20 3536  mg_height_h * 56
+0000d800: 3030 202f 2066 6c6f 6174 2869 6d67 5f77  00 / float(img_w
+0000d810: 6964 7468 5f68 2929 2c20 3536 3030 290a  idth_h)), 5600).
+0000d820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000d830: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+0000d840: 2020 2020 2020 2020 2020 696d 6720 3d20            img = 
+0000d850: 6f74 7375 5f63 6f70 795f 6269 6e61 7279  otsu_copy_binary
+0000d860: 2869 6d67 290a 2020 2020 2020 2020 2020  (img).          
+0000d870: 2020 2020 2020 2020 2020 696d 6720 3d20            img = 
+0000d880: 696d 672e 6173 7479 7065 286e 702e 7569  img.astype(np.ui
+0000d890: 6e74 3829 0a20 2020 2020 2020 2020 2020  nt8).           
+0000d8a0: 2020 2020 2020 2020 2069 6d67 3d20 7265           img= re
+0000d8b0: 7369 7a65 5f69 6d61 6765 2869 6d67 2c20  size_image(img, 
+0000d8c0: 696e 7428 696d 675f 6865 6967 6874 5f68  int(img_height_h
+0000d8d0: 202a 2030 2e39 292c 2069 6e74 2869 6d67   * 0.9), int(img
+0000d8e0: 5f77 6964 7468 5f68 202a 2030 2e39 2929  _width_h * 0.9))
+0000d8f0: 0a0a 2020 2020 2020 2020 6d61 7267 696e  ..        margin
+0000d900: 616c 5f6f 665f 7061 7463 685f 7065 7263  al_of_patch_perc
+0000d910: 656e 7420 3d20 302e 310a 2020 2020 2020  ent = 0.1.      
+0000d920: 2020 7072 6564 6963 7469 6f6e 5f72 6567    prediction_reg
+0000d930: 696f 6e73 203d 2073 656c 662e 646f 5f70  ions = self.do_p
+0000d940: 7265 6469 6374 696f 6e28 7061 7463 6865  rediction(patche
+0000d950: 732c 2069 6d67 2c20 6d6f 6465 6c5f 7265  s, img, model_re
+0000d960: 6769 6f6e 2c20 6d61 7267 696e 616c 5f6f  gion, marginal_o
+0000d970: 665f 7061 7463 685f 7065 7263 656e 7429  f_patch_percent)
+0000d980: 0a20 2020 2020 2020 2070 7265 6469 6374  .        predict
+0000d990: 696f 6e5f 7265 6769 6f6e 7320 3d20 7265  ion_regions = re
+0000d9a0: 7369 7a65 5f69 6d61 6765 2870 7265 6469  size_image(predi
+0000d9b0: 6374 696f 6e5f 7265 6769 6f6e 732c 2069  ction_regions, i
+0000d9c0: 6d67 5f68 6569 6768 745f 682c 2069 6d67  mg_height_h, img
+0000d9d0: 5f77 6964 7468 5f68 290a 2020 2020 2020  _width_h).      
+0000d9e0: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
+0000d9f0: 6275 6728 2265 7869 7420 6578 7472 6163  bug("exit extrac
+0000da00: 745f 7465 7874 5f72 6567 696f 6e73 2229  t_text_regions")
+0000da10: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+0000da20: 7072 6564 6963 7469 6f6e 5f72 6567 696f  prediction_regio
+0000da30: 6e73 2c20 7072 6564 6963 7469 6f6e 5f72  ns, prediction_r
+0000da40: 6567 696f 6e73 320a 2020 2020 0a20 2020  egions2.    .   
+0000da50: 2064 6566 2067 6574 5f73 6c6f 7065 735f   def get_slopes_
+0000da60: 616e 645f 6465 736b 6577 5f6e 6577 5f6c  and_deskew_new_l
+0000da70: 6967 6874 2873 656c 662c 2063 6f6e 746f  ight(self, conto
+0000da80: 7572 732c 2063 6f6e 746f 7572 735f 7061  urs, contours_pa
+0000da90: 722c 2074 6578 746c 696e 655f 6d61 736b  r, textline_mask
+0000daa0: 5f74 6f74 2c20 696d 6167 655f 7061 6765  _tot, image_page
+0000dab0: 5f72 6f74 6174 6564 2c20 626f 7865 732c  _rotated, boxes,
+0000dac0: 2073 6c6f 7065 5f64 6573 6b65 7729 3a0a   slope_deskew):.
+0000dad0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+0000dae0: 6765 722e 6465 6275 6728 2265 6e74 6572  ger.debug("enter
+0000daf0: 2067 6574 5f73 6c6f 7065 735f 616e 645f   get_slopes_and_
+0000db00: 6465 736b 6577 5f6e 6577 2229 0a20 2020  deskew_new").   
+0000db10: 2020 2020 206e 756d 5f63 6f72 6573 203d       num_cores =
+0000db20: 2063 7075 5f63 6f75 6e74 2829 0a20 2020   cpu_count().   
+0000db30: 2020 2020 2071 7565 7565 5f6f 665f 616c       queue_of_al
+0000db40: 6c5f 7061 7261 6d73 203d 2051 7565 7565  l_params = Queue
+0000db50: 2829 0a0a 2020 2020 2020 2020 7072 6f63  ()..        proc
+0000db60: 6573 7365 7320 3d20 5b5d 0a20 2020 2020  esses = [].     
+0000db70: 2020 206e 6820 3d20 6e70 2e6c 696e 7370     nh = np.linsp
+0000db80: 6163 6528 302c 206c 656e 2862 6f78 6573  ace(0, len(boxes
+0000db90: 292c 206e 756d 5f63 6f72 6573 202b 2031  ), num_cores + 1
+0000dba0: 290a 2020 2020 2020 2020 696e 6465 7865  ).        indexe
+0000dbb0: 735f 6279 5f74 6578 745f 636f 6e20 3d20  s_by_text_con = 
+0000dbc0: 6e70 2e61 7272 6179 2872 616e 6765 286c  np.array(range(l
+0000dbd0: 656e 2863 6f6e 746f 7572 735f 7061 7229  en(contours_par)
+0000dbe0: 2929 0a20 2020 2020 2020 2066 6f72 2069  )).        for i
+0000dbf0: 2069 6e20 7261 6e67 6528 6e75 6d5f 636f   in range(num_co
+0000dc00: 7265 7329 3a0a 2020 2020 2020 2020 2020  res):.          
+0000dc10: 2020 626f 7865 735f 7065 725f 7072 6f63    boxes_per_proc
+0000dc20: 6573 7320 3d20 626f 7865 735b 696e 7428  ess = boxes[int(
+0000dc30: 6e68 5b69 5d29 203a 2069 6e74 286e 685b  nh[i]) : int(nh[
+0000dc40: 6920 2b20 315d 295d 0a20 2020 2020 2020  i + 1])].       
+0000dc50: 2020 2020 2063 6f6e 746f 7572 735f 7065       contours_pe
+0000dc60: 725f 7072 6f63 6573 7320 3d20 636f 6e74  r_process = cont
+0000dc70: 6f75 7273 5b69 6e74 286e 685b 695d 2920  ours[int(nh[i]) 
+0000dc80: 3a20 696e 7428 6e68 5b69 202b 2031 5d29  : int(nh[i + 1])
+0000dc90: 5d0a 2020 2020 2020 2020 2020 2020 636f  ].            co
+0000dca0: 6e74 6f75 7273 5f70 6172 5f70 6572 5f70  ntours_par_per_p
+0000dcb0: 726f 6365 7373 203d 2063 6f6e 746f 7572  rocess = contour
+0000dcc0: 735f 7061 725b 696e 7428 6e68 5b69 5d29  s_par[int(nh[i])
+0000dcd0: 203a 2069 6e74 286e 685b 6920 2b20 315d   : int(nh[i + 1]
+0000dce0: 295d 0a20 2020 2020 2020 2020 2020 2069  )].            i
+0000dcf0: 6e64 6578 6573 5f74 6578 745f 636f 6e5f  ndexes_text_con_
+0000dd00: 7065 725f 7072 6f63 6573 7320 3d20 696e  per_process = in
+0000dd10: 6465 7865 735f 6279 5f74 6578 745f 636f  dexes_by_text_co
+0000dd20: 6e5b 696e 7428 6e68 5b69 5d29 203a 2069  n[int(nh[i]) : i
+0000dd30: 6e74 286e 685b 6920 2b20 315d 295d 0a0a  nt(nh[i + 1])]..
+0000dd40: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
+0000dd50: 6573 7365 732e 6170 7065 6e64 2850 726f  esses.append(Pro
+0000dd60: 6365 7373 2874 6172 6765 743d 7365 6c66  cess(target=self
+0000dd70: 2e64 6f5f 776f 726b 5f6f 665f 736c 6f70  .do_work_of_slop
+0000dd80: 6573 5f6e 6577 5f6c 6967 6874 2c20 6172  es_new_light, ar
+0000dd90: 6773 3d28 7175 6575 655f 6f66 5f61 6c6c  gs=(queue_of_all
+0000dda0: 5f70 6172 616d 732c 2062 6f78 6573 5f70  _params, boxes_p
+0000ddb0: 6572 5f70 726f 6365 7373 2c20 7465 7874  er_process, text
+0000ddc0: 6c69 6e65 5f6d 6173 6b5f 746f 742c 2063  line_mask_tot, c
+0000ddd0: 6f6e 746f 7572 735f 7065 725f 7072 6f63  ontours_per_proc
+0000dde0: 6573 732c 2063 6f6e 746f 7572 735f 7061  ess, contours_pa
+0000ddf0: 725f 7065 725f 7072 6f63 6573 732c 2069  r_per_process, i
+0000de00: 6e64 6578 6573 5f74 6578 745f 636f 6e5f  ndexes_text_con_
+0000de10: 7065 725f 7072 6f63 6573 732c 2069 6d61  per_process, ima
+0000de20: 6765 5f70 6167 655f 726f 7461 7465 642c  ge_page_rotated,
+0000de30: 2073 6c6f 7065 5f64 6573 6b65 7729 2929   slope_deskew)))
+0000de40: 0a20 2020 2020 2020 2066 6f72 2069 2069  .        for i i
+0000de50: 6e20 7261 6e67 6528 6e75 6d5f 636f 7265  n range(num_core
+0000de60: 7329 3a0a 2020 2020 2020 2020 2020 2020  s):.            
+0000de70: 7072 6f63 6573 7365 735b 695d 2e73 7461  processes[i].sta
+0000de80: 7274 2829 0a0a 2020 2020 2020 2020 736c  rt()..        sl
+0000de90: 6f70 6573 203d 205b 5d0a 2020 2020 2020  opes = [].      
+0000dea0: 2020 616c 6c5f 666f 756e 645f 7465 786c    all_found_texl
+0000deb0: 696e 655f 706f 6c79 676f 6e73 203d 205b  ine_polygons = [
+0000dec0: 5d0a 2020 2020 2020 2020 616c 6c5f 666f  ].        all_fo
+0000ded0: 756e 645f 7465 7874 5f72 6567 696f 6e73  und_text_regions
+0000dee0: 203d 205b 5d0a 2020 2020 2020 2020 616c   = [].        al
+0000def0: 6c5f 666f 756e 645f 7465 7874 5f72 6567  l_found_text_reg
+0000df00: 696f 6e73 5f70 6172 203d 205b 5d0a 2020  ions_par = [].  
+0000df10: 2020 2020 2020 626f 7865 7320 3d20 5b5d        boxes = []
+0000df20: 0a20 2020 2020 2020 2061 6c6c 5f62 6f78  .        all_box
+0000df30: 5f63 6f6f 7264 203d 205b 5d0a 2020 2020  _coord = [].    
+0000df40: 2020 2020 616c 6c5f 696e 6465 785f 7465      all_index_te
+0000df50: 7874 5f63 6f6e 203d 205b 5d0a 2020 2020  xt_con = [].    
+0000df60: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+0000df70: 6765 286e 756d 5f63 6f72 6573 293a 0a20  ge(num_cores):. 
+0000df80: 2020 2020 2020 2020 2020 206c 6973 745f             list_
+0000df90: 616c 6c5f 7061 7220 3d20 7175 6575 655f  all_par = queue_
+0000dfa0: 6f66 5f61 6c6c 5f70 6172 616d 732e 6765  of_all_params.ge
+0000dfb0: 7428 5472 7565 290a 2020 2020 2020 2020  t(True).        
+0000dfc0: 2020 2020 736c 6f70 6573 5f66 6f72 5f73      slopes_for_s
+0000dfd0: 7562 5f70 726f 6365 7373 203d 206c 6973  ub_process = lis
+0000dfe0: 745f 616c 6c5f 7061 725b 305d 0a20 2020  t_all_par[0].   
+0000dff0: 2020 2020 2020 2020 2070 6f6c 7973 5f66           polys_f
+0000e000: 6f72 5f73 7562 5f70 726f 6365 7373 203d  or_sub_process =
+0000e010: 206c 6973 745f 616c 6c5f 7061 725b 315d   list_all_par[1]
+0000e020: 0a20 2020 2020 2020 2020 2020 2062 6f78  .            box
+0000e030: 6573 5f66 6f72 5f73 7562 5f70 726f 6365  es_for_sub_proce
+0000e040: 7373 203d 206c 6973 745f 616c 6c5f 7061  ss = list_all_pa
+0000e050: 725b 325d 0a20 2020 2020 2020 2020 2020  r[2].           
+0000e060: 2063 6f6e 746f 7572 735f 666f 725f 7375   contours_for_su
+0000e070: 6270 726f 6365 7373 203d 206c 6973 745f  bprocess = list_
+0000e080: 616c 6c5f 7061 725b 335d 0a20 2020 2020  all_par[3].     
+0000e090: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
+0000e0a0: 7061 725f 666f 725f 7375 6270 726f 6365  par_for_subproce
+0000e0b0: 7373 203d 206c 6973 745f 616c 6c5f 7061  ss = list_all_pa
+0000e0c0: 725b 345d 0a20 2020 2020 2020 2020 2020  r[4].           
+0000e0d0: 2062 6f78 6573 5f63 6f6f 7264 5f66 6f72   boxes_coord_for
+0000e0e0: 5f73 7562 7072 6f63 6573 7320 3d20 6c69  _subprocess = li
+0000e0f0: 7374 5f61 6c6c 5f70 6172 5b35 5d0a 2020  st_all_par[5].  
+0000e100: 2020 2020 2020 2020 2020 696e 6465 7865            indexe
+0000e110: 735f 666f 725f 7375 6270 726f 6365 7373  s_for_subprocess
+0000e120: 203d 206c 6973 745f 616c 6c5f 7061 725b   = list_all_par[
+0000e130: 365d 0a20 2020 2020 2020 2020 2020 2066  6].            f
+0000e140: 6f72 206a 2069 6e20 7261 6e67 6528 6c65  or j in range(le
+0000e150: 6e28 736c 6f70 6573 5f66 6f72 5f73 7562  n(slopes_for_sub
+0000e160: 5f70 726f 6365 7373 2929 3a0a 2020 2020  _process)):.    
+0000e170: 2020 2020 2020 2020 2020 2020 736c 6f70              slop
+0000e180: 6573 2e61 7070 656e 6428 736c 6f70 6573  es.append(slopes
+0000e190: 5f66 6f72 5f73 7562 5f70 726f 6365 7373  _for_sub_process
+0000e1a0: 5b6a 5d29 0a20 2020 2020 2020 2020 2020  [j]).           
+0000e1b0: 2020 2020 2061 6c6c 5f66 6f75 6e64 5f74       all_found_t
+0000e1c0: 6578 6c69 6e65 5f70 6f6c 7967 6f6e 732e  exline_polygons.
+0000e1d0: 6170 7065 6e64 2870 6f6c 7973 5f66 6f72  append(polys_for
+0000e1e0: 5f73 7562 5f70 726f 6365 7373 5b6a 5d29  _sub_process[j])
+0000e1f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000e200: 2062 6f78 6573 2e61 7070 656e 6428 626f   boxes.append(bo
+0000e210: 7865 735f 666f 725f 7375 625f 7072 6f63  xes_for_sub_proc
+0000e220: 6573 735b 6a5d 290a 2020 2020 2020 2020  ess[j]).        
+0000e230: 2020 2020 2020 2020 616c 6c5f 666f 756e          all_foun
+0000e240: 645f 7465 7874 5f72 6567 696f 6e73 2e61  d_text_regions.a
+0000e250: 7070 656e 6428 636f 6e74 6f75 7273 5f66  ppend(contours_f
+0000e260: 6f72 5f73 7562 7072 6f63 6573 735b 6a5d  or_subprocess[j]
+0000e270: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0000e280: 2020 616c 6c5f 666f 756e 645f 7465 7874    all_found_text
+0000e290: 5f72 6567 696f 6e73 5f70 6172 2e61 7070  _regions_par.app
+0000e2a0: 656e 6428 636f 6e74 6f75 7273 5f70 6172  end(contours_par
+0000e2b0: 5f66 6f72 5f73 7562 7072 6f63 6573 735b  _for_subprocess[
+0000e2c0: 6a5d 290a 2020 2020 2020 2020 2020 2020  j]).            
+0000e2d0: 2020 2020 616c 6c5f 626f 785f 636f 6f72      all_box_coor
+0000e2e0: 642e 6170 7065 6e64 2862 6f78 6573 5f63  d.append(boxes_c
+0000e2f0: 6f6f 7264 5f66 6f72 5f73 7562 7072 6f63  oord_for_subproc
+0000e300: 6573 735b 6a5d 290a 2020 2020 2020 2020  ess[j]).        
+0000e310: 2020 2020 2020 2020 616c 6c5f 696e 6465          all_inde
+0000e320: 785f 7465 7874 5f63 6f6e 2e61 7070 656e  x_text_con.appen
+0000e330: 6428 696e 6465 7865 735f 666f 725f 7375  d(indexes_for_su
+0000e340: 6270 726f 6365 7373 5b6a 5d29 0a20 2020  bprocess[j]).   
+0000e350: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
+0000e360: 6e67 6528 6e75 6d5f 636f 7265 7329 3a0a  nge(num_cores):.
+0000e370: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
+0000e380: 6573 7365 735b 695d 2e6a 6f69 6e28 290a  esses[i].join().
+0000e390: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+0000e3a0: 6765 722e 6465 6275 6728 2773 6c6f 7065  ger.debug('slope
+0000e3b0: 7320 2573 272c 2073 6c6f 7065 7329 0a20  s %s', slopes). 
+0000e3c0: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
+0000e3d0: 6572 2e64 6562 7567 2822 6578 6974 2067  er.debug("exit g
+0000e3e0: 6574 5f73 6c6f 7065 735f 616e 645f 6465  et_slopes_and_de
+0000e3f0: 736b 6577 5f6e 6577 2229 0a20 2020 2020  skew_new").     
+0000e400: 2020 2072 6574 7572 6e20 736c 6f70 6573     return slopes
+0000e410: 2c20 616c 6c5f 666f 756e 645f 7465 786c  , all_found_texl
+0000e420: 696e 655f 706f 6c79 676f 6e73 2c20 626f  ine_polygons, bo
+0000e430: 7865 732c 2061 6c6c 5f66 6f75 6e64 5f74  xes, all_found_t
+0000e440: 6578 745f 7265 6769 6f6e 732c 2061 6c6c  ext_regions, all
+0000e450: 5f66 6f75 6e64 5f74 6578 745f 7265 6769  _found_text_regi
+0000e460: 6f6e 735f 7061 722c 2061 6c6c 5f62 6f78  ons_par, all_box
+0000e470: 5f63 6f6f 7264 2c20 616c 6c5f 696e 6465  _coord, all_inde
+0000e480: 785f 7465 7874 5f63 6f6e 0a0a 2020 2020  x_text_con..    
+0000e490: 6465 6620 6765 745f 736c 6f70 6573 5f61  def get_slopes_a
+0000e4a0: 6e64 5f64 6573 6b65 775f 6e65 7728 7365  nd_deskew_new(se
+0000e4b0: 6c66 2c20 636f 6e74 6f75 7273 2c20 636f  lf, contours, co
+0000e4c0: 6e74 6f75 7273 5f70 6172 2c20 7465 7874  ntours_par, text
+0000e4d0: 6c69 6e65 5f6d 6173 6b5f 746f 742c 2069  line_mask_tot, i
+0000e4e0: 6d61 6765 5f70 6167 655f 726f 7461 7465  mage_page_rotate
+0000e4f0: 642c 2062 6f78 6573 2c20 736c 6f70 655f  d, boxes, slope_
+0000e500: 6465 736b 6577 293a 0a20 2020 2020 2020  deskew):.       
+0000e510: 2073 656c 662e 6c6f 6767 6572 2e64 6562   self.logger.deb
+0000e520: 7567 2822 656e 7465 7220 6765 745f 736c  ug("enter get_sl
+0000e530: 6f70 6573 5f61 6e64 5f64 6573 6b65 775f  opes_and_deskew_
+0000e540: 6e65 7722 290a 2020 2020 2020 2020 6e75  new").        nu
+0000e550: 6d5f 636f 7265 7320 3d20 6370 755f 636f  m_cores = cpu_co
+0000e560: 756e 7428 290a 2020 2020 2020 2020 7175  unt().        qu
+0000e570: 6575 655f 6f66 5f61 6c6c 5f70 6172 616d  eue_of_all_param
+0000e580: 7320 3d20 5175 6575 6528 290a 0a20 2020  s = Queue()..   
+0000e590: 2020 2020 2070 726f 6365 7373 6573 203d       processes =
+0000e5a0: 205b 5d0a 2020 2020 2020 2020 6e68 203d   [].        nh =
+0000e5b0: 206e 702e 6c69 6e73 7061 6365 2830 2c20   np.linspace(0, 
+0000e5c0: 6c65 6e28 626f 7865 7329 2c20 6e75 6d5f  len(boxes), num_
+0000e5d0: 636f 7265 7320 2b20 3129 0a20 2020 2020  cores + 1).     
+0000e5e0: 2020 2069 6e64 6578 6573 5f62 795f 7465     indexes_by_te
+0000e5f0: 7874 5f63 6f6e 203d 206e 702e 6172 7261  xt_con = np.arra
+0000e600: 7928 7261 6e67 6528 6c65 6e28 636f 6e74  y(range(len(cont
+0000e610: 6f75 7273 5f70 6172 2929 290a 2020 2020  ours_par))).    
+0000e620: 2020 2020 666f 7220 6920 696e 2072 616e      for i in ran
+0000e630: 6765 286e 756d 5f63 6f72 6573 293a 0a20  ge(num_cores):. 
+0000e640: 2020 2020 2020 2020 2020 2062 6f78 6573             boxes
+0000e650: 5f70 6572 5f70 726f 6365 7373 203d 2062  _per_process = b
+0000e660: 6f78 6573 5b69 6e74 286e 685b 695d 2920  oxes[int(nh[i]) 
+0000e670: 3a20 696e 7428 6e68 5b69 202b 2031 5d29  : int(nh[i + 1])
+0000e680: 5d0a 2020 2020 2020 2020 2020 2020 636f  ].            co
+0000e690: 6e74 6f75 7273 5f70 6572 5f70 726f 6365  ntours_per_proce
+0000e6a0: 7373 203d 2063 6f6e 746f 7572 735b 696e  ss = contours[in
+0000e6b0: 7428 6e68 5b69 5d29 203a 2069 6e74 286e  t(nh[i]) : int(n
+0000e6c0: 685b 6920 2b20 315d 295d 0a20 2020 2020  h[i + 1])].     
+0000e6d0: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
+0000e6e0: 7061 725f 7065 725f 7072 6f63 6573 7320  par_per_process 
+0000e6f0: 3d20 636f 6e74 6f75 7273 5f70 6172 5b69  = contours_par[i
+0000e700: 6e74 286e 685b 695d 2920 3a20 696e 7428  nt(nh[i]) : int(
+0000e710: 6e68 5b69 202b 2031 5d29 5d0a 2020 2020  nh[i + 1])].    
+0000e720: 2020 2020 2020 2020 696e 6465 7865 735f          indexes_
+0000e730: 7465 7874 5f63 6f6e 5f70 6572 5f70 726f  text_con_per_pro
+0000e740: 6365 7373 203d 2069 6e64 6578 6573 5f62  cess = indexes_b
+0000e750: 795f 7465 7874 5f63 6f6e 5b69 6e74 286e  y_text_con[int(n
+0000e760: 685b 695d 2920 3a20 696e 7428 6e68 5b69  h[i]) : int(nh[i
+0000e770: 202b 2031 5d29 5d0a 0a20 2020 2020 2020   + 1])]..       
+0000e780: 2020 2020 2070 726f 6365 7373 6573 2e61       processes.a
+0000e790: 7070 656e 6428 5072 6f63 6573 7328 7461  ppend(Process(ta
+0000e7a0: 7267 6574 3d73 656c 662e 646f 5f77 6f72  rget=self.do_wor
+0000e7b0: 6b5f 6f66 5f73 6c6f 7065 735f 6e65 772c  k_of_slopes_new,
+0000e7c0: 2061 7267 733d 2871 7565 7565 5f6f 665f   args=(queue_of_
+0000e7d0: 616c 6c5f 7061 7261 6d73 2c20 626f 7865  all_params, boxe
+0000e7e0: 735f 7065 725f 7072 6f63 6573 732c 2074  s_per_process, t
+0000e7f0: 6578 746c 696e 655f 6d61 736b 5f74 6f74  extline_mask_tot
+0000e800: 2c20 636f 6e74 6f75 7273 5f70 6572 5f70  , contours_per_p
+0000e810: 726f 6365 7373 2c20 636f 6e74 6f75 7273  rocess, contours
+0000e820: 5f70 6172 5f70 6572 5f70 726f 6365 7373  _par_per_process
+0000e830: 2c20 696e 6465 7865 735f 7465 7874 5f63  , indexes_text_c
+0000e840: 6f6e 5f70 6572 5f70 726f 6365 7373 2c20  on_per_process, 
+0000e850: 696d 6167 655f 7061 6765 5f72 6f74 6174  image_page_rotat
+0000e860: 6564 2c20 736c 6f70 655f 6465 736b 6577  ed, slope_deskew
+0000e870: 2929 290a 2020 2020 2020 2020 666f 7220  ))).        for 
+0000e880: 6920 696e 2072 616e 6765 286e 756d 5f63  i in range(num_c
+0000e890: 6f72 6573 293a 0a20 2020 2020 2020 2020  ores):.         
+0000e8a0: 2020 2070 726f 6365 7373 6573 5b69 5d2e     processes[i].
+0000e8b0: 7374 6172 7428 290a 0a20 2020 2020 2020  start()..       
+0000e8c0: 2073 6c6f 7065 7320 3d20 5b5d 0a20 2020   slopes = [].   
+0000e8d0: 2020 2020 2061 6c6c 5f66 6f75 6e64 5f74       all_found_t
+0000e8e0: 6578 6c69 6e65 5f70 6f6c 7967 6f6e 7320  exline_polygons 
+0000e8f0: 3d20 5b5d 0a20 2020 2020 2020 2061 6c6c  = [].        all
+0000e900: 5f66 6f75 6e64 5f74 6578 745f 7265 6769  _found_text_regi
+0000e910: 6f6e 7320 3d20 5b5d 0a20 2020 2020 2020  ons = [].       
+0000e920: 2061 6c6c 5f66 6f75 6e64 5f74 6578 745f   all_found_text_
+0000e930: 7265 6769 6f6e 735f 7061 7220 3d20 5b5d  regions_par = []
+0000e940: 0a20 2020 2020 2020 2062 6f78 6573 203d  .        boxes =
+0000e950: 205b 5d0a 2020 2020 2020 2020 616c 6c5f   [].        all_
+0000e960: 626f 785f 636f 6f72 6420 3d20 5b5d 0a20  box_coord = []. 
+0000e970: 2020 2020 2020 2061 6c6c 5f69 6e64 6578         all_index
+0000e980: 5f74 6578 745f 636f 6e20 3d20 5b5d 0a20  _text_con = []. 
+0000e990: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+0000e9a0: 7261 6e67 6528 6e75 6d5f 636f 7265 7329  range(num_cores)
+0000e9b0: 3a0a 2020 2020 2020 2020 2020 2020 6c69  :.            li
+0000e9c0: 7374 5f61 6c6c 5f70 6172 203d 2071 7565  st_all_par = que
+0000e9d0: 7565 5f6f 665f 616c 6c5f 7061 7261 6d73  ue_of_all_params
+0000e9e0: 2e67 6574 2854 7275 6529 0a20 2020 2020  .get(True).     
+0000e9f0: 2020 2020 2020 2073 6c6f 7065 735f 666f         slopes_fo
+0000ea00: 725f 7375 625f 7072 6f63 6573 7320 3d20  r_sub_process = 
+0000ea10: 6c69 7374 5f61 6c6c 5f70 6172 5b30 5d0a  list_all_par[0].
+0000ea20: 2020 2020 2020 2020 2020 2020 706f 6c79              poly
+0000ea30: 735f 666f 725f 7375 625f 7072 6f63 6573  s_for_sub_proces
+0000ea40: 7320 3d20 6c69 7374 5f61 6c6c 5f70 6172  s = list_all_par
+0000ea50: 5b31 5d0a 2020 2020 2020 2020 2020 2020  [1].            
+0000ea60: 626f 7865 735f 666f 725f 7375 625f 7072  boxes_for_sub_pr
+0000ea70: 6f63 6573 7320 3d20 6c69 7374 5f61 6c6c  ocess = list_all
+0000ea80: 5f70 6172 5b32 5d0a 2020 2020 2020 2020  _par[2].        
+0000ea90: 2020 2020 636f 6e74 6f75 7273 5f66 6f72      contours_for
+0000eaa0: 5f73 7562 7072 6f63 6573 7320 3d20 6c69  _subprocess = li
+0000eab0: 7374 5f61 6c6c 5f70 6172 5b33 5d0a 2020  st_all_par[3].  
+0000eac0: 2020 2020 2020 2020 2020 636f 6e74 6f75            contou
+0000ead0: 7273 5f70 6172 5f66 6f72 5f73 7562 7072  rs_par_for_subpr
+0000eae0: 6f63 6573 7320 3d20 6c69 7374 5f61 6c6c  ocess = list_all
+0000eaf0: 5f70 6172 5b34 5d0a 2020 2020 2020 2020  _par[4].        
+0000eb00: 2020 2020 626f 7865 735f 636f 6f72 645f      boxes_coord_
+0000eb10: 666f 725f 7375 6270 726f 6365 7373 203d  for_subprocess =
+0000eb20: 206c 6973 745f 616c 6c5f 7061 725b 355d   list_all_par[5]
+0000eb30: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
+0000eb40: 6578 6573 5f66 6f72 5f73 7562 7072 6f63  exes_for_subproc
+0000eb50: 6573 7320 3d20 6c69 7374 5f61 6c6c 5f70  ess = list_all_p
+0000eb60: 6172 5b36 5d0a 2020 2020 2020 2020 2020  ar[6].          
+0000eb70: 2020 666f 7220 6a20 696e 2072 616e 6765    for j in range
+0000eb80: 286c 656e 2873 6c6f 7065 735f 666f 725f  (len(slopes_for_
+0000eb90: 7375 625f 7072 6f63 6573 7329 293a 0a20  sub_process)):. 
+0000eba0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+0000ebb0: 6c6f 7065 732e 6170 7065 6e64 2873 6c6f  lopes.append(slo
+0000ebc0: 7065 735f 666f 725f 7375 625f 7072 6f63  pes_for_sub_proc
+0000ebd0: 6573 735b 6a5d 290a 2020 2020 2020 2020  ess[j]).        
+0000ebe0: 2020 2020 2020 2020 616c 6c5f 666f 756e          all_foun
+0000ebf0: 645f 7465 786c 696e 655f 706f 6c79 676f  d_texline_polygo
+0000ec00: 6e73 2e61 7070 656e 6428 706f 6c79 735f  ns.append(polys_
+0000ec10: 666f 725f 7375 625f 7072 6f63 6573 735b  for_sub_process[
+0000ec20: 6a5d 290a 2020 2020 2020 2020 2020 2020  j]).            
+0000ec30: 2020 2020 626f 7865 732e 6170 7065 6e64      boxes.append
+0000ec40: 2862 6f78 6573 5f66 6f72 5f73 7562 5f70  (boxes_for_sub_p
+0000ec50: 726f 6365 7373 5b6a 5d29 0a20 2020 2020  rocess[j]).     
+0000ec60: 2020 2020 2020 2020 2020 2061 6c6c 5f66             all_f
+0000ec70: 6f75 6e64 5f74 6578 745f 7265 6769 6f6e  ound_text_region
+0000ec80: 732e 6170 7065 6e64 2863 6f6e 746f 7572  s.append(contour
+0000ec90: 735f 666f 725f 7375 6270 726f 6365 7373  s_for_subprocess
+0000eca0: 5b6a 5d29 0a20 2020 2020 2020 2020 2020  [j]).           
+0000ecb0: 2020 2020 2061 6c6c 5f66 6f75 6e64 5f74       all_found_t
+0000ecc0: 6578 745f 7265 6769 6f6e 735f 7061 722e  ext_regions_par.
+0000ecd0: 6170 7065 6e64 2863 6f6e 746f 7572 735f  append(contours_
+0000ece0: 7061 725f 666f 725f 7375 6270 726f 6365  par_for_subproce
+0000ecf0: 7373 5b6a 5d29 0a20 2020 2020 2020 2020  ss[j]).         
+0000ed00: 2020 2020 2020 2061 6c6c 5f62 6f78 5f63         all_box_c
+0000ed10: 6f6f 7264 2e61 7070 656e 6428 626f 7865  oord.append(boxe
+0000ed20: 735f 636f 6f72 645f 666f 725f 7375 6270  s_coord_for_subp
+0000ed30: 726f 6365 7373 5b6a 5d29 0a20 2020 2020  rocess[j]).     
+0000ed40: 2020 2020 2020 2020 2020 2061 6c6c 5f69             all_i
+0000ed50: 6e64 6578 5f74 6578 745f 636f 6e2e 6170  ndex_text_con.ap
+0000ed60: 7065 6e64 2869 6e64 6578 6573 5f66 6f72  pend(indexes_for
+0000ed70: 5f73 7562 7072 6f63 6573 735b 6a5d 290a  _subprocess[j]).
+0000ed80: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+0000ed90: 2072 616e 6765 286e 756d 5f63 6f72 6573   range(num_cores
+0000eda0: 293a 0a20 2020 2020 2020 2020 2020 2070  ):.            p
+0000edb0: 726f 6365 7373 6573 5b69 5d2e 6a6f 696e  rocesses[i].join
+0000edc0: 2829 0a20 2020 2020 2020 2073 656c 662e  ().        self.
+0000edd0: 6c6f 6767 6572 2e64 6562 7567 2827 736c  logger.debug('sl
+0000ede0: 6f70 6573 2025 7327 2c20 736c 6f70 6573  opes %s', slopes
+0000edf0: 290a 2020 2020 2020 2020 7365 6c66 2e6c  ).        self.l
+0000ee00: 6f67 6765 722e 6465 6275 6728 2265 7869  ogger.debug("exi
+0000ee10: 7420 6765 745f 736c 6f70 6573 5f61 6e64  t get_slopes_and
+0000ee20: 5f64 6573 6b65 775f 6e65 7722 290a 2020  _deskew_new").  
+0000ee30: 2020 2020 2020 7265 7475 726e 2073 6c6f        return slo
+0000ee40: 7065 732c 2061 6c6c 5f66 6f75 6e64 5f74  pes, all_found_t
+0000ee50: 6578 6c69 6e65 5f70 6f6c 7967 6f6e 732c  exline_polygons,
+0000ee60: 2062 6f78 6573 2c20 616c 6c5f 666f 756e   boxes, all_foun
+0000ee70: 645f 7465 7874 5f72 6567 696f 6e73 2c20  d_text_regions, 
+0000ee80: 616c 6c5f 666f 756e 645f 7465 7874 5f72  all_found_text_r
+0000ee90: 6567 696f 6e73 5f70 6172 2c20 616c 6c5f  egions_par, all_
+0000eea0: 626f 785f 636f 6f72 642c 2061 6c6c 5f69  box_coord, all_i
+0000eeb0: 6e64 6578 5f74 6578 745f 636f 6e0a 0a20  ndex_text_con.. 
+0000eec0: 2020 2064 6566 2067 6574 5f73 6c6f 7065     def get_slope
+0000eed0: 735f 616e 645f 6465 736b 6577 5f6e 6577  s_and_deskew_new
+0000eee0: 5f63 7572 7665 6428 7365 6c66 2c20 636f  _curved(self, co
+0000eef0: 6e74 6f75 7273 2c20 636f 6e74 6f75 7273  ntours, contours
+0000ef00: 5f70 6172 2c20 7465 7874 6c69 6e65 5f6d  _par, textline_m
+0000ef10: 6173 6b5f 746f 742c 2069 6d61 6765 5f70  ask_tot, image_p
+0000ef20: 6167 655f 726f 7461 7465 642c 2062 6f78  age_rotated, box
+0000ef30: 6573 2c20 6d61 736b 5f74 6578 7473 5f6f  es, mask_texts_o
+0000ef40: 6e6c 792c 206e 756d 5f63 6f6c 2c20 7363  nly, num_col, sc
+0000ef50: 616c 655f 7061 722c 2073 6c6f 7065 5f64  ale_par, slope_d
+0000ef60: 6573 6b65 7729 3a0a 2020 2020 2020 2020  eskew):.        
+0000ef70: 7365 6c66 2e6c 6f67 6765 722e 6465 6275  self.logger.debu
+0000ef80: 6728 2265 6e74 6572 2067 6574 5f73 6c6f  g("enter get_slo
+0000ef90: 7065 735f 616e 645f 6465 736b 6577 5f6e  pes_and_deskew_n
+0000efa0: 6577 5f63 7572 7665 6422 290a 2020 2020  ew_curved").    
+0000efb0: 2020 2020 6e75 6d5f 636f 7265 7320 3d20      num_cores = 
+0000efc0: 6370 755f 636f 756e 7428 290a 2020 2020  cpu_count().    
+0000efd0: 2020 2020 7175 6575 655f 6f66 5f61 6c6c      queue_of_all
+0000efe0: 5f70 6172 616d 7320 3d20 5175 6575 6528  _params = Queue(
+0000eff0: 290a 0a20 2020 2020 2020 2070 726f 6365  )..        proce
+0000f000: 7373 6573 203d 205b 5d0a 2020 2020 2020  sses = [].      
+0000f010: 2020 6e68 203d 206e 702e 6c69 6e73 7061    nh = np.linspa
+0000f020: 6365 2830 2c20 6c65 6e28 626f 7865 7329  ce(0, len(boxes)
+0000f030: 2c20 6e75 6d5f 636f 7265 7320 2b20 3129  , num_cores + 1)
+0000f040: 0a20 2020 2020 2020 2069 6e64 6578 6573  .        indexes
+0000f050: 5f62 795f 7465 7874 5f63 6f6e 203d 206e  _by_text_con = n
+0000f060: 702e 6172 7261 7928 7261 6e67 6528 6c65  p.array(range(le
+0000f070: 6e28 636f 6e74 6f75 7273 5f70 6172 2929  n(contours_par))
+0000f080: 290a 0a20 2020 2020 2020 2066 6f72 2069  )..        for i
+0000f090: 2069 6e20 7261 6e67 6528 6e75 6d5f 636f   in range(num_co
+0000f0a0: 7265 7329 3a0a 2020 2020 2020 2020 2020  res):.          
+0000f0b0: 2020 626f 7865 735f 7065 725f 7072 6f63    boxes_per_proc
+0000f0c0: 6573 7320 3d20 626f 7865 735b 696e 7428  ess = boxes[int(
+0000f0d0: 6e68 5b69 5d29 203a 2069 6e74 286e 685b  nh[i]) : int(nh[
+0000f0e0: 6920 2b20 315d 295d 0a20 2020 2020 2020  i + 1])].       
+0000f0f0: 2020 2020 2063 6f6e 746f 7572 735f 7065       contours_pe
+0000f100: 725f 7072 6f63 6573 7320 3d20 636f 6e74  r_process = cont
+0000f110: 6f75 7273 5b69 6e74 286e 685b 695d 2920  ours[int(nh[i]) 
+0000f120: 3a20 696e 7428 6e68 5b69 202b 2031 5d29  : int(nh[i + 1])
+0000f130: 5d0a 2020 2020 2020 2020 2020 2020 636f  ].            co
+0000f140: 6e74 6f75 7273 5f70 6172 5f70 6572 5f70  ntours_par_per_p
+0000f150: 726f 6365 7373 203d 2063 6f6e 746f 7572  rocess = contour
+0000f160: 735f 7061 725b 696e 7428 6e68 5b69 5d29  s_par[int(nh[i])
+0000f170: 203a 2069 6e74 286e 685b 6920 2b20 315d   : int(nh[i + 1]
+0000f180: 295d 0a20 2020 2020 2020 2020 2020 2069  )].            i
+0000f190: 6e64 6578 6573 5f74 6578 745f 636f 6e5f  ndexes_text_con_
+0000f1a0: 7065 725f 7072 6f63 6573 7320 3d20 696e  per_process = in
+0000f1b0: 6465 7865 735f 6279 5f74 6578 745f 636f  dexes_by_text_co
+0000f1c0: 6e5b 696e 7428 6e68 5b69 5d29 203a 2069  n[int(nh[i]) : i
+0000f1d0: 6e74 286e 685b 6920 2b20 315d 295d 0a0a  nt(nh[i + 1])]..
+0000f1e0: 2020 2020 2020 2020 2020 2020 7072 6f63              proc
+0000f1f0: 6573 7365 732e 6170 7065 6e64 2850 726f  esses.append(Pro
+0000f200: 6365 7373 2874 6172 6765 743d 7365 6c66  cess(target=self
+0000f210: 2e64 6f5f 776f 726b 5f6f 665f 736c 6f70  .do_work_of_slop
+0000f220: 6573 5f6e 6577 5f63 7572 7665 642c 2061  es_new_curved, a
+0000f230: 7267 733d 2871 7565 7565 5f6f 665f 616c  rgs=(queue_of_al
+0000f240: 6c5f 7061 7261 6d73 2c20 626f 7865 735f  l_params, boxes_
+0000f250: 7065 725f 7072 6f63 6573 732c 2074 6578  per_process, tex
+0000f260: 746c 696e 655f 6d61 736b 5f74 6f74 2c20  tline_mask_tot, 
+0000f270: 636f 6e74 6f75 7273 5f70 6572 5f70 726f  contours_per_pro
+0000f280: 6365 7373 2c20 636f 6e74 6f75 7273 5f70  cess, contours_p
+0000f290: 6172 5f70 6572 5f70 726f 6365 7373 2c20  ar_per_process, 
+0000f2a0: 696d 6167 655f 7061 6765 5f72 6f74 6174  image_page_rotat
+0000f2b0: 6564 2c20 6d61 736b 5f74 6578 7473 5f6f  ed, mask_texts_o
+0000f2c0: 6e6c 792c 206e 756d 5f63 6f6c 2c20 7363  nly, num_col, sc
+0000f2d0: 616c 655f 7061 722c 2069 6e64 6578 6573  ale_par, indexes
+0000f2e0: 5f74 6578 745f 636f 6e5f 7065 725f 7072  _text_con_per_pr
+0000f2f0: 6f63 6573 732c 2073 6c6f 7065 5f64 6573  ocess, slope_des
+0000f300: 6b65 7729 2929 0a0a 2020 2020 2020 2020  kew)))..        
+0000f310: 666f 7220 6920 696e 2072 616e 6765 286e  for i in range(n
+0000f320: 756d 5f63 6f72 6573 293a 0a20 2020 2020  um_cores):.     
+0000f330: 2020 2020 2020 2070 726f 6365 7373 6573         processes
+0000f340: 5b69 5d2e 7374 6172 7428 290a 0a20 2020  [i].start()..   
+0000f350: 2020 2020 2073 6c6f 7065 7320 3d20 5b5d       slopes = []
+0000f360: 0a20 2020 2020 2020 2061 6c6c 5f66 6f75  .        all_fou
+0000f370: 6e64 5f74 6578 6c69 6e65 5f70 6f6c 7967  nd_texline_polyg
+0000f380: 6f6e 7320 3d20 5b5d 0a20 2020 2020 2020  ons = [].       
+0000f390: 2061 6c6c 5f66 6f75 6e64 5f74 6578 745f   all_found_text_
+0000f3a0: 7265 6769 6f6e 7320 3d20 5b5d 0a20 2020  regions = [].   
+0000f3b0: 2020 2020 2061 6c6c 5f66 6f75 6e64 5f74       all_found_t
+0000f3c0: 6578 745f 7265 6769 6f6e 735f 7061 7220  ext_regions_par 
+0000f3d0: 3d20 5b5d 0a20 2020 2020 2020 2062 6f78  = [].        box
+0000f3e0: 6573 203d 205b 5d0a 2020 2020 2020 2020  es = [].        
+0000f3f0: 616c 6c5f 626f 785f 636f 6f72 6420 3d20  all_box_coord = 
+0000f400: 5b5d 0a20 2020 2020 2020 2061 6c6c 5f69  [].        all_i
+0000f410: 6e64 6578 5f74 6578 745f 636f 6e20 3d20  ndex_text_con = 
+0000f420: 5b5d 0a0a 2020 2020 2020 2020 666f 7220  []..        for 
+0000f430: 6920 696e 2072 616e 6765 286e 756d 5f63  i in range(num_c
+0000f440: 6f72 6573 293a 0a20 2020 2020 2020 2020  ores):.         
+0000f450: 2020 206c 6973 745f 616c 6c5f 7061 7220     list_all_par 
+0000f460: 3d20 7175 6575 655f 6f66 5f61 6c6c 5f70  = queue_of_all_p
+0000f470: 6172 616d 732e 6765 7428 5472 7565 290a  arams.get(True).
+0000f480: 2020 2020 2020 2020 2020 2020 706f 6c79              poly
+0000f490: 735f 666f 725f 7375 625f 7072 6f63 6573  s_for_sub_proces
+0000f4a0: 7320 3d20 6c69 7374 5f61 6c6c 5f70 6172  s = list_all_par
+0000f4b0: 5b30 5d0a 2020 2020 2020 2020 2020 2020  [0].            
+0000f4c0: 626f 7865 735f 666f 725f 7375 625f 7072  boxes_for_sub_pr
+0000f4d0: 6f63 6573 7320 3d20 6c69 7374 5f61 6c6c  ocess = list_all
+0000f4e0: 5f70 6172 5b31 5d0a 2020 2020 2020 2020  _par[1].        
+0000f4f0: 2020 2020 636f 6e74 6f75 7273 5f66 6f72      contours_for
+0000f500: 5f73 7562 7072 6f63 6573 7320 3d20 6c69  _subprocess = li
+0000f510: 7374 5f61 6c6c 5f70 6172 5b32 5d0a 2020  st_all_par[2].  
+0000f520: 2020 2020 2020 2020 2020 636f 6e74 6f75            contou
+0000f530: 7273 5f70 6172 5f66 6f72 5f73 7562 7072  rs_par_for_subpr
+0000f540: 6f63 6573 7320 3d20 6c69 7374 5f61 6c6c  ocess = list_all
+0000f550: 5f70 6172 5b33 5d0a 2020 2020 2020 2020  _par[3].        
+0000f560: 2020 2020 626f 7865 735f 636f 6f72 645f      boxes_coord_
+0000f570: 666f 725f 7375 6270 726f 6365 7373 203d  for_subprocess =
+0000f580: 206c 6973 745f 616c 6c5f 7061 725b 345d   list_all_par[4]
+0000f590: 0a20 2020 2020 2020 2020 2020 2069 6e64  .            ind
+0000f5a0: 6578 6573 5f66 6f72 5f73 7562 7072 6f63  exes_for_subproc
+0000f5b0: 6573 7320 3d20 6c69 7374 5f61 6c6c 5f70  ess = list_all_p
+0000f5c0: 6172 5b35 5d0a 2020 2020 2020 2020 2020  ar[5].          
+0000f5d0: 2020 736c 6f70 6573 5f66 6f72 5f73 7562    slopes_for_sub
+0000f5e0: 5f70 726f 6365 7373 203d 206c 6973 745f  _process = list_
+0000f5f0: 616c 6c5f 7061 725b 365d 0a20 2020 2020  all_par[6].     
+0000f600: 2020 2020 2020 2066 6f72 206a 2069 6e20         for j in 
+0000f610: 7261 6e67 6528 6c65 6e28 706f 6c79 735f  range(len(polys_
+0000f620: 666f 725f 7375 625f 7072 6f63 6573 7329  for_sub_process)
+0000f630: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0000f640: 2020 2073 6c6f 7065 732e 6170 7065 6e64     slopes.append
+0000f650: 2873 6c6f 7065 735f 666f 725f 7375 625f  (slopes_for_sub_
+0000f660: 7072 6f63 6573 735b 6a5d 290a 2020 2020  process[j]).    
+0000f670: 2020 2020 2020 2020 2020 2020 616c 6c5f              all_
+0000f680: 666f 756e 645f 7465 786c 696e 655f 706f  found_texline_po
+0000f690: 6c79 676f 6e73 2e61 7070 656e 6428 706f  lygons.append(po
+0000f6a0: 6c79 735f 666f 725f 7375 625f 7072 6f63  lys_for_sub_proc
+0000f6b0: 6573 735b 6a5d 5b3a 3a2d 315d 290a 2020  ess[j][::-1]).  
+0000f6c0: 2020 2020 2020 2020 2020 2020 2020 626f                bo
+0000f6d0: 7865 732e 6170 7065 6e64 2862 6f78 6573  xes.append(boxes
+0000f6e0: 5f66 6f72 5f73 7562 5f70 726f 6365 7373  _for_sub_process
+0000f6f0: 5b6a 5d29 0a20 2020 2020 2020 2020 2020  [j]).           
+0000f700: 2020 2020 2061 6c6c 5f66 6f75 6e64 5f74       all_found_t
+0000f710: 6578 745f 7265 6769 6f6e 732e 6170 7065  ext_regions.appe
+0000f720: 6e64 2863 6f6e 746f 7572 735f 666f 725f  nd(contours_for_
+0000f730: 7375 6270 726f 6365 7373 5b6a 5d29 0a20  subprocess[j]). 
+0000f740: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0000f750: 6c6c 5f66 6f75 6e64 5f74 6578 745f 7265  ll_found_text_re
+0000f760: 6769 6f6e 735f 7061 722e 6170 7065 6e64  gions_par.append
+0000f770: 2863 6f6e 746f 7572 735f 7061 725f 666f  (contours_par_fo
+0000f780: 725f 7375 6270 726f 6365 7373 5b6a 5d29  r_subprocess[j])
+0000f790: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0000f7a0: 2061 6c6c 5f62 6f78 5f63 6f6f 7264 2e61   all_box_coord.a
+0000f7b0: 7070 656e 6428 626f 7865 735f 636f 6f72  ppend(boxes_coor
+0000f7c0: 645f 666f 725f 7375 6270 726f 6365 7373  d_for_subprocess
+0000f7d0: 5b6a 5d29 0a20 2020 2020 2020 2020 2020  [j]).           
+0000f7e0: 2020 2020 2061 6c6c 5f69 6e64 6578 5f74       all_index_t
+0000f7f0: 6578 745f 636f 6e2e 6170 7065 6e64 2869  ext_con.append(i
+0000f800: 6e64 6578 6573 5f66 6f72 5f73 7562 7072  ndexes_for_subpr
+0000f810: 6f63 6573 735b 6a5d 290a 0a20 2020 2020  ocess[j])..     
+0000f820: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+0000f830: 6528 6e75 6d5f 636f 7265 7329 3a0a 2020  e(num_cores):.  
+0000f840: 2020 2020 2020 2020 2020 7072 6f63 6573            proces
+0000f850: 7365 735b 695d 2e6a 6f69 6e28 290a 2020  ses[i].join().  
+0000f860: 2020 2020 2020 2320 7072 696e 7428 736c        # print(sl
+0000f870: 6f70 6573 2c27 736c 6f70 6573 2729 0a20  opes,'slopes'). 
+0000f880: 2020 2020 2020 2072 6574 7572 6e20 616c         return al
+0000f890: 6c5f 666f 756e 645f 7465 786c 696e 655f  l_found_texline_
+0000f8a0: 706f 6c79 676f 6e73 2c20 626f 7865 732c  polygons, boxes,
+0000f8b0: 2061 6c6c 5f66 6f75 6e64 5f74 6578 745f   all_found_text_
+0000f8c0: 7265 6769 6f6e 732c 2061 6c6c 5f66 6f75  regions, all_fou
+0000f8d0: 6e64 5f74 6578 745f 7265 6769 6f6e 735f  nd_text_regions_
+0000f8e0: 7061 722c 2061 6c6c 5f62 6f78 5f63 6f6f  par, all_box_coo
+0000f8f0: 7264 2c20 616c 6c5f 696e 6465 785f 7465  rd, all_index_te
+0000f900: 7874 5f63 6f6e 2c20 736c 6f70 6573 0a0a  xt_con, slopes..
+0000f910: 2020 2020 6465 6620 646f 5f77 6f72 6b5f      def do_work_
+0000f920: 6f66 5f73 6c6f 7065 735f 6e65 775f 6375  of_slopes_new_cu
+0000f930: 7276 6564 2873 656c 662c 2071 7565 7565  rved(self, queue
+0000f940: 5f6f 665f 616c 6c5f 7061 7261 6d73 2c20  _of_all_params, 
+0000f950: 626f 7865 735f 7465 7874 2c20 7465 7874  boxes_text, text
+0000f960: 6c69 6e65 5f6d 6173 6b5f 746f 745f 6561  line_mask_tot_ea
+0000f970: 2c20 636f 6e74 6f75 7273 5f70 6572 5f70  , contours_per_p
+0000f980: 726f 6365 7373 2c20 636f 6e74 6f75 7273  rocess, contours
+0000f990: 5f70 6172 5f70 6572 5f70 726f 6365 7373  _par_per_process
+0000f9a0: 2c20 696d 6167 655f 7061 6765 5f72 6f74  , image_page_rot
+0000f9b0: 6174 6564 2c20 6d61 736b 5f74 6578 7473  ated, mask_texts
+0000f9c0: 5f6f 6e6c 792c 206e 756d 5f63 6f6c 2c20  _only, num_col, 
+0000f9d0: 7363 616c 655f 7061 722c 2069 6e64 6578  scale_par, index
+0000f9e0: 6573 5f72 5f63 6f6e 5f70 6572 5f70 726f  es_r_con_per_pro
+0000f9f0: 2c20 736c 6f70 655f 6465 736b 6577 293a  , slope_deskew):
+0000fa00: 0a20 2020 2020 2020 2073 656c 662e 6c6f  .        self.lo
+0000fa10: 6767 6572 2e64 6562 7567 2822 656e 7465  gger.debug("ente
+0000fa20: 7220 646f 5f77 6f72 6b5f 6f66 5f73 6c6f  r do_work_of_slo
+0000fa30: 7065 735f 6e65 775f 6375 7276 6564 2229  pes_new_curved")
+0000fa40: 0a20 2020 2020 2020 2073 6c6f 7065 735f  .        slopes_
+0000fa50: 7065 725f 6561 6368 5f73 7562 7072 6f63  per_each_subproc
+0000fa60: 6573 7320 3d20 5b5d 0a20 2020 2020 2020  ess = [].       
+0000fa70: 2062 6f75 6e64 696e 675f 626f 785f 6f66   bounding_box_of
+0000fa80: 5f74 6578 7472 6567 696f 6e5f 7065 725f  _textregion_per_
+0000fa90: 6561 6368 5f73 7562 7072 6f63 6573 7320  each_subprocess 
+0000faa0: 3d20 5b5d 0a20 2020 2020 2020 2074 6578  = [].        tex
+0000fab0: 746c 696e 6573 5f72 6563 7461 6e67 6c65  tlines_rectangle
+0000fac0: 735f 7065 725f 6561 6368 5f73 7562 7072  s_per_each_subpr
+0000fad0: 6f63 6573 7320 3d20 5b5d 0a20 2020 2020  ocess = [].     
+0000fae0: 2020 2063 6f6e 746f 7572 735f 7465 7874     contours_text
+0000faf0: 7265 6769 6f6e 5f70 6572 5f65 6163 685f  region_per_each_
+0000fb00: 7375 6270 726f 6365 7373 203d 205b 5d0a  subprocess = [].
+0000fb10: 2020 2020 2020 2020 636f 6e74 6f75 7273          contours
+0000fb20: 5f74 6578 7472 6567 696f 6e5f 7061 725f  _textregion_par_
+0000fb30: 7065 725f 6561 6368 5f73 7562 7072 6f63  per_each_subproc
+0000fb40: 6573 7320 3d20 5b5d 0a20 2020 2020 2020  ess = [].       
+0000fb50: 2061 6c6c 5f62 6f78 5f63 6f6f 7264 5f70   all_box_coord_p
+0000fb60: 6572 5f70 726f 6365 7373 203d 205b 5d0a  er_process = [].
+0000fb70: 2020 2020 2020 2020 696e 6465 785f 6279          index_by
+0000fb80: 5f74 6578 745f 7265 6769 6f6e 5f63 6f6e  _text_region_con
+0000fb90: 746f 7572 7320 3d20 5b5d 0a0a 2020 2020  tours = []..    
+0000fba0: 2020 2020 7465 7874 6c69 6e65 5f63 6e74      textline_cnt
+0000fbb0: 5f73 6570 6172 6174 6564 203d 206e 702e  _separated = np.
+0000fbc0: 7a65 726f 7328 7465 7874 6c69 6e65 5f6d  zeros(textline_m
+0000fbd0: 6173 6b5f 746f 745f 6561 2e73 6861 7065  ask_tot_ea.shape
+0000fbe0: 290a 0a20 2020 2020 2020 2066 6f72 206d  )..        for m
+0000fbf0: 7620 696e 2072 616e 6765 286c 656e 2862  v in range(len(b
+0000fc00: 6f78 6573 5f74 6578 7429 293a 0a0a 2020  oxes_text)):..  
+0000fc10: 2020 2020 2020 2020 2020 616c 6c5f 7465            all_te
+0000fc20: 7874 5f72 6567 696f 6e5f 7261 7720 3d20  xt_region_raw = 
+0000fc30: 7465 7874 6c69 6e65 5f6d 6173 6b5f 746f  textline_mask_to
+0000fc40: 745f 6561 5b62 6f78 6573 5f74 6578 745b  t_ea[boxes_text[
+0000fc50: 6d76 5d5b 315d 203a 2062 6f78 6573 5f74  mv][1] : boxes_t
+0000fc60: 6578 745b 6d76 5d5b 315d 202b 2062 6f78  ext[mv][1] + box
+0000fc70: 6573 5f74 6578 745b 6d76 5d5b 335d 2c20  es_text[mv][3], 
+0000fc80: 626f 7865 735f 7465 7874 5b6d 765d 5b30  boxes_text[mv][0
+0000fc90: 5d20 3a20 626f 7865 735f 7465 7874 5b6d  ] : boxes_text[m
+0000fca0: 765d 5b30 5d20 2b20 626f 7865 735f 7465  v][0] + boxes_te
+0000fcb0: 7874 5b6d 765d 5b32 5d5d 0a20 2020 2020  xt[mv][2]].     
+0000fcc0: 2020 2020 2020 2061 6c6c 5f74 6578 745f         all_text_
+0000fcd0: 7265 6769 6f6e 5f72 6177 203d 2061 6c6c  region_raw = all
+0000fce0: 5f74 6578 745f 7265 6769 6f6e 5f72 6177  _text_region_raw
+0000fcf0: 2e61 7374 7970 6528 6e70 2e75 696e 7438  .astype(np.uint8
+0000fd00: 290a 2020 2020 2020 2020 2020 2020 696d  ).            im
+0000fd10: 675f 696e 745f 7020 3d20 616c 6c5f 7465  g_int_p = all_te
+0000fd20: 7874 5f72 6567 696f 6e5f 7261 775b 3a2c  xt_region_raw[:,
+0000fd30: 203a 5d0a 0a20 2020 2020 2020 2020 2020   :]..           
+0000fd40: 2023 2069 6d67 5f69 6e74 5f70 3d63 7632   # img_int_p=cv2
+0000fd50: 2e65 726f 6465 2869 6d67 5f69 6e74 5f70  .erode(img_int_p
+0000fd60: 2c4b 4552 4e45 4c2c 6974 6572 6174 696f  ,KERNEL,iteratio
+0000fd70: 6e73 203d 2032 290a 2020 2020 2020 2020  ns = 2).        
+0000fd80: 2020 2020 2320 706c 742e 696d 7368 6f77      # plt.imshow
+0000fd90: 2869 6d67 5f69 6e74 5f70 290a 2020 2020  (img_int_p).    
+0000fda0: 2020 2020 2020 2020 2320 706c 742e 7368          # plt.sh
+0000fdb0: 6f77 2829 0a0a 2020 2020 2020 2020 2020  ow()..          
+0000fdc0: 2020 6966 2069 6d67 5f69 6e74 5f70 2e73    if img_int_p.s
+0000fdd0: 6861 7065 5b30 5d20 2f20 696d 675f 696e  hape[0] / img_in
+0000fde0: 745f 702e 7368 6170 655b 315d 203c 2030  t_p.shape[1] < 0
+0000fdf0: 2e31 3a0a 2020 2020 2020 2020 2020 2020  .1:.            
+0000fe00: 2020 2020 736c 6f70 6573 5f70 6572 5f65      slopes_per_e
+0000fe10: 6163 685f 7375 6270 726f 6365 7373 2e61  ach_subprocess.a
+0000fe20: 7070 656e 6428 3029 0a20 2020 2020 2020  ppend(0).       
+0000fe30: 2020 2020 2020 2020 2073 6c6f 7065 5f66           slope_f
+0000fe40: 6f72 5f61 6c6c 203d 205b 736c 6f70 655f  or_all = [slope_
+0000fe50: 6465 736b 6577 5d5b 305d 0a20 2020 2020  deskew][0].     
+0000fe60: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0000fe70: 2020 2020 2020 2020 2020 2020 2074 7279               try
+0000fe80: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0000fe90: 2020 2020 2020 7465 7874 6c69 6e65 5f63        textline_c
+0000fea0: 6f6e 2c20 6869 6572 6172 6368 7920 3d20  on, hierarchy = 
+0000feb0: 7265 7475 726e 5f63 6f6e 746f 7572 735f  return_contours_
+0000fec0: 6f66 5f69 6d61 6765 2869 6d67 5f69 6e74  of_image(img_int
+0000fed0: 5f70 290a 2020 2020 2020 2020 2020 2020  _p).            
+0000fee0: 2020 2020 2020 2020 7465 7874 6c69 6e65          textline
+0000fef0: 5f63 6f6e 5f66 696c 203d 2066 696c 7465  _con_fil = filte
+0000ff00: 725f 636f 6e74 6f75 7273 5f61 7265 615f  r_contours_area_
+0000ff10: 6f66 5f69 6d61 6765 2869 6d67 5f69 6e74  of_image(img_int
+0000ff20: 5f70 2c20 7465 7874 6c69 6e65 5f63 6f6e  _p, textline_con
+0000ff30: 2c20 6869 6572 6172 6368 792c 206d 6178  , hierarchy, max
+0000ff40: 5f61 7265 613d 312c 206d 696e 5f61 7265  _area=1, min_are
+0000ff50: 613d 302e 3030 3038 290a 2020 2020 2020  a=0.0008).      
+0000ff60: 2020 2020 2020 2020 2020 2020 2020 795f                y_
+0000ff70: 6469 6666 5f6d 6561 6e20 3d20 6669 6e64  diff_mean = find
+0000ff80: 5f63 6f6e 746f 7572 735f 6d65 616e 5f79  _contours_mean_y
+0000ff90: 5f64 6966 6628 7465 7874 6c69 6e65 5f63  _diff(textline_c
+0000ffa0: 6f6e 5f66 696c 290a 2020 2020 2020 2020  on_fil).        
+0000ffb0: 2020 2020 2020 2020 2020 2020 6966 2073              if s
+0000ffc0: 656c 662e 6973 4e61 4e28 795f 6469 6666  elf.isNaN(y_diff
+0000ffd0: 5f6d 6561 6e29 3a0a 2020 2020 2020 2020  _mean):.        
+0000ffe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0000fff0: 736c 6f70 655f 666f 725f 616c 6c20 3d20  slope_for_all = 
+00010000: 4d41 585f 534c 4f50 450a 2020 2020 2020  MAX_SLOPE.      
+00010010: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00010020: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00010030: 2020 2020 2020 2020 2020 2020 7369 676d              sigm
+00010040: 615f 6465 7320 3d20 6d61 7828 312c 2069  a_des = max(1, i
+00010050: 6e74 2879 5f64 6966 665f 6d65 616e 202a  nt(y_diff_mean *
+00010060: 2028 342e 3020 2f20 3430 2e30 2929 290a   (4.0 / 40.0))).
+00010070: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010080: 2020 2020 2020 2020 696d 675f 696e 745f          img_int_
+00010090: 705b 696d 675f 696e 745f 7020 3e20 305d  p[img_int_p > 0]
+000100a0: 203d 2031 0a20 2020 2020 2020 2020 2020   = 1.           
+000100b0: 2020 2020 2020 2020 2020 2020 2073 6c6f               slo
+000100c0: 7065 5f66 6f72 5f61 6c6c 203d 2072 6574  pe_for_all = ret
+000100d0: 7572 6e5f 6465 736b 6577 5f73 6c6f 7028  urn_deskew_slop(
+000100e0: 696d 675f 696e 745f 702c 2073 6967 6d61  img_int_p, sigma
+000100f0: 5f64 6573 2c20 706c 6f74 7465 723d 7365  _des, plotter=se
+00010100: 6c66 2e70 6c6f 7474 6572 290a 0a20 2020  lf.plotter)..   
+00010110: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010120: 2020 2020 2069 6620 6162 7328 736c 6f70       if abs(slop
+00010130: 655f 666f 725f 616c 6c29 203c 2030 2e35  e_for_all) < 0.5
+00010140: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00010150: 2020 2020 2020 2020 2020 2020 2020 736c                sl
+00010160: 6f70 655f 666f 725f 616c 6c20 3d20 5b73  ope_for_all = [s
+00010170: 6c6f 7065 5f64 6573 6b65 775d 5b30 5d0a  lope_deskew][0].
+00010180: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010190: 2065 7863 6570 7420 4578 6365 7074 696f   except Exceptio
+000101a0: 6e20 6173 2077 6879 3a0a 2020 2020 2020  n as why:.      
+000101b0: 2020 2020 2020 2020 2020 2020 2020 7365                se
+000101c0: 6c66 2e6c 6f67 6765 722e 6572 726f 7228  lf.logger.error(
+000101d0: 7768 7929 0a20 2020 2020 2020 2020 2020  why).           
+000101e0: 2020 2020 2020 2020 2073 6c6f 7065 5f66           slope_f
+000101f0: 6f72 5f61 6c6c 203d 204d 4158 5f53 4c4f  or_all = MAX_SLO
+00010200: 5045 0a0a 2020 2020 2020 2020 2020 2020  PE..            
+00010210: 2020 2020 6966 2073 6c6f 7065 5f66 6f72      if slope_for
+00010220: 5f61 6c6c 203d 3d20 4d41 585f 534c 4f50  _all == MAX_SLOP
+00010230: 453a 0a20 2020 2020 2020 2020 2020 2020  E:.             
+00010240: 2020 2020 2020 2073 6c6f 7065 5f66 6f72         slope_for
+00010250: 5f61 6c6c 203d 205b 736c 6f70 655f 6465  _all = [slope_de
+00010260: 736b 6577 5d5b 305d 0a20 2020 2020 2020  skew][0].       
+00010270: 2020 2020 2020 2020 2073 6c6f 7065 735f           slopes_
+00010280: 7065 725f 6561 6368 5f73 7562 7072 6f63  per_each_subproc
+00010290: 6573 732e 6170 7065 6e64 2873 6c6f 7065  ess.append(slope
+000102a0: 5f66 6f72 5f61 6c6c 290a 0a20 2020 2020  _for_all)..     
+000102b0: 2020 2020 2020 2069 6e64 6578 5f62 795f         index_by_
+000102c0: 7465 7874 5f72 6567 696f 6e5f 636f 6e74  text_region_cont
+000102d0: 6f75 7273 2e61 7070 656e 6428 696e 6465  ours.append(inde
+000102e0: 7865 735f 725f 636f 6e5f 7065 725f 7072  xes_r_con_per_pr
+000102f0: 6f5b 6d76 5d29 0a20 2020 2020 2020 2020  o[mv]).         
+00010300: 2020 205f 2c20 6372 6f70 5f63 6f6f 7220     _, crop_coor 
+00010310: 3d20 6372 6f70 5f69 6d61 6765 5f69 6e73  = crop_image_ins
+00010320: 6964 655f 626f 7828 626f 7865 735f 7465  ide_box(boxes_te
+00010330: 7874 5b6d 765d 2c20 696d 6167 655f 7061  xt[mv], image_pa
+00010340: 6765 5f72 6f74 6174 6564 290a 0a20 2020  ge_rotated)..   
+00010350: 2020 2020 2020 2020 2069 6620 6162 7328           if abs(
+00010360: 736c 6f70 655f 666f 725f 616c 6c29 203c  slope_for_all) <
+00010370: 2034 353a 0a20 2020 2020 2020 2020 2020   45:.           
+00010380: 2020 2020 2023 2061 6c6c 5f62 6f78 5f63       # all_box_c
+00010390: 6f6f 7264 2e61 7070 656e 6428 6372 6f70  oord.append(crop
+000103a0: 5f63 6f6f 7229 0a20 2020 2020 2020 2020  _coor).         
+000103b0: 2020 2020 2020 2074 6578 746c 696e 655f         textline_
+000103c0: 7265 6769 6f6e 5f69 6e5f 696d 6167 6520  region_in_image 
+000103d0: 3d20 6e70 2e7a 6572 6f73 2874 6578 746c  = np.zeros(textl
+000103e0: 696e 655f 6d61 736b 5f74 6f74 5f65 612e  ine_mask_tot_ea.
+000103f0: 7368 6170 6529 0a20 2020 2020 2020 2020  shape).         
+00010400: 2020 2020 2020 2063 6e74 5f6f 5f74 5f6d         cnt_o_t_m
+00010410: 6178 203d 2063 6f6e 746f 7572 735f 7061  ax = contours_pa
+00010420: 725f 7065 725f 7072 6f63 6573 735b 6d76  r_per_process[mv
+00010430: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00010440: 2020 782c 2079 2c20 772c 2068 203d 2063    x, y, w, h = c
+00010450: 7632 2e62 6f75 6e64 696e 6752 6563 7428  v2.boundingRect(
+00010460: 636e 745f 6f5f 745f 6d61 7829 0a20 2020  cnt_o_t_max).   
+00010470: 2020 2020 2020 2020 2020 2020 206d 6173               mas
+00010480: 6b5f 6269 6767 6573 7420 3d20 6e70 2e7a  k_biggest = np.z
+00010490: 6572 6f73 286d 6173 6b5f 7465 7874 735f  eros(mask_texts_
+000104a0: 6f6e 6c79 2e73 6861 7065 290a 2020 2020  only.shape).    
+000104b0: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
+000104c0: 5f62 6967 6765 7374 203d 2063 7632 2e66  _biggest = cv2.f
+000104d0: 696c 6c50 6f6c 7928 6d61 736b 5f62 6967  illPoly(mask_big
+000104e0: 6765 7374 2c20 7074 733d 5b63 6e74 5f6f  gest, pts=[cnt_o
+000104f0: 5f74 5f6d 6178 5d2c 2063 6f6c 6f72 3d28  _t_max], color=(
+00010500: 312c 2031 2c20 3129 290a 2020 2020 2020  1, 1, 1)).      
+00010510: 2020 2020 2020 2020 2020 6d61 736b 5f72            mask_r
+00010520: 6567 696f 6e5f 696e 5f70 6174 6368 5f72  egion_in_patch_r
+00010530: 6567 696f 6e20 3d20 6d61 736b 5f62 6967  egion = mask_big
+00010540: 6765 7374 5b79 203a 2079 202b 2068 2c20  gest[y : y + h, 
+00010550: 7820 3a20 7820 2b20 775d 0a20 2020 2020  x : x + w].     
+00010560: 2020 2020 2020 2020 2020 2074 6578 746c             textl
+00010570: 696e 655f 6269 6767 6573 745f 7265 6769  ine_biggest_regi
+00010580: 6f6e 203d 206d 6173 6b5f 6269 6767 6573  on = mask_bigges
+00010590: 7420 2a20 7465 7874 6c69 6e65 5f6d 6173  t * textline_mas
+000105a0: 6b5f 746f 745f 6561 0a0a 2020 2020 2020  k_tot_ea..      
+000105b0: 2020 2020 2020 2020 2020 2320 7072 696e            # prin
+000105c0: 7428 736c 6f70 655f 666f 725f 616c 6c2c  t(slope_for_all,
+000105d0: 2773 6c6f 7065 5f66 6f72 5f61 6c6c 2729  'slope_for_all')
+000105e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000105f0: 2074 6578 746c 696e 655f 726f 7461 7465   textline_rotate
+00010600: 645f 7365 7061 7261 7465 6420 3d20 7365  d_separated = se
+00010610: 7061 7261 7465 5f6c 696e 6573 5f6e 6577  parate_lines_new
+00010620: 3228 7465 7874 6c69 6e65 5f62 6967 6765  2(textline_bigge
+00010630: 7374 5f72 6567 696f 6e5b 7920 3a20 7920  st_region[y : y 
+00010640: 2b20 682c 2078 203a 2078 202b 2077 5d2c  + h, x : x + w],
+00010650: 2030 2c20 6e75 6d5f 636f 6c2c 2073 6c6f   0, num_col, slo
+00010660: 7065 5f66 6f72 5f61 6c6c 2c20 706c 6f74  pe_for_all, plot
+00010670: 7465 723d 7365 6c66 2e70 6c6f 7474 6572  ter=self.plotter
+00010680: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+00010690: 2020 2023 206e 6577 206c 696e 6520 6164     # new line ad
+000106a0: 6465 640a 2020 2020 2020 2020 2020 2020  ded.            
+000106b0: 2020 2020 2323 7072 696e 7428 6e70 2e73      ##print(np.s
+000106c0: 6861 7065 2874 6578 746c 696e 655f 726f  hape(textline_ro
+000106d0: 7461 7465 645f 7365 7061 7261 7465 6429  tated_separated)
+000106e0: 2c6e 702e 7368 6170 6528 6d61 736b 5f62  ,np.shape(mask_b
+000106f0: 6967 6765 7374 2929 0a20 2020 2020 2020  iggest)).       
+00010700: 2020 2020 2020 2020 2074 6578 746c 696e           textlin
+00010710: 655f 726f 7461 7465 645f 7365 7061 7261  e_rotated_separa
+00010720: 7465 645b 6d61 736b 5f72 6567 696f 6e5f  ted[mask_region_
+00010730: 696e 5f70 6174 6368 5f72 6567 696f 6e5b  in_patch_region[
+00010740: 3a2c 203a 5d20 213d 2031 5d20 3d20 300a  :, :] != 1] = 0.
+00010750: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010760: 2320 7469 6c6c 2068 6572 650a 0a20 2020  # till here..   
+00010770: 2020 2020 2020 2020 2020 2020 2074 6578               tex
+00010780: 746c 696e 655f 636e 745f 7365 7061 7261  tline_cnt_separa
+00010790: 7465 645b 7920 3a20 7920 2b20 682c 2078  ted[y : y + h, x
+000107a0: 203a 2078 202b 2077 5d20 3d20 7465 7874   : x + w] = text
+000107b0: 6c69 6e65 5f72 6f74 6174 6564 5f73 6570  line_rotated_sep
+000107c0: 6172 6174 6564 0a20 2020 2020 2020 2020  arated.         
+000107d0: 2020 2020 2020 2074 6578 746c 696e 655f         textline_
+000107e0: 7265 6769 6f6e 5f69 6e5f 696d 6167 655b  region_in_image[
+000107f0: 7920 3a20 7920 2b20 682c 2078 203a 2078  y : y + h, x : x
+00010800: 202b 2077 5d20 3d20 7465 7874 6c69 6e65   + w] = textline
+00010810: 5f72 6f74 6174 6564 5f73 6570 6172 6174  _rotated_separat
+00010820: 6564 0a0a 2020 2020 2020 2020 2020 2020  ed..            
+00010830: 2020 2020 2320 706c 742e 696d 7368 6f77      # plt.imshow
+00010840: 2874 6578 746c 696e 655f 7265 6769 6f6e  (textline_region
+00010850: 5f69 6e5f 696d 6167 6529 0a20 2020 2020  _in_image).     
+00010860: 2020 2020 2020 2020 2020 2023 2070 6c74             # plt
+00010870: 2e73 686f 7728 290a 2020 2020 2020 2020  .show().        
+00010880: 2020 2020 2020 2020 2320 706c 742e 696d          # plt.im
+00010890: 7368 6f77 2874 6578 746c 696e 655f 636e  show(textline_cn
+000108a0: 745f 7365 7061 7261 7465 6429 0a20 2020  t_separated).   
+000108b0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+000108c0: 6c74 2e73 686f 7728 290a 0a20 2020 2020  lt.show()..     
+000108d0: 2020 2020 2020 2020 2020 2070 6978 656c             pixel
+000108e0: 5f69 6d67 203d 2031 0a20 2020 2020 2020  _img = 1.       
+000108f0: 2020 2020 2020 2020 2063 6e74 5f74 6578           cnt_tex
+00010900: 746c 696e 6573 5f69 6e5f 696d 6167 6520  tlines_in_image 
+00010910: 3d20 7265 7475 726e 5f63 6f6e 746f 7572  = return_contour
+00010920: 735f 6f66 5f69 6e74 6572 6573 7465 645f  s_of_interested_
+00010930: 7465 7874 6c69 6e65 2874 6578 746c 696e  textline(textlin
+00010940: 655f 7265 6769 6f6e 5f69 6e5f 696d 6167  e_region_in_imag
+00010950: 652c 2070 6978 656c 5f69 6d67 290a 0a20  e, pixel_img).. 
+00010960: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00010970: 6578 746c 696e 6573 5f63 6e74 5f70 6572  extlines_cnt_per
+00010980: 5f72 6567 696f 6e20 3d20 5b5d 0a20 2020  _region = [].   
+00010990: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+000109a0: 206a 6a6a 6a20 696e 2072 616e 6765 286c   jjjj in range(l
+000109b0: 656e 2863 6e74 5f74 6578 746c 696e 6573  en(cnt_textlines
+000109c0: 5f69 6e5f 696d 6167 6529 293a 0a20 2020  _in_image)):.   
+000109d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000109e0: 206d 6173 6b5f 6269 6767 6573 7432 203d   mask_biggest2 =
+000109f0: 206e 702e 7a65 726f 7328 6d61 736b 5f74   np.zeros(mask_t
+00010a00: 6578 7473 5f6f 6e6c 792e 7368 6170 6529  exts_only.shape)
+00010a10: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010a20: 2020 2020 206d 6173 6b5f 6269 6767 6573       mask_bigges
+00010a30: 7432 203d 2063 7632 2e66 696c 6c50 6f6c  t2 = cv2.fillPol
+00010a40: 7928 6d61 736b 5f62 6967 6765 7374 322c  y(mask_biggest2,
+00010a50: 2070 7473 3d5b 636e 745f 7465 7874 6c69   pts=[cnt_textli
+00010a60: 6e65 735f 696e 5f69 6d61 6765 5b6a 6a6a  nes_in_image[jjj
+00010a70: 6a5d 5d2c 2063 6f6c 6f72 3d28 312c 2031  j]], color=(1, 1
+00010a80: 2c20 3129 290a 2020 2020 2020 2020 2020  , 1)).          
+00010a90: 2020 2020 2020 2020 2020 6966 206e 756d            if num
+00010aa0: 5f63 6f6c 202b 2031 203d 3d20 313a 0a20  _col + 1 == 1:. 
+00010ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010ac0: 2020 2020 2020 206d 6173 6b5f 6269 6767         mask_bigg
+00010ad0: 6573 7432 203d 2063 7632 2e64 696c 6174  est2 = cv2.dilat
+00010ae0: 6528 6d61 736b 5f62 6967 6765 7374 322c  e(mask_biggest2,
+00010af0: 204b 4552 4e45 4c2c 2069 7465 7261 7469   KERNEL, iterati
+00010b00: 6f6e 733d 3529 0a20 2020 2020 2020 2020  ons=5).         
+00010b10: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00010b20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00010b30: 2020 2020 2020 2020 206d 6173 6b5f 6269           mask_bi
+00010b40: 6767 6573 7432 203d 2063 7632 2e64 696c  ggest2 = cv2.dil
+00010b50: 6174 6528 6d61 736b 5f62 6967 6765 7374  ate(mask_biggest
+00010b60: 322c 204b 4552 4e45 4c2c 2069 7465 7261  2, KERNEL, itera
+00010b70: 7469 6f6e 733d 3429 0a0a 2020 2020 2020  tions=4)..      
+00010b80: 2020 2020 2020 2020 2020 2020 2020 7069                pi
+00010b90: 7865 6c5f 696d 6720 3d20 310a 2020 2020  xel_img = 1.    
+00010ba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010bb0: 6d61 736b 5f62 6967 6765 7374 3220 3d20  mask_biggest2 = 
+00010bc0: 7265 7369 7a65 5f69 6d61 6765 286d 6173  resize_image(mas
+00010bd0: 6b5f 6269 6767 6573 7432 2c20 696e 7428  k_biggest2, int(
+00010be0: 6d61 736b 5f62 6967 6765 7374 322e 7368  mask_biggest2.sh
+00010bf0: 6170 655b 305d 202a 2073 6361 6c65 5f70  ape[0] * scale_p
+00010c00: 6172 292c 2069 6e74 286d 6173 6b5f 6269  ar), int(mask_bi
+00010c10: 6767 6573 7432 2e73 6861 7065 5b31 5d20  ggest2.shape[1] 
+00010c20: 2a20 7363 616c 655f 7061 7229 290a 2020  * scale_par)).  
+00010c30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010c40: 2020 636e 745f 7465 7874 6c69 6e65 735f    cnt_textlines_
+00010c50: 696e 5f69 6d61 6765 5f69 6e64 203d 2072  in_image_ind = r
+00010c60: 6574 7572 6e5f 636f 6e74 6f75 7273 5f6f  eturn_contours_o
+00010c70: 665f 696e 7465 7265 7374 6564 5f74 6578  f_interested_tex
+00010c80: 746c 696e 6528 6d61 736b 5f62 6967 6765  tline(mask_bigge
+00010c90: 7374 322c 2070 6978 656c 5f69 6d67 290a  st2, pixel_img).
+00010ca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010cb0: 2020 2020 7472 793a 0a20 2020 2020 2020      try:.       
+00010cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010cd0: 2074 6578 746c 696e 6573 5f63 6e74 5f70   textlines_cnt_p
+00010ce0: 6572 5f72 6567 696f 6e2e 6170 7065 6e64  er_region.append
+00010cf0: 2863 6e74 5f74 6578 746c 696e 6573 5f69  (cnt_textlines_i
+00010d00: 6e5f 696d 6167 655f 696e 645b 305d 290a  n_image_ind[0]).
+00010d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d20: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00010d30: 7469 6f6e 2061 7320 7768 793a 0a20 2020  tion as why:.   
+00010d40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010d50: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
+00010d60: 2e65 7272 6f72 2877 6879 290a 2020 2020  .error(why).    
+00010d70: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00010d80: 2020 2020 2020 2020 2020 2020 2020 6164                ad
+00010d90: 645f 626f 7865 735f 636f 6f72 5f69 6e74  d_boxes_coor_int
+00010da0: 6f5f 7465 7874 6c69 6e65 7320 3d20 5472  o_textlines = Tr
+00010db0: 7565 0a20 2020 2020 2020 2020 2020 2020  ue.             
+00010dc0: 2020 2074 6578 746c 696e 6573 5f63 6e74     textlines_cnt
+00010dd0: 5f70 6572 5f72 6567 696f 6e20 3d20 7465  _per_region = te
+00010de0: 7874 6c69 6e65 5f63 6f6e 746f 7572 735f  xtline_contours_
+00010df0: 706f 7374 7072 6f63 6573 7369 6e67 2861  postprocessing(a
+00010e00: 6c6c 5f74 6578 745f 7265 6769 6f6e 5f72  ll_text_region_r
+00010e10: 6177 2c20 736c 6f70 655f 666f 725f 616c  aw, slope_for_al
+00010e20: 6c2c 2063 6f6e 746f 7572 735f 7061 725f  l, contours_par_
+00010e30: 7065 725f 7072 6f63 6573 735b 6d76 5d2c  per_process[mv],
+00010e40: 2062 6f78 6573 5f74 6578 745b 6d76 5d2c   boxes_text[mv],
+00010e50: 2061 6464 5f62 6f78 6573 5f63 6f6f 725f   add_boxes_coor_
+00010e60: 696e 746f 5f74 6578 746c 696e 6573 290a  into_textlines).
+00010e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00010e80: 6164 645f 626f 7865 735f 636f 6f72 5f69  add_boxes_coor_i
+00010e90: 6e74 6f5f 7465 7874 6c69 6e65 7320 3d20  nto_textlines = 
+00010ea0: 4661 6c73 650a 2020 2020 2020 2020 2020  False.          
+00010eb0: 2020 2020 2020 2320 7072 696e 7428 6e70        # print(np
+00010ec0: 2e73 6861 7065 2874 6578 746c 696e 6573  .shape(textlines
+00010ed0: 5f63 6e74 5f70 6572 5f72 6567 696f 6e29  _cnt_per_region)
+00010ee0: 2c27 7465 7874 6c69 6e65 735f 636e 745f  ,'textlines_cnt_
+00010ef0: 7065 725f 7265 6769 6f6e 2729 0a0a 2020  per_region')..  
+00010f00: 2020 2020 2020 2020 2020 7465 7874 6c69            textli
+00010f10: 6e65 735f 7265 6374 616e 676c 6573 5f70  nes_rectangles_p
+00010f20: 6572 5f65 6163 685f 7375 6270 726f 6365  er_each_subproce
+00010f30: 7373 2e61 7070 656e 6428 7465 7874 6c69  ss.append(textli
+00010f40: 6e65 735f 636e 745f 7065 725f 7265 6769  nes_cnt_per_regi
+00010f50: 6f6e 290a 2020 2020 2020 2020 2020 2020  on).            
+00010f60: 626f 756e 6469 6e67 5f62 6f78 5f6f 665f  bounding_box_of_
+00010f70: 7465 7874 7265 6769 6f6e 5f70 6572 5f65  textregion_per_e
+00010f80: 6163 685f 7375 6270 726f 6365 7373 2e61  ach_subprocess.a
+00010f90: 7070 656e 6428 626f 7865 735f 7465 7874  ppend(boxes_text
+00010fa0: 5b6d 765d 290a 2020 2020 2020 2020 2020  [mv]).          
+00010fb0: 2020 636f 6e74 6f75 7273 5f74 6578 7472    contours_textr
+00010fc0: 6567 696f 6e5f 7065 725f 6561 6368 5f73  egion_per_each_s
+00010fd0: 7562 7072 6f63 6573 732e 6170 7065 6e64  ubprocess.append
+00010fe0: 2863 6f6e 746f 7572 735f 7065 725f 7072  (contours_per_pr
+00010ff0: 6f63 6573 735b 6d76 5d29 0a20 2020 2020  ocess[mv]).     
+00011000: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
+00011010: 7465 7874 7265 6769 6f6e 5f70 6172 5f70  textregion_par_p
+00011020: 6572 5f65 6163 685f 7375 6270 726f 6365  er_each_subproce
+00011030: 7373 2e61 7070 656e 6428 636f 6e74 6f75  ss.append(contou
+00011040: 7273 5f70 6172 5f70 6572 5f70 726f 6365  rs_par_per_proce
+00011050: 7373 5b6d 765d 290a 2020 2020 2020 2020  ss[mv]).        
+00011060: 2020 2020 616c 6c5f 626f 785f 636f 6f72      all_box_coor
+00011070: 645f 7065 725f 7072 6f63 6573 732e 6170  d_per_process.ap
+00011080: 7065 6e64 2863 726f 705f 636f 6f72 290a  pend(crop_coor).
+00011090: 0a20 2020 2020 2020 2071 7565 7565 5f6f  .        queue_o
+000110a0: 665f 616c 6c5f 7061 7261 6d73 2e70 7574  f_all_params.put
+000110b0: 285b 7465 7874 6c69 6e65 735f 7265 6374  ([textlines_rect
+000110c0: 616e 676c 6573 5f70 6572 5f65 6163 685f  angles_per_each_
+000110d0: 7375 6270 726f 6365 7373 2c20 626f 756e  subprocess, boun
+000110e0: 6469 6e67 5f62 6f78 5f6f 665f 7465 7874  ding_box_of_text
+000110f0: 7265 6769 6f6e 5f70 6572 5f65 6163 685f  region_per_each_
+00011100: 7375 6270 726f 6365 7373 2c20 636f 6e74  subprocess, cont
+00011110: 6f75 7273 5f74 6578 7472 6567 696f 6e5f  ours_textregion_
+00011120: 7065 725f 6561 6368 5f73 7562 7072 6f63  per_each_subproc
+00011130: 6573 732c 2063 6f6e 746f 7572 735f 7465  ess, contours_te
+00011140: 7874 7265 6769 6f6e 5f70 6172 5f70 6572  xtregion_par_per
+00011150: 5f65 6163 685f 7375 6270 726f 6365 7373  _each_subprocess
+00011160: 2c20 616c 6c5f 626f 785f 636f 6f72 645f  , all_box_coord_
+00011170: 7065 725f 7072 6f63 6573 732c 2069 6e64  per_process, ind
+00011180: 6578 5f62 795f 7465 7874 5f72 6567 696f  ex_by_text_regio
+00011190: 6e5f 636f 6e74 6f75 7273 2c20 736c 6f70  n_contours, slop
+000111a0: 6573 5f70 6572 5f65 6163 685f 7375 6270  es_per_each_subp
+000111b0: 726f 6365 7373 5d29 0a20 2020 2064 6566  rocess]).    def
+000111c0: 2064 6f5f 776f 726b 5f6f 665f 736c 6f70   do_work_of_slop
+000111d0: 6573 5f6e 6577 5f6c 6967 6874 2873 656c  es_new_light(sel
+000111e0: 662c 2071 7565 7565 5f6f 665f 616c 6c5f  f, queue_of_all_
+000111f0: 7061 7261 6d73 2c20 626f 7865 735f 7465  params, boxes_te
+00011200: 7874 2c20 7465 7874 6c69 6e65 5f6d 6173  xt, textline_mas
+00011210: 6b5f 746f 745f 6561 2c20 636f 6e74 6f75  k_tot_ea, contou
+00011220: 7273 5f70 6572 5f70 726f 6365 7373 2c20  rs_per_process, 
+00011230: 636f 6e74 6f75 7273 5f70 6172 5f70 6572  contours_par_per
+00011240: 5f70 726f 6365 7373 2c20 696e 6465 7865  _process, indexe
+00011250: 735f 725f 636f 6e5f 7065 725f 7072 6f2c  s_r_con_per_pro,
+00011260: 2069 6d61 6765 5f70 6167 655f 726f 7461   image_page_rota
+00011270: 7465 642c 2073 6c6f 7065 5f64 6573 6b65  ted, slope_deske
+00011280: 7729 3a0a 2020 2020 2020 2020 7365 6c66  w):.        self
+00011290: 2e6c 6f67 6765 722e 6465 6275 6728 2765  .logger.debug('e
+000112a0: 6e74 6572 2064 6f5f 776f 726b 5f6f 665f  nter do_work_of_
+000112b0: 736c 6f70 6573 5f6e 6577 5f6c 6967 6874  slopes_new_light
+000112c0: 2729 0a20 2020 2020 2020 2073 6c6f 7065  ').        slope
+000112d0: 735f 7065 725f 6561 6368 5f73 7562 7072  s_per_each_subpr
+000112e0: 6f63 6573 7320 3d20 5b5d 0a20 2020 2020  ocess = [].     
+000112f0: 2020 2062 6f75 6e64 696e 675f 626f 785f     bounding_box_
+00011300: 6f66 5f74 6578 7472 6567 696f 6e5f 7065  of_textregion_pe
+00011310: 725f 6561 6368 5f73 7562 7072 6f63 6573  r_each_subproces
+00011320: 7320 3d20 5b5d 0a20 2020 2020 2020 2074  s = [].        t
+00011330: 6578 746c 696e 6573 5f72 6563 7461 6e67  extlines_rectang
+00011340: 6c65 735f 7065 725f 6561 6368 5f73 7562  les_per_each_sub
+00011350: 7072 6f63 6573 7320 3d20 5b5d 0a20 2020  process = [].   
+00011360: 2020 2020 2063 6f6e 746f 7572 735f 7465       contours_te
+00011370: 7874 7265 6769 6f6e 5f70 6572 5f65 6163  xtregion_per_eac
+00011380: 685f 7375 6270 726f 6365 7373 203d 205b  h_subprocess = [
+00011390: 5d0a 2020 2020 2020 2020 636f 6e74 6f75  ].        contou
+000113a0: 7273 5f74 6578 7472 6567 696f 6e5f 7061  rs_textregion_pa
+000113b0: 725f 7065 725f 6561 6368 5f73 7562 7072  r_per_each_subpr
+000113c0: 6f63 6573 7320 3d20 5b5d 0a20 2020 2020  ocess = [].     
+000113d0: 2020 2061 6c6c 5f62 6f78 5f63 6f6f 7264     all_box_coord
+000113e0: 5f70 6572 5f70 726f 6365 7373 203d 205b  _per_process = [
+000113f0: 5d0a 2020 2020 2020 2020 696e 6465 785f  ].        index_
+00011400: 6279 5f74 6578 745f 7265 6769 6f6e 5f63  by_text_region_c
+00011410: 6f6e 746f 7572 7320 3d20 5b5d 0a20 2020  ontours = [].   
+00011420: 2020 2020 2066 6f72 206d 7620 696e 2072       for mv in r
+00011430: 616e 6765 286c 656e 2862 6f78 6573 5f74  ange(len(boxes_t
+00011440: 6578 7429 293a 0a20 2020 2020 2020 2020  ext)):.         
+00011450: 2020 205f 2c20 6372 6f70 5f63 6f6f 7220     _, crop_coor 
+00011460: 3d20 6372 6f70 5f69 6d61 6765 5f69 6e73  = crop_image_ins
+00011470: 6964 655f 626f 7828 626f 7865 735f 7465  ide_box(boxes_te
+00011480: 7874 5b6d 765d 2c69 6d61 6765 5f70 6167  xt[mv],image_pag
+00011490: 655f 726f 7461 7465 6429 0a20 2020 2020  e_rotated).     
+000114a0: 2020 2020 2020 206d 6173 6b5f 7465 7874         mask_text
+000114b0: 6c69 6e65 203d 206e 702e 7a65 726f 7328  line = np.zeros(
+000114c0: 2874 6578 746c 696e 655f 6d61 736b 5f74  (textline_mask_t
+000114d0: 6f74 5f65 612e 7368 6170 6529 290a 2020  ot_ea.shape)).  
+000114e0: 2020 2020 2020 2020 2020 6d61 736b 5f74            mask_t
+000114f0: 6578 746c 696e 6520 3d20 6376 322e 6669  extline = cv2.fi
+00011500: 6c6c 506f 6c79 286d 6173 6b5f 7465 7874  llPoly(mask_text
+00011510: 6c69 6e65 2c70 7473 3d5b 636f 6e74 6f75  line,pts=[contou
+00011520: 7273 5f70 6572 5f70 726f 6365 7373 5b6d  rs_per_process[m
+00011530: 765d 5d2c 636f 6c6f 723d 2831 2c31 2c31  v]],color=(1,1,1
+00011540: 2929 0a20 2020 2020 2020 2020 2020 2061  )).            a
+00011550: 6c6c 5f74 6578 745f 7265 6769 6f6e 5f72  ll_text_region_r
+00011560: 6177 203d 2028 7465 7874 6c69 6e65 5f6d  aw = (textline_m
+00011570: 6173 6b5f 746f 745f 6561 2a6d 6173 6b5f  ask_tot_ea*mask_
+00011580: 7465 7874 6c69 6e65 5b3a 2c3a 5d29 5b62  textline[:,:])[b
+00011590: 6f78 6573 5f74 6578 745b 6d76 5d5b 315d  oxes_text[mv][1]
+000115a0: 3a62 6f78 6573 5f74 6578 745b 6d76 5d5b  :boxes_text[mv][
+000115b0: 315d 2b62 6f78 6573 5f74 6578 745b 6d76  1]+boxes_text[mv
+000115c0: 5d5b 335d 202c 2062 6f78 6573 5f74 6578  ][3] , boxes_tex
+000115d0: 745b 6d76 5d5b 305d 3a62 6f78 6573 5f74  t[mv][0]:boxes_t
+000115e0: 6578 745b 6d76 5d5b 305d 2b62 6f78 6573  ext[mv][0]+boxes
+000115f0: 5f74 6578 745b 6d76 5d5b 325d 205d 0a20  _text[mv][2] ]. 
+00011600: 2020 2020 2020 2020 2020 2061 6c6c 5f74             all_t
+00011610: 6578 745f 7265 6769 6f6e 5f72 6177 3d61  ext_region_raw=a
+00011620: 6c6c 5f74 6578 745f 7265 6769 6f6e 5f72  ll_text_region_r
+00011630: 6177 2e61 7374 7970 6528 6e70 2e75 696e  aw.astype(np.uin
+00011640: 7438 290a 0a20 2020 2020 2020 2020 2020  t8)..           
+00011650: 2073 6c6f 7065 735f 7065 725f 6561 6368   slopes_per_each
+00011660: 5f73 7562 7072 6f63 6573 732e 6170 7065  _subprocess.appe
+00011670: 6e64 285b 736c 6f70 655f 6465 736b 6577  nd([slope_deskew
+00011680: 5d5b 305d 290a 2020 2020 2020 2020 2020  ][0]).          
+00011690: 2020 6d61 736b 5f6f 6e6c 795f 636f 6e5f    mask_only_con_
+000116a0: 7265 6769 6f6e 203d 206e 702e 7a65 726f  region = np.zero
+000116b0: 7328 7465 7874 6c69 6e65 5f6d 6173 6b5f  s(textline_mask_
+000116c0: 746f 745f 6561 2e73 6861 7065 290a 2020  tot_ea.shape).  
+000116d0: 2020 2020 2020 2020 2020 6d61 736b 5f6f            mask_o
+000116e0: 6e6c 795f 636f 6e5f 7265 6769 6f6e 203d  nly_con_region =
+000116f0: 2063 7632 2e66 696c 6c50 6f6c 7928 6d61   cv2.fillPoly(ma
+00011700: 736b 5f6f 6e6c 795f 636f 6e5f 7265 6769  sk_only_con_regi
+00011710: 6f6e 2c20 7074 733d 5b63 6f6e 746f 7572  on, pts=[contour
+00011720: 735f 7061 725f 7065 725f 7072 6f63 6573  s_par_per_proces
+00011730: 735b 6d76 5d5d 2c20 636f 6c6f 723d 2831  s[mv]], color=(1
+00011740: 2c20 312c 2031 2929 0a0a 2020 2020 2020  , 1, 1))..      
+00011750: 2020 2020 2020 2320 706c 742e 696d 7368        # plt.imsh
+00011760: 6f77 286d 6173 6b5f 6f6e 6c79 5f63 6f6e  ow(mask_only_con
+00011770: 5f72 6567 696f 6e29 0a20 2020 2020 2020  _region).       
+00011780: 2020 2020 2023 2070 6c74 2e73 686f 7728       # plt.show(
+00011790: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
+000117a0: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+000117b0: 6c66 2e74 6578 746c 696e 655f 6c69 6768  lf.textline_ligh
+000117c0: 743a 0a20 2020 2020 2020 2020 2020 2020  t:.             
+000117d0: 2020 2061 6c6c 5f74 6578 745f 7265 6769     all_text_regi
+000117e0: 6f6e 5f72 6177 203d 206e 702e 636f 7079  on_raw = np.copy
+000117f0: 2874 6578 746c 696e 655f 6d61 736b 5f74  (textline_mask_t
+00011800: 6f74 5f65 6129 0a20 2020 2020 2020 2020  ot_ea).         
+00011810: 2020 2020 2020 2061 6c6c 5f74 6578 745f         all_text_
+00011820: 7265 6769 6f6e 5f72 6177 5b6d 6173 6b5f  region_raw[mask_
+00011830: 6f6e 6c79 5f63 6f6e 5f72 6567 696f 6e20  only_con_region 
+00011840: 3d3d 2030 5d20 3d20 300a 2020 2020 2020  == 0] = 0.      
+00011850: 2020 2020 2020 2020 2020 636e 745f 636c            cnt_cl
+00011860: 6561 6e5f 726f 745f 7261 772c 2068 6972  ean_rot_raw, hir
+00011870: 5f6f 6e5f 636e 745f 636c 6561 6e5f 726f  _on_cnt_clean_ro
+00011880: 7420 3d20 7265 7475 726e 5f63 6f6e 746f  t = return_conto
+00011890: 7572 735f 6f66 5f69 6d61 6765 2861 6c6c  urs_of_image(all
+000118a0: 5f74 6578 745f 7265 6769 6f6e 5f72 6177  _text_region_raw
+000118b0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000118c0: 2020 636e 745f 636c 6561 6e5f 726f 7420    cnt_clean_rot 
+000118d0: 3d20 6669 6c74 6572 5f63 6f6e 746f 7572  = filter_contour
+000118e0: 735f 6172 6561 5f6f 665f 696d 6167 6528  s_area_of_image(
+000118f0: 616c 6c5f 7465 7874 5f72 6567 696f 6e5f  all_text_region_
+00011900: 7261 772c 2063 6e74 5f63 6c65 616e 5f72  raw, cnt_clean_r
+00011910: 6f74 5f72 6177 2c20 6869 725f 6f6e 5f63  ot_raw, hir_on_c
+00011920: 6e74 5f63 6c65 616e 5f72 6f74 2c20 6d61  nt_clean_rot, ma
+00011930: 785f 6172 6561 3d31 2c20 6d69 6e5f 6172  x_area=1, min_ar
+00011940: 6561 3d30 2e30 3030 3031 290a 2020 2020  ea=0.00001).    
+00011950: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00011960: 2020 2020 2020 2020 2020 2020 2020 616c                al
+00011970: 6c5f 7465 7874 5f72 6567 696f 6e5f 7261  l_text_region_ra
+00011980: 7720 3d20 6e70 2e63 6f70 7928 7465 7874  w = np.copy(text
+00011990: 6c69 6e65 5f6d 6173 6b5f 746f 745f 6561  line_mask_tot_ea
+000119a0: 5b62 6f78 6573 5f74 6578 745b 6d76 5d5b  [boxes_text[mv][
+000119b0: 315d 203a 2062 6f78 6573 5f74 6578 745b  1] : boxes_text[
+000119c0: 6d76 5d5b 315d 202b 2062 6f78 6573 5f74  mv][1] + boxes_t
+000119d0: 6578 745b 6d76 5d5b 335d 2c20 626f 7865  ext[mv][3], boxe
+000119e0: 735f 7465 7874 5b6d 765d 5b30 5d20 3a20  s_text[mv][0] : 
+000119f0: 626f 7865 735f 7465 7874 5b6d 765d 5b30  boxes_text[mv][0
+00011a00: 5d20 2b20 626f 7865 735f 7465 7874 5b6d  ] + boxes_text[m
+00011a10: 765d 5b32 5d5d 290a 2020 2020 2020 2020  v][2]]).        
+00011a20: 2020 2020 2020 2020 6d61 736b 5f6f 6e6c          mask_onl
+00011a30: 795f 636f 6e5f 7265 6769 6f6e 203d 206d  y_con_region = m
+00011a40: 6173 6b5f 6f6e 6c79 5f63 6f6e 5f72 6567  ask_only_con_reg
+00011a50: 696f 6e5b 626f 7865 735f 7465 7874 5b6d  ion[boxes_text[m
+00011a60: 765d 5b31 5d20 3a20 626f 7865 735f 7465  v][1] : boxes_te
+00011a70: 7874 5b6d 765d 5b31 5d20 2b20 626f 7865  xt[mv][1] + boxe
+00011a80: 735f 7465 7874 5b6d 765d 5b33 5d2c 2062  s_text[mv][3], b
+00011a90: 6f78 6573 5f74 6578 745b 6d76 5d5b 305d  oxes_text[mv][0]
+00011aa0: 203a 2062 6f78 6573 5f74 6578 745b 6d76   : boxes_text[mv
+00011ab0: 5d5b 305d 202b 2062 6f78 6573 5f74 6578  ][0] + boxes_tex
+00011ac0: 745b 6d76 5d5b 325d 5d0a 2020 2020 2020  t[mv][2]].      
+00011ad0: 2020 2020 2020 2020 2020 616c 6c5f 7465            all_te
+00011ae0: 7874 5f72 6567 696f 6e5f 7261 775b 6d61  xt_region_raw[ma
+00011af0: 736b 5f6f 6e6c 795f 636f 6e5f 7265 6769  sk_only_con_regi
+00011b00: 6f6e 203d 3d20 305d 203d 2030 0a20 2020  on == 0] = 0.   
+00011b10: 2020 2020 2020 2020 2020 2020 2063 6e74               cnt
+00011b20: 5f63 6c65 616e 5f72 6f74 203d 2074 6578  _clean_rot = tex
+00011b30: 746c 696e 655f 636f 6e74 6f75 7273 5f70  tline_contours_p
+00011b40: 6f73 7470 726f 6365 7373 696e 6728 616c  ostprocessing(al
+00011b50: 6c5f 7465 7874 5f72 6567 696f 6e5f 7261  l_text_region_ra
+00011b60: 772c 205b 736c 6f70 655f 6465 736b 6577  w, [slope_deskew
+00011b70: 5d5b 305d 2c20 636f 6e74 6f75 7273 5f70  ][0], contours_p
+00011b80: 6172 5f70 6572 5f70 726f 6365 7373 5b6d  ar_per_process[m
+00011b90: 765d 2c20 626f 7865 735f 7465 7874 5b6d  v], boxes_text[m
+00011ba0: 765d 290a 0a20 2020 2020 2020 2020 2020  v])..           
+00011bb0: 2074 6578 746c 696e 6573 5f72 6563 7461   textlines_recta
+00011bc0: 6e67 6c65 735f 7065 725f 6561 6368 5f73  ngles_per_each_s
+00011bd0: 7562 7072 6f63 6573 732e 6170 7065 6e64  ubprocess.append
+00011be0: 2863 6e74 5f63 6c65 616e 5f72 6f74 290a  (cnt_clean_rot).
+00011bf0: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+00011c00: 785f 6279 5f74 6578 745f 7265 6769 6f6e  x_by_text_region
+00011c10: 5f63 6f6e 746f 7572 732e 6170 7065 6e64  _contours.append
+00011c20: 2869 6e64 6578 6573 5f72 5f63 6f6e 5f70  (indexes_r_con_p
+00011c30: 6572 5f70 726f 5b6d 765d 290a 2020 2020  er_pro[mv]).    
+00011c40: 2020 2020 2020 2020 626f 756e 6469 6e67          bounding
+00011c50: 5f62 6f78 5f6f 665f 7465 7874 7265 6769  _box_of_textregi
+00011c60: 6f6e 5f70 6572 5f65 6163 685f 7375 6270  on_per_each_subp
+00011c70: 726f 6365 7373 2e61 7070 656e 6428 626f  rocess.append(bo
+00011c80: 7865 735f 7465 7874 5b6d 765d 290a 0a20  xes_text[mv]).. 
+00011c90: 2020 2020 2020 2020 2020 2063 6f6e 746f             conto
+00011ca0: 7572 735f 7465 7874 7265 6769 6f6e 5f70  urs_textregion_p
+00011cb0: 6572 5f65 6163 685f 7375 6270 726f 6365  er_each_subproce
+00011cc0: 7373 2e61 7070 656e 6428 636f 6e74 6f75  ss.append(contou
+00011cd0: 7273 5f70 6572 5f70 726f 6365 7373 5b6d  rs_per_process[m
+00011ce0: 765d 290a 2020 2020 2020 2020 2020 2020  v]).            
+00011cf0: 636f 6e74 6f75 7273 5f74 6578 7472 6567  contours_textreg
+00011d00: 696f 6e5f 7061 725f 7065 725f 6561 6368  ion_par_per_each
+00011d10: 5f73 7562 7072 6f63 6573 732e 6170 7065  _subprocess.appe
+00011d20: 6e64 2863 6f6e 746f 7572 735f 7061 725f  nd(contours_par_
+00011d30: 7065 725f 7072 6f63 6573 735b 6d76 5d29  per_process[mv])
+00011d40: 0a20 2020 2020 2020 2020 2020 2061 6c6c  .            all
+00011d50: 5f62 6f78 5f63 6f6f 7264 5f70 6572 5f70  _box_coord_per_p
+00011d60: 726f 6365 7373 2e61 7070 656e 6428 6372  rocess.append(cr
+00011d70: 6f70 5f63 6f6f 7229 0a20 2020 2020 2020  op_coor).       
+00011d80: 2071 7565 7565 5f6f 665f 616c 6c5f 7061   queue_of_all_pa
+00011d90: 7261 6d73 2e70 7574 285b 736c 6f70 6573  rams.put([slopes
+00011da0: 5f70 6572 5f65 6163 685f 7375 6270 726f  _per_each_subpro
+00011db0: 6365 7373 2c20 7465 7874 6c69 6e65 735f  cess, textlines_
+00011dc0: 7265 6374 616e 676c 6573 5f70 6572 5f65  rectangles_per_e
+00011dd0: 6163 685f 7375 6270 726f 6365 7373 2c20  ach_subprocess, 
+00011de0: 626f 756e 6469 6e67 5f62 6f78 5f6f 665f  bounding_box_of_
+00011df0: 7465 7874 7265 6769 6f6e 5f70 6572 5f65  textregion_per_e
+00011e00: 6163 685f 7375 6270 726f 6365 7373 2c20  ach_subprocess, 
+00011e10: 636f 6e74 6f75 7273 5f74 6578 7472 6567  contours_textreg
+00011e20: 696f 6e5f 7065 725f 6561 6368 5f73 7562  ion_per_each_sub
+00011e30: 7072 6f63 6573 732c 2063 6f6e 746f 7572  process, contour
+00011e40: 735f 7465 7874 7265 6769 6f6e 5f70 6172  s_textregion_par
+00011e50: 5f70 6572 5f65 6163 685f 7375 6270 726f  _per_each_subpro
+00011e60: 6365 7373 2c20 616c 6c5f 626f 785f 636f  cess, all_box_co
+00011e70: 6f72 645f 7065 725f 7072 6f63 6573 732c  ord_per_process,
+00011e80: 2069 6e64 6578 5f62 795f 7465 7874 5f72   index_by_text_r
+00011e90: 6567 696f 6e5f 636f 6e74 6f75 7273 5d29  egion_contours])
+00011ea0: 0a20 2020 2020 2020 200a 2020 2020 6465  .        .    de
+00011eb0: 6620 646f 5f77 6f72 6b5f 6f66 5f73 6c6f  f do_work_of_slo
+00011ec0: 7065 735f 6e65 7728 7365 6c66 2c20 7175  pes_new(self, qu
+00011ed0: 6575 655f 6f66 5f61 6c6c 5f70 6172 616d  eue_of_all_param
+00011ee0: 732c 2062 6f78 6573 5f74 6578 742c 2074  s, boxes_text, t
+00011ef0: 6578 746c 696e 655f 6d61 736b 5f74 6f74  extline_mask_tot
+00011f00: 5f65 612c 2063 6f6e 746f 7572 735f 7065  _ea, contours_pe
+00011f10: 725f 7072 6f63 6573 732c 2063 6f6e 746f  r_process, conto
+00011f20: 7572 735f 7061 725f 7065 725f 7072 6f63  urs_par_per_proc
+00011f30: 6573 732c 2069 6e64 6578 6573 5f72 5f63  ess, indexes_r_c
+00011f40: 6f6e 5f70 6572 5f70 726f 2c20 696d 6167  on_per_pro, imag
+00011f50: 655f 7061 6765 5f72 6f74 6174 6564 2c20  e_page_rotated, 
+00011f60: 736c 6f70 655f 6465 736b 6577 293a 0a20  slope_deskew):. 
+00011f70: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
+00011f80: 6572 2e64 6562 7567 2827 656e 7465 7220  er.debug('enter 
+00011f90: 646f 5f77 6f72 6b5f 6f66 5f73 6c6f 7065  do_work_of_slope
+00011fa0: 735f 6e65 7727 290a 2020 2020 2020 2020  s_new').        
+00011fb0: 736c 6f70 6573 5f70 6572 5f65 6163 685f  slopes_per_each_
+00011fc0: 7375 6270 726f 6365 7373 203d 205b 5d0a  subprocess = [].
+00011fd0: 2020 2020 2020 2020 626f 756e 6469 6e67          bounding
+00011fe0: 5f62 6f78 5f6f 665f 7465 7874 7265 6769  _box_of_textregi
+00011ff0: 6f6e 5f70 6572 5f65 6163 685f 7375 6270  on_per_each_subp
+00012000: 726f 6365 7373 203d 205b 5d0a 2020 2020  rocess = [].    
+00012010: 2020 2020 7465 7874 6c69 6e65 735f 7265      textlines_re
+00012020: 6374 616e 676c 6573 5f70 6572 5f65 6163  ctangles_per_eac
+00012030: 685f 7375 6270 726f 6365 7373 203d 205b  h_subprocess = [
+00012040: 5d0a 2020 2020 2020 2020 636f 6e74 6f75  ].        contou
+00012050: 7273 5f74 6578 7472 6567 696f 6e5f 7065  rs_textregion_pe
+00012060: 725f 6561 6368 5f73 7562 7072 6f63 6573  r_each_subproces
+00012070: 7320 3d20 5b5d 0a20 2020 2020 2020 2063  s = [].        c
+00012080: 6f6e 746f 7572 735f 7465 7874 7265 6769  ontours_textregi
+00012090: 6f6e 5f70 6172 5f70 6572 5f65 6163 685f  on_par_per_each_
+000120a0: 7375 6270 726f 6365 7373 203d 205b 5d0a  subprocess = [].
+000120b0: 2020 2020 2020 2020 616c 6c5f 626f 785f          all_box_
+000120c0: 636f 6f72 645f 7065 725f 7072 6f63 6573  coord_per_proces
+000120d0: 7320 3d20 5b5d 0a20 2020 2020 2020 2069  s = [].        i
+000120e0: 6e64 6578 5f62 795f 7465 7874 5f72 6567  ndex_by_text_reg
+000120f0: 696f 6e5f 636f 6e74 6f75 7273 203d 205b  ion_contours = [
+00012100: 5d0a 2020 2020 2020 2020 666f 7220 6d76  ].        for mv
+00012110: 2069 6e20 7261 6e67 6528 6c65 6e28 626f   in range(len(bo
+00012120: 7865 735f 7465 7874 2929 3a0a 2020 2020  xes_text)):.    
+00012130: 2020 2020 2020 2020 5f2c 2063 726f 705f          _, crop_
+00012140: 636f 6f72 203d 2063 726f 705f 696d 6167  coor = crop_imag
+00012150: 655f 696e 7369 6465 5f62 6f78 2862 6f78  e_inside_box(box
+00012160: 6573 5f74 6578 745b 6d76 5d2c 696d 6167  es_text[mv],imag
+00012170: 655f 7061 6765 5f72 6f74 6174 6564 290a  e_page_rotated).
+00012180: 2020 2020 2020 2020 2020 2020 6d61 736b              mask
+00012190: 5f74 6578 746c 696e 6520 3d20 6e70 2e7a  _textline = np.z
+000121a0: 6572 6f73 2828 7465 7874 6c69 6e65 5f6d  eros((textline_m
+000121b0: 6173 6b5f 746f 745f 6561 2e73 6861 7065  ask_tot_ea.shape
+000121c0: 2929 0a20 2020 2020 2020 2020 2020 206d  )).            m
+000121d0: 6173 6b5f 7465 7874 6c69 6e65 203d 2063  ask_textline = c
+000121e0: 7632 2e66 696c 6c50 6f6c 7928 6d61 736b  v2.fillPoly(mask
+000121f0: 5f74 6578 746c 696e 652c 7074 733d 5b63  _textline,pts=[c
+00012200: 6f6e 746f 7572 735f 7065 725f 7072 6f63  ontours_per_proc
+00012210: 6573 735b 6d76 5d5d 2c63 6f6c 6f72 3d28  ess[mv]],color=(
+00012220: 312c 312c 3129 290a 2020 2020 2020 2020  1,1,1)).        
+00012230: 2020 2020 616c 6c5f 7465 7874 5f72 6567      all_text_reg
+00012240: 696f 6e5f 7261 7720 3d20 2874 6578 746c  ion_raw = (textl
+00012250: 696e 655f 6d61 736b 5f74 6f74 5f65 612a  ine_mask_tot_ea*
+00012260: 6d61 736b 5f74 6578 746c 696e 655b 3a2c  mask_textline[:,
+00012270: 3a5d 295b 626f 7865 735f 7465 7874 5b6d  :])[boxes_text[m
+00012280: 765d 5b31 5d3a 626f 7865 735f 7465 7874  v][1]:boxes_text
+00012290: 5b6d 765d 5b31 5d2b 626f 7865 735f 7465  [mv][1]+boxes_te
+000122a0: 7874 5b6d 765d 5b33 5d20 2c20 626f 7865  xt[mv][3] , boxe
+000122b0: 735f 7465 7874 5b6d 765d 5b30 5d3a 626f  s_text[mv][0]:bo
+000122c0: 7865 735f 7465 7874 5b6d 765d 5b30 5d2b  xes_text[mv][0]+
+000122d0: 626f 7865 735f 7465 7874 5b6d 765d 5b32  boxes_text[mv][2
+000122e0: 5d20 5d0a 2020 2020 2020 2020 2020 2020  ] ].            
+000122f0: 616c 6c5f 7465 7874 5f72 6567 696f 6e5f  all_text_region_
+00012300: 7261 773d 616c 6c5f 7465 7874 5f72 6567  raw=all_text_reg
+00012310: 696f 6e5f 7261 772e 6173 7479 7065 286e  ion_raw.astype(n
+00012320: 702e 7569 6e74 3829 0a20 2020 2020 2020  p.uint8).       
+00012330: 2020 2020 2069 6d67 5f69 6e74 5f70 3d61       img_int_p=a
+00012340: 6c6c 5f74 6578 745f 7265 6769 6f6e 5f72  ll_text_region_r
+00012350: 6177 5b3a 2c3a 5d23 7365 6c66 2e61 6c6c  aw[:,:]#self.all
+00012360: 5f74 6578 745f 7265 6769 6f6e 5f72 6177  _text_region_raw
+00012370: 5b6d 765d 0a20 2020 2020 2020 2020 2020  [mv].           
+00012380: 2069 6d67 5f69 6e74 5f70 3d63 7632 2e65   img_int_p=cv2.e
+00012390: 726f 6465 2869 6d67 5f69 6e74 5f70 2c4b  rode(img_int_p,K
+000123a0: 4552 4e45 4c2c 6974 6572 6174 696f 6e73  ERNEL,iterations
+000123b0: 203d 2032 290a 0a20 2020 2020 2020 2020   = 2)..         
+000123c0: 2020 2069 6620 696d 675f 696e 745f 702e     if img_int_p.
+000123d0: 7368 6170 655b 305d 2f69 6d67 5f69 6e74  shape[0]/img_int
+000123e0: 5f70 2e73 6861 7065 5b31 5d3c 302e 313a  _p.shape[1]<0.1:
+000123f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00012400: 2073 6c6f 7065 735f 7065 725f 6561 6368   slopes_per_each
+00012410: 5f73 7562 7072 6f63 6573 732e 6170 7065  _subprocess.appe
+00012420: 6e64 2830 290a 2020 2020 2020 2020 2020  nd(0).          
+00012430: 2020 2020 2020 736c 6f70 655f 666f 725f        slope_for_
+00012440: 616c 6c20 3d20 5b73 6c6f 7065 5f64 6573  all = [slope_des
+00012450: 6b65 775d 5b30 5d0a 2020 2020 2020 2020  kew][0].        
+00012460: 2020 2020 2020 2020 616c 6c5f 7465 7874          all_text
+00012470: 5f72 6567 696f 6e5f 7261 7720 3d20 7465  _region_raw = te
+00012480: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745f  xtline_mask_tot_
+00012490: 6561 5b62 6f78 6573 5f74 6578 745b 6d76  ea[boxes_text[mv
+000124a0: 5d5b 315d 203a 2062 6f78 6573 5f74 6578  ][1] : boxes_tex
+000124b0: 745b 6d76 5d5b 315d 202b 2062 6f78 6573  t[mv][1] + boxes
+000124c0: 5f74 6578 745b 6d76 5d5b 335d 2c20 626f  _text[mv][3], bo
+000124d0: 7865 735f 7465 7874 5b6d 765d 5b30 5d20  xes_text[mv][0] 
+000124e0: 3a20 626f 7865 735f 7465 7874 5b6d 765d  : boxes_text[mv]
+000124f0: 5b30 5d20 2b20 626f 7865 735f 7465 7874  [0] + boxes_text
+00012500: 5b6d 765d 5b32 5d5d 0a20 2020 2020 2020  [mv][2]].       
+00012510: 2020 2020 2020 2020 2063 6e74 5f63 6c65           cnt_cle
+00012520: 616e 5f72 6f74 203d 2074 6578 746c 696e  an_rot = textlin
+00012530: 655f 636f 6e74 6f75 7273 5f70 6f73 7470  e_contours_postp
+00012540: 726f 6365 7373 696e 6728 616c 6c5f 7465  rocessing(all_te
+00012550: 7874 5f72 6567 696f 6e5f 7261 772c 2073  xt_region_raw, s
+00012560: 6c6f 7065 5f66 6f72 5f61 6c6c 2c20 636f  lope_for_all, co
+00012570: 6e74 6f75 7273 5f70 6172 5f70 6572 5f70  ntours_par_per_p
+00012580: 726f 6365 7373 5b6d 765d 2c20 626f 7865  rocess[mv], boxe
+00012590: 735f 7465 7874 5b6d 765d 2c20 3029 0a20  s_text[mv], 0). 
+000125a0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000125b0: 6578 746c 696e 6573 5f72 6563 7461 6e67  extlines_rectang
+000125c0: 6c65 735f 7065 725f 6561 6368 5f73 7562  les_per_each_sub
+000125d0: 7072 6f63 6573 732e 6170 7065 6e64 2863  process.append(c
+000125e0: 6e74 5f63 6c65 616e 5f72 6f74 290a 2020  nt_clean_rot).  
+000125f0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00012600: 6465 785f 6279 5f74 6578 745f 7265 6769  dex_by_text_regi
+00012610: 6f6e 5f63 6f6e 746f 7572 732e 6170 7065  on_contours.appe
+00012620: 6e64 2869 6e64 6578 6573 5f72 5f63 6f6e  nd(indexes_r_con
+00012630: 5f70 6572 5f70 726f 5b6d 765d 290a 2020  _per_pro[mv]).  
+00012640: 2020 2020 2020 2020 2020 2020 2020 626f                bo
+00012650: 756e 6469 6e67 5f62 6f78 5f6f 665f 7465  unding_box_of_te
+00012660: 7874 7265 6769 6f6e 5f70 6572 5f65 6163  xtregion_per_eac
+00012670: 685f 7375 6270 726f 6365 7373 2e61 7070  h_subprocess.app
+00012680: 656e 6428 626f 7865 735f 7465 7874 5b6d  end(boxes_text[m
+00012690: 765d 290a 2020 2020 2020 2020 2020 2020  v]).            
+000126a0: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+000126b0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000126c0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000126d0: 6578 746c 696e 655f 636f 6e2c 2068 6965  extline_con, hie
+000126e0: 7261 7263 6879 203d 2072 6574 7572 6e5f  rarchy = return_
+000126f0: 636f 6e74 6f75 7273 5f6f 665f 696d 6167  contours_of_imag
+00012700: 6528 696d 675f 696e 745f 7029 0a20 2020  e(img_int_p).   
+00012710: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012720: 2074 6578 746c 696e 655f 636f 6e5f 6669   textline_con_fi
+00012730: 6c20 3d20 6669 6c74 6572 5f63 6f6e 746f  l = filter_conto
+00012740: 7572 735f 6172 6561 5f6f 665f 696d 6167  urs_area_of_imag
+00012750: 6528 696d 675f 696e 745f 702c 2074 6578  e(img_int_p, tex
+00012760: 746c 696e 655f 636f 6e2c 2068 6965 7261  tline_con, hiera
+00012770: 7263 6879 2c20 6d61 785f 6172 6561 3d31  rchy, max_area=1
+00012780: 2c20 6d69 6e5f 6172 6561 3d30 2e30 3030  , min_area=0.000
+00012790: 3038 290a 2020 2020 2020 2020 2020 2020  08).            
+000127a0: 2020 2020 2020 2020 795f 6469 6666 5f6d          y_diff_m
+000127b0: 6561 6e20 3d20 6669 6e64 5f63 6f6e 746f  ean = find_conto
+000127c0: 7572 735f 6d65 616e 5f79 5f64 6966 6628  urs_mean_y_diff(
+000127d0: 7465 7874 6c69 6e65 5f63 6f6e 5f66 696c  textline_con_fil
+000127e0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000127f0: 2020 2020 2020 6966 2073 656c 662e 6973        if self.is
+00012800: 4e61 4e28 795f 6469 6666 5f6d 6561 6e29  NaN(y_diff_mean)
+00012810: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00012820: 2020 2020 2020 2020 2020 736c 6f70 655f            slope_
+00012830: 666f 725f 616c 6c20 3d20 4d41 585f 534c  for_all = MAX_SL
+00012840: 4f50 450a 2020 2020 2020 2020 2020 2020  OPE.            
+00012850: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+00012860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012870: 2020 2020 2020 7369 676d 615f 6465 7320        sigma_des 
+00012880: 3d20 696e 7428 795f 6469 6666 5f6d 6561  = int(y_diff_mea
+00012890: 6e20 2a20 2834 2e30 202f 2034 302e 3029  n * (4.0 / 40.0)
+000128a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000128b0: 2020 2020 2020 2020 2020 6966 2073 6967            if sig
+000128c0: 6d61 5f64 6573 203c 2031 3a0a 2020 2020  ma_des < 1:.    
+000128d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000128e0: 2020 2020 2020 2020 7369 676d 615f 6465          sigma_de
+000128f0: 7320 3d20 310a 2020 2020 2020 2020 2020  s = 1.          
+00012900: 2020 2020 2020 2020 2020 2020 2020 696d                im
+00012910: 675f 696e 745f 705b 696d 675f 696e 745f  g_int_p[img_int_
+00012920: 7020 3e20 305d 203d 2031 0a20 2020 2020  p > 0] = 1.     
+00012930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012940: 2020 2073 6c6f 7065 5f66 6f72 5f61 6c6c     slope_for_all
+00012950: 203d 2072 6574 7572 6e5f 6465 736b 6577   = return_deskew
+00012960: 5f73 6c6f 7028 696d 675f 696e 745f 702c  _slop(img_int_p,
+00012970: 2073 6967 6d61 5f64 6573 2c20 706c 6f74   sigma_des, plot
+00012980: 7465 723d 7365 6c66 2e70 6c6f 7474 6572  ter=self.plotter
+00012990: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000129a0: 2020 2020 2020 2020 2020 6966 2061 6273            if abs
+000129b0: 2873 6c6f 7065 5f66 6f72 5f61 6c6c 2920  (slope_for_all) 
+000129c0: 3c3d 2030 2e35 3a0a 2020 2020 2020 2020  <= 0.5:.        
+000129d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000129e0: 2020 2020 736c 6f70 655f 666f 725f 616c      slope_for_al
+000129f0: 6c20 3d20 5b73 6c6f 7065 5f64 6573 6b65  l = [slope_deske
+00012a00: 775d 5b30 5d0a 2020 2020 2020 2020 2020  w][0].          
+00012a10: 2020 2020 2020 6578 6365 7074 2045 7863        except Exc
+00012a20: 6570 7469 6f6e 2061 7320 7768 793a 0a20  eption as why:. 
+00012a30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00012a40: 2020 2073 656c 662e 6c6f 6767 6572 2e65     self.logger.e
+00012a50: 7272 6f72 2877 6879 290a 2020 2020 2020  rror(why).      
+00012a60: 2020 2020 2020 2020 2020 2020 2020 736c                sl
+00012a70: 6f70 655f 666f 725f 616c 6c20 3d20 4d41  ope_for_all = MA
+00012a80: 585f 534c 4f50 450a 2020 2020 2020 2020  X_SLOPE.        
+00012a90: 2020 2020 2020 2020 6966 2073 6c6f 7065          if slope
+00012aa0: 5f66 6f72 5f61 6c6c 203d 3d20 4d41 585f  _for_all == MAX_
+00012ab0: 534c 4f50 453a 0a20 2020 2020 2020 2020  SLOPE:.         
+00012ac0: 2020 2020 2020 2020 2020 2073 6c6f 7065             slope
+00012ad0: 5f66 6f72 5f61 6c6c 203d 205b 736c 6f70  _for_all = [slop
+00012ae0: 655f 6465 736b 6577 5d5b 305d 0a20 2020  e_deskew][0].   
+00012af0: 2020 2020 2020 2020 2020 2020 2073 6c6f               slo
+00012b00: 7065 735f 7065 725f 6561 6368 5f73 7562  pes_per_each_sub
+00012b10: 7072 6f63 6573 732e 6170 7065 6e64 2873  process.append(s
+00012b20: 6c6f 7065 5f66 6f72 5f61 6c6c 290a 2020  lope_for_all).  
+00012b30: 2020 2020 2020 2020 2020 2020 2020 6d61                ma
+00012b40: 736b 5f6f 6e6c 795f 636f 6e5f 7265 6769  sk_only_con_regi
+00012b50: 6f6e 203d 206e 702e 7a65 726f 7328 7465  on = np.zeros(te
+00012b60: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745f  xtline_mask_tot_
+00012b70: 6561 2e73 6861 7065 290a 2020 2020 2020  ea.shape).      
+00012b80: 2020 2020 2020 2020 2020 6d61 736b 5f6f            mask_o
+00012b90: 6e6c 795f 636f 6e5f 7265 6769 6f6e 203d  nly_con_region =
+00012ba0: 2063 7632 2e66 696c 6c50 6f6c 7928 6d61   cv2.fillPoly(ma
+00012bb0: 736b 5f6f 6e6c 795f 636f 6e5f 7265 6769  sk_only_con_regi
+00012bc0: 6f6e 2c20 7074 733d 5b63 6f6e 746f 7572  on, pts=[contour
+00012bd0: 735f 7061 725f 7065 725f 7072 6f63 6573  s_par_per_proces
+00012be0: 735b 6d76 5d5d 2c20 636f 6c6f 723d 2831  s[mv]], color=(1
+00012bf0: 2c20 312c 2031 2929 0a0a 2020 2020 2020  , 1, 1))..      
+00012c00: 2020 2020 2020 2020 2020 2320 706c 742e            # plt.
+00012c10: 696d 7368 6f77 286d 6173 6b5f 6f6e 6c79  imshow(mask_only
+00012c20: 5f63 6f6e 5f72 6567 696f 6e29 0a20 2020  _con_region).   
+00012c30: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+00012c40: 6c74 2e73 686f 7728 290a 2020 2020 2020  lt.show().      
+00012c50: 2020 2020 2020 2020 2020 616c 6c5f 7465            all_te
+00012c60: 7874 5f72 6567 696f 6e5f 7261 7720 3d20  xt_region_raw = 
+00012c70: 6e70 2e63 6f70 7928 7465 7874 6c69 6e65  np.copy(textline
+00012c80: 5f6d 6173 6b5f 746f 745f 6561 5b62 6f78  _mask_tot_ea[box
+00012c90: 6573 5f74 6578 745b 6d76 5d5b 315d 203a  es_text[mv][1] :
+00012ca0: 2062 6f78 6573 5f74 6578 745b 6d76 5d5b   boxes_text[mv][
+00012cb0: 315d 202b 2062 6f78 6573 5f74 6578 745b  1] + boxes_text[
+00012cc0: 6d76 5d5b 335d 2c20 626f 7865 735f 7465  mv][3], boxes_te
+00012cd0: 7874 5b6d 765d 5b30 5d20 3a20 626f 7865  xt[mv][0] : boxe
+00012ce0: 735f 7465 7874 5b6d 765d 5b30 5d20 2b20  s_text[mv][0] + 
+00012cf0: 626f 7865 735f 7465 7874 5b6d 765d 5b32  boxes_text[mv][2
+00012d00: 5d5d 290a 2020 2020 2020 2020 2020 2020  ]]).            
+00012d10: 2020 2020 6d61 736b 5f6f 6e6c 795f 636f      mask_only_co
+00012d20: 6e5f 7265 6769 6f6e 203d 206d 6173 6b5f  n_region = mask_
+00012d30: 6f6e 6c79 5f63 6f6e 5f72 6567 696f 6e5b  only_con_region[
+00012d40: 626f 7865 735f 7465 7874 5b6d 765d 5b31  boxes_text[mv][1
+00012d50: 5d20 3a20 626f 7865 735f 7465 7874 5b6d  ] : boxes_text[m
+00012d60: 765d 5b31 5d20 2b20 626f 7865 735f 7465  v][1] + boxes_te
+00012d70: 7874 5b6d 765d 5b33 5d2c 2062 6f78 6573  xt[mv][3], boxes
+00012d80: 5f74 6578 745b 6d76 5d5b 305d 203a 2062  _text[mv][0] : b
+00012d90: 6f78 6573 5f74 6578 745b 6d76 5d5b 305d  oxes_text[mv][0]
+00012da0: 202b 2062 6f78 6573 5f74 6578 745b 6d76   + boxes_text[mv
+00012db0: 5d5b 325d 5d0a 0a20 2020 2020 2020 2020  ][2]]..         
+00012dc0: 2020 2020 2020 2023 2370 6c74 2e69 6d73         ##plt.ims
+00012dd0: 686f 7728 7465 7874 6c69 6e65 5f6d 6173  how(textline_mas
+00012de0: 6b5f 746f 745f 6561 290a 2020 2020 2020  k_tot_ea).      
+00012df0: 2020 2020 2020 2020 2020 2323 706c 742e            ##plt.
+00012e00: 7368 6f77 2829 0a20 2020 2020 2020 2020  show().         
+00012e10: 2020 2020 2020 2023 2370 6c74 2e69 6d73         ##plt.ims
+00012e20: 686f 7728 616c 6c5f 7465 7874 5f72 6567  how(all_text_reg
+00012e30: 696f 6e5f 7261 7729 0a20 2020 2020 2020  ion_raw).       
+00012e40: 2020 2020 2020 2020 2023 2370 6c74 2e73           ##plt.s
+00012e50: 686f 7728 290a 2020 2020 2020 2020 2020  how().          
+00012e60: 2020 2020 2020 2323 706c 742e 696d 7368        ##plt.imsh
+00012e70: 6f77 286d 6173 6b5f 6f6e 6c79 5f63 6f6e  ow(mask_only_con
+00012e80: 5f72 6567 696f 6e29 0a20 2020 2020 2020  _region).       
+00012e90: 2020 2020 2020 2020 2023 2370 6c74 2e73           ##plt.s
+00012ea0: 686f 7728 290a 0a20 2020 2020 2020 2020  how()..         
+00012eb0: 2020 2020 2020 2061 6c6c 5f74 6578 745f         all_text_
+00012ec0: 7265 6769 6f6e 5f72 6177 5b6d 6173 6b5f  region_raw[mask_
+00012ed0: 6f6e 6c79 5f63 6f6e 5f72 6567 696f 6e20  only_con_region 
+00012ee0: 3d3d 2030 5d20 3d20 300a 2020 2020 2020  == 0] = 0.      
+00012ef0: 2020 2020 2020 2020 2020 636e 745f 636c            cnt_cl
+00012f00: 6561 6e5f 726f 7420 3d20 7465 7874 6c69  ean_rot = textli
+00012f10: 6e65 5f63 6f6e 746f 7572 735f 706f 7374  ne_contours_post
+00012f20: 7072 6f63 6573 7369 6e67 2861 6c6c 5f74  processing(all_t
+00012f30: 6578 745f 7265 6769 6f6e 5f72 6177 2c20  ext_region_raw, 
+00012f40: 736c 6f70 655f 666f 725f 616c 6c2c 2063  slope_for_all, c
+00012f50: 6f6e 746f 7572 735f 7061 725f 7065 725f  ontours_par_per_
+00012f60: 7072 6f63 6573 735b 6d76 5d2c 2062 6f78  process[mv], box
+00012f70: 6573 5f74 6578 745b 6d76 5d29 0a0a 2020  es_text[mv])..  
+00012f80: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00012f90: 7874 6c69 6e65 735f 7265 6374 616e 676c  xtlines_rectangl
+00012fa0: 6573 5f70 6572 5f65 6163 685f 7375 6270  es_per_each_subp
+00012fb0: 726f 6365 7373 2e61 7070 656e 6428 636e  rocess.append(cn
+00012fc0: 745f 636c 6561 6e5f 726f 7429 0a20 2020  t_clean_rot).   
+00012fd0: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+00012fe0: 6578 5f62 795f 7465 7874 5f72 6567 696f  ex_by_text_regio
+00012ff0: 6e5f 636f 6e74 6f75 7273 2e61 7070 656e  n_contours.appen
+00013000: 6428 696e 6465 7865 735f 725f 636f 6e5f  d(indexes_r_con_
+00013010: 7065 725f 7072 6f5b 6d76 5d29 0a20 2020  per_pro[mv]).   
+00013020: 2020 2020 2020 2020 2020 2020 2062 6f75               bou
+00013030: 6e64 696e 675f 626f 785f 6f66 5f74 6578  nding_box_of_tex
+00013040: 7472 6567 696f 6e5f 7065 725f 6561 6368  tregion_per_each
+00013050: 5f73 7562 7072 6f63 6573 732e 6170 7065  _subprocess.appe
+00013060: 6e64 2862 6f78 6573 5f74 6578 745b 6d76  nd(boxes_text[mv
+00013070: 5d29 0a0a 2020 2020 2020 2020 2020 2020  ])..            
+00013080: 636f 6e74 6f75 7273 5f74 6578 7472 6567  contours_textreg
+00013090: 696f 6e5f 7065 725f 6561 6368 5f73 7562  ion_per_each_sub
+000130a0: 7072 6f63 6573 732e 6170 7065 6e64 2863  process.append(c
+000130b0: 6f6e 746f 7572 735f 7065 725f 7072 6f63  ontours_per_proc
+000130c0: 6573 735b 6d76 5d29 0a20 2020 2020 2020  ess[mv]).       
+000130d0: 2020 2020 2063 6f6e 746f 7572 735f 7465       contours_te
+000130e0: 7874 7265 6769 6f6e 5f70 6172 5f70 6572  xtregion_par_per
+000130f0: 5f65 6163 685f 7375 6270 726f 6365 7373  _each_subprocess
+00013100: 2e61 7070 656e 6428 636f 6e74 6f75 7273  .append(contours
+00013110: 5f70 6172 5f70 6572 5f70 726f 6365 7373  _par_per_process
+00013120: 5b6d 765d 290a 2020 2020 2020 2020 2020  [mv]).          
+00013130: 2020 616c 6c5f 626f 785f 636f 6f72 645f    all_box_coord_
+00013140: 7065 725f 7072 6f63 6573 732e 6170 7065  per_process.appe
+00013150: 6e64 2863 726f 705f 636f 6f72 290a 2020  nd(crop_coor).  
+00013160: 2020 2020 2020 7175 6575 655f 6f66 5f61        queue_of_a
+00013170: 6c6c 5f70 6172 616d 732e 7075 7428 5b73  ll_params.put([s
+00013180: 6c6f 7065 735f 7065 725f 6561 6368 5f73  lopes_per_each_s
+00013190: 7562 7072 6f63 6573 732c 2074 6578 746c  ubprocess, textl
+000131a0: 696e 6573 5f72 6563 7461 6e67 6c65 735f  ines_rectangles_
+000131b0: 7065 725f 6561 6368 5f73 7562 7072 6f63  per_each_subproc
+000131c0: 6573 732c 2062 6f75 6e64 696e 675f 626f  ess, bounding_bo
+000131d0: 785f 6f66 5f74 6578 7472 6567 696f 6e5f  x_of_textregion_
+000131e0: 7065 725f 6561 6368 5f73 7562 7072 6f63  per_each_subproc
+000131f0: 6573 732c 2063 6f6e 746f 7572 735f 7465  ess, contours_te
+00013200: 7874 7265 6769 6f6e 5f70 6572 5f65 6163  xtregion_per_eac
+00013210: 685f 7375 6270 726f 6365 7373 2c20 636f  h_subprocess, co
+00013220: 6e74 6f75 7273 5f74 6578 7472 6567 696f  ntours_textregio
+00013230: 6e5f 7061 725f 7065 725f 6561 6368 5f73  n_par_per_each_s
+00013240: 7562 7072 6f63 6573 732c 2061 6c6c 5f62  ubprocess, all_b
+00013250: 6f78 5f63 6f6f 7264 5f70 6572 5f70 726f  ox_coord_per_pro
+00013260: 6365 7373 2c20 696e 6465 785f 6279 5f74  cess, index_by_t
+00013270: 6578 745f 7265 6769 6f6e 5f63 6f6e 746f  ext_region_conto
+00013280: 7572 735d 290a 0a20 2020 2064 6566 2074  urs])..    def t
+00013290: 6578 746c 696e 655f 636f 6e74 6f75 7273  extline_contours
+000132a0: 2873 656c 662c 2069 6d67 2c20 7061 7463  (self, img, patc
+000132b0: 6865 732c 2073 6361 6c65 725f 682c 2073  hes, scaler_h, s
+000132c0: 6361 6c65 725f 7729 3a0a 2020 2020 2020  caler_w):.      
+000132d0: 2020 7365 6c66 2e6c 6f67 6765 722e 6465    self.logger.de
+000132e0: 6275 6728 2765 6e74 6572 2074 6578 746c  bug('enter textl
+000132f0: 696e 655f 636f 6e74 6f75 7273 2729 0a20  ine_contours'). 
+00013300: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+00013310: 6c66 2e64 6972 5f69 6e3a 0a20 2020 2020  lf.dir_in:.     
+00013320: 2020 2020 2020 206d 6f64 656c 5f74 6578         model_tex
+00013330: 746c 696e 652c 2073 6573 7369 6f6e 5f74  tline, session_t
+00013340: 6578 746c 696e 6520 3d20 7365 6c66 2e73  extline = self.s
+00013350: 7461 7274 5f6e 6577 5f73 6573 7369 6f6e  tart_new_session
+00013360: 5f61 6e64 5f6d 6f64 656c 2873 656c 662e  _and_model(self.
+00013370: 6d6f 6465 6c5f 7465 7874 6c69 6e65 5f64  model_textline_d
+00013380: 6972 2069 6620 7061 7463 6865 7320 656c  ir if patches el
+00013390: 7365 2073 656c 662e 6d6f 6465 6c5f 7465  se self.model_te
+000133a0: 7874 6c69 6e65 5f64 6972 5f6e 7029 0a20  xtline_dir_np). 
+000133b0: 2020 2020 2020 2069 6d67 203d 2069 6d67         img = img
+000133c0: 2e61 7374 7970 6528 6e70 2e75 696e 7438  .astype(np.uint8
+000133d0: 290a 2020 2020 2020 2020 696d 675f 6f72  ).        img_or
+000133e0: 6720 3d20 6e70 2e63 6f70 7928 696d 6729  g = np.copy(img)
+000133f0: 0a20 2020 2020 2020 2069 6d67 5f68 203d  .        img_h =
+00013400: 2069 6d67 5f6f 7267 2e73 6861 7065 5b30   img_org.shape[0
+00013410: 5d0a 2020 2020 2020 2020 696d 675f 7720  ].        img_w 
+00013420: 3d20 696d 675f 6f72 672e 7368 6170 655b  = img_org.shape[
+00013430: 315d 0a20 2020 2020 2020 2069 6d67 203d  1].        img =
+00013440: 2072 6573 697a 655f 696d 6167 6528 696d   resize_image(im
+00013450: 675f 6f72 672c 2069 6e74 2869 6d67 5f6f  g_org, int(img_o
+00013460: 7267 2e73 6861 7065 5b30 5d20 2a20 7363  rg.shape[0] * sc
+00013470: 616c 6572 5f68 292c 2069 6e74 2869 6d67  aler_h), int(img
+00013480: 5f6f 7267 2e73 6861 7065 5b31 5d20 2a20  _org.shape[1] * 
+00013490: 7363 616c 6572 5f77 2929 0a20 2020 2020  scaler_w)).     
+000134a0: 2020 2069 6620 6e6f 7420 7365 6c66 2e64     if not self.d
+000134b0: 6972 5f69 6e3a 0a20 2020 2020 2020 2020  ir_in:.         
+000134c0: 2020 2070 7265 6469 6374 696f 6e5f 7465     prediction_te
+000134d0: 7874 6c69 6e65 203d 2073 656c 662e 646f  xtline = self.do
+000134e0: 5f70 7265 6469 6374 696f 6e28 7061 7463  _prediction(patc
+000134f0: 6865 732c 2069 6d67 2c20 6d6f 6465 6c5f  hes, img, model_
+00013500: 7465 7874 6c69 6e65 290a 2020 2020 2020  textline).      
+00013510: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00013520: 2020 2020 7072 6564 6963 7469 6f6e 5f74      prediction_t
+00013530: 6578 746c 696e 6520 3d20 7365 6c66 2e64  extline = self.d
+00013540: 6f5f 7072 6564 6963 7469 6f6e 2870 6174  o_prediction(pat
+00013550: 6368 6573 2c20 696d 672c 2073 656c 662e  ches, img, self.
+00013560: 6d6f 6465 6c5f 7465 7874 6c69 6e65 290a  model_textline).
+00013570: 2020 2020 2020 2020 7072 6564 6963 7469          predicti
+00013580: 6f6e 5f74 6578 746c 696e 6520 3d20 7265  on_textline = re
+00013590: 7369 7a65 5f69 6d61 6765 2870 7265 6469  size_image(predi
+000135a0: 6374 696f 6e5f 7465 7874 6c69 6e65 2c20  ction_textline, 
+000135b0: 696d 675f 682c 2069 6d67 5f77 290a 2020  img_h, img_w).  
+000135c0: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+000135d0: 662e 6469 725f 696e 3a0a 2020 2020 2020  f.dir_in:.      
+000135e0: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
+000135f0: 5f74 6578 746c 696e 655f 6c6f 6e67 7368  _textline_longsh
+00013600: 6f74 203d 2073 656c 662e 646f 5f70 7265  ot = self.do_pre
+00013610: 6469 6374 696f 6e28 4661 6c73 652c 2069  diction(False, i
+00013620: 6d67 2c20 6d6f 6465 6c5f 7465 7874 6c69  mg, model_textli
+00013630: 6e65 290a 2020 2020 2020 2020 656c 7365  ne).        else
+00013640: 3a0a 2020 2020 2020 2020 2020 2020 7072  :.            pr
+00013650: 6564 6963 7469 6f6e 5f74 6578 746c 696e  ediction_textlin
+00013660: 655f 6c6f 6e67 7368 6f74 203d 2073 656c  e_longshot = sel
+00013670: 662e 646f 5f70 7265 6469 6374 696f 6e28  f.do_prediction(
+00013680: 4661 6c73 652c 2069 6d67 2c20 7365 6c66  False, img, self
+00013690: 2e6d 6f64 656c 5f74 6578 746c 696e 6529  .model_textline)
+000136a0: 0a20 2020 2020 2020 2070 7265 6469 6374  .        predict
+000136b0: 696f 6e5f 7465 7874 6c69 6e65 5f6c 6f6e  ion_textline_lon
+000136c0: 6773 686f 745f 7472 7565 5f73 697a 6520  gshot_true_size 
+000136d0: 3d20 7265 7369 7a65 5f69 6d61 6765 2870  = resize_image(p
+000136e0: 7265 6469 6374 696f 6e5f 7465 7874 6c69  rediction_textli
+000136f0: 6e65 5f6c 6f6e 6773 686f 742c 2069 6d67  ne_longshot, img
+00013700: 5f68 2c20 696d 675f 7729 0a20 2020 2020  _h, img_w).     
+00013710: 2020 200a 0a20 2020 2020 2020 2069 6620     ..        if 
+00013720: 7365 6c66 2e74 6578 746c 696e 655f 6c69  self.textline_li
+00013730: 6768 743a 0a20 2020 2020 2020 2020 2020  ght:.           
+00013740: 2072 6574 7572 6e20 2870 7265 6469 6374   return (predict
+00013750: 696f 6e5f 7465 7874 6c69 6e65 5b3a 2c20  ion_textline[:, 
+00013760: 3a2c 2030 5d3d 3d31 292a 312c 2028 7072  :, 0]==1)*1, (pr
+00013770: 6564 6963 7469 6f6e 5f74 6578 746c 696e  ediction_textlin
+00013780: 655f 6c6f 6e67 7368 6f74 5f74 7275 655f  e_longshot_true_
+00013790: 7369 7a65 5b3a 2c20 3a2c 2030 5d3d 3d31  size[:, :, 0]==1
+000137a0: 292a 310a 2020 2020 2020 2020 656c 7365  )*1.        else
+000137b0: 3a0a 2020 2020 2020 2020 2020 2020 7265  :.            re
+000137c0: 7475 726e 2070 7265 6469 6374 696f 6e5f  turn prediction_
+000137d0: 7465 7874 6c69 6e65 5b3a 2c20 3a2c 2030  textline[:, :, 0
+000137e0: 5d2c 2070 7265 6469 6374 696f 6e5f 7465  ], prediction_te
+000137f0: 7874 6c69 6e65 5f6c 6f6e 6773 686f 745f  xtline_longshot_
+00013800: 7472 7565 5f73 697a 655b 3a2c 203a 2c20  true_size[:, :, 
+00013810: 305d 0a0a 0a20 2020 2064 6566 2064 6f5f  0]...    def do_
+00013820: 776f 726b 5f6f 665f 736c 6f70 6573 2873  work_of_slopes(s
+00013830: 656c 662c 2071 2c20 706f 6c79 2c20 626f  elf, q, poly, bo
+00013840: 785f 7375 622c 2062 6f78 6573 5f70 6572  x_sub, boxes_per
+00013850: 5f70 726f 6365 7373 2c20 7465 7874 6c69  _process, textli
+00013860: 6e65 5f6d 6173 6b5f 746f 742c 2063 6f6e  ne_mask_tot, con
+00013870: 746f 7572 735f 7065 725f 7072 6f63 6573  tours_per_proces
+00013880: 7329 3a0a 2020 2020 2020 2020 7365 6c66  s):.        self
+00013890: 2e6c 6f67 6765 722e 6465 6275 6728 2765  .logger.debug('e
+000138a0: 6e74 6572 2064 6f5f 776f 726b 5f6f 665f  nter do_work_of_
+000138b0: 736c 6f70 6573 2729 0a20 2020 2020 2020  slopes').       
+000138c0: 2073 6c6f 7065 5f62 6967 6765 7374 203d   slope_biggest =
+000138d0: 2030 0a20 2020 2020 2020 2073 6c6f 7065   0.        slope
+000138e0: 735f 7375 6220 3d20 5b5d 0a20 2020 2020  s_sub = [].     
+000138f0: 2020 2062 6f78 6573 5f73 7562 5f6e 6577     boxes_sub_new
+00013900: 203d 205b 5d0a 2020 2020 2020 2020 706f   = [].        po
+00013910: 6c79 5f73 7562 203d 205b 5d0a 2020 2020  ly_sub = [].    
+00013920: 2020 2020 666f 7220 6d76 2069 6e20 7261      for mv in ra
+00013930: 6e67 6528 6c65 6e28 626f 7865 735f 7065  nge(len(boxes_pe
+00013940: 725f 7072 6f63 6573 7329 293a 0a20 2020  r_process)):.   
+00013950: 2020 2020 2020 2020 2063 726f 705f 696d           crop_im
+00013960: 672c 205f 203d 2063 726f 705f 696d 6167  g, _ = crop_imag
+00013970: 655f 696e 7369 6465 5f62 6f78 2862 6f78  e_inside_box(box
+00013980: 6573 5f70 6572 5f70 726f 6365 7373 5b6d  es_per_process[m
+00013990: 765d 2c20 6e70 2e72 6570 6561 7428 7465  v], np.repeat(te
+000139a0: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745b  xtline_mask_tot[
+000139b0: 3a2c 203a 2c20 6e70 2e6e 6577 6178 6973  :, :, np.newaxis
+000139c0: 5d2c 2033 2c20 6178 6973 3d32 2929 0a20  ], 3, axis=2)). 
+000139d0: 2020 2020 2020 2020 2020 2063 726f 705f             crop_
+000139e0: 696d 6720 3d20 6372 6f70 5f69 6d67 5b3a  img = crop_img[:
+000139f0: 2c20 3a2c 2030 5d0a 2020 2020 2020 2020  , :, 0].        
+00013a00: 2020 2020 6372 6f70 5f69 6d67 203d 2063      crop_img = c
+00013a10: 7632 2e65 726f 6465 2863 726f 705f 696d  v2.erode(crop_im
+00013a20: 672c 204b 4552 4e45 4c2c 2069 7465 7261  g, KERNEL, itera
+00013a30: 7469 6f6e 733d 3229 0a20 2020 2020 2020  tions=2).       
+00013a40: 2020 2020 2074 7279 3a0a 2020 2020 2020       try:.      
+00013a50: 2020 2020 2020 2020 2020 7465 7874 6c69            textli
+00013a60: 6e65 5f63 6f6e 2c20 6869 6572 6172 6368  ne_con, hierarch
+00013a70: 7920 3d20 7265 7475 726e 5f63 6f6e 746f  y = return_conto
+00013a80: 7572 735f 6f66 5f69 6d61 6765 2863 726f  urs_of_image(cro
+00013a90: 705f 696d 6729 0a20 2020 2020 2020 2020  p_img).         
+00013aa0: 2020 2020 2020 2074 6578 746c 696e 655f         textline_
+00013ab0: 636f 6e5f 6669 6c20 3d20 6669 6c74 6572  con_fil = filter
+00013ac0: 5f63 6f6e 746f 7572 735f 6172 6561 5f6f  _contours_area_o
+00013ad0: 665f 696d 6167 6528 6372 6f70 5f69 6d67  f_image(crop_img
+00013ae0: 2c20 7465 7874 6c69 6e65 5f63 6f6e 2c20  , textline_con, 
+00013af0: 6869 6572 6172 6368 792c 206d 6178 5f61  hierarchy, max_a
+00013b00: 7265 613d 312c 206d 696e 5f61 7265 613d  rea=1, min_area=
+00013b10: 302e 3030 3038 290a 2020 2020 2020 2020  0.0008).        
+00013b20: 2020 2020 2020 2020 795f 6469 6666 5f6d          y_diff_m
+00013b30: 6561 6e20 3d20 6669 6e64 5f63 6f6e 746f  ean = find_conto
+00013b40: 7572 735f 6d65 616e 5f79 5f64 6966 6628  urs_mean_y_diff(
+00013b50: 7465 7874 6c69 6e65 5f63 6f6e 5f66 696c  textline_con_fil
+00013b60: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00013b70: 2020 7369 676d 615f 6465 7320 3d20 6d61    sigma_des = ma
+00013b80: 7828 312c 2069 6e74 2879 5f64 6966 665f  x(1, int(y_diff_
+00013b90: 6d65 616e 202a 2028 342e 3020 2f20 3430  mean * (4.0 / 40
+00013ba0: 2e30 2929 290a 2020 2020 2020 2020 2020  .0))).          
+00013bb0: 2020 2020 2020 6372 6f70 5f69 6d67 5b63        crop_img[c
+00013bc0: 726f 705f 696d 6720 3e20 305d 203d 2031  rop_img > 0] = 1
+00013bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00013be0: 2073 6c6f 7065 5f63 6f72 7265 7370 6f6e   slope_correspon
+00013bf0: 6469 6e67 5f74 6578 7472 6567 696f 6e20  ding_textregion 
+00013c00: 3d20 7265 7475 726e 5f64 6573 6b65 775f  = return_deskew_
+00013c10: 736c 6f70 2863 726f 705f 696d 672c 2073  slop(crop_img, s
+00013c20: 6967 6d61 5f64 6573 2c20 706c 6f74 7465  igma_des, plotte
+00013c30: 723d 7365 6c66 2e70 6c6f 7474 6572 290a  r=self.plotter).
+00013c40: 2020 2020 2020 2020 2020 2020 6578 6365              exce
+00013c50: 7074 2045 7863 6570 7469 6f6e 2061 7320  pt Exception as 
+00013c60: 7768 793a 0a20 2020 2020 2020 2020 2020  why:.           
+00013c70: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
+00013c80: 2e65 7272 6f72 2877 6879 290a 2020 2020  .error(why).    
+00013c90: 2020 2020 2020 2020 2020 2020 736c 6f70              slop
+00013ca0: 655f 636f 7272 6573 706f 6e64 696e 675f  e_corresponding_
+00013cb0: 7465 7874 7265 6769 6f6e 203d 204d 4158  textregion = MAX
+00013cc0: 5f53 4c4f 5045 0a0a 2020 2020 2020 2020  _SLOPE..        
+00013cd0: 2020 2020 6966 2073 6c6f 7065 5f63 6f72      if slope_cor
+00013ce0: 7265 7370 6f6e 6469 6e67 5f74 6578 7472  responding_textr
+00013cf0: 6567 696f 6e20 3d3d 204d 4158 5f53 4c4f  egion == MAX_SLO
+00013d00: 5045 3a0a 2020 2020 2020 2020 2020 2020  PE:.            
+00013d10: 2020 2020 736c 6f70 655f 636f 7272 6573      slope_corres
+00013d20: 706f 6e64 696e 675f 7465 7874 7265 6769  ponding_textregi
+00013d30: 6f6e 203d 2073 6c6f 7065 5f62 6967 6765  on = slope_bigge
+00013d40: 7374 0a20 2020 2020 2020 2020 2020 2073  st.            s
+00013d50: 6c6f 7065 735f 7375 622e 6170 7065 6e64  lopes_sub.append
+00013d60: 2873 6c6f 7065 5f63 6f72 7265 7370 6f6e  (slope_correspon
+00013d70: 6469 6e67 5f74 6578 7472 6567 696f 6e29  ding_textregion)
+00013d80: 0a0a 2020 2020 2020 2020 2020 2020 636e  ..            cn
+00013d90: 745f 636c 6561 6e5f 726f 7420 3d20 7465  t_clean_rot = te
+00013da0: 7874 6c69 6e65 5f63 6f6e 746f 7572 735f  xtline_contours_
+00013db0: 706f 7374 7072 6f63 6573 7369 6e67 2863  postprocessing(c
+00013dc0: 726f 705f 696d 672c 2073 6c6f 7065 5f63  rop_img, slope_c
+00013dd0: 6f72 7265 7370 6f6e 6469 6e67 5f74 6578  orresponding_tex
+00013de0: 7472 6567 696f 6e2c 2063 6f6e 746f 7572  tregion, contour
+00013df0: 735f 7065 725f 7072 6f63 6573 735b 6d76  s_per_process[mv
+00013e00: 5d2c 2062 6f78 6573 5f70 6572 5f70 726f  ], boxes_per_pro
+00013e10: 6365 7373 5b6d 765d 290a 0a20 2020 2020  cess[mv])..     
+00013e20: 2020 2020 2020 2070 6f6c 795f 7375 622e         poly_sub.
+00013e30: 6170 7065 6e64 2863 6e74 5f63 6c65 616e  append(cnt_clean
+00013e40: 5f72 6f74 290a 2020 2020 2020 2020 2020  _rot).          
+00013e50: 2020 626f 7865 735f 7375 625f 6e65 772e    boxes_sub_new.
+00013e60: 6170 7065 6e64 2862 6f78 6573 5f70 6572  append(boxes_per
+00013e70: 5f70 726f 6365 7373 5b6d 765d 290a 0a20  _process[mv]).. 
+00013e80: 2020 2020 2020 2071 2e70 7574 2873 6c6f         q.put(slo
+00013e90: 7065 735f 7375 6229 0a20 2020 2020 2020  pes_sub).       
+00013ea0: 2070 6f6c 792e 7075 7428 706f 6c79 5f73   poly.put(poly_s
+00013eb0: 7562 290a 2020 2020 2020 2020 626f 785f  ub).        box_
+00013ec0: 7375 622e 7075 7428 626f 7865 735f 7375  sub.put(boxes_su
+00013ed0: 625f 6e65 7729 0a20 2020 2064 6566 2067  b_new).    def g
+00013ee0: 6574 5f72 6567 696f 6e73 5f6c 6967 6874  et_regions_light
+00013ef0: 5f76 2873 656c 662c 696d 672c 6973 5f69  _v(self,img,is_i
+00013f00: 6d61 6765 5f65 6e68 616e 6365 642c 206e  mage_enhanced, n
+00013f10: 756d 5f63 6f6c 5f63 6c61 7373 6966 6965  um_col_classifie
+00013f20: 7229 3a0a 2020 2020 2020 2020 7365 6c66  r):.        self
+00013f30: 2e6c 6f67 6765 722e 6465 6275 6728 2265  .logger.debug("e
+00013f40: 6e74 6572 2067 6574 5f72 6567 696f 6e73  nter get_regions
+00013f50: 5f6c 6967 6874 5f76 2229 0a20 2020 2020  _light_v").     
+00013f60: 2020 2065 726f 7369 6f6e 5f68 7572 7473     erosion_hurts
+00013f70: 203d 2046 616c 7365 0a20 2020 2020 2020   = False.       
+00013f80: 2069 6d67 5f6f 7267 203d 206e 702e 636f   img_org = np.co
+00013f90: 7079 2869 6d67 290a 2020 2020 2020 2020  py(img).        
+00013fa0: 696d 675f 6865 6967 6874 5f68 203d 2069  img_height_h = i
+00013fb0: 6d67 5f6f 7267 2e73 6861 7065 5b30 5d0a  mg_org.shape[0].
+00013fc0: 2020 2020 2020 2020 696d 675f 7769 6474          img_widt
+00013fd0: 685f 6820 3d20 696d 675f 6f72 672e 7368  h_h = img_org.sh
+00013fe0: 6170 655b 315d 0a0a 2020 2020 2020 2020  ape[1]..        
+00013ff0: 236d 6f64 656c 5f72 6567 696f 6e2c 2073  #model_region, s
+00014000: 6573 7369 6f6e 5f72 6567 696f 6e20 3d20  ession_region = 
+00014010: 7365 6c66 2e73 7461 7274 5f6e 6577 5f73  self.start_new_s
+00014020: 6573 7369 6f6e 5f61 6e64 5f6d 6f64 656c  ession_and_model
+00014030: 2873 656c 662e 6d6f 6465 6c5f 7265 6769  (self.model_regi
+00014040: 6f6e 5f64 6972 5f70 5f65 6e73 290a 0a20  on_dir_p_ens).. 
+00014050: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00014060: 0a20 2020 2020 2020 2069 6620 6e75 6d5f  .        if num_
+00014070: 636f 6c5f 636c 6173 7369 6669 6572 203d  col_classifier =
+00014080: 3d20 313a 0a20 2020 2020 2020 2020 2020  = 1:.           
+00014090: 2069 6d67 5f77 5f6e 6577 203d 2031 3030   img_w_new = 100
+000140a0: 300a 2020 2020 2020 2020 2020 2020 696d  0.            im
+000140b0: 675f 685f 6e65 7720 3d20 696e 7428 696d  g_h_new = int(im
+000140c0: 675f 6f72 672e 7368 6170 655b 305d 202f  g_org.shape[0] /
+000140d0: 2066 6c6f 6174 2869 6d67 5f6f 7267 2e73   float(img_org.s
+000140e0: 6861 7065 5b31 5d29 202a 2069 6d67 5f77  hape[1]) * img_w
+000140f0: 5f6e 6577 290a 2020 2020 2020 2020 2020  _new).          
+00014100: 2020 0a20 2020 2020 2020 2065 6c69 6620    .        elif 
+00014110: 6e75 6d5f 636f 6c5f 636c 6173 7369 6669  num_col_classifi
+00014120: 6572 203d 3d20 323a 0a20 2020 2020 2020  er == 2:.       
+00014130: 2020 2020 2069 6d67 5f77 5f6e 6577 203d       img_w_new =
+00014140: 2031 3530 300a 2020 2020 2020 2020 2020   1500.          
+00014150: 2020 696d 675f 685f 6e65 7720 3d20 696e    img_h_new = in
+00014160: 7428 696d 675f 6f72 672e 7368 6170 655b  t(img_org.shape[
+00014170: 305d 202f 2066 6c6f 6174 2869 6d67 5f6f  0] / float(img_o
+00014180: 7267 2e73 6861 7065 5b31 5d29 202a 2069  rg.shape[1]) * i
+00014190: 6d67 5f77 5f6e 6577 290a 2020 2020 2020  mg_w_new).      
+000141a0: 2020 2020 2020 0a20 2020 2020 2020 2065        .        e
+000141b0: 6c69 6620 6e75 6d5f 636f 6c5f 636c 6173  lif num_col_clas
+000141c0: 7369 6669 6572 203d 3d20 333a 0a20 2020  sifier == 3:.   
+000141d0: 2020 2020 2020 2020 2069 6d67 5f77 5f6e           img_w_n
+000141e0: 6577 203d 2032 3030 300a 2020 2020 2020  ew = 2000.      
+000141f0: 2020 2020 2020 696d 675f 685f 6e65 7720        img_h_new 
+00014200: 3d20 696e 7428 696d 675f 6f72 672e 7368  = int(img_org.sh
+00014210: 6170 655b 305d 202f 2066 6c6f 6174 2869  ape[0] / float(i
+00014220: 6d67 5f6f 7267 2e73 6861 7065 5b31 5d29  mg_org.shape[1])
+00014230: 202a 2069 6d67 5f77 5f6e 6577 290a 2020   * img_w_new).  
+00014240: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00014250: 2020 2065 6c69 6620 6e75 6d5f 636f 6c5f     elif num_col_
+00014260: 636c 6173 7369 6669 6572 203d 3d20 343a  classifier == 4:
+00014270: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
+00014280: 5f77 5f6e 6577 203d 2032 3530 300a 2020  _w_new = 2500.  
+00014290: 2020 2020 2020 2020 2020 696d 675f 685f            img_h_
+000142a0: 6e65 7720 3d20 696e 7428 696d 675f 6f72  new = int(img_or
+000142b0: 672e 7368 6170 655b 305d 202f 2066 6c6f  g.shape[0] / flo
+000142c0: 6174 2869 6d67 5f6f 7267 2e73 6861 7065  at(img_org.shape
+000142d0: 5b31 5d29 202a 2069 6d67 5f77 5f6e 6577  [1]) * img_w_new
+000142e0: 290a 2020 2020 2020 2020 656c 6966 206e  ).        elif n
+000142f0: 756d 5f63 6f6c 5f63 6c61 7373 6966 6965  um_col_classifie
+00014300: 7220 3d3d 2035 3a0a 2020 2020 2020 2020  r == 5:.        
+00014310: 2020 2020 696d 675f 775f 6e65 7720 3d20      img_w_new = 
+00014320: 3330 3030 0a20 2020 2020 2020 2020 2020  3000.           
+00014330: 2069 6d67 5f68 5f6e 6577 203d 2069 6e74   img_h_new = int
+00014340: 2869 6d67 5f6f 7267 2e73 6861 7065 5b30  (img_org.shape[0
+00014350: 5d20 2f20 666c 6f61 7428 696d 675f 6f72  ] / float(img_or
+00014360: 672e 7368 6170 655b 315d 2920 2a20 696d  g.shape[1]) * im
+00014370: 675f 775f 6e65 7729 0a20 2020 2020 2020  g_w_new).       
+00014380: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00014390: 2020 2069 6d67 5f77 5f6e 6577 203d 2034     img_w_new = 4
+000143a0: 3030 300a 2020 2020 2020 2020 2020 2020  000.            
+000143b0: 696d 675f 685f 6e65 7720 3d20 696e 7428  img_h_new = int(
+000143c0: 696d 675f 6f72 672e 7368 6170 655b 305d  img_org.shape[0]
+000143d0: 202f 2066 6c6f 6174 2869 6d67 5f6f 7267   / float(img_org
+000143e0: 2e73 6861 7065 5b31 5d29 202a 2069 6d67  .shape[1]) * img
+000143f0: 5f77 5f6e 6577 290a 2020 2020 2020 2020  _w_new).        
+00014400: 696d 675f 7265 7369 7a65 6420 3d20 7265  img_resized = re
+00014410: 7369 7a65 5f69 6d61 6765 2869 6d67 2c69  size_image(img,i
+00014420: 6d67 5f68 5f6e 6577 2c20 696d 675f 775f  mg_h_new, img_w_
+00014430: 6e65 7720 290a 2020 2020 2020 2020 0a20  new ).        . 
+00014440: 2020 2020 2020 2069 6620 6e6f 7420 7365         if not se
+00014450: 6c66 2e64 6972 5f69 6e3a 0a20 2020 2020  lf.dir_in:.     
+00014460: 2020 2020 2020 206d 6f64 656c 5f62 696e         model_bin
+00014470: 2c20 7365 7373 696f 6e5f 6269 6e20 3d20  , session_bin = 
+00014480: 7365 6c66 2e73 7461 7274 5f6e 6577 5f73  self.start_new_s
+00014490: 6573 7369 6f6e 5f61 6e64 5f6d 6f64 656c  ession_and_model
+000144a0: 2873 656c 662e 6d6f 6465 6c5f 6469 725f  (self.model_dir_
+000144b0: 6f66 5f62 696e 6172 697a 6174 696f 6e29  of_binarization)
+000144c0: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
+000144d0: 6469 6374 696f 6e5f 6269 6e20 3d20 7365  diction_bin = se
+000144e0: 6c66 2e64 6f5f 7072 6564 6963 7469 6f6e  lf.do_prediction
+000144f0: 2854 7275 652c 2069 6d67 5f72 6573 697a  (True, img_resiz
+00014500: 6564 2c20 6d6f 6465 6c5f 6269 6e29 0a20  ed, model_bin). 
+00014510: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00014520: 2020 2020 2020 2020 2070 7265 6469 6374           predict
+00014530: 696f 6e5f 6269 6e20 3d20 7365 6c66 2e64  ion_bin = self.d
+00014540: 6f5f 7072 6564 6963 7469 6f6e 2854 7275  o_prediction(Tru
+00014550: 652c 2069 6d67 5f72 6573 697a 6564 2c20  e, img_resized, 
+00014560: 7365 6c66 2e6d 6f64 656c 5f62 696e 290a  self.model_bin).
+00014570: 2020 2020 2020 2020 7072 6564 6963 7469          predicti
+00014580: 6f6e 5f62 696e 3d70 7265 6469 6374 696f  on_bin=predictio
+00014590: 6e5f 6269 6e5b 3a2c 3a2c 305d 0a20 2020  n_bin[:,:,0].   
+000145a0: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
+000145b0: 6269 6e20 3d20 2870 7265 6469 6374 696f  bin = (predictio
+000145c0: 6e5f 6269 6e5b 3a2c 3a5d 3d3d 3029 2a31  n_bin[:,:]==0)*1
+000145d0: 0a20 2020 2020 2020 2070 7265 6469 6374  .        predict
+000145e0: 696f 6e5f 6269 6e20 3d20 7072 6564 6963  ion_bin = predic
+000145f0: 7469 6f6e 5f62 696e 2a32 3535 0a20 2020  tion_bin*255.   
+00014600: 2020 2020 200a 2020 2020 2020 2020 7072       .        pr
+00014610: 6564 6963 7469 6f6e 5f62 696e 203d 6e70  ediction_bin =np
+00014620: 2e72 6570 6561 7428 7072 6564 6963 7469  .repeat(predicti
+00014630: 6f6e 5f62 696e 5b3a 2c20 3a2c 206e 702e  on_bin[:, :, np.
+00014640: 6e65 7761 7869 735d 2c20 332c 2061 7869  newaxis], 3, axi
+00014650: 733d 3229 0a20 2020 2020 2020 200a 2020  s=2).        .  
+00014660: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
+00014670: 5f62 696e 203d 2070 7265 6469 6374 696f  _bin = predictio
+00014680: 6e5f 6269 6e2e 6173 7479 7065 286e 702e  n_bin.astype(np.
+00014690: 7569 6e74 3136 290a 2020 2020 2020 2020  uint16).        
+000146a0: 2369 6d67 3d20 6e70 2e63 6f70 7928 7072  #img= np.copy(pr
+000146b0: 6564 6963 7469 6f6e 5f62 696e 290a 2020  ediction_bin).  
+000146c0: 2020 2020 2020 696d 675f 6269 6e20 3d20        img_bin = 
+000146d0: 6e70 2e63 6f70 7928 7072 6564 6963 7469  np.copy(predicti
+000146e0: 6f6e 5f62 696e 290a 2020 2020 2020 2020  on_bin).        
+000146f0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00014700: 2020 0a20 2020 2020 2020 2074 6578 746c    .        textl
+00014710: 696e 655f 6d61 736b 5f74 6f74 5f65 6120  ine_mask_tot_ea 
+00014720: 3d20 7365 6c66 2e72 756e 5f74 6578 746c  = self.run_textl
+00014730: 696e 6528 696d 675f 6269 6e29 0a0a 2020  ine(img_bin)..  
+00014740: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+00014750: 662e 6469 725f 696e 3a0a 2020 2020 2020  f.dir_in:.      
+00014760: 2020 2020 2020 6d6f 6465 6c5f 7265 6769        model_regi
+00014770: 6f6e 2c20 7365 7373 696f 6e5f 7265 6769  on, session_regi
+00014780: 6f6e 203d 2073 656c 662e 7374 6172 745f  on = self.start_
+00014790: 6e65 775f 7365 7373 696f 6e5f 616e 645f  new_session_and_
+000147a0: 6d6f 6465 6c28 7365 6c66 2e6d 6f64 656c  model(self.model
+000147b0: 5f72 6567 696f 6e5f 6469 725f 705f 656e  _region_dir_p_en
+000147c0: 735f 6c69 6768 7429 0a20 2020 2020 2020  s_light).       
+000147d0: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
+000147e0: 7265 6769 6f6e 735f 6f72 6720 3d20 7365  regions_org = se
+000147f0: 6c66 2e64 6f5f 7072 6564 6963 7469 6f6e  lf.do_prediction
+00014800: 5f6e 6577 5f63 6f6e 6365 7074 2854 7275  _new_concept(Tru
+00014810: 652c 2069 6d67 5f62 696e 2c20 6d6f 6465  e, img_bin, mode
+00014820: 6c5f 7265 6769 6f6e 290a 2020 2020 2020  l_region).      
+00014830: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00014840: 2020 2020 7072 6564 6963 7469 6f6e 5f72      prediction_r
+00014850: 6567 696f 6e73 5f6f 7267 203d 2073 656c  egions_org = sel
+00014860: 662e 646f 5f70 7265 6469 6374 696f 6e5f  f.do_prediction_
+00014870: 6e65 775f 636f 6e63 6570 7428 5472 7565  new_concept(True
+00014880: 2c20 696d 675f 6269 6e2c 2073 656c 662e  , img_bin, self.
+00014890: 6d6f 6465 6c5f 7265 6769 6f6e 290a 2020  model_region).  
+000148a0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+000148b0: 2020 2023 706c 742e 696d 7368 6f77 2870     #plt.imshow(p
+000148c0: 7265 6469 6374 696f 6e5f 7265 6769 6f6e  rediction_region
+000148d0: 735f 6f72 675b 3a2c 3a2c 305d 290a 2020  s_org[:,:,0]).  
+000148e0: 2020 2020 2020 2370 6c74 2e73 686f 7728        #plt.show(
+000148f0: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
+00014900: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
+00014910: 6e5f 7265 6769 6f6e 735f 6f72 6720 3d20  n_regions_org = 
+00014920: 7265 7369 7a65 5f69 6d61 6765 2870 7265  resize_image(pre
+00014930: 6469 6374 696f 6e5f 7265 6769 6f6e 735f  diction_regions_
+00014940: 6f72 672c 696d 675f 6865 6967 6874 5f68  org,img_height_h
+00014950: 2c20 696d 675f 7769 6474 685f 6820 290a  , img_width_h ).
+00014960: 2020 2020 2020 2020 7465 7874 6c69 6e65          textline
+00014970: 5f6d 6173 6b5f 746f 745f 6561 203d 2072  _mask_tot_ea = r
+00014980: 6573 697a 655f 696d 6167 6528 7465 7874  esize_image(text
+00014990: 6c69 6e65 5f6d 6173 6b5f 746f 745f 6561  line_mask_tot_ea
+000149a0: 2c69 6d67 5f68 6569 6768 745f 682c 2069  ,img_height_h, i
+000149b0: 6d67 5f77 6964 7468 5f68 2029 0a20 2020  mg_width_h ).   
+000149c0: 2020 2020 200a 2020 2020 2020 2020 7072       .        pr
+000149d0: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
+000149e0: 5f6f 7267 3d70 7265 6469 6374 696f 6e5f  _org=prediction_
+000149f0: 7265 6769 6f6e 735f 6f72 675b 3a2c 3a2c  regions_org[:,:,
+00014a00: 305d 0a20 2020 2020 2020 2020 2020 200a  0].            .
+00014a10: 2020 2020 2020 2020 6d61 736b 5f6c 696e          mask_lin
+00014a20: 6573 5f6f 6e6c 7920 3d20 2870 7265 6469  es_only = (predi
+00014a30: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
+00014a40: 675b 3a2c 3a5d 203d 3d33 292a 310a 2020  g[:,:] ==3)*1.  
+00014a50: 2020 2020 2020 0a20 2020 2020 2020 206d        .        m
+00014a60: 6173 6b5f 7465 7874 735f 6f6e 6c79 203d  ask_texts_only =
+00014a70: 2028 7072 6564 6963 7469 6f6e 5f72 6567   (prediction_reg
+00014a80: 696f 6e73 5f6f 7267 5b3a 2c3a 5d20 3d3d  ions_org[:,:] ==
+00014a90: 3129 2a31 0a20 2020 2020 2020 200a 2020  1)*1.        .  
+00014aa0: 2020 2020 2020 6d61 736b 5f69 6d61 6765        mask_image
+00014ab0: 735f 6f6e 6c79 3d28 7072 6564 6963 7469  s_only=(predicti
+00014ac0: 6f6e 5f72 6567 696f 6e73 5f6f 7267 5b3a  on_regions_org[:
+00014ad0: 2c3a 5d20 3d3d 3229 2a31 0a20 2020 2020  ,:] ==2)*1.     
+00014ae0: 2020 200a 2020 2020 2020 2020 706f 6c79     .        poly
+00014af0: 676f 6e73 5f6c 696e 6573 5f78 6d6c 2c20  gons_lines_xml, 
+00014b00: 6869 725f 6c69 6e65 735f 786d 6c20 3d20  hir_lines_xml = 
+00014b10: 7265 7475 726e 5f63 6f6e 746f 7572 735f  return_contours_
+00014b20: 6f66 5f69 6d61 6765 286d 6173 6b5f 6c69  of_image(mask_li
+00014b30: 6e65 735f 6f6e 6c79 290a 2020 2020 2020  nes_only).      
+00014b40: 2020 706f 6c79 676f 6e73 5f6c 696e 6573    polygons_lines
+00014b50: 5f78 6d6c 203d 2074 6578 746c 696e 655f  _xml = textline_
+00014b60: 636f 6e5f 6669 6c20 3d20 6669 6c74 6572  con_fil = filter
+00014b70: 5f63 6f6e 746f 7572 735f 6172 6561 5f6f  _contours_area_o
+00014b80: 665f 696d 6167 6528 6d61 736b 5f6c 696e  f_image(mask_lin
+00014b90: 6573 5f6f 6e6c 792c 2070 6f6c 7967 6f6e  es_only, polygon
+00014ba0: 735f 6c69 6e65 735f 786d 6c2c 2068 6972  s_lines_xml, hir
+00014bb0: 5f6c 696e 6573 5f78 6d6c 2c20 6d61 785f  _lines_xml, max_
+00014bc0: 6172 6561 3d31 2c20 6d69 6e5f 6172 6561  area=1, min_area
+00014bd0: 3d30 2e30 3030 3031 290a 2020 2020 2020  =0.00001).      
+00014be0: 2020 0a20 2020 2020 2020 200a 2020 2020    .        .    
+00014bf0: 2020 2020 706f 6c79 676f 6e73 5f6f 665f      polygons_of_
+00014c00: 6f6e 6c79 5f74 6578 7473 203d 2072 6574  only_texts = ret
+00014c10: 7572 6e5f 636f 6e74 6f75 7273 5f6f 665f  urn_contours_of_
+00014c20: 696e 7465 7265 7374 6564 5f72 6567 696f  interested_regio
+00014c30: 6e28 6d61 736b 5f74 6578 7473 5f6f 6e6c  n(mask_texts_onl
+00014c40: 792c 312c 302e 3030 3030 3129 0a20 2020  y,1,0.00001).   
+00014c50: 2020 2020 200a 2020 2020 2020 2020 706f       .        po
+00014c60: 6c79 676f 6e73 5f6f 665f 6f6e 6c79 5f6c  lygons_of_only_l
+00014c70: 696e 6573 203d 2072 6574 7572 6e5f 636f  ines = return_co
+00014c80: 6e74 6f75 7273 5f6f 665f 696e 7465 7265  ntours_of_intere
+00014c90: 7374 6564 5f72 6567 696f 6e28 6d61 736b  sted_region(mask
+00014ca0: 5f6c 696e 6573 5f6f 6e6c 792c 312c 302e  _lines_only,1,0.
+00014cb0: 3030 3030 3129 0a20 2020 2020 2020 200a  00001).        .
+00014cc0: 2020 2020 2020 2020 7465 7874 5f72 6567          text_reg
+00014cd0: 696f 6e73 5f70 5f74 7275 6520 3d20 6e70  ions_p_true = np
+00014ce0: 2e7a 6572 6f73 2870 7265 6469 6374 696f  .zeros(predictio
+00014cf0: 6e5f 7265 6769 6f6e 735f 6f72 672e 7368  n_regions_org.sh
+00014d00: 6170 6529 0a20 2020 2020 2020 200a 2020  ape).        .  
+00014d10: 2020 2020 2020 7465 7874 5f72 6567 696f        text_regio
+00014d20: 6e73 5f70 5f74 7275 6520 3d20 6376 322e  ns_p_true = cv2.
+00014d30: 6669 6c6c 506f 6c79 2874 6578 745f 7265  fillPoly(text_re
+00014d40: 6769 6f6e 735f 705f 7472 7565 2c20 7074  gions_p_true, pt
+00014d50: 7320 3d20 706f 6c79 676f 6e73 5f6f 665f  s = polygons_of_
+00014d60: 6f6e 6c79 5f6c 696e 6573 2c20 636f 6c6f  only_lines, colo
+00014d70: 723d 2833 2c33 2c33 2929 0a20 2020 2020  r=(3,3,3)).     
+00014d80: 2020 200a 2020 2020 2020 2020 7465 7874     .        text
+00014d90: 5f72 6567 696f 6e73 5f70 5f74 7275 655b  _regions_p_true[
+00014da0: 3a2c 3a5d 5b6d 6173 6b5f 696d 6167 6573  :,:][mask_images
+00014db0: 5f6f 6e6c 795b 3a2c 3a5d 203d 3d20 315d  _only[:,:] == 1]
+00014dc0: 203d 2032 0a20 2020 2020 2020 200a 2020   = 2.        .  
+00014dd0: 2020 2020 2020 7465 7874 5f72 6567 696f        text_regio
+00014de0: 6e73 5f70 5f74 7275 6520 3d20 6376 322e  ns_p_true = cv2.
+00014df0: 6669 6c6c 506f 6c79 2874 6578 745f 7265  fillPoly(text_re
+00014e00: 6769 6f6e 735f 705f 7472 7565 2c20 7074  gions_p_true, pt
+00014e10: 7320 3d20 706f 6c79 676f 6e73 5f6f 665f  s = polygons_of_
+00014e20: 6f6e 6c79 5f74 6578 7473 2c20 636f 6c6f  only_texts, colo
+00014e30: 723d 2831 2c31 2c31 2929 0a20 2020 2020  r=(1,1,1)).     
+00014e40: 2020 200a 2020 2020 2020 2020 7265 7475     .        retu
+00014e50: 726e 2074 6578 745f 7265 6769 6f6e 735f  rn text_regions_
+00014e60: 705f 7472 7565 2c20 6572 6f73 696f 6e5f  p_true, erosion_
+00014e70: 6875 7274 732c 2070 6f6c 7967 6f6e 735f  hurts, polygons_
+00014e80: 6c69 6e65 735f 786d 6c2c 2074 6578 746c  lines_xml, textl
+00014e90: 696e 655f 6d61 736b 5f74 6f74 5f65 610a  ine_mask_tot_ea.
+00014ea0: 0a20 2020 2064 6566 2067 6574 5f72 6567  .    def get_reg
+00014eb0: 696f 6e73 5f66 726f 6d5f 7879 5f32 6d6f  ions_from_xy_2mo
+00014ec0: 6465 6c73 2873 656c 662c 696d 672c 6973  dels(self,img,is
+00014ed0: 5f69 6d61 6765 5f65 6e68 616e 6365 642c  _image_enhanced,
+00014ee0: 206e 756d 5f63 6f6c 5f63 6c61 7373 6966   num_col_classif
+00014ef0: 6965 7229 3a0a 2020 2020 2020 2020 7365  ier):.        se
+00014f00: 6c66 2e6c 6f67 6765 722e 6465 6275 6728  lf.logger.debug(
+00014f10: 2265 6e74 6572 2067 6574 5f72 6567 696f  "enter get_regio
+00014f20: 6e73 5f66 726f 6d5f 7879 5f32 6d6f 6465  ns_from_xy_2mode
+00014f30: 6c73 2229 0a20 2020 2020 2020 2065 726f  ls").        ero
+00014f40: 7369 6f6e 5f68 7572 7473 203d 2046 616c  sion_hurts = Fal
+00014f50: 7365 0a20 2020 2020 2020 2069 6d67 5f6f  se.        img_o
+00014f60: 7267 203d 206e 702e 636f 7079 2869 6d67  rg = np.copy(img
+00014f70: 290a 2020 2020 2020 2020 696d 675f 6865  ).        img_he
+00014f80: 6967 6874 5f68 203d 2069 6d67 5f6f 7267  ight_h = img_org
+00014f90: 2e73 6861 7065 5b30 5d0a 2020 2020 2020  .shape[0].      
+00014fa0: 2020 696d 675f 7769 6474 685f 6820 3d20    img_width_h = 
+00014fb0: 696d 675f 6f72 672e 7368 6170 655b 315d  img_org.shape[1]
+00014fc0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+00014fd0: 2020 6966 206e 6f74 2073 656c 662e 6469    if not self.di
+00014fe0: 725f 696e 3a0a 2020 2020 2020 2020 2020  r_in:.          
+00014ff0: 2020 6d6f 6465 6c5f 7265 6769 6f6e 2c20    model_region, 
+00015000: 7365 7373 696f 6e5f 7265 6769 6f6e 203d  session_region =
+00015010: 2073 656c 662e 7374 6172 745f 6e65 775f   self.start_new_
+00015020: 7365 7373 696f 6e5f 616e 645f 6d6f 6465  session_and_mode
+00015030: 6c28 7365 6c66 2e6d 6f64 656c 5f72 6567  l(self.model_reg
+00015040: 696f 6e5f 6469 725f 705f 656e 7329 0a0a  ion_dir_p_ens)..
+00015050: 2020 2020 2020 2020 7261 7469 6f5f 793d          ratio_y=
+00015060: 312e 330a 2020 2020 2020 2020 7261 7469  1.3.        rati
+00015070: 6f5f 783d 310a 0a20 2020 2020 2020 2069  o_x=1..        i
+00015080: 6d67 203d 2072 6573 697a 655f 696d 6167  mg = resize_imag
+00015090: 6528 696d 675f 6f72 672c 2069 6e74 2869  e(img_org, int(i
+000150a0: 6d67 5f6f 7267 2e73 6861 7065 5b30 5d2a  mg_org.shape[0]*
+000150b0: 7261 7469 6f5f 7929 2c20 696e 7428 696d  ratio_y), int(im
+000150c0: 675f 6f72 672e 7368 6170 655b 315d 2a72  g_org.shape[1]*r
+000150d0: 6174 696f 5f78 2929 0a20 2020 2020 2020  atio_x)).       
+000150e0: 2069 6620 6e6f 7420 7365 6c66 2e64 6972   if not self.dir
+000150f0: 5f69 6e3a 0a20 2020 2020 2020 2020 2020  _in:.           
+00015100: 2070 7265 6469 6374 696f 6e5f 7265 6769   prediction_regi
+00015110: 6f6e 735f 6f72 675f 7920 3d20 7365 6c66  ons_org_y = self
+00015120: 2e64 6f5f 7072 6564 6963 7469 6f6e 2854  .do_prediction(T
+00015130: 7275 652c 2069 6d67 2c20 6d6f 6465 6c5f  rue, img, model_
+00015140: 7265 6769 6f6e 290a 2020 2020 2020 2020  region).        
+00015150: 656c 7365 3a0a 2020 2020 2020 2020 2020  else:.          
+00015160: 2020 7072 6564 6963 7469 6f6e 5f72 6567    prediction_reg
+00015170: 696f 6e73 5f6f 7267 5f79 203d 2073 656c  ions_org_y = sel
+00015180: 662e 646f 5f70 7265 6469 6374 696f 6e28  f.do_prediction(
+00015190: 5472 7565 2c20 696d 672c 2073 656c 662e  True, img, self.
+000151a0: 6d6f 6465 6c5f 7265 6769 6f6e 290a 2020  model_region).  
+000151b0: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
+000151c0: 5f72 6567 696f 6e73 5f6f 7267 5f79 203d  _regions_org_y =
+000151d0: 2072 6573 697a 655f 696d 6167 6528 7072   resize_image(pr
+000151e0: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
+000151f0: 5f6f 7267 5f79 2c20 696d 675f 6865 6967  _org_y, img_heig
+00015200: 6874 5f68 2c20 696d 675f 7769 6474 685f  ht_h, img_width_
+00015210: 6820 290a 0a20 2020 2020 2020 2023 706c  h )..        #pl
+00015220: 742e 696d 7368 6f77 2870 7265 6469 6374  t.imshow(predict
+00015230: 696f 6e5f 7265 6769 6f6e 735f 6f72 675f  ion_regions_org_
+00015240: 795b 3a2c 3a2c 305d 290a 2020 2020 2020  y[:,:,0]).      
+00015250: 2020 2370 6c74 2e73 686f 7728 290a 2020    #plt.show().  
+00015260: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
+00015270: 5f72 6567 696f 6e73 5f6f 7267 5f79 203d  _regions_org_y =
+00015280: 2070 7265 6469 6374 696f 6e5f 7265 6769   prediction_regi
+00015290: 6f6e 735f 6f72 675f 795b 3a2c 3a2c 305d  ons_org_y[:,:,0]
+000152a0: 0a20 2020 2020 2020 206d 6173 6b5f 7a65  .        mask_ze
+000152b0: 726f 735f 7920 3d20 2870 7265 6469 6374  ros_y = (predict
+000152c0: 696f 6e5f 7265 6769 6f6e 735f 6f72 675f  ion_regions_org_
+000152d0: 795b 3a2c 3a5d 3d3d 3029 2a31 0a20 2020  y[:,:]==0)*1.   
+000152e0: 2020 2020 200a 2020 2020 2020 2020 2323       .        ##
+000152f0: 696d 675f 6f6e 6c79 5f72 6567 696f 6e73  img_only_regions
+00015300: 5f77 6974 685f 7365 7020 3d20 2820 2870  _with_sep = ( (p
+00015310: 7265 6469 6374 696f 6e5f 7265 6769 6f6e  rediction_region
+00015320: 735f 6f72 675f 795b 3a2c 3a5d 2021 3d20  s_org_y[:,:] != 
+00015330: 3329 2026 2028 7072 6564 6963 7469 6f6e  3) & (prediction
+00015340: 5f72 6567 696f 6e73 5f6f 7267 5f79 5b3a  _regions_org_y[:
+00015350: 2c3a 5d20 213d 2030 2920 292a 310a 2020  ,:] != 0) )*1.  
+00015360: 2020 2020 2020 696d 675f 6f6e 6c79 5f72        img_only_r
+00015370: 6567 696f 6e73 5f77 6974 685f 7365 7020  egions_with_sep 
+00015380: 3d20 2820 7072 6564 6963 7469 6f6e 5f72  = ( prediction_r
+00015390: 6567 696f 6e73 5f6f 7267 5f79 5b3a 2c3a  egions_org_y[:,:
+000153a0: 5d20 3d3d 2031 2029 2a31 0a20 2020 2020  ] == 1 )*1.     
+000153b0: 2020 2069 6d67 5f6f 6e6c 795f 7265 6769     img_only_regi
+000153c0: 6f6e 735f 7769 7468 5f73 6570 203d 2069  ons_with_sep = i
+000153d0: 6d67 5f6f 6e6c 795f 7265 6769 6f6e 735f  mg_only_regions_
+000153e0: 7769 7468 5f73 6570 2e61 7374 7970 6528  with_sep.astype(
+000153f0: 6e70 2e75 696e 7438 290a 2020 2020 2020  np.uint8).      
+00015400: 2020 0a20 2020 2020 2020 2074 7279 3a0a    .        try:.
+00015410: 2020 2020 2020 2020 2020 2020 696d 675f              img_
+00015420: 6f6e 6c79 5f72 6567 696f 6e73 203d 2063  only_regions = c
+00015430: 7632 2e65 726f 6465 2869 6d67 5f6f 6e6c  v2.erode(img_onl
+00015440: 795f 7265 6769 6f6e 735f 7769 7468 5f73  y_regions_with_s
+00015450: 6570 5b3a 2c3a 5d2c 204b 4552 4e45 4c2c  ep[:,:], KERNEL,
+00015460: 2069 7465 7261 7469 6f6e 733d 3230 290a   iterations=20).
+00015470: 0a20 2020 2020 2020 2020 2020 205f 2c20  .            _, 
+00015480: 5f20 3d20 6669 6e64 5f6e 756d 5f63 6f6c  _ = find_num_col
+00015490: 2869 6d67 5f6f 6e6c 795f 7265 6769 6f6e  (img_only_region
+000154a0: 732c 206e 756d 5f63 6f6c 5f63 6c61 7373  s, num_col_class
+000154b0: 6966 6965 722c 2073 656c 662e 7461 626c  ifier, self.tabl
+000154c0: 6573 2c20 6d75 6c74 6970 6c69 6572 3d36  es, multiplier=6
+000154d0: 2e30 290a 2020 2020 2020 2020 2020 2020  .0).            
+000154e0: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
+000154f0: 203d 2072 6573 697a 655f 696d 6167 6528   = resize_image(
+00015500: 696d 675f 6f72 672c 2069 6e74 2869 6d67  img_org, int(img
+00015510: 5f6f 7267 2e73 6861 7065 5b30 5d29 2c20  _org.shape[0]), 
+00015520: 696e 7428 696d 675f 6f72 672e 7368 6170  int(img_org.shap
+00015530: 655b 315d 2a28 312e 3220 6966 2069 735f  e[1]*(1.2 if is_
+00015540: 696d 6167 655f 656e 6861 6e63 6564 2065  image_enhanced e
+00015550: 6c73 6520 3129 2929 0a20 2020 2020 2020  lse 1))).       
+00015560: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+00015570: 2020 6966 2073 656c 662e 6469 725f 696e    if self.dir_in
+00015580: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00015590: 2020 7072 6564 6963 7469 6f6e 5f72 6567    prediction_reg
+000155a0: 696f 6e73 5f6f 7267 203d 2073 656c 662e  ions_org = self.
+000155b0: 646f 5f70 7265 6469 6374 696f 6e28 5472  do_prediction(Tr
+000155c0: 7565 2c20 696d 672c 2073 656c 662e 6d6f  ue, img, self.mo
+000155d0: 6465 6c5f 7265 6769 6f6e 290a 2020 2020  del_region).    
+000155e0: 2020 2020 2020 2020 656c 7365 3a0a 2020          else:.  
+000155f0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00015600: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
+00015610: 5f6f 7267 203d 2073 656c 662e 646f 5f70  _org = self.do_p
+00015620: 7265 6469 6374 696f 6e28 5472 7565 2c20  rediction(True, 
+00015630: 696d 672c 206d 6f64 656c 5f72 6567 696f  img, model_regio
+00015640: 6e29 0a20 2020 2020 2020 2020 2020 2070  n).            p
+00015650: 7265 6469 6374 696f 6e5f 7265 6769 6f6e  rediction_region
+00015660: 735f 6f72 6720 3d20 7265 7369 7a65 5f69  s_org = resize_i
+00015670: 6d61 6765 2870 7265 6469 6374 696f 6e5f  mage(prediction_
+00015680: 7265 6769 6f6e 735f 6f72 672c 2069 6d67  regions_org, img
+00015690: 5f68 6569 6768 745f 682c 2069 6d67 5f77  _height_h, img_w
+000156a0: 6964 7468 5f68 2029 0a0a 2020 2020 2020  idth_h )..      
+000156b0: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
+000156c0: 5f72 6567 696f 6e73 5f6f 7267 3d70 7265  _regions_org=pre
+000156d0: 6469 6374 696f 6e5f 7265 6769 6f6e 735f  diction_regions_
+000156e0: 6f72 675b 3a2c 3a2c 305d 0a20 2020 2020  org[:,:,0].     
+000156f0: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
+00015700: 6e5f 7265 6769 6f6e 735f 6f72 675b 2870  n_regions_org[(p
+00015710: 7265 6469 6374 696f 6e5f 7265 6769 6f6e  rediction_region
+00015720: 735f 6f72 675b 3a2c 3a5d 3d3d 3129 2026  s_org[:,:]==1) &
+00015730: 2028 6d61 736b 5f7a 6572 6f73 5f79 5b3a   (mask_zeros_y[:
+00015740: 2c3a 5d3d 3d31 295d 3d30 0a20 2020 2020  ,:]==1)]=0.     
+00015750: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00015760: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+00015770: 2069 6620 6e6f 7420 7365 6c66 2e64 6972   if not self.dir
+00015780: 5f69 6e3a 0a20 2020 2020 2020 2020 2020  _in:.           
+00015790: 2020 2020 206d 6f64 656c 5f72 6567 696f       model_regio
+000157a0: 6e2c 2073 6573 7369 6f6e 5f72 6567 696f  n, session_regio
+000157b0: 6e20 3d20 7365 6c66 2e73 7461 7274 5f6e  n = self.start_n
+000157c0: 6577 5f73 6573 7369 6f6e 5f61 6e64 5f6d  ew_session_and_m
+000157d0: 6f64 656c 2873 656c 662e 6d6f 6465 6c5f  odel(self.model_
+000157e0: 7265 6769 6f6e 5f64 6972 5f70 3229 0a0a  region_dir_p2)..
+000157f0: 2020 2020 2020 2020 2020 2020 696d 6720              img 
+00015800: 3d20 7265 7369 7a65 5f69 6d61 6765 2869  = resize_image(i
+00015810: 6d67 5f6f 7267 2c20 696e 7428 696d 675f  mg_org, int(img_
+00015820: 6f72 672e 7368 6170 655b 305d 292c 2069  org.shape[0]), i
+00015830: 6e74 2869 6d67 5f6f 7267 2e73 6861 7065  nt(img_org.shape
+00015840: 5b31 5d29 290a 2020 2020 2020 2020 2020  [1])).          
+00015850: 2020 0a20 2020 2020 2020 2020 2020 2069    .            i
+00015860: 6620 7365 6c66 2e64 6972 5f69 6e3a 0a20  f self.dir_in:. 
+00015870: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00015880: 7265 6469 6374 696f 6e5f 7265 6769 6f6e  rediction_region
+00015890: 735f 6f72 6732 203d 2073 656c 662e 646f  s_org2 = self.do
+000158a0: 5f70 7265 6469 6374 696f 6e28 5472 7565  _prediction(True
+000158b0: 2c20 696d 672c 2073 656c 662e 6d6f 6465  , img, self.mode
+000158c0: 6c5f 7265 6769 6f6e 5f70 322c 2030 2e32  l_region_p2, 0.2
+000158d0: 290a 2020 2020 2020 2020 2020 2020 656c  ).            el
+000158e0: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+000158f0: 2020 2020 7072 6564 6963 7469 6f6e 5f72      prediction_r
+00015900: 6567 696f 6e73 5f6f 7267 3220 3d20 7365  egions_org2 = se
+00015910: 6c66 2e64 6f5f 7072 6564 6963 7469 6f6e  lf.do_prediction
+00015920: 2854 7275 652c 2069 6d67 2c20 6d6f 6465  (True, img, mode
+00015930: 6c5f 7265 6769 6f6e 2c20 302e 3229 0a20  l_region, 0.2). 
+00015940: 2020 2020 2020 2020 2020 2070 7265 6469             predi
+00015950: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
+00015960: 6732 3d72 6573 697a 655f 696d 6167 6528  g2=resize_image(
+00015970: 7072 6564 6963 7469 6f6e 5f72 6567 696f  prediction_regio
+00015980: 6e73 5f6f 7267 322c 2069 6d67 5f68 6569  ns_org2, img_hei
+00015990: 6768 745f 682c 2069 6d67 5f77 6964 7468  ght_h, img_width
+000159a0: 5f68 2029 0a0a 0a20 2020 2020 2020 2020  _h )...         
+000159b0: 2020 206d 6173 6b5f 7a65 726f 7332 203d     mask_zeros2 =
+000159c0: 2028 7072 6564 6963 7469 6f6e 5f72 6567   (prediction_reg
+000159d0: 696f 6e73 5f6f 7267 325b 3a2c 3a2c 305d  ions_org2[:,:,0]
+000159e0: 203d 3d20 3029 0a20 2020 2020 2020 2020   == 0).         
+000159f0: 2020 206d 6173 6b5f 6c69 6e65 7332 203d     mask_lines2 =
+00015a00: 2028 7072 6564 6963 7469 6f6e 5f72 6567   (prediction_reg
+00015a10: 696f 6e73 5f6f 7267 325b 3a2c 3a2c 305d  ions_org2[:,:,0]
+00015a20: 203d 3d20 3329 0a20 2020 2020 2020 2020   == 3).         
+00015a30: 2020 2074 6578 745f 7375 6d65 5f65 6172     text_sume_ear
+00015a40: 6c79 203d 2028 7072 6564 6963 7469 6f6e  ly = (prediction
+00015a50: 5f72 6567 696f 6e73 5f6f 7267 5b3a 2c3a  _regions_org[:,:
+00015a60: 5d20 3d3d 2031 292e 7375 6d28 290a 2020  ] == 1).sum().  
+00015a70: 2020 2020 2020 2020 2020 7072 6564 6963            predic
+00015a80: 7469 6f6e 5f72 6567 696f 6e73 5f6f 7267  tion_regions_org
+00015a90: 5f63 6f70 7920 3d20 6e70 2e63 6f70 7928  _copy = np.copy(
+00015aa0: 7072 6564 6963 7469 6f6e 5f72 6567 696f  prediction_regio
+00015ab0: 6e73 5f6f 7267 290a 2020 2020 2020 2020  ns_org).        
+00015ac0: 2020 2020 7072 6564 6963 7469 6f6e 5f72      prediction_r
+00015ad0: 6567 696f 6e73 5f6f 7267 5f63 6f70 795b  egions_org_copy[
+00015ae0: 2870 7265 6469 6374 696f 6e5f 7265 6769  (prediction_regi
+00015af0: 6f6e 735f 6f72 675f 636f 7079 5b3a 2c3a  ons_org_copy[:,:
+00015b00: 5d3d 3d31 2920 2620 286d 6173 6b5f 7a65  ]==1) & (mask_ze
+00015b10: 726f 7332 5b3a 2c3a 5d3d 3d31 295d 203d  ros2[:,:]==1)] =
+00015b20: 2030 0a20 2020 2020 2020 2020 2020 2074   0.            t
+00015b30: 6578 745f 7375 6d65 5f73 6563 6f6e 6420  ext_sume_second 
+00015b40: 3d20 2828 7072 6564 6963 7469 6f6e 5f72  = ((prediction_r
+00015b50: 6567 696f 6e73 5f6f 7267 5f63 6f70 795b  egions_org_copy[
+00015b60: 3a2c 3a5d 3d3d 3129 2a31 292e 7375 6d28  :,:]==1)*1).sum(
+00015b70: 290a 0a20 2020 2020 2020 2020 2020 2072  )..            r
+00015b80: 6174 655f 7477 6f5f 6d6f 6465 6c73 203d  ate_two_models =
+00015b90: 2074 6578 745f 7375 6d65 5f73 6563 6f6e   text_sume_secon
+00015ba0: 6420 2f20 666c 6f61 7428 7465 7874 5f73  d / float(text_s
+00015bb0: 756d 655f 6561 726c 7929 202a 2031 3030  ume_early) * 100
+00015bc0: 0a0a 2020 2020 2020 2020 2020 2020 7365  ..            se
+00015bd0: 6c66 2e6c 6f67 6765 722e 696e 666f 2822  lf.logger.info("
+00015be0: 7261 7469 6f5f 6f66 5f74 776f 5f6d 6f64  ratio_of_two_mod
+00015bf0: 656c 733a 2025 7322 2c20 7261 7465 5f74  els: %s", rate_t
+00015c00: 776f 5f6d 6f64 656c 7329 0a20 2020 2020  wo_models).     
+00015c10: 2020 2020 2020 2069 6620 6e6f 7428 6973         if not(is
+00015c20: 5f69 6d61 6765 5f65 6e68 616e 6365 6420  _image_enhanced 
+00015c30: 616e 6420 7261 7465 5f74 776f 5f6d 6f64  and rate_two_mod
+00015c40: 656c 7320 3c20 5241 5449 4f5f 4f46 5f54  els < RATIO_OF_T
+00015c50: 574f 5f4d 4f44 454c 5f54 4852 4553 484f  WO_MODEL_THRESHO
+00015c60: 4c44 293a 0a20 2020 2020 2020 2020 2020  LD):.           
+00015c70: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
+00015c80: 7265 6769 6f6e 735f 6f72 6720 3d20 6e70  regions_org = np
+00015c90: 2e63 6f70 7928 7072 6564 6963 7469 6f6e  .copy(prediction
+00015ca0: 5f72 6567 696f 6e73 5f6f 7267 5f63 6f70  _regions_org_cop
+00015cb0: 7929 0a20 2020 2020 2020 2020 2020 2020  y).             
+00015cc0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+00015cd0: 0a0a 2020 2020 2020 2020 2020 2020 7072  ..            pr
+00015ce0: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
+00015cf0: 5f6f 7267 5b28 6d61 736b 5f6c 696e 6573  _org[(mask_lines
+00015d00: 325b 3a2c 3a5d 3d3d 3129 2026 2028 7072  2[:,:]==1) & (pr
+00015d10: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
+00015d20: 5f6f 7267 5b3a 2c3a 5d3d 3d30 295d 3d33  _org[:,:]==0)]=3
+00015d30: 0a20 2020 2020 2020 2020 2020 206d 6173  .            mas
+00015d40: 6b5f 6c69 6e65 735f 6f6e 6c79 3d28 7072  k_lines_only=(pr
+00015d50: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
+00015d60: 5f6f 7267 5b3a 2c3a 5d3d 3d33 292a 310a  _org[:,:]==3)*1.
+00015d70: 2020 2020 2020 2020 2020 2020 7072 6564              pred
+00015d80: 6963 7469 6f6e 5f72 6567 696f 6e73 5f6f  iction_regions_o
+00015d90: 7267 203d 2063 7632 2e65 726f 6465 2870  rg = cv2.erode(p
+00015da0: 7265 6469 6374 696f 6e5f 7265 6769 6f6e  rediction_region
+00015db0: 735f 6f72 675b 3a2c 3a5d 2c20 4b45 524e  s_org[:,:], KERN
+00015dc0: 454c 2c20 6974 6572 6174 696f 6e73 3d32  EL, iterations=2
+00015dd0: 290a 0a0a 2020 2020 2020 2020 2020 2020  )...            
+00015de0: 7072 6564 6963 7469 6f6e 5f72 6567 696f  prediction_regio
+00015df0: 6e73 5f6f 7267 203d 2063 7632 2e64 696c  ns_org = cv2.dil
+00015e00: 6174 6528 7072 6564 6963 7469 6f6e 5f72  ate(prediction_r
+00015e10: 6567 696f 6e73 5f6f 7267 5b3a 2c3a 5d2c  egions_org[:,:],
+00015e20: 204b 4552 4e45 4c2c 2069 7465 7261 7469   KERNEL, iterati
+00015e30: 6f6e 733d 3229 0a20 2020 2020 2020 2020  ons=2).         
+00015e40: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+00015e50: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00015e60: 7261 7465 5f74 776f 5f6d 6f64 656c 733c  rate_two_models<
+00015e70: 3d34 303a 0a20 2020 2020 2020 2020 2020  =40:.           
+00015e80: 2020 2020 2069 6620 7365 6c66 2e69 6e70       if self.inp
+00015e90: 7574 5f62 696e 6172 793a 0a20 2020 2020  ut_binary:.     
+00015ea0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00015eb0: 7265 6469 6374 696f 6e5f 6269 6e20 3d20  rediction_bin = 
+00015ec0: 6e70 2e63 6f70 7928 696d 675f 6f72 6729  np.copy(img_org)
+00015ed0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015ee0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00015ef0: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00015f00: 7420 7365 6c66 2e64 6972 5f69 6e3a 0a20  t self.dir_in:. 
+00015f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00015f20: 2020 2020 2020 206d 6f64 656c 5f62 696e         model_bin
+00015f30: 2c20 7365 7373 696f 6e5f 6269 6e20 3d20  , session_bin = 
+00015f40: 7365 6c66 2e73 7461 7274 5f6e 6577 5f73  self.start_new_s
+00015f50: 6573 7369 6f6e 5f61 6e64 5f6d 6f64 656c  ession_and_model
+00015f60: 2873 656c 662e 6d6f 6465 6c5f 6469 725f  (self.model_dir_
+00015f70: 6f66 5f62 696e 6172 697a 6174 696f 6e29  of_binarization)
+00015f80: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00015f90: 2020 2020 2020 2020 2070 7265 6469 6374           predict
+00015fa0: 696f 6e5f 6269 6e20 3d20 7365 6c66 2e64  ion_bin = self.d
+00015fb0: 6f5f 7072 6564 6963 7469 6f6e 2854 7275  o_prediction(Tru
+00015fc0: 652c 2069 6d67 5f6f 7267 2c20 6d6f 6465  e, img_org, mode
+00015fd0: 6c5f 6269 6e29 0a20 2020 2020 2020 2020  l_bin).         
+00015fe0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00015ff0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016000: 2020 2020 2020 2020 2070 7265 6469 6374           predict
+00016010: 696f 6e5f 6269 6e20 3d20 7365 6c66 2e64  ion_bin = self.d
+00016020: 6f5f 7072 6564 6963 7469 6f6e 2854 7275  o_prediction(Tru
+00016030: 652c 2069 6d67 5f6f 7267 2c20 7365 6c66  e, img_org, self
+00016040: 2e6d 6f64 656c 5f62 696e 290a 2020 2020  .model_bin).    
+00016050: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016060: 7072 6564 6963 7469 6f6e 5f62 696e 203d  prediction_bin =
+00016070: 2072 6573 697a 655f 696d 6167 6528 7072   resize_image(pr
+00016080: 6564 6963 7469 6f6e 5f62 696e 2c20 696d  ediction_bin, im
+00016090: 675f 6865 6967 6874 5f68 2c20 696d 675f  g_height_h, img_
+000160a0: 7769 6474 685f 6820 290a 2020 2020 2020  width_h ).      
+000160b0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+000160c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000160d0: 2020 2070 7265 6469 6374 696f 6e5f 6269     prediction_bi
+000160e0: 6e3d 7072 6564 6963 7469 6f6e 5f62 696e  n=prediction_bin
+000160f0: 5b3a 2c3a 2c30 5d0a 2020 2020 2020 2020  [:,:,0].        
+00016100: 2020 2020 2020 2020 2020 2020 7072 6564              pred
+00016110: 6963 7469 6f6e 5f62 696e 203d 2028 7072  iction_bin = (pr
+00016120: 6564 6963 7469 6f6e 5f62 696e 5b3a 2c3a  ediction_bin[:,:
+00016130: 5d3d 3d30 292a 310a 2020 2020 2020 2020  ]==0)*1.        
+00016140: 2020 2020 2020 2020 2020 2020 7072 6564              pred
+00016150: 6963 7469 6f6e 5f62 696e 203d 2070 7265  iction_bin = pre
+00016160: 6469 6374 696f 6e5f 6269 6e2a 3235 350a  diction_bin*255.
+00016170: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00016180: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+00016190: 2020 2020 2020 2020 2070 7265 6469 6374           predict
+000161a0: 696f 6e5f 6269 6e20 3d6e 702e 7265 7065  ion_bin =np.repe
+000161b0: 6174 2870 7265 6469 6374 696f 6e5f 6269  at(prediction_bi
+000161c0: 6e5b 3a2c 203a 2c20 6e70 2e6e 6577 6178  n[:, :, np.newax
+000161d0: 6973 5d2c 2033 2c20 6178 6973 3d32 290a  is], 3, axis=2).
+000161e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000161f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016200: 2069 6620 6e6f 7420 7365 6c66 2e64 6972   if not self.dir
+00016210: 5f69 6e3a 0a20 2020 2020 2020 2020 2020  _in:.           
+00016220: 2020 2020 2020 2020 206d 6f64 656c 5f72           model_r
+00016230: 6567 696f 6e2c 2073 6573 7369 6f6e 5f72  egion, session_r
+00016240: 6567 696f 6e20 3d20 7365 6c66 2e73 7461  egion = self.sta
+00016250: 7274 5f6e 6577 5f73 6573 7369 6f6e 5f61  rt_new_session_a
+00016260: 6e64 5f6d 6f64 656c 2873 656c 662e 6d6f  nd_model(self.mo
+00016270: 6465 6c5f 7265 6769 6f6e 5f64 6972 5f70  del_region_dir_p
+00016280: 5f65 6e73 290a 2020 2020 2020 2020 2020  _ens).          
+00016290: 2020 2020 2020 7261 7469 6f5f 793d 310a        ratio_y=1.
+000162a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000162b0: 7261 7469 6f5f 783d 310a 0a0a 2020 2020  ratio_x=1...    
+000162c0: 2020 2020 2020 2020 2020 2020 696d 6720              img 
+000162d0: 3d20 7265 7369 7a65 5f69 6d61 6765 2870  = resize_image(p
+000162e0: 7265 6469 6374 696f 6e5f 6269 6e2c 2069  rediction_bin, i
+000162f0: 6e74 2869 6d67 5f6f 7267 2e73 6861 7065  nt(img_org.shape
+00016300: 5b30 5d2a 7261 7469 6f5f 7929 2c20 696e  [0]*ratio_y), in
+00016310: 7428 696d 675f 6f72 672e 7368 6170 655b  t(img_org.shape[
+00016320: 315d 2a72 6174 696f 5f78 2929 0a20 2020  1]*ratio_x)).   
+00016330: 2020 2020 2020 2020 2020 2020 200a 2020               .  
+00016340: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00016350: 206e 6f74 2073 656c 662e 6469 725f 696e   not self.dir_in
+00016360: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00016370: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
+00016380: 5f72 6567 696f 6e73 5f6f 7267 203d 2073  _regions_org = s
+00016390: 656c 662e 646f 5f70 7265 6469 6374 696f  elf.do_predictio
+000163a0: 6e28 5472 7565 2c20 696d 672c 206d 6f64  n(True, img, mod
+000163b0: 656c 5f72 6567 696f 6e29 0a20 2020 2020  el_region).     
+000163c0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000163d0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000163e0: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
+000163f0: 7265 6769 6f6e 735f 6f72 6720 3d20 7365  regions_org = se
+00016400: 6c66 2e64 6f5f 7072 6564 6963 7469 6f6e  lf.do_prediction
+00016410: 2854 7275 652c 2069 6d67 2c20 7365 6c66  (True, img, self
+00016420: 2e6d 6f64 656c 5f72 6567 696f 6e29 0a20  .model_region). 
+00016430: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00016440: 7265 6469 6374 696f 6e5f 7265 6769 6f6e  rediction_region
+00016450: 735f 6f72 6720 3d20 7265 7369 7a65 5f69  s_org = resize_i
+00016460: 6d61 6765 2870 7265 6469 6374 696f 6e5f  mage(prediction_
+00016470: 7265 6769 6f6e 735f 6f72 672c 2069 6d67  regions_org, img
+00016480: 5f68 6569 6768 745f 682c 2069 6d67 5f77  _height_h, img_w
+00016490: 6964 7468 5f68 2029 0a20 2020 2020 2020  idth_h ).       
+000164a0: 2020 2020 2020 2020 2070 7265 6469 6374           predict
+000164b0: 696f 6e5f 7265 6769 6f6e 735f 6f72 673d  ion_regions_org=
+000164c0: 7072 6564 6963 7469 6f6e 5f72 6567 696f  prediction_regio
+000164d0: 6e73 5f6f 7267 5b3a 2c3a 2c30 5d0a 2020  ns_org[:,:,0].  
+000164e0: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+000164f0: 2020 2020 2020 2020 2020 2020 2020 206d                 m
+00016500: 6173 6b5f 6c69 6e65 735f 6f6e 6c79 3d28  ask_lines_only=(
+00016510: 7072 6564 6963 7469 6f6e 5f72 6567 696f  prediction_regio
+00016520: 6e73 5f6f 7267 5b3a 2c3a 5d3d 3d33 292a  ns_org[:,:]==3)*
+00016530: 310a 2020 2020 2020 2020 2020 2020 2020  1.              
+00016540: 2020 0a20 2020 2020 2020 2020 2020 206d    .            m
+00016550: 6173 6b5f 7465 7874 735f 6f6e 6c79 3d28  ask_texts_only=(
+00016560: 7072 6564 6963 7469 6f6e 5f72 6567 696f  prediction_regio
+00016570: 6e73 5f6f 7267 5b3a 2c3a 5d3d 3d31 292a  ns_org[:,:]==1)*
+00016580: 310a 2020 2020 2020 2020 2020 2020 6d61  1.            ma
+00016590: 736b 5f69 6d61 6765 735f 6f6e 6c79 3d28  sk_images_only=(
+000165a0: 7072 6564 6963 7469 6f6e 5f72 6567 696f  prediction_regio
+000165b0: 6e73 5f6f 7267 5b3a 2c3a 5d3d 3d32 292a  ns_org[:,:]==2)*
+000165c0: 310a 2020 2020 2020 2020 2020 2020 0a20  1.            . 
+000165d0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+000165e0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000165f0: 2020 2020 2070 6f6c 7967 6f6e 735f 6c69       polygons_li
+00016600: 6e65 735f 786d 6c2c 2068 6972 5f6c 696e  nes_xml, hir_lin
+00016610: 6573 5f78 6d6c 203d 2072 6574 7572 6e5f  es_xml = return_
+00016620: 636f 6e74 6f75 7273 5f6f 665f 696d 6167  contours_of_imag
+00016630: 6528 6d61 736b 5f6c 696e 6573 5f6f 6e6c  e(mask_lines_onl
+00016640: 7929 0a20 2020 2020 2020 2020 2020 2070  y).            p
+00016650: 6f6c 7967 6f6e 735f 6c69 6e65 735f 786d  olygons_lines_xm
+00016660: 6c20 3d20 7465 7874 6c69 6e65 5f63 6f6e  l = textline_con
+00016670: 5f66 696c 203d 2066 696c 7465 725f 636f  _fil = filter_co
+00016680: 6e74 6f75 7273 5f61 7265 615f 6f66 5f69  ntours_area_of_i
+00016690: 6d61 6765 286d 6173 6b5f 6c69 6e65 735f  mage(mask_lines_
+000166a0: 6f6e 6c79 2c20 706f 6c79 676f 6e73 5f6c  only, polygons_l
+000166b0: 696e 6573 5f78 6d6c 2c20 6869 725f 6c69  ines_xml, hir_li
+000166c0: 6e65 735f 786d 6c2c 206d 6178 5f61 7265  nes_xml, max_are
+000166d0: 613d 312c 206d 696e 5f61 7265 613d 302e  a=1, min_area=0.
+000166e0: 3030 3030 3129 0a0a 2020 2020 2020 2020  00001)..        
+000166f0: 2020 2020 706f 6c79 676f 6e73 5f6f 665f      polygons_of_
+00016700: 6f6e 6c79 5f74 6578 7473 203d 2072 6574  only_texts = ret
+00016710: 7572 6e5f 636f 6e74 6f75 7273 5f6f 665f  urn_contours_of_
+00016720: 696e 7465 7265 7374 6564 5f72 6567 696f  interested_regio
+00016730: 6e28 6d61 736b 5f74 6578 7473 5f6f 6e6c  n(mask_texts_onl
+00016740: 792c 2031 2c20 302e 3030 3030 3129 0a20  y, 1, 0.00001). 
+00016750: 2020 2020 2020 2020 2020 2070 6f6c 7967             polyg
+00016760: 6f6e 735f 6f66 5f6f 6e6c 795f 6c69 6e65  ons_of_only_line
+00016770: 7320 3d20 7265 7475 726e 5f63 6f6e 746f  s = return_conto
+00016780: 7572 735f 6f66 5f69 6e74 6572 6573 7465  urs_of_intereste
+00016790: 645f 7265 6769 6f6e 286d 6173 6b5f 6c69  d_region(mask_li
+000167a0: 6e65 735f 6f6e 6c79 2c20 312c 2030 2e30  nes_only, 1, 0.0
+000167b0: 3030 3031 290a 0a20 2020 2020 2020 2020  0001)..         
+000167c0: 2020 2074 6578 745f 7265 6769 6f6e 735f     text_regions_
+000167d0: 705f 7472 7565 203d 206e 702e 7a65 726f  p_true = np.zero
+000167e0: 7328 7072 6564 6963 7469 6f6e 5f72 6567  s(prediction_reg
+000167f0: 696f 6e73 5f6f 7267 2e73 6861 7065 290a  ions_org.shape).
+00016800: 2020 2020 2020 2020 2020 2020 7465 7874              text
+00016810: 5f72 6567 696f 6e73 5f70 5f74 7275 6520  _regions_p_true 
+00016820: 3d20 6376 322e 6669 6c6c 506f 6c79 2874  = cv2.fillPoly(t
+00016830: 6578 745f 7265 6769 6f6e 735f 705f 7472  ext_regions_p_tr
+00016840: 7565 2c70 7473 203d 2070 6f6c 7967 6f6e  ue,pts = polygon
+00016850: 735f 6f66 5f6f 6e6c 795f 6c69 6e65 732c  s_of_only_lines,
+00016860: 2063 6f6c 6f72 3d28 332c 2033 2c20 3329   color=(3, 3, 3)
+00016870: 290a 2020 2020 2020 2020 2020 2020 7465  ).            te
+00016880: 7874 5f72 6567 696f 6e73 5f70 5f74 7275  xt_regions_p_tru
+00016890: 655b 3a2c 3a5d 5b6d 6173 6b5f 696d 6167  e[:,:][mask_imag
+000168a0: 6573 5f6f 6e6c 795b 3a2c 3a5d 203d 3d20  es_only[:,:] == 
+000168b0: 315d 203d 2032 0a0a 2020 2020 2020 2020  1] = 2..        
+000168c0: 2020 2020 7465 7874 5f72 6567 696f 6e73      text_regions
+000168d0: 5f70 5f74 7275 653d 6376 322e 6669 6c6c  _p_true=cv2.fill
+000168e0: 506f 6c79 2874 6578 745f 7265 6769 6f6e  Poly(text_region
+000168f0: 735f 705f 7472 7565 2c70 7473 3d70 6f6c  s_p_true,pts=pol
+00016900: 7967 6f6e 735f 6f66 5f6f 6e6c 795f 7465  ygons_of_only_te
+00016910: 7874 732c 2063 6f6c 6f72 3d28 312c 312c  xts, color=(1,1,
+00016920: 3129 290a 0a20 2020 2020 2020 2020 2020  1))..           
+00016930: 2072 6574 7572 6e20 7465 7874 5f72 6567   return text_reg
+00016940: 696f 6e73 5f70 5f74 7275 652c 2065 726f  ions_p_true, ero
+00016950: 7369 6f6e 5f68 7572 7473 2c20 706f 6c79  sion_hurts, poly
+00016960: 676f 6e73 5f6c 696e 6573 5f78 6d6c 0a20  gons_lines_xml. 
+00016970: 2020 2020 2020 2065 7863 6570 743a 0a20         except:. 
+00016980: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00016990: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+000169a0: 696e 7075 745f 6269 6e61 7279 3a0a 2020  input_binary:.  
+000169b0: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+000169c0: 6564 6963 7469 6f6e 5f62 696e 203d 206e  ediction_bin = n
+000169d0: 702e 636f 7079 2869 6d67 5f6f 7267 290a  p.copy(img_org).
+000169e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000169f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016a00: 2069 6620 6e6f 7420 7365 6c66 2e64 6972   if not self.dir
+00016a10: 5f69 6e3a 0a20 2020 2020 2020 2020 2020  _in:.           
+00016a20: 2020 2020 2020 2020 206d 6f64 656c 5f62           model_b
+00016a30: 696e 2c20 7365 7373 696f 6e5f 6269 6e20  in, session_bin 
+00016a40: 3d20 7365 6c66 2e73 7461 7274 5f6e 6577  = self.start_new
+00016a50: 5f73 6573 7369 6f6e 5f61 6e64 5f6d 6f64  _session_and_mod
+00016a60: 656c 2873 656c 662e 6d6f 6465 6c5f 6469  el(self.model_di
+00016a70: 725f 6f66 5f62 696e 6172 697a 6174 696f  r_of_binarizatio
+00016a80: 6e29 0a20 2020 2020 2020 2020 2020 2020  n).             
+00016a90: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
+00016aa0: 6e5f 6269 6e20 3d20 7365 6c66 2e64 6f5f  n_bin = self.do_
+00016ab0: 7072 6564 6963 7469 6f6e 2854 7275 652c  prediction(True,
+00016ac0: 2069 6d67 5f6f 7267 2c20 6d6f 6465 6c5f   img_org, model_
+00016ad0: 6269 6e29 0a20 2020 2020 2020 2020 2020  bin).           
+00016ae0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00016af0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00016b00: 7265 6469 6374 696f 6e5f 6269 6e20 3d20  rediction_bin = 
+00016b10: 7365 6c66 2e64 6f5f 7072 6564 6963 7469  self.do_predicti
+00016b20: 6f6e 2854 7275 652c 2069 6d67 5f6f 7267  on(True, img_org
+00016b30: 2c20 7365 6c66 2e6d 6f64 656c 5f62 696e  , self.model_bin
+00016b40: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00016b50: 2020 7072 6564 6963 7469 6f6e 5f62 696e    prediction_bin
+00016b60: 203d 2072 6573 697a 655f 696d 6167 6528   = resize_image(
+00016b70: 7072 6564 6963 7469 6f6e 5f62 696e 2c20  prediction_bin, 
+00016b80: 696d 675f 6865 6967 6874 5f68 2c20 696d  img_height_h, im
+00016b90: 675f 7769 6474 685f 6820 290a 2020 2020  g_width_h ).    
+00016ba0: 2020 2020 2020 2020 2020 2020 7072 6564              pred
+00016bb0: 6963 7469 6f6e 5f62 696e 3d70 7265 6469  iction_bin=predi
+00016bc0: 6374 696f 6e5f 6269 6e5b 3a2c 3a2c 305d  ction_bin[:,:,0]
+00016bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016be0: 200a 2020 2020 2020 2020 2020 2020 2020   .              
+00016bf0: 2020 7072 6564 6963 7469 6f6e 5f62 696e    prediction_bin
+00016c00: 203d 2028 7072 6564 6963 7469 6f6e 5f62   = (prediction_b
+00016c10: 696e 5b3a 2c3a 5d3d 3d30 292a 310a 2020  in[:,:]==0)*1.  
+00016c20: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+00016c30: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00016c40: 7265 6469 6374 696f 6e5f 6269 6e20 3d20  rediction_bin = 
+00016c50: 7072 6564 6963 7469 6f6e 5f62 696e 2a32  prediction_bin*2
+00016c60: 3535 0a20 2020 2020 2020 2020 2020 2020  55.             
+00016c70: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+00016c80: 2020 2020 7072 6564 6963 7469 6f6e 5f62      prediction_b
+00016c90: 696e 203d 6e70 2e72 6570 6561 7428 7072  in =np.repeat(pr
+00016ca0: 6564 6963 7469 6f6e 5f62 696e 5b3a 2c20  ediction_bin[:, 
+00016cb0: 3a2c 206e 702e 6e65 7761 7869 735d 2c20  :, np.newaxis], 
+00016cc0: 332c 2061 7869 733d 3229 0a20 2020 2020  3, axis=2).     
+00016cd0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00016ce0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+00016cf0: 2020 2020 2069 6620 6e6f 7420 7365 6c66       if not self
+00016d00: 2e64 6972 5f69 6e3a 0a20 2020 2020 2020  .dir_in:.       
+00016d10: 2020 2020 2020 2020 2020 2020 206d 6f64               mod
+00016d20: 656c 5f72 6567 696f 6e2c 2073 6573 7369  el_region, sessi
+00016d30: 6f6e 5f72 6567 696f 6e20 3d20 7365 6c66  on_region = self
+00016d40: 2e73 7461 7274 5f6e 6577 5f73 6573 7369  .start_new_sessi
+00016d50: 6f6e 5f61 6e64 5f6d 6f64 656c 2873 656c  on_and_model(sel
+00016d60: 662e 6d6f 6465 6c5f 7265 6769 6f6e 5f64  f.model_region_d
+00016d70: 6972 5f70 5f65 6e73 290a 2020 2020 2020  ir_p_ens).      
+00016d80: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+00016d90: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00016da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00016db0: 2070 7265 6469 6374 696f 6e5f 6269 6e20   prediction_bin 
+00016dc0: 3d20 6e70 2e63 6f70 7928 696d 675f 6f72  = np.copy(img_or
+00016dd0: 6729 0a20 2020 2020 2020 2020 2020 2072  g).            r
+00016de0: 6174 696f 5f79 3d31 0a20 2020 2020 2020  atio_y=1.       
+00016df0: 2020 2020 2072 6174 696f 5f78 3d31 0a0a       ratio_x=1..
+00016e00: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
+00016e10: 203d 2072 6573 697a 655f 696d 6167 6528   = resize_image(
+00016e20: 7072 6564 6963 7469 6f6e 5f62 696e 2c20  prediction_bin, 
+00016e30: 696e 7428 696d 675f 6f72 672e 7368 6170  int(img_org.shap
+00016e40: 655b 305d 2a72 6174 696f 5f79 292c 2069  e[0]*ratio_y), i
+00016e50: 6e74 2869 6d67 5f6f 7267 2e73 6861 7065  nt(img_org.shape
+00016e60: 5b31 5d2a 7261 7469 6f5f 7829 290a 2020  [1]*ratio_x)).  
+00016e70: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+00016e80: 2073 656c 662e 6469 725f 696e 3a0a 2020   self.dir_in:.  
+00016e90: 2020 2020 2020 2020 2020 2020 2020 7072                pr
+00016ea0: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
+00016eb0: 5f6f 7267 203d 2073 656c 662e 646f 5f70  _org = self.do_p
+00016ec0: 7265 6469 6374 696f 6e28 5472 7565 2c20  rediction(True, 
+00016ed0: 696d 672c 206d 6f64 656c 5f72 6567 696f  img, model_regio
+00016ee0: 6e29 0a20 2020 2020 2020 2020 2020 2065  n).            e
+00016ef0: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00016f00: 2020 2020 2070 7265 6469 6374 696f 6e5f       prediction_
+00016f10: 7265 6769 6f6e 735f 6f72 6720 3d20 7365  regions_org = se
+00016f20: 6c66 2e64 6f5f 7072 6564 6963 7469 6f6e  lf.do_prediction
+00016f30: 2854 7275 652c 2069 6d67 2c20 7365 6c66  (True, img, self
+00016f40: 2e6d 6f64 656c 5f72 6567 696f 6e29 0a20  .model_region). 
+00016f50: 2020 2020 2020 2020 2020 2070 7265 6469             predi
+00016f60: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
+00016f70: 6720 3d20 7265 7369 7a65 5f69 6d61 6765  g = resize_image
+00016f80: 2870 7265 6469 6374 696f 6e5f 7265 6769  (prediction_regi
+00016f90: 6f6e 735f 6f72 672c 2069 6d67 5f68 6569  ons_org, img_hei
+00016fa0: 6768 745f 682c 2069 6d67 5f77 6964 7468  ght_h, img_width
+00016fb0: 5f68 2029 0a20 2020 2020 2020 2020 2020  _h ).           
+00016fc0: 2070 7265 6469 6374 696f 6e5f 7265 6769   prediction_regi
+00016fd0: 6f6e 735f 6f72 673d 7072 6564 6963 7469  ons_org=predicti
+00016fe0: 6f6e 5f72 6567 696f 6e73 5f6f 7267 5b3a  on_regions_org[:
+00016ff0: 2c3a 2c30 5d0a 2020 2020 2020 2020 2020  ,:,0].          
+00017000: 2020 0a20 2020 2020 2020 2020 2020 2023    .            #
+00017010: 6d61 736b 5f6c 696e 6573 5f6f 6e6c 793d  mask_lines_only=
+00017020: 2870 7265 6469 6374 696f 6e5f 7265 6769  (prediction_regi
+00017030: 6f6e 735f 6f72 675b 3a2c 3a5d 3d3d 3329  ons_org[:,:]==3)
+00017040: 2a31 0a20 2020 2020 2020 2020 2020 2023  *1.            #
+00017050: 696d 6720 3d20 7265 7369 7a65 5f69 6d61  img = resize_ima
+00017060: 6765 2869 6d67 5f6f 7267 2c20 696e 7428  ge(img_org, int(
+00017070: 696d 675f 6f72 672e 7368 6170 655b 305d  img_org.shape[0]
+00017080: 2a31 292c 2069 6e74 2869 6d67 5f6f 7267  *1), int(img_org
+00017090: 2e73 6861 7065 5b31 5d2a 3129 290a 2020  .shape[1]*1)).  
+000170a0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+000170b0: 2020 2020 2020 2023 7072 6564 6963 7469         #predicti
+000170c0: 6f6e 5f72 6567 696f 6e73 5f6f 7267 203d  on_regions_org =
+000170d0: 2073 656c 662e 646f 5f70 7265 6469 6374   self.do_predict
+000170e0: 696f 6e28 5472 7565 2c20 696d 672c 206d  ion(True, img, m
+000170f0: 6f64 656c 5f72 6567 696f 6e29 0a20 2020  odel_region).   
+00017100: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+00017110: 2020 2020 2020 2370 7265 6469 6374 696f        #predictio
+00017120: 6e5f 7265 6769 6f6e 735f 6f72 6720 3d20  n_regions_org = 
+00017130: 7265 7369 7a65 5f69 6d61 6765 2870 7265  resize_image(pre
+00017140: 6469 6374 696f 6e5f 7265 6769 6f6e 735f  diction_regions_
+00017150: 6f72 672c 2069 6d67 5f68 6569 6768 745f  org, img_height_
+00017160: 682c 2069 6d67 5f77 6964 7468 5f68 2029  h, img_width_h )
+00017170: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+00017180: 2020 2020 2020 2020 2020 2370 7265 6469            #predi
+00017190: 6374 696f 6e5f 7265 6769 6f6e 735f 6f72  ction_regions_or
+000171a0: 6720 3d20 7072 6564 6963 7469 6f6e 5f72  g = prediction_r
+000171b0: 6567 696f 6e73 5f6f 7267 5b3a 2c3a 2c30  egions_org[:,:,0
+000171c0: 5d0a 2020 2020 2020 2020 2020 2020 0a20  ].            . 
+000171d0: 2020 2020 2020 2020 2020 2023 7072 6564             #pred
+000171e0: 6963 7469 6f6e 5f72 6567 696f 6e73 5f6f  iction_regions_o
+000171f0: 7267 5b28 7072 6564 6963 7469 6f6e 5f72  rg[(prediction_r
+00017200: 6567 696f 6e73 5f6f 7267 5b3a 2c3a 5d20  egions_org[:,:] 
+00017210: 3d3d 2031 2920 2620 286d 6173 6b5f 7a65  == 1) & (mask_ze
+00017220: 726f 735f 795b 3a2c 3a5d 203d 3d20 3129  ros_y[:,:] == 1)
+00017230: 5d3d 300a 2020 2020 2020 2020 2020 2020  ]=0.            
+00017240: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+00017250: 2020 2020 2020 2020 2020 6d61 736b 5f6c            mask_l
+00017260: 696e 6573 5f6f 6e6c 7920 3d20 2870 7265  ines_only = (pre
+00017270: 6469 6374 696f 6e5f 7265 6769 6f6e 735f  diction_regions_
+00017280: 6f72 675b 3a2c 3a5d 203d 3d33 292a 310a  org[:,:] ==3)*1.
+00017290: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+000172a0: 2020 2020 2020 2020 206d 6173 6b5f 7465           mask_te
+000172b0: 7874 735f 6f6e 6c79 203d 2028 7072 6564  xts_only = (pred
+000172c0: 6963 7469 6f6e 5f72 6567 696f 6e73 5f6f  iction_regions_o
+000172d0: 7267 5b3a 2c3a 5d20 3d3d 3129 2a31 0a20  rg[:,:] ==1)*1. 
+000172e0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+000172f0: 2020 2020 2020 2020 6d61 736b 5f69 6d61          mask_ima
+00017300: 6765 735f 6f6e 6c79 3d28 7072 6564 6963  ges_only=(predic
+00017310: 7469 6f6e 5f72 6567 696f 6e73 5f6f 7267  tion_regions_org
+00017320: 5b3a 2c3a 5d20 3d3d 3229 2a31 0a20 2020  [:,:] ==2)*1.   
+00017330: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+00017340: 2020 2020 2020 706f 6c79 676f 6e73 5f6c        polygons_l
+00017350: 696e 6573 5f78 6d6c 2c20 6869 725f 6c69  ines_xml, hir_li
+00017360: 6e65 735f 786d 6c20 3d20 7265 7475 726e  nes_xml = return
+00017370: 5f63 6f6e 746f 7572 735f 6f66 5f69 6d61  _contours_of_ima
+00017380: 6765 286d 6173 6b5f 6c69 6e65 735f 6f6e  ge(mask_lines_on
+00017390: 6c79 290a 2020 2020 2020 2020 2020 2020  ly).            
+000173a0: 706f 6c79 676f 6e73 5f6c 696e 6573 5f78  polygons_lines_x
+000173b0: 6d6c 203d 2074 6578 746c 696e 655f 636f  ml = textline_co
+000173c0: 6e5f 6669 6c20 3d20 6669 6c74 6572 5f63  n_fil = filter_c
+000173d0: 6f6e 746f 7572 735f 6172 6561 5f6f 665f  ontours_area_of_
+000173e0: 696d 6167 6528 6d61 736b 5f6c 696e 6573  image(mask_lines
+000173f0: 5f6f 6e6c 792c 2070 6f6c 7967 6f6e 735f  _only, polygons_
+00017400: 6c69 6e65 735f 786d 6c2c 2068 6972 5f6c  lines_xml, hir_l
+00017410: 696e 6573 5f78 6d6c 2c20 6d61 785f 6172  ines_xml, max_ar
+00017420: 6561 3d31 2c20 6d69 6e5f 6172 6561 3d30  ea=1, min_area=0
+00017430: 2e30 3030 3031 290a 2020 2020 2020 2020  .00001).        
+00017440: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+00017450: 200a 2020 2020 2020 2020 2020 2020 706f   .            po
+00017460: 6c79 676f 6e73 5f6f 665f 6f6e 6c79 5f74  lygons_of_only_t
+00017470: 6578 7473 203d 2072 6574 7572 6e5f 636f  exts = return_co
+00017480: 6e74 6f75 7273 5f6f 665f 696e 7465 7265  ntours_of_intere
+00017490: 7374 6564 5f72 6567 696f 6e28 6d61 736b  sted_region(mask
+000174a0: 5f74 6578 7473 5f6f 6e6c 792c 312c 302e  _texts_only,1,0.
+000174b0: 3030 3030 3129 0a20 2020 2020 2020 2020  00001).         
+000174c0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+000174d0: 706f 6c79 676f 6e73 5f6f 665f 6f6e 6c79  polygons_of_only
+000174e0: 5f6c 696e 6573 203d 2072 6574 7572 6e5f  _lines = return_
+000174f0: 636f 6e74 6f75 7273 5f6f 665f 696e 7465  contours_of_inte
+00017500: 7265 7374 6564 5f72 6567 696f 6e28 6d61  rested_region(ma
+00017510: 736b 5f6c 696e 6573 5f6f 6e6c 792c 312c  sk_lines_only,1,
+00017520: 302e 3030 3030 3129 0a20 2020 2020 2020  0.00001).       
+00017530: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+00017540: 2020 0a20 2020 2020 2020 2020 2020 2074    .            t
+00017550: 6578 745f 7265 6769 6f6e 735f 705f 7472  ext_regions_p_tr
+00017560: 7565 203d 206e 702e 7a65 726f 7328 7072  ue = np.zeros(pr
+00017570: 6564 6963 7469 6f6e 5f72 6567 696f 6e73  ediction_regions
+00017580: 5f6f 7267 2e73 6861 7065 290a 2020 2020  _org.shape).    
+00017590: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+000175a0: 2020 2020 2074 6578 745f 7265 6769 6f6e       text_region
+000175b0: 735f 705f 7472 7565 203d 2063 7632 2e66  s_p_true = cv2.f
+000175c0: 696c 6c50 6f6c 7928 7465 7874 5f72 6567  illPoly(text_reg
+000175d0: 696f 6e73 5f70 5f74 7275 652c 2070 7473  ions_p_true, pts
+000175e0: 203d 2070 6f6c 7967 6f6e 735f 6f66 5f6f   = polygons_of_o
+000175f0: 6e6c 795f 6c69 6e65 732c 2063 6f6c 6f72  nly_lines, color
+00017600: 3d28 332c 332c 3329 290a 2020 2020 2020  =(3,3,3)).      
+00017610: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+00017620: 2020 2074 6578 745f 7265 6769 6f6e 735f     text_regions_
+00017630: 705f 7472 7565 5b3a 2c3a 5d5b 6d61 736b  p_true[:,:][mask
+00017640: 5f69 6d61 6765 735f 6f6e 6c79 5b3a 2c3a  _images_only[:,:
+00017650: 5d20 3d3d 2031 5d20 3d20 320a 2020 2020  ] == 1] = 2.    
+00017660: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00017670: 2020 2020 2074 6578 745f 7265 6769 6f6e       text_region
+00017680: 735f 705f 7472 7565 203d 2063 7632 2e66  s_p_true = cv2.f
+00017690: 696c 6c50 6f6c 7928 7465 7874 5f72 6567  illPoly(text_reg
+000176a0: 696f 6e73 5f70 5f74 7275 652c 2070 7473  ions_p_true, pts
+000176b0: 203d 2070 6f6c 7967 6f6e 735f 6f66 5f6f   = polygons_of_o
+000176c0: 6e6c 795f 7465 7874 732c 2063 6f6c 6f72  nly_texts, color
+000176d0: 3d28 312c 312c 3129 290a 2020 2020 2020  =(1,1,1)).      
+000176e0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+000176f0: 2020 2065 726f 7369 6f6e 5f68 7572 7473     erosion_hurts
+00017700: 203d 2054 7275 650a 2020 2020 2020 2020   = True.        
+00017710: 2020 2020 7265 7475 726e 2074 6578 745f      return text_
+00017720: 7265 6769 6f6e 735f 705f 7472 7565 2c20  regions_p_true, 
+00017730: 6572 6f73 696f 6e5f 6875 7274 732c 2070  erosion_hurts, p
+00017740: 6f6c 7967 6f6e 735f 6c69 6e65 735f 786d  olygons_lines_xm
+00017750: 6c0a 0a20 2020 2064 6566 2064 6f5f 6f72  l..    def do_or
+00017760: 6465 725f 6f66 5f72 6567 696f 6e73 5f66  der_of_regions_f
+00017770: 756c 6c5f 6c61 796f 7574 2873 656c 662c  ull_layout(self,
+00017780: 2063 6f6e 746f 7572 735f 6f6e 6c79 5f74   contours_only_t
+00017790: 6578 745f 7061 7265 6e74 2c20 636f 6e74  ext_parent, cont
+000177a0: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
+000177b0: 6172 656e 745f 682c 2062 6f78 6573 2c20  arent_h, boxes, 
+000177c0: 7465 7874 6c69 6e65 5f6d 6173 6b5f 746f  textline_mask_to
+000177d0: 7429 3a0a 2020 2020 2020 2020 7365 6c66  t):.        self
+000177e0: 2e6c 6f67 6765 722e 6465 6275 6728 2265  .logger.debug("e
+000177f0: 6e74 6572 2064 6f5f 6f72 6465 725f 6f66  nter do_order_of
+00017800: 5f72 6567 696f 6e73 5f66 756c 6c5f 6c61  _regions_full_la
+00017810: 796f 7574 2229 0a20 2020 2020 2020 2063  yout").        c
+00017820: 785f 7465 7874 5f6f 6e6c 792c 2063 795f  x_text_only, cy_
+00017830: 7465 7874 5f6f 6e6c 792c 2078 5f6d 696e  text_only, x_min
+00017840: 5f74 6578 745f 6f6e 6c79 2c20 5f2c 205f  _text_only, _, _
+00017850: 2c20 5f2c 2079 5f63 6f72 5f78 5f6d 696e  , _, y_cor_x_min
+00017860: 5f6d 6169 6e20 3d20 6669 6e64 5f6e 6577  _main = find_new
+00017870: 5f66 6561 7475 7265 735f 6f66 5f63 6f6e  _features_of_con
+00017880: 746f 7572 7328 636f 6e74 6f75 7273 5f6f  tours(contours_o
+00017890: 6e6c 795f 7465 7874 5f70 6172 656e 7429  nly_text_parent)
+000178a0: 0a20 2020 2020 2020 2063 785f 7465 7874  .        cx_text
+000178b0: 5f6f 6e6c 795f 682c 2063 795f 7465 7874  _only_h, cy_text
+000178c0: 5f6f 6e6c 795f 682c 2078 5f6d 696e 5f74  _only_h, x_min_t
+000178d0: 6578 745f 6f6e 6c79 5f68 2c20 5f2c 205f  ext_only_h, _, _
+000178e0: 2c20 5f2c 2079 5f63 6f72 5f78 5f6d 696e  , _, y_cor_x_min
+000178f0: 5f6d 6169 6e5f 6820 3d20 6669 6e64 5f6e  _main_h = find_n
+00017900: 6577 5f66 6561 7475 7265 735f 6f66 5f63  ew_features_of_c
+00017910: 6f6e 746f 7572 7328 636f 6e74 6f75 7273  ontours(contours
+00017920: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
+00017930: 745f 6829 0a0a 2020 2020 2020 2020 7472  t_h)..        tr
+00017940: 793a 0a20 2020 2020 2020 2020 2020 2061  y:.            a
+00017950: 7267 5f74 6578 745f 636f 6e20 3d20 5b5d  rg_text_con = []
+00017960: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00017970: 2069 6920 696e 2072 616e 6765 286c 656e   ii in range(len
+00017980: 2863 785f 7465 7874 5f6f 6e6c 7929 293a  (cx_text_only)):
+00017990: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000179a0: 2066 6f72 206a 6a20 696e 2072 616e 6765   for jj in range
+000179b0: 286c 656e 2862 6f78 6573 2929 3a0a 2020  (len(boxes)):.  
+000179c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000179d0: 2020 6966 2028 785f 6d69 6e5f 7465 7874    if (x_min_text
+000179e0: 5f6f 6e6c 795b 6969 5d20 2b20 3830 2920  _only[ii] + 80) 
+000179f0: 3e3d 2062 6f78 6573 5b6a 6a5d 5b30 5d20  >= boxes[jj][0] 
+00017a00: 616e 6420 2878 5f6d 696e 5f74 6578 745f  and (x_min_text_
+00017a10: 6f6e 6c79 5b69 695d 202b 2038 3029 203c  only[ii] + 80) <
+00017a20: 2062 6f78 6573 5b6a 6a5d 5b31 5d20 616e   boxes[jj][1] an
+00017a30: 6420 795f 636f 725f 785f 6d69 6e5f 6d61  d y_cor_x_min_ma
+00017a40: 696e 5b69 695d 203e 3d20 626f 7865 735b  in[ii] >= boxes[
+00017a50: 6a6a 5d5b 325d 2061 6e64 2079 5f63 6f72  jj][2] and y_cor
+00017a60: 5f78 5f6d 696e 5f6d 6169 6e5b 6969 5d20  _x_min_main[ii] 
+00017a70: 3c20 626f 7865 735b 6a6a 5d5b 335d 3a0a  < boxes[jj][3]:.
+00017a80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017a90: 2020 2020 2020 2020 6172 675f 7465 7874          arg_text
+00017aa0: 5f63 6f6e 2e61 7070 656e 6428 6a6a 290a  _con.append(jj).
+00017ab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ac0: 2020 2020 2020 2020 6272 6561 6b0a 2020          break.  
+00017ad0: 2020 2020 2020 2020 2020 6172 6773 5f63            args_c
+00017ae0: 6f6e 746f 7572 7320 3d20 6e70 2e61 7272  ontours = np.arr
+00017af0: 6179 2872 616e 6765 286c 656e 2861 7267  ay(range(len(arg
+00017b00: 5f74 6578 745f 636f 6e29 2929 0a20 2020  _text_con))).   
+00017b10: 2020 2020 2020 2020 2061 7267 5f74 6578           arg_tex
+00017b20: 745f 636f 6e5f 6820 3d20 5b5d 0a20 2020  t_con_h = [].   
+00017b30: 2020 2020 2020 2020 2066 6f72 2069 6920           for ii 
+00017b40: 696e 2072 616e 6765 286c 656e 2863 785f  in range(len(cx_
+00017b50: 7465 7874 5f6f 6e6c 795f 6829 293a 0a20  text_only_h)):. 
+00017b60: 2020 2020 2020 2020 2020 2020 2020 2066                 f
+00017b70: 6f72 206a 6a20 696e 2072 616e 6765 286c  or jj in range(l
+00017b80: 656e 2862 6f78 6573 2929 3a0a 2020 2020  en(boxes)):.    
+00017b90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ba0: 6966 2028 785f 6d69 6e5f 7465 7874 5f6f  if (x_min_text_o
+00017bb0: 6e6c 795f 685b 6969 5d20 2b20 3830 2920  nly_h[ii] + 80) 
+00017bc0: 3e3d 2062 6f78 6573 5b6a 6a5d 5b30 5d20  >= boxes[jj][0] 
+00017bd0: 616e 6420 2878 5f6d 696e 5f74 6578 745f  and (x_min_text_
+00017be0: 6f6e 6c79 5f68 5b69 695d 202b 2038 3029  only_h[ii] + 80)
+00017bf0: 203c 2062 6f78 6573 5b6a 6a5d 5b31 5d20   < boxes[jj][1] 
+00017c00: 616e 6420 795f 636f 725f 785f 6d69 6e5f  and y_cor_x_min_
+00017c10: 6d61 696e 5f68 5b69 695d 203e 3d20 626f  main_h[ii] >= bo
+00017c20: 7865 735b 6a6a 5d5b 325d 2061 6e64 2079  xes[jj][2] and y
+00017c30: 5f63 6f72 5f78 5f6d 696e 5f6d 6169 6e5f  _cor_x_min_main_
+00017c40: 685b 6969 5d20 3c20 626f 7865 735b 6a6a  h[ii] < boxes[jj
+00017c50: 5d5b 335d 3a0a 2020 2020 2020 2020 2020  ][3]:.          
+00017c60: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+00017c70: 675f 7465 7874 5f63 6f6e 5f68 2e61 7070  g_text_con_h.app
+00017c80: 656e 6428 6a6a 290a 2020 2020 2020 2020  end(jj).        
+00017c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ca0: 6272 6561 6b0a 2020 2020 2020 2020 2020  break.          
+00017cb0: 2020 6172 6773 5f63 6f6e 746f 7572 735f    args_contours_
+00017cc0: 6820 3d20 6e70 2e61 7272 6179 2872 616e  h = np.array(ran
+00017cd0: 6765 286c 656e 2861 7267 5f74 6578 745f  ge(len(arg_text_
+00017ce0: 636f 6e5f 6829 2929 0a0a 2020 2020 2020  con_h)))..      
+00017cf0: 2020 2020 2020 6f72 6465 725f 6279 5f63        order_by_c
+00017d00: 6f6e 5f68 6561 6420 3d20 6e70 2e7a 6572  on_head = np.zer
+00017d10: 6f73 286c 656e 2861 7267 5f74 6578 745f  os(len(arg_text_
+00017d20: 636f 6e5f 6829 290a 2020 2020 2020 2020  con_h)).        
+00017d30: 2020 2020 6f72 6465 725f 6279 5f63 6f6e      order_by_con
+00017d40: 5f6d 6169 6e20 3d20 6e70 2e7a 6572 6f73  _main = np.zeros
+00017d50: 286c 656e 2861 7267 5f74 6578 745f 636f  (len(arg_text_co
+00017d60: 6e29 290a 0a20 2020 2020 2020 2020 2020  n))..           
+00017d70: 2072 6566 5f70 6f69 6e74 203d 2030 0a20   ref_point = 0. 
+00017d80: 2020 2020 2020 2020 2020 206f 7264 6572             order
+00017d90: 5f6f 665f 7465 7874 735f 746f 7420 3d20  _of_texts_tot = 
+00017da0: 5b5d 0a20 2020 2020 2020 2020 2020 2069  [].            i
+00017db0: 645f 6f66 5f74 6578 7473 5f74 6f74 203d  d_of_texts_tot =
+00017dc0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+00017dd0: 666f 7220 6969 6a20 696e 2072 616e 6765  for iij in range
+00017de0: 286c 656e 2862 6f78 6573 2929 3a0a 0a20  (len(boxes)):.. 
+00017df0: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+00017e00: 7267 735f 636f 6e74 6f75 7273 5f62 6f78  rgs_contours_box
+00017e10: 203d 2061 7267 735f 636f 6e74 6f75 7273   = args_contours
+00017e20: 5b6e 702e 6172 7261 7928 6172 675f 7465  [np.array(arg_te
+00017e30: 7874 5f63 6f6e 2920 3d3d 2069 696a 5d0a  xt_con) == iij].
+00017e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017e50: 6172 6773 5f63 6f6e 746f 7572 735f 626f  args_contours_bo
+00017e60: 785f 6820 3d20 6172 6773 5f63 6f6e 746f  x_h = args_conto
+00017e70: 7572 735f 685b 6e70 2e61 7272 6179 2861  urs_h[np.array(a
+00017e80: 7267 5f74 6578 745f 636f 6e5f 6829 203d  rg_text_con_h) =
+00017e90: 3d20 6969 6a5d 0a20 2020 2020 2020 2020  = iij].         
+00017ea0: 2020 2020 2020 2063 6f6e 5f69 6e74 6572         con_inter
+00017eb0: 5f62 6f78 203d 205b 5d0a 2020 2020 2020  _box = [].      
+00017ec0: 2020 2020 2020 2020 2020 636f 6e5f 696e            con_in
+00017ed0: 7465 725f 626f 785f 6820 3d20 5b5d 0a0a  ter_box_h = []..
+00017ee0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017ef0: 666f 7220 626f 7820 696e 2061 7267 735f  for box in args_
+00017f00: 636f 6e74 6f75 7273 5f62 6f78 3a0a 2020  contours_box:.  
+00017f10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00017f20: 2020 636f 6e5f 696e 7465 725f 626f 782e    con_inter_box.
+00017f30: 6170 7065 6e64 2863 6f6e 746f 7572 735f  append(contours_
+00017f40: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
+00017f50: 5b62 6f78 5d29 0a0a 2020 2020 2020 2020  [box])..        
+00017f60: 2020 2020 2020 2020 666f 7220 626f 7820          for box 
+00017f70: 696e 2061 7267 735f 636f 6e74 6f75 7273  in args_contours
+00017f80: 5f62 6f78 5f68 3a0a 2020 2020 2020 2020  _box_h:.        
+00017f90: 2020 2020 2020 2020 2020 2020 636f 6e5f              con_
+00017fa0: 696e 7465 725f 626f 785f 682e 6170 7065  inter_box_h.appe
+00017fb0: 6e64 2863 6f6e 746f 7572 735f 6f6e 6c79  nd(contours_only
+00017fc0: 5f74 6578 745f 7061 7265 6e74 5f68 5b62  _text_parent_h[b
+00017fd0: 6f78 5d29 0a0a 2020 2020 2020 2020 2020  ox])..          
+00017fe0: 2020 2020 2020 696e 6465 7865 735f 736f        indexes_so
+00017ff0: 7274 6564 2c20 6d61 7472 6978 5f6f 665f  rted, matrix_of_
+00018000: 6f72 6465 7273 2c20 6b69 6e64 5f6f 665f  orders, kind_of_
+00018010: 7465 7874 735f 736f 7274 6564 2c20 696e  texts_sorted, in
+00018020: 6465 785f 6279 5f6b 696e 645f 736f 7274  dex_by_kind_sort
+00018030: 6564 203d 206f 7264 6572 5f6f 665f 7265  ed = order_of_re
+00018040: 6769 6f6e 7328 7465 7874 6c69 6e65 5f6d  gions(textline_m
+00018050: 6173 6b5f 746f 745b 696e 7428 626f 7865  ask_tot[int(boxe
+00018060: 735b 6969 6a5d 5b32 5d29 203a 2069 6e74  s[iij][2]) : int
+00018070: 2862 6f78 6573 5b69 696a 5d5b 335d 292c  (boxes[iij][3]),
+00018080: 2069 6e74 2862 6f78 6573 5b69 696a 5d5b   int(boxes[iij][
+00018090: 305d 2920 3a20 696e 7428 626f 7865 735b  0]) : int(boxes[
+000180a0: 6969 6a5d 5b31 5d29 5d2c 2063 6f6e 5f69  iij][1])], con_i
+000180b0: 6e74 6572 5f62 6f78 2c20 636f 6e5f 696e  nter_box, con_in
+000180c0: 7465 725f 626f 785f 682c 2062 6f78 6573  ter_box_h, boxes
+000180d0: 5b69 696a 5d5b 325d 290a 0a20 2020 2020  [iij][2])..     
+000180e0: 2020 2020 2020 2020 2020 206f 7264 6572             order
+000180f0: 5f6f 665f 7465 7874 732c 2069 645f 6f66  _of_texts, id_of
+00018100: 5f74 6578 7473 203d 206f 7264 6572 5f61  _texts = order_a
+00018110: 6e64 5f69 645f 6f66 5f74 6578 7473 2863  nd_id_of_texts(c
+00018120: 6f6e 5f69 6e74 6572 5f62 6f78 2c20 636f  on_inter_box, co
+00018130: 6e5f 696e 7465 725f 626f 785f 682c 206d  n_inter_box_h, m
+00018140: 6174 7269 785f 6f66 5f6f 7264 6572 732c  atrix_of_orders,
+00018150: 2069 6e64 6578 6573 5f73 6f72 7465 642c   indexes_sorted,
+00018160: 2069 6e64 6578 5f62 795f 6b69 6e64 5f73   index_by_kind_s
+00018170: 6f72 7465 642c 206b 696e 645f 6f66 5f74  orted, kind_of_t
+00018180: 6578 7473 5f73 6f72 7465 642c 2072 6566  exts_sorted, ref
+00018190: 5f70 6f69 6e74 290a 0a20 2020 2020 2020  _point)..       
+000181a0: 2020 2020 2020 2020 2069 6e64 6578 6573           indexes
+000181b0: 5f73 6f72 7465 645f 6d61 696e 203d 206e  _sorted_main = n
+000181c0: 702e 6172 7261 7928 696e 6465 7865 735f  p.array(indexes_
+000181d0: 736f 7274 6564 295b 6e70 2e61 7272 6179  sorted)[np.array
+000181e0: 286b 696e 645f 6f66 5f74 6578 7473 5f73  (kind_of_texts_s
+000181f0: 6f72 7465 6429 203d 3d20 315d 0a20 2020  orted) == 1].   
+00018200: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+00018210: 6578 6573 5f62 795f 7479 7065 5f6d 6169  exes_by_type_mai
+00018220: 6e20 3d20 6e70 2e61 7272 6179 2869 6e64  n = np.array(ind
+00018230: 6578 5f62 795f 6b69 6e64 5f73 6f72 7465  ex_by_kind_sorte
+00018240: 6429 5b6e 702e 6172 7261 7928 6b69 6e64  d)[np.array(kind
+00018250: 5f6f 665f 7465 7874 735f 736f 7274 6564  _of_texts_sorted
+00018260: 2920 3d3d 2031 5d0a 2020 2020 2020 2020  ) == 1].        
+00018270: 2020 2020 2020 2020 696e 6465 7865 735f          indexes_
+00018280: 736f 7274 6564 5f68 6561 6420 3d20 6e70  sorted_head = np
+00018290: 2e61 7272 6179 2869 6e64 6578 6573 5f73  .array(indexes_s
+000182a0: 6f72 7465 6429 5b6e 702e 6172 7261 7928  orted)[np.array(
+000182b0: 6b69 6e64 5f6f 665f 7465 7874 735f 736f  kind_of_texts_so
+000182c0: 7274 6564 2920 3d3d 2032 5d0a 2020 2020  rted) == 2].    
+000182d0: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+000182e0: 7865 735f 6279 5f74 7970 655f 6865 6164  xes_by_type_head
+000182f0: 203d 206e 702e 6172 7261 7928 696e 6465   = np.array(inde
+00018300: 785f 6279 5f6b 696e 645f 736f 7274 6564  x_by_kind_sorted
+00018310: 295b 6e70 2e61 7272 6179 286b 696e 645f  )[np.array(kind_
+00018320: 6f66 5f74 6578 7473 5f73 6f72 7465 6429  of_texts_sorted)
+00018330: 203d 3d20 325d 0a0a 2020 2020 2020 2020   == 2]..        
+00018340: 2020 2020 2020 2020 666f 7220 7a61 686c          for zahl
+00018350: 6572 2c20 5f20 696e 2065 6e75 6d65 7261  er, _ in enumera
+00018360: 7465 2861 7267 735f 636f 6e74 6f75 7273  te(args_contours
+00018370: 5f62 6f78 293a 0a20 2020 2020 2020 2020  _box):.         
+00018380: 2020 2020 2020 2020 2020 2061 7267 5f6f             arg_o
+00018390: 7264 6572 5f76 203d 2069 6e64 6578 6573  rder_v = indexes
+000183a0: 5f73 6f72 7465 645f 6d61 696e 5b7a 6168  _sorted_main[zah
+000183b0: 6c65 725d 0a20 2020 2020 2020 2020 2020  ler].           
+000183c0: 2020 2020 2020 2020 206f 7264 6572 5f62           order_b
+000183d0: 795f 636f 6e5f 6d61 696e 5b61 7267 735f  y_con_main[args_
+000183e0: 636f 6e74 6f75 7273 5f62 6f78 5b69 6e64  contours_box[ind
+000183f0: 6578 6573 5f62 795f 7479 7065 5f6d 6169  exes_by_type_mai
+00018400: 6e5b 7a61 686c 6572 5d5d 5d20 3d20 6e70  n[zahler]]] = np
+00018410: 2e77 6865 7265 2869 6e64 6578 6573 5f73  .where(indexes_s
+00018420: 6f72 7465 6420 3d3d 2061 7267 5f6f 7264  orted == arg_ord
+00018430: 6572 5f76 295b 305d 5b30 5d20 2b20 7265  er_v)[0][0] + re
+00018440: 665f 706f 696e 740a 0a20 2020 2020 2020  f_point..       
+00018450: 2020 2020 2020 2020 2066 6f72 207a 6168           for zah
+00018460: 6c65 722c 205f 2069 6e20 656e 756d 6572  ler, _ in enumer
+00018470: 6174 6528 6172 6773 5f63 6f6e 746f 7572  ate(args_contour
+00018480: 735f 626f 785f 6829 3a0a 2020 2020 2020  s_box_h):.      
+00018490: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+000184a0: 675f 6f72 6465 725f 7620 3d20 696e 6465  g_order_v = inde
+000184b0: 7865 735f 736f 7274 6564 5f68 6561 645b  xes_sorted_head[
+000184c0: 7a61 686c 6572 5d0a 2020 2020 2020 2020  zahler].        
+000184d0: 2020 2020 2020 2020 2020 2020 6f72 6465              orde
+000184e0: 725f 6279 5f63 6f6e 5f68 6561 645b 6172  r_by_con_head[ar
+000184f0: 6773 5f63 6f6e 746f 7572 735f 626f 785f  gs_contours_box_
+00018500: 685b 696e 6465 7865 735f 6279 5f74 7970  h[indexes_by_typ
+00018510: 655f 6865 6164 5b7a 6168 6c65 725d 5d5d  e_head[zahler]]]
+00018520: 203d 206e 702e 7768 6572 6528 696e 6465   = np.where(inde
+00018530: 7865 735f 736f 7274 6564 203d 3d20 6172  xes_sorted == ar
+00018540: 675f 6f72 6465 725f 7629 5b30 5d5b 305d  g_order_v)[0][0]
+00018550: 202b 2072 6566 5f70 6f69 6e74 0a0a 2020   + ref_point..  
+00018560: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+00018570: 7220 6a6a 6920 696e 2072 616e 6765 286c  r jji in range(l
+00018580: 656e 2869 645f 6f66 5f74 6578 7473 2929  en(id_of_texts))
+00018590: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+000185a0: 2020 2020 2020 6f72 6465 725f 6f66 5f74        order_of_t
+000185b0: 6578 7473 5f74 6f74 2e61 7070 656e 6428  exts_tot.append(
+000185c0: 6f72 6465 725f 6f66 5f74 6578 7473 5b6a  order_of_texts[j
+000185d0: 6a69 5d20 2b20 7265 665f 706f 696e 7429  ji] + ref_point)
+000185e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000185f0: 2020 2020 2069 645f 6f66 5f74 6578 7473       id_of_texts
+00018600: 5f74 6f74 2e61 7070 656e 6428 6964 5f6f  _tot.append(id_o
+00018610: 665f 7465 7874 735b 6a6a 695d 290a 2020  f_texts[jji]).  
+00018620: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00018630: 665f 706f 696e 7420 2b3d 206c 656e 2869  f_point += len(i
+00018640: 645f 6f66 5f74 6578 7473 290a 0a20 2020  d_of_texts)..   
+00018650: 2020 2020 2020 2020 206f 7264 6572 5f6f           order_o
+00018660: 665f 7465 7874 735f 746f 7420 3d20 5b5d  f_texts_tot = []
+00018670: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+00018680: 2074 6a31 2069 6e20 7261 6e67 6528 6c65   tj1 in range(le
+00018690: 6e28 636f 6e74 6f75 7273 5f6f 6e6c 795f  n(contours_only_
+000186a0: 7465 7874 5f70 6172 656e 7429 293a 0a20  text_parent)):. 
+000186b0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+000186c0: 7264 6572 5f6f 665f 7465 7874 735f 746f  rder_of_texts_to
+000186d0: 742e 6170 7065 6e64 2869 6e74 286f 7264  t.append(int(ord
+000186e0: 6572 5f62 795f 636f 6e5f 6d61 696e 5b74  er_by_con_main[t
+000186f0: 6a31 5d29 290a 0a20 2020 2020 2020 2020  j1]))..         
+00018700: 2020 2066 6f72 2074 6a31 2069 6e20 7261     for tj1 in ra
+00018710: 6e67 6528 6c65 6e28 636f 6e74 6f75 7273  nge(len(contours
+00018720: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
+00018730: 745f 6829 293a 0a20 2020 2020 2020 2020  t_h)):.         
+00018740: 2020 2020 2020 206f 7264 6572 5f6f 665f         order_of_
+00018750: 7465 7874 735f 746f 742e 6170 7065 6e64  texts_tot.append
+00018760: 2869 6e74 286f 7264 6572 5f62 795f 636f  (int(order_by_co
+00018770: 6e5f 6865 6164 5b74 6a31 5d29 290a 0a20  n_head[tj1])).. 
+00018780: 2020 2020 2020 2020 2020 206f 7264 6572             order
+00018790: 5f74 6578 745f 6e65 7720 3d20 5b5d 0a20  _text_new = []. 
+000187a0: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+000187b0: 6969 2069 6e20 7261 6e67 6528 6c65 6e28  ii in range(len(
+000187c0: 6f72 6465 725f 6f66 5f74 6578 7473 5f74  order_of_texts_t
+000187d0: 6f74 2929 3a0a 2020 2020 2020 2020 2020  ot)):.          
+000187e0: 2020 2020 2020 6f72 6465 725f 7465 7874        order_text
+000187f0: 5f6e 6577 2e61 7070 656e 6428 6e70 2e77  _new.append(np.w
+00018800: 6865 7265 286e 702e 6172 7261 7928 6f72  here(np.array(or
+00018810: 6465 725f 6f66 5f74 6578 7473 5f74 6f74  der_of_texts_tot
+00018820: 2920 3d3d 2069 6969 295b 305d 5b30 5d29  ) == iii)[0][0])
+00018830: 0a0a 2020 2020 2020 2020 6578 6365 7074  ..        except
+00018840: 2045 7863 6570 7469 6f6e 2061 7320 7768   Exception as wh
+00018850: 793a 0a20 2020 2020 2020 2020 2020 2073  y:.            s
+00018860: 656c 662e 6c6f 6767 6572 2e65 7272 6f72  elf.logger.error
+00018870: 2877 6879 290a 2020 2020 2020 2020 2020  (why).          
+00018880: 2020 6172 675f 7465 7874 5f63 6f6e 203d    arg_text_con =
+00018890: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+000188a0: 666f 7220 6969 2069 6e20 7261 6e67 6528  for ii in range(
+000188b0: 6c65 6e28 6378 5f74 6578 745f 6f6e 6c79  len(cx_text_only
+000188c0: 2929 3a0a 2020 2020 2020 2020 2020 2020  )):.            
+000188d0: 2020 2020 666f 7220 6a6a 2069 6e20 7261      for jj in ra
+000188e0: 6e67 6528 6c65 6e28 626f 7865 7329 293a  nge(len(boxes)):
+000188f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018900: 2020 2020 2069 6620 6378 5f74 6578 745f       if cx_text_
+00018910: 6f6e 6c79 5b69 695d 203e 3d20 626f 7865  only[ii] >= boxe
+00018920: 735b 6a6a 5d5b 305d 2061 6e64 2063 785f  s[jj][0] and cx_
+00018930: 7465 7874 5f6f 6e6c 795b 6969 5d20 3c20  text_only[ii] < 
+00018940: 626f 7865 735b 6a6a 5d5b 315d 2061 6e64  boxes[jj][1] and
+00018950: 2063 795f 7465 7874 5f6f 6e6c 795b 6969   cy_text_only[ii
+00018960: 5d20 3e3d 2062 6f78 6573 5b6a 6a5d 5b32  ] >= boxes[jj][2
+00018970: 5d20 616e 6420 6379 5f74 6578 745f 6f6e  ] and cy_text_on
+00018980: 6c79 5b69 695d 203c 2062 6f78 6573 5b6a  ly[ii] < boxes[j
+00018990: 6a5d 5b33 5d3a 2020 2320 7468 6973 2069  j][3]:  # this i
+000189a0: 7320 7661 6c69 6420 6966 2074 6865 2063  s valid if the c
+000189b0: 656e 7465 7220 6f66 2072 6567 696f 6e20  enter of region 
+000189c0: 6964 656e 7469 6679 2069 6e20 7768 6963  identify in whic
+000189d0: 6820 626f 7820 6974 2069 7320 6c6f 6361  h box it is loca
+000189e0: 7465 640a 2020 2020 2020 2020 2020 2020  ted.            
+000189f0: 2020 2020 2020 2020 2020 2020 6172 675f              arg_
+00018a00: 7465 7874 5f63 6f6e 2e61 7070 656e 6428  text_con.append(
+00018a10: 6a6a 290a 2020 2020 2020 2020 2020 2020  jj).            
+00018a20: 2020 2020 2020 2020 2020 2020 6272 6561              brea
+00018a30: 6b0a 2020 2020 2020 2020 2020 2020 6172  k.            ar
+00018a40: 6773 5f63 6f6e 746f 7572 7320 3d20 6e70  gs_contours = np
+00018a50: 2e61 7272 6179 2872 616e 6765 286c 656e  .array(range(len
+00018a60: 2861 7267 5f74 6578 745f 636f 6e29 2929  (arg_text_con)))
+00018a70: 0a0a 2020 2020 2020 2020 2020 2020 6f72  ..            or
+00018a80: 6465 725f 6279 5f63 6f6e 5f6d 6169 6e20  der_by_con_main 
+00018a90: 3d20 6e70 2e7a 6572 6f73 286c 656e 2861  = np.zeros(len(a
+00018aa0: 7267 5f74 6578 745f 636f 6e29 290a 0a20  rg_text_con)).. 
+00018ab0: 2020 2020 2020 2020 2020 2023 2323 2323             #####
+00018ac0: 2323 2323 2323 2323 2323 2323 2323 2323  ################
+00018ad0: 2323 2323 2323 2323 2068 6561 640a 0a20  ######## head.. 
+00018ae0: 2020 2020 2020 2020 2020 2061 7267 5f74             arg_t
+00018af0: 6578 745f 636f 6e5f 6820 3d20 5b5d 0a20  ext_con_h = []. 
+00018b00: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+00018b10: 6920 696e 2072 616e 6765 286c 656e 2863  i in range(len(c
+00018b20: 785f 7465 7874 5f6f 6e6c 795f 6829 293a  x_text_only_h)):
+00018b30: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00018b40: 2066 6f72 206a 6a20 696e 2072 616e 6765   for jj in range
+00018b50: 286c 656e 2862 6f78 6573 2929 3a0a 2020  (len(boxes)):.  
+00018b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018b70: 2020 6966 2063 785f 7465 7874 5f6f 6e6c    if cx_text_onl
+00018b80: 795f 685b 6969 5d20 3e3d 2062 6f78 6573  y_h[ii] >= boxes
+00018b90: 5b6a 6a5d 5b30 5d20 616e 6420 6378 5f74  [jj][0] and cx_t
+00018ba0: 6578 745f 6f6e 6c79 5f68 5b69 695d 203c  ext_only_h[ii] <
+00018bb0: 2062 6f78 6573 5b6a 6a5d 5b31 5d20 616e   boxes[jj][1] an
+00018bc0: 6420 6379 5f74 6578 745f 6f6e 6c79 5f68  d cy_text_only_h
+00018bd0: 5b69 695d 203e 3d20 626f 7865 735b 6a6a  [ii] >= boxes[jj
+00018be0: 5d5b 325d 2061 6e64 2063 795f 7465 7874  ][2] and cy_text
+00018bf0: 5f6f 6e6c 795f 685b 6969 5d20 3c20 626f  _only_h[ii] < bo
+00018c00: 7865 735b 6a6a 5d5b 335d 3a20 2023 2074  xes[jj][3]:  # t
+00018c10: 6869 7320 6973 2076 616c 6964 2069 6620  his is valid if 
+00018c20: 7468 6520 6365 6e74 6572 206f 6620 7265  the center of re
+00018c30: 6769 6f6e 2069 6465 6e74 6966 7920 696e  gion identify in
+00018c40: 2077 6869 6368 2062 6f78 2069 7420 6973   which box it is
+00018c50: 206c 6f63 6174 6564 0a20 2020 2020 2020   located.       
+00018c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018c70: 2061 7267 5f74 6578 745f 636f 6e5f 682e   arg_text_con_h.
+00018c80: 6170 7065 6e64 286a 6a29 0a20 2020 2020  append(jj).     
+00018c90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018ca0: 2020 2062 7265 616b 0a20 2020 2020 2020     break.       
+00018cb0: 2020 2020 2061 7267 735f 636f 6e74 6f75       args_contou
+00018cc0: 7273 5f68 203d 206e 702e 6172 7261 7928  rs_h = np.array(
+00018cd0: 7261 6e67 6528 6c65 6e28 6172 675f 7465  range(len(arg_te
+00018ce0: 7874 5f63 6f6e 5f68 2929 290a 0a20 2020  xt_con_h)))..   
+00018cf0: 2020 2020 2020 2020 206f 7264 6572 5f62           order_b
+00018d00: 795f 636f 6e5f 6865 6164 203d 206e 702e  y_con_head = np.
+00018d10: 7a65 726f 7328 6c65 6e28 6172 675f 7465  zeros(len(arg_te
+00018d20: 7874 5f63 6f6e 5f68 2929 0a0a 2020 2020  xt_con_h))..    
+00018d30: 2020 2020 2020 2020 7265 665f 706f 696e          ref_poin
+00018d40: 7420 3d20 300a 2020 2020 2020 2020 2020  t = 0.          
+00018d50: 2020 6f72 6465 725f 6f66 5f74 6578 7473    order_of_texts
+00018d60: 5f74 6f74 203d 205b 5d0a 2020 2020 2020  _tot = [].      
+00018d70: 2020 2020 2020 6964 5f6f 665f 7465 7874        id_of_text
+00018d80: 735f 746f 7420 3d20 5b5d 0a20 2020 2020  s_tot = [].     
+00018d90: 2020 2020 2020 2066 6f72 2069 696a 2c20         for iij, 
+00018da0: 5f20 696e 2065 6e75 6d65 7261 7465 2862  _ in enumerate(b
+00018db0: 6f78 6573 293a 0a20 2020 2020 2020 2020  oxes):.         
+00018dc0: 2020 2020 2020 2061 7267 735f 636f 6e74         args_cont
+00018dd0: 6f75 7273 5f62 6f78 203d 2061 7267 735f  ours_box = args_
+00018de0: 636f 6e74 6f75 7273 5b6e 702e 6172 7261  contours[np.arra
+00018df0: 7928 6172 675f 7465 7874 5f63 6f6e 2920  y(arg_text_con) 
+00018e00: 3d3d 2069 696a 5d0a 2020 2020 2020 2020  == iij].        
+00018e10: 2020 2020 2020 2020 6172 6773 5f63 6f6e          args_con
+00018e20: 746f 7572 735f 626f 785f 6820 3d20 6172  tours_box_h = ar
+00018e30: 6773 5f63 6f6e 746f 7572 735f 685b 6e70  gs_contours_h[np
+00018e40: 2e61 7272 6179 2861 7267 5f74 6578 745f  .array(arg_text_
+00018e50: 636f 6e5f 6829 203d 3d20 6969 6a5d 0a20  con_h) == iij]. 
+00018e60: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00018e70: 6f6e 5f69 6e74 6572 5f62 6f78 203d 205b  on_inter_box = [
+00018e80: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+00018e90: 2020 636f 6e5f 696e 7465 725f 626f 785f    con_inter_box_
+00018ea0: 6820 3d20 5b5d 0a0a 2020 2020 2020 2020  h = []..        
+00018eb0: 2020 2020 2020 2020 666f 7220 626f 7820          for box 
+00018ec0: 696e 2061 7267 735f 636f 6e74 6f75 7273  in args_contours
+00018ed0: 5f62 6f78 3a0a 2020 2020 2020 2020 2020  _box:.          
+00018ee0: 2020 2020 2020 2020 2020 636f 6e5f 696e            con_in
+00018ef0: 7465 725f 626f 782e 6170 7065 6e64 2863  ter_box.append(c
+00018f00: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
+00018f10: 745f 7061 7265 6e74 5b62 6f78 5d29 0a0a  t_parent[box])..
+00018f20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f30: 666f 7220 626f 7820 696e 2061 7267 735f  for box in args_
+00018f40: 636f 6e74 6f75 7273 5f62 6f78 5f68 3a0a  contours_box_h:.
+00018f50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00018f60: 2020 2020 636f 6e5f 696e 7465 725f 626f      con_inter_bo
+00018f70: 785f 682e 6170 7065 6e64 2863 6f6e 746f  x_h.append(conto
+00018f80: 7572 735f 6f6e 6c79 5f74 6578 745f 7061  urs_only_text_pa
+00018f90: 7265 6e74 5f68 5b62 6f78 5d29 0a0a 2020  rent_h[box])..  
+00018fa0: 2020 2020 2020 2020 2020 2020 2020 696e                in
+00018fb0: 6465 7865 735f 736f 7274 6564 2c20 6d61  dexes_sorted, ma
+00018fc0: 7472 6978 5f6f 665f 6f72 6465 7273 2c20  trix_of_orders, 
+00018fd0: 6b69 6e64 5f6f 665f 7465 7874 735f 736f  kind_of_texts_so
+00018fe0: 7274 6564 2c20 696e 6465 785f 6279 5f6b  rted, index_by_k
+00018ff0: 696e 645f 736f 7274 6564 203d 206f 7264  ind_sorted = ord
+00019000: 6572 5f6f 665f 7265 6769 6f6e 7328 7465  er_of_regions(te
+00019010: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745b  xtline_mask_tot[
+00019020: 696e 7428 626f 7865 735b 6969 6a5d 5b32  int(boxes[iij][2
+00019030: 5d29 203a 2069 6e74 2862 6f78 6573 5b69  ]) : int(boxes[i
+00019040: 696a 5d5b 335d 292c 2069 6e74 2862 6f78  ij][3]), int(box
+00019050: 6573 5b69 696a 5d5b 305d 2920 3a20 696e  es[iij][0]) : in
+00019060: 7428 626f 7865 735b 6969 6a5d 5b31 5d29  t(boxes[iij][1])
+00019070: 5d2c 2063 6f6e 5f69 6e74 6572 5f62 6f78  ], con_inter_box
+00019080: 2c20 636f 6e5f 696e 7465 725f 626f 785f  , con_inter_box_
+00019090: 682c 2062 6f78 6573 5b69 696a 5d5b 325d  h, boxes[iij][2]
+000190a0: 290a 0a20 2020 2020 2020 2020 2020 2020  )..             
+000190b0: 2020 206f 7264 6572 5f6f 665f 7465 7874     order_of_text
+000190c0: 732c 2069 645f 6f66 5f74 6578 7473 203d  s, id_of_texts =
+000190d0: 206f 7264 6572 5f61 6e64 5f69 645f 6f66   order_and_id_of
+000190e0: 5f74 6578 7473 2863 6f6e 5f69 6e74 6572  _texts(con_inter
+000190f0: 5f62 6f78 2c20 636f 6e5f 696e 7465 725f  _box, con_inter_
+00019100: 626f 785f 682c 206d 6174 7269 785f 6f66  box_h, matrix_of
+00019110: 5f6f 7264 6572 732c 2069 6e64 6578 6573  _orders, indexes
+00019120: 5f73 6f72 7465 642c 2069 6e64 6578 5f62  _sorted, index_b
+00019130: 795f 6b69 6e64 5f73 6f72 7465 642c 206b  y_kind_sorted, k
+00019140: 696e 645f 6f66 5f74 6578 7473 5f73 6f72  ind_of_texts_sor
+00019150: 7465 642c 2072 6566 5f70 6f69 6e74 290a  ted, ref_point).
+00019160: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019170: 2069 6e64 6578 6573 5f73 6f72 7465 645f   indexes_sorted_
+00019180: 6d61 696e 203d 206e 702e 6172 7261 7928  main = np.array(
+00019190: 696e 6465 7865 735f 736f 7274 6564 295b  indexes_sorted)[
+000191a0: 6e70 2e61 7272 6179 286b 696e 645f 6f66  np.array(kind_of
+000191b0: 5f74 6578 7473 5f73 6f72 7465 6429 203d  _texts_sorted) =
+000191c0: 3d20 315d 0a20 2020 2020 2020 2020 2020  = 1].           
+000191d0: 2020 2020 2069 6e64 6578 6573 5f62 795f       indexes_by_
+000191e0: 7479 7065 5f6d 6169 6e20 3d20 6e70 2e61  type_main = np.a
+000191f0: 7272 6179 2869 6e64 6578 5f62 795f 6b69  rray(index_by_ki
+00019200: 6e64 5f73 6f72 7465 6429 5b6e 702e 6172  nd_sorted)[np.ar
+00019210: 7261 7928 6b69 6e64 5f6f 665f 7465 7874  ray(kind_of_text
+00019220: 735f 736f 7274 6564 2920 3d3d 2031 5d0a  s_sorted) == 1].
+00019230: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019240: 696e 6465 7865 735f 736f 7274 6564 5f68  indexes_sorted_h
+00019250: 6561 6420 3d20 6e70 2e61 7272 6179 2869  ead = np.array(i
+00019260: 6e64 6578 6573 5f73 6f72 7465 6429 5b6e  ndexes_sorted)[n
+00019270: 702e 6172 7261 7928 6b69 6e64 5f6f 665f  p.array(kind_of_
+00019280: 7465 7874 735f 736f 7274 6564 2920 3d3d  texts_sorted) ==
+00019290: 2032 5d0a 2020 2020 2020 2020 2020 2020   2].            
+000192a0: 2020 2020 696e 6465 7865 735f 6279 5f74      indexes_by_t
+000192b0: 7970 655f 6865 6164 203d 206e 702e 6172  ype_head = np.ar
+000192c0: 7261 7928 696e 6465 785f 6279 5f6b 696e  ray(index_by_kin
+000192d0: 645f 736f 7274 6564 295b 6e70 2e61 7272  d_sorted)[np.arr
+000192e0: 6179 286b 696e 645f 6f66 5f74 6578 7473  ay(kind_of_texts
+000192f0: 5f73 6f72 7465 6429 203d 3d20 325d 0a0a  _sorted) == 2]..
+00019300: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019310: 666f 7220 7a61 686c 6572 2c20 5f20 696e  for zahler, _ in
+00019320: 2065 6e75 6d65 7261 7465 2861 7267 735f   enumerate(args_
+00019330: 636f 6e74 6f75 7273 5f62 6f78 293a 0a20  contours_box):. 
+00019340: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019350: 2020 2061 7267 5f6f 7264 6572 5f76 203d     arg_order_v =
+00019360: 2069 6e64 6578 6573 5f73 6f72 7465 645f   indexes_sorted_
+00019370: 6d61 696e 5b7a 6168 6c65 725d 0a20 2020  main[zahler].   
+00019380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019390: 206f 7264 6572 5f62 795f 636f 6e5f 6d61   order_by_con_ma
+000193a0: 696e 5b61 7267 735f 636f 6e74 6f75 7273  in[args_contours
+000193b0: 5f62 6f78 5b69 6e64 6578 6573 5f62 795f  _box[indexes_by_
+000193c0: 7479 7065 5f6d 6169 6e5b 7a61 686c 6572  type_main[zahler
+000193d0: 5d5d 5d20 3d20 6e70 2e77 6865 7265 2869  ]]] = np.where(i
+000193e0: 6e64 6578 6573 5f73 6f72 7465 6420 3d3d  ndexes_sorted ==
+000193f0: 2061 7267 5f6f 7264 6572 5f76 295b 305d   arg_order_v)[0]
+00019400: 5b30 5d20 2b20 7265 665f 706f 696e 740a  [0] + ref_point.
+00019410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019420: 2066 6f72 207a 6168 6c65 722c 205f 2069   for zahler, _ i
+00019430: 6e20 656e 756d 6572 6174 6528 6172 6773  n enumerate(args
+00019440: 5f63 6f6e 746f 7572 735f 626f 785f 6829  _contours_box_h)
+00019450: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00019460: 2020 2020 2020 6172 675f 6f72 6465 725f        arg_order_
+00019470: 7620 3d20 696e 6465 7865 735f 736f 7274  v = indexes_sort
+00019480: 6564 5f68 6561 645b 7a61 686c 6572 5d0a  ed_head[zahler].
+00019490: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000194a0: 2020 2020 6f72 6465 725f 6279 5f63 6f6e      order_by_con
+000194b0: 5f68 6561 645b 6172 6773 5f63 6f6e 746f  _head[args_conto
+000194c0: 7572 735f 626f 785f 685b 696e 6465 7865  urs_box_h[indexe
+000194d0: 735f 6279 5f74 7970 655f 6865 6164 5b7a  s_by_type_head[z
+000194e0: 6168 6c65 725d 5d5d 203d 206e 702e 7768  ahler]]] = np.wh
+000194f0: 6572 6528 696e 6465 7865 735f 736f 7274  ere(indexes_sort
+00019500: 6564 203d 3d20 6172 675f 6f72 6465 725f  ed == arg_order_
+00019510: 7629 5b30 5d5b 305d 202b 2072 6566 5f70  v)[0][0] + ref_p
+00019520: 6f69 6e74 0a0a 2020 2020 2020 2020 2020  oint..          
+00019530: 2020 2020 2020 666f 7220 6a6a 692c 205f        for jji, _
+00019540: 2069 6e20 656e 756d 6572 6174 6528 6964   in enumerate(id
+00019550: 5f6f 665f 7465 7874 7329 3a0a 2020 2020  _of_texts):.    
+00019560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019570: 6f72 6465 725f 6f66 5f74 6578 7473 5f74  order_of_texts_t
+00019580: 6f74 2e61 7070 656e 6428 6f72 6465 725f  ot.append(order_
+00019590: 6f66 5f74 6578 7473 5b6a 6a69 5d20 2b20  of_texts[jji] + 
+000195a0: 7265 665f 706f 696e 7429 0a20 2020 2020  ref_point).     
+000195b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000195c0: 645f 6f66 5f74 6578 7473 5f74 6f74 2e61  d_of_texts_tot.a
+000195d0: 7070 656e 6428 6964 5f6f 665f 7465 7874  ppend(id_of_text
+000195e0: 735b 6a6a 695d 290a 2020 2020 2020 2020  s[jji]).        
+000195f0: 2020 2020 2020 2020 7265 665f 706f 696e          ref_poin
+00019600: 7420 2b3d 206c 656e 2869 645f 6f66 5f74  t += len(id_of_t
+00019610: 6578 7473 290a 0a20 2020 2020 2020 2020  exts)..         
+00019620: 2020 206f 7264 6572 5f6f 665f 7465 7874     order_of_text
+00019630: 735f 746f 7420 3d20 5b5d 0a20 2020 2020  s_tot = [].     
+00019640: 2020 2020 2020 2066 6f72 2074 6a31 2069         for tj1 i
+00019650: 6e20 7261 6e67 6528 6c65 6e28 636f 6e74  n range(len(cont
+00019660: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
+00019670: 6172 656e 7429 293a 0a20 2020 2020 2020  arent)):.       
+00019680: 2020 2020 2020 2020 206f 7264 6572 5f6f           order_o
+00019690: 665f 7465 7874 735f 746f 742e 6170 7065  f_texts_tot.appe
+000196a0: 6e64 2869 6e74 286f 7264 6572 5f62 795f  nd(int(order_by_
+000196b0: 636f 6e5f 6d61 696e 5b74 6a31 5d29 290a  con_main[tj1])).
+000196c0: 0a20 2020 2020 2020 2020 2020 2066 6f72  .            for
+000196d0: 2074 6a31 2069 6e20 7261 6e67 6528 6c65   tj1 in range(le
+000196e0: 6e28 636f 6e74 6f75 7273 5f6f 6e6c 795f  n(contours_only_
+000196f0: 7465 7874 5f70 6172 656e 745f 6829 293a  text_parent_h)):
+00019700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019710: 206f 7264 6572 5f6f 665f 7465 7874 735f   order_of_texts_
+00019720: 746f 742e 6170 7065 6e64 2869 6e74 286f  tot.append(int(o
+00019730: 7264 6572 5f62 795f 636f 6e5f 6865 6164  rder_by_con_head
+00019740: 5b74 6a31 5d29 290a 0a20 2020 2020 2020  [tj1]))..       
+00019750: 2020 2020 206f 7264 6572 5f74 6578 745f       order_text_
+00019760: 6e65 7720 3d20 5b5d 0a20 2020 2020 2020  new = [].       
+00019770: 2020 2020 2066 6f72 2069 6969 2069 6e20       for iii in 
+00019780: 7261 6e67 6528 6c65 6e28 6f72 6465 725f  range(len(order_
+00019790: 6f66 5f74 6578 7473 5f74 6f74 2929 3a0a  of_texts_tot)):.
+000197a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000197b0: 6f72 6465 725f 7465 7874 5f6e 6577 2e61  order_text_new.a
+000197c0: 7070 656e 6428 6e70 2e77 6865 7265 286e  ppend(np.where(n
+000197d0: 702e 6172 7261 7928 6f72 6465 725f 6f66  p.array(order_of
+000197e0: 5f74 6578 7473 5f74 6f74 2920 3d3d 2069  _texts_tot) == i
+000197f0: 6969 295b 305d 5b30 5d29 0a20 2020 2020  ii)[0][0]).     
+00019800: 2020 2072 6574 7572 6e20 6f72 6465 725f     return order_
+00019810: 7465 7874 5f6e 6577 2c20 6964 5f6f 665f  text_new, id_of_
+00019820: 7465 7874 735f 746f 740a 0a20 2020 2064  texts_tot..    d
+00019830: 6566 2064 6f5f 6f72 6465 725f 6f66 5f72  ef do_order_of_r
+00019840: 6567 696f 6e73 5f6e 6f5f 6675 6c6c 5f6c  egions_no_full_l
+00019850: 6179 6f75 7428 7365 6c66 2c20 636f 6e74  ayout(self, cont
+00019860: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
+00019870: 6172 656e 742c 2063 6f6e 746f 7572 735f  arent, contours_
+00019880: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
+00019890: 5f68 2c20 626f 7865 732c 2074 6578 746c  _h, boxes, textl
+000198a0: 696e 655f 6d61 736b 5f74 6f74 293a 0a20  ine_mask_tot):. 
+000198b0: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
+000198c0: 6572 2e64 6562 7567 2822 656e 7465 7220  er.debug("enter 
+000198d0: 646f 5f6f 7264 6572 5f6f 665f 7265 6769  do_order_of_regi
+000198e0: 6f6e 735f 6e6f 5f66 756c 6c5f 6c61 796f  ons_no_full_layo
+000198f0: 7574 2229 0a20 2020 2020 2020 2063 785f  ut").        cx_
+00019900: 7465 7874 5f6f 6e6c 792c 2063 795f 7465  text_only, cy_te
+00019910: 7874 5f6f 6e6c 792c 2078 5f6d 696e 5f74  xt_only, x_min_t
+00019920: 6578 745f 6f6e 6c79 2c20 5f2c 205f 2c20  ext_only, _, _, 
+00019930: 5f2c 2079 5f63 6f72 5f78 5f6d 696e 5f6d  _, y_cor_x_min_m
+00019940: 6169 6e20 3d20 6669 6e64 5f6e 6577 5f66  ain = find_new_f
+00019950: 6561 7475 7265 735f 6f66 5f63 6f6e 746f  eatures_of_conto
+00019960: 7572 7328 636f 6e74 6f75 7273 5f6f 6e6c  urs(contours_onl
+00019970: 795f 7465 7874 5f70 6172 656e 7429 0a0a  y_text_parent)..
+00019980: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+00019990: 2020 2020 2020 2020 2061 7267 5f74 6578           arg_tex
+000199a0: 745f 636f 6e20 3d20 5b5d 0a20 2020 2020  t_con = [].     
+000199b0: 2020 2020 2020 2066 6f72 2069 6920 696e         for ii in
+000199c0: 2072 616e 6765 286c 656e 2863 785f 7465   range(len(cx_te
+000199d0: 7874 5f6f 6e6c 7929 293a 0a20 2020 2020  xt_only)):.     
+000199e0: 2020 2020 2020 2020 2020 2066 6f72 206a             for j
+000199f0: 6a20 696e 2072 616e 6765 286c 656e 2862  j in range(len(b
+00019a00: 6f78 6573 2929 3a0a 2020 2020 2020 2020  oxes)):.        
+00019a10: 2020 2020 2020 2020 2020 2020 6966 2028              if (
+00019a20: 785f 6d69 6e5f 7465 7874 5f6f 6e6c 795b  x_min_text_only[
+00019a30: 6969 5d20 2b20 3830 2920 3e3d 2062 6f78  ii] + 80) >= box
+00019a40: 6573 5b6a 6a5d 5b30 5d20 616e 6420 2878  es[jj][0] and (x
+00019a50: 5f6d 696e 5f74 6578 745f 6f6e 6c79 5b69  _min_text_only[i
+00019a60: 695d 202b 2038 3029 203c 2062 6f78 6573  i] + 80) < boxes
+00019a70: 5b6a 6a5d 5b31 5d20 616e 6420 795f 636f  [jj][1] and y_co
+00019a80: 725f 785f 6d69 6e5f 6d61 696e 5b69 695d  r_x_min_main[ii]
+00019a90: 203e 3d20 626f 7865 735b 6a6a 5d5b 325d   >= boxes[jj][2]
+00019aa0: 2061 6e64 2079 5f63 6f72 5f78 5f6d 696e   and y_cor_x_min
+00019ab0: 5f6d 6169 6e5b 6969 5d20 3c20 626f 7865  _main[ii] < boxe
+00019ac0: 735b 6a6a 5d5b 335d 3a0a 2020 2020 2020  s[jj][3]:.      
+00019ad0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019ae0: 2020 6172 675f 7465 7874 5f63 6f6e 2e61    arg_text_con.a
+00019af0: 7070 656e 6428 6a6a 290a 2020 2020 2020  ppend(jj).      
+00019b00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019b10: 2020 6272 6561 6b0a 2020 2020 2020 2020    break.        
+00019b20: 2020 2020 6172 6773 5f63 6f6e 746f 7572      args_contour
+00019b30: 7320 3d20 6e70 2e61 7272 6179 2872 616e  s = np.array(ran
+00019b40: 6765 286c 656e 2861 7267 5f74 6578 745f  ge(len(arg_text_
+00019b50: 636f 6e29 2929 0a20 2020 2020 2020 2020  con))).         
+00019b60: 2020 206f 7264 6572 5f62 795f 636f 6e5f     order_by_con_
+00019b70: 6d61 696e 203d 206e 702e 7a65 726f 7328  main = np.zeros(
+00019b80: 6c65 6e28 6172 675f 7465 7874 5f63 6f6e  len(arg_text_con
+00019b90: 2929 0a0a 2020 2020 2020 2020 2020 2020  ))..            
+00019ba0: 7265 665f 706f 696e 7420 3d20 300a 2020  ref_point = 0.  
+00019bb0: 2020 2020 2020 2020 2020 6f72 6465 725f            order_
+00019bc0: 6f66 5f74 6578 7473 5f74 6f74 203d 205b  of_texts_tot = [
+00019bd0: 5d0a 2020 2020 2020 2020 2020 2020 6964  ].            id
+00019be0: 5f6f 665f 7465 7874 735f 746f 7420 3d20  _of_texts_tot = 
+00019bf0: 5b5d 0a20 2020 2020 2020 2020 2020 2066  [].            f
+00019c00: 6f72 2069 696a 2069 6e20 7261 6e67 6528  or iij in range(
+00019c10: 6c65 6e28 626f 7865 7329 293a 0a20 2020  len(boxes)):.   
+00019c20: 2020 2020 2020 2020 2020 2020 2061 7267               arg
+00019c30: 735f 636f 6e74 6f75 7273 5f62 6f78 203d  s_contours_box =
+00019c40: 2061 7267 735f 636f 6e74 6f75 7273 5b6e   args_contours[n
+00019c50: 702e 6172 7261 7928 6172 675f 7465 7874  p.array(arg_text
+00019c60: 5f63 6f6e 2920 3d3d 2069 696a 5d0a 2020  _con) == iij].  
+00019c70: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00019c80: 6e5f 696e 7465 725f 626f 7820 3d20 5b5d  n_inter_box = []
+00019c90: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00019ca0: 2063 6f6e 5f69 6e74 6572 5f62 6f78 5f68   con_inter_box_h
+00019cb0: 203d 205b 5d0a 2020 2020 2020 2020 2020   = [].          
+00019cc0: 2020 2020 2020 666f 7220 6920 696e 2072        for i in r
+00019cd0: 616e 6765 286c 656e 2861 7267 735f 636f  ange(len(args_co
+00019ce0: 6e74 6f75 7273 5f62 6f78 2929 3a0a 2020  ntours_box)):.  
+00019cf0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019d00: 2020 636f 6e5f 696e 7465 725f 626f 782e    con_inter_box.
+00019d10: 6170 7065 6e64 2863 6f6e 746f 7572 735f  append(contours_
+00019d20: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
+00019d30: 5b61 7267 735f 636f 6e74 6f75 7273 5f62  [args_contours_b
+00019d40: 6f78 5b69 5d5d 290a 0a20 2020 2020 2020  ox[i]])..       
+00019d50: 2020 2020 2020 2020 2069 6e64 6578 6573           indexes
+00019d60: 5f73 6f72 7465 642c 206d 6174 7269 785f  _sorted, matrix_
+00019d70: 6f66 5f6f 7264 6572 732c 206b 696e 645f  of_orders, kind_
+00019d80: 6f66 5f74 6578 7473 5f73 6f72 7465 642c  of_texts_sorted,
+00019d90: 2069 6e64 6578 5f62 795f 6b69 6e64 5f73   index_by_kind_s
+00019da0: 6f72 7465 6420 3d20 6f72 6465 725f 6f66  orted = order_of
+00019db0: 5f72 6567 696f 6e73 2874 6578 746c 696e  _regions(textlin
+00019dc0: 655f 6d61 736b 5f74 6f74 5b69 6e74 2862  e_mask_tot[int(b
+00019dd0: 6f78 6573 5b69 696a 5d5b 325d 2920 3a20  oxes[iij][2]) : 
+00019de0: 696e 7428 626f 7865 735b 6969 6a5d 5b33  int(boxes[iij][3
+00019df0: 5d29 2c20 696e 7428 626f 7865 735b 6969  ]), int(boxes[ii
+00019e00: 6a5d 5b30 5d29 203a 2069 6e74 2862 6f78  j][0]) : int(box
+00019e10: 6573 5b69 696a 5d5b 315d 295d 2c20 636f  es[iij][1])], co
+00019e20: 6e5f 696e 7465 725f 626f 782c 2063 6f6e  n_inter_box, con
+00019e30: 5f69 6e74 6572 5f62 6f78 5f68 2c20 626f  _inter_box_h, bo
+00019e40: 7865 735b 6969 6a5d 5b32 5d29 0a0a 2020  xes[iij][2])..  
+00019e50: 2020 2020 2020 2020 2020 2020 2020 6f72                or
+00019e60: 6465 725f 6f66 5f74 6578 7473 2c20 6964  der_of_texts, id
+00019e70: 5f6f 665f 7465 7874 7320 3d20 6f72 6465  _of_texts = orde
+00019e80: 725f 616e 645f 6964 5f6f 665f 7465 7874  r_and_id_of_text
+00019e90: 7328 636f 6e5f 696e 7465 725f 626f 782c  s(con_inter_box,
+00019ea0: 2063 6f6e 5f69 6e74 6572 5f62 6f78 5f68   con_inter_box_h
+00019eb0: 2c20 6d61 7472 6978 5f6f 665f 6f72 6465  , matrix_of_orde
+00019ec0: 7273 2c20 696e 6465 7865 735f 736f 7274  rs, indexes_sort
+00019ed0: 6564 2c20 696e 6465 785f 6279 5f6b 696e  ed, index_by_kin
+00019ee0: 645f 736f 7274 6564 2c20 6b69 6e64 5f6f  d_sorted, kind_o
+00019ef0: 665f 7465 7874 735f 736f 7274 6564 2c20  f_texts_sorted, 
+00019f00: 7265 665f 706f 696e 7429 0a0a 2020 2020  ref_point)..    
+00019f10: 2020 2020 2020 2020 2020 2020 696e 6465              inde
+00019f20: 7865 735f 736f 7274 6564 5f6d 6169 6e20  xes_sorted_main 
+00019f30: 3d20 6e70 2e61 7272 6179 2869 6e64 6578  = np.array(index
+00019f40: 6573 5f73 6f72 7465 6429 5b6e 702e 6172  es_sorted)[np.ar
+00019f50: 7261 7928 6b69 6e64 5f6f 665f 7465 7874  ray(kind_of_text
+00019f60: 735f 736f 7274 6564 2920 3d3d 2031 5d0a  s_sorted) == 1].
+00019f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00019f80: 696e 6465 7865 735f 6279 5f74 7970 655f  indexes_by_type_
+00019f90: 6d61 696e 203d 206e 702e 6172 7261 7928  main = np.array(
+00019fa0: 696e 6465 785f 6279 5f6b 696e 645f 736f  index_by_kind_so
+00019fb0: 7274 6564 295b 6e70 2e61 7272 6179 286b  rted)[np.array(k
+00019fc0: 696e 645f 6f66 5f74 6578 7473 5f73 6f72  ind_of_texts_sor
+00019fd0: 7465 6429 203d 3d20 315d 0a0a 2020 2020  ted) == 1]..    
+00019fe0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+00019ff0: 7a61 686c 6572 2c20 5f20 696e 2065 6e75  zahler, _ in enu
+0001a000: 6d65 7261 7465 2861 7267 735f 636f 6e74  merate(args_cont
+0001a010: 6f75 7273 5f62 6f78 293a 0a20 2020 2020  ours_box):.     
+0001a020: 2020 2020 2020 2020 2020 2020 2020 2061                 a
+0001a030: 7267 5f6f 7264 6572 5f76 203d 2069 6e64  rg_order_v = ind
+0001a040: 6578 6573 5f73 6f72 7465 645f 6d61 696e  exes_sorted_main
+0001a050: 5b7a 6168 6c65 725d 0a20 2020 2020 2020  [zahler].       
+0001a060: 2020 2020 2020 2020 2020 2020 206f 7264               ord
+0001a070: 6572 5f62 795f 636f 6e5f 6d61 696e 5b61  er_by_con_main[a
+0001a080: 7267 735f 636f 6e74 6f75 7273 5f62 6f78  rgs_contours_box
+0001a090: 5b69 6e64 6578 6573 5f62 795f 7479 7065  [indexes_by_type
+0001a0a0: 5f6d 6169 6e5b 7a61 686c 6572 5d5d 5d20  _main[zahler]]] 
+0001a0b0: 3d20 6e70 2e77 6865 7265 2869 6e64 6578  = np.where(index
+0001a0c0: 6573 5f73 6f72 7465 6420 3d3d 2061 7267  es_sorted == arg
+0001a0d0: 5f6f 7264 6572 5f76 295b 305d 5b30 5d20  _order_v)[0][0] 
+0001a0e0: 2b20 7265 665f 706f 696e 740a 0a20 2020  + ref_point..   
+0001a0f0: 2020 2020 2020 2020 2020 2020 2066 6f72               for
+0001a100: 206a 6a69 2c20 5f20 696e 2065 6e75 6d65   jji, _ in enume
+0001a110: 7261 7465 2869 645f 6f66 5f74 6578 7473  rate(id_of_texts
+0001a120: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001a130: 2020 2020 2020 206f 7264 6572 5f6f 665f         order_of_
+0001a140: 7465 7874 735f 746f 742e 6170 7065 6e64  texts_tot.append
+0001a150: 286f 7264 6572 5f6f 665f 7465 7874 735b  (order_of_texts[
+0001a160: 6a6a 695d 202b 2072 6566 5f70 6f69 6e74  jji] + ref_point
+0001a170: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001a180: 2020 2020 2020 6964 5f6f 665f 7465 7874        id_of_text
+0001a190: 735f 746f 742e 6170 7065 6e64 2869 645f  s_tot.append(id_
+0001a1a0: 6f66 5f74 6578 7473 5b6a 6a69 5d29 0a20  of_texts[jji]). 
+0001a1b0: 2020 2020 2020 2020 2020 2020 2020 2072                 r
+0001a1c0: 6566 5f70 6f69 6e74 202b 3d20 6c65 6e28  ef_point += len(
+0001a1d0: 6964 5f6f 665f 7465 7874 7329 0a0a 2020  id_of_texts)..  
+0001a1e0: 2020 2020 2020 2020 2020 6f72 6465 725f            order_
+0001a1f0: 6f66 5f74 6578 7473 5f74 6f74 203d 205b  of_texts_tot = [
+0001a200: 5d0a 2020 2020 2020 2020 2020 2020 666f  ].            fo
+0001a210: 7220 746a 3120 696e 2072 616e 6765 286c  r tj1 in range(l
+0001a220: 656e 2863 6f6e 746f 7572 735f 6f6e 6c79  en(contours_only
+0001a230: 5f74 6578 745f 7061 7265 6e74 2929 3a0a  _text_parent)):.
+0001a240: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001a250: 6f72 6465 725f 6f66 5f74 6578 7473 5f74  order_of_texts_t
+0001a260: 6f74 2e61 7070 656e 6428 696e 7428 6f72  ot.append(int(or
+0001a270: 6465 725f 6279 5f63 6f6e 5f6d 6169 6e5b  der_by_con_main[
+0001a280: 746a 315d 2929 0a0a 2020 2020 2020 2020  tj1]))..        
+0001a290: 2020 2020 6f72 6465 725f 7465 7874 5f6e      order_text_n
+0001a2a0: 6577 203d 205b 5d0a 2020 2020 2020 2020  ew = [].        
+0001a2b0: 2020 2020 666f 7220 6969 6920 696e 2072      for iii in r
+0001a2c0: 616e 6765 286c 656e 286f 7264 6572 5f6f  ange(len(order_o
+0001a2d0: 665f 7465 7874 735f 746f 7429 293a 0a20  f_texts_tot)):. 
+0001a2e0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0001a2f0: 7264 6572 5f74 6578 745f 6e65 772e 6170  rder_text_new.ap
+0001a300: 7065 6e64 286e 702e 7768 6572 6528 6e70  pend(np.where(np
+0001a310: 2e61 7272 6179 286f 7264 6572 5f6f 665f  .array(order_of_
+0001a320: 7465 7874 735f 746f 7429 203d 3d20 6969  texts_tot) == ii
+0001a330: 6929 5b30 5d5b 305d 290a 2020 2020 2020  i)[0][0]).      
+0001a340: 2020 0a20 2020 2020 2020 2065 7863 6570    .        excep
+0001a350: 7420 4578 6365 7074 696f 6e20 6173 2077  t Exception as w
+0001a360: 6879 3a0a 2020 2020 2020 2020 2020 2020  hy:.            
+0001a370: 7365 6c66 2e6c 6f67 6765 722e 6572 726f  self.logger.erro
+0001a380: 7228 7768 7929 0a20 2020 2020 2020 2020  r(why).         
+0001a390: 2020 2061 7267 5f74 6578 745f 636f 6e20     arg_text_con 
+0001a3a0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+0001a3b0: 2066 6f72 2069 6920 696e 2072 616e 6765   for ii in range
+0001a3c0: 286c 656e 2863 785f 7465 7874 5f6f 6e6c  (len(cx_text_onl
+0001a3d0: 7929 293a 0a20 2020 2020 2020 2020 2020  y)):.           
+0001a3e0: 2020 2020 2066 6f72 206a 6a20 696e 2072       for jj in r
+0001a3f0: 616e 6765 286c 656e 2862 6f78 6573 2929  ange(len(boxes))
+0001a400: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001a410: 2020 2020 2020 6966 2063 785f 7465 7874        if cx_text
+0001a420: 5f6f 6e6c 795b 6969 5d20 3e3d 2062 6f78  _only[ii] >= box
+0001a430: 6573 5b6a 6a5d 5b30 5d20 616e 6420 6378  es[jj][0] and cx
+0001a440: 5f74 6578 745f 6f6e 6c79 5b69 695d 203c  _text_only[ii] <
+0001a450: 2062 6f78 6573 5b6a 6a5d 5b31 5d20 616e   boxes[jj][1] an
+0001a460: 6420 6379 5f74 6578 745f 6f6e 6c79 5b69  d cy_text_only[i
+0001a470: 695d 203e 3d20 626f 7865 735b 6a6a 5d5b  i] >= boxes[jj][
+0001a480: 325d 2061 6e64 2063 795f 7465 7874 5f6f  2] and cy_text_o
+0001a490: 6e6c 795b 6969 5d20 3c20 626f 7865 735b  nly[ii] < boxes[
+0001a4a0: 6a6a 5d5b 335d 3a20 2023 2074 6869 7320  jj][3]:  # this 
+0001a4b0: 6973 2076 616c 6964 2069 6620 7468 6520  is valid if the 
+0001a4c0: 6365 6e74 6572 206f 6620 7265 6769 6f6e  center of region
+0001a4d0: 2069 6465 6e74 6966 7920 696e 2077 6869   identify in whi
+0001a4e0: 6368 2062 6f78 2069 7420 6973 206c 6f63  ch box it is loc
+0001a4f0: 6174 6564 0a20 2020 2020 2020 2020 2020  ated.           
+0001a500: 2020 2020 2020 2020 2020 2020 2061 7267               arg
+0001a510: 5f74 6578 745f 636f 6e2e 6170 7065 6e64  _text_con.append
+0001a520: 286a 6a29 0a20 2020 2020 2020 2020 2020  (jj).           
+0001a530: 2020 2020 2020 2020 2020 2020 2062 7265               bre
+0001a540: 616b 0a20 2020 2020 2020 2020 2020 2061  ak.            a
+0001a550: 7267 735f 636f 6e74 6f75 7273 203d 206e  rgs_contours = n
+0001a560: 702e 6172 7261 7928 7261 6e67 6528 6c65  p.array(range(le
+0001a570: 6e28 6172 675f 7465 7874 5f63 6f6e 2929  n(arg_text_con))
+0001a580: 290a 0a20 2020 2020 2020 2020 2020 206f  )..            o
+0001a590: 7264 6572 5f62 795f 636f 6e5f 6d61 696e  rder_by_con_main
+0001a5a0: 203d 206e 702e 7a65 726f 7328 6c65 6e28   = np.zeros(len(
+0001a5b0: 6172 675f 7465 7874 5f63 6f6e 2929 0a0a  arg_text_con))..
+0001a5c0: 2020 2020 2020 2020 2020 2020 7265 665f              ref_
+0001a5d0: 706f 696e 7420 3d20 300a 2020 2020 2020  point = 0.      
+0001a5e0: 2020 2020 2020 6f72 6465 725f 6f66 5f74        order_of_t
+0001a5f0: 6578 7473 5f74 6f74 203d 205b 5d0a 2020  exts_tot = [].  
+0001a600: 2020 2020 2020 2020 2020 6964 5f6f 665f            id_of_
+0001a610: 7465 7874 735f 746f 7420 3d20 5b5d 0a20  texts_tot = []. 
+0001a620: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0001a630: 696a 2069 6e20 7261 6e67 6528 6c65 6e28  ij in range(len(
+0001a640: 626f 7865 7329 293a 0a20 2020 2020 2020  boxes)):.       
+0001a650: 2020 2020 2020 2020 2061 7267 735f 636f           args_co
+0001a660: 6e74 6f75 7273 5f62 6f78 203d 2061 7267  ntours_box = arg
+0001a670: 735f 636f 6e74 6f75 7273 5b6e 702e 6172  s_contours[np.ar
+0001a680: 7261 7928 6172 675f 7465 7874 5f63 6f6e  ray(arg_text_con
+0001a690: 2920 3d3d 2069 696a 5d0a 2020 2020 2020  ) == iij].      
+0001a6a0: 2020 2020 2020 2020 2020 636f 6e5f 696e            con_in
+0001a6b0: 7465 725f 626f 7820 3d20 5b5d 0a20 2020  ter_box = [].   
+0001a6c0: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+0001a6d0: 5f69 6e74 6572 5f62 6f78 5f68 203d 205b  _inter_box_h = [
+0001a6e0: 5d0a 0a20 2020 2020 2020 2020 2020 2020  ]..             
+0001a6f0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+0001a700: 6528 6c65 6e28 6172 6773 5f63 6f6e 746f  e(len(args_conto
+0001a710: 7572 735f 626f 7829 293a 0a20 2020 2020  urs_box)):.     
+0001a720: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+0001a730: 6f6e 5f69 6e74 6572 5f62 6f78 2e61 7070  on_inter_box.app
+0001a740: 656e 6428 636f 6e74 6f75 7273 5f6f 6e6c  end(contours_onl
+0001a750: 795f 7465 7874 5f70 6172 656e 745b 6172  y_text_parent[ar
+0001a760: 6773 5f63 6f6e 746f 7572 735f 626f 785b  gs_contours_box[
+0001a770: 695d 5d29 0a0a 2020 2020 2020 2020 2020  i]])..          
+0001a780: 2020 2020 2020 696e 6465 7865 735f 736f        indexes_so
+0001a790: 7274 6564 2c20 6d61 7472 6978 5f6f 665f  rted, matrix_of_
+0001a7a0: 6f72 6465 7273 2c20 6b69 6e64 5f6f 665f  orders, kind_of_
+0001a7b0: 7465 7874 735f 736f 7274 6564 2c20 696e  texts_sorted, in
+0001a7c0: 6465 785f 6279 5f6b 696e 645f 736f 7274  dex_by_kind_sort
+0001a7d0: 6564 203d 206f 7264 6572 5f6f 665f 7265  ed = order_of_re
+0001a7e0: 6769 6f6e 7328 7465 7874 6c69 6e65 5f6d  gions(textline_m
+0001a7f0: 6173 6b5f 746f 745b 696e 7428 626f 7865  ask_tot[int(boxe
+0001a800: 735b 6969 6a5d 5b32 5d29 203a 2069 6e74  s[iij][2]) : int
+0001a810: 2862 6f78 6573 5b69 696a 5d5b 335d 292c  (boxes[iij][3]),
+0001a820: 2069 6e74 2862 6f78 6573 5b69 696a 5d5b   int(boxes[iij][
+0001a830: 305d 2920 3a20 696e 7428 626f 7865 735b  0]) : int(boxes[
+0001a840: 6969 6a5d 5b31 5d29 5d2c 2063 6f6e 5f69  iij][1])], con_i
+0001a850: 6e74 6572 5f62 6f78 2c20 636f 6e5f 696e  nter_box, con_in
+0001a860: 7465 725f 626f 785f 682c 2062 6f78 6573  ter_box_h, boxes
+0001a870: 5b69 696a 5d5b 325d 290a 0a20 2020 2020  [iij][2])..     
+0001a880: 2020 2020 2020 2020 2020 206f 7264 6572             order
+0001a890: 5f6f 665f 7465 7874 732c 2069 645f 6f66  _of_texts, id_of
+0001a8a0: 5f74 6578 7473 203d 206f 7264 6572 5f61  _texts = order_a
+0001a8b0: 6e64 5f69 645f 6f66 5f74 6578 7473 2863  nd_id_of_texts(c
+0001a8c0: 6f6e 5f69 6e74 6572 5f62 6f78 2c20 636f  on_inter_box, co
+0001a8d0: 6e5f 696e 7465 725f 626f 785f 682c 206d  n_inter_box_h, m
+0001a8e0: 6174 7269 785f 6f66 5f6f 7264 6572 732c  atrix_of_orders,
+0001a8f0: 2069 6e64 6578 6573 5f73 6f72 7465 642c   indexes_sorted,
+0001a900: 2069 6e64 6578 5f62 795f 6b69 6e64 5f73   index_by_kind_s
+0001a910: 6f72 7465 642c 206b 696e 645f 6f66 5f74  orted, kind_of_t
+0001a920: 6578 7473 5f73 6f72 7465 642c 2072 6566  exts_sorted, ref
+0001a930: 5f70 6f69 6e74 290a 0a20 2020 2020 2020  _point)..       
+0001a940: 2020 2020 2020 2020 2069 6e64 6578 6573           indexes
+0001a950: 5f73 6f72 7465 645f 6d61 696e 203d 206e  _sorted_main = n
+0001a960: 702e 6172 7261 7928 696e 6465 7865 735f  p.array(indexes_
+0001a970: 736f 7274 6564 295b 6e70 2e61 7272 6179  sorted)[np.array
+0001a980: 286b 696e 645f 6f66 5f74 6578 7473 5f73  (kind_of_texts_s
+0001a990: 6f72 7465 6429 203d 3d20 315d 0a20 2020  orted) == 1].   
+0001a9a0: 2020 2020 2020 2020 2020 2020 2069 6e64               ind
+0001a9b0: 6578 6573 5f62 795f 7479 7065 5f6d 6169  exes_by_type_mai
+0001a9c0: 6e20 3d20 6e70 2e61 7272 6179 2869 6e64  n = np.array(ind
+0001a9d0: 6578 5f62 795f 6b69 6e64 5f73 6f72 7465  ex_by_kind_sorte
+0001a9e0: 6429 5b6e 702e 6172 7261 7928 6b69 6e64  d)[np.array(kind
+0001a9f0: 5f6f 665f 7465 7874 735f 736f 7274 6564  _of_texts_sorted
+0001aa00: 2920 3d3d 2031 5d0a 0a20 2020 2020 2020  ) == 1]..       
+0001aa10: 2020 2020 2020 2020 2066 6f72 207a 6168           for zah
+0001aa20: 6c65 722c 205f 2069 6e20 656e 756d 6572  ler, _ in enumer
+0001aa30: 6174 6528 6172 6773 5f63 6f6e 746f 7572  ate(args_contour
+0001aa40: 735f 626f 7829 3a0a 2020 2020 2020 2020  s_box):.        
+0001aa50: 2020 2020 2020 2020 2020 2020 6172 675f              arg_
+0001aa60: 6f72 6465 725f 7620 3d20 696e 6465 7865  order_v = indexe
+0001aa70: 735f 736f 7274 6564 5f6d 6169 6e5b 7a61  s_sorted_main[za
+0001aa80: 686c 6572 5d0a 2020 2020 2020 2020 2020  hler].          
+0001aa90: 2020 2020 2020 2020 2020 6f72 6465 725f            order_
+0001aaa0: 6279 5f63 6f6e 5f6d 6169 6e5b 6172 6773  by_con_main[args
+0001aab0: 5f63 6f6e 746f 7572 735f 626f 785b 696e  _contours_box[in
+0001aac0: 6465 7865 735f 6279 5f74 7970 655f 6d61  dexes_by_type_ma
+0001aad0: 696e 5b7a 6168 6c65 725d 5d5d 203d 206e  in[zahler]]] = n
+0001aae0: 702e 7768 6572 6528 696e 6465 7865 735f  p.where(indexes_
+0001aaf0: 736f 7274 6564 203d 3d20 6172 675f 6f72  sorted == arg_or
+0001ab00: 6465 725f 7629 5b30 5d5b 305d 202b 2072  der_v)[0][0] + r
+0001ab10: 6566 5f70 6f69 6e74 0a0a 2020 2020 2020  ef_point..      
+0001ab20: 2020 2020 2020 2020 2020 666f 7220 6a6a            for jj
+0001ab30: 692c 205f 2069 6e20 656e 756d 6572 6174  i, _ in enumerat
+0001ab40: 6528 6964 5f6f 665f 7465 7874 7329 3a0a  e(id_of_texts):.
+0001ab50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ab60: 2020 2020 6f72 6465 725f 6f66 5f74 6578      order_of_tex
+0001ab70: 7473 5f74 6f74 2e61 7070 656e 6428 6f72  ts_tot.append(or
+0001ab80: 6465 725f 6f66 5f74 6578 7473 5b6a 6a69  der_of_texts[jji
+0001ab90: 5d20 2b20 7265 665f 706f 696e 7429 0a20  ] + ref_point). 
+0001aba0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001abb0: 2020 2069 645f 6f66 5f74 6578 7473 5f74     id_of_texts_t
+0001abc0: 6f74 2e61 7070 656e 6428 6964 5f6f 665f  ot.append(id_of_
+0001abd0: 7465 7874 735b 6a6a 695d 290a 2020 2020  texts[jji]).    
+0001abe0: 2020 2020 2020 2020 2020 2020 7265 665f              ref_
+0001abf0: 706f 696e 7420 2b3d 206c 656e 2869 645f  point += len(id_
+0001ac00: 6f66 5f74 6578 7473 290a 0a20 2020 2020  of_texts)..     
+0001ac10: 2020 2020 2020 206f 7264 6572 5f6f 665f         order_of_
+0001ac20: 7465 7874 735f 746f 7420 3d20 5b5d 0a20  texts_tot = []. 
+0001ac30: 2020 2020 2020 2020 2020 2066 6f72 2074             for t
+0001ac40: 6a31 2069 6e20 7261 6e67 6528 6c65 6e28  j1 in range(len(
+0001ac50: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
+0001ac60: 7874 5f70 6172 656e 7429 293a 0a20 2020  xt_parent)):.   
+0001ac70: 2020 2020 2020 2020 2020 2020 206f 7264               ord
+0001ac80: 6572 5f6f 665f 7465 7874 735f 746f 742e  er_of_texts_tot.
+0001ac90: 6170 7065 6e64 2869 6e74 286f 7264 6572  append(int(order
+0001aca0: 5f62 795f 636f 6e5f 6d61 696e 5b74 6a31  _by_con_main[tj1
+0001acb0: 5d29 290a 0a20 2020 2020 2020 2020 2020  ]))..           
+0001acc0: 206f 7264 6572 5f74 6578 745f 6e65 7720   order_text_new 
+0001acd0: 3d20 5b5d 0a20 2020 2020 2020 2020 2020  = [].           
+0001ace0: 2066 6f72 2069 6969 2069 6e20 7261 6e67   for iii in rang
+0001acf0: 6528 6c65 6e28 6f72 6465 725f 6f66 5f74  e(len(order_of_t
+0001ad00: 6578 7473 5f74 6f74 2929 3a0a 2020 2020  exts_tot)):.    
+0001ad10: 2020 2020 2020 2020 2020 2020 6f72 6465              orde
+0001ad20: 725f 7465 7874 5f6e 6577 2e61 7070 656e  r_text_new.appen
+0001ad30: 6428 6e70 2e77 6865 7265 286e 702e 6172  d(np.where(np.ar
+0001ad40: 7261 7928 6f72 6465 725f 6f66 5f74 6578  ray(order_of_tex
+0001ad50: 7473 5f74 6f74 2920 3d3d 2069 6969 295b  ts_tot) == iii)[
+0001ad60: 305d 5b30 5d29 0a20 2020 2020 2020 200a  0][0]).        .
+0001ad70: 2020 2020 2020 2020 7265 7475 726e 206f          return o
+0001ad80: 7264 6572 5f74 6578 745f 6e65 772c 2069  rder_text_new, i
+0001ad90: 645f 6f66 5f74 6578 7473 5f74 6f74 0a20  d_of_texts_tot. 
+0001ada0: 2020 2064 6566 2063 6865 636b 5f69 6f75     def check_iou
+0001adb0: 5f6f 665f 626f 756e 6469 6e67 5f62 6f78  _of_bounding_box
+0001adc0: 5f61 6e64 5f63 6f6e 746f 7572 5f66 6f72  _and_contour_for
+0001add0: 5f74 6162 6c65 7328 7365 6c66 2c20 6c61  _tables(self, la
+0001ade0: 796f 7574 2c20 7461 626c 655f 7072 6564  yout, table_pred
+0001adf0: 6963 7469 6f6e 5f65 6172 6c79 2c20 7069  iction_early, pi
+0001ae00: 7865 6c5f 7461 6265 6c2c 206e 756d 5f63  xel_tabel, num_c
+0001ae10: 6f6c 5f63 6c61 7373 6966 6965 7229 3a0a  ol_classifier):.
+0001ae20: 2020 2020 2020 2020 6c61 796f 7574 5f6f          layout_o
+0001ae30: 7267 2020 3d20 6e70 2e63 6f70 7928 6c61  rg  = np.copy(la
+0001ae40: 796f 7574 290a 2020 2020 2020 2020 6c61  yout).        la
+0001ae50: 796f 7574 5f6f 7267 5b3a 2c3a 2c30 5d5b  yout_org[:,:,0][
+0001ae60: 6c61 796f 7574 5f6f 7267 5b3a 2c3a 2c30  layout_org[:,:,0
+0001ae70: 5d3d 3d70 6978 656c 5f74 6162 656c 5d20  ]==pixel_tabel] 
+0001ae80: 3d20 300a 2020 2020 2020 2020 6c61 796f  = 0.        layo
+0001ae90: 7574 203d 2028 6c61 796f 7574 5b3a 2c3a  ut = (layout[:,:
+0001aea0: 2c30 5d3d 3d70 6978 656c 5f74 6162 656c  ,0]==pixel_tabel
+0001aeb0: 292a 310a 0a20 2020 2020 2020 206c 6179  )*1..        lay
+0001aec0: 6f75 7420 3d6e 702e 7265 7065 6174 286c  out =np.repeat(l
+0001aed0: 6179 6f75 745b 3a2c 203a 2c20 6e70 2e6e  ayout[:, :, np.n
+0001aee0: 6577 6178 6973 5d2c 2033 2c20 6178 6973  ewaxis], 3, axis
+0001aef0: 3d32 290a 2020 2020 2020 2020 6c61 796f  =2).        layo
+0001af00: 7574 203d 206c 6179 6f75 742e 6173 7479  ut = layout.asty
+0001af10: 7065 286e 702e 7569 6e74 3829 0a20 2020  pe(np.uint8).   
+0001af20: 2020 2020 2069 6d67 7261 7920 3d20 6376       imgray = cv
+0001af30: 322e 6376 7443 6f6c 6f72 286c 6179 6f75  2.cvtColor(layou
+0001af40: 742c 2063 7632 2e43 4f4c 4f52 5f42 4752  t, cv2.COLOR_BGR
+0001af50: 3247 5241 5920 290a 2020 2020 2020 2020  2GRAY ).        
+0001af60: 5f2c 2074 6872 6573 6820 3d20 6376 322e  _, thresh = cv2.
+0001af70: 7468 7265 7368 6f6c 6428 696d 6772 6179  threshold(imgray
+0001af80: 2c20 302c 2032 3535 2c20 3029 0a0a 2020  , 0, 255, 0)..  
+0001af90: 2020 2020 2020 636f 6e74 6f75 7273 2c20        contours, 
+0001afa0: 5f20 3d20 6376 322e 6669 6e64 436f 6e74  _ = cv2.findCont
+0001afb0: 6f75 7273 2874 6872 6573 682c 2063 7632  ours(thresh, cv2
+0001afc0: 2e52 4554 525f 5452 4545 2c20 6376 322e  .RETR_TREE, cv2.
+0001afd0: 4348 4149 4e5f 4150 5052 4f58 5f53 494d  CHAIN_APPROX_SIM
+0001afe0: 504c 4529 0a20 2020 2020 2020 2063 6e74  PLE).        cnt
+0001aff0: 5f73 697a 6520 3d20 6e70 2e61 7272 6179  _size = np.array
+0001b000: 285b 6376 322e 636f 6e74 6f75 7241 7265  ([cv2.contourAre
+0001b010: 6128 636f 6e74 6f75 7273 5b6a 5d29 2066  a(contours[j]) f
+0001b020: 6f72 206a 2069 6e20 7261 6e67 6528 6c65  or j in range(le
+0001b030: 6e28 636f 6e74 6f75 7273 2929 5d29 0a20  n(contours))]). 
+0001b040: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0001b050: 636f 6e74 6f75 7273 5f6e 6577 203d 205b  contours_new = [
+0001b060: 5d0a 2020 2020 2020 2020 666f 7220 6920  ].        for i 
+0001b070: 696e 2072 616e 6765 286c 656e 2863 6f6e  in range(len(con
+0001b080: 746f 7572 7329 293a 0a20 2020 2020 2020  tours)):.       
+0001b090: 2020 2020 2078 2c20 792c 2077 2c20 6820       x, y, w, h 
+0001b0a0: 3d20 6376 322e 626f 756e 6469 6e67 5265  = cv2.boundingRe
+0001b0b0: 6374 2863 6f6e 746f 7572 735b 695d 290a  ct(contours[i]).
+0001b0c0: 2020 2020 2020 2020 2020 2020 696f 7520              iou 
+0001b0d0: 3d20 636e 745f 7369 7a65 5b69 5d20 2f66  = cnt_size[i] /f
+0001b0e0: 6c6f 6174 2877 2a68 2920 2a31 3030 0a20  loat(w*h) *100. 
+0001b0f0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+0001b100: 2020 2020 2020 2020 6966 2069 6f75 3c38          if iou<8
+0001b110: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+0001b120: 2020 206c 6179 6f75 745f 636f 6e74 6f75     layout_contou
+0001b130: 7220 3d20 6e70 2e7a 6572 6f73 2828 6c61  r = np.zeros((la
+0001b140: 796f 7574 5f6f 7267 2e73 6861 7065 5b30  yout_org.shape[0
+0001b150: 5d2c 206c 6179 6f75 745f 6f72 672e 7368  ], layout_org.sh
+0001b160: 6170 655b 315d 2929 0a20 2020 2020 2020  ape[1])).       
+0001b170: 2020 2020 2020 2020 206c 6179 6f75 745f           layout_
+0001b180: 636f 6e74 6f75 723d 2063 7632 2e66 696c  contour= cv2.fil
+0001b190: 6c50 6f6c 7928 6c61 796f 7574 5f63 6f6e  lPoly(layout_con
+0001b1a0: 746f 7572 2c70 7473 3d5b 636f 6e74 6f75  tour,pts=[contou
+0001b1b0: 7273 5b69 5d5d 202c 636f 6c6f 723d 2831  rs[i]] ,color=(1
+0001b1c0: 2c31 2c31 2929 0a20 2020 2020 2020 2020  ,1,1)).         
+0001b1d0: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0001b1e0: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0001b1f0: 2020 2020 2020 2020 206c 6179 6f75 745f           layout_
+0001b200: 636f 6e74 6f75 725f 7375 6d20 3d20 6c61  contour_sum = la
+0001b210: 796f 7574 5f63 6f6e 746f 7572 2e73 756d  yout_contour.sum
+0001b220: 2861 7869 733d 3029 0a20 2020 2020 2020  (axis=0).       
+0001b230: 2020 2020 2020 2020 206c 6179 6f75 745f           layout_
+0001b240: 636f 6e74 6f75 725f 7375 6d5f 6469 6666  contour_sum_diff
+0001b250: 203d 206e 702e 6469 6666 286c 6179 6f75   = np.diff(layou
+0001b260: 745f 636f 6e74 6f75 725f 7375 6d29 0a20  t_contour_sum). 
+0001b270: 2020 2020 2020 2020 2020 2020 2020 206c                 l
+0001b280: 6179 6f75 745f 636f 6e74 6f75 725f 7375  ayout_contour_su
+0001b290: 6d5f 6469 6666 3d20 6e70 2e61 6273 286c  m_diff= np.abs(l
+0001b2a0: 6179 6f75 745f 636f 6e74 6f75 725f 7375  ayout_contour_su
+0001b2b0: 6d5f 6469 6666 290a 2020 2020 2020 2020  m_diff).        
+0001b2c0: 2020 2020 2020 2020 6c61 796f 7574 5f63          layout_c
+0001b2d0: 6f6e 746f 7572 5f73 756d 5f64 6966 665f  ontour_sum_diff_
+0001b2e0: 736d 6f6f 7468 6564 3d20 6761 7573 7369  smoothed= gaussi
+0001b2f0: 616e 5f66 696c 7465 7231 6428 6c61 796f  an_filter1d(layo
+0001b300: 7574 5f63 6f6e 746f 7572 5f73 756d 5f64  ut_contour_sum_d
+0001b310: 6966 662c 2031 3029 0a0a 2020 2020 2020  iff, 10)..      
+0001b320: 2020 2020 2020 2020 2020 7065 616b 732c            peaks,
+0001b330: 205f 203d 2066 696e 645f 7065 616b 7328   _ = find_peaks(
+0001b340: 6c61 796f 7574 5f63 6f6e 746f 7572 5f73  layout_contour_s
+0001b350: 756d 5f64 6966 665f 736d 6f6f 7468 6564  um_diff_smoothed
+0001b360: 2c20 6865 6967 6874 3d30 290a 2020 2020  , height=0).    
+0001b370: 2020 2020 2020 2020 2020 2020 7065 616b              peak
+0001b380: 733d 2070 6561 6b73 5b6c 6179 6f75 745f  s= peaks[layout_
+0001b390: 636f 6e74 6f75 725f 7375 6d5f 6469 6666  contour_sum_diff
+0001b3a0: 5f73 6d6f 6f74 6865 645b 7065 616b 735d  _smoothed[peaks]
+0001b3b0: 3e34 5d0a 2020 2020 2020 2020 2020 2020  >4].            
+0001b3c0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+0001b3d0: 2020 2020 2066 6f72 206a 2069 6e20 7261       for j in ra
+0001b3e0: 6e67 6528 6c65 6e28 7065 616b 7329 293a  nge(len(peaks)):
+0001b3f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001b400: 2020 2020 206c 6179 6f75 745f 636f 6e74       layout_cont
+0001b410: 6f75 725b 3a2c 7065 616b 735b 6a5d 2d33  our[:,peaks[j]-3
+0001b420: 2b31 3a70 6561 6b73 5b6a 5d2b 312b 335d  +1:peaks[j]+1+3]
+0001b430: 203d 2030 0a20 2020 2020 2020 2020 2020   = 0.           
+0001b440: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0001b450: 2020 2020 2020 2020 2020 6c61 796f 7574            layout
+0001b460: 5f63 6f6e 746f 7572 3d63 7632 2e65 726f  _contour=cv2.ero
+0001b470: 6465 286c 6179 6f75 745f 636f 6e74 6f75  de(layout_contou
+0001b480: 725b 3a2c 3a5d 2c20 4b45 524e 454c 2c20  r[:,:], KERNEL, 
+0001b490: 6974 6572 6174 696f 6e73 3d35 290a 2020  iterations=5).  
+0001b4a0: 2020 2020 2020 2020 2020 2020 2020 6c61                la
+0001b4b0: 796f 7574 5f63 6f6e 746f 7572 3d63 7632  yout_contour=cv2
+0001b4c0: 2e64 696c 6174 6528 6c61 796f 7574 5f63  .dilate(layout_c
+0001b4d0: 6f6e 746f 7572 5b3a 2c3a 5d2c 204b 4552  ontour[:,:], KER
+0001b4e0: 4e45 4c2c 2069 7465 7261 7469 6f6e 733d  NEL, iterations=
+0001b4f0: 3529 0a20 2020 2020 2020 2020 2020 2020  5).             
+0001b500: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+0001b510: 2020 2020 6c61 796f 7574 5f63 6f6e 746f      layout_conto
+0001b520: 7572 203d 6e70 2e72 6570 6561 7428 6c61  ur =np.repeat(la
+0001b530: 796f 7574 5f63 6f6e 746f 7572 5b3a 2c20  yout_contour[:, 
+0001b540: 3a2c 206e 702e 6e65 7761 7869 735d 2c20  :, np.newaxis], 
+0001b550: 332c 2061 7869 733d 3229 0a20 2020 2020  3, axis=2).     
+0001b560: 2020 2020 2020 2020 2020 206c 6179 6f75             layou
+0001b570: 745f 636f 6e74 6f75 7220 3d20 6c61 796f  t_contour = layo
+0001b580: 7574 5f63 6f6e 746f 7572 2e61 7374 7970  ut_contour.astyp
+0001b590: 6528 6e70 2e75 696e 7438 290a 2020 2020  e(np.uint8).    
+0001b5a0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0001b5b0: 2020 2020 2020 2020 2020 2020 2069 6d67               img
+0001b5c0: 7261 7920 3d20 6376 322e 6376 7443 6f6c  ray = cv2.cvtCol
+0001b5d0: 6f72 286c 6179 6f75 745f 636f 6e74 6f75  or(layout_contou
+0001b5e0: 722c 2063 7632 2e43 4f4c 4f52 5f42 4752  r, cv2.COLOR_BGR
+0001b5f0: 3247 5241 5920 290a 2020 2020 2020 2020  2GRAY ).        
+0001b600: 2020 2020 2020 2020 5f2c 2074 6872 6573          _, thres
+0001b610: 6820 3d20 6376 322e 7468 7265 7368 6f6c  h = cv2.threshol
+0001b620: 6428 696d 6772 6179 2c20 302c 2032 3535  d(imgray, 0, 255
+0001b630: 2c20 3029 0a0a 2020 2020 2020 2020 2020  , 0)..          
+0001b640: 2020 2020 2020 636f 6e74 6f75 7273 5f73        contours_s
+0001b650: 6570 2c20 5f20 3d20 6376 322e 6669 6e64  ep, _ = cv2.find
+0001b660: 436f 6e74 6f75 7273 2874 6872 6573 682c  Contours(thresh,
+0001b670: 2063 7632 2e52 4554 525f 5452 4545 2c20   cv2.RETR_TREE, 
+0001b680: 6376 322e 4348 4149 4e5f 4150 5052 4f58  cv2.CHAIN_APPROX
+0001b690: 5f53 494d 504c 4529 0a0a 2020 2020 2020  _SIMPLE)..      
+0001b6a0: 2020 2020 2020 2020 2020 666f 7220 6a69            for ji
+0001b6b0: 2069 6e20 7261 6e67 6528 6c65 6e28 636f   in range(len(co
+0001b6c0: 6e74 6f75 7273 5f73 6570 2920 293a 0a20  ntours_sep) ):. 
+0001b6d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b6e0: 2020 2063 6f6e 746f 7572 735f 6e65 772e     contours_new.
+0001b6f0: 6170 7065 6e64 2863 6f6e 746f 7572 735f  append(contours_
+0001b700: 7365 705b 6a69 5d29 0a20 2020 2020 2020  sep[ji]).       
+0001b710: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0001b720: 6e75 6d5f 636f 6c5f 636c 6173 7369 6669  num_col_classifi
+0001b730: 6572 3e3d 323a 0a20 2020 2020 2020 2020  er>=2:.         
+0001b740: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0001b750: 6e6c 795f 7265 6365 6e74 5f63 6f6e 746f  nly_recent_conto
+0001b760: 7572 5f69 6d61 6765 203d 206e 702e 7a65  ur_image = np.ze
+0001b770: 726f 7328 286c 6179 6f75 742e 7368 6170  ros((layout.shap
+0001b780: 655b 305d 2c6c 6179 6f75 742e 7368 6170  e[0],layout.shap
+0001b790: 655b 315d 2929 0a20 2020 2020 2020 2020  e[1])).         
+0001b7a0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0001b7b0: 6e6c 795f 7265 6365 6e74 5f63 6f6e 746f  nly_recent_conto
+0001b7c0: 7572 5f69 6d61 6765 3d20 6376 322e 6669  ur_image= cv2.fi
+0001b7d0: 6c6c 506f 6c79 286f 6e6c 795f 7265 6365  llPoly(only_rece
+0001b7e0: 6e74 5f63 6f6e 746f 7572 5f69 6d61 6765  nt_contour_image
+0001b7f0: 2c70 7473 3d5b 636f 6e74 6f75 7273 5f73  ,pts=[contours_s
+0001b800: 6570 5b6a 695d 5d20 2c63 6f6c 6f72 3d28  ep[ji]] ,color=(
+0001b810: 312c 312c 3129 290a 2020 2020 2020 2020  1,1,1)).        
+0001b820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b830: 7461 626c 655f 7069 7865 6c73 5f6d 6173  table_pixels_mas
+0001b840: 6b65 645f 6672 6f6d 5f65 6172 6c79 5f70  ked_from_early_p
+0001b850: 7265 203d 206f 6e6c 795f 7265 6365 6e74  re = only_recent
+0001b860: 5f63 6f6e 746f 7572 5f69 6d61 6765 5b3a  _contour_image[:
+0001b870: 2c3a 5d2a 7461 626c 655f 7072 6564 6963  ,:]*table_predic
+0001b880: 7469 6f6e 5f65 6172 6c79 5b3a 2c3a 5d0a  tion_early[:,:].
+0001b890: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b8a0: 2020 2020 2020 2020 696f 755f 696e 203d          iou_in =
+0001b8b0: 2074 6162 6c65 5f70 6978 656c 735f 6d61   table_pixels_ma
+0001b8c0: 736b 6564 5f66 726f 6d5f 6561 726c 795f  sked_from_early_
+0001b8d0: 7072 652e 7375 6d28 2920 2f66 6c6f 6174  pre.sum() /float
+0001b8e0: 286f 6e6c 795f 7265 6365 6e74 5f63 6f6e  (only_recent_con
+0001b8f0: 746f 7572 5f69 6d61 6765 2e73 756d 2829  tour_image.sum()
+0001b900: 2920 2a31 3030 0a20 2020 2020 2020 2020  ) *100.         
+0001b910: 2020 2020 2020 2020 2020 2020 2020 2023                 #
+0001b920: 7072 696e 7428 696f 755f 696e 2c27 696f  print(iou_in,'io
+0001b930: 755f 696e 5f69 6e31 2729 0a20 2020 2020  u_in_in1').     
+0001b940: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b950: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+0001b960: 2020 2020 2020 2020 2020 2020 6966 2069              if i
+0001b970: 6f75 5f69 6e3e 3330 3a0a 2020 2020 2020  ou_in>30:.      
+0001b980: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001b990: 2020 2020 2020 6c61 796f 7574 5f6f 7267        layout_org
+0001b9a0: 3d20 6376 322e 6669 6c6c 506f 6c79 286c  = cv2.fillPoly(l
+0001b9b0: 6179 6f75 745f 6f72 672c 7074 733d 5b63  ayout_org,pts=[c
+0001b9c0: 6f6e 746f 7572 735f 7365 705b 6a69 5d5d  ontours_sep[ji]]
+0001b9d0: 202c 636f 6c6f 723d 2870 6978 656c 5f74   ,color=(pixel_t
+0001b9e0: 6162 656c 2c70 6978 656c 5f74 6162 656c  abel,pixel_tabel
+0001b9f0: 2c70 6978 656c 5f74 6162 656c 2929 0a20  ,pixel_tabel)). 
+0001ba00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ba10: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+0001ba20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ba30: 2020 2020 2020 2020 2070 6173 730a 2020           pass.  
+0001ba40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ba50: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001ba60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ba70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001ba80: 2020 2020 2020 2020 206c 6179 6f75 745f           layout_
+0001ba90: 6f72 673d 2063 7632 2e66 696c 6c50 6f6c  org= cv2.fillPol
+0001baa0: 7928 6c61 796f 7574 5f6f 7267 2c70 7473  y(layout_org,pts
+0001bab0: 3d5b 636f 6e74 6f75 7273 5f73 6570 5b6a  =[contours_sep[j
+0001bac0: 695d 5d20 2c63 6f6c 6f72 3d28 7069 7865  i]] ,color=(pixe
+0001bad0: 6c5f 7461 6265 6c2c 7069 7865 6c5f 7461  l_tabel,pixel_ta
+0001bae0: 6265 6c2c 7069 7865 6c5f 7461 6265 6c29  bel,pixel_tabel)
+0001baf0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0001bb00: 2020 0a20 2020 2020 2020 2020 2020 2065    .            e
+0001bb10: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+0001bb20: 2020 2020 2063 6f6e 746f 7572 735f 6e65       contours_ne
+0001bb30: 772e 6170 7065 6e64 2863 6f6e 746f 7572  w.append(contour
+0001bb40: 735b 695d 290a 2020 2020 2020 2020 2020  s[i]).          
+0001bb50: 2020 2020 2020 6966 206e 756d 5f63 6f6c        if num_col
+0001bb60: 5f63 6c61 7373 6966 6965 723e 3d32 3a0a  _classifier>=2:.
+0001bb70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bb80: 2020 2020 6f6e 6c79 5f72 6563 656e 745f      only_recent_
+0001bb90: 636f 6e74 6f75 725f 696d 6167 6520 3d20  contour_image = 
+0001bba0: 6e70 2e7a 6572 6f73 2828 6c61 796f 7574  np.zeros((layout
+0001bbb0: 2e73 6861 7065 5b30 5d2c 6c61 796f 7574  .shape[0],layout
+0001bbc0: 2e73 6861 7065 5b31 5d29 290a 2020 2020  .shape[1])).    
+0001bbd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bbe0: 6f6e 6c79 5f72 6563 656e 745f 636f 6e74  only_recent_cont
+0001bbf0: 6f75 725f 696d 6167 653d 2063 7632 2e66  our_image= cv2.f
+0001bc00: 696c 6c50 6f6c 7928 6f6e 6c79 5f72 6563  illPoly(only_rec
+0001bc10: 656e 745f 636f 6e74 6f75 725f 696d 6167  ent_contour_imag
+0001bc20: 652c 7074 733d 5b63 6f6e 746f 7572 735b  e,pts=[contours[
+0001bc30: 695d 5d20 2c63 6f6c 6f72 3d28 312c 312c  i]] ,color=(1,1,
+0001bc40: 3129 290a 2020 2020 2020 2020 2020 2020  1)).            
+0001bc50: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+0001bc60: 2020 2020 2020 2020 2020 2020 2074 6162               tab
+0001bc70: 6c65 5f70 6978 656c 735f 6d61 736b 6564  le_pixels_masked
+0001bc80: 5f66 726f 6d5f 6561 726c 795f 7072 6520  _from_early_pre 
+0001bc90: 3d20 6f6e 6c79 5f72 6563 656e 745f 636f  = only_recent_co
+0001bca0: 6e74 6f75 725f 696d 6167 655b 3a2c 3a5d  ntour_image[:,:]
+0001bcb0: 2a74 6162 6c65 5f70 7265 6469 6374 696f  *table_predictio
+0001bcc0: 6e5f 6561 726c 795b 3a2c 3a5d 0a20 2020  n_early[:,:].   
+0001bcd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bce0: 2069 6f75 5f69 6e20 3d20 7461 626c 655f   iou_in = table_
+0001bcf0: 7069 7865 6c73 5f6d 6173 6b65 645f 6672  pixels_masked_fr
+0001bd00: 6f6d 5f65 6172 6c79 5f70 7265 2e73 756d  om_early_pre.sum
+0001bd10: 2829 202f 666c 6f61 7428 6f6e 6c79 5f72  () /float(only_r
+0001bd20: 6563 656e 745f 636f 6e74 6f75 725f 696d  ecent_contour_im
+0001bd30: 6167 652e 7375 6d28 2929 202a 3130 300a  age.sum()) *100.
+0001bd40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd50: 2020 2020 2370 7269 6e74 2869 6f75 5f69      #print(iou_i
+0001bd60: 6e2c 2769 6f75 5f69 6e27 290a 2020 2020  n,'iou_in').    
+0001bd70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bd80: 6966 2069 6f75 5f69 6e3e 3330 3a0a 2020  if iou_in>30:.  
+0001bd90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001bda0: 2020 2020 2020 6c61 796f 7574 5f6f 7267        layout_org
+0001bdb0: 3d20 6376 322e 6669 6c6c 506f 6c79 286c  = cv2.fillPoly(l
+0001bdc0: 6179 6f75 745f 6f72 672c 7074 733d 5b63  ayout_org,pts=[c
+0001bdd0: 6f6e 746f 7572 735b 695d 5d20 2c63 6f6c  ontours[i]] ,col
+0001bde0: 6f72 3d28 7069 7865 6c5f 7461 6265 6c2c  or=(pixel_tabel,
+0001bdf0: 7069 7865 6c5f 7461 6265 6c2c 7069 7865  pixel_tabel,pixe
+0001be00: 6c5f 7461 6265 6c29 290a 2020 2020 2020  l_tabel)).      
+0001be10: 2020 2020 2020 2020 2020 2020 2020 656c                el
+0001be20: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+0001be30: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+0001be40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001be50: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001be60: 2020 2020 2020 2020 2020 206c 6179 6f75             layou
+0001be70: 745f 6f72 673d 2063 7632 2e66 696c 6c50  t_org= cv2.fillP
+0001be80: 6f6c 7928 6c61 796f 7574 5f6f 7267 2c70  oly(layout_org,p
+0001be90: 7473 3d5b 636f 6e74 6f75 7273 5b69 5d5d  ts=[contours[i]]
+0001bea0: 202c 636f 6c6f 723d 2870 6978 656c 5f74   ,color=(pixel_t
+0001beb0: 6162 656c 2c70 6978 656c 5f74 6162 656c  abel,pixel_tabel
+0001bec0: 2c70 6978 656c 5f74 6162 656c 2929 0a20  ,pixel_tabel)). 
+0001bed0: 2020 2020 2020 2020 2020 2020 2020 200a                 .
+0001bee0: 2020 2020 2020 2020 7265 7475 726e 206c          return l
+0001bef0: 6179 6f75 745f 6f72 672c 2063 6f6e 746f  ayout_org, conto
+0001bf00: 7572 735f 6e65 770a 2020 2020 6465 6620  urs_new.    def 
+0001bf10: 6465 6c65 7465 5f73 6570 6172 6174 6f72  delete_separator
+0001bf20: 5f61 726f 756e 6428 7365 6c66 2c73 706c  _around(self,spl
+0001bf30: 6974 6572 5f79 2c70 6561 6b73 5f6e 6567  iter_y,peaks_neg
+0001bf40: 2c69 6d61 6765 5f62 795f 7265 6769 6f6e  ,image_by_region
+0001bf50: 2c20 7069 7865 6c5f 6c69 6e65 2c20 7069  , pixel_line, pi
+0001bf60: 7865 6c5f 7461 626c 6529 3a0a 2020 2020  xel_table):.    
+0001bf70: 2020 2020 2320 666f 726d 6174 206f 6620      # format of 
+0001bf80: 7375 6262 6f78 6573 3a20 626f 783d 5b78  subboxes: box=[x
+0001bf90: 312c 2078 3220 2c20 7931 2c20 7932 5d0a  1, x2 , y1, y2].
+0001bfa0: 2020 2020 2020 2020 7069 785f 6465 6c20          pix_del 
+0001bfb0: 3d20 3130 300a 2020 2020 2020 2020 6966  = 100.        if
+0001bfc0: 206c 656e 2869 6d61 6765 5f62 795f 7265   len(image_by_re
+0001bfd0: 6769 6f6e 2e73 6861 7065 293d 3d33 3a0a  gion.shape)==3:.
+0001bfe0: 2020 2020 2020 2020 2020 2020 666f 7220              for 
+0001bff0: 6920 696e 2072 616e 6765 286c 656e 2873  i in range(len(s
+0001c000: 706c 6974 6572 5f79 292d 3129 3a0a 2020  pliter_y)-1):.  
+0001c010: 2020 2020 2020 2020 2020 2020 2020 666f                fo
+0001c020: 7220 6a20 696e 2072 616e 6765 2831 2c6c  r j in range(1,l
+0001c030: 656e 2870 6561 6b73 5f6e 6567 5b69 5d29  en(peaks_neg[i])
+0001c040: 2d31 293a 0a20 2020 2020 2020 2020 2020  -1):.           
+0001c050: 2020 2020 2020 2020 2069 6d61 6765 5f62           image_b
+0001c060: 795f 7265 6769 6f6e 5b69 6e74 2873 706c  y_region[int(spl
+0001c070: 6974 6572 5f79 5b69 5d29 3a69 6e74 2873  iter_y[i]):int(s
+0001c080: 706c 6974 6572 5f79 5b69 2b31 5d29 2c70  pliter_y[i+1]),p
+0001c090: 6561 6b73 5f6e 6567 5b69 5d5b 6a5d 2d70  eaks_neg[i][j]-p
+0001c0a0: 6978 5f64 656c 3a70 6561 6b73 5f6e 6567  ix_del:peaks_neg
+0001c0b0: 5b69 5d5b 6a5d 2b70 6978 5f64 656c 2c30  [i][j]+pix_del,0
+0001c0c0: 5d5b 696d 6167 655f 6279 5f72 6567 696f  ][image_by_regio
+0001c0d0: 6e5b 696e 7428 7370 6c69 7465 725f 795b  n[int(spliter_y[
+0001c0e0: 695d 293a 696e 7428 7370 6c69 7465 725f  i]):int(spliter_
+0001c0f0: 795b 692b 315d 292c 7065 616b 735f 6e65  y[i+1]),peaks_ne
+0001c100: 675b 695d 5b6a 5d2d 7069 785f 6465 6c3a  g[i][j]-pix_del:
+0001c110: 7065 616b 735f 6e65 675b 695d 5b6a 5d2b  peaks_neg[i][j]+
+0001c120: 7069 785f 6465 6c2c 305d 3d3d 7069 7865  pix_del,0]==pixe
+0001c130: 6c5f 6c69 6e65 205d 3d30 0a20 2020 2020  l_line ]=0.     
+0001c140: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001c150: 6d61 6765 5f62 795f 7265 6769 6f6e 5b73  mage_by_region[s
+0001c160: 706c 6974 6572 5f79 5b69 5d3a 7370 6c69  pliter_y[i]:spli
+0001c170: 7465 725f 795b 692b 315d 2c70 6561 6b73  ter_y[i+1],peaks
+0001c180: 5f6e 6567 5b69 5d5b 6a5d 2d70 6978 5f64  _neg[i][j]-pix_d
+0001c190: 656c 3a70 6561 6b73 5f6e 6567 5b69 5d5b  el:peaks_neg[i][
+0001c1a0: 6a5d 2b70 6978 5f64 656c 2c30 5d5b 696d  j]+pix_del,0][im
+0001c1b0: 6167 655f 6279 5f72 6567 696f 6e5b 696e  age_by_region[in
+0001c1c0: 7428 7370 6c69 7465 725f 795b 695d 293a  t(spliter_y[i]):
+0001c1d0: 696e 7428 7370 6c69 7465 725f 795b 692b  int(spliter_y[i+
+0001c1e0: 315d 292c 7065 616b 735f 6e65 675b 695d  1]),peaks_neg[i]
+0001c1f0: 5b6a 5d2d 7069 785f 6465 6c3a 7065 616b  [j]-pix_del:peak
+0001c200: 735f 6e65 675b 695d 5b6a 5d2b 7069 785f  s_neg[i][j]+pix_
+0001c210: 6465 6c2c 315d 3d3d 7069 7865 6c5f 6c69  del,1]==pixel_li
+0001c220: 6e65 205d 3d30 0a20 2020 2020 2020 2020  ne ]=0.         
+0001c230: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+0001c240: 5f62 795f 7265 6769 6f6e 5b73 706c 6974  _by_region[split
+0001c250: 6572 5f79 5b69 5d3a 7370 6c69 7465 725f  er_y[i]:spliter_
+0001c260: 795b 692b 315d 2c70 6561 6b73 5f6e 6567  y[i+1],peaks_neg
+0001c270: 5b69 5d5b 6a5d 2d70 6978 5f64 656c 3a70  [i][j]-pix_del:p
+0001c280: 6561 6b73 5f6e 6567 5b69 5d5b 6a5d 2b70  eaks_neg[i][j]+p
+0001c290: 6978 5f64 656c 2c30 5d5b 696d 6167 655f  ix_del,0][image_
+0001c2a0: 6279 5f72 6567 696f 6e5b 696e 7428 7370  by_region[int(sp
+0001c2b0: 6c69 7465 725f 795b 695d 293a 696e 7428  liter_y[i]):int(
+0001c2c0: 7370 6c69 7465 725f 795b 692b 315d 292c  spliter_y[i+1]),
+0001c2d0: 7065 616b 735f 6e65 675b 695d 5b6a 5d2d  peaks_neg[i][j]-
+0001c2e0: 7069 785f 6465 6c3a 7065 616b 735f 6e65  pix_del:peaks_ne
+0001c2f0: 675b 695d 5b6a 5d2b 7069 785f 6465 6c2c  g[i][j]+pix_del,
+0001c300: 325d 3d3d 7069 7865 6c5f 6c69 6e65 205d  2]==pixel_line ]
+0001c310: 3d30 0a20 2020 2020 2020 2020 2020 2020  =0.             
+0001c320: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+0001c330: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+0001c340: 655f 6279 5f72 6567 696f 6e5b 696e 7428  e_by_region[int(
+0001c350: 7370 6c69 7465 725f 795b 695d 293a 696e  spliter_y[i]):in
+0001c360: 7428 7370 6c69 7465 725f 795b 692b 315d  t(spliter_y[i+1]
+0001c370: 292c 7065 616b 735f 6e65 675b 695d 5b6a  ),peaks_neg[i][j
+0001c380: 5d2d 7069 785f 6465 6c3a 7065 616b 735f  ]-pix_del:peaks_
+0001c390: 6e65 675b 695d 5b6a 5d2b 7069 785f 6465  neg[i][j]+pix_de
+0001c3a0: 6c2c 305d 5b69 6d61 6765 5f62 795f 7265  l,0][image_by_re
+0001c3b0: 6769 6f6e 5b69 6e74 2873 706c 6974 6572  gion[int(spliter
+0001c3c0: 5f79 5b69 5d29 3a69 6e74 2873 706c 6974  _y[i]):int(split
+0001c3d0: 6572 5f79 5b69 2b31 5d29 2c70 6561 6b73  er_y[i+1]),peaks
+0001c3e0: 5f6e 6567 5b69 5d5b 6a5d 2d70 6978 5f64  _neg[i][j]-pix_d
+0001c3f0: 656c 3a70 6561 6b73 5f6e 6567 5b69 5d5b  el:peaks_neg[i][
+0001c400: 6a5d 2b70 6978 5f64 656c 2c30 5d3d 3d70  j]+pix_del,0]==p
+0001c410: 6978 656c 5f74 6162 6c65 205d 3d30 0a20  ixel_table ]=0. 
+0001c420: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c430: 2020 2069 6d61 6765 5f62 795f 7265 6769     image_by_regi
+0001c440: 6f6e 5b69 6e74 2873 706c 6974 6572 5f79  on[int(spliter_y
+0001c450: 5b69 5d29 3a69 6e74 2873 706c 6974 6572  [i]):int(spliter
+0001c460: 5f79 5b69 2b31 5d29 2c70 6561 6b73 5f6e  _y[i+1]),peaks_n
+0001c470: 6567 5b69 5d5b 6a5d 2d70 6978 5f64 656c  eg[i][j]-pix_del
+0001c480: 3a70 6561 6b73 5f6e 6567 5b69 5d5b 6a5d  :peaks_neg[i][j]
+0001c490: 2b70 6978 5f64 656c 2c30 5d5b 696d 6167  +pix_del,0][imag
+0001c4a0: 655f 6279 5f72 6567 696f 6e5b 696e 7428  e_by_region[int(
+0001c4b0: 7370 6c69 7465 725f 795b 695d 293a 696e  spliter_y[i]):in
+0001c4c0: 7428 7370 6c69 7465 725f 795b 692b 315d  t(spliter_y[i+1]
+0001c4d0: 292c 7065 616b 735f 6e65 675b 695d 5b6a  ),peaks_neg[i][j
+0001c4e0: 5d2d 7069 785f 6465 6c3a 7065 616b 735f  ]-pix_del:peaks_
+0001c4f0: 6e65 675b 695d 5b6a 5d2b 7069 785f 6465  neg[i][j]+pix_de
+0001c500: 6c2c 315d 3d3d 7069 7865 6c5f 7461 626c  l,1]==pixel_tabl
+0001c510: 6520 5d3d 300a 2020 2020 2020 2020 2020  e ]=0.          
+0001c520: 2020 2020 2020 2020 2020 696d 6167 655f            image_
+0001c530: 6279 5f72 6567 696f 6e5b 696e 7428 7370  by_region[int(sp
+0001c540: 6c69 7465 725f 795b 695d 293a 696e 7428  liter_y[i]):int(
+0001c550: 7370 6c69 7465 725f 795b 692b 315d 292c  spliter_y[i+1]),
+0001c560: 7065 616b 735f 6e65 675b 695d 5b6a 5d2d  peaks_neg[i][j]-
+0001c570: 7069 785f 6465 6c3a 7065 616b 735f 6e65  pix_del:peaks_ne
+0001c580: 675b 695d 5b6a 5d2b 7069 785f 6465 6c2c  g[i][j]+pix_del,
+0001c590: 305d 5b69 6d61 6765 5f62 795f 7265 6769  0][image_by_regi
+0001c5a0: 6f6e 5b69 6e74 2873 706c 6974 6572 5f79  on[int(spliter_y
+0001c5b0: 5b69 5d29 3a69 6e74 2873 706c 6974 6572  [i]):int(spliter
+0001c5c0: 5f79 5b69 2b31 5d29 2c70 6561 6b73 5f6e  _y[i+1]),peaks_n
+0001c5d0: 6567 5b69 5d5b 6a5d 2d70 6978 5f64 656c  eg[i][j]-pix_del
+0001c5e0: 3a70 6561 6b73 5f6e 6567 5b69 5d5b 6a5d  :peaks_neg[i][j]
+0001c5f0: 2b70 6978 5f64 656c 2c32 5d3d 3d70 6978  +pix_del,2]==pix
+0001c600: 656c 5f74 6162 6c65 205d 3d30 0a20 2020  el_table ]=0.   
+0001c610: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001c620: 2020 2020 2020 2066 6f72 2069 2069 6e20         for i in 
+0001c630: 7261 6e67 6528 6c65 6e28 7370 6c69 7465  range(len(splite
+0001c640: 725f 7929 2d31 293a 0a20 2020 2020 2020  r_y)-1):.       
+0001c650: 2020 2020 2020 2020 2066 6f72 206a 2069           for j i
+0001c660: 6e20 7261 6e67 6528 312c 6c65 6e28 7065  n range(1,len(pe
+0001c670: 616b 735f 6e65 675b 695d 292d 3129 3a0a  aks_neg[i])-1):.
+0001c680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001c690: 2020 2020 696d 6167 655f 6279 5f72 6567      image_by_reg
+0001c6a0: 696f 6e5b 696e 7428 7370 6c69 7465 725f  ion[int(spliter_
+0001c6b0: 795b 695d 293a 696e 7428 7370 6c69 7465  y[i]):int(splite
+0001c6c0: 725f 795b 692b 315d 292c 7065 616b 735f  r_y[i+1]),peaks_
+0001c6d0: 6e65 675b 695d 5b6a 5d2d 7069 785f 6465  neg[i][j]-pix_de
+0001c6e0: 6c3a 7065 616b 735f 6e65 675b 695d 5b6a  l:peaks_neg[i][j
+0001c6f0: 5d2b 7069 785f 6465 6c5d 5b69 6d61 6765  ]+pix_del][image
+0001c700: 5f62 795f 7265 6769 6f6e 5b69 6e74 2873  _by_region[int(s
+0001c710: 706c 6974 6572 5f79 5b69 5d29 3a69 6e74  pliter_y[i]):int
+0001c720: 2873 706c 6974 6572 5f79 5b69 2b31 5d29  (spliter_y[i+1])
+0001c730: 2c70 6561 6b73 5f6e 6567 5b69 5d5b 6a5d  ,peaks_neg[i][j]
+0001c740: 2d70 6978 5f64 656c 3a70 6561 6b73 5f6e  -pix_del:peaks_n
+0001c750: 6567 5b69 5d5b 6a5d 2b70 6978 5f64 656c  eg[i][j]+pix_del
+0001c760: 5d3d 3d70 6978 656c 5f6c 696e 6520 5d3d  ]==pixel_line ]=
+0001c770: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
+0001c780: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0001c790: 2020 2020 2020 2020 2020 2069 6d61 6765             image
+0001c7a0: 5f62 795f 7265 6769 6f6e 5b69 6e74 2873  _by_region[int(s
+0001c7b0: 706c 6974 6572 5f79 5b69 5d29 3a69 6e74  pliter_y[i]):int
+0001c7c0: 2873 706c 6974 6572 5f79 5b69 2b31 5d29  (spliter_y[i+1])
+0001c7d0: 2c70 6561 6b73 5f6e 6567 5b69 5d5b 6a5d  ,peaks_neg[i][j]
+0001c7e0: 2d70 6978 5f64 656c 3a70 6561 6b73 5f6e  -pix_del:peaks_n
+0001c7f0: 6567 5b69 5d5b 6a5d 2b70 6978 5f64 656c  eg[i][j]+pix_del
+0001c800: 5d5b 696d 6167 655f 6279 5f72 6567 696f  ][image_by_regio
+0001c810: 6e5b 696e 7428 7370 6c69 7465 725f 795b  n[int(spliter_y[
+0001c820: 695d 293a 696e 7428 7370 6c69 7465 725f  i]):int(spliter_
+0001c830: 795b 692b 315d 292c 7065 616b 735f 6e65  y[i+1]),peaks_ne
+0001c840: 675b 695d 5b6a 5d2d 7069 785f 6465 6c3a  g[i][j]-pix_del:
+0001c850: 7065 616b 735f 6e65 675b 695d 5b6a 5d2b  peaks_neg[i][j]+
+0001c860: 7069 785f 6465 6c5d 3d3d 7069 7865 6c5f  pix_del]==pixel_
+0001c870: 7461 626c 6520 5d3d 300a 2020 2020 2020  table ]=0.      
+0001c880: 2020 7265 7475 726e 2069 6d61 6765 5f62    return image_b
+0001c890: 795f 7265 6769 6f6e 0a20 2020 2064 6566  y_region.    def
+0001c8a0: 2061 6464 5f74 6162 6c65 735f 6865 7572   add_tables_heur
+0001c8b0: 6973 7469 635f 746f 5f6c 6179 6f75 7428  istic_to_layout(
+0001c8c0: 7365 6c66 2c20 696d 6167 655f 7265 6769  self, image_regi
+0001c8d0: 6f6e 735f 6572 616c 795f 702c 626f 7865  ons_eraly_p,boxe
+0001c8e0: 732c 2073 6c6f 7065 5f6d 6561 6e5f 686f  s, slope_mean_ho
+0001c8f0: 722c 2073 706c 6974 6572 5f79 2c70 6561  r, spliter_y,pea
+0001c900: 6b73 5f6e 6567 5f74 6f74 2c20 696d 6167  ks_neg_tot, imag
+0001c910: 655f 7265 7669 7365 642c 206e 756d 5f63  e_revised, num_c
+0001c920: 6f6c 5f63 6c61 7373 6966 6965 722c 206d  ol_classifier, m
+0001c930: 696e 5f61 7265 612c 2070 6978 656c 5f6c  in_area, pixel_l
+0001c940: 696e 6529 3a0a 2020 2020 2020 2020 7069  ine):.        pi
+0001c950: 7865 6c5f 7461 626c 6520 3d31 300a 2020  xel_table =10.  
+0001c960: 2020 2020 2020 696d 6167 655f 7265 7669        image_revi
+0001c970: 7365 645f 3120 3d20 7365 6c66 2e64 656c  sed_1 = self.del
+0001c980: 6574 655f 7365 7061 7261 746f 725f 6172  ete_separator_ar
+0001c990: 6f75 6e64 2873 706c 6974 6572 5f79 2c20  ound(spliter_y, 
+0001c9a0: 7065 616b 735f 6e65 675f 746f 742c 2069  peaks_neg_tot, i
+0001c9b0: 6d61 6765 5f72 6576 6973 6564 2c20 7069  mage_revised, pi
+0001c9c0: 7865 6c5f 6c69 6e65 2c20 7069 7865 6c5f  xel_line, pixel_
+0001c9d0: 7461 626c 6529 0a20 2020 2020 2020 200a  table).        .
+0001c9e0: 2020 2020 2020 2020 7472 793a 0a20 2020          try:.   
+0001c9f0: 2020 2020 2020 2020 2069 6d61 6765 5f72           image_r
+0001ca00: 6576 6973 6564 5f31 5b3a 2c3a 3330 5d5b  evised_1[:,:30][
+0001ca10: 696d 6167 655f 7265 7669 7365 645f 315b  image_revised_1[
+0001ca20: 3a2c 3a33 305d 3d3d 7069 7865 6c5f 6c69  :,:30]==pixel_li
+0001ca30: 6e65 5d20 3d20 300a 2020 2020 2020 2020  ne] = 0.        
+0001ca40: 2020 2020 696d 6167 655f 7265 7669 7365      image_revise
+0001ca50: 645f 315b 3a2c 696d 6167 655f 7265 7669  d_1[:,image_revi
+0001ca60: 7365 645f 312e 7368 6170 655b 315d 2d33  sed_1.shape[1]-3
+0001ca70: 303a 5d5b 696d 6167 655f 7265 7669 7365  0:][image_revise
+0001ca80: 645f 315b 3a2c 696d 6167 655f 7265 7669  d_1[:,image_revi
+0001ca90: 7365 645f 312e 7368 6170 655b 315d 2d33  sed_1.shape[1]-3
+0001caa0: 303a 5d3d 3d70 6978 656c 5f6c 696e 655d  0:]==pixel_line]
+0001cab0: 203d 2030 0a20 2020 2020 2020 2065 7863   = 0.        exc
+0001cac0: 6570 743a 0a20 2020 2020 2020 2020 2020  ept:.           
+0001cad0: 2070 6173 730a 2020 2020 2020 2020 0a20   pass.        . 
+0001cae0: 2020 2020 2020 2069 6d67 5f63 6f6d 6d5f         img_comm_
+0001caf0: 6520 3d20 6e70 2e7a 6572 6f73 2869 6d61  e = np.zeros(ima
+0001cb00: 6765 5f72 6576 6973 6564 5f31 2e73 6861  ge_revised_1.sha
+0001cb10: 7065 290a 2020 2020 2020 2020 696d 675f  pe).        img_
+0001cb20: 636f 6d6d 203d 206e 702e 7265 7065 6174  comm = np.repeat
+0001cb30: 2869 6d67 5f63 6f6d 6d5f 655b 3a2c 203a  (img_comm_e[:, :
+0001cb40: 2c20 6e70 2e6e 6577 6178 6973 5d2c 2033  , np.newaxis], 3
+0001cb50: 2c20 6178 6973 3d32 290a 0a20 2020 2020  , axis=2)..     
+0001cb60: 2020 2066 6f72 2069 6e64 6976 2069 6e20     for indiv in 
+0001cb70: 6e70 2e75 6e69 7175 6528 696d 6167 655f  np.unique(image_
+0001cb80: 7265 7669 7365 645f 3129 3a0a 2020 2020  revised_1):.    
+0001cb90: 2020 2020 2020 2020 696d 6167 655f 636f          image_co
+0001cba0: 6c3d 2869 6d61 6765 5f72 6576 6973 6564  l=(image_revised
+0001cbb0: 5f31 3d3d 696e 6469 7629 2a32 3535 0a20  _1==indiv)*255. 
+0001cbc0: 2020 2020 2020 2020 2020 2069 6d67 5f63             img_c
+0001cbd0: 6f6d 6d5f 696e 3d6e 702e 7265 7065 6174  omm_in=np.repeat
+0001cbe0: 2869 6d61 6765 5f63 6f6c 5b3a 2c20 3a2c  (image_col[:, :,
+0001cbf0: 206e 702e 6e65 7761 7869 735d 2c20 332c   np.newaxis], 3,
+0001cc00: 2061 7869 733d 3229 0a20 2020 2020 2020   axis=2).       
+0001cc10: 2020 2020 2069 6d67 5f63 6f6d 6d5f 696e       img_comm_in
+0001cc20: 3d69 6d67 5f63 6f6d 6d5f 696e 2e61 7374  =img_comm_in.ast
+0001cc30: 7970 6528 6e70 2e75 696e 7438 290a 0a20  ype(np.uint8).. 
+0001cc40: 2020 2020 2020 2020 2020 2069 6d67 7261             imgra
+0001cc50: 7920 3d20 6376 322e 6376 7443 6f6c 6f72  y = cv2.cvtColor
+0001cc60: 2869 6d67 5f63 6f6d 6d5f 696e 2c20 6376  (img_comm_in, cv
+0001cc70: 322e 434f 4c4f 525f 4247 5232 4752 4159  2.COLOR_BGR2GRAY
+0001cc80: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+0001cc90: 742c 2074 6872 6573 6820 3d20 6376 322e  t, thresh = cv2.
+0001cca0: 7468 7265 7368 6f6c 6428 696d 6772 6179  threshold(imgray
+0001ccb0: 2c20 302c 2032 3535 2c20 3029 0a20 2020  , 0, 255, 0).   
+0001ccc0: 2020 2020 2020 2020 2063 6f6e 746f 7572           contour
+0001ccd0: 732c 6869 7261 7263 6879 3d63 7632 2e66  s,hirarchy=cv2.f
+0001cce0: 696e 6443 6f6e 746f 7572 7328 7468 7265  indContours(thre
+0001ccf0: 7368 2e63 6f70 7928 292c 2063 7632 2e52  sh.copy(), cv2.R
+0001cd00: 4554 525f 5452 4545 2c63 7632 2e43 4841  ETR_TREE,cv2.CHA
+0001cd10: 494e 5f41 5050 524f 585f 5349 4d50 4c45  IN_APPROX_SIMPLE
+0001cd20: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+0001cd30: 6620 696e 6469 763d 3d70 6978 656c 5f74  f indiv==pixel_t
+0001cd40: 6162 6c65 3a0a 2020 2020 2020 2020 2020  able:.          
+0001cd50: 2020 2020 2020 6d61 696e 5f63 6f6e 746f        main_conto
+0001cd60: 7572 7320 3d20 6669 6c74 6572 5f63 6f6e  urs = filter_con
+0001cd70: 746f 7572 735f 6172 6561 5f6f 665f 696d  tours_area_of_im
+0001cd80: 6167 655f 7461 626c 6573 2874 6872 6573  age_tables(thres
+0001cd90: 682c 2063 6f6e 746f 7572 732c 2068 6972  h, contours, hir
+0001cda0: 6172 6368 792c 206d 6178 5f61 7265 6120  archy, max_area 
+0001cdb0: 3d20 312c 206d 696e 5f61 7265 6120 3d20  = 1, min_area = 
+0001cdc0: 302e 3030 3129 0a20 2020 2020 2020 2020  0.001).         
+0001cdd0: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001cde0: 2020 2020 2020 2020 206d 6169 6e5f 636f           main_co
+0001cdf0: 6e74 6f75 7273 203d 2066 696c 7465 725f  ntours = filter_
+0001ce00: 636f 6e74 6f75 7273 5f61 7265 615f 6f66  contours_area_of
+0001ce10: 5f69 6d61 6765 5f74 6162 6c65 7328 7468  _image_tables(th
+0001ce20: 7265 7368 2c20 636f 6e74 6f75 7273 2c20  resh, contours, 
+0001ce30: 6869 7261 7263 6879 2c20 6d61 785f 6172  hirarchy, max_ar
+0001ce40: 6561 203d 2031 2c20 6d69 6e5f 6172 6561  ea = 1, min_area
+0001ce50: 203d 206d 696e 5f61 7265 6129 0a0a 2020   = min_area)..  
+0001ce60: 2020 2020 2020 2020 2020 696d 675f 636f            img_co
+0001ce70: 6d6d 203d 2063 7632 2e66 696c 6c50 6f6c  mm = cv2.fillPol
+0001ce80: 7928 696d 675f 636f 6d6d 2c20 7074 7320  y(img_comm, pts 
+0001ce90: 3d20 6d61 696e 5f63 6f6e 746f 7572 732c  = main_contours,
+0001cea0: 2063 6f6c 6f72 203d 2028 696e 6469 762c   color = (indiv,
+0001ceb0: 2069 6e64 6976 2c20 696e 6469 7629 290a   indiv, indiv)).
+0001cec0: 2020 2020 2020 2020 2020 2020 696d 675f              img_
+0001ced0: 636f 6d6d 203d 2069 6d67 5f63 6f6d 6d2e  comm = img_comm.
+0001cee0: 6173 7479 7065 286e 702e 7569 6e74 3829  astype(np.uint8)
+0001cef0: 0a20 2020 2020 2020 2020 2020 200a 2020  .            .  
+0001cf00: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+0001cf10: 662e 6973 4e61 4e28 736c 6f70 655f 6d65  f.isNaN(slope_me
+0001cf20: 616e 5f68 6f72 293a 0a20 2020 2020 2020  an_hor):.       
+0001cf30: 2020 2020 2069 6d61 6765 5f72 6576 6973       image_revis
+0001cf40: 6564 5f6c 6173 7420 3d20 6e70 2e7a 6572  ed_last = np.zer
+0001cf50: 6f73 2828 696d 6167 655f 7265 6769 6f6e  os((image_region
+0001cf60: 735f 6572 616c 795f 702e 7368 6170 655b  s_eraly_p.shape[
+0001cf70: 305d 2c20 696d 6167 655f 7265 6769 6f6e  0], image_region
+0001cf80: 735f 6572 616c 795f 702e 7368 6170 655b  s_eraly_p.shape[
+0001cf90: 315d 2c33 2929 0a20 2020 2020 2020 2020  1],3)).         
+0001cfa0: 2020 2066 6f72 2069 2069 6e20 7261 6e67     for i in rang
+0001cfb0: 6528 6c65 6e28 626f 7865 7329 293a 0a20  e(len(boxes)):. 
+0001cfc0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+0001cfd0: 6d61 6765 5f62 6f78 3d69 6d67 5f63 6f6d  mage_box=img_com
+0001cfe0: 6d5b 696e 7428 626f 7865 735b 695d 5b32  m[int(boxes[i][2
+0001cff0: 5d29 3a69 6e74 2862 6f78 6573 5b69 5d5b  ]):int(boxes[i][
+0001d000: 335d 292c 696e 7428 626f 7865 735b 695d  3]),int(boxes[i]
+0001d010: 5b30 5d29 3a69 6e74 2862 6f78 6573 5b69  [0]):int(boxes[i
+0001d020: 5d5b 315d 292c 3a5d 0a20 2020 2020 2020  ][1]),:].       
+0001d030: 2020 2020 2020 2020 2074 7279 3a0a 2020           try:.  
+0001d040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d050: 2020 696d 6167 655f 626f 785f 7461 6265    image_box_tabe
+0001d060: 6c73 5f31 3d28 696d 6167 655f 626f 785b  ls_1=(image_box[
+0001d070: 3a2c 3a2c 305d 3d3d 7069 7865 6c5f 7461  :,:,0]==pixel_ta
+0001d080: 626c 6529 2a31 0a20 2020 2020 2020 2020  ble)*1.         
+0001d090: 2020 2020 2020 2020 2020 2063 6f6e 746f             conto
+0001d0a0: 7572 735f 7461 622c 5f3d 7265 7475 726e  urs_tab,_=return
+0001d0b0: 5f63 6f6e 746f 7572 735f 6f66 5f69 6d61  _contours_of_ima
+0001d0c0: 6765 2869 6d61 6765 5f62 6f78 5f74 6162  ge(image_box_tab
+0001d0d0: 656c 735f 3129 0a20 2020 2020 2020 2020  els_1).         
+0001d0e0: 2020 2020 2020 2020 2020 2063 6f6e 746f             conto
+0001d0f0: 7572 735f 7461 623d 6669 6c74 6572 5f63  urs_tab=filter_c
+0001d100: 6f6e 746f 7572 735f 6172 6561 5f6f 665f  ontours_area_of_
+0001d110: 696d 6167 655f 7461 626c 6573 2869 6d61  image_tables(ima
+0001d120: 6765 5f62 6f78 5f74 6162 656c 735f 312c  ge_box_tabels_1,
+0001d130: 636f 6e74 6f75 7273 5f74 6162 2c5f 2c31  contours_tab,_,1
+0001d140: 2c30 2e30 3033 290a 2020 2020 2020 2020  ,0.003).        
+0001d150: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+0001d160: 655f 626f 785f 7461 6265 6c73 5f31 3d28  e_box_tabels_1=(
+0001d170: 696d 6167 655f 626f 785b 3a2c 3a2c 305d  image_box[:,:,0]
+0001d180: 3d3d 7069 7865 6c5f 6c69 6e65 292a 310a  ==pixel_line)*1.
+0001d190: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d1a0: 2020 2020 2069 6d61 6765 5f62 6f78 5f74       image_box_t
+0001d1b0: 6162 656c 735f 616e 645f 6d5f 7465 7874  abels_and_m_text
+0001d1c0: 3d28 2028 696d 6167 655f 626f 785b 3a2c  =( (image_box[:,
+0001d1d0: 3a2c 305d 3d3d 7069 7865 6c5f 7461 626c  :,0]==pixel_tabl
+0001d1e0: 6529 207c 2028 696d 6167 655f 626f 785b  e) | (image_box[
+0001d1f0: 3a2c 3a2c 305d 3d3d 3129 2029 2a31 0a20  :,:,0]==1) )*1. 
+0001d200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d210: 2020 2069 6d61 6765 5f62 6f78 5f74 6162     image_box_tab
+0001d220: 656c 735f 616e 645f 6d5f 7465 7874 3d69  els_and_m_text=i
+0001d230: 6d61 6765 5f62 6f78 5f74 6162 656c 735f  mage_box_tabels_
+0001d240: 616e 645f 6d5f 7465 7874 2e61 7374 7970  and_m_text.astyp
+0001d250: 6528 6e70 2e75 696e 7438 290a 0a20 2020  e(np.uint8)..   
+0001d260: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d270: 2069 6d61 6765 5f62 6f78 5f74 6162 656c   image_box_tabel
+0001d280: 735f 313d 696d 6167 655f 626f 785f 7461  s_1=image_box_ta
+0001d290: 6265 6c73 5f31 2e61 7374 7970 6528 6e70  bels_1.astype(np
+0001d2a0: 2e75 696e 7438 290a 2020 2020 2020 2020  .uint8).        
+0001d2b0: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+0001d2c0: 655f 626f 785f 7461 6265 6c73 5f31 203d  e_box_tabels_1 =
+0001d2d0: 2063 7632 2e64 696c 6174 6528 696d 6167   cv2.dilate(imag
+0001d2e0: 655f 626f 785f 7461 6265 6c73 5f31 2c4b  e_box_tabels_1,K
+0001d2f0: 4552 4e45 4c2c 6974 6572 6174 696f 6e73  ERNEL,iterations
+0001d300: 203d 2035 290a 0a20 2020 2020 2020 2020   = 5)..         
+0001d310: 2020 2020 2020 2020 2020 2063 6f6e 746f             conto
+0001d320: 7572 735f 7461 626c 655f 6d5f 7465 7874  urs_table_m_text
+0001d330: 2c5f 3d72 6574 7572 6e5f 636f 6e74 6f75  ,_=return_contou
+0001d340: 7273 5f6f 665f 696d 6167 6528 696d 6167  rs_of_image(imag
+0001d350: 655f 626f 785f 7461 6265 6c73 5f61 6e64  e_box_tabels_and
+0001d360: 5f6d 5f74 6578 7429 0a20 2020 2020 2020  _m_text).       
+0001d370: 2020 2020 2020 2020 2020 2020 2069 6d61               ima
+0001d380: 6765 5f62 6f78 5f74 6162 656c 733d 6e70  ge_box_tabels=np
+0001d390: 2e72 6570 6561 7428 696d 6167 655f 626f  .repeat(image_bo
+0001d3a0: 785f 7461 6265 6c73 5f31 5b3a 2c20 3a2c  x_tabels_1[:, :,
+0001d3b0: 206e 702e 6e65 7761 7869 735d 2c20 332c   np.newaxis], 3,
+0001d3c0: 2061 7869 733d 3229 0a0a 2020 2020 2020   axis=2)..      
+0001d3d0: 2020 2020 2020 2020 2020 2020 2020 696d                im
+0001d3e0: 6167 655f 626f 785f 7461 6265 6c73 3d69  age_box_tabels=i
+0001d3f0: 6d61 6765 5f62 6f78 5f74 6162 656c 732e  mage_box_tabels.
+0001d400: 6173 7479 7065 286e 702e 7569 6e74 3829  astype(np.uint8)
+0001d410: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d420: 2020 2020 2069 6d67 7261 7920 3d20 6376       imgray = cv
+0001d430: 322e 6376 7443 6f6c 6f72 2869 6d61 6765  2.cvtColor(image
+0001d440: 5f62 6f78 5f74 6162 656c 732c 2063 7632  _box_tabels, cv2
+0001d450: 2e43 4f4c 4f52 5f42 4752 3247 5241 5929  .COLOR_BGR2GRAY)
+0001d460: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d470: 2020 2020 2072 6574 2c20 7468 7265 7368       ret, thresh
+0001d480: 203d 2063 7632 2e74 6872 6573 686f 6c64   = cv2.threshold
+0001d490: 2869 6d67 7261 792c 2030 2c20 3235 352c  (imgray, 0, 255,
+0001d4a0: 2030 290a 0a20 2020 2020 2020 2020 2020   0)..           
+0001d4b0: 2020 2020 2020 2020 2063 6f6e 746f 7572           contour
+0001d4c0: 735f 6c69 6e65 2c68 6965 7261 6368 793d  s_line,hierachy=
+0001d4d0: 6376 322e 6669 6e64 436f 6e74 6f75 7273  cv2.findContours
+0001d4e0: 2874 6872 6573 682c 6376 322e 5245 5452  (thresh,cv2.RETR
+0001d4f0: 5f54 5245 452c 6376 322e 4348 4149 4e5f  _TREE,cv2.CHAIN_
+0001d500: 4150 5052 4f58 5f53 494d 504c 4529 0a0a  APPROX_SIMPLE)..
+0001d510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d520: 2020 2020 795f 6d69 6e5f 6d61 696e 5f6c      y_min_main_l
+0001d530: 696e 6520 2c79 5f6d 6178 5f6d 6169 6e5f  ine ,y_max_main_
+0001d540: 6c69 6e65 3d66 696e 645f 6665 6174 7572  line=find_featur
+0001d550: 6573 5f6f 665f 636f 6e74 6f75 7273 2863  es_of_contours(c
+0001d560: 6f6e 746f 7572 735f 6c69 6e65 290a 2020  ontours_line).  
+0001d570: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d580: 2020 795f 6d69 6e5f 6d61 696e 5f74 6162    y_min_main_tab
+0001d590: 202c 795f 6d61 785f 6d61 696e 5f74 6162   ,y_max_main_tab
+0001d5a0: 3d66 696e 645f 6665 6174 7572 6573 5f6f  =find_features_o
+0001d5b0: 665f 636f 6e74 6f75 7273 2863 6f6e 746f  f_contours(conto
+0001d5c0: 7572 735f 7461 6229 0a0a 2020 2020 2020  urs_tab)..      
+0001d5d0: 2020 2020 2020 2020 2020 2020 2020 6378                cx
+0001d5e0: 5f74 6162 5f6d 5f74 6578 742c 6379 5f74  _tab_m_text,cy_t
+0001d5f0: 6162 5f6d 5f74 6578 7420 2c78 5f6d 696e  ab_m_text ,x_min
+0001d600: 5f74 6162 5f6d 5f74 6578 7420 2c20 785f  _tab_m_text , x_
+0001d610: 6d61 785f 7461 625f 6d5f 7465 7874 2c20  max_tab_m_text, 
+0001d620: 795f 6d69 6e5f 7461 625f 6d5f 7465 7874  y_min_tab_m_text
+0001d630: 202c 795f 6d61 785f 7461 625f 6d5f 7465   ,y_max_tab_m_te
+0001d640: 7874 2c20 5f3d 2066 696e 645f 6e65 775f  xt, _= find_new_
+0001d650: 6665 6174 7572 6573 5f6f 665f 636f 6e74  features_of_cont
+0001d660: 6f75 7273 2863 6f6e 746f 7572 735f 7461  ours(contours_ta
+0001d670: 626c 655f 6d5f 7465 7874 290a 2020 2020  ble_m_text).    
+0001d680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d690: 6378 5f74 6162 6c2c 6379 5f74 6162 6c20  cx_tabl,cy_tabl 
+0001d6a0: 2c78 5f6d 696e 5f74 6162 6c20 2c20 785f  ,x_min_tabl , x_
+0001d6b0: 6d61 785f 7461 626c 2c20 795f 6d69 6e5f  max_tabl, y_min_
+0001d6c0: 7461 626c 202c 795f 6d61 785f 7461 626c  tabl ,y_max_tabl
+0001d6d0: 2c5f 3d20 6669 6e64 5f6e 6577 5f66 6561  ,_= find_new_fea
+0001d6e0: 7475 7265 735f 6f66 5f63 6f6e 746f 7572  tures_of_contour
+0001d6f0: 7328 636f 6e74 6f75 7273 5f74 6162 290a  s(contours_tab).
+0001d700: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d710: 2020 2020 2069 6620 6c65 6e28 795f 6d69       if len(y_mi
+0001d720: 6e5f 6d61 696e 5f74 6162 2029 3e30 3a0a  n_main_tab )>0:.
+0001d730: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d740: 2020 2020 2020 2020 795f 646f 776e 5f74          y_down_t
+0001d750: 6162 733d 5b5d 0a20 2020 2020 2020 2020  abs=[].         
+0001d760: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+0001d770: 5f75 705f 7461 6273 3d5b 5d0a 0a20 2020  _up_tabs=[]..   
+0001d780: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d790: 2020 2020 2066 6f72 2069 5f74 2069 6e20       for i_t in 
+0001d7a0: 7261 6e67 6528 6c65 6e28 795f 6d69 6e5f  range(len(y_min_
+0001d7b0: 6d61 696e 5f74 6162 2029 293a 0a20 2020  main_tab )):.   
+0001d7c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d7d0: 2020 2020 2020 2020 2079 5f64 6f77 6e5f           y_down_
+0001d7e0: 7461 623d 5b5d 0a20 2020 2020 2020 2020  tab=[].         
+0001d7f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d800: 2020 2079 5f75 705f 7461 623d 5b5d 0a20     y_up_tab=[]. 
+0001d810: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d820: 2020 2020 2020 2020 2020 2066 6f72 2069             for i
+0001d830: 5f6c 2069 6e20 7261 6e67 6528 6c65 6e28  _l in range(len(
+0001d840: 795f 6d69 6e5f 6d61 696e 5f6c 696e 6529  y_min_main_line)
+0001d850: 293a 0a20 2020 2020 2020 2020 2020 2020  ):.             
+0001d860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d870: 2020 2069 6620 795f 6d69 6e5f 6d61 696e     if y_min_main
+0001d880: 5f74 6162 5b69 5f74 5d3e 795f 6d69 6e5f  _tab[i_t]>y_min_
+0001d890: 6d61 696e 5f6c 696e 655b 695f 6c5d 2061  main_line[i_l] a
+0001d8a0: 6e64 2020 795f 6d61 785f 6d61 696e 5f74  nd  y_max_main_t
+0001d8b0: 6162 5b69 5f74 5d3e 795f 6d69 6e5f 6d61  ab[i_t]>y_min_ma
+0001d8c0: 696e 5f6c 696e 655b 695f 6c5d 2061 6e64  in_line[i_l] and
+0001d8d0: 2079 5f6d 696e 5f6d 6169 6e5f 7461 625b   y_min_main_tab[
+0001d8e0: 695f 745d 3e79 5f6d 6178 5f6d 6169 6e5f  i_t]>y_max_main_
+0001d8f0: 6c69 6e65 5b69 5f6c 5d20 616e 6420 795f  line[i_l] and y_
+0001d900: 6d61 785f 6d61 696e 5f74 6162 5b69 5f74  max_main_tab[i_t
+0001d910: 5d3e 795f 6d69 6e5f 6d61 696e 5f6c 696e  ]>y_min_main_lin
+0001d920: 655b 695f 6c5d 3a0a 2020 2020 2020 2020  e[i_l]:.        
+0001d930: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d940: 2020 2020 2020 2020 2020 2020 7061 7373              pass
+0001d950: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001d960: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001d970: 2065 6c69 6620 795f 6d69 6e5f 6d61 696e   elif y_min_main
+0001d980: 5f74 6162 5b69 5f74 5d3c 795f 6d61 785f  _tab[i_t]<y_max_
+0001d990: 6d61 696e 5f6c 696e 655b 695f 6c5d 2061  main_line[i_l] a
+0001d9a0: 6e64 2079 5f6d 6178 5f6d 6169 6e5f 7461  nd y_max_main_ta
+0001d9b0: 625b 695f 745d 3c79 5f6d 6178 5f6d 6169  b[i_t]<y_max_mai
+0001d9c0: 6e5f 6c69 6e65 5b69 5f6c 5d20 616e 6420  n_line[i_l] and 
+0001d9d0: 795f 6d61 785f 6d61 696e 5f74 6162 5b69  y_max_main_tab[i
+0001d9e0: 5f74 5d3c 795f 6d69 6e5f 6d61 696e 5f6c  _t]<y_min_main_l
+0001d9f0: 696e 655b 695f 6c5d 2061 6e64 2079 5f6d  ine[i_l] and y_m
+0001da00: 696e 5f6d 6169 6e5f 7461 625b 695f 745d  in_main_tab[i_t]
+0001da10: 3c79 5f6d 696e 5f6d 6169 6e5f 6c69 6e65  <y_min_main_line
+0001da20: 5b69 5f6c 5d3a 0a20 2020 2020 2020 2020  [i_l]:.         
+0001da30: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001da40: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+0001da50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001da60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001da70: 656c 6966 206e 702e 6162 7328 795f 6d61  elif np.abs(y_ma
+0001da80: 785f 6d61 696e 5f6c 696e 655b 695f 6c5d  x_main_line[i_l]
+0001da90: 2d79 5f6d 696e 5f6d 6169 6e5f 6c69 6e65  -y_min_main_line
+0001daa0: 5b69 5f6c 5d29 3c31 3030 3a0a 2020 2020  [i_l])<100:.    
+0001dab0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dac0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dad0: 7061 7373 0a20 2020 2020 2020 2020 2020  pass.           
+0001dae0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001daf0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001db00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001db10: 2020 2020 2020 2020 2020 2020 2020 2079                 y
+0001db20: 5f75 705f 7461 622e 6170 7065 6e64 286e  _up_tab.append(n
+0001db30: 702e 6d69 6e28 5b79 5f6d 696e 5f6d 6169  p.min([y_min_mai
+0001db40: 6e5f 6c69 6e65 5b69 5f6c 5d2c 2079 5f6d  n_line[i_l], y_m
+0001db50: 696e 5f6d 6169 6e5f 7461 625b 695f 745d  in_main_tab[i_t]
+0001db60: 205d 2920 2029 0a20 2020 2020 2020 2020   ])  ).         
+0001db70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001db80: 2020 2020 2020 2020 2020 2079 5f64 6f77             y_dow
+0001db90: 6e5f 7461 622e 6170 7065 6e64 2820 6e70  n_tab.append( np
+0001dba0: 2e6d 6178 285b 2079 5f6d 6178 5f6d 6169  .max([ y_max_mai
+0001dbb0: 6e5f 6c69 6e65 5b69 5f6c 5d2c 795f 6d61  n_line[i_l],y_ma
+0001dbc0: 785f 6d61 696e 5f74 6162 5b69 5f74 5d20  x_main_tab[i_t] 
+0001dbd0: 5d29 2029 0a0a 2020 2020 2020 2020 2020  ]) )..          
+0001dbe0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dbf0: 2020 6966 206c 656e 2879 5f75 705f 7461    if len(y_up_ta
+0001dc00: 6229 3d3d 303a 0a20 2020 2020 2020 2020  b)==0:.         
+0001dc10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc20: 2020 2020 2020 2079 5f75 705f 7461 6273         y_up_tabs
+0001dc30: 2e61 7070 656e 6428 795f 6d69 6e5f 6d61  .append(y_min_ma
+0001dc40: 696e 5f74 6162 5b69 5f74 5d29 0a20 2020  in_tab[i_t]).   
+0001dc50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dc60: 2020 2020 2020 2020 2020 2020 2079 5f64               y_d
+0001dc70: 6f77 6e5f 7461 6273 2e61 7070 656e 6428  own_tabs.append(
+0001dc80: 795f 6d61 785f 6d61 696e 5f74 6162 5b69  y_max_main_tab[i
+0001dc90: 5f74 5d29 0a20 2020 2020 2020 2020 2020  _t]).           
+0001dca0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dcb0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+0001dcc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dcd0: 2020 2020 2020 2079 5f75 705f 7461 6273         y_up_tabs
+0001dce0: 2e61 7070 656e 6428 6e70 2e6d 696e 2879  .append(np.min(y
+0001dcf0: 5f75 705f 7461 6229 290a 2020 2020 2020  _up_tab)).      
+0001dd00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd10: 2020 2020 2020 2020 2020 795f 646f 776e            y_down
+0001dd20: 5f74 6162 732e 6170 7065 6e64 286e 702e  _tabs.append(np.
+0001dd30: 6d61 7828 795f 646f 776e 5f74 6162 2929  max(y_down_tab))
+0001dd40: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001dd50: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0001dd60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001dd70: 2020 2079 5f64 6f77 6e5f 7461 6273 3d5b     y_down_tabs=[
+0001dd80: 5d0a 2020 2020 2020 2020 2020 2020 2020  ].              
+0001dd90: 2020 2020 2020 2020 2020 795f 7570 5f74            y_up_t
+0001dda0: 6162 733d 5b5d 0a20 2020 2020 2020 2020  abs=[].         
+0001ddb0: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+0001ddc0: 6173 730a 2020 2020 2020 2020 2020 2020  ass.            
+0001ddd0: 2020 2020 6578 6365 7074 3a0a 2020 2020      except:.    
+0001dde0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001ddf0: 795f 646f 776e 5f74 6162 733d 5b5d 0a20  y_down_tabs=[]. 
+0001de00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001de10: 2020 2079 5f75 705f 7461 6273 3d5b 5d0a     y_up_tabs=[].
+0001de20: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0001de30: 2066 6f72 2069 6920 696e 2072 616e 6765   for ii in range
+0001de40: 286c 656e 2879 5f75 705f 7461 6273 2929  (len(y_up_tabs))
+0001de50: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0001de60: 2020 2020 2020 696d 6167 655f 626f 785b        image_box[
+0001de70: 795f 7570 5f74 6162 735b 6969 5d3a 795f  y_up_tabs[ii]:y_
+0001de80: 646f 776e 5f74 6162 735b 6969 5d2c 3a2c  down_tabs[ii],:,
+0001de90: 305d 3d70 6978 656c 5f74 6162 6c65 0a0a  0]=pixel_table..
+0001dea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001deb0: 696d 6167 655f 7265 7669 7365 645f 6c61  image_revised_la
+0001dec0: 7374 5b69 6e74 2862 6f78 6573 5b69 5d5b  st[int(boxes[i][
+0001ded0: 325d 293a 696e 7428 626f 7865 735b 695d  2]):int(boxes[i]
+0001dee0: 5b33 5d29 2c69 6e74 2862 6f78 6573 5b69  [3]),int(boxes[i
+0001def0: 5d5b 305d 293a 696e 7428 626f 7865 735b  ][0]):int(boxes[
+0001df00: 695d 5b31 5d29 2c3a 5d3d 696d 6167 655f  i][1]),:]=image_
+0001df10: 626f 785b 3a2c 3a2c 3a5d 0a20 2020 2020  box[:,:,:].     
+0001df20: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+0001df30: 2020 2020 2066 6f72 2069 2069 6e20 7261       for i in ra
+0001df40: 6e67 6528 6c65 6e28 626f 7865 7329 293a  nge(len(boxes)):
+0001df50: 0a0a 2020 2020 2020 2020 2020 2020 2020  ..              
+0001df60: 2020 696d 6167 655f 626f 783d 696d 675f    image_box=img_
+0001df70: 636f 6d6d 5b69 6e74 2862 6f78 6573 5b69  comm[int(boxes[i
+0001df80: 5d5b 325d 293a 696e 7428 626f 7865 735b  ][2]):int(boxes[
+0001df90: 695d 5b33 5d29 2c69 6e74 2862 6f78 6573  i][3]),int(boxes
+0001dfa0: 5b69 5d5b 305d 293a 696e 7428 626f 7865  [i][0]):int(boxe
+0001dfb0: 735b 695d 5b31 5d29 2c3a 5d0a 2020 2020  s[i][1]),:].    
+0001dfc0: 2020 2020 2020 2020 2020 2020 696d 6167              imag
+0001dfd0: 655f 7265 7669 7365 645f 6c61 7374 5b69  e_revised_last[i
+0001dfe0: 6e74 2862 6f78 6573 5b69 5d5b 325d 293a  nt(boxes[i][2]):
+0001dff0: 696e 7428 626f 7865 735b 695d 5b33 5d29  int(boxes[i][3])
+0001e000: 2c69 6e74 2862 6f78 6573 5b69 5d5b 305d  ,int(boxes[i][0]
+0001e010: 293a 696e 7428 626f 7865 735b 695d 5b31  ):int(boxes[i][1
+0001e020: 5d29 2c3a 5d3d 696d 6167 655f 626f 785b  ]),:]=image_box[
+0001e030: 3a2c 3a2c 3a5d 0a20 2020 2020 2020 200a  :,:,:].        .
+0001e040: 2020 2020 2020 2020 6966 206e 756d 5f63          if num_c
+0001e050: 6f6c 5f63 6c61 7373 6966 6965 723d 3d31  ol_classifier==1
+0001e060: 3a0a 2020 2020 2020 2020 2020 2020 696d  :.            im
+0001e070: 675f 7461 626c 6573 5f63 6f6c 5f31 3d28  g_tables_col_1=(
+0001e080: 2069 6d61 6765 5f72 6576 6973 6564 5f6c   image_revised_l
+0001e090: 6173 745b 3a2c 3a2c 305d 3d3d 7069 7865  ast[:,:,0]==pixe
+0001e0a0: 6c5f 7461 626c 6520 292a 310a 2020 2020  l_table )*1.    
+0001e0b0: 2020 2020 2020 2020 696d 675f 7461 626c          img_tabl
+0001e0c0: 6573 5f63 6f6c 5f31 3d69 6d67 5f74 6162  es_col_1=img_tab
+0001e0d0: 6c65 735f 636f 6c5f 312e 6173 7479 7065  les_col_1.astype
+0001e0e0: 286e 702e 7569 6e74 3829 0a20 2020 2020  (np.uint8).     
+0001e0f0: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
+0001e100: 7461 626c 655f 636f 6c31 2c5f 3d72 6574  table_col1,_=ret
+0001e110: 7572 6e5f 636f 6e74 6f75 7273 5f6f 665f  urn_contours_of_
+0001e120: 696d 6167 6528 696d 675f 7461 626c 6573  image(img_tables
+0001e130: 5f63 6f6c 5f31 290a 2020 2020 2020 2020  _col_1).        
+0001e140: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+0001e150: 205f 2c5f 202c 5f20 2c20 5f2c 2079 5f6d   _,_ ,_ , _, y_m
+0001e160: 696e 5f74 6162 5f63 6f6c 3120 2c79 5f6d  in_tab_col1 ,y_m
+0001e170: 6178 5f74 6162 5f63 6f6c 312c 205f 3d20  ax_tab_col1, _= 
+0001e180: 6669 6e64 5f6e 6577 5f66 6561 7475 7265  find_new_feature
+0001e190: 735f 6f66 5f63 6f6e 746f 7572 7328 636f  s_of_contours(co
+0001e1a0: 6e74 6f75 7273 5f74 6162 6c65 5f63 6f6c  ntours_table_col
+0001e1b0: 3129 0a20 2020 2020 2020 2020 2020 200a  1).            .
+0001e1c0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+0001e1d0: 656e 2879 5f6d 696e 5f74 6162 5f63 6f6c  en(y_min_tab_col
+0001e1e0: 3129 3e30 3a0a 2020 2020 2020 2020 2020  1)>0:.          
+0001e1f0: 2020 2020 2020 666f 7220 696a 7620 696e        for ijv in
+0001e200: 2072 616e 6765 286c 656e 2879 5f6d 696e   range(len(y_min
+0001e210: 5f74 6162 5f63 6f6c 3129 293a 0a20 2020  _tab_col1)):.   
+0001e220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0001e230: 2069 6d61 6765 5f72 6576 6973 6564 5f6c   image_revised_l
+0001e240: 6173 745b 696e 7428 795f 6d69 6e5f 7461  ast[int(y_min_ta
+0001e250: 625f 636f 6c31 5b69 6a76 5d29 3a69 6e74  b_col1[ijv]):int
+0001e260: 2879 5f6d 6178 5f74 6162 5f63 6f6c 315b  (y_max_tab_col1[
+0001e270: 696a 765d 292c 3a2c 3a5d 3d70 6978 656c  ijv]),:,:]=pixel
+0001e280: 5f74 6162 6c65 0a20 2020 2020 2020 2072  _table.        r
+0001e290: 6574 7572 6e20 696d 6167 655f 7265 7669  eturn image_revi
+0001e2a0: 7365 645f 6c61 7374 0a20 2020 2064 6566  sed_last.    def
+0001e2b0: 2064 6f5f 6f72 6465 725f 6f66 5f72 6567   do_order_of_reg
+0001e2c0: 696f 6e73 2873 656c 662c 202a 6172 6773  ions(self, *args
+0001e2d0: 2c20 2a2a 6b77 6172 6773 293a 0a20 2020  , **kwargs):.   
+0001e2e0: 2020 2020 2069 6620 7365 6c66 2e66 756c       if self.ful
+0001e2f0: 6c5f 6c61 796f 7574 3a0a 2020 2020 2020  l_layout:.      
+0001e300: 2020 2020 2020 7265 7475 726e 2073 656c        return sel
+0001e310: 662e 646f 5f6f 7264 6572 5f6f 665f 7265  f.do_order_of_re
+0001e320: 6769 6f6e 735f 6675 6c6c 5f6c 6179 6f75  gions_full_layou
+0001e330: 7428 2a61 7267 732c 202a 2a6b 7761 7267  t(*args, **kwarg
+0001e340: 7329 0a20 2020 2020 2020 2072 6574 7572  s).        retur
+0001e350: 6e20 7365 6c66 2e64 6f5f 6f72 6465 725f  n self.do_order_
+0001e360: 6f66 5f72 6567 696f 6e73 5f6e 6f5f 6675  of_regions_no_fu
+0001e370: 6c6c 5f6c 6179 6f75 7428 2a61 7267 732c  ll_layout(*args,
+0001e380: 202a 2a6b 7761 7267 7329 0a20 2020 200a   **kwargs).    .
+0001e390: 2020 2020 6465 6620 6765 745f 7461 626c      def get_tabl
+0001e3a0: 6573 5f66 726f 6d5f 6d6f 6465 6c28 7365  es_from_model(se
+0001e3b0: 6c66 2c20 696d 672c 206e 756d 5f63 6f6c  lf, img, num_col
+0001e3c0: 5f63 6c61 7373 6966 6965 7229 3a0a 2020  _classifier):.  
+0001e3d0: 2020 2020 2020 696d 675f 6f72 6720 3d20        img_org = 
+0001e3e0: 6e70 2e63 6f70 7928 696d 6729 0a20 2020  np.copy(img).   
+0001e3f0: 2020 2020 200a 2020 2020 2020 2020 696d       .        im
+0001e400: 675f 6865 6967 6874 5f68 203d 2069 6d67  g_height_h = img
+0001e410: 5f6f 7267 2e73 6861 7065 5b30 5d0a 2020  _org.shape[0].  
+0001e420: 2020 2020 2020 696d 675f 7769 6474 685f        img_width_
+0001e430: 6820 3d20 696d 675f 6f72 672e 7368 6170  h = img_org.shap
+0001e440: 655b 315d 0a20 2020 2020 2020 200a 2020  e[1].        .  
+0001e450: 2020 2020 2020 6d6f 6465 6c5f 7265 6769        model_regi
+0001e460: 6f6e 2c20 7365 7373 696f 6e5f 7265 6769  on, session_regi
+0001e470: 6f6e 203d 2073 656c 662e 7374 6172 745f  on = self.start_
+0001e480: 6e65 775f 7365 7373 696f 6e5f 616e 645f  new_session_and_
+0001e490: 6d6f 6465 6c28 7365 6c66 2e6d 6f64 656c  model(self.model
+0001e4a0: 5f74 6162 6c65 7329 0a20 2020 2020 2020  _tables).       
+0001e4b0: 200a 2020 2020 2020 2020 7061 7463 6865   .        patche
+0001e4c0: 7320 3d20 4661 6c73 650a 2020 2020 2020  s = False.      
+0001e4d0: 2020 0a20 2020 2020 2020 2069 6620 6e75    .        if nu
+0001e4e0: 6d5f 636f 6c5f 636c 6173 7369 6669 6572  m_col_classifier
+0001e4f0: 203c 2034 2061 6e64 206e 756d 5f63 6f6c   < 4 and num_col
+0001e500: 5f63 6c61 7373 6966 6965 7220 3e20 323a  _classifier > 2:
+0001e510: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
+0001e520: 6469 6374 696f 6e5f 7461 626c 6520 3d20  diction_table = 
+0001e530: 7365 6c66 2e64 6f5f 7072 6564 6963 7469  self.do_predicti
+0001e540: 6f6e 2870 6174 6368 6573 2c20 696d 672c  on(patches, img,
+0001e550: 206d 6f64 656c 5f72 6567 696f 6e29 0a20   model_region). 
+0001e560: 2020 2020 2020 2020 2020 2070 7265 5f75             pre_u
+0001e570: 7064 6f77 6e20 3d20 7365 6c66 2e64 6f5f  pdown = self.do_
+0001e580: 7072 6564 6963 7469 6f6e 2870 6174 6368  prediction(patch
+0001e590: 6573 2c20 6376 322e 666c 6970 2869 6d67  es, cv2.flip(img
+0001e5a0: 5b3a 2c3a 2c3a 5d2c 202d 3129 2c20 6d6f  [:,:,:], -1), mo
+0001e5b0: 6465 6c5f 7265 6769 6f6e 290a 2020 2020  del_region).    
+0001e5c0: 2020 2020 2020 2020 7072 655f 7570 646f          pre_updo
+0001e5d0: 776e 203d 2063 7632 2e66 6c69 7028 7072  wn = cv2.flip(pr
+0001e5e0: 655f 7570 646f 776e 2c20 2d31 290a 2020  e_updown, -1).  
+0001e5f0: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0001e600: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
+0001e610: 6e5f 7461 626c 655b 3a2c 3a2c 305d 5b70  n_table[:,:,0][p
+0001e620: 7265 5f75 7064 6f77 6e5b 3a2c 3a2c 305d  re_updown[:,:,0]
+0001e630: 3d3d 315d 3d31 0a20 2020 2020 2020 2020  ==1]=1.         
+0001e640: 2020 2070 7265 6469 6374 696f 6e5f 7461     prediction_ta
+0001e650: 626c 6520 3d20 7072 6564 6963 7469 6f6e  ble = prediction
+0001e660: 5f74 6162 6c65 2e61 7374 7970 6528 6e70  _table.astype(np
+0001e670: 2e69 6e74 3136 290a 2020 2020 2020 2020  .int16).        
+0001e680: 2020 2020 0a20 2020 2020 2020 2065 6c69      .        eli
+0001e690: 6620 6e75 6d5f 636f 6c5f 636c 6173 7369  f num_col_classi
+0001e6a0: 6669 6572 203d 3d32 3a0a 2020 2020 2020  fier ==2:.      
+0001e6b0: 2020 2020 2020 6865 6967 6874 5f65 7874        height_ext
+0001e6c0: 203d 2030 2369 6e74 2820 696d 672e 7368   = 0#int( img.sh
+0001e6d0: 6170 655b 305d 2f34 2e20 290a 2020 2020  ape[0]/4. ).    
+0001e6e0: 2020 2020 2020 2020 685f 7374 6172 7420          h_start 
+0001e6f0: 3d20 696e 7428 6865 6967 6874 5f65 7874  = int(height_ext
+0001e700: 2f32 2e29 0a20 2020 2020 2020 2020 2020  /2.).           
+0001e710: 2077 6964 7468 5f65 7874 203d 2069 6e74   width_ext = int
+0001e720: 2820 696d 672e 7368 6170 655b 315d 2f38  ( img.shape[1]/8
+0001e730: 2e20 290a 2020 2020 2020 2020 2020 2020  . ).            
+0001e740: 775f 7374 6172 7420 3d20 696e 7428 7769  w_start = int(wi
+0001e750: 6474 685f 6578 742f 322e 290a 2020 2020  dth_ext/2.).    
+0001e760: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+0001e770: 2068 6569 6768 745f 6e65 7720 3d20 696d   height_new = im
+0001e780: 672e 7368 6170 655b 305d 2b68 6569 6768  g.shape[0]+heigh
+0001e790: 745f 6578 740a 2020 2020 2020 2020 2020  t_ext.          
+0001e7a0: 2020 7769 6474 685f 6e65 7720 3d20 696d    width_new = im
+0001e7b0: 672e 7368 6170 655b 315d 2b77 6964 7468  g.shape[1]+width
+0001e7c0: 5f65 7874 0a20 2020 2020 2020 2020 2020  _ext.           
+0001e7d0: 200a 2020 2020 2020 2020 2020 2020 696d   .            im
+0001e7e0: 675f 6e65 7720 3d6e 702e 6f6e 6573 2828  g_new =np.ones((
+0001e7f0: 6865 6967 6874 5f6e 6577 2c77 6964 7468  height_new,width
+0001e800: 5f6e 6577 2c69 6d67 2e73 6861 7065 5b32  _new,img.shape[2
+0001e810: 5d29 292e 6173 7479 7065 2866 6c6f 6174  ])).astype(float
+0001e820: 292a 300a 2020 2020 2020 2020 2020 2020  )*0.            
+0001e830: 696d 675f 6e65 775b 685f 7374 6172 743a  img_new[h_start:
+0001e840: 685f 7374 6172 742b 696d 672e 7368 6170  h_start+img.shap
+0001e850: 655b 305d 202c 775f 7374 6172 743a 2077  e[0] ,w_start: w
+0001e860: 5f73 7461 7274 2b69 6d67 2e73 6861 7065  _start+img.shape
+0001e870: 5b31 5d2c 203a 205d 203d 696d 675b 3a2c  [1], : ] =img[:,
+0001e880: 3a2c 3a5d 0a0a 2020 2020 2020 2020 2020  :,:]..          
+0001e890: 2020 7072 6564 6963 7469 6f6e 5f65 7874    prediction_ext
+0001e8a0: 203d 2073 656c 662e 646f 5f70 7265 6469   = self.do_predi
+0001e8b0: 6374 696f 6e28 7061 7463 6865 732c 2069  ction(patches, i
+0001e8c0: 6d67 5f6e 6577 2c20 6d6f 6465 6c5f 7265  mg_new, model_re
+0001e8d0: 6769 6f6e 290a 2020 2020 2020 2020 2020  gion).          
+0001e8e0: 2020 7072 655f 7570 646f 776e 203d 2073    pre_updown = s
+0001e8f0: 656c 662e 646f 5f70 7265 6469 6374 696f  elf.do_predictio
+0001e900: 6e28 7061 7463 6865 732c 2063 7632 2e66  n(patches, cv2.f
+0001e910: 6c69 7028 696d 675f 6e65 775b 3a2c 3a2c  lip(img_new[:,:,
+0001e920: 3a5d 2c20 2d31 292c 206d 6f64 656c 5f72  :], -1), model_r
+0001e930: 6567 696f 6e29 0a20 2020 2020 2020 2020  egion).         
+0001e940: 2020 2070 7265 5f75 7064 6f77 6e20 3d20     pre_updown = 
+0001e950: 6376 322e 666c 6970 2870 7265 5f75 7064  cv2.flip(pre_upd
+0001e960: 6f77 6e2c 202d 3129 0a20 2020 2020 2020  own, -1).       
+0001e970: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+0001e980: 2020 7072 6564 6963 7469 6f6e 5f74 6162    prediction_tab
+0001e990: 6c65 203d 2070 7265 6469 6374 696f 6e5f  le = prediction_
+0001e9a0: 6578 745b 685f 7374 6172 743a 685f 7374  ext[h_start:h_st
+0001e9b0: 6172 742b 696d 672e 7368 6170 655b 305d  art+img.shape[0]
+0001e9c0: 202c 775f 7374 6172 743a 2077 5f73 7461   ,w_start: w_sta
+0001e9d0: 7274 2b69 6d67 2e73 6861 7065 5b31 5d2c  rt+img.shape[1],
+0001e9e0: 203a 205d 0a20 2020 2020 2020 2020 2020   : ].           
+0001e9f0: 2070 7265 6469 6374 696f 6e5f 7461 626c   prediction_tabl
+0001ea00: 655f 7570 646f 776e 203d 2070 7265 5f75  e_updown = pre_u
+0001ea10: 7064 6f77 6e5b 685f 7374 6172 743a 685f  pdown[h_start:h_
+0001ea20: 7374 6172 742b 696d 672e 7368 6170 655b  start+img.shape[
+0001ea30: 305d 202c 775f 7374 6172 743a 2077 5f73  0] ,w_start: w_s
+0001ea40: 7461 7274 2b69 6d67 2e73 6861 7065 5b31  tart+img.shape[1
+0001ea50: 5d2c 203a 205d 0a20 2020 2020 2020 2020  ], : ].         
+0001ea60: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+0001ea70: 7072 6564 6963 7469 6f6e 5f74 6162 6c65  prediction_table
+0001ea80: 5b3a 2c3a 2c30 5d5b 7072 6564 6963 7469  [:,:,0][predicti
+0001ea90: 6f6e 5f74 6162 6c65 5f75 7064 6f77 6e5b  on_table_updown[
+0001eaa0: 3a2c 3a2c 305d 3d3d 315d 3d31 0a20 2020  :,:,0]==1]=1.   
+0001eab0: 2020 2020 2020 2020 2070 7265 6469 6374           predict
+0001eac0: 696f 6e5f 7461 626c 6520 3d20 7072 6564  ion_table = pred
+0001ead0: 6963 7469 6f6e 5f74 6162 6c65 2e61 7374  iction_table.ast
+0001eae0: 7970 6528 6e70 2e69 6e74 3136 290a 0a20  ype(np.int16).. 
+0001eaf0: 2020 2020 2020 2065 6c69 6620 6e75 6d5f         elif num_
+0001eb00: 636f 6c5f 636c 6173 7369 6669 6572 203d  col_classifier =
+0001eb10: 3d31 3a0a 2020 2020 2020 2020 2020 2020  =1:.            
+0001eb20: 6865 6967 6874 5f65 7874 203d 2030 2320  height_ext = 0# 
+0001eb30: 696e 7428 2069 6d67 2e73 6861 7065 5b30  int( img.shape[0
+0001eb40: 5d2f 342e 2029 0a20 2020 2020 2020 2020  ]/4. ).         
+0001eb50: 2020 2068 5f73 7461 7274 203d 2069 6e74     h_start = int
+0001eb60: 2868 6569 6768 745f 6578 742f 322e 290a  (height_ext/2.).
+0001eb70: 2020 2020 2020 2020 2020 2020 7769 6474              widt
+0001eb80: 685f 6578 7420 3d20 696e 7428 2069 6d67  h_ext = int( img
+0001eb90: 2e73 6861 7065 5b31 5d2f 342e 2029 0a20  .shape[1]/4. ). 
+0001eba0: 2020 2020 2020 2020 2020 2077 5f73 7461             w_sta
+0001ebb0: 7274 203d 2069 6e74 2877 6964 7468 5f65  rt = int(width_e
+0001ebc0: 7874 2f32 2e29 0a20 2020 2020 2020 200a  xt/2.).        .
+0001ebd0: 2020 2020 2020 2020 2020 2020 6865 6967              heig
+0001ebe0: 6874 5f6e 6577 203d 2069 6d67 2e73 6861  ht_new = img.sha
+0001ebf0: 7065 5b30 5d2b 6865 6967 6874 5f65 7874  pe[0]+height_ext
+0001ec00: 0a20 2020 2020 2020 2020 2020 2077 6964  .            wid
+0001ec10: 7468 5f6e 6577 203d 2069 6d67 2e73 6861  th_new = img.sha
+0001ec20: 7065 5b31 5d2b 7769 6474 685f 6578 740a  pe[1]+width_ext.
+0001ec30: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+0001ec40: 2020 2020 2020 2020 2069 6d67 5f6e 6577           img_new
+0001ec50: 203d 6e70 2e6f 6e65 7328 2868 6569 6768   =np.ones((heigh
+0001ec60: 745f 6e65 772c 7769 6474 685f 6e65 772c  t_new,width_new,
+0001ec70: 696d 672e 7368 6170 655b 325d 2929 2e61  img.shape[2])).a
+0001ec80: 7374 7970 6528 666c 6f61 7429 2a30 0a20  stype(float)*0. 
+0001ec90: 2020 2020 2020 2020 2020 2069 6d67 5f6e             img_n
+0001eca0: 6577 5b68 5f73 7461 7274 3a68 5f73 7461  ew[h_start:h_sta
+0001ecb0: 7274 2b69 6d67 2e73 6861 7065 5b30 5d20  rt+img.shape[0] 
+0001ecc0: 2c77 5f73 7461 7274 3a20 775f 7374 6172  ,w_start: w_star
+0001ecd0: 742b 696d 672e 7368 6170 655b 315d 2c20  t+img.shape[1], 
+0001ece0: 3a20 5d20 3d69 6d67 5b3a 2c3a 2c3a 5d0a  : ] =img[:,:,:].
+0001ecf0: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
+0001ed00: 6469 6374 696f 6e5f 6578 7420 3d20 7365  diction_ext = se
+0001ed10: 6c66 2e64 6f5f 7072 6564 6963 7469 6f6e  lf.do_prediction
+0001ed20: 2870 6174 6368 6573 2c20 696d 675f 6e65  (patches, img_ne
+0001ed30: 772c 206d 6f64 656c 5f72 6567 696f 6e29  w, model_region)
+0001ed40: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
+0001ed50: 5f75 7064 6f77 6e20 3d20 7365 6c66 2e64  _updown = self.d
+0001ed60: 6f5f 7072 6564 6963 7469 6f6e 2870 6174  o_prediction(pat
+0001ed70: 6368 6573 2c20 6376 322e 666c 6970 2869  ches, cv2.flip(i
+0001ed80: 6d67 5f6e 6577 5b3a 2c3a 2c3a 5d2c 202d  mg_new[:,:,:], -
+0001ed90: 3129 2c20 6d6f 6465 6c5f 7265 6769 6f6e  1), model_region
+0001eda0: 290a 2020 2020 2020 2020 2020 2020 7072  ).            pr
+0001edb0: 655f 7570 646f 776e 203d 2063 7632 2e66  e_updown = cv2.f
+0001edc0: 6c69 7028 7072 655f 7570 646f 776e 2c20  lip(pre_updown, 
+0001edd0: 2d31 290a 2020 2020 2020 2020 2020 2020  -1).            
+0001ede0: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
+0001edf0: 6469 6374 696f 6e5f 7461 626c 6520 3d20  diction_table = 
+0001ee00: 7072 6564 6963 7469 6f6e 5f65 7874 5b68  prediction_ext[h
+0001ee10: 5f73 7461 7274 3a68 5f73 7461 7274 2b69  _start:h_start+i
+0001ee20: 6d67 2e73 6861 7065 5b30 5d20 2c77 5f73  mg.shape[0] ,w_s
+0001ee30: 7461 7274 3a20 775f 7374 6172 742b 696d  tart: w_start+im
+0001ee40: 672e 7368 6170 655b 315d 2c20 3a20 5d0a  g.shape[1], : ].
+0001ee50: 2020 2020 2020 2020 2020 2020 7072 6564              pred
+0001ee60: 6963 7469 6f6e 5f74 6162 6c65 5f75 7064  iction_table_upd
+0001ee70: 6f77 6e20 3d20 7072 655f 7570 646f 776e  own = pre_updown
+0001ee80: 5b68 5f73 7461 7274 3a68 5f73 7461 7274  [h_start:h_start
+0001ee90: 2b69 6d67 2e73 6861 7065 5b30 5d20 2c77  +img.shape[0] ,w
+0001eea0: 5f73 7461 7274 3a20 775f 7374 6172 742b  _start: w_start+
+0001eeb0: 696d 672e 7368 6170 655b 315d 2c20 3a20  img.shape[1], : 
+0001eec0: 5d0a 2020 2020 2020 2020 2020 2020 0a20  ].            . 
+0001eed0: 2020 2020 2020 2020 2020 2070 7265 6469             predi
+0001eee0: 6374 696f 6e5f 7461 626c 655b 3a2c 3a2c  ction_table[:,:,
+0001eef0: 305d 5b70 7265 6469 6374 696f 6e5f 7461  0][prediction_ta
+0001ef00: 626c 655f 7570 646f 776e 5b3a 2c3a 2c30  ble_updown[:,:,0
+0001ef10: 5d3d 3d31 5d3d 310a 2020 2020 2020 2020  ]==1]=1.        
+0001ef20: 2020 2020 7072 6564 6963 7469 6f6e 5f74      prediction_t
+0001ef30: 6162 6c65 203d 2070 7265 6469 6374 696f  able = predictio
+0001ef40: 6e5f 7461 626c 652e 6173 7479 7065 286e  n_table.astype(n
+0001ef50: 702e 696e 7431 3629 0a0a 2020 2020 2020  p.int16)..      
+0001ef60: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+0001ef70: 2020 2020 7072 6564 6963 7469 6f6e 5f74      prediction_t
+0001ef80: 6162 6c65 203d 206e 702e 7a65 726f 7328  able = np.zeros(
+0001ef90: 696d 672e 7368 6170 6529 0a20 2020 2020  img.shape).     
+0001efa0: 2020 2020 2020 2069 6d67 5f77 5f68 616c         img_w_hal
+0001efb0: 6620 3d20 696e 7428 696d 672e 7368 6170  f = int(img.shap
+0001efc0: 655b 315d 2f32 2e29 0a0a 2020 2020 2020  e[1]/2.)..      
+0001efd0: 2020 2020 2020 7072 6531 203d 2073 656c        pre1 = sel
+0001efe0: 662e 646f 5f70 7265 6469 6374 696f 6e28  f.do_prediction(
+0001eff0: 7061 7463 6865 732c 2069 6d67 5b3a 2c30  patches, img[:,0
+0001f000: 3a69 6d67 5f77 5f68 616c 662c 3a5d 2c20  :img_w_half,:], 
+0001f010: 6d6f 6465 6c5f 7265 6769 6f6e 290a 2020  model_region).  
+0001f020: 2020 2020 2020 2020 2020 7072 6532 203d            pre2 =
+0001f030: 2073 656c 662e 646f 5f70 7265 6469 6374   self.do_predict
+0001f040: 696f 6e28 7061 7463 6865 732c 2069 6d67  ion(patches, img
+0001f050: 5b3a 2c69 6d67 5f77 5f68 616c 663a 2c3a  [:,img_w_half:,:
+0001f060: 5d2c 206d 6f64 656c 5f72 6567 696f 6e29  ], model_region)
+0001f070: 0a20 2020 2020 2020 2020 2020 2070 7265  .            pre
+0001f080: 5f66 756c 6c20 3d20 7365 6c66 2e64 6f5f  _full = self.do_
+0001f090: 7072 6564 6963 7469 6f6e 2870 6174 6368  prediction(patch
+0001f0a0: 6573 2c20 696d 675b 3a2c 3a2c 3a5d 2c20  es, img[:,:,:], 
+0001f0b0: 6d6f 6465 6c5f 7265 6769 6f6e 290a 2020  model_region).  
+0001f0c0: 2020 2020 2020 2020 2020 7072 655f 7570            pre_up
+0001f0d0: 646f 776e 203d 2073 656c 662e 646f 5f70  down = self.do_p
+0001f0e0: 7265 6469 6374 696f 6e28 7061 7463 6865  rediction(patche
+0001f0f0: 732c 2063 7632 2e66 6c69 7028 696d 675b  s, cv2.flip(img[
+0001f100: 3a2c 3a2c 3a5d 2c20 2d31 292c 206d 6f64  :,:,:], -1), mod
+0001f110: 656c 5f72 6567 696f 6e29 0a20 2020 2020  el_region).     
+0001f120: 2020 2020 2020 2070 7265 5f75 7064 6f77         pre_updow
+0001f130: 6e20 3d20 6376 322e 666c 6970 2870 7265  n = cv2.flip(pre
+0001f140: 5f75 7064 6f77 6e2c 202d 3129 0a20 2020  _updown, -1).   
+0001f150: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0001f160: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
+0001f170: 5f74 6162 6c65 5f66 756c 6c5f 6572 6f64  _table_full_erod
+0001f180: 6520 3d20 6376 322e 6572 6f64 6528 7072  e = cv2.erode(pr
+0001f190: 655f 6675 6c6c 5b3a 2c3a 2c30 5d2c 204b  e_full[:,:,0], K
+0001f1a0: 4552 4e45 4c2c 2069 7465 7261 7469 6f6e  ERNEL, iteration
+0001f1b0: 733d 3429 0a20 2020 2020 2020 2020 2020  s=4).           
+0001f1c0: 2070 7265 6469 6374 696f 6e5f 7461 626c   prediction_tabl
+0001f1d0: 655f 6675 6c6c 5f65 726f 6465 203d 2063  e_full_erode = c
+0001f1e0: 7632 2e64 696c 6174 6528 7072 6564 6963  v2.dilate(predic
+0001f1f0: 7469 6f6e 5f74 6162 6c65 5f66 756c 6c5f  tion_table_full_
+0001f200: 6572 6f64 652c 204b 4552 4e45 4c2c 2069  erode, KERNEL, i
+0001f210: 7465 7261 7469 6f6e 733d 3429 0a20 2020  terations=4).   
+0001f220: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+0001f230: 2020 2020 2020 7072 6564 6963 7469 6f6e        prediction
+0001f240: 5f74 6162 6c65 5f66 756c 6c5f 7570 646f  _table_full_updo
+0001f250: 776e 5f65 726f 6465 203d 2063 7632 2e65  wn_erode = cv2.e
+0001f260: 726f 6465 2870 7265 5f75 7064 6f77 6e5b  rode(pre_updown[
+0001f270: 3a2c 3a2c 305d 2c20 4b45 524e 454c 2c20  :,:,0], KERNEL, 
+0001f280: 6974 6572 6174 696f 6e73 3d34 290a 2020  iterations=4).  
+0001f290: 2020 2020 2020 2020 2020 7072 6564 6963            predic
+0001f2a0: 7469 6f6e 5f74 6162 6c65 5f66 756c 6c5f  tion_table_full_
+0001f2b0: 7570 646f 776e 5f65 726f 6465 203d 2063  updown_erode = c
+0001f2c0: 7632 2e64 696c 6174 6528 7072 6564 6963  v2.dilate(predic
+0001f2d0: 7469 6f6e 5f74 6162 6c65 5f66 756c 6c5f  tion_table_full_
+0001f2e0: 7570 646f 776e 5f65 726f 6465 2c20 4b45  updown_erode, KE
+0001f2f0: 524e 454c 2c20 6974 6572 6174 696f 6e73  RNEL, iterations
+0001f300: 3d34 290a 0a20 2020 2020 2020 2020 2020  =4)..           
+0001f310: 2070 7265 6469 6374 696f 6e5f 7461 626c   prediction_tabl
+0001f320: 655b 3a2c 303a 696d 675f 775f 6861 6c66  e[:,0:img_w_half
+0001f330: 2c3a 5d20 3d20 7072 6531 5b3a 2c3a 2c3a  ,:] = pre1[:,:,:
+0001f340: 5d0a 2020 2020 2020 2020 2020 2020 7072  ].            pr
+0001f350: 6564 6963 7469 6f6e 5f74 6162 6c65 5b3a  ediction_table[:
+0001f360: 2c69 6d67 5f77 5f68 616c 663a 2c3a 5d20  ,img_w_half:,:] 
+0001f370: 3d20 7072 6532 5b3a 2c3a 2c3a 5d0a 2020  = pre2[:,:,:].  
+0001f380: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+0001f390: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
+0001f3a0: 6e5f 7461 626c 655b 3a2c 3a2c 305d 5b70  n_table[:,:,0][p
+0001f3b0: 7265 6469 6374 696f 6e5f 7461 626c 655f  rediction_table_
+0001f3c0: 6675 6c6c 5f65 726f 6465 5b3a 2c3a 5d3d  full_erode[:,:]=
+0001f3d0: 3d31 5d3d 310a 2020 2020 2020 2020 2020  =1]=1.          
+0001f3e0: 2020 7072 6564 6963 7469 6f6e 5f74 6162    prediction_tab
+0001f3f0: 6c65 5b3a 2c3a 2c30 5d5b 7072 6564 6963  le[:,:,0][predic
+0001f400: 7469 6f6e 5f74 6162 6c65 5f66 756c 6c5f  tion_table_full_
+0001f410: 7570 646f 776e 5f65 726f 6465 5b3a 2c3a  updown_erode[:,:
+0001f420: 5d3d 3d31 5d3d 310a 2020 2020 2020 2020  ]==1]=1.        
+0001f430: 2020 2020 7072 6564 6963 7469 6f6e 5f74      prediction_t
+0001f440: 6162 6c65 203d 2070 7265 6469 6374 696f  able = predictio
+0001f450: 6e5f 7461 626c 652e 6173 7479 7065 286e  n_table.astype(n
+0001f460: 702e 696e 7431 3629 0a20 2020 2020 2020  p.int16).       
+0001f470: 2020 2020 200a 2020 2020 2020 2020 2370       .        #p
+0001f480: 7265 6469 6374 696f 6e5f 7461 626c 655f  rediction_table_
+0001f490: 6572 6f64 6520 3d20 6376 322e 6572 6f64  erode = cv2.erod
+0001f4a0: 6528 7072 6564 6963 7469 6f6e 5f74 6162  e(prediction_tab
+0001f4b0: 6c65 5b3a 2c3a 2c30 5d2c 2073 656c 662e  le[:,:,0], self.
+0001f4c0: 6b65 726e 656c 2c20 6974 6572 6174 696f  kernel, iteratio
+0001f4d0: 6e73 3d36 290a 2020 2020 2020 2020 2370  ns=6).        #p
+0001f4e0: 7265 6469 6374 696f 6e5f 7461 626c 655f  rediction_table_
+0001f4f0: 6572 6f64 6520 3d20 6376 322e 6469 6c61  erode = cv2.dila
+0001f500: 7465 2870 7265 6469 6374 696f 6e5f 7461  te(prediction_ta
+0001f510: 626c 655f 6572 6f64 652c 2073 656c 662e  ble_erode, self.
+0001f520: 6b65 726e 656c 2c20 6974 6572 6174 696f  kernel, iteratio
+0001f530: 6e73 3d36 290a 2020 2020 2020 2020 0a20  ns=6).        . 
+0001f540: 2020 2020 2020 2070 7265 6469 6374 696f         predictio
+0001f550: 6e5f 7461 626c 655f 6572 6f64 6520 3d20  n_table_erode = 
+0001f560: 6376 322e 6572 6f64 6528 7072 6564 6963  cv2.erode(predic
+0001f570: 7469 6f6e 5f74 6162 6c65 5b3a 2c3a 2c30  tion_table[:,:,0
+0001f580: 5d2c 204b 4552 4e45 4c2c 2069 7465 7261  ], KERNEL, itera
+0001f590: 7469 6f6e 733d 3230 290a 2020 2020 2020  tions=20).      
+0001f5a0: 2020 7072 6564 6963 7469 6f6e 5f74 6162    prediction_tab
+0001f5b0: 6c65 5f65 726f 6465 203d 2063 7632 2e64  le_erode = cv2.d
+0001f5c0: 696c 6174 6528 7072 6564 6963 7469 6f6e  ilate(prediction
+0001f5d0: 5f74 6162 6c65 5f65 726f 6465 2c20 4b45  _table_erode, KE
+0001f5e0: 524e 454c 2c20 6974 6572 6174 696f 6e73  RNEL, iterations
+0001f5f0: 3d32 3029 0a20 2020 2020 2020 2072 6574  =20).        ret
+0001f600: 7572 6e20 7072 6564 6963 7469 6f6e 5f74  urn prediction_t
+0001f610: 6162 6c65 5f65 726f 6465 2e61 7374 7970  able_erode.astyp
+0001f620: 6528 6e70 2e69 6e74 3136 290a 2020 2020  e(np.int16).    
+0001f630: 6465 6620 7275 6e5f 6772 6170 6869 6373  def run_graphics
+0001f640: 5f61 6e64 5f63 6f6c 756d 6e73 5f6c 6967  _and_columns_lig
+0001f650: 6874 2873 656c 662c 2074 6578 745f 7265  ht(self, text_re
+0001f660: 6769 6f6e 735f 705f 312c 2074 6578 746c  gions_p_1, textl
+0001f670: 696e 655f 6d61 736b 5f74 6f74 5f65 612c  ine_mask_tot_ea,
+0001f680: 206e 756d 5f63 6f6c 5f63 6c61 7373 6966   num_col_classif
+0001f690: 6965 722c 206e 756d 5f63 6f6c 756d 6e5f  ier, num_column_
+0001f6a0: 6973 5f63 6c61 7373 6966 6965 642c 2065  is_classified, e
+0001f6b0: 726f 7369 6f6e 5f68 7572 7473 293a 0a20  rosion_hurts):. 
+0001f6c0: 2020 2020 2020 2069 6d67 5f67 203d 2073         img_g = s
+0001f6d0: 656c 662e 696d 7265 6164 2867 7261 7973  elf.imread(grays
+0001f6e0: 6361 6c65 3d54 7275 652c 2075 696e 7438  cale=True, uint8
+0001f6f0: 3d54 7275 6529 0a0a 2020 2020 2020 2020  =True)..        
+0001f700: 696d 675f 6733 203d 206e 702e 7a65 726f  img_g3 = np.zero
+0001f710: 7328 2869 6d67 5f67 2e73 6861 7065 5b30  s((img_g.shape[0
+0001f720: 5d2c 2069 6d67 5f67 2e73 6861 7065 5b31  ], img_g.shape[1
+0001f730: 5d2c 2033 2929 0a20 2020 2020 2020 2069  ], 3)).        i
+0001f740: 6d67 5f67 3320 3d20 696d 675f 6733 2e61  mg_g3 = img_g3.a
+0001f750: 7374 7970 6528 6e70 2e75 696e 7438 290a  stype(np.uint8).
+0001f760: 2020 2020 2020 2020 696d 675f 6733 5b3a          img_g3[:
+0001f770: 2c20 3a2c 2030 5d20 3d20 696d 675f 675b  , :, 0] = img_g[
+0001f780: 3a2c 203a 5d0a 2020 2020 2020 2020 696d  :, :].        im
+0001f790: 675f 6733 5b3a 2c20 3a2c 2031 5d20 3d20  g_g3[:, :, 1] = 
+0001f7a0: 696d 675f 675b 3a2c 203a 5d0a 2020 2020  img_g[:, :].    
+0001f7b0: 2020 2020 696d 675f 6733 5b3a 2c20 3a2c      img_g3[:, :,
+0001f7c0: 2032 5d20 3d20 696d 675f 675b 3a2c 203a   2] = img_g[:, :
+0001f7d0: 5d0a 0a20 2020 2020 2020 2069 6d61 6765  ]..        image
+0001f7e0: 5f70 6167 652c 2070 6167 655f 636f 6f72  _page, page_coor
+0001f7f0: 642c 2063 6f6e 745f 7061 6765 203d 2073  d, cont_page = s
+0001f800: 656c 662e 6578 7472 6163 745f 7061 6765  elf.extract_page
+0001f810: 2829 0a20 2020 2020 2020 200a 2020 2020  ().        .    
+0001f820: 2020 2020 6966 2073 656c 662e 7461 626c      if self.tabl
+0001f830: 6573 3a0a 2020 2020 2020 2020 2020 2020  es:.            
+0001f840: 7461 626c 655f 7072 6564 6963 7469 6f6e  table_prediction
+0001f850: 203d 2073 656c 662e 6765 745f 7461 626c   = self.get_tabl
+0001f860: 6573 5f66 726f 6d5f 6d6f 6465 6c28 696d  es_from_model(im
+0001f870: 6167 655f 7061 6765 2c20 6e75 6d5f 636f  age_page, num_co
+0001f880: 6c5f 636c 6173 7369 6669 6572 290a 2020  l_classifier).  
+0001f890: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001f8a0: 2020 2020 2020 2020 7461 626c 655f 7072          table_pr
+0001f8b0: 6564 6963 7469 6f6e 203d 2028 6e70 2e7a  ediction = (np.z
+0001f8c0: 6572 6f73 2828 696d 6167 655f 7061 6765  eros((image_page
+0001f8d0: 2e73 6861 7065 5b30 5d2c 2069 6d61 6765  .shape[0], image
+0001f8e0: 5f70 6167 652e 7368 6170 655b 315d 2929  _page.shape[1]))
+0001f8f0: 292e 6173 7479 7065 286e 702e 696e 7431  ).astype(np.int1
+0001f900: 3629 0a20 2020 2020 2020 200a 2020 2020  6).        .    
+0001f910: 2020 2020 6966 2073 656c 662e 706c 6f74      if self.plot
+0001f920: 7465 723a 0a20 2020 2020 2020 2020 2020  ter:.           
+0001f930: 2073 656c 662e 706c 6f74 7465 722e 7361   self.plotter.sa
+0001f940: 7665 5f70 6167 655f 696d 6167 6528 696d  ve_page_image(im
+0001f950: 6167 655f 7061 6765 290a 0a20 2020 2020  age_page)..     
+0001f960: 2020 2074 6578 745f 7265 6769 6f6e 735f     text_regions_
+0001f970: 705f 3120 3d20 7465 7874 5f72 6567 696f  p_1 = text_regio
+0001f980: 6e73 5f70 5f31 5b70 6167 655f 636f 6f72  ns_p_1[page_coor
+0001f990: 645b 305d 203a 2070 6167 655f 636f 6f72  d[0] : page_coor
+0001f9a0: 645b 315d 2c20 7061 6765 5f63 6f6f 7264  d[1], page_coord
+0001f9b0: 5b32 5d20 3a20 7061 6765 5f63 6f6f 7264  [2] : page_coord
+0001f9c0: 5b33 5d5d 0a20 2020 2020 2020 2074 6578  [3]].        tex
+0001f9d0: 746c 696e 655f 6d61 736b 5f74 6f74 5f65  tline_mask_tot_e
+0001f9e0: 6120 3d20 7465 7874 6c69 6e65 5f6d 6173  a = textline_mas
+0001f9f0: 6b5f 746f 745f 6561 5b70 6167 655f 636f  k_tot_ea[page_co
+0001fa00: 6f72 645b 305d 203a 2070 6167 655f 636f  ord[0] : page_co
+0001fa10: 6f72 645b 315d 2c20 7061 6765 5f63 6f6f  ord[1], page_coo
+0001fa20: 7264 5b32 5d20 3a20 7061 6765 5f63 6f6f  rd[2] : page_coo
+0001fa30: 7264 5b33 5d5d 0a20 2020 2020 2020 206d  rd[3]].        m
+0001fa40: 6173 6b5f 696d 6167 6573 203d 2028 7465  ask_images = (te
+0001fa50: 7874 5f72 6567 696f 6e73 5f70 5f31 5b3a  xt_regions_p_1[:
+0001fa60: 2c20 3a5d 203d 3d20 3229 202a 2031 0a20  , :] == 2) * 1. 
+0001fa70: 2020 2020 2020 206d 6173 6b5f 696d 6167         mask_imag
+0001fa80: 6573 203d 206d 6173 6b5f 696d 6167 6573  es = mask_images
+0001fa90: 2e61 7374 7970 6528 6e70 2e75 696e 7438  .astype(np.uint8
+0001faa0: 290a 2020 2020 2020 2020 6d61 736b 5f69  ).        mask_i
+0001fab0: 6d61 6765 7320 3d20 6376 322e 6572 6f64  mages = cv2.erod
+0001fac0: 6528 6d61 736b 5f69 6d61 6765 735b 3a2c  e(mask_images[:,
+0001fad0: 203a 5d2c 204b 4552 4e45 4c2c 2069 7465   :], KERNEL, ite
+0001fae0: 7261 7469 6f6e 733d 3130 290a 2020 2020  rations=10).    
+0001faf0: 2020 2020 6d61 736b 5f6c 696e 6573 203d      mask_lines =
+0001fb00: 2028 7465 7874 5f72 6567 696f 6e73 5f70   (text_regions_p
+0001fb10: 5f31 5b3a 2c20 3a5d 203d 3d20 3329 202a  _1[:, :] == 3) *
+0001fb20: 2031 0a20 2020 2020 2020 206d 6173 6b5f   1.        mask_
+0001fb30: 6c69 6e65 7320 3d20 6d61 736b 5f6c 696e  lines = mask_lin
+0001fb40: 6573 2e61 7374 7970 6528 6e70 2e75 696e  es.astype(np.uin
+0001fb50: 7438 290a 2020 2020 2020 2020 696d 675f  t8).        img_
+0001fb60: 6f6e 6c79 5f72 6567 696f 6e73 5f77 6974  only_regions_wit
+0001fb70: 685f 7365 7020 3d20 2828 7465 7874 5f72  h_sep = ((text_r
+0001fb80: 6567 696f 6e73 5f70 5f31 5b3a 2c20 3a5d  egions_p_1[:, :]
+0001fb90: 2021 3d20 3329 2026 2028 7465 7874 5f72   != 3) & (text_r
+0001fba0: 6567 696f 6e73 5f70 5f31 5b3a 2c20 3a5d  egions_p_1[:, :]
+0001fbb0: 2021 3d20 3029 2920 2a20 310a 2020 2020   != 0)) * 1.    
+0001fbc0: 2020 2020 696d 675f 6f6e 6c79 5f72 6567      img_only_reg
+0001fbd0: 696f 6e73 5f77 6974 685f 7365 7020 3d20  ions_with_sep = 
+0001fbe0: 696d 675f 6f6e 6c79 5f72 6567 696f 6e73  img_only_regions
+0001fbf0: 5f77 6974 685f 7365 702e 6173 7479 7065  _with_sep.astype
+0001fc00: 286e 702e 7569 6e74 3829 0a20 2020 2020  (np.uint8).     
+0001fc10: 2020 200a 2020 2020 2020 2020 0a20 2020     .        .   
+0001fc20: 2020 2020 2069 6620 6572 6f73 696f 6e5f       if erosion_
+0001fc30: 6875 7274 733a 0a20 2020 2020 2020 2020  hurts:.         
+0001fc40: 2020 2069 6d67 5f6f 6e6c 795f 7265 6769     img_only_regi
+0001fc50: 6f6e 7320 3d20 6e70 2e63 6f70 7928 696d  ons = np.copy(im
+0001fc60: 675f 6f6e 6c79 5f72 6567 696f 6e73 5f77  g_only_regions_w
+0001fc70: 6974 685f 7365 705b 3a2c 3a5d 290a 2020  ith_sep[:,:]).  
+0001fc80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+0001fc90: 2020 2020 2020 2020 696d 675f 6f6e 6c79          img_only
+0001fca0: 5f72 6567 696f 6e73 203d 2063 7632 2e65  _regions = cv2.e
+0001fcb0: 726f 6465 2869 6d67 5f6f 6e6c 795f 7265  rode(img_only_re
+0001fcc0: 6769 6f6e 735f 7769 7468 5f73 6570 5b3a  gions_with_sep[:
+0001fcd0: 2c3a 5d2c 204b 4552 4e45 4c2c 2069 7465  ,:], KERNEL, ite
+0001fce0: 7261 7469 6f6e 733d 3629 0a20 2020 2020  rations=6).     
+0001fcf0: 2020 200a 2020 2020 2020 2020 2323 7072     .        ##pr
+0001fd00: 696e 7428 696d 675f 6f6e 6c79 5f72 6567  int(img_only_reg
+0001fd10: 696f 6e73 2e73 6861 7065 2c27 696d 675f  ions.shape,'img_
+0001fd20: 6f6e 6c79 5f72 6567 696f 6e73 2729 0a20  only_regions'). 
+0001fd30: 2020 2020 2020 2023 2370 6c74 2e69 6d73         ##plt.ims
+0001fd40: 686f 7728 696d 675f 6f6e 6c79 5f72 6567  how(img_only_reg
+0001fd50: 696f 6e73 5b3a 2c3a 5d29 0a20 2020 2020  ions[:,:]).     
+0001fd60: 2020 2023 2370 6c74 2e73 686f 7728 290a     ##plt.show().
+0001fd70: 2020 2020 2020 2020 2323 6e75 6d5f 636f          ##num_co
+0001fd80: 6c2c 205f 203d 2066 696e 645f 6e75 6d5f  l, _ = find_num_
+0001fd90: 636f 6c28 696d 675f 6f6e 6c79 5f72 6567  col(img_only_reg
+0001fda0: 696f 6e73 2c20 6e75 6d5f 636f 6c5f 636c  ions, num_col_cl
+0001fdb0: 6173 7369 6669 6572 2c20 7365 6c66 2e74  assifier, self.t
+0001fdc0: 6162 6c65 732c 206d 756c 7469 706c 6965  ables, multiplie
+0001fdd0: 723d 362e 3029 0a20 2020 2020 2020 2074  r=6.0).        t
+0001fde0: 7279 3a0a 2020 2020 2020 2020 2020 2020  ry:.            
+0001fdf0: 6e75 6d5f 636f 6c2c 205f 203d 2066 696e  num_col, _ = fin
+0001fe00: 645f 6e75 6d5f 636f 6c28 696d 675f 6f6e  d_num_col(img_on
+0001fe10: 6c79 5f72 6567 696f 6e73 2c20 6e75 6d5f  ly_regions, num_
+0001fe20: 636f 6c5f 636c 6173 7369 6669 6572 2c20  col_classifier, 
+0001fe30: 7365 6c66 2e74 6162 6c65 732c 206d 756c  self.tables, mul
+0001fe40: 7469 706c 6965 723d 362e 3029 0a20 2020  tiplier=6.0).   
+0001fe50: 2020 2020 2020 2020 206e 756d 5f63 6f6c           num_col
+0001fe60: 203d 206e 756d 5f63 6f6c 202b 2031 0a20   = num_col + 1. 
+0001fe70: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+0001fe80: 7420 6e75 6d5f 636f 6c75 6d6e 5f69 735f  t num_column_is_
+0001fe90: 636c 6173 7369 6669 6564 3a0a 2020 2020  classified:.    
+0001fea0: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
+0001feb0: 636f 6c5f 636c 6173 7369 6669 6572 203d  col_classifier =
+0001fec0: 206e 756d 5f63 6f6c 202b 2031 0a20 2020   num_col + 1.   
+0001fed0: 2020 2020 2065 7863 6570 7420 4578 6365       except Exce
+0001fee0: 7074 696f 6e20 6173 2077 6879 3a0a 2020  ption as why:.  
+0001fef0: 2020 2020 2020 2020 2020 7365 6c66 2e6c            self.l
+0001ff00: 6f67 6765 722e 6572 726f 7228 7768 7929  ogger.error(why)
+0001ff10: 0a20 2020 2020 2020 2020 2020 206e 756d  .            num
+0001ff20: 5f63 6f6c 203d 204e 6f6e 650a 2020 2020  _col = None.    
+0001ff30: 2020 2020 7265 7475 726e 206e 756d 5f63      return num_c
+0001ff40: 6f6c 2c20 6e75 6d5f 636f 6c5f 636c 6173  ol, num_col_clas
+0001ff50: 7369 6669 6572 2c20 696d 675f 6f6e 6c79  sifier, img_only
+0001ff60: 5f72 6567 696f 6e73 2c20 7061 6765 5f63  _regions, page_c
+0001ff70: 6f6f 7264 2c20 696d 6167 655f 7061 6765  oord, image_page
+0001ff80: 2c20 6d61 736b 5f69 6d61 6765 732c 206d  , mask_images, m
+0001ff90: 6173 6b5f 6c69 6e65 732c 2074 6578 745f  ask_lines, text_
+0001ffa0: 7265 6769 6f6e 735f 705f 312c 2063 6f6e  regions_p_1, con
+0001ffb0: 745f 7061 6765 2c20 7461 626c 655f 7072  t_page, table_pr
+0001ffc0: 6564 6963 7469 6f6e 2c20 7465 7874 6c69  ediction, textli
+0001ffd0: 6e65 5f6d 6173 6b5f 746f 745f 6561 0a20  ne_mask_tot_ea. 
+0001ffe0: 2020 2064 6566 2072 756e 5f67 7261 7068     def run_graph
+0001fff0: 6963 735f 616e 645f 636f 6c75 6d6e 7328  ics_and_columns(
+00020000: 7365 6c66 2c20 7465 7874 5f72 6567 696f  self, text_regio
+00020010: 6e73 5f70 5f31 2c20 6e75 6d5f 636f 6c5f  ns_p_1, num_col_
+00020020: 636c 6173 7369 6669 6572 2c20 6e75 6d5f  classifier, num_
+00020030: 636f 6c75 6d6e 5f69 735f 636c 6173 7369  column_is_classi
+00020040: 6669 6564 2c20 6572 6f73 696f 6e5f 6875  fied, erosion_hu
+00020050: 7274 7329 3a0a 2020 2020 2020 2020 696d  rts):.        im
+00020060: 675f 6720 3d20 7365 6c66 2e69 6d72 6561  g_g = self.imrea
+00020070: 6428 6772 6179 7363 616c 653d 5472 7565  d(grayscale=True
+00020080: 2c20 7569 6e74 383d 5472 7565 290a 0a20  , uint8=True).. 
+00020090: 2020 2020 2020 2069 6d67 5f67 3320 3d20         img_g3 = 
+000200a0: 6e70 2e7a 6572 6f73 2828 696d 675f 672e  np.zeros((img_g.
+000200b0: 7368 6170 655b 305d 2c20 696d 675f 672e  shape[0], img_g.
+000200c0: 7368 6170 655b 315d 2c20 3329 290a 2020  shape[1], 3)).  
+000200d0: 2020 2020 2020 696d 675f 6733 203d 2069        img_g3 = i
+000200e0: 6d67 5f67 332e 6173 7479 7065 286e 702e  mg_g3.astype(np.
+000200f0: 7569 6e74 3829 0a20 2020 2020 2020 2069  uint8).        i
+00020100: 6d67 5f67 335b 3a2c 203a 2c20 305d 203d  mg_g3[:, :, 0] =
+00020110: 2069 6d67 5f67 5b3a 2c20 3a5d 0a20 2020   img_g[:, :].   
+00020120: 2020 2020 2069 6d67 5f67 335b 3a2c 203a       img_g3[:, :
+00020130: 2c20 315d 203d 2069 6d67 5f67 5b3a 2c20  , 1] = img_g[:, 
+00020140: 3a5d 0a20 2020 2020 2020 2069 6d67 5f67  :].        img_g
+00020150: 335b 3a2c 203a 2c20 325d 203d 2069 6d67  3[:, :, 2] = img
+00020160: 5f67 5b3a 2c20 3a5d 0a0a 2020 2020 2020  _g[:, :]..      
+00020170: 2020 696d 6167 655f 7061 6765 2c20 7061    image_page, pa
+00020180: 6765 5f63 6f6f 7264 2c20 636f 6e74 5f70  ge_coord, cont_p
+00020190: 6167 6520 3d20 7365 6c66 2e65 7874 7261  age = self.extra
+000201a0: 6374 5f70 6167 6528 290a 2020 2020 2020  ct_page().      
+000201b0: 2020 0a20 2020 2020 2020 2069 6620 7365    .        if se
+000201c0: 6c66 2e74 6162 6c65 733a 0a20 2020 2020  lf.tables:.     
+000201d0: 2020 2020 2020 2074 6162 6c65 5f70 7265         table_pre
+000201e0: 6469 6374 696f 6e20 3d20 7365 6c66 2e67  diction = self.g
+000201f0: 6574 5f74 6162 6c65 735f 6672 6f6d 5f6d  et_tables_from_m
+00020200: 6f64 656c 2869 6d61 6765 5f70 6167 652c  odel(image_page,
+00020210: 206e 756d 5f63 6f6c 5f63 6c61 7373 6966   num_col_classif
+00020220: 6965 7229 0a20 2020 2020 2020 2065 6c73  ier).        els
+00020230: 653a 0a20 2020 2020 2020 2020 2020 2074  e:.            t
+00020240: 6162 6c65 5f70 7265 6469 6374 696f 6e20  able_prediction 
+00020250: 3d20 286e 702e 7a65 726f 7328 2869 6d61  = (np.zeros((ima
+00020260: 6765 5f70 6167 652e 7368 6170 655b 305d  ge_page.shape[0]
+00020270: 2c20 696d 6167 655f 7061 6765 2e73 6861  , image_page.sha
+00020280: 7065 5b31 5d29 2929 2e61 7374 7970 6528  pe[1]))).astype(
+00020290: 6e70 2e69 6e74 3136 290a 2020 2020 2020  np.int16).      
+000202a0: 2020 0a20 2020 2020 2020 2069 6620 7365    .        if se
+000202b0: 6c66 2e70 6c6f 7474 6572 3a0a 2020 2020  lf.plotter:.    
+000202c0: 2020 2020 2020 2020 7365 6c66 2e70 6c6f          self.plo
+000202d0: 7474 6572 2e73 6176 655f 7061 6765 5f69  tter.save_page_i
+000202e0: 6d61 6765 2869 6d61 6765 5f70 6167 6529  mage(image_page)
+000202f0: 0a0a 2020 2020 2020 2020 7465 7874 5f72  ..        text_r
+00020300: 6567 696f 6e73 5f70 5f31 203d 2074 6578  egions_p_1 = tex
+00020310: 745f 7265 6769 6f6e 735f 705f 315b 7061  t_regions_p_1[pa
+00020320: 6765 5f63 6f6f 7264 5b30 5d20 3a20 7061  ge_coord[0] : pa
+00020330: 6765 5f63 6f6f 7264 5b31 5d2c 2070 6167  ge_coord[1], pag
+00020340: 655f 636f 6f72 645b 325d 203a 2070 6167  e_coord[2] : pag
+00020350: 655f 636f 6f72 645b 335d 5d0a 2020 2020  e_coord[3]].    
+00020360: 2020 2020 6d61 736b 5f69 6d61 6765 7320      mask_images 
+00020370: 3d20 2874 6578 745f 7265 6769 6f6e 735f  = (text_regions_
+00020380: 705f 315b 3a2c 203a 5d20 3d3d 2032 2920  p_1[:, :] == 2) 
+00020390: 2a20 310a 2020 2020 2020 2020 6d61 736b  * 1.        mask
+000203a0: 5f69 6d61 6765 7320 3d20 6d61 736b 5f69  _images = mask_i
+000203b0: 6d61 6765 732e 6173 7479 7065 286e 702e  mages.astype(np.
+000203c0: 7569 6e74 3829 0a20 2020 2020 2020 206d  uint8).        m
+000203d0: 6173 6b5f 696d 6167 6573 203d 2063 7632  ask_images = cv2
+000203e0: 2e65 726f 6465 286d 6173 6b5f 696d 6167  .erode(mask_imag
+000203f0: 6573 5b3a 2c20 3a5d 2c20 4b45 524e 454c  es[:, :], KERNEL
+00020400: 2c20 6974 6572 6174 696f 6e73 3d31 3029  , iterations=10)
+00020410: 0a20 2020 2020 2020 206d 6173 6b5f 6c69  .        mask_li
+00020420: 6e65 7320 3d20 2874 6578 745f 7265 6769  nes = (text_regi
+00020430: 6f6e 735f 705f 315b 3a2c 203a 5d20 3d3d  ons_p_1[:, :] ==
+00020440: 2033 2920 2a20 310a 2020 2020 2020 2020   3) * 1.        
+00020450: 6d61 736b 5f6c 696e 6573 203d 206d 6173  mask_lines = mas
+00020460: 6b5f 6c69 6e65 732e 6173 7479 7065 286e  k_lines.astype(n
+00020470: 702e 7569 6e74 3829 0a20 2020 2020 2020  p.uint8).       
+00020480: 2069 6d67 5f6f 6e6c 795f 7265 6769 6f6e   img_only_region
+00020490: 735f 7769 7468 5f73 6570 203d 2028 2874  s_with_sep = ((t
+000204a0: 6578 745f 7265 6769 6f6e 735f 705f 315b  ext_regions_p_1[
+000204b0: 3a2c 203a 5d20 213d 2033 2920 2620 2874  :, :] != 3) & (t
+000204c0: 6578 745f 7265 6769 6f6e 735f 705f 315b  ext_regions_p_1[
+000204d0: 3a2c 203a 5d20 213d 2030 2929 202a 2031  :, :] != 0)) * 1
+000204e0: 0a20 2020 2020 2020 2069 6d67 5f6f 6e6c  .        img_onl
+000204f0: 795f 7265 6769 6f6e 735f 7769 7468 5f73  y_regions_with_s
+00020500: 6570 203d 2069 6d67 5f6f 6e6c 795f 7265  ep = img_only_re
+00020510: 6769 6f6e 735f 7769 7468 5f73 6570 2e61  gions_with_sep.a
+00020520: 7374 7970 6528 6e70 2e75 696e 7438 290a  stype(np.uint8).
+00020530: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00020540: 200a 2020 2020 2020 2020 6966 2065 726f   .        if ero
+00020550: 7369 6f6e 5f68 7572 7473 3a0a 2020 2020  sion_hurts:.    
+00020560: 2020 2020 2020 2020 696d 675f 6f6e 6c79          img_only
+00020570: 5f72 6567 696f 6e73 203d 206e 702e 636f  _regions = np.co
+00020580: 7079 2869 6d67 5f6f 6e6c 795f 7265 6769  py(img_only_regi
+00020590: 6f6e 735f 7769 7468 5f73 6570 5b3a 2c3a  ons_with_sep[:,:
+000205a0: 5d29 0a20 2020 2020 2020 2065 6c73 653a  ]).        else:
+000205b0: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
+000205c0: 5f6f 6e6c 795f 7265 6769 6f6e 7320 3d20  _only_regions = 
+000205d0: 6376 322e 6572 6f64 6528 696d 675f 6f6e  cv2.erode(img_on
+000205e0: 6c79 5f72 6567 696f 6e73 5f77 6974 685f  ly_regions_with_
+000205f0: 7365 705b 3a2c 3a5d 2c20 4b45 524e 454c  sep[:,:], KERNEL
+00020600: 2c20 6974 6572 6174 696f 6e73 3d36 290a  , iterations=6).
+00020610: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00020620: 2020 2020 200a 2020 2020 2020 2020 7472       .        tr
+00020630: 793a 0a20 2020 2020 2020 2020 2020 206e  y:.            n
+00020640: 756d 5f63 6f6c 2c20 5f20 3d20 6669 6e64  um_col, _ = find
+00020650: 5f6e 756d 5f63 6f6c 2869 6d67 5f6f 6e6c  _num_col(img_onl
+00020660: 795f 7265 6769 6f6e 732c 206e 756d 5f63  y_regions, num_c
+00020670: 6f6c 5f63 6c61 7373 6966 6965 722c 2073  ol_classifier, s
+00020680: 656c 662e 7461 626c 6573 2c20 6d75 6c74  elf.tables, mult
+00020690: 6970 6c69 6572 3d36 2e30 290a 2020 2020  iplier=6.0).    
+000206a0: 2020 2020 2020 2020 6e75 6d5f 636f 6c20          num_col 
+000206b0: 3d20 6e75 6d5f 636f 6c20 2b20 310a 2020  = num_col + 1.  
+000206c0: 2020 2020 2020 2020 2020 6966 206e 6f74            if not
+000206d0: 206e 756d 5f63 6f6c 756d 6e5f 6973 5f63   num_column_is_c
+000206e0: 6c61 7373 6966 6965 643a 0a20 2020 2020  lassified:.     
+000206f0: 2020 2020 2020 2020 2020 206e 756d 5f63             num_c
+00020700: 6f6c 5f63 6c61 7373 6966 6965 7220 3d20  ol_classifier = 
+00020710: 6e75 6d5f 636f 6c20 2b20 310a 2020 2020  num_col + 1.    
+00020720: 2020 2020 6578 6365 7074 2045 7863 6570      except Excep
+00020730: 7469 6f6e 2061 7320 7768 793a 0a20 2020  tion as why:.   
+00020740: 2020 2020 2020 2020 2073 656c 662e 6c6f           self.lo
+00020750: 6767 6572 2e65 7272 6f72 2877 6879 290a  gger.error(why).
+00020760: 2020 2020 2020 2020 2020 2020 6e75 6d5f              num_
+00020770: 636f 6c20 3d20 4e6f 6e65 0a20 2020 2020  col = None.     
+00020780: 2020 2072 6574 7572 6e20 6e75 6d5f 636f     return num_co
+00020790: 6c2c 206e 756d 5f63 6f6c 5f63 6c61 7373  l, num_col_class
+000207a0: 6966 6965 722c 2069 6d67 5f6f 6e6c 795f  ifier, img_only_
+000207b0: 7265 6769 6f6e 732c 2070 6167 655f 636f  regions, page_co
+000207c0: 6f72 642c 2069 6d61 6765 5f70 6167 652c  ord, image_page,
+000207d0: 206d 6173 6b5f 696d 6167 6573 2c20 6d61   mask_images, ma
+000207e0: 736b 5f6c 696e 6573 2c20 7465 7874 5f72  sk_lines, text_r
+000207f0: 6567 696f 6e73 5f70 5f31 2c20 636f 6e74  egions_p_1, cont
+00020800: 5f70 6167 652c 2074 6162 6c65 5f70 7265  _page, table_pre
+00020810: 6469 6374 696f 6e0a 0a20 2020 2064 6566  diction..    def
+00020820: 2072 756e 5f65 6e68 616e 6365 6d65 6e74   run_enhancement
+00020830: 2873 656c 662c 6c69 6768 745f 7665 7273  (self,light_vers
+00020840: 696f 6e29 3a0a 2020 2020 2020 2020 7365  ion):.        se
+00020850: 6c66 2e6c 6f67 6765 722e 696e 666f 2822  lf.logger.info("
+00020860: 5265 7369 7a69 6e67 2061 6e64 2065 6e68  Resizing and enh
+00020870: 616e 6369 6e67 2069 6d61 6765 2e2e 2e22  ancing image..."
+00020880: 290a 2020 2020 2020 2020 6973 5f69 6d61  ).        is_ima
+00020890: 6765 5f65 6e68 616e 6365 642c 2069 6d67  ge_enhanced, img
+000208a0: 5f6f 7267 2c20 696d 675f 7265 732c 206e  _org, img_res, n
+000208b0: 756d 5f63 6f6c 5f63 6c61 7373 6966 6965  um_col_classifie
+000208c0: 722c 206e 756d 5f63 6f6c 756d 6e5f 6973  r, num_column_is
+000208d0: 5f63 6c61 7373 6966 6965 642c 2069 6d67  _classified, img
+000208e0: 5f62 696e 203d 2073 656c 662e 7265 7369  _bin = self.resi
+000208f0: 7a65 5f61 6e64 5f65 6e68 616e 6365 5f69  ze_and_enhance_i
+00020900: 6d61 6765 5f77 6974 685f 636f 6c75 6d6e  mage_with_column
+00020910: 5f63 6c61 7373 6966 6965 7228 6c69 6768  _classifier(ligh
+00020920: 745f 7665 7273 696f 6e29 0a20 2020 2020  t_version).     
+00020930: 2020 2073 656c 662e 6c6f 6767 6572 2e69     self.logger.i
+00020940: 6e66 6f28 2249 6d61 6765 2077 6173 2025  nfo("Image was %
+00020950: 7365 6e68 616e 6365 642e 222c 2027 2720  senhanced.", '' 
+00020960: 6966 2069 735f 696d 6167 655f 656e 6861  if is_image_enha
+00020970: 6e63 6564 2065 6c73 6520 276e 6f74 2027  nced else 'not '
+00020980: 290a 0a20 2020 2020 2020 2073 6361 6c65  )..        scale
+00020990: 203d 2031 0a20 2020 2020 2020 2069 6620   = 1.        if 
+000209a0: 6973 5f69 6d61 6765 5f65 6e68 616e 6365  is_image_enhance
+000209b0: 643a 0a20 2020 2020 2020 2020 2020 2069  d:.            i
+000209c0: 6620 7365 6c66 2e61 6c6c 6f77 5f65 6e68  f self.allow_enh
+000209d0: 616e 6365 6d65 6e74 3a0a 2020 2020 2020  ancement:.      
+000209e0: 2020 2020 2020 2020 2020 696d 675f 7265            img_re
+000209f0: 7320 3d20 696d 675f 7265 732e 6173 7479  s = img_res.asty
+00020a00: 7065 286e 702e 7569 6e74 3829 0a20 2020  pe(np.uint8).   
+00020a10: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00020a20: 662e 6765 745f 696d 6167 655f 616e 645f  f.get_image_and_
+00020a30: 7363 616c 6573 2869 6d67 5f6f 7267 2c20  scales(img_org, 
+00020a40: 696d 675f 7265 732c 2073 6361 6c65 290a  img_res, scale).
+00020a50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00020a60: 6966 2073 656c 662e 706c 6f74 7465 723a  if self.plotter:
+00020a70: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020a80: 2020 2020 2073 656c 662e 706c 6f74 7465       self.plotte
+00020a90: 722e 7361 7665 5f65 6e68 616e 6365 645f  r.save_enhanced_
+00020aa0: 696d 6167 6528 696d 675f 7265 7329 0a20  image(img_res). 
+00020ab0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00020ac0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00020ad0: 2073 656c 662e 6765 745f 696d 6167 655f   self.get_image_
+00020ae0: 616e 645f 7363 616c 6573 5f61 6674 6572  and_scales_after
+00020af0: 5f65 6e68 616e 6369 6e67 2869 6d67 5f6f  _enhancing(img_o
+00020b00: 7267 2c20 696d 675f 7265 7329 0a20 2020  rg, img_res).   
+00020b10: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00020b20: 2020 2020 2020 2069 6620 7365 6c66 2e61         if self.a
+00020b30: 6c6c 6f77 5f65 6e68 616e 6365 6d65 6e74  llow_enhancement
+00020b40: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00020b50: 2020 7365 6c66 2e67 6574 5f69 6d61 6765    self.get_image
+00020b60: 5f61 6e64 5f73 6361 6c65 7328 696d 675f  _and_scales(img_
+00020b70: 6f72 672c 2069 6d67 5f72 6573 2c20 7363  org, img_res, sc
+00020b80: 616c 6529 0a20 2020 2020 2020 2020 2020  ale).           
+00020b90: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00020ba0: 2020 2020 2020 2073 656c 662e 6765 745f         self.get_
+00020bb0: 696d 6167 655f 616e 645f 7363 616c 6573  image_and_scales
+00020bc0: 2869 6d67 5f6f 7267 2c20 696d 675f 7265  (img_org, img_re
+00020bd0: 732c 2073 6361 6c65 290a 2020 2020 2020  s, scale).      
+00020be0: 2020 2020 2020 6966 2073 656c 662e 616c        if self.al
+00020bf0: 6c6f 775f 7363 616c 696e 673a 0a20 2020  low_scaling:.   
+00020c00: 2020 2020 2020 2020 2020 2020 2069 6d67               img
+00020c10: 5f6f 7267 2c20 696d 675f 7265 732c 2069  _org, img_res, i
+00020c20: 735f 696d 6167 655f 656e 6861 6e63 6564  s_image_enhanced
+00020c30: 203d 2073 656c 662e 7265 7369 7a65 5f69   = self.resize_i
+00020c40: 6d61 6765 5f77 6974 685f 636f 6c75 6d6e  mage_with_column
+00020c50: 5f63 6c61 7373 6966 6965 7228 6973 5f69  _classifier(is_i
+00020c60: 6d61 6765 5f65 6e68 616e 6365 642c 2069  mage_enhanced, i
+00020c70: 6d67 5f62 696e 290a 2020 2020 2020 2020  mg_bin).        
+00020c80: 2020 2020 2020 2020 7365 6c66 2e67 6574          self.get
+00020c90: 5f69 6d61 6765 5f61 6e64 5f73 6361 6c65  _image_and_scale
+00020ca0: 735f 6166 7465 725f 656e 6861 6e63 696e  s_after_enhancin
+00020cb0: 6728 696d 675f 6f72 672c 2069 6d67 5f72  g(img_org, img_r
+00020cc0: 6573 290a 2020 2020 2020 2020 7265 7475  es).        retu
+00020cd0: 726e 2069 6d67 5f72 6573 2c20 6973 5f69  rn img_res, is_i
+00020ce0: 6d61 6765 5f65 6e68 616e 6365 642c 206e  mage_enhanced, n
+00020cf0: 756d 5f63 6f6c 5f63 6c61 7373 6966 6965  um_col_classifie
+00020d00: 722c 206e 756d 5f63 6f6c 756d 6e5f 6973  r, num_column_is
+00020d10: 5f63 6c61 7373 6966 6965 640a 0a20 2020  _classified..   
+00020d20: 2064 6566 2072 756e 5f74 6578 746c 696e   def run_textlin
+00020d30: 6528 7365 6c66 2c20 696d 6167 655f 7061  e(self, image_pa
+00020d40: 6765 293a 0a20 2020 2020 2020 2073 6361  ge):.        sca
+00020d50: 6c65 725f 685f 7465 7874 6c69 6e65 203d  ler_h_textline =
+00020d60: 2031 2020 2320 312e 3223 312e 320a 2020   1  # 1.2#1.2.  
+00020d70: 2020 2020 2020 7363 616c 6572 5f77 5f74        scaler_w_t
+00020d80: 6578 746c 696e 6520 3d20 3120 2023 2030  extline = 1  # 0
+00020d90: 2e39 2331 0a20 2020 2020 2020 2074 6578  .9#1.        tex
+00020da0: 746c 696e 655f 6d61 736b 5f74 6f74 5f65  tline_mask_tot_e
+00020db0: 612c 205f 203d 2073 656c 662e 7465 7874  a, _ = self.text
+00020dc0: 6c69 6e65 5f63 6f6e 746f 7572 7328 696d  line_contours(im
+00020dd0: 6167 655f 7061 6765 2c20 5472 7565 2c20  age_page, True, 
+00020de0: 7363 616c 6572 5f68 5f74 6578 746c 696e  scaler_h_textlin
+00020df0: 652c 2073 6361 6c65 725f 775f 7465 7874  e, scaler_w_text
+00020e00: 6c69 6e65 290a 2020 2020 2020 2020 6966  line).        if
+00020e10: 2073 656c 662e 7465 7874 6c69 6e65 5f6c   self.textline_l
+00020e20: 6967 6874 3a0a 2020 2020 2020 2020 2020  ight:.          
+00020e30: 2020 7465 7874 6c69 6e65 5f6d 6173 6b5f    textline_mask_
+00020e40: 746f 745f 6561 203d 2074 6578 746c 696e  tot_ea = textlin
+00020e50: 655f 6d61 736b 5f74 6f74 5f65 612e 6173  e_mask_tot_ea.as
+00020e60: 7479 7065 286e 702e 696e 7431 3629 0a0a  type(np.int16)..
+00020e70: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00020e80: 706c 6f74 7465 723a 0a20 2020 2020 2020  plotter:.       
+00020e90: 2020 2020 2073 656c 662e 706c 6f74 7465       self.plotte
+00020ea0: 722e 7361 7665 5f70 6c6f 745f 6f66 5f74  r.save_plot_of_t
+00020eb0: 6578 746c 696e 6573 2874 6578 746c 696e  extlines(textlin
+00020ec0: 655f 6d61 736b 5f74 6f74 5f65 612c 2069  e_mask_tot_ea, i
+00020ed0: 6d61 6765 5f70 6167 6529 0a20 2020 2020  mage_page).     
+00020ee0: 2020 2072 6574 7572 6e20 7465 7874 6c69     return textli
+00020ef0: 6e65 5f6d 6173 6b5f 746f 745f 6561 0a0a  ne_mask_tot_ea..
+00020f00: 2020 2020 6465 6620 7275 6e5f 6465 736b      def run_desk
+00020f10: 6577 2873 656c 662c 2074 6578 746c 696e  ew(self, textlin
+00020f20: 655f 6d61 736b 5f74 6f74 5f65 6129 3a0a  e_mask_tot_ea):.
+00020f30: 2020 2020 2020 2020 7369 676d 6120 3d20          sigma = 
+00020f40: 320a 2020 2020 2020 2020 6d61 696e 5f70  2.        main_p
+00020f50: 6167 655f 6465 736b 6577 203d 2054 7275  age_deskew = Tru
+00020f60: 650a 2020 2020 2020 2020 736c 6f70 655f  e.        slope_
+00020f70: 6465 736b 6577 203d 2072 6574 7572 6e5f  deskew = return_
+00020f80: 6465 736b 6577 5f73 6c6f 7028 6376 322e  deskew_slop(cv2.
+00020f90: 6572 6f64 6528 7465 7874 6c69 6e65 5f6d  erode(textline_m
+00020fa0: 6173 6b5f 746f 745f 6561 2c20 4b45 524e  ask_tot_ea, KERN
+00020fb0: 454c 2c20 6974 6572 6174 696f 6e73 3d32  EL, iterations=2
+00020fc0: 292c 2073 6967 6d61 2c20 6d61 696e 5f70  ), sigma, main_p
+00020fd0: 6167 655f 6465 736b 6577 2c20 706c 6f74  age_deskew, plot
+00020fe0: 7465 723d 7365 6c66 2e70 6c6f 7474 6572  ter=self.plotter
+00020ff0: 290a 2020 2020 2020 2020 736c 6f70 655f  ).        slope_
+00021000: 6669 7273 7420 3d20 300a 0a20 2020 2020  first = 0..     
+00021010: 2020 2069 6620 7365 6c66 2e70 6c6f 7474     if self.plott
+00021020: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+00021030: 7365 6c66 2e70 6c6f 7474 6572 2e73 6176  self.plotter.sav
+00021040: 655f 6465 736b 6577 6564 5f69 6d61 6765  e_deskewed_image
+00021050: 2873 6c6f 7065 5f64 6573 6b65 7729 0a20  (slope_deskew). 
+00021060: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
+00021070: 6572 2e69 6e66 6f28 2273 6c6f 7065 5f64  er.info("slope_d
+00021080: 6573 6b65 773a 2025 2e32 66c2 b022 2c20  eskew: %.2f..", 
+00021090: 736c 6f70 655f 6465 736b 6577 290a 2020  slope_deskew).  
+000210a0: 2020 2020 2020 7265 7475 726e 2073 6c6f        return slo
+000210b0: 7065 5f64 6573 6b65 772c 2073 6c6f 7065  pe_deskew, slope
+000210c0: 5f66 6972 7374 0a0a 2020 2020 6465 6620  _first..    def 
+000210d0: 7275 6e5f 6d61 7267 696e 616c 7328 7365  run_marginals(se
+000210e0: 6c66 2c20 696d 6167 655f 7061 6765 2c20  lf, image_page, 
+000210f0: 7465 7874 6c69 6e65 5f6d 6173 6b5f 746f  textline_mask_to
+00021100: 745f 6561 2c20 6d61 736b 5f69 6d61 6765  t_ea, mask_image
+00021110: 732c 206d 6173 6b5f 6c69 6e65 732c 206e  s, mask_lines, n
+00021120: 756d 5f63 6f6c 5f63 6c61 7373 6966 6965  um_col_classifie
+00021130: 722c 2073 6c6f 7065 5f64 6573 6b65 772c  r, slope_deskew,
+00021140: 2074 6578 745f 7265 6769 6f6e 735f 705f   text_regions_p_
+00021150: 312c 2074 6162 6c65 5f70 7265 6469 6374  1, table_predict
+00021160: 696f 6e29 3a0a 2020 2020 2020 2020 696d  ion):.        im
+00021170: 6167 655f 7061 6765 5f72 6f74 6174 6564  age_page_rotated
+00021180: 2c20 7465 7874 6c69 6e65 5f6d 6173 6b5f  , textline_mask_
+00021190: 746f 7420 3d20 696d 6167 655f 7061 6765  tot = image_page
+000211a0: 5b3a 2c20 3a5d 2c20 7465 7874 6c69 6e65  [:, :], textline
+000211b0: 5f6d 6173 6b5f 746f 745f 6561 5b3a 2c20  _mask_tot_ea[:, 
+000211c0: 3a5d 0a20 2020 2020 2020 2074 6578 746c  :].        textl
+000211d0: 696e 655f 6d61 736b 5f74 6f74 5b6d 6173  ine_mask_tot[mas
+000211e0: 6b5f 696d 6167 6573 5b3a 2c20 3a5d 203d  k_images[:, :] =
+000211f0: 3d20 315d 203d 2030 0a0a 2020 2020 2020  = 1] = 0..      
+00021200: 2020 7465 7874 5f72 6567 696f 6e73 5f70    text_regions_p
+00021210: 5f31 5b6d 6173 6b5f 6c69 6e65 735b 3a2c  _1[mask_lines[:,
+00021220: 203a 5d20 3d3d 2031 5d20 3d20 330a 2020   :] == 1] = 3.  
+00021230: 2020 2020 2020 7465 7874 5f72 6567 696f        text_regio
+00021240: 6e73 5f70 203d 2074 6578 745f 7265 6769  ns_p = text_regi
+00021250: 6f6e 735f 705f 315b 3a2c 203a 5d0a 2020  ons_p_1[:, :].  
+00021260: 2020 2020 2020 7465 7874 5f72 6567 696f        text_regio
+00021270: 6e73 5f70 203d 206e 702e 6172 7261 7928  ns_p = np.array(
+00021280: 7465 7874 5f72 6567 696f 6e73 5f70 290a  text_regions_p).
+00021290: 0a20 2020 2020 2020 2069 6620 6e75 6d5f  .        if num_
+000212a0: 636f 6c5f 636c 6173 7369 6669 6572 2069  col_classifier i
+000212b0: 6e20 2831 2c20 3229 3a0a 2020 2020 2020  n (1, 2):.      
+000212c0: 2020 2020 2020 7472 793a 0a20 2020 2020        try:.     
+000212d0: 2020 2020 2020 2020 2020 2072 6567 696f             regio
+000212e0: 6e73 5f77 6974 686f 7574 5f73 6570 6172  ns_without_separ
+000212f0: 6174 6f72 7320 3d20 2874 6578 745f 7265  ators = (text_re
+00021300: 6769 6f6e 735f 705b 3a2c 203a 5d20 3d3d  gions_p[:, :] ==
+00021310: 2031 2920 2a20 310a 2020 2020 2020 2020   1) * 1.        
+00021320: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00021330: 7461 626c 6573 3a0a 2020 2020 2020 2020  tables:.        
+00021340: 2020 2020 2020 2020 2020 2020 7265 6769              regi
+00021350: 6f6e 735f 7769 7468 6f75 745f 7365 7061  ons_without_sepa
+00021360: 7261 746f 7273 5b74 6162 6c65 5f70 7265  rators[table_pre
+00021370: 6469 6374 696f 6e3d 3d31 5d20 3d20 310a  diction==1] = 1.
+00021380: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00021390: 7265 6769 6f6e 735f 7769 7468 6f75 745f  regions_without_
+000213a0: 7365 7061 7261 746f 7273 203d 2072 6567  separators = reg
+000213b0: 696f 6e73 5f77 6974 686f 7574 5f73 6570  ions_without_sep
+000213c0: 6172 6174 6f72 732e 6173 7479 7065 286e  arators.astype(n
+000213d0: 702e 7569 6e74 3829 0a20 2020 2020 2020  p.uint8).       
+000213e0: 2020 2020 2020 2020 2074 6578 745f 7265           text_re
+000213f0: 6769 6f6e 735f 7020 3d20 6765 745f 6d61  gions_p = get_ma
+00021400: 7267 696e 616c 7328 726f 7461 7465 5f69  rginals(rotate_i
+00021410: 6d61 6765 2872 6567 696f 6e73 5f77 6974  mage(regions_wit
+00021420: 686f 7574 5f73 6570 6172 6174 6f72 732c  hout_separators,
+00021430: 2073 6c6f 7065 5f64 6573 6b65 7729 2c20   slope_deskew), 
+00021440: 7465 7874 5f72 6567 696f 6e73 5f70 2c20  text_regions_p, 
+00021450: 6e75 6d5f 636f 6c5f 636c 6173 7369 6669  num_col_classifi
+00021460: 6572 2c20 736c 6f70 655f 6465 736b 6577  er, slope_deskew
+00021470: 2c20 6b65 726e 656c 3d4b 4552 4e45 4c29  , kernel=KERNEL)
+00021480: 0a20 2020 2020 2020 2020 2020 2065 7863  .            exc
+00021490: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+000214a0: 2065 3a0a 2020 2020 2020 2020 2020 2020   e:.            
+000214b0: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
+000214c0: 6572 726f 7228 2265 7863 6570 7469 6f6e  error("exception
+000214d0: 2025 7322 2c20 6529 0a0a 2020 2020 2020   %s", e)..      
+000214e0: 2020 6966 2073 656c 662e 706c 6f74 7465    if self.plotte
+000214f0: 723a 0a20 2020 2020 2020 2020 2020 2073  r:.            s
+00021500: 656c 662e 706c 6f74 7465 722e 7361 7665  elf.plotter.save
+00021510: 5f70 6c6f 745f 6f66 5f6c 6179 6f75 745f  _plot_of_layout_
+00021520: 6d61 696e 5f61 6c6c 2874 6578 745f 7265  main_all(text_re
+00021530: 6769 6f6e 735f 702c 2069 6d61 6765 5f70  gions_p, image_p
+00021540: 6167 6529 0a20 2020 2020 2020 2020 2020  age).           
+00021550: 2073 656c 662e 706c 6f74 7465 722e 7361   self.plotter.sa
+00021560: 7665 5f70 6c6f 745f 6f66 5f6c 6179 6f75  ve_plot_of_layou
+00021570: 745f 6d61 696e 2874 6578 745f 7265 6769  t_main(text_regi
+00021580: 6f6e 735f 702c 2069 6d61 6765 5f70 6167  ons_p, image_pag
+00021590: 6529 0a20 2020 2020 2020 2072 6574 7572  e).        retur
+000215a0: 6e20 7465 7874 6c69 6e65 5f6d 6173 6b5f  n textline_mask_
+000215b0: 746f 742c 2074 6578 745f 7265 6769 6f6e  tot, text_region
+000215c0: 735f 702c 2069 6d61 6765 5f70 6167 655f  s_p, image_page_
+000215d0: 726f 7461 7465 640a 0a20 2020 2064 6566  rotated..    def
+000215e0: 2072 756e 5f62 6f78 6573 5f6e 6f5f 6675   run_boxes_no_fu
+000215f0: 6c6c 5f6c 6179 6f75 7428 7365 6c66 2c20  ll_layout(self, 
+00021600: 696d 6167 655f 7061 6765 2c20 7465 7874  image_page, text
+00021610: 6c69 6e65 5f6d 6173 6b5f 746f 742c 2074  line_mask_tot, t
+00021620: 6578 745f 7265 6769 6f6e 735f 702c 2073  ext_regions_p, s
+00021630: 6c6f 7065 5f64 6573 6b65 772c 206e 756d  lope_deskew, num
+00021640: 5f63 6f6c 5f63 6c61 7373 6966 6965 722c  _col_classifier,
+00021650: 2074 6162 6c65 5f70 7265 6469 6374 696f   table_predictio
+00021660: 6e2c 2065 726f 7369 6f6e 5f68 7572 7473  n, erosion_hurts
+00021670: 293a 0a20 2020 2020 2020 2073 656c 662e  ):.        self.
+00021680: 6c6f 6767 6572 2e64 6562 7567 2827 656e  logger.debug('en
+00021690: 7465 7220 7275 6e5f 626f 7865 735f 6e6f  ter run_boxes_no
+000216a0: 5f66 756c 6c5f 6c61 796f 7574 2729 0a20  _full_layout'). 
+000216b0: 2020 2020 2020 2069 6620 6e70 2e61 6273         if np.abs
+000216c0: 2873 6c6f 7065 5f64 6573 6b65 7729 203e  (slope_deskew) >
+000216d0: 3d20 534c 4f50 455f 5448 5245 5348 4f4c  = SLOPE_THRESHOL
+000216e0: 443a 0a20 2020 2020 2020 2020 2020 205f  D:.            _
+000216f0: 2c20 7465 7874 6c69 6e65 5f6d 6173 6b5f  , textline_mask_
+00021700: 746f 745f 642c 2074 6578 745f 7265 6769  tot_d, text_regi
+00021710: 6f6e 735f 705f 315f 6e2c 2074 6162 6c65  ons_p_1_n, table
+00021720: 5f70 7265 6469 6374 696f 6e5f 6e20 3d20  _prediction_n = 
+00021730: 726f 7461 7469 6f6e 5f6e 6f74 5f39 305f  rotation_not_90_
+00021740: 6675 6e63 2869 6d61 6765 5f70 6167 652c  func(image_page,
+00021750: 2074 6578 746c 696e 655f 6d61 736b 5f74   textline_mask_t
+00021760: 6f74 2c20 7465 7874 5f72 6567 696f 6e73  ot, text_regions
+00021770: 5f70 2c20 7461 626c 655f 7072 6564 6963  _p, table_predic
+00021780: 7469 6f6e 2c20 736c 6f70 655f 6465 736b  tion, slope_desk
+00021790: 6577 290a 2020 2020 2020 2020 2020 2020  ew).            
+000217a0: 7465 7874 5f72 6567 696f 6e73 5f70 5f31  text_regions_p_1
+000217b0: 5f6e 203d 2072 6573 697a 655f 696d 6167  _n = resize_imag
+000217c0: 6528 7465 7874 5f72 6567 696f 6e73 5f70  e(text_regions_p
+000217d0: 5f31 5f6e 2c20 7465 7874 5f72 6567 696f  _1_n, text_regio
+000217e0: 6e73 5f70 2e73 6861 7065 5b30 5d2c 2074  ns_p.shape[0], t
+000217f0: 6578 745f 7265 6769 6f6e 735f 702e 7368  ext_regions_p.sh
+00021800: 6170 655b 315d 290a 2020 2020 2020 2020  ape[1]).        
+00021810: 2020 2020 7465 7874 6c69 6e65 5f6d 6173      textline_mas
+00021820: 6b5f 746f 745f 6420 3d20 7265 7369 7a65  k_tot_d = resize
+00021830: 5f69 6d61 6765 2874 6578 746c 696e 655f  _image(textline_
+00021840: 6d61 736b 5f74 6f74 5f64 2c20 7465 7874  mask_tot_d, text
+00021850: 5f72 6567 696f 6e73 5f70 2e73 6861 7065  _regions_p.shape
+00021860: 5b30 5d2c 2074 6578 745f 7265 6769 6f6e  [0], text_region
+00021870: 735f 702e 7368 6170 655b 315d 290a 2020  s_p.shape[1]).  
+00021880: 2020 2020 2020 2020 2020 7461 626c 655f            table_
+00021890: 7072 6564 6963 7469 6f6e 5f6e 203d 2072  prediction_n = r
+000218a0: 6573 697a 655f 696d 6167 6528 7461 626c  esize_image(tabl
+000218b0: 655f 7072 6564 6963 7469 6f6e 5f6e 2c20  e_prediction_n, 
+000218c0: 7465 7874 5f72 6567 696f 6e73 5f70 2e73  text_regions_p.s
+000218d0: 6861 7065 5b30 5d2c 2074 6578 745f 7265  hape[0], text_re
+000218e0: 6769 6f6e 735f 702e 7368 6170 655b 315d  gions_p.shape[1]
+000218f0: 290a 2020 2020 2020 2020 2020 2020 7265  ).            re
+00021900: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
+00021910: 7061 7261 746f 7273 5f64 203d 2028 7465  parators_d = (te
+00021920: 7874 5f72 6567 696f 6e73 5f70 5f31 5f6e  xt_regions_p_1_n
+00021930: 5b3a 2c20 3a5d 203d 3d20 3129 202a 2031  [:, :] == 1) * 1
+00021940: 0a20 2020 2020 2020 2020 2020 2069 6620  .            if 
+00021950: 7365 6c66 2e74 6162 6c65 733a 0a20 2020  self.tables:.   
+00021960: 2020 2020 2020 2020 2020 2020 2072 6567               reg
+00021970: 696f 6e73 5f77 6974 686f 7574 5f73 6570  ions_without_sep
+00021980: 6172 6174 6f72 735f 645b 7461 626c 655f  arators_d[table_
+00021990: 7072 6564 6963 7469 6f6e 5f6e 5b3a 2c3a  prediction_n[:,:
+000219a0: 5d20 3d3d 2031 5d20 3d20 310a 2020 2020  ] == 1] = 1.    
+000219b0: 2020 2020 7265 6769 6f6e 735f 7769 7468      regions_with
+000219c0: 6f75 745f 7365 7061 7261 746f 7273 203d  out_separators =
+000219d0: 2028 7465 7874 5f72 6567 696f 6e73 5f70   (text_regions_p
+000219e0: 5b3a 2c20 3a5d 203d 3d20 3129 202a 2031  [:, :] == 1) * 1
+000219f0: 2020 2320 2820 2874 6578 745f 7265 6769    # ( (text_regi
+00021a00: 6f6e 735f 705b 3a2c 3a5d 3d3d 3129 207c  ons_p[:,:]==1) |
+00021a10: 2028 7465 7874 5f72 6567 696f 6e73 5f70   (text_regions_p
+00021a20: 5b3a 2c3a 5d3d 3d32 2920 292a 3120 2373  [:,:]==2) )*1 #s
+00021a30: 656c 662e 7265 7475 726e 5f72 6567 696f  elf.return_regio
+00021a40: 6e73 5f77 6974 686f 7574 5f73 6570 6172  ns_without_separ
+00021a50: 6174 6f72 735f 6e65 7728 7465 7874 5f72  ators_new(text_r
+00021a60: 6567 696f 6e73 5f70 5b3a 2c3a 2c30 5d2c  egions_p[:,:,0],
+00021a70: 696d 675f 6f6e 6c79 5f72 6567 696f 6e73  img_only_regions
+00021a80: 290a 2020 2020 2020 2020 6966 2073 656c  ).        if sel
+00021a90: 662e 7461 626c 6573 3a0a 2020 2020 2020  f.tables:.      
+00021aa0: 2020 2020 2020 7265 6769 6f6e 735f 7769        regions_wi
+00021ab0: 7468 6f75 745f 7365 7061 7261 746f 7273  thout_separators
+00021ac0: 5b74 6162 6c65 5f70 7265 6469 6374 696f  [table_predictio
+00021ad0: 6e20 3d3d 3120 5d20 3d20 310a 2020 2020  n ==1 ] = 1.    
+00021ae0: 2020 2020 6966 206e 702e 6162 7328 736c      if np.abs(sl
+00021af0: 6f70 655f 6465 736b 6577 2920 3c20 534c  ope_deskew) < SL
+00021b00: 4f50 455f 5448 5245 5348 4f4c 443a 0a20  OPE_THRESHOLD:. 
+00021b10: 2020 2020 2020 2020 2020 2074 6578 745f             text_
+00021b20: 7265 6769 6f6e 735f 705f 315f 6e20 3d20  regions_p_1_n = 
+00021b30: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00021b40: 2074 6578 746c 696e 655f 6d61 736b 5f74   textline_mask_t
+00021b50: 6f74 5f64 203d 204e 6f6e 650a 2020 2020  ot_d = None.    
+00021b60: 2020 2020 2020 2020 7265 6769 6f6e 735f          regions_
+00021b70: 7769 7468 6f75 745f 7365 7061 7261 746f  without_separato
+00021b80: 7273 5f64 203d 204e 6f6e 650a 2020 2020  rs_d = None.    
+00021b90: 2020 2020 7069 7865 6c5f 6c69 6e65 7320      pixel_lines 
+00021ba0: 3d20 330a 2020 2020 2020 2020 6966 206e  = 3.        if n
+00021bb0: 702e 6162 7328 736c 6f70 655f 6465 736b  p.abs(slope_desk
+00021bc0: 6577 2920 3c20 534c 4f50 455f 5448 5245  ew) < SLOPE_THRE
+00021bd0: 5348 4f4c 443a 0a20 2020 2020 2020 2020  SHOLD:.         
+00021be0: 2020 205f 2c20 5f2c 206d 6174 7269 785f     _, _, matrix_
+00021bf0: 6f66 5f6c 696e 6573 5f63 682c 2073 706c  of_lines_ch, spl
+00021c00: 6974 7465 725f 795f 6e65 772c 205f 203d  itter_y_new, _ =
+00021c10: 2066 696e 645f 6e75 6d62 6572 5f6f 665f   find_number_of_
+00021c20: 636f 6c75 6d6e 735f 696e 5f64 6f63 756d  columns_in_docum
+00021c30: 656e 7428 6e70 2e72 6570 6561 7428 7465  ent(np.repeat(te
+00021c40: 7874 5f72 6567 696f 6e73 5f70 5b3a 2c20  xt_regions_p[:, 
+00021c50: 3a2c 206e 702e 6e65 7761 7869 735d 2c20  :, np.newaxis], 
+00021c60: 332c 2061 7869 733d 3229 2c20 6e75 6d5f  3, axis=2), num_
+00021c70: 636f 6c5f 636c 6173 7369 6669 6572 2c20  col_classifier, 
+00021c80: 7365 6c66 2e74 6162 6c65 732c 2070 6978  self.tables, pix
+00021c90: 656c 5f6c 696e 6573 290a 0a20 2020 2020  el_lines)..     
+00021ca0: 2020 2069 6620 6e70 2e61 6273 2873 6c6f     if np.abs(slo
+00021cb0: 7065 5f64 6573 6b65 7729 203e 3d20 534c  pe_deskew) >= SL
+00021cc0: 4f50 455f 5448 5245 5348 4f4c 443a 0a20  OPE_THRESHOLD:. 
+00021cd0: 2020 2020 2020 2020 2020 205f 2c20 5f2c             _, _,
+00021ce0: 206d 6174 7269 785f 6f66 5f6c 696e 6573   matrix_of_lines
+00021cf0: 5f63 685f 642c 2073 706c 6974 7465 725f  _ch_d, splitter_
+00021d00: 795f 6e65 775f 642c 205f 203d 2066 696e  y_new_d, _ = fin
+00021d10: 645f 6e75 6d62 6572 5f6f 665f 636f 6c75  d_number_of_colu
+00021d20: 6d6e 735f 696e 5f64 6f63 756d 656e 7428  mns_in_document(
+00021d30: 6e70 2e72 6570 6561 7428 7465 7874 5f72  np.repeat(text_r
+00021d40: 6567 696f 6e73 5f70 5f31 5f6e 5b3a 2c20  egions_p_1_n[:, 
+00021d50: 3a2c 206e 702e 6e65 7761 7869 735d 2c20  :, np.newaxis], 
+00021d60: 332c 2061 7869 733d 3229 2c20 6e75 6d5f  3, axis=2), num_
+00021d70: 636f 6c5f 636c 6173 7369 6669 6572 2c20  col_classifier, 
+00021d80: 7365 6c66 2e74 6162 6c65 732c 2070 6978  self.tables, pix
+00021d90: 656c 5f6c 696e 6573 290a 0a20 2020 2020  el_lines)..     
+00021da0: 2020 2073 656c 662e 6c6f 6767 6572 2e69     self.logger.i
+00021db0: 6e66 6f28 226e 756d 5f63 6f6c 5f63 6c61  nfo("num_col_cla
+00021dc0: 7373 6966 6965 723a 2025 7322 2c20 6e75  ssifier: %s", nu
+00021dd0: 6d5f 636f 6c5f 636c 6173 7369 6669 6572  m_col_classifier
+00021de0: 290a 0a20 2020 2020 2020 2069 6620 6e75  )..        if nu
+00021df0: 6d5f 636f 6c5f 636c 6173 7369 6669 6572  m_col_classifier
+00021e00: 203e 3d20 333a 0a20 2020 2020 2020 2020   >= 3:.         
+00021e10: 2020 2069 6620 6e70 2e61 6273 2873 6c6f     if np.abs(slo
+00021e20: 7065 5f64 6573 6b65 7729 203c 2053 4c4f  pe_deskew) < SLO
+00021e30: 5045 5f54 4852 4553 484f 4c44 3a0a 2020  PE_THRESHOLD:.  
+00021e40: 2020 2020 2020 2020 2020 2020 2020 7265                re
+00021e50: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
+00021e60: 7061 7261 746f 7273 203d 2072 6567 696f  parators = regio
+00021e70: 6e73 5f77 6974 686f 7574 5f73 6570 6172  ns_without_separ
+00021e80: 6174 6f72 732e 6173 7479 7065 286e 702e  ators.astype(np.
+00021e90: 7569 6e74 3829 0a20 2020 2020 2020 2020  uint8).         
+00021ea0: 2020 2020 2020 2072 6567 696f 6e73 5f77         regions_w
+00021eb0: 6974 686f 7574 5f73 6570 6172 6174 6f72  ithout_separator
+00021ec0: 7320 3d20 6376 322e 6572 6f64 6528 7265  s = cv2.erode(re
+00021ed0: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
+00021ee0: 7061 7261 746f 7273 5b3a 2c20 3a5d 2c20  parators[:, :], 
+00021ef0: 4b45 524e 454c 2c20 6974 6572 6174 696f  KERNEL, iteratio
+00021f00: 6e73 3d36 290a 2020 2020 2020 2020 2020  ns=6).          
+00021f10: 2020 656c 7365 3a0a 2020 2020 2020 2020    else:.        
+00021f20: 2020 2020 2020 2020 7265 6769 6f6e 735f          regions_
+00021f30: 7769 7468 6f75 745f 7365 7061 7261 746f  without_separato
+00021f40: 7273 5f64 203d 2072 6567 696f 6e73 5f77  rs_d = regions_w
+00021f50: 6974 686f 7574 5f73 6570 6172 6174 6f72  ithout_separator
+00021f60: 735f 642e 6173 7479 7065 286e 702e 7569  s_d.astype(np.ui
+00021f70: 6e74 3829 0a20 2020 2020 2020 2020 2020  nt8).           
+00021f80: 2020 2020 2072 6567 696f 6e73 5f77 6974       regions_wit
+00021f90: 686f 7574 5f73 6570 6172 6174 6f72 735f  hout_separators_
+00021fa0: 6420 3d20 6376 322e 6572 6f64 6528 7265  d = cv2.erode(re
+00021fb0: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
+00021fc0: 7061 7261 746f 7273 5f64 5b3a 2c20 3a5d  parators_d[:, :]
+00021fd0: 2c20 4b45 524e 454c 2c20 6974 6572 6174  , KERNEL, iterat
+00021fe0: 696f 6e73 3d36 290a 2020 2020 2020 2020  ions=6).        
+00021ff0: 7431 203d 2074 696d 652e 7469 6d65 2829  t1 = time.time()
+00022000: 0a20 2020 2020 2020 2069 6620 6e70 2e61  .        if np.a
+00022010: 6273 2873 6c6f 7065 5f64 6573 6b65 7729  bs(slope_deskew)
+00022020: 203c 2053 4c4f 5045 5f54 4852 4553 484f   < SLOPE_THRESHO
+00022030: 4c44 3a0a 2020 2020 2020 2020 2020 2020  LD:.            
+00022040: 626f 7865 732c 2070 6561 6b73 5f6e 6567  boxes, peaks_neg
+00022050: 5f74 6f74 5f74 6162 6c65 7320 3d20 7265  _tot_tables = re
+00022060: 7475 726e 5f62 6f78 6573 5f6f 665f 696d  turn_boxes_of_im
+00022070: 6167 6573 5f62 795f 6f72 6465 725f 6f66  ages_by_order_of
+00022080: 5f72 6561 6469 6e67 5f6e 6577 2873 706c  _reading_new(spl
+00022090: 6974 7465 725f 795f 6e65 772c 2072 6567  itter_y_new, reg
+000220a0: 696f 6e73 5f77 6974 686f 7574 5f73 6570  ions_without_sep
+000220b0: 6172 6174 6f72 732c 206d 6174 7269 785f  arators, matrix_
+000220c0: 6f66 5f6c 696e 6573 5f63 682c 206e 756d  of_lines_ch, num
+000220d0: 5f63 6f6c 5f63 6c61 7373 6966 6965 722c  _col_classifier,
+000220e0: 2065 726f 7369 6f6e 5f68 7572 7473 2c20   erosion_hurts, 
+000220f0: 7365 6c66 2e74 6162 6c65 7329 0a20 2020  self.tables).   
+00022100: 2020 2020 2020 2020 2062 6f78 6573 5f64           boxes_d
+00022110: 203d 204e 6f6e 650a 2020 2020 2020 2020   = None.        
+00022120: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
+00022130: 6465 6275 6728 226c 656e 2862 6f78 6573  debug("len(boxes
+00022140: 293a 2025 7322 2c20 6c65 6e28 626f 7865  ): %s", len(boxe
+00022150: 7329 290a 2020 2020 2020 2020 2020 2020  s)).            
+00022160: 0a20 2020 2020 2020 2020 2020 2074 6578  .            tex
+00022170: 745f 7265 6769 6f6e 735f 705f 7461 626c  t_regions_p_tabl
+00022180: 6573 203d 206e 702e 636f 7079 2874 6578  es = np.copy(tex
+00022190: 745f 7265 6769 6f6e 735f 7029 0a20 2020  t_regions_p).   
+000221a0: 2020 2020 2020 2020 2074 6578 745f 7265           text_re
+000221b0: 6769 6f6e 735f 705f 7461 626c 6573 5b3a  gions_p_tables[:
+000221c0: 2c3a 5d5b 2874 6162 6c65 5f70 7265 6469  ,:][(table_predi
+000221d0: 6374 696f 6e5b 3a2c 3a5d 203d 3d20 3129  ction[:,:] == 1)
+000221e0: 5d20 3d20 3130 0a20 2020 2020 2020 2020  ] = 10.         
+000221f0: 2020 2070 6978 656c 5f6c 696e 6520 3d20     pixel_line = 
+00022200: 330a 2020 2020 2020 2020 2020 2020 696d  3.            im
+00022210: 675f 7265 7669 7365 645f 7461 6232 203d  g_revised_tab2 =
+00022220: 2073 656c 662e 6164 645f 7461 626c 6573   self.add_tables
+00022230: 5f68 6575 7269 7374 6963 5f74 6f5f 6c61  _heuristic_to_la
+00022240: 796f 7574 2874 6578 745f 7265 6769 6f6e  yout(text_region
+00022250: 735f 705f 7461 626c 6573 2c20 626f 7865  s_p_tables, boxe
+00022260: 732c 2030 2c20 7370 6c69 7474 6572 5f79  s, 0, splitter_y
+00022270: 5f6e 6577 2c20 7065 616b 735f 6e65 675f  _new, peaks_neg_
+00022280: 746f 745f 7461 626c 6573 2c20 7465 7874  tot_tables, text
+00022290: 5f72 6567 696f 6e73 5f70 5f74 6162 6c65  _regions_p_table
+000222a0: 7320 2c20 6e75 6d5f 636f 6c5f 636c 6173  s , num_col_clas
+000222b0: 7369 6669 6572 202c 2030 2e30 3030 3030  sifier , 0.00000
+000222c0: 352c 2070 6978 656c 5f6c 696e 6529 0a20  5, pixel_line). 
+000222d0: 2020 2020 2020 2020 2020 2069 6d67 5f72             img_r
+000222e0: 6576 6973 6564 5f74 6162 322c 2063 6f6e  evised_tab2, con
+000222f0: 746f 7572 6573 5f74 6162 6c65 7320 3d20  toures_tables = 
+00022300: 7365 6c66 2e63 6865 636b 5f69 6f75 5f6f  self.check_iou_o
+00022310: 665f 626f 756e 6469 6e67 5f62 6f78 5f61  f_bounding_box_a
+00022320: 6e64 5f63 6f6e 746f 7572 5f66 6f72 5f74  nd_contour_for_t
+00022330: 6162 6c65 7328 696d 675f 7265 7669 7365  ables(img_revise
+00022340: 645f 7461 6232 2c74 6162 6c65 5f70 7265  d_tab2,table_pre
+00022350: 6469 6374 696f 6e2c 2031 302c 206e 756d  diction, 10, num
+00022360: 5f63 6f6c 5f63 6c61 7373 6966 6965 7229  _col_classifier)
+00022370: 0a20 2020 2020 2020 2065 6c73 653a 0a20  .        else:. 
+00022380: 2020 2020 2020 2020 2020 2062 6f78 6573             boxes
+00022390: 5f64 2c20 7065 616b 735f 6e65 675f 746f  _d, peaks_neg_to
+000223a0: 745f 7461 626c 6573 5f64 203d 2072 6574  t_tables_d = ret
+000223b0: 7572 6e5f 626f 7865 735f 6f66 5f69 6d61  urn_boxes_of_ima
+000223c0: 6765 735f 6279 5f6f 7264 6572 5f6f 665f  ges_by_order_of_
+000223d0: 7265 6164 696e 675f 6e65 7728 7370 6c69  reading_new(spli
+000223e0: 7474 6572 5f79 5f6e 6577 5f64 2c20 7265  tter_y_new_d, re
+000223f0: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
+00022400: 7061 7261 746f 7273 5f64 2c20 6d61 7472  parators_d, matr
+00022410: 6978 5f6f 665f 6c69 6e65 735f 6368 5f64  ix_of_lines_ch_d
+00022420: 2c20 6e75 6d5f 636f 6c5f 636c 6173 7369  , num_col_classi
+00022430: 6669 6572 2c20 6572 6f73 696f 6e5f 6875  fier, erosion_hu
+00022440: 7274 732c 2073 656c 662e 7461 626c 6573  rts, self.tables
+00022450: 290a 2020 2020 2020 2020 2020 2020 626f  ).            bo
+00022460: 7865 7320 3d20 4e6f 6e65 0a20 2020 2020  xes = None.     
+00022470: 2020 2020 2020 2073 656c 662e 6c6f 6767         self.logg
+00022480: 6572 2e64 6562 7567 2822 6c65 6e28 626f  er.debug("len(bo
+00022490: 7865 7329 3a20 2573 222c 206c 656e 2862  xes): %s", len(b
+000224a0: 6f78 6573 5f64 2929 0a20 2020 2020 2020  oxes_d)).       
+000224b0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+000224c0: 2020 7465 7874 5f72 6567 696f 6e73 5f70    text_regions_p
+000224d0: 5f74 6162 6c65 7320 3d20 6e70 2e63 6f70  _tables = np.cop
+000224e0: 7928 7465 7874 5f72 6567 696f 6e73 5f70  y(text_regions_p
+000224f0: 5f31 5f6e 290a 2020 2020 2020 2020 2020  _1_n).          
+00022500: 2020 7465 7874 5f72 6567 696f 6e73 5f70    text_regions_p
+00022510: 5f74 6162 6c65 7320 3d6e 702e 726f 756e  _tables =np.roun
+00022520: 6428 7465 7874 5f72 6567 696f 6e73 5f70  d(text_regions_p
+00022530: 5f74 6162 6c65 7329 0a20 2020 2020 2020  _tables).       
+00022540: 2020 2020 2074 6578 745f 7265 6769 6f6e       text_region
+00022550: 735f 705f 7461 626c 6573 5b3a 2c3a 5d5b  s_p_tables[:,:][
+00022560: 2874 6578 745f 7265 6769 6f6e 735f 705f  (text_regions_p_
+00022570: 7461 626c 6573 5b3a 2c3a 5d20 213d 2033  tables[:,:] != 3
+00022580: 2920 2620 2874 6162 6c65 5f70 7265 6469  ) & (table_predi
+00022590: 6374 696f 6e5f 6e5b 3a2c 3a5d 203d 3d20  ction_n[:,:] == 
+000225a0: 3129 5d20 3d20 3130 0a20 2020 2020 2020  1)] = 10.       
+000225b0: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+000225c0: 2020 7069 7865 6c5f 6c69 6e65 203d 2033    pixel_line = 3
+000225d0: 0a20 2020 2020 2020 2020 2020 2069 6d67  .            img
+000225e0: 5f72 6576 6973 6564 5f74 6162 3220 3d20  _revised_tab2 = 
+000225f0: 7365 6c66 2e61 6464 5f74 6162 6c65 735f  self.add_tables_
+00022600: 6865 7572 6973 7469 635f 746f 5f6c 6179  heuristic_to_lay
+00022610: 6f75 7428 7465 7874 5f72 6567 696f 6e73  out(text_regions
+00022620: 5f70 5f74 6162 6c65 732c 626f 7865 735f  _p_tables,boxes_
+00022630: 642c 302c 7370 6c69 7474 6572 5f79 5f6e  d,0,splitter_y_n
+00022640: 6577 5f64 2c70 6561 6b73 5f6e 6567 5f74  ew_d,peaks_neg_t
+00022650: 6f74 5f74 6162 6c65 735f 642c 7465 7874  ot_tables_d,text
+00022660: 5f72 6567 696f 6e73 5f70 5f74 6162 6c65  _regions_p_table
+00022670: 732c 206e 756d 5f63 6f6c 5f63 6c61 7373  s, num_col_class
+00022680: 6966 6965 722c 2030 2e30 3030 3030 352c  ifier, 0.000005,
+00022690: 2070 6978 656c 5f6c 696e 6529 0a20 2020   pixel_line).   
+000226a0: 2020 2020 2020 2020 2069 6d67 5f72 6576           img_rev
+000226b0: 6973 6564 5f74 6162 325f 642c 5f20 3d20  ised_tab2_d,_ = 
+000226c0: 7365 6c66 2e63 6865 636b 5f69 6f75 5f6f  self.check_iou_o
+000226d0: 665f 626f 756e 6469 6e67 5f62 6f78 5f61  f_bounding_box_a
+000226e0: 6e64 5f63 6f6e 746f 7572 5f66 6f72 5f74  nd_contour_for_t
+000226f0: 6162 6c65 7328 696d 675f 7265 7669 7365  ables(img_revise
+00022700: 645f 7461 6232 2c74 6162 6c65 5f70 7265  d_tab2,table_pre
+00022710: 6469 6374 696f 6e5f 6e2c 2031 302c 206e  diction_n, 10, n
+00022720: 756d 5f63 6f6c 5f63 6c61 7373 6966 6965  um_col_classifie
+00022730: 7229 0a20 2020 2020 2020 2020 2020 200a  r).            .
+00022740: 2020 2020 2020 2020 2020 2020 696d 675f              img_
+00022750: 7265 7669 7365 645f 7461 6232 5f64 5f72  revised_tab2_d_r
+00022760: 6f74 6174 6564 203d 2072 6f74 6174 655f  otated = rotate_
+00022770: 696d 6167 6528 696d 675f 7265 7669 7365  image(img_revise
+00022780: 645f 7461 6232 5f64 2c20 2d73 6c6f 7065  d_tab2_d, -slope
+00022790: 5f64 6573 6b65 7729 0a20 2020 2020 2020  _deskew).       
+000227a0: 2020 2020 2069 6d67 5f72 6576 6973 6564       img_revised
+000227b0: 5f74 6162 325f 645f 726f 7461 7465 6420  _tab2_d_rotated 
+000227c0: 3d20 6e70 2e72 6f75 6e64 2869 6d67 5f72  = np.round(img_r
+000227d0: 6576 6973 6564 5f74 6162 325f 645f 726f  evised_tab2_d_ro
+000227e0: 7461 7465 6429 0a20 2020 2020 2020 2020  tated).         
+000227f0: 2020 2069 6d67 5f72 6576 6973 6564 5f74     img_revised_t
+00022800: 6162 325f 645f 726f 7461 7465 6420 3d20  ab2_d_rotated = 
+00022810: 696d 675f 7265 7669 7365 645f 7461 6232  img_revised_tab2
+00022820: 5f64 5f72 6f74 6174 6564 2e61 7374 7970  _d_rotated.astyp
+00022830: 6528 6e70 2e69 6e74 3829 0a20 2020 2020  e(np.int8).     
+00022840: 2020 2020 2020 2069 6d67 5f72 6576 6973         img_revis
+00022850: 6564 5f74 6162 325f 645f 726f 7461 7465  ed_tab2_d_rotate
+00022860: 6420 3d20 7265 7369 7a65 5f69 6d61 6765  d = resize_image
+00022870: 2869 6d67 5f72 6576 6973 6564 5f74 6162  (img_revised_tab
+00022880: 325f 645f 726f 7461 7465 642c 2074 6578  2_d_rotated, tex
+00022890: 745f 7265 6769 6f6e 735f 702e 7368 6170  t_regions_p.shap
+000228a0: 655b 305d 2c20 7465 7874 5f72 6567 696f  e[0], text_regio
+000228b0: 6e73 5f70 2e73 6861 7065 5b31 5d29 0a0a  ns_p.shape[1])..
+000228c0: 2020 2020 2020 2020 7365 6c66 2e6c 6f67          self.log
+000228d0: 6765 722e 696e 666f 2822 6465 7465 6374  ger.info("detect
+000228e0: 696e 6720 626f 7865 7320 746f 6f6b 2025  ing boxes took %
+000228f0: 2e31 6673 222c 2074 696d 652e 7469 6d65  .1fs", time.time
+00022900: 2829 202d 2074 3129 0a20 2020 2020 2020  () - t1).       
+00022910: 200a 2020 2020 2020 2020 6966 2073 656c   .        if sel
+00022920: 662e 7461 626c 6573 3a0a 2020 2020 2020  f.tables:.      
+00022930: 2020 2020 2020 6966 206e 702e 6162 7328        if np.abs(
+00022940: 736c 6f70 655f 6465 736b 6577 2920 3c20  slope_deskew) < 
+00022950: 534c 4f50 455f 5448 5245 5348 4f4c 443a  SLOPE_THRESHOLD:
+00022960: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022970: 2069 6d67 5f72 6576 6973 6564 5f74 6162   img_revised_tab
+00022980: 203d 206e 702e 636f 7079 2869 6d67 5f72   = np.copy(img_r
+00022990: 6576 6973 6564 5f74 6162 325b 3a2c 3a2c  evised_tab2[:,:,
+000229a0: 305d 290a 2020 2020 2020 2020 2020 2020  0]).            
+000229b0: 2020 2020 696d 675f 7265 7669 7365 645f      img_revised_
+000229c0: 7461 625b 3a2c 3a5d 5b28 7465 7874 5f72  tab[:,:][(text_r
+000229d0: 6567 696f 6e73 5f70 5b3a 2c3a 5d20 3d3d  egions_p[:,:] ==
+000229e0: 2031 2920 2620 2869 6d67 5f72 6576 6973   1) & (img_revis
+000229f0: 6564 5f74 6162 5b3a 2c3a 5d20 213d 2031  ed_tab[:,:] != 1
+00022a00: 3029 5d20 3d20 310a 2020 2020 2020 2020  0)] = 1.        
+00022a10: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00022a20: 2020 2020 2020 2020 2020 696d 675f 7265            img_re
+00022a30: 7669 7365 645f 7461 6220 3d20 6e70 2e63  vised_tab = np.c
+00022a40: 6f70 7928 7465 7874 5f72 6567 696f 6e73  opy(text_regions
+00022a50: 5f70 5b3a 2c3a 5d29 0a20 2020 2020 2020  _p[:,:]).       
+00022a60: 2020 2020 2020 2020 2069 6d67 5f72 6576           img_rev
+00022a70: 6973 6564 5f74 6162 5b3a 2c3a 5d5b 696d  ised_tab[:,:][im
+00022a80: 675f 7265 7669 7365 645f 7461 625b 3a2c  g_revised_tab[:,
+00022a90: 3a5d 203d 3d20 3130 5d20 3d20 300a 2020  :] == 10] = 0.  
+00022aa0: 2020 2020 2020 2020 2020 2020 2020 696d                im
+00022ab0: 675f 7265 7669 7365 645f 7461 625b 3a2c  g_revised_tab[:,
+00022ac0: 3a5d 5b69 6d67 5f72 6576 6973 6564 5f74  :][img_revised_t
+00022ad0: 6162 325f 645f 726f 7461 7465 645b 3a2c  ab2_d_rotated[:,
+00022ae0: 3a2c 305d 203d 3d20 3130 5d20 3d20 3130  :,0] == 10] = 10
+00022af0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00022b00: 200a 2020 2020 2020 2020 2020 2020 7465   .            te
+00022b10: 7874 5f72 6567 696f 6e73 5f70 5b3a 2c3a  xt_regions_p[:,:
+00022b20: 5d5b 7465 7874 5f72 6567 696f 6e73 5f70  ][text_regions_p
+00022b30: 5b3a 2c3a 5d3d 3d31 305d 203d 2030 0a20  [:,:]==10] = 0. 
+00022b40: 2020 2020 2020 2020 2020 2074 6578 745f             text_
+00022b50: 7265 6769 6f6e 735f 705b 3a2c 3a5d 5b69  regions_p[:,:][i
+00022b60: 6d67 5f72 6576 6973 6564 5f74 6162 5b3a  mg_revised_tab[:
+00022b70: 2c3a 5d3d 3d31 305d 203d 2031 300a 2020  ,:]==10] = 10.  
+00022b80: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00022b90: 2020 2020 2020 2020 696d 675f 7265 7669          img_revi
+00022ba0: 7365 645f 7461 623d 7465 7874 5f72 6567  sed_tab=text_reg
+00022bb0: 696f 6e73 5f70 5b3a 2c3a 5d0a 2020 2020  ions_p[:,:].    
+00022bc0: 2020 2020 2369 6d67 5f72 6576 6973 6564      #img_revised
+00022bd0: 5f74 6162 203d 2074 6578 745f 7265 6769  _tab = text_regi
+00022be0: 6f6e 735f 705b 3a2c 203a 5d0a 2020 2020  ons_p[:, :].    
+00022bf0: 2020 2020 706f 6c79 676f 6e73 5f6f 665f      polygons_of_
+00022c00: 696d 6167 6573 203d 2072 6574 7572 6e5f  images = return_
+00022c10: 636f 6e74 6f75 7273 5f6f 665f 696e 7465  contours_of_inte
+00022c20: 7265 7374 6564 5f72 6567 696f 6e28 696d  rested_region(im
+00022c30: 675f 7265 7669 7365 645f 7461 622c 2032  g_revised_tab, 2
+00022c40: 290a 0a20 2020 2020 2020 2070 6978 656c  )..        pixel
+00022c50: 5f69 6d67 203d 2034 0a20 2020 2020 2020  _img = 4.       
+00022c60: 206d 696e 5f61 7265 615f 6d61 7220 3d20   min_area_mar = 
+00022c70: 302e 3030 3030 310a 2020 2020 2020 2020  0.00001.        
+00022c80: 706f 6c79 676f 6e73 5f6f 665f 6d61 7267  polygons_of_marg
+00022c90: 696e 616c 7320 3d20 7265 7475 726e 5f63  inals = return_c
+00022ca0: 6f6e 746f 7572 735f 6f66 5f69 6e74 6572  ontours_of_inter
+00022cb0: 6573 7465 645f 7265 6769 6f6e 2874 6578  ested_region(tex
+00022cc0: 745f 7265 6769 6f6e 735f 702c 2070 6978  t_regions_p, pix
+00022cd0: 656c 5f69 6d67 2c20 6d69 6e5f 6172 6561  el_img, min_area
+00022ce0: 5f6d 6172 290a 2020 2020 2020 2020 0a20  _mar).        . 
+00022cf0: 2020 2020 2020 2070 6978 656c 5f69 6d67         pixel_img
+00022d00: 203d 2031 300a 2020 2020 2020 2020 636f   = 10.        co
+00022d10: 6e74 6f75 7273 5f74 6162 6c65 7320 3d20  ntours_tables = 
+00022d20: 7265 7475 726e 5f63 6f6e 746f 7572 735f  return_contours_
+00022d30: 6f66 5f69 6e74 6572 6573 7465 645f 7265  of_interested_re
+00022d40: 6769 6f6e 2874 6578 745f 7265 6769 6f6e  gion(text_region
+00022d50: 735f 702c 2070 6978 656c 5f69 6d67 2c20  s_p, pixel_img, 
+00022d60: 6d69 6e5f 6172 6561 5f6d 6172 290a 2020  min_area_mar).  
+00022d70: 2020 2020 2020 0a20 2020 2020 2020 2073        .        s
+00022d80: 656c 662e 6c6f 6767 6572 2e64 6562 7567  elf.logger.debug
+00022d90: 2827 6578 6974 2072 756e 5f62 6f78 6573  ('exit run_boxes
+00022da0: 5f6e 6f5f 6675 6c6c 5f6c 6179 6f75 7427  _no_full_layout'
+00022db0: 290a 2020 2020 2020 2020 7265 7475 726e  ).        return
+00022dc0: 2070 6f6c 7967 6f6e 735f 6f66 5f69 6d61   polygons_of_ima
+00022dd0: 6765 732c 2069 6d67 5f72 6576 6973 6564  ges, img_revised
+00022de0: 5f74 6162 2c20 7465 7874 5f72 6567 696f  _tab, text_regio
+00022df0: 6e73 5f70 5f31 5f6e 2c20 7465 7874 6c69  ns_p_1_n, textli
+00022e00: 6e65 5f6d 6173 6b5f 746f 745f 642c 2072  ne_mask_tot_d, r
+00022e10: 6567 696f 6e73 5f77 6974 686f 7574 5f73  egions_without_s
+00022e20: 6570 6172 6174 6f72 735f 642c 2062 6f78  eparators_d, box
+00022e30: 6573 2c20 626f 7865 735f 642c 2070 6f6c  es, boxes_d, pol
+00022e40: 7967 6f6e 735f 6f66 5f6d 6172 6769 6e61  ygons_of_margina
+00022e50: 6c73 2c20 636f 6e74 6f75 7273 5f74 6162  ls, contours_tab
+00022e60: 6c65 730a 0a20 2020 2064 6566 2072 756e  les..    def run
+00022e70: 5f62 6f78 6573 5f66 756c 6c5f 6c61 796f  _boxes_full_layo
+00022e80: 7574 2873 656c 662c 2069 6d61 6765 5f70  ut(self, image_p
+00022e90: 6167 652c 2074 6578 746c 696e 655f 6d61  age, textline_ma
+00022ea0: 736b 5f74 6f74 2c20 7465 7874 5f72 6567  sk_tot, text_reg
+00022eb0: 696f 6e73 5f70 2c20 736c 6f70 655f 6465  ions_p, slope_de
+00022ec0: 736b 6577 2c20 6e75 6d5f 636f 6c5f 636c  skew, num_col_cl
+00022ed0: 6173 7369 6669 6572 2c20 696d 675f 6f6e  assifier, img_on
+00022ee0: 6c79 5f72 6567 696f 6e73 2c20 7461 626c  ly_regions, tabl
+00022ef0: 655f 7072 6564 6963 7469 6f6e 2c20 6572  e_prediction, er
+00022f00: 6f73 696f 6e5f 6875 7274 7329 3a0a 2020  osion_hurts):.  
+00022f10: 2020 2020 2020 7365 6c66 2e6c 6f67 6765        self.logge
+00022f20: 722e 6465 6275 6728 2765 6e74 6572 2072  r.debug('enter r
+00022f30: 756e 5f62 6f78 6573 5f66 756c 6c5f 6c61  un_boxes_full_la
+00022f40: 796f 7574 2729 0a20 2020 2020 2020 200a  yout').        .
+00022f50: 2020 2020 2020 2020 6966 2073 656c 662e          if self.
+00022f60: 7461 626c 6573 3a0a 2020 2020 2020 2020  tables:.        
+00022f70: 2020 2020 6966 206e 702e 6162 7328 736c      if np.abs(sl
+00022f80: 6f70 655f 6465 736b 6577 2920 3e3d 2053  ope_deskew) >= S
+00022f90: 4c4f 5045 5f54 4852 4553 484f 4c44 3a0a  LOPE_THRESHOLD:.
+00022fa0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00022fb0: 696d 6167 655f 7061 6765 5f72 6f74 6174  image_page_rotat
+00022fc0: 6564 5f6e 2c74 6578 746c 696e 655f 6d61  ed_n,textline_ma
+00022fd0: 736b 5f74 6f74 5f64 2c74 6578 745f 7265  sk_tot_d,text_re
+00022fe0: 6769 6f6e 735f 705f 315f 6e20 2c20 7461  gions_p_1_n , ta
+00022ff0: 626c 655f 7072 6564 6963 7469 6f6e 5f6e  ble_prediction_n
+00023000: 203d 2072 6f74 6174 696f 6e5f 6e6f 745f   = rotation_not_
+00023010: 3930 5f66 756e 6328 696d 6167 655f 7061  90_func(image_pa
+00023020: 6765 2c20 7465 7874 6c69 6e65 5f6d 6173  ge, textline_mas
+00023030: 6b5f 746f 742c 2074 6578 745f 7265 6769  k_tot, text_regi
+00023040: 6f6e 735f 702c 2074 6162 6c65 5f70 7265  ons_p, table_pre
+00023050: 6469 6374 696f 6e2c 2073 6c6f 7065 5f64  diction, slope_d
+00023060: 6573 6b65 7729 0a20 2020 2020 2020 2020  eskew).         
+00023070: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00023080: 2020 2020 2020 2020 7465 7874 5f72 6567          text_reg
+00023090: 696f 6e73 5f70 5f31 5f6e 203d 2072 6573  ions_p_1_n = res
+000230a0: 697a 655f 696d 6167 6528 7465 7874 5f72  ize_image(text_r
+000230b0: 6567 696f 6e73 5f70 5f31 5f6e 2c74 6578  egions_p_1_n,tex
+000230c0: 745f 7265 6769 6f6e 735f 702e 7368 6170  t_regions_p.shap
+000230d0: 655b 305d 2c74 6578 745f 7265 6769 6f6e  e[0],text_region
+000230e0: 735f 702e 7368 6170 655b 315d 290a 2020  s_p.shape[1]).  
+000230f0: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00023100: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745f  xtline_mask_tot_
+00023110: 6420 3d20 7265 7369 7a65 5f69 6d61 6765  d = resize_image
+00023120: 2874 6578 746c 696e 655f 6d61 736b 5f74  (textline_mask_t
+00023130: 6f74 5f64 2c74 6578 745f 7265 6769 6f6e  ot_d,text_region
+00023140: 735f 702e 7368 6170 655b 305d 2c74 6578  s_p.shape[0],tex
+00023150: 745f 7265 6769 6f6e 735f 702e 7368 6170  t_regions_p.shap
+00023160: 655b 315d 290a 2020 2020 2020 2020 2020  e[1]).          
+00023170: 2020 2020 2020 7461 626c 655f 7072 6564        table_pred
+00023180: 6963 7469 6f6e 5f6e 203d 2072 6573 697a  iction_n = resiz
+00023190: 655f 696d 6167 6528 7461 626c 655f 7072  e_image(table_pr
+000231a0: 6564 6963 7469 6f6e 5f6e 2c74 6578 745f  ediction_n,text_
+000231b0: 7265 6769 6f6e 735f 702e 7368 6170 655b  regions_p.shape[
+000231c0: 305d 2c74 6578 745f 7265 6769 6f6e 735f  0],text_regions_
+000231d0: 702e 7368 6170 655b 315d 290a 2020 2020  p.shape[1]).    
+000231e0: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+000231f0: 2020 2020 2020 2020 2020 2020 2072 6567               reg
+00023200: 696f 6e73 5f77 6974 686f 7574 5f73 6570  ions_without_sep
+00023210: 6172 6174 6f72 735f 643d 2874 6578 745f  arators_d=(text_
+00023220: 7265 6769 6f6e 735f 705f 315f 6e5b 3a2c  regions_p_1_n[:,
+00023230: 3a5d 203d 3d20 3129 2a31 0a20 2020 2020  :] == 1)*1.     
+00023240: 2020 2020 2020 2020 2020 2072 6567 696f             regio
+00023250: 6e73 5f77 6974 686f 7574 5f73 6570 6172  ns_without_separ
+00023260: 6174 6f72 735f 645b 7461 626c 655f 7072  ators_d[table_pr
+00023270: 6564 6963 7469 6f6e 5f6e 5b3a 2c3a 5d20  ediction_n[:,:] 
+00023280: 3d3d 2031 5d20 3d20 310a 2020 2020 2020  == 1] = 1.      
+00023290: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+000232a0: 2020 2020 2020 2020 2020 2020 7465 7874              text
+000232b0: 5f72 6567 696f 6e73 5f70 5f31 5f6e 203d  _regions_p_1_n =
+000232c0: 204e 6f6e 650a 2020 2020 2020 2020 2020   None.          
+000232d0: 2020 2020 2020 7465 7874 6c69 6e65 5f6d        textline_m
+000232e0: 6173 6b5f 746f 745f 6420 3d20 4e6f 6e65  ask_tot_d = None
+000232f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023300: 2072 6567 696f 6e73 5f77 6974 686f 7574   regions_without
+00023310: 5f73 6570 6172 6174 6f72 735f 6420 3d20  _separators_d = 
+00023320: 4e6f 6e65 0a20 2020 2020 2020 2020 2020  None.           
+00023330: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+00023340: 2020 7265 6769 6f6e 735f 7769 7468 6f75    regions_withou
+00023350: 745f 7365 7061 7261 746f 7273 203d 2028  t_separators = (
+00023360: 7465 7874 5f72 6567 696f 6e73 5f70 5b3a  text_regions_p[:
+00023370: 2c3a 5d20 3d3d 2031 292a 3123 2820 2874  ,:] == 1)*1#( (t
+00023380: 6578 745f 7265 6769 6f6e 735f 705b 3a2c  ext_regions_p[:,
+00023390: 3a5d 3d3d 3129 207c 2028 7465 7874 5f72  :]==1) | (text_r
+000233a0: 6567 696f 6e73 5f70 5b3a 2c3a 5d3d 3d32  egions_p[:,:]==2
+000233b0: 2920 292a 3120 2373 656c 662e 7265 7475  ) )*1 #self.retu
+000233c0: 726e 5f72 6567 696f 6e73 5f77 6974 686f  rn_regions_witho
+000233d0: 7574 5f73 6570 6572 6174 6f72 735f 6e65  ut_seperators_ne
+000233e0: 7728 7465 7874 5f72 6567 696f 6e73 5f70  w(text_regions_p
+000233f0: 5b3a 2c3a 2c30 5d2c 696d 675f 6f6e 6c79  [:,:,0],img_only
+00023400: 5f72 6567 696f 6e73 290a 2020 2020 2020  _regions).      
+00023410: 2020 2020 2020 7265 6769 6f6e 735f 7769        regions_wi
+00023420: 7468 6f75 745f 7365 7061 7261 746f 7273  thout_separators
+00023430: 5b74 6162 6c65 5f70 7265 6469 6374 696f  [table_predictio
+00023440: 6e20 3d3d 2031 5d20 3d20 310a 2020 2020  n == 1] = 1.    
+00023450: 2020 2020 2020 2020 0a20 2020 2020 2020          .       
+00023460: 2020 2020 2070 6978 656c 5f6c 696e 6573       pixel_lines
+00023470: 3d33 0a20 2020 2020 2020 2020 2020 2069  =3.            i
+00023480: 6620 6e70 2e61 6273 2873 6c6f 7065 5f64  f np.abs(slope_d
+00023490: 6573 6b65 7729 203c 2053 4c4f 5045 5f54  eskew) < SLOPE_T
+000234a0: 4852 4553 484f 4c44 3a0a 2020 2020 2020  HRESHOLD:.      
+000234b0: 2020 2020 2020 2020 2020 6e75 6d5f 636f            num_co
+000234c0: 6c2c 2070 6561 6b73 5f6e 6567 5f66 696e  l, peaks_neg_fin
+000234d0: 2c20 6d61 7472 6978 5f6f 665f 6c69 6e65  , matrix_of_line
+000234e0: 735f 6368 2c20 7370 6c69 7474 6572 5f79  s_ch, splitter_y
+000234f0: 5f6e 6577 2c20 7365 7065 7261 746f 7273  _new, seperators
+00023500: 5f63 6c6f 7365 7570 5f6e 203d 2066 696e  _closeup_n = fin
+00023510: 645f 6e75 6d62 6572 5f6f 665f 636f 6c75  d_number_of_colu
+00023520: 6d6e 735f 696e 5f64 6f63 756d 656e 7428  mns_in_document(
+00023530: 6e70 2e72 6570 6561 7428 7465 7874 5f72  np.repeat(text_r
+00023540: 6567 696f 6e73 5f70 5b3a 2c20 3a2c 206e  egions_p[:, :, n
+00023550: 702e 6e65 7761 7869 735d 2c20 332c 2061  p.newaxis], 3, a
+00023560: 7869 733d 3229 2c20 6e75 6d5f 636f 6c5f  xis=2), num_col_
+00023570: 636c 6173 7369 6669 6572 2c20 7365 6c66  classifier, self
+00023580: 2e74 6162 6c65 732c 2070 6978 656c 5f6c  .tables, pixel_l
+00023590: 696e 6573 290a 2020 2020 2020 2020 2020  ines).          
+000235a0: 2020 0a20 2020 2020 2020 2020 2020 2069    .            i
+000235b0: 6620 6e70 2e61 6273 2873 6c6f 7065 5f64  f np.abs(slope_d
+000235c0: 6573 6b65 7729 203e 3d20 534c 4f50 455f  eskew) >= SLOPE_
+000235d0: 5448 5245 5348 4f4c 443a 0a20 2020 2020  THRESHOLD:.     
+000235e0: 2020 2020 2020 2020 2020 206e 756d 5f63             num_c
+000235f0: 6f6c 5f64 2c20 7065 616b 735f 6e65 675f  ol_d, peaks_neg_
+00023600: 6669 6e5f 642c 206d 6174 7269 785f 6f66  fin_d, matrix_of
+00023610: 5f6c 696e 6573 5f63 685f 642c 2073 706c  _lines_ch_d, spl
+00023620: 6974 7465 725f 795f 6e65 775f 642c 2073  itter_y_new_d, s
+00023630: 6570 6572 6174 6f72 735f 636c 6f73 6575  eperators_closeu
+00023640: 705f 6e5f 6420 3d20 6669 6e64 5f6e 756d  p_n_d = find_num
+00023650: 6265 725f 6f66 5f63 6f6c 756d 6e73 5f69  ber_of_columns_i
+00023660: 6e5f 646f 6375 6d65 6e74 286e 702e 7265  n_document(np.re
+00023670: 7065 6174 2874 6578 745f 7265 6769 6f6e  peat(text_region
+00023680: 735f 705f 315f 6e5b 3a2c 203a 2c20 6e70  s_p_1_n[:, :, np
+00023690: 2e6e 6577 6178 6973 5d2c 2033 2c20 6178  .newaxis], 3, ax
+000236a0: 6973 3d32 292c 6e75 6d5f 636f 6c5f 636c  is=2),num_col_cl
+000236b0: 6173 7369 6669 6572 2c20 7365 6c66 2e74  assifier, self.t
+000236c0: 6162 6c65 732c 2070 6978 656c 5f6c 696e  ables, pixel_lin
+000236d0: 6573 290a 0a20 2020 2020 2020 2020 2020  es)..           
+000236e0: 2069 6620 6e75 6d5f 636f 6c5f 636c 6173   if num_col_clas
+000236f0: 7369 6669 6572 3e3d 333a 0a20 2020 2020  sifier>=3:.     
+00023700: 2020 2020 2020 2020 2020 2069 6620 6e70             if np
+00023710: 2e61 6273 2873 6c6f 7065 5f64 6573 6b65  .abs(slope_deske
+00023720: 7729 203c 2053 4c4f 5045 5f54 4852 4553  w) < SLOPE_THRES
+00023730: 484f 4c44 3a0a 2020 2020 2020 2020 2020  HOLD:.          
+00023740: 2020 2020 2020 2020 2020 7265 6769 6f6e            region
+00023750: 735f 7769 7468 6f75 745f 7365 7061 7261  s_without_separa
+00023760: 746f 7273 203d 2072 6567 696f 6e73 5f77  tors = regions_w
+00023770: 6974 686f 7574 5f73 6570 6172 6174 6f72  ithout_separator
+00023780: 732e 6173 7479 7065 286e 702e 7569 6e74  s.astype(np.uint
+00023790: 3829 0a20 2020 2020 2020 2020 2020 2020  8).             
+000237a0: 2020 2020 2020 2072 6567 696f 6e73 5f77         regions_w
+000237b0: 6974 686f 7574 5f73 6570 6172 6174 6f72  ithout_separator
+000237c0: 7320 3d20 6376 322e 6572 6f64 6528 7265  s = cv2.erode(re
+000237d0: 6769 6f6e 735f 7769 7468 6f75 745f 7365  gions_without_se
+000237e0: 7061 7261 746f 7273 5b3a 2c3a 5d2c 204b  parators[:,:], K
+000237f0: 4552 4e45 4c2c 2069 7465 7261 7469 6f6e  ERNEL, iteration
+00023800: 733d 3629 0a20 2020 2020 2020 2020 2020  s=6).           
+00023810: 2020 2020 200a 2020 2020 2020 2020 2020       .          
+00023820: 2020 2020 2020 6966 206e 702e 6162 7328        if np.abs(
+00023830: 736c 6f70 655f 6465 736b 6577 2920 3e3d  slope_deskew) >=
+00023840: 2053 4c4f 5045 5f54 4852 4553 484f 4c44   SLOPE_THRESHOLD
+00023850: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00023860: 2020 2020 2020 7265 6769 6f6e 735f 7769        regions_wi
+00023870: 7468 6f75 745f 7365 7061 7261 746f 7273  thout_separators
+00023880: 5f64 203d 2072 6567 696f 6e73 5f77 6974  _d = regions_wit
+00023890: 686f 7574 5f73 6570 6172 6174 6f72 735f  hout_separators_
+000238a0: 642e 6173 7479 7065 286e 702e 7569 6e74  d.astype(np.uint
+000238b0: 3829 0a20 2020 2020 2020 2020 2020 2020  8).             
+000238c0: 2020 2020 2020 2072 6567 696f 6e73 5f77         regions_w
+000238d0: 6974 686f 7574 5f73 6570 6172 6174 6f72  ithout_separator
+000238e0: 735f 6420 3d20 6376 322e 6572 6f64 6528  s_d = cv2.erode(
+000238f0: 7265 6769 6f6e 735f 7769 7468 6f75 745f  regions_without_
+00023900: 7365 7061 7261 746f 7273 5f64 5b3a 2c3a  separators_d[:,:
+00023910: 5d2c 204b 4552 4e45 4c2c 2069 7465 7261  ], KERNEL, itera
+00023920: 7469 6f6e 733d 3629 0a20 2020 2020 2020  tions=6).       
+00023930: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00023940: 2020 2020 2020 2020 2020 2070 6173 730a             pass.
+00023950: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00023960: 2020 2020 2020 2020 2069 6620 6e70 2e61           if np.a
+00023970: 6273 2873 6c6f 7065 5f64 6573 6b65 7729  bs(slope_deskew)
+00023980: 203c 2053 4c4f 5045 5f54 4852 4553 484f   < SLOPE_THRESHO
+00023990: 4c44 3a0a 2020 2020 2020 2020 2020 2020  LD:.            
+000239a0: 2020 2020 626f 7865 732c 2070 6561 6b73      boxes, peaks
+000239b0: 5f6e 6567 5f74 6f74 5f74 6162 6c65 7320  _neg_tot_tables 
+000239c0: 3d20 7265 7475 726e 5f62 6f78 6573 5f6f  = return_boxes_o
+000239d0: 665f 696d 6167 6573 5f62 795f 6f72 6465  f_images_by_orde
+000239e0: 725f 6f66 5f72 6561 6469 6e67 5f6e 6577  r_of_reading_new
+000239f0: 2873 706c 6974 7465 725f 795f 6e65 772c  (splitter_y_new,
+00023a00: 2072 6567 696f 6e73 5f77 6974 686f 7574   regions_without
+00023a10: 5f73 6570 6172 6174 6f72 732c 206d 6174  _separators, mat
+00023a20: 7269 785f 6f66 5f6c 696e 6573 5f63 682c  rix_of_lines_ch,
+00023a30: 206e 756d 5f63 6f6c 5f63 6c61 7373 6966   num_col_classif
+00023a40: 6965 722c 2065 726f 7369 6f6e 5f68 7572  ier, erosion_hur
+00023a50: 7473 2c20 7365 6c66 2e74 6162 6c65 7329  ts, self.tables)
+00023a60: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023a70: 2074 6578 745f 7265 6769 6f6e 735f 705f   text_regions_p_
+00023a80: 7461 626c 6573 203d 206e 702e 636f 7079  tables = np.copy
+00023a90: 2874 6578 745f 7265 6769 6f6e 735f 7029  (text_regions_p)
+00023aa0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00023ab0: 2074 6578 745f 7265 6769 6f6e 735f 705f   text_regions_p_
+00023ac0: 7461 626c 6573 5b3a 2c3a 5d5b 2874 6162  tables[:,:][(tab
+00023ad0: 6c65 5f70 7265 6469 6374 696f 6e5b 3a2c  le_prediction[:,
+00023ae0: 3a5d 3d3d 3129 5d20 3d20 3130 0a20 2020  :]==1)] = 10.   
+00023af0: 2020 2020 2020 2020 2020 2020 2070 6978               pix
+00023b00: 656c 5f6c 696e 6520 3d20 330a 2020 2020  el_line = 3.    
+00023b10: 2020 2020 2020 2020 2020 2020 696d 675f              img_
+00023b20: 7265 7669 7365 645f 7461 6232 203d 2073  revised_tab2 = s
+00023b30: 656c 662e 6164 645f 7461 626c 6573 5f68  elf.add_tables_h
+00023b40: 6575 7269 7374 6963 5f74 6f5f 6c61 796f  euristic_to_layo
+00023b50: 7574 2874 6578 745f 7265 6769 6f6e 735f  ut(text_regions_
+00023b60: 705f 7461 626c 6573 2c20 626f 7865 732c  p_tables, boxes,
+00023b70: 2030 2c20 7370 6c69 7474 6572 5f79 5f6e   0, splitter_y_n
+00023b80: 6577 2c20 7065 616b 735f 6e65 675f 746f  ew, peaks_neg_to
+00023b90: 745f 7461 626c 6573 2c20 7465 7874 5f72  t_tables, text_r
+00023ba0: 6567 696f 6e73 5f70 5f74 6162 6c65 7320  egions_p_tables 
+00023bb0: 2c20 6e75 6d5f 636f 6c5f 636c 6173 7369  , num_col_classi
+00023bc0: 6669 6572 202c 2030 2e30 3030 3030 352c  fier , 0.000005,
+00023bd0: 2070 6978 656c 5f6c 696e 6529 0a20 2020   pixel_line).   
+00023be0: 2020 2020 2020 2020 2020 2020 200a 2020               .  
+00023bf0: 2020 2020 2020 2020 2020 2020 2020 696d                im
+00023c00: 675f 7265 7669 7365 645f 7461 6232 2c63  g_revised_tab2,c
+00023c10: 6f6e 746f 7572 6573 5f74 6162 6c65 7320  ontoures_tables 
+00023c20: 3d20 7365 6c66 2e63 6865 636b 5f69 6f75  = self.check_iou
+00023c30: 5f6f 665f 626f 756e 6469 6e67 5f62 6f78  _of_bounding_box
+00023c40: 5f61 6e64 5f63 6f6e 746f 7572 5f66 6f72  _and_contour_for
+00023c50: 5f74 6162 6c65 7328 696d 675f 7265 7669  _tables(img_revi
+00023c60: 7365 645f 7461 6232 2c20 7461 626c 655f  sed_tab2, table_
+00023c70: 7072 6564 6963 7469 6f6e 2c20 3130 2c20  prediction, 10, 
+00023c80: 6e75 6d5f 636f 6c5f 636c 6173 7369 6669  num_col_classifi
+00023c90: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+00023ca0: 2020 2020 0a20 2020 2020 2020 2020 2020      .           
+00023cb0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+00023cc0: 2020 2020 2020 2062 6f78 6573 5f64 2c20         boxes_d, 
+00023cd0: 7065 616b 735f 6e65 675f 746f 745f 7461  peaks_neg_tot_ta
+00023ce0: 626c 6573 5f64 203d 2072 6574 7572 6e5f  bles_d = return_
+00023cf0: 626f 7865 735f 6f66 5f69 6d61 6765 735f  boxes_of_images_
+00023d00: 6279 5f6f 7264 6572 5f6f 665f 7265 6164  by_order_of_read
+00023d10: 696e 675f 6e65 7728 7370 6c69 7474 6572  ing_new(splitter
+00023d20: 5f79 5f6e 6577 5f64 2c20 7265 6769 6f6e  _y_new_d, region
+00023d30: 735f 7769 7468 6f75 745f 7365 7061 7261  s_without_separa
+00023d40: 746f 7273 5f64 2c20 6d61 7472 6978 5f6f  tors_d, matrix_o
+00023d50: 665f 6c69 6e65 735f 6368 5f64 2c20 6e75  f_lines_ch_d, nu
+00023d60: 6d5f 636f 6c5f 636c 6173 7369 6669 6572  m_col_classifier
+00023d70: 2c20 6572 6f73 696f 6e5f 6875 7274 732c  , erosion_hurts,
+00023d80: 2073 656c 662e 7461 626c 6573 290a 2020   self.tables).  
+00023d90: 2020 2020 2020 2020 2020 2020 2020 7465                te
+00023da0: 7874 5f72 6567 696f 6e73 5f70 5f74 6162  xt_regions_p_tab
+00023db0: 6c65 7320 3d20 6e70 2e63 6f70 7928 7465  les = np.copy(te
+00023dc0: 7874 5f72 6567 696f 6e73 5f70 5f31 5f6e  xt_regions_p_1_n
+00023dd0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00023de0: 2020 7465 7874 5f72 6567 696f 6e73 5f70    text_regions_p
+00023df0: 5f74 6162 6c65 7320 3d20 6e70 2e72 6f75  _tables = np.rou
+00023e00: 6e64 2874 6578 745f 7265 6769 6f6e 735f  nd(text_regions_
+00023e10: 705f 7461 626c 6573 290a 2020 2020 2020  p_tables).      
+00023e20: 2020 2020 2020 2020 2020 7465 7874 5f72            text_r
+00023e30: 6567 696f 6e73 5f70 5f74 6162 6c65 735b  egions_p_tables[
+00023e40: 3a2c 3a5d 5b28 7465 7874 5f72 6567 696f  :,:][(text_regio
+00023e50: 6e73 5f70 5f74 6162 6c65 735b 3a2c 3a5d  ns_p_tables[:,:]
+00023e60: 213d 3329 2026 2028 7461 626c 655f 7072  !=3) & (table_pr
+00023e70: 6564 6963 7469 6f6e 5f6e 5b3a 2c3a 5d3d  ediction_n[:,:]=
+00023e80: 3d31 295d 203d 2031 300a 2020 2020 2020  =1)] = 10.      
+00023e90: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00023ea0: 2020 2020 2020 2020 2020 2070 6978 656c             pixel
+00023eb0: 5f6c 696e 6520 3d20 330a 2020 2020 2020  _line = 3.      
+00023ec0: 2020 2020 2020 2020 2020 696d 675f 7265            img_re
+00023ed0: 7669 7365 645f 7461 6232 203d 2073 656c  vised_tab2 = sel
+00023ee0: 662e 6164 645f 7461 626c 6573 5f68 6575  f.add_tables_heu
+00023ef0: 7269 7374 6963 5f74 6f5f 6c61 796f 7574  ristic_to_layout
+00023f00: 2874 6578 745f 7265 6769 6f6e 735f 705f  (text_regions_p_
+00023f10: 7461 626c 6573 2c62 6f78 6573 5f64 2c30  tables,boxes_d,0
+00023f20: 2c73 706c 6974 7465 725f 795f 6e65 775f  ,splitter_y_new_
+00023f30: 642c 7065 616b 735f 6e65 675f 746f 745f  d,peaks_neg_tot_
+00023f40: 7461 626c 6573 5f64 2c74 6578 745f 7265  tables_d,text_re
+00023f50: 6769 6f6e 735f 705f 7461 626c 6573 2c20  gions_p_tables, 
+00023f60: 6e75 6d5f 636f 6c5f 636c 6173 7369 6669  num_col_classifi
+00023f70: 6572 2c20 302e 3030 3030 3035 2c20 7069  er, 0.000005, pi
+00023f80: 7865 6c5f 6c69 6e65 290a 2020 2020 2020  xel_line).      
+00023f90: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00023fa0: 2020 2020 2020 2020 2020 2069 6d67 5f72             img_r
+00023fb0: 6576 6973 6564 5f74 6162 325f 642c 5f20  evised_tab2_d,_ 
+00023fc0: 3d20 7365 6c66 2e63 6865 636b 5f69 6f75  = self.check_iou
+00023fd0: 5f6f 665f 626f 756e 6469 6e67 5f62 6f78  _of_bounding_box
+00023fe0: 5f61 6e64 5f63 6f6e 746f 7572 5f66 6f72  _and_contour_for
+00023ff0: 5f74 6162 6c65 7328 696d 675f 7265 7669  _tables(img_revi
+00024000: 7365 645f 7461 6232 2c20 7461 626c 655f  sed_tab2, table_
+00024010: 7072 6564 6963 7469 6f6e 5f6e 2c20 3130  prediction_n, 10
+00024020: 2c20 6e75 6d5f 636f 6c5f 636c 6173 7369  , num_col_classi
+00024030: 6669 6572 290a 2020 2020 2020 2020 2020  fier).          
+00024040: 2020 2020 2020 696d 675f 7265 7669 7365        img_revise
+00024050: 645f 7461 6232 5f64 5f72 6f74 6174 6564  d_tab2_d_rotated
+00024060: 203d 2072 6f74 6174 655f 696d 6167 6528   = rotate_image(
+00024070: 696d 675f 7265 7669 7365 645f 7461 6232  img_revised_tab2
+00024080: 5f64 2c20 2d73 6c6f 7065 5f64 6573 6b65  _d, -slope_deske
+00024090: 7729 0a20 2020 2020 2020 2020 2020 2020  w).             
+000240a0: 2020 200a 0a20 2020 2020 2020 2020 2020     ..           
+000240b0: 2020 2020 2069 6d67 5f72 6576 6973 6564       img_revised
+000240c0: 5f74 6162 325f 645f 726f 7461 7465 6420  _tab2_d_rotated 
+000240d0: 3d20 6e70 2e72 6f75 6e64 2869 6d67 5f72  = np.round(img_r
+000240e0: 6576 6973 6564 5f74 6162 325f 645f 726f  evised_tab2_d_ro
+000240f0: 7461 7465 6429 0a20 2020 2020 2020 2020  tated).         
+00024100: 2020 2020 2020 2069 6d67 5f72 6576 6973         img_revis
+00024110: 6564 5f74 6162 325f 645f 726f 7461 7465  ed_tab2_d_rotate
+00024120: 6420 3d20 696d 675f 7265 7669 7365 645f  d = img_revised_
+00024130: 7461 6232 5f64 5f72 6f74 6174 6564 2e61  tab2_d_rotated.a
+00024140: 7374 7970 6528 6e70 2e69 6e74 3829 0a0a  stype(np.int8)..
+00024150: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00024160: 696d 675f 7265 7669 7365 645f 7461 6232  img_revised_tab2
+00024170: 5f64 5f72 6f74 6174 6564 203d 2072 6573  _d_rotated = res
+00024180: 697a 655f 696d 6167 6528 696d 675f 7265  ize_image(img_re
+00024190: 7669 7365 645f 7461 6232 5f64 5f72 6f74  vised_tab2_d_rot
+000241a0: 6174 6564 2c20 7465 7874 5f72 6567 696f  ated, text_regio
+000241b0: 6e73 5f70 2e73 6861 7065 5b30 5d2c 2074  ns_p.shape[0], t
+000241c0: 6578 745f 7265 6769 6f6e 735f 702e 7368  ext_regions_p.sh
+000241d0: 6170 655b 315d 290a 0a0a 2020 2020 2020  ape[1])...      
+000241e0: 2020 2020 2020 6966 206e 702e 6162 7328        if np.abs(
+000241f0: 736c 6f70 655f 6465 736b 6577 2920 3c20  slope_deskew) < 
+00024200: 302e 3133 3a0a 2020 2020 2020 2020 2020  0.13:.          
+00024210: 2020 2020 2020 696d 675f 7265 7669 7365        img_revise
+00024220: 645f 7461 6220 3d20 6e70 2e63 6f70 7928  d_tab = np.copy(
+00024230: 696d 675f 7265 7669 7365 645f 7461 6232  img_revised_tab2
+00024240: 5b3a 2c3a 2c30 5d29 0a20 2020 2020 2020  [:,:,0]).       
+00024250: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+00024260: 2020 2020 2020 2020 2020 2069 6d67 5f72             img_r
+00024270: 6576 6973 6564 5f74 6162 203d 206e 702e  evised_tab = np.
+00024280: 636f 7079 2874 6578 745f 7265 6769 6f6e  copy(text_region
+00024290: 735f 705b 3a2c 3a5d 290a 2020 2020 2020  s_p[:,:]).      
+000242a0: 2020 2020 2020 2020 2020 696d 675f 7265            img_re
+000242b0: 7669 7365 645f 7461 625b 3a2c 3a5d 5b69  vised_tab[:,:][i
+000242c0: 6d67 5f72 6576 6973 6564 5f74 6162 5b3a  mg_revised_tab[:
+000242d0: 2c3a 5d20 3d3d 2031 305d 203d 2030 0a20  ,:] == 10] = 0. 
+000242e0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000242f0: 6d67 5f72 6576 6973 6564 5f74 6162 5b3a  mg_revised_tab[:
+00024300: 2c3a 5d5b 696d 675f 7265 7669 7365 645f  ,:][img_revised_
+00024310: 7461 6232 5f64 5f72 6f74 6174 6564 5b3a  tab2_d_rotated[:
+00024320: 2c3a 2c30 5d20 3d3d 2031 305d 203d 2031  ,:,0] == 10] = 1
+00024330: 300a 2020 2020 2020 2020 2020 2020 2020  0.              
+00024340: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+00024350: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00024360: 2020 2020 2020 2020 2323 696d 675f 7265          ##img_re
+00024370: 7669 7365 645f 7461 623d 696d 675f 7265  vised_tab=img_re
+00024380: 7669 7365 645f 7461 6232 5b3a 2c3a 2c30  vised_tab2[:,:,0
+00024390: 5d0a 2020 2020 2020 2020 2020 2020 2369  ].            #i
+000243a0: 6d67 5f72 6576 6973 6564 5f74 6162 3d74  mg_revised_tab=t
+000243b0: 6578 745f 7265 6769 6f6e 735f 705b 3a2c  ext_regions_p[:,
+000243c0: 3a5d 0a20 2020 2020 2020 2020 2020 2074  :].            t
+000243d0: 6578 745f 7265 6769 6f6e 735f 705b 3a2c  ext_regions_p[:,
+000243e0: 3a5d 5b74 6578 745f 7265 6769 6f6e 735f  :][text_regions_
+000243f0: 705b 3a2c 3a5d 3d3d 3130 5d20 3d20 300a  p[:,:]==10] = 0.
+00024400: 2020 2020 2020 2020 2020 2020 7465 7874              text
+00024410: 5f72 6567 696f 6e73 5f70 5b3a 2c3a 5d5b  _regions_p[:,:][
+00024420: 696d 675f 7265 7669 7365 645f 7461 625b  img_revised_tab[
+00024430: 3a2c 3a5d 3d3d 3130 5d20 3d20 3130 0a20  :,:]==10] = 10. 
+00024440: 2020 2020 2020 2020 2020 2023 696d 675f             #img_
+00024450: 7265 7669 7365 645f 7461 625b 696d 675f  revised_tab[img_
+00024460: 7265 7669 7365 645f 7461 6232 5b3a 2c3a  revised_tab2[:,:
+00024470: 2c30 5d3d 3d31 305d 203d 3130 0a20 2020  ,0]==10] =10.   
+00024480: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+00024490: 2020 7069 7865 6c5f 696d 6720 3d20 340a    pixel_img = 4.
+000244a0: 2020 2020 2020 2020 6d69 6e5f 6172 6561          min_area
+000244b0: 5f6d 6172 203d 2030 2e30 3030 3031 0a20  _mar = 0.00001. 
+000244c0: 2020 2020 2020 2070 6f6c 7967 6f6e 735f         polygons_
+000244d0: 6f66 5f6d 6172 6769 6e61 6c73 203d 2072  of_marginals = r
+000244e0: 6574 7572 6e5f 636f 6e74 6f75 7273 5f6f  eturn_contours_o
+000244f0: 665f 696e 7465 7265 7374 6564 5f72 6567  f_interested_reg
+00024500: 696f 6e28 7465 7874 5f72 6567 696f 6e73  ion(text_regions
+00024510: 5f70 2c20 7069 7865 6c5f 696d 672c 206d  _p, pixel_img, m
+00024520: 696e 5f61 7265 615f 6d61 7229 0a20 2020  in_area_mar).   
+00024530: 2020 2020 200a 2020 2020 2020 2020 7069       .        pi
+00024540: 7865 6c5f 696d 6720 3d20 3130 0a20 2020  xel_img = 10.   
+00024550: 2020 2020 2063 6f6e 746f 7572 735f 7461       contours_ta
+00024560: 626c 6573 203d 2072 6574 7572 6e5f 636f  bles = return_co
+00024570: 6e74 6f75 7273 5f6f 665f 696e 7465 7265  ntours_of_intere
+00024580: 7374 6564 5f72 6567 696f 6e28 7465 7874  sted_region(text
+00024590: 5f72 6567 696f 6e73 5f70 2c20 7069 7865  _regions_p, pixe
+000245a0: 6c5f 696d 672c 206d 696e 5f61 7265 615f  l_img, min_area_
+000245b0: 6d61 7229 0a20 2020 2020 2020 200a 2020  mar).        .  
+000245c0: 2020 2020 2020 2320 7365 7420 6669 7273        # set firs
+000245d0: 7420 6d6f 6465 6c20 7769 7468 2073 6563  t model with sec
+000245e0: 6f6e 6420 6d6f 6465 6c0a 2020 2020 2020  ond model.      
+000245f0: 2020 7465 7874 5f72 6567 696f 6e73 5f70    text_regions_p
+00024600: 5b3a 2c20 3a5d 5b74 6578 745f 7265 6769  [:, :][text_regi
+00024610: 6f6e 735f 705b 3a2c 203a 5d20 3d3d 2032  ons_p[:, :] == 2
+00024620: 5d20 3d20 350a 2020 2020 2020 2020 7465  ] = 5.        te
+00024630: 7874 5f72 6567 696f 6e73 5f70 5b3a 2c20  xt_regions_p[:, 
+00024640: 3a5d 5b74 6578 745f 7265 6769 6f6e 735f  :][text_regions_
+00024650: 705b 3a2c 203a 5d20 3d3d 2033 5d20 3d20  p[:, :] == 3] = 
+00024660: 360a 2020 2020 2020 2020 7465 7874 5f72  6.        text_r
+00024670: 6567 696f 6e73 5f70 5b3a 2c20 3a5d 5b74  egions_p[:, :][t
+00024680: 6578 745f 7265 6769 6f6e 735f 705b 3a2c  ext_regions_p[:,
+00024690: 203a 5d20 3d3d 2034 5d20 3d20 380a 0a20   :] == 4] = 8.. 
+000246a0: 2020 2020 2020 2069 6d61 6765 5f70 6167         image_pag
+000246b0: 6520 3d20 696d 6167 655f 7061 6765 2e61  e = image_page.a
+000246c0: 7374 7970 6528 6e70 2e75 696e 7438 290a  stype(np.uint8).
+000246d0: 0a20 2020 2020 2020 2072 6567 696f 6e73  .        regions
+000246e0: 5f66 756c 6c79 2c20 7265 6769 6f6e 735f  _fully, regions_
+000246f0: 6675 6c6c 795f 6f6e 6c79 5f64 726f 7020  fully_only_drop 
+00024700: 3d20 7365 6c66 2e65 7874 7261 6374 5f74  = self.extract_t
+00024710: 6578 745f 7265 6769 6f6e 7328 696d 6167  ext_regions(imag
+00024720: 655f 7061 6765 2c20 5472 7565 2c20 636f  e_page, True, co
+00024730: 6c73 3d6e 756d 5f63 6f6c 5f63 6c61 7373  ls=num_col_class
+00024740: 6966 6965 7229 0a20 2020 2020 2020 2074  ifier).        t
+00024750: 6578 745f 7265 6769 6f6e 735f 705b 3a2c  ext_regions_p[:,
+00024760: 3a5d 5b72 6567 696f 6e73 5f66 756c 6c79  :][regions_fully
+00024770: 5b3a 2c3a 2c30 5d3d 3d36 5d3d 360a 2020  [:,:,0]==6]=6.  
+00024780: 2020 2020 2020 7265 6769 6f6e 735f 6675        regions_fu
+00024790: 6c6c 795f 6f6e 6c79 5f64 726f 7020 3d20  lly_only_drop = 
+000247a0: 7075 745f 6472 6f70 5f6f 7574 5f66 726f  put_drop_out_fro
+000247b0: 6d5f 6f6e 6c79 5f64 726f 705f 6d6f 6465  m_only_drop_mode
+000247c0: 6c28 7265 6769 6f6e 735f 6675 6c6c 795f  l(regions_fully_
+000247d0: 6f6e 6c79 5f64 726f 702c 2074 6578 745f  only_drop, text_
+000247e0: 7265 6769 6f6e 735f 7029 0a20 2020 2020  regions_p).     
+000247f0: 2020 2072 6567 696f 6e73 5f66 756c 6c79     regions_fully
+00024800: 5b3a 2c20 3a2c 2030 5d5b 7265 6769 6f6e  [:, :, 0][region
+00024810: 735f 6675 6c6c 795f 6f6e 6c79 5f64 726f  s_fully_only_dro
+00024820: 705b 3a2c 203a 2c20 305d 203d 3d20 345d  p[:, :, 0] == 4]
+00024830: 203d 2034 0a0a 2020 2020 2020 2020 7265   = 4..        re
+00024840: 6769 6f6e 735f 6675 6c6c 7920 3d20 7075  gions_fully = pu
+00024850: 7474 5f62 625f 6f66 5f64 726f 705f 6361  tt_bb_of_drop_ca
+00024860: 7069 7461 6c73 5f6f 665f 6d6f 6465 6c5f  pitals_of_model_
+00024870: 696e 5f70 6174 6368 6573 5f69 6e5f 6c61  in_patches_in_la
+00024880: 796f 7574 2872 6567 696f 6e73 5f66 756c  yout(regions_ful
+00024890: 6c79 290a 2020 2020 2020 2020 7265 6769  ly).        regi
+000248a0: 6f6e 735f 6675 6c6c 795f 6e70 2c20 5f20  ons_fully_np, _ 
+000248b0: 3d20 7365 6c66 2e65 7874 7261 6374 5f74  = self.extract_t
+000248c0: 6578 745f 7265 6769 6f6e 7328 696d 6167  ext_regions(imag
+000248d0: 655f 7061 6765 2c20 4661 6c73 652c 2063  e_page, False, c
+000248e0: 6f6c 733d 6e75 6d5f 636f 6c5f 636c 6173  ols=num_col_clas
+000248f0: 7369 6669 6572 290a 2020 2020 2020 2020  sifier).        
+00024900: 6966 206e 756d 5f63 6f6c 5f63 6c61 7373  if num_col_class
+00024910: 6966 6965 7220 3e20 323a 0a20 2020 2020  ifier > 2:.     
+00024920: 2020 2020 2020 2072 6567 696f 6e73 5f66         regions_f
+00024930: 756c 6c79 5f6e 705b 3a2c 203a 2c20 305d  ully_np[:, :, 0]
+00024940: 5b72 6567 696f 6e73 5f66 756c 6c79 5f6e  [regions_fully_n
+00024950: 705b 3a2c 203a 2c20 305d 203d 3d20 345d  p[:, :, 0] == 4]
+00024960: 203d 2030 0a20 2020 2020 2020 2065 6c73   = 0.        els
+00024970: 653a 0a20 2020 2020 2020 2020 2020 2072  e:.            r
+00024980: 6567 696f 6e73 5f66 756c 6c79 5f6e 7020  egions_fully_np 
+00024990: 3d20 6669 6c74 6572 5f73 6d61 6c6c 5f64  = filter_small_d
+000249a0: 726f 705f 6361 7069 7461 6c73 5f66 726f  rop_capitals_fro
+000249b0: 6d5f 6e6f 5f70 6174 6368 5f6c 6179 6f75  m_no_patch_layou
+000249c0: 7428 7265 6769 6f6e 735f 6675 6c6c 795f  t(regions_fully_
+000249d0: 6e70 2c20 7465 7874 5f72 6567 696f 6e73  np, text_regions
+000249e0: 5f70 290a 0a20 2020 2020 2020 2072 6567  _p)..        reg
+000249f0: 696f 6e73 5f66 756c 6c79 203d 2062 6f6f  ions_fully = boo
+00024a00: 7374 696e 675f 6865 6164 6572 735f 6279  sting_headers_by
+00024a10: 5f6c 6f6e 6773 686f 745f 7265 6769 6f6e  _longshot_region
+00024a20: 5f73 6567 6d65 6e74 6174 696f 6e28 7265  _segmentation(re
+00024a30: 6769 6f6e 735f 6675 6c6c 792c 2072 6567  gions_fully, reg
+00024a40: 696f 6e73 5f66 756c 6c79 5f6e 702c 2069  ions_fully_np, i
+00024a50: 6d67 5f6f 6e6c 795f 7265 6769 6f6e 7329  mg_only_regions)
+00024a60: 0a20 2020 2020 2020 2023 2070 6c74 2e69  .        # plt.i
+00024a70: 6d73 686f 7728 7265 6769 6f6e 735f 6675  mshow(regions_fu
+00024a80: 6c6c 795b 3a2c 3a2c 305d 290a 2020 2020  lly[:,:,0]).    
+00024a90: 2020 2020 2320 706c 742e 7368 6f77 2829      # plt.show()
+00024aa0: 0a20 2020 2020 2020 2074 6578 745f 7265  .        text_re
+00024ab0: 6769 6f6e 735f 705b 3a2c 203a 5d5b 7265  gions_p[:, :][re
+00024ac0: 6769 6f6e 735f 6675 6c6c 795b 3a2c 203a  gions_fully[:, :
+00024ad0: 2c20 305d 203d 3d20 345d 203d 2034 0a20  , 0] == 4] = 4. 
+00024ae0: 2020 2020 2020 2074 6578 745f 7265 6769         text_regi
+00024af0: 6f6e 735f 705b 3a2c 203a 5d5b 7265 6769  ons_p[:, :][regi
+00024b00: 6f6e 735f 6675 6c6c 795f 6e70 5b3a 2c20  ons_fully_np[:, 
+00024b10: 3a2c 2030 5d20 3d3d 2034 5d20 3d20 340a  :, 0] == 4] = 4.
+00024b20: 2020 2020 2020 2020 2370 6c74 2e69 6d73          #plt.ims
+00024b30: 686f 7728 7465 7874 5f72 6567 696f 6e73  how(text_regions
+00024b40: 5f70 290a 2020 2020 2020 2020 2370 6c74  _p).        #plt
+00024b50: 2e73 686f 7728 290a 2020 2020 2020 2020  .show().        
+00024b60: 2323 2323 6966 206e 6f74 2073 656c 662e  ####if not self.
+00024b70: 7461 626c 6573 3a0a 2020 2020 2020 2020  tables:.        
+00024b80: 6966 206e 702e 6162 7328 736c 6f70 655f  if np.abs(slope_
+00024b90: 6465 736b 6577 2920 3e3d 2053 4c4f 5045  deskew) >= SLOPE
+00024ba0: 5f54 4852 4553 484f 4c44 3a0a 2020 2020  _THRESHOLD:.    
+00024bb0: 2020 2020 2020 2020 5f2c 2074 6578 746c          _, textl
+00024bc0: 696e 655f 6d61 736b 5f74 6f74 5f64 2c20  ine_mask_tot_d, 
+00024bd0: 7465 7874 5f72 6567 696f 6e73 5f70 5f31  text_regions_p_1
+00024be0: 5f6e 2c20 7265 6769 6f6e 735f 6675 6c6c  _n, regions_full
+00024bf0: 795f 6e20 3d20 726f 7461 7469 6f6e 5f6e  y_n = rotation_n
+00024c00: 6f74 5f39 305f 6675 6e63 5f66 756c 6c5f  ot_90_func_full_
+00024c10: 6c61 796f 7574 2869 6d61 6765 5f70 6167  layout(image_pag
+00024c20: 652c 2074 6578 746c 696e 655f 6d61 736b  e, textline_mask
+00024c30: 5f74 6f74 2c20 7465 7874 5f72 6567 696f  _tot, text_regio
+00024c40: 6e73 5f70 2c20 7265 6769 6f6e 735f 6675  ns_p, regions_fu
+00024c50: 6c6c 792c 2073 6c6f 7065 5f64 6573 6b65  lly, slope_deske
+00024c60: 7729 0a0a 2020 2020 2020 2020 2020 2020  w)..            
+00024c70: 7465 7874 5f72 6567 696f 6e73 5f70 5f31  text_regions_p_1
+00024c80: 5f6e 203d 2072 6573 697a 655f 696d 6167  _n = resize_imag
+00024c90: 6528 7465 7874 5f72 6567 696f 6e73 5f70  e(text_regions_p
+00024ca0: 5f31 5f6e 2c20 7465 7874 5f72 6567 696f  _1_n, text_regio
+00024cb0: 6e73 5f70 2e73 6861 7065 5b30 5d2c 2074  ns_p.shape[0], t
+00024cc0: 6578 745f 7265 6769 6f6e 735f 702e 7368  ext_regions_p.sh
+00024cd0: 6170 655b 315d 290a 2020 2020 2020 2020  ape[1]).        
+00024ce0: 2020 2020 7465 7874 6c69 6e65 5f6d 6173      textline_mas
+00024cf0: 6b5f 746f 745f 6420 3d20 7265 7369 7a65  k_tot_d = resize
+00024d00: 5f69 6d61 6765 2874 6578 746c 696e 655f  _image(textline_
+00024d10: 6d61 736b 5f74 6f74 5f64 2c20 7465 7874  mask_tot_d, text
+00024d20: 5f72 6567 696f 6e73 5f70 2e73 6861 7065  _regions_p.shape
+00024d30: 5b30 5d2c 2074 6578 745f 7265 6769 6f6e  [0], text_region
+00024d40: 735f 702e 7368 6170 655b 315d 290a 2020  s_p.shape[1]).  
+00024d50: 2020 2020 2020 2020 2020 7265 6769 6f6e            region
+00024d60: 735f 6675 6c6c 795f 6e20 3d20 7265 7369  s_fully_n = resi
+00024d70: 7a65 5f69 6d61 6765 2872 6567 696f 6e73  ze_image(regions
+00024d80: 5f66 756c 6c79 5f6e 2c20 7465 7874 5f72  _fully_n, text_r
+00024d90: 6567 696f 6e73 5f70 2e73 6861 7065 5b30  egions_p.shape[0
+00024da0: 5d2c 2074 6578 745f 7265 6769 6f6e 735f  ], text_regions_
+00024db0: 702e 7368 6170 655b 315d 290a 2020 2020  p.shape[1]).    
+00024dc0: 2020 2020 2020 2020 6966 206e 6f74 2073          if not s
+00024dd0: 656c 662e 7461 626c 6573 3a0a 2020 2020  elf.tables:.    
+00024de0: 2020 2020 2020 2020 2020 2020 7265 6769              regi
+00024df0: 6f6e 735f 7769 7468 6f75 745f 7365 7061  ons_without_sepa
+00024e00: 7261 746f 7273 5f64 203d 2028 7465 7874  rators_d = (text
+00024e10: 5f72 6567 696f 6e73 5f70 5f31 5f6e 5b3a  _regions_p_1_n[:
+00024e20: 2c20 3a5d 203d 3d20 3129 202a 2031 0a20  , :] == 1) * 1. 
+00024e30: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00024e40: 2020 2020 2020 2020 2074 6578 745f 7265           text_re
+00024e50: 6769 6f6e 735f 705f 315f 6e20 3d20 4e6f  gions_p_1_n = No
+00024e60: 6e65 0a20 2020 2020 2020 2020 2020 2074  ne.            t
+00024e70: 6578 746c 696e 655f 6d61 736b 5f74 6f74  extline_mask_tot
+00024e80: 5f64 203d 204e 6f6e 650a 2020 2020 2020  _d = None.      
+00024e90: 2020 2020 2020 7265 6769 6f6e 735f 7769        regions_wi
+00024ea0: 7468 6f75 745f 7365 7061 7261 746f 7273  thout_separators
+00024eb0: 5f64 203d 204e 6f6e 650a 2020 2020 2020  _d = None.      
+00024ec0: 2020 6966 206e 6f74 2073 656c 662e 7461    if not self.ta
+00024ed0: 626c 6573 3a0a 2020 2020 2020 2020 2020  bles:.          
+00024ee0: 2020 7265 6769 6f6e 735f 7769 7468 6f75    regions_withou
+00024ef0: 745f 7365 7061 7261 746f 7273 203d 2028  t_separators = (
+00024f00: 7465 7874 5f72 6567 696f 6e73 5f70 5b3a  text_regions_p[:
+00024f10: 2c20 3a5d 203d 3d20 3129 202a 2031 0a20  , :] == 1) * 1. 
+00024f20: 2020 2020 2020 2069 6d67 5f72 6576 6973         img_revis
+00024f30: 6564 5f74 6162 203d 206e 702e 636f 7079  ed_tab = np.copy
+00024f40: 2874 6578 745f 7265 6769 6f6e 735f 705b  (text_regions_p[
+00024f50: 3a2c 203a 5d29 0a20 2020 2020 2020 2070  :, :]).        p
+00024f60: 6f6c 7967 6f6e 735f 6f66 5f69 6d61 6765  olygons_of_image
+00024f70: 7320 3d20 7265 7475 726e 5f63 6f6e 746f  s = return_conto
+00024f80: 7572 735f 6f66 5f69 6e74 6572 6573 7465  urs_of_intereste
+00024f90: 645f 7265 6769 6f6e 2869 6d67 5f72 6576  d_region(img_rev
+00024fa0: 6973 6564 5f74 6162 2c20 3529 0a20 2020  ised_tab, 5).   
+00024fb0: 2020 2020 2073 656c 662e 6c6f 6767 6572       self.logger
+00024fc0: 2e64 6562 7567 2827 6578 6974 2072 756e  .debug('exit run
+00024fd0: 5f62 6f78 6573 5f66 756c 6c5f 6c61 796f  _boxes_full_layo
+00024fe0: 7574 2729 0a20 2020 2020 2020 2072 6574  ut').        ret
+00024ff0: 7572 6e20 706f 6c79 676f 6e73 5f6f 665f  urn polygons_of_
+00025000: 696d 6167 6573 2c20 696d 675f 7265 7669  images, img_revi
+00025010: 7365 645f 7461 622c 2074 6578 745f 7265  sed_tab, text_re
+00025020: 6769 6f6e 735f 705f 315f 6e2c 2074 6578  gions_p_1_n, tex
+00025030: 746c 696e 655f 6d61 736b 5f74 6f74 5f64  tline_mask_tot_d
+00025040: 2c20 7265 6769 6f6e 735f 7769 7468 6f75  , regions_withou
+00025050: 745f 7365 7061 7261 746f 7273 5f64 2c20  t_separators_d, 
+00025060: 7265 6769 6f6e 735f 6675 6c6c 792c 2072  regions_fully, r
+00025070: 6567 696f 6e73 5f77 6974 686f 7574 5f73  egions_without_s
+00025080: 6570 6172 6174 6f72 732c 2070 6f6c 7967  eparators, polyg
+00025090: 6f6e 735f 6f66 5f6d 6172 6769 6e61 6c73  ons_of_marginals
+000250a0: 2c20 636f 6e74 6f75 7273 5f74 6162 6c65  , contours_table
+000250b0: 730a 2020 2020 0a20 2020 2064 6566 206f  s.    .    def o
+000250c0: 7572 5f6c 6f61 645f 6d6f 6465 6c28 7365  ur_load_model(se
+000250d0: 6c66 2c20 6d6f 6465 6c5f 6669 6c65 293a  lf, model_file):
+000250e0: 0a20 2020 2020 2020 200a 2020 2020 2020  .        .      
+000250f0: 2020 7472 793a 0a20 2020 2020 2020 2020    try:.         
+00025100: 2020 206d 6f64 656c 203d 206c 6f61 645f     model = load_
+00025110: 6d6f 6465 6c28 6d6f 6465 6c5f 6669 6c65  model(model_file
+00025120: 2c20 636f 6d70 696c 653d 4661 6c73 6529  , compile=False)
+00025130: 0a20 2020 2020 2020 2065 7863 6570 743a  .        except:
+00025140: 0a20 2020 2020 2020 2020 2020 206d 6f64  .            mod
+00025150: 656c 203d 206c 6f61 645f 6d6f 6465 6c28  el = load_model(
+00025160: 6d6f 6465 6c5f 6669 6c65 202c 2063 6f6d  model_file , com
+00025170: 7069 6c65 3d46 616c 7365 2c63 7573 746f  pile=False,custo
+00025180: 6d5f 6f62 6a65 6374 7320 3d20 7b22 5061  m_objects = {"Pa
+00025190: 7463 6845 6e63 6f64 6572 223a 2050 6174  tchEncoder": Pat
+000251a0: 6368 456e 636f 6465 722c 2022 5061 7463  chEncoder, "Patc
+000251b0: 6865 7322 3a20 5061 7463 6865 737d 290a  hes": Patches}).
+000251c0: 0a20 2020 2020 2020 2072 6574 7572 6e20  .        return 
+000251d0: 6d6f 6465 6c0a 0a20 2020 2064 6566 2072  model..    def r
+000251e0: 756e 2873 656c 6629 3a0a 2020 2020 2020  un(self):.      
+000251f0: 2020 2222 220a 2020 2020 2020 2020 4765    """.        Ge
+00025200: 7420 696d 6167 6520 616e 6420 7363 616c  t image and scal
+00025210: 6573 2c20 7468 656e 2065 7874 7261 6374  es, then extract
+00025220: 2074 6865 2070 6167 6520 6f66 2073 6361   the page of sca
+00025230: 6e6e 6564 2069 6d61 6765 0a20 2020 2020  nned image.     
+00025240: 2020 2022 2222 0a20 2020 2020 2020 2073     """.        s
+00025250: 656c 662e 6c6f 6767 6572 2e64 6562 7567  elf.logger.debug
+00025260: 2822 656e 7465 7220 7275 6e22 290a 0a0a  ("enter run")...
+00025270: 2020 2020 2020 2020 7430 5f74 6f74 203d          t0_tot =
+00025280: 2074 696d 652e 7469 6d65 2829 0a0a 2020   time.time()..  
+00025290: 2020 2020 2020 6966 206e 6f74 2073 656c        if not sel
+000252a0: 662e 6469 725f 696e 3a0a 2020 2020 2020  f.dir_in:.      
+000252b0: 2020 2020 2020 7365 6c66 2e6c 735f 696d        self.ls_im
+000252c0: 6773 203d 205b 315d 0a20 2020 2020 2020  gs = [1].       
+000252d0: 200a 2020 2020 2020 2020 666f 7220 696d   .        for im
+000252e0: 675f 6e61 6d65 2069 6e20 7365 6c66 2e6c  g_name in self.l
+000252f0: 735f 696d 6773 3a0a 2020 2020 2020 2020  s_imgs:.        
+00025300: 2020 2020 7430 203d 2074 696d 652e 7469      t0 = time.ti
+00025310: 6d65 2829 0a20 2020 2020 2020 2020 2020  me().           
+00025320: 2069 6620 7365 6c66 2e64 6972 5f69 6e3a   if self.dir_in:
+00025330: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025340: 2073 656c 662e 7265 7365 745f 6669 6c65   self.reset_file
+00025350: 5f6e 616d 655f 6469 7228 6f73 2e70 6174  _name_dir(os.pat
+00025360: 682e 6a6f 696e 2873 656c 662e 6469 725f  h.join(self.dir_
+00025370: 696e 2c69 6d67 5f6e 616d 6529 290a 2020  in,img_name)).  
+00025380: 2020 2020 2020 2020 2020 0a20 2020 2020            .     
+00025390: 2020 2020 2020 2069 6d67 5f72 6573 2c20         img_res, 
+000253a0: 6973 5f69 6d61 6765 5f65 6e68 616e 6365  is_image_enhance
+000253b0: 642c 206e 756d 5f63 6f6c 5f63 6c61 7373  d, num_col_class
+000253c0: 6966 6965 722c 206e 756d 5f63 6f6c 756d  ifier, num_colum
+000253d0: 6e5f 6973 5f63 6c61 7373 6966 6965 6420  n_is_classified 
+000253e0: 3d20 7365 6c66 2e72 756e 5f65 6e68 616e  = self.run_enhan
+000253f0: 6365 6d65 6e74 2873 656c 662e 6c69 6768  cement(self.ligh
+00025400: 745f 7665 7273 696f 6e29 0a20 2020 2020  t_version).     
+00025410: 2020 2020 2020 200a 2020 2020 2020 2020         .        
+00025420: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
+00025430: 696e 666f 2822 456e 6861 6e63 696e 6720  info("Enhancing 
+00025440: 746f 6f6b 2025 2e31 6673 2022 2c20 7469  took %.1fs ", ti
+00025450: 6d65 2e74 696d 6528 2920 2d20 7430 290a  me.time() - t0).
+00025460: 2020 2020 2020 2020 2020 2020 0a20 2020              .   
+00025470: 2020 2020 2020 2020 2074 3120 3d20 7469           t1 = ti
+00025480: 6d65 2e74 696d 6528 290a 2020 2020 2020  me.time().      
+00025490: 2020 2020 2020 6966 2073 656c 662e 6c69        if self.li
+000254a0: 6768 745f 7665 7273 696f 6e3a 0a20 2020  ght_version:.   
+000254b0: 2020 2020 2020 2020 2020 2020 2074 6578               tex
+000254c0: 745f 7265 6769 6f6e 735f 705f 3120 2c65  t_regions_p_1 ,e
+000254d0: 726f 7369 6f6e 5f68 7572 7473 2c20 706f  rosion_hurts, po
+000254e0: 6c79 676f 6e73 5f6c 696e 6573 5f78 6d6c  lygons_lines_xml
+000254f0: 2c20 7465 7874 6c69 6e65 5f6d 6173 6b5f  , textline_mask_
+00025500: 746f 745f 6561 203d 2073 656c 662e 6765  tot_ea = self.ge
+00025510: 745f 7265 6769 6f6e 735f 6c69 6768 745f  t_regions_light_
+00025520: 7628 696d 675f 7265 732c 2069 735f 696d  v(img_res, is_im
+00025530: 6167 655f 656e 6861 6e63 6564 2c20 6e75  age_enhanced, nu
+00025540: 6d5f 636f 6c5f 636c 6173 7369 6669 6572  m_col_classifier
+00025550: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00025560: 2020 736c 6f70 655f 6465 736b 6577 2c20    slope_deskew, 
+00025570: 736c 6f70 655f 6669 7273 7420 3d20 7365  slope_first = se
+00025580: 6c66 2e72 756e 5f64 6573 6b65 7728 7465  lf.run_deskew(te
+00025590: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745f  xtline_mask_tot_
+000255a0: 6561 290a 2020 2020 2020 2020 2020 2020  ea).            
+000255b0: 2020 2020 2373 656c 662e 6c6f 6767 6572      #self.logger
+000255c0: 2e69 6e66 6f28 2254 6578 7472 6567 696f  .info("Textregio
+000255d0: 6e20 6465 7465 6374 696f 6e20 746f 6f6b  n detection took
+000255e0: 2025 2e31 6673 2022 2c20 7469 6d65 2e74   %.1fs ", time.t
+000255f0: 696d 6528 2920 2d20 7431 7429 0a20 2020  ime() - t1t).   
+00025600: 2020 2020 2020 2020 2020 2020 206e 756d               num
+00025610: 5f63 6f6c 2c20 6e75 6d5f 636f 6c5f 636c  _col, num_col_cl
+00025620: 6173 7369 6669 6572 2c20 696d 675f 6f6e  assifier, img_on
+00025630: 6c79 5f72 6567 696f 6e73 2c20 7061 6765  ly_regions, page
+00025640: 5f63 6f6f 7264 2c20 696d 6167 655f 7061  _coord, image_pa
+00025650: 6765 2c20 6d61 736b 5f69 6d61 6765 732c  ge, mask_images,
+00025660: 206d 6173 6b5f 6c69 6e65 732c 2074 6578   mask_lines, tex
+00025670: 745f 7265 6769 6f6e 735f 705f 312c 2063  t_regions_p_1, c
+00025680: 6f6e 745f 7061 6765 2c20 7461 626c 655f  ont_page, table_
+00025690: 7072 6564 6963 7469 6f6e 2c20 7465 7874  prediction, text
+000256a0: 6c69 6e65 5f6d 6173 6b5f 746f 745f 6561  line_mask_tot_ea
+000256b0: 203d 205c 0a20 2020 2020 2020 2020 2020   = \.           
+000256c0: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+000256d0: 662e 7275 6e5f 6772 6170 6869 6373 5f61  f.run_graphics_a
+000256e0: 6e64 5f63 6f6c 756d 6e73 5f6c 6967 6874  nd_columns_light
+000256f0: 2874 6578 745f 7265 6769 6f6e 735f 705f  (text_regions_p_
+00025700: 312c 2074 6578 746c 696e 655f 6d61 736b  1, textline_mask
+00025710: 5f74 6f74 5f65 612c 206e 756d 5f63 6f6c  _tot_ea, num_col
+00025720: 5f63 6c61 7373 6966 6965 722c 206e 756d  _classifier, num
+00025730: 5f63 6f6c 756d 6e5f 6973 5f63 6c61 7373  _column_is_class
+00025740: 6966 6965 642c 2065 726f 7369 6f6e 5f68  ified, erosion_h
+00025750: 7572 7473 290a 2020 2020 2020 2020 2020  urts).          
+00025760: 2020 2020 2020 2373 656c 662e 6c6f 6767        #self.logg
+00025770: 6572 2e69 6e66 6f28 2272 756e 2067 7261  er.info("run gra
+00025780: 7068 6963 7320 252e 3166 7320 222c 2074  phics %.1fs ", t
+00025790: 696d 652e 7469 6d65 2829 202d 2074 3174  ime.time() - t1t
+000257a0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+000257b0: 2020 7465 7874 6c69 6e65 5f6d 6173 6b5f    textline_mask_
+000257c0: 746f 745f 6561 5f6f 7267 203d 206e 702e  tot_ea_org = np.
+000257d0: 636f 7079 2874 6578 746c 696e 655f 6d61  copy(textline_ma
+000257e0: 736b 5f74 6f74 5f65 6129 0a20 2020 2020  sk_tot_ea).     
+000257f0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00025800: 2020 2020 2020 2020 2020 2020 2074 6578               tex
+00025810: 745f 7265 6769 6f6e 735f 705f 3120 2c65  t_regions_p_1 ,e
+00025820: 726f 7369 6f6e 5f68 7572 7473 2c20 706f  rosion_hurts, po
+00025830: 6c79 676f 6e73 5f6c 696e 6573 5f78 6d6c  lygons_lines_xml
+00025840: 203d 2073 656c 662e 6765 745f 7265 6769   = self.get_regi
+00025850: 6f6e 735f 6672 6f6d 5f78 795f 326d 6f64  ons_from_xy_2mod
+00025860: 656c 7328 696d 675f 7265 732c 2069 735f  els(img_res, is_
+00025870: 696d 6167 655f 656e 6861 6e63 6564 2c20  image_enhanced, 
+00025880: 6e75 6d5f 636f 6c5f 636c 6173 7369 6669  num_col_classifi
+00025890: 6572 290a 2020 2020 2020 2020 2020 2020  er).            
+000258a0: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
+000258b0: 696e 666f 2822 5465 7874 7265 6769 6f6e  info("Textregion
+000258c0: 2064 6574 6563 7469 6f6e 2074 6f6f 6b20   detection took 
+000258d0: 252e 3166 7320 222c 2074 696d 652e 7469  %.1fs ", time.ti
+000258e0: 6d65 2829 202d 2074 3129 0a0a 2020 2020  me() - t1)..    
+000258f0: 2020 2020 2020 2020 2020 2020 7431 203d              t1 =
+00025900: 2074 696d 652e 7469 6d65 2829 0a20 2020   time.time().   
+00025910: 2020 2020 2020 2020 2020 2020 206e 756d               num
+00025920: 5f63 6f6c 2c20 6e75 6d5f 636f 6c5f 636c  _col, num_col_cl
+00025930: 6173 7369 6669 6572 2c20 696d 675f 6f6e  assifier, img_on
+00025940: 6c79 5f72 6567 696f 6e73 2c20 7061 6765  ly_regions, page
+00025950: 5f63 6f6f 7264 2c20 696d 6167 655f 7061  _coord, image_pa
+00025960: 6765 2c20 6d61 736b 5f69 6d61 6765 732c  ge, mask_images,
+00025970: 206d 6173 6b5f 6c69 6e65 732c 2074 6578   mask_lines, tex
+00025980: 745f 7265 6769 6f6e 735f 705f 312c 2063  t_regions_p_1, c
+00025990: 6f6e 745f 7061 6765 2c20 7461 626c 655f  ont_page, table_
+000259a0: 7072 6564 6963 7469 6f6e 203d 205c 0a20  prediction = \. 
+000259b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000259c0: 2020 2020 2020 2073 656c 662e 7275 6e5f         self.run_
+000259d0: 6772 6170 6869 6373 5f61 6e64 5f63 6f6c  graphics_and_col
+000259e0: 756d 6e73 2874 6578 745f 7265 6769 6f6e  umns(text_region
+000259f0: 735f 705f 312c 206e 756d 5f63 6f6c 5f63  s_p_1, num_col_c
+00025a00: 6c61 7373 6966 6965 722c 206e 756d 5f63  lassifier, num_c
+00025a10: 6f6c 756d 6e5f 6973 5f63 6c61 7373 6966  olumn_is_classif
+00025a20: 6965 642c 2065 726f 7369 6f6e 5f68 7572  ied, erosion_hur
+00025a30: 7473 290a 2020 2020 2020 2020 2020 2020  ts).            
+00025a40: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
+00025a50: 696e 666f 2822 4772 6170 6869 6373 2064  info("Graphics d
+00025a60: 6574 6563 7469 6f6e 2074 6f6f 6b20 252e  etection took %.
+00025a70: 3166 7320 222c 2074 696d 652e 7469 6d65  1fs ", time.time
+00025a80: 2829 202d 2074 3129 0a20 2020 2020 2020  () - t1).       
+00025a90: 2020 2020 2020 2020 2023 7365 6c66 2e6c           #self.l
+00025aa0: 6f67 6765 722e 696e 666f 2827 636f 6e74  ogger.info('cont
+00025ab0: 5f70 6167 6520 2573 272c 2063 6f6e 745f  _page %s', cont_
+00025ac0: 7061 6765 290a 2020 2020 2020 2020 2020  page).          
+00025ad0: 2020 0a20 2020 2020 2020 2020 2020 2069    .            i
+00025ae0: 6620 6e6f 7420 6e75 6d5f 636f 6c3a 0a20  f not num_col:. 
+00025af0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+00025b00: 656c 662e 6c6f 6767 6572 2e69 6e66 6f28  elf.logger.info(
+00025b10: 224e 6f20 636f 6c75 6d6e 7320 6465 7465  "No columns dete
+00025b20: 6374 6564 2c20 6f75 7470 7574 7469 6e67  cted, outputting
+00025b30: 2061 6e20 656d 7074 7920 5041 4745 2d58   an empty PAGE-X
+00025b40: 4d4c 2229 0a20 2020 2020 2020 2020 2020  ML").           
+00025b50: 2020 2020 2070 6367 7473 203d 2073 656c       pcgts = sel
+00025b60: 662e 7772 6974 6572 2e62 7569 6c64 5f70  f.writer.build_p
+00025b70: 6167 6578 6d6c 5f6e 6f5f 6675 6c6c 5f6c  agexml_no_full_l
+00025b80: 6179 6f75 7428 5b5d 2c20 7061 6765 5f63  ayout([], page_c
+00025b90: 6f6f 7264 2c20 5b5d 2c20 5b5d 2c20 5b5d  oord, [], [], []
+00025ba0: 2c20 5b5d 2c20 5b5d 2c20 5b5d 2c20 5b5d  , [], [], [], []
+00025bb0: 2c20 5b5d 2c20 5b5d 2c20 5b5d 2c20 636f  , [], [], [], co
+00025bc0: 6e74 5f70 6167 652c 205b 5d2c 205b 5d29  nt_page, [], [])
+00025bd0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025be0: 2073 656c 662e 6c6f 6767 6572 2e69 6e66   self.logger.inf
+00025bf0: 6f28 224a 6f62 2064 6f6e 6520 696e 2025  o("Job done in %
+00025c00: 2e31 6673 222c 2074 696d 652e 7469 6d65  .1fs", time.time
+00025c10: 2829 202d 2074 3129 0a20 2020 2020 2020  () - t1).       
+00025c20: 2020 2020 2020 2020 2069 6620 7365 6c66           if self
+00025c30: 2e64 6972 5f69 6e3a 0a20 2020 2020 2020  .dir_in:.       
+00025c40: 2020 2020 2020 2020 2020 2020 2073 656c               sel
+00025c50: 662e 7772 6974 6572 2e77 7269 7465 5f70  f.writer.write_p
+00025c60: 6167 6578 6d6c 2870 6367 7473 290a 2020  agexml(pcgts).  
+00025c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00025c80: 2020 636f 6e74 696e 7565 0a20 2020 2020    continue.     
+00025c90: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00025ca0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025cb0: 2020 2020 2072 6574 7572 6e20 7063 6774       return pcgt
+00025cc0: 730a 0a20 2020 2020 2020 2020 2020 2074  s..            t
+00025cd0: 3120 3d20 7469 6d65 2e74 696d 6528 290a  1 = time.time().
+00025ce0: 2020 2020 2020 2020 2020 2020 6966 206e              if n
+00025cf0: 6f74 2073 656c 662e 6c69 6768 745f 7665  ot self.light_ve
+00025d00: 7273 696f 6e3a 0a20 2020 2020 2020 2020  rsion:.         
+00025d10: 2020 2020 2020 2074 6578 746c 696e 655f         textline_
+00025d20: 6d61 736b 5f74 6f74 5f65 6120 3d20 7365  mask_tot_ea = se
+00025d30: 6c66 2e72 756e 5f74 6578 746c 696e 6528  lf.run_textline(
+00025d40: 696d 6167 655f 7061 6765 290a 2020 2020  image_page).    
+00025d50: 2020 2020 2020 2020 2020 2020 7365 6c66              self
+00025d60: 2e6c 6f67 6765 722e 696e 666f 2822 7465  .logger.info("te
+00025d70: 7874 6c69 6e65 2064 6574 6563 7469 6f6e  xtline detection
+00025d80: 2074 6f6f 6b20 252e 3166 7322 2c20 7469   took %.1fs", ti
+00025d90: 6d65 2e74 696d 6528 2920 2d20 7431 290a  me.time() - t1).
+00025da0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00025db0: 2074 3120 3d20 7469 6d65 2e74 696d 6528   t1 = time.time(
+00025dc0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00025dd0: 2020 736c 6f70 655f 6465 736b 6577 2c20    slope_deskew, 
+00025de0: 736c 6f70 655f 6669 7273 7420 3d20 7365  slope_first = se
+00025df0: 6c66 2e72 756e 5f64 6573 6b65 7728 7465  lf.run_deskew(te
+00025e00: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745f  xtline_mask_tot_
+00025e10: 6561 290a 2020 2020 2020 2020 2020 2020  ea).            
+00025e20: 2020 2020 7365 6c66 2e6c 6f67 6765 722e      self.logger.
+00025e30: 696e 666f 2822 6465 736b 6577 696e 6720  info("deskewing 
+00025e40: 746f 6f6b 2025 2e31 6673 222c 2074 696d  took %.1fs", tim
+00025e50: 652e 7469 6d65 2829 202d 2074 3129 0a20  e.time() - t1). 
+00025e60: 2020 2020 2020 2020 2020 2074 3120 3d20             t1 = 
+00025e70: 7469 6d65 2e74 696d 6528 290a 2020 2020  time.time().    
+00025e80: 2020 2020 2020 2020 2370 6c74 2e69 6d73          #plt.ims
+00025e90: 686f 7728 7461 626c 655f 7072 6564 6963  how(table_predic
+00025ea0: 7469 6f6e 290a 2020 2020 2020 2020 2020  tion).          
+00025eb0: 2020 2370 6c74 2e73 686f 7728 290a 0a20    #plt.show().. 
+00025ec0: 2020 2020 2020 2020 2020 2074 6578 746c             textl
+00025ed0: 696e 655f 6d61 736b 5f74 6f74 2c20 7465  ine_mask_tot, te
+00025ee0: 7874 5f72 6567 696f 6e73 5f70 2c20 696d  xt_regions_p, im
+00025ef0: 6167 655f 7061 6765 5f72 6f74 6174 6564  age_page_rotated
+00025f00: 203d 2073 656c 662e 7275 6e5f 6d61 7267   = self.run_marg
+00025f10: 696e 616c 7328 696d 6167 655f 7061 6765  inals(image_page
+00025f20: 2c20 7465 7874 6c69 6e65 5f6d 6173 6b5f  , textline_mask_
+00025f30: 746f 745f 6561 2c20 6d61 736b 5f69 6d61  tot_ea, mask_ima
+00025f40: 6765 732c 206d 6173 6b5f 6c69 6e65 732c  ges, mask_lines,
+00025f50: 206e 756d 5f63 6f6c 5f63 6c61 7373 6966   num_col_classif
+00025f60: 6965 722c 2073 6c6f 7065 5f64 6573 6b65  ier, slope_deske
+00025f70: 772c 2074 6578 745f 7265 6769 6f6e 735f  w, text_regions_
+00025f80: 705f 312c 2074 6162 6c65 5f70 7265 6469  p_1, table_predi
+00025f90: 6374 696f 6e29 0a20 2020 2020 2020 2020  ction).         
+00025fa0: 2020 2073 656c 662e 6c6f 6767 6572 2e69     self.logger.i
+00025fb0: 6e66 6f28 2264 6574 6563 7469 6f6e 206f  nfo("detection o
+00025fc0: 6620 6d61 7267 696e 616c 7320 746f 6f6b  f marginals took
+00025fd0: 2025 2e31 6673 222c 2074 696d 652e 7469   %.1fs", time.ti
+00025fe0: 6d65 2829 202d 2074 3129 0a20 2020 2020  me() - t1).     
+00025ff0: 2020 2020 2020 2074 3120 3d20 7469 6d65         t1 = time
+00026000: 2e74 696d 6528 290a 2020 2020 2020 2020  .time().        
+00026010: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00026020: 6675 6c6c 5f6c 6179 6f75 743a 0a20 2020  full_layout:.   
+00026030: 2020 2020 2020 2020 2020 2020 2070 6f6c               pol
+00026040: 7967 6f6e 735f 6f66 5f69 6d61 6765 732c  ygons_of_images,
+00026050: 2069 6d67 5f72 6576 6973 6564 5f74 6162   img_revised_tab
+00026060: 2c20 7465 7874 5f72 6567 696f 6e73 5f70  , text_regions_p
+00026070: 5f31 5f6e 2c20 7465 7874 6c69 6e65 5f6d  _1_n, textline_m
+00026080: 6173 6b5f 746f 745f 642c 2072 6567 696f  ask_tot_d, regio
+00026090: 6e73 5f77 6974 686f 7574 5f73 6570 6172  ns_without_separ
+000260a0: 6174 6f72 735f 642c 2062 6f78 6573 2c20  ators_d, boxes, 
+000260b0: 626f 7865 735f 642c 2070 6f6c 7967 6f6e  boxes_d, polygon
+000260c0: 735f 6f66 5f6d 6172 6769 6e61 6c73 2c20  s_of_marginals, 
+000260d0: 636f 6e74 6f75 7273 5f74 6162 6c65 7320  contours_tables 
+000260e0: 3d20 7365 6c66 2e72 756e 5f62 6f78 6573  = self.run_boxes
+000260f0: 5f6e 6f5f 6675 6c6c 5f6c 6179 6f75 7428  _no_full_layout(
+00026100: 696d 6167 655f 7061 6765 2c20 7465 7874  image_page, text
+00026110: 6c69 6e65 5f6d 6173 6b5f 746f 742c 2074  line_mask_tot, t
+00026120: 6578 745f 7265 6769 6f6e 735f 702c 2073  ext_regions_p, s
+00026130: 6c6f 7065 5f64 6573 6b65 772c 206e 756d  lope_deskew, num
+00026140: 5f63 6f6c 5f63 6c61 7373 6966 6965 722c  _col_classifier,
+00026150: 2074 6162 6c65 5f70 7265 6469 6374 696f   table_predictio
+00026160: 6e2c 2065 726f 7369 6f6e 5f68 7572 7473  n, erosion_hurts
+00026170: 290a 0a20 2020 2020 2020 2020 2020 2069  )..            i
+00026180: 6620 7365 6c66 2e66 756c 6c5f 6c61 796f  f self.full_layo
+00026190: 7574 3a0a 2020 2020 2020 2020 2020 2020  ut:.            
+000261a0: 2020 2020 706f 6c79 676f 6e73 5f6f 665f      polygons_of_
+000261b0: 696d 6167 6573 2c20 696d 675f 7265 7669  images, img_revi
+000261c0: 7365 645f 7461 622c 2074 6578 745f 7265  sed_tab, text_re
+000261d0: 6769 6f6e 735f 705f 315f 6e2c 2074 6578  gions_p_1_n, tex
+000261e0: 746c 696e 655f 6d61 736b 5f74 6f74 5f64  tline_mask_tot_d
+000261f0: 2c20 7265 6769 6f6e 735f 7769 7468 6f75  , regions_withou
+00026200: 745f 7365 7061 7261 746f 7273 5f64 2c20  t_separators_d, 
+00026210: 7265 6769 6f6e 735f 6675 6c6c 792c 2072  regions_fully, r
+00026220: 6567 696f 6e73 5f77 6974 686f 7574 5f73  egions_without_s
+00026230: 6570 6172 6174 6f72 732c 2070 6f6c 7967  eparators, polyg
+00026240: 6f6e 735f 6f66 5f6d 6172 6769 6e61 6c73  ons_of_marginals
+00026250: 2c20 636f 6e74 6f75 7273 5f74 6162 6c65  , contours_table
+00026260: 7320 3d20 7365 6c66 2e72 756e 5f62 6f78  s = self.run_box
+00026270: 6573 5f66 756c 6c5f 6c61 796f 7574 2869  es_full_layout(i
+00026280: 6d61 6765 5f70 6167 652c 2074 6578 746c  mage_page, textl
+00026290: 696e 655f 6d61 736b 5f74 6f74 2c20 7465  ine_mask_tot, te
+000262a0: 7874 5f72 6567 696f 6e73 5f70 2c20 736c  xt_regions_p, sl
+000262b0: 6f70 655f 6465 736b 6577 2c20 6e75 6d5f  ope_deskew, num_
+000262c0: 636f 6c5f 636c 6173 7369 6669 6572 2c20  col_classifier, 
+000262d0: 696d 675f 6f6e 6c79 5f72 6567 696f 6e73  img_only_regions
+000262e0: 2c20 7461 626c 655f 7072 6564 6963 7469  , table_predicti
+000262f0: 6f6e 2c20 6572 6f73 696f 6e5f 6875 7274  on, erosion_hurt
+00026300: 7329 0a20 2020 2020 2020 2020 2020 2074  s).            t
+00026310: 6578 745f 6f6e 6c79 203d 2028 2869 6d67  ext_only = ((img
+00026320: 5f72 6576 6973 6564 5f74 6162 5b3a 2c20  _revised_tab[:, 
+00026330: 3a5d 203d 3d20 3129 2920 2a20 310a 2020  :] == 1)) * 1.  
+00026340: 2020 2020 2020 2020 2020 6966 206e 702e            if np.
+00026350: 6162 7328 736c 6f70 655f 6465 736b 6577  abs(slope_deskew
+00026360: 2920 3e3d 2053 4c4f 5045 5f54 4852 4553  ) >= SLOPE_THRES
+00026370: 484f 4c44 3a0a 2020 2020 2020 2020 2020  HOLD:.          
+00026380: 2020 2020 2020 7465 7874 5f6f 6e6c 795f        text_only_
+00026390: 6420 3d20 2828 7465 7874 5f72 6567 696f  d = ((text_regio
+000263a0: 6e73 5f70 5f31 5f6e 5b3a 2c20 3a5d 203d  ns_p_1_n[:, :] =
+000263b0: 3d20 3129 2920 2a20 310a 2020 2020 2020  = 1)) * 1.      
+000263c0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+000263d0: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+000263e0: 6d69 6e5f 636f 6e5f 6172 6561 203d 2030  min_con_area = 0
+000263f0: 2e30 3030 3030 350a 2020 2020 2020 2020  .000005.        
+00026400: 2020 2020 6966 206e 702e 6162 7328 736c      if np.abs(sl
+00026410: 6f70 655f 6465 736b 6577 2920 3e3d 2053  ope_deskew) >= S
+00026420: 4c4f 5045 5f54 4852 4553 484f 4c44 3a0a  LOPE_THRESHOLD:.
+00026430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026440: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
+00026450: 7874 2c20 6869 725f 6f6e 5f74 6578 7420  xt, hir_on_text 
+00026460: 3d20 7265 7475 726e 5f63 6f6e 746f 7572  = return_contour
+00026470: 735f 6f66 5f69 6d61 6765 2874 6578 745f  s_of_image(text_
+00026480: 6f6e 6c79 290a 2020 2020 2020 2020 2020  only).          
+00026490: 2020 2020 2020 636f 6e74 6f75 7273 5f6f        contours_o
+000264a0: 6e6c 795f 7465 7874 5f70 6172 656e 7420  nly_text_parent 
+000264b0: 3d20 7265 7475 726e 5f70 6172 656e 745f  = return_parent_
+000264c0: 636f 6e74 6f75 7273 2863 6f6e 746f 7572  contours(contour
+000264d0: 735f 6f6e 6c79 5f74 6578 742c 2068 6972  s_only_text, hir
+000264e0: 5f6f 6e5f 7465 7874 290a 2020 2020 2020  _on_text).      
+000264f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026500: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+00026510: 2020 2020 2020 2069 6620 6c65 6e28 636f         if len(co
+00026520: 6e74 6f75 7273 5f6f 6e6c 795f 7465 7874  ntours_only_text
+00026530: 5f70 6172 656e 7429 203e 2030 3a0a 2020  _parent) > 0:.  
+00026540: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026550: 2020 6172 6561 735f 636e 745f 7465 7874    areas_cnt_text
+00026560: 203d 206e 702e 6172 7261 7928 5b63 7632   = np.array([cv2
+00026570: 2e63 6f6e 746f 7572 4172 6561 2863 2920  .contourArea(c) 
+00026580: 666f 7220 6320 696e 2063 6f6e 746f 7572  for c in contour
+00026590: 735f 6f6e 6c79 5f74 6578 745f 7061 7265  s_only_text_pare
+000265a0: 6e74 5d29 0a20 2020 2020 2020 2020 2020  nt]).           
+000265b0: 2020 2020 2020 2020 2061 7265 6173 5f63           areas_c
+000265c0: 6e74 5f74 6578 7420 3d20 6172 6561 735f  nt_text = areas_
+000265d0: 636e 745f 7465 7874 202f 2066 6c6f 6174  cnt_text / float
+000265e0: 2874 6578 745f 6f6e 6c79 2e73 6861 7065  (text_only.shape
+000265f0: 5b30 5d20 2a20 7465 7874 5f6f 6e6c 792e  [0] * text_only.
+00026600: 7368 6170 655b 315d 290a 2020 2020 2020  shape[1]).      
+00026610: 2020 2020 2020 2020 2020 2020 2020 2373                #s
+00026620: 656c 662e 6c6f 6767 6572 2e69 6e66 6f28  elf.logger.info(
+00026630: 2761 7265 6173 5f63 6e74 5f74 6578 7420  'areas_cnt_text 
+00026640: 2573 272c 2061 7265 6173 5f63 6e74 5f74  %s', areas_cnt_t
+00026650: 6578 7429 0a20 2020 2020 2020 2020 2020  ext).           
+00026660: 2020 2020 2020 2020 2063 6f6e 746f 7572           contour
+00026670: 735f 6269 6767 6573 7420 3d20 636f 6e74  s_biggest = cont
+00026680: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
+00026690: 6172 656e 745b 6e70 2e61 7267 6d61 7828  arent[np.argmax(
+000266a0: 6172 6561 735f 636e 745f 7465 7874 295d  areas_cnt_text)]
+000266b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000266c0: 2020 2020 2063 6f6e 746f 7572 735f 6f6e       contours_on
+000266d0: 6c79 5f74 6578 745f 7061 7265 6e74 203d  ly_text_parent =
+000266e0: 205b 6320 666f 7220 6a7a 2c20 6320 696e   [c for jz, c in
+000266f0: 2065 6e75 6d65 7261 7465 2863 6f6e 746f   enumerate(conto
+00026700: 7572 735f 6f6e 6c79 5f74 6578 745f 7061  urs_only_text_pa
+00026710: 7265 6e74 2920 6966 2061 7265 6173 5f63  rent) if areas_c
+00026720: 6e74 5f74 6578 745b 6a7a 5d20 3e20 6d69  nt_text[jz] > mi
+00026730: 6e5f 636f 6e5f 6172 6561 5d0a 2020 2020  n_con_area].    
+00026740: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026750: 6172 6561 735f 636e 745f 7465 7874 5f70  areas_cnt_text_p
+00026760: 6172 656e 7420 3d20 5b61 7265 6120 666f  arent = [area fo
+00026770: 7220 6172 6561 2069 6e20 6172 6561 735f  r area in areas_
+00026780: 636e 745f 7465 7874 2069 6620 6172 6561  cnt_text if area
+00026790: 203e 206d 696e 5f63 6f6e 5f61 7265 615d   > min_con_area]
+000267a0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000267b0: 2020 2020 2069 6e64 6578 5f63 6f6e 5f70       index_con_p
+000267c0: 6172 656e 7473 203d 206e 702e 6172 6773  arents = np.args
+000267d0: 6f72 7428 6172 6561 735f 636e 745f 7465  ort(areas_cnt_te
+000267e0: 7874 5f70 6172 656e 7429 0a20 2020 2020  xt_parent).     
+000267f0: 2020 2020 2020 2020 2020 2020 2020 2063                 c
+00026800: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
+00026810: 745f 7061 7265 6e74 203d 206c 6973 7428  t_parent = list(
+00026820: 6e70 2e61 7272 6179 2863 6f6e 746f 7572  np.array(contour
+00026830: 735f 6f6e 6c79 5f74 6578 745f 7061 7265  s_only_text_pare
+00026840: 6e74 295b 696e 6465 785f 636f 6e5f 7061  nt)[index_con_pa
+00026850: 7265 6e74 735d 290a 2020 2020 2020 2020  rents]).        
+00026860: 2020 2020 2020 2020 2020 2020 6172 6561              area
+00026870: 735f 636e 745f 7465 7874 5f70 6172 656e  s_cnt_text_paren
+00026880: 7420 3d20 6c69 7374 286e 702e 6172 7261  t = list(np.arra
+00026890: 7928 6172 6561 735f 636e 745f 7465 7874  y(areas_cnt_text
+000268a0: 5f70 6172 656e 7429 5b69 6e64 6578 5f63  _parent)[index_c
+000268b0: 6f6e 5f70 6172 656e 7473 5d29 0a0a 2020  on_parents])..  
+000268c0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000268d0: 2020 6378 5f62 6967 6573 745f 6269 672c    cx_bigest_big,
+000268e0: 2063 795f 6269 6767 6573 745f 6269 672c   cy_biggest_big,
+000268f0: 205f 2c20 5f2c 205f 2c20 5f2c 205f 203d   _, _, _, _, _ =
+00026900: 2066 696e 645f 6e65 775f 6665 6174 7572   find_new_featur
+00026910: 6573 5f6f 665f 636f 6e74 6f75 7273 285b  es_of_contours([
+00026920: 636f 6e74 6f75 7273 5f62 6967 6765 7374  contours_biggest
+00026930: 5d29 0a20 2020 2020 2020 2020 2020 2020  ]).             
+00026940: 2020 2020 2020 2063 785f 6269 6765 7374         cx_bigest
+00026950: 2c20 6379 5f62 6967 6765 7374 2c20 5f2c  , cy_biggest, _,
+00026960: 205f 2c20 5f2c 205f 2c20 5f20 3d20 6669   _, _, _, _ = fi
+00026970: 6e64 5f6e 6577 5f66 6561 7475 7265 735f  nd_new_features_
+00026980: 6f66 5f63 6f6e 746f 7572 7328 636f 6e74  of_contours(cont
+00026990: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
+000269a0: 6172 656e 7429 0a0a 2020 2020 2020 2020  arent)..        
+000269b0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+000269c0: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f64  ours_only_text_d
+000269d0: 2c20 6869 725f 6f6e 5f74 6578 745f 6420  , hir_on_text_d 
+000269e0: 3d20 7265 7475 726e 5f63 6f6e 746f 7572  = return_contour
+000269f0: 735f 6f66 5f69 6d61 6765 2874 6578 745f  s_of_image(text_
+00026a00: 6f6e 6c79 5f64 290a 2020 2020 2020 2020  only_d).        
+00026a10: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00026a20: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
+00026a30: 6172 656e 745f 6420 3d20 7265 7475 726e  arent_d = return
+00026a40: 5f70 6172 656e 745f 636f 6e74 6f75 7273  _parent_contours
+00026a50: 2863 6f6e 746f 7572 735f 6f6e 6c79 5f74  (contours_only_t
+00026a60: 6578 745f 642c 2068 6972 5f6f 6e5f 7465  ext_d, hir_on_te
+00026a70: 7874 5f64 290a 0a20 2020 2020 2020 2020  xt_d)..         
+00026a80: 2020 2020 2020 2020 2020 2061 7265 6173             areas
+00026a90: 5f63 6e74 5f74 6578 745f 6420 3d20 6e70  _cnt_text_d = np
+00026aa0: 2e61 7272 6179 285b 6376 322e 636f 6e74  .array([cv2.cont
+00026ab0: 6f75 7241 7265 6128 6329 2066 6f72 2063  ourArea(c) for c
+00026ac0: 2069 6e20 636f 6e74 6f75 7273 5f6f 6e6c   in contours_onl
+00026ad0: 795f 7465 7874 5f70 6172 656e 745f 645d  y_text_parent_d]
+00026ae0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00026af0: 2020 2020 2020 6172 6561 735f 636e 745f        areas_cnt_
+00026b00: 7465 7874 5f64 203d 2061 7265 6173 5f63  text_d = areas_c
+00026b10: 6e74 5f74 6578 745f 6420 2f20 666c 6f61  nt_text_d / floa
+00026b20: 7428 7465 7874 5f6f 6e6c 795f 642e 7368  t(text_only_d.sh
+00026b30: 6170 655b 305d 202a 2074 6578 745f 6f6e  ape[0] * text_on
+00026b40: 6c79 5f64 2e73 6861 7065 5b31 5d29 0a20  ly_d.shape[1]). 
+00026b50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026b60: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+00026b70: 2020 2020 2020 2020 6966 206c 656e 2861          if len(a
+00026b80: 7265 6173 5f63 6e74 5f74 6578 745f 6429  reas_cnt_text_d)
+00026b90: 3e30 3a0a 2020 2020 2020 2020 2020 2020  >0:.            
+00026ba0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+00026bb0: 6f75 7273 5f62 6967 6765 7374 5f64 203d  ours_biggest_d =
+00026bc0: 2063 6f6e 746f 7572 735f 6f6e 6c79 5f74   contours_only_t
+00026bd0: 6578 745f 7061 7265 6e74 5f64 5b6e 702e  ext_parent_d[np.
+00026be0: 6172 676d 6178 2861 7265 6173 5f63 6e74  argmax(areas_cnt
+00026bf0: 5f74 6578 745f 6429 5d0a 2020 2020 2020  _text_d)].      
+00026c00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026c10: 2020 696e 6465 785f 636f 6e5f 7061 7265    index_con_pare
+00026c20: 6e74 735f 6420 3d20 6e70 2e61 7267 736f  nts_d = np.argso
+00026c30: 7274 2861 7265 6173 5f63 6e74 5f74 6578  rt(areas_cnt_tex
+00026c40: 745f 6429 0a20 2020 2020 2020 2020 2020  t_d).           
+00026c50: 2020 2020 2020 2020 2020 2020 2063 6f6e               con
+00026c60: 746f 7572 735f 6f6e 6c79 5f74 6578 745f  tours_only_text_
+00026c70: 7061 7265 6e74 5f64 203d 206c 6973 7428  parent_d = list(
+00026c80: 6e70 2e61 7272 6179 2863 6f6e 746f 7572  np.array(contour
+00026c90: 735f 6f6e 6c79 5f74 6578 745f 7061 7265  s_only_text_pare
+00026ca0: 6e74 5f64 295b 696e 6465 785f 636f 6e5f  nt_d)[index_con_
+00026cb0: 7061 7265 6e74 735f 645d 290a 2020 2020  parents_d]).    
+00026cc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026cd0: 2020 2020 6172 6561 735f 636e 745f 7465      areas_cnt_te
+00026ce0: 7874 5f64 203d 206c 6973 7428 6e70 2e61  xt_d = list(np.a
+00026cf0: 7272 6179 2861 7265 6173 5f63 6e74 5f74  rray(areas_cnt_t
+00026d00: 6578 745f 6429 5b69 6e64 6578 5f63 6f6e  ext_d)[index_con
+00026d10: 5f70 6172 656e 7473 5f64 5d29 0a0a 2020  _parents_d])..  
+00026d20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026d30: 2020 2020 2020 6378 5f62 6967 6573 745f        cx_bigest_
+00026d40: 645f 6269 672c 2063 795f 6269 6767 6573  d_big, cy_bigges
+00026d50: 745f 645f 6269 672c 205f 2c20 5f2c 205f  t_d_big, _, _, _
+00026d60: 2c20 5f2c 205f 203d 2066 696e 645f 6e65  , _, _ = find_ne
+00026d70: 775f 6665 6174 7572 6573 5f6f 665f 636f  w_features_of_co
+00026d80: 6e74 6f75 7273 285b 636f 6e74 6f75 7273  ntours([contours
+00026d90: 5f62 6967 6765 7374 5f64 5d29 0a20 2020  _biggest_d]).   
+00026da0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026db0: 2020 2020 2063 785f 6269 6765 7374 5f64       cx_bigest_d
+00026dc0: 2c20 6379 5f62 6967 6765 7374 5f64 2c20  , cy_biggest_d, 
+00026dd0: 5f2c 205f 2c20 5f2c 205f 2c20 5f20 3d20  _, _, _, _, _ = 
+00026de0: 6669 6e64 5f6e 6577 5f66 6561 7475 7265  find_new_feature
+00026df0: 735f 6f66 5f63 6f6e 746f 7572 7328 636f  s_of_contours(co
+00026e00: 6e74 6f75 7273 5f6f 6e6c 795f 7465 7874  ntours_only_text
+00026e10: 5f70 6172 656e 745f 6429 0a20 2020 2020  _parent_d).     
+00026e20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026e30: 2020 2074 7279 3a0a 2020 2020 2020 2020     try:.        
+00026e40: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026e50: 2020 2020 6966 206c 656e 2863 785f 6269      if len(cx_bi
+00026e60: 6765 7374 5f64 2920 3e3d 2035 3a0a 2020  gest_d) >= 5:.  
+00026e70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026e80: 2020 2020 2020 2020 2020 2020 2020 6378                cx
+00026e90: 5f62 6967 6573 745f 645f 6c61 7374 3520  _bigest_d_last5 
+00026ea0: 3d20 6378 5f62 6967 6573 745f 645b 2d35  = cx_bigest_d[-5
+00026eb0: 3a5d 0a20 2020 2020 2020 2020 2020 2020  :].             
+00026ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026ed0: 2020 2063 795f 6269 6767 6573 745f 645f     cy_biggest_d_
+00026ee0: 6c61 7374 3520 3d20 6379 5f62 6967 6765  last5 = cy_bigge
+00026ef0: 7374 5f64 5b2d 353a 5d0a 2020 2020 2020  st_d[-5:].      
+00026f00: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026f10: 2020 2020 2020 2020 2020 6469 7374 735f            dists_
+00026f20: 6420 3d20 5b6d 6174 682e 7371 7274 2828  d = [math.sqrt((
+00026f30: 6378 5f62 6967 6573 745f 6269 675b 305d  cx_bigest_big[0]
+00026f40: 202d 2063 785f 6269 6765 7374 5f64 5f6c   - cx_bigest_d_l
+00026f50: 6173 7435 5b6a 5d29 202a 2a20 3220 2b20  ast5[j]) ** 2 + 
+00026f60: 2863 795f 6269 6767 6573 745f 6269 675b  (cy_biggest_big[
+00026f70: 305d 202d 2063 795f 6269 6767 6573 745f  0] - cy_biggest_
+00026f80: 645f 6c61 7374 355b 6a5d 2920 2a2a 2032  d_last5[j]) ** 2
+00026f90: 2920 666f 7220 6a20 696e 2072 616e 6765  ) for j in range
+00026fa0: 286c 656e 2863 795f 6269 6767 6573 745f  (len(cy_biggest_
+00026fb0: 645f 6c61 7374 3529 295d 0a20 2020 2020  d_last5))].     
+00026fc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00026fd0: 2020 2020 2020 2020 2020 2069 6e64 5f6c             ind_l
+00026fe0: 6172 6765 7374 203d 206c 656e 2863 785f  argest = len(cx_
+00026ff0: 6269 6765 7374 5f64 2920 2d35 202b 206e  bigest_d) -5 + n
+00027000: 702e 6172 676d 696e 2864 6973 7473 5f64  p.argmin(dists_d
+00027010: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00027020: 2020 2020 2020 2020 2020 2020 2020 656c                el
+00027030: 7365 3a0a 2020 2020 2020 2020 2020 2020  se:.            
+00027040: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027050: 2020 2020 6378 5f62 6967 6573 745f 645f      cx_bigest_d_
+00027060: 6c61 7374 3520 3d20 6378 5f62 6967 6573  last5 = cx_biges
+00027070: 745f 645b 2d6c 656e 2863 785f 6269 6765  t_d[-len(cx_bige
+00027080: 7374 5f64 293a 5d0a 2020 2020 2020 2020  st_d):].        
+00027090: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000270a0: 2020 2020 2020 2020 6379 5f62 6967 6765          cy_bigge
+000270b0: 7374 5f64 5f6c 6173 7435 203d 2063 795f  st_d_last5 = cy_
+000270c0: 6269 6767 6573 745f 645b 2d6c 656e 2863  biggest_d[-len(c
+000270d0: 785f 6269 6765 7374 5f64 293a 5d0a 2020  x_bigest_d):].  
+000270e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000270f0: 2020 2020 2020 2020 2020 2020 2020 6469                di
+00027100: 7374 735f 6420 3d20 5b6d 6174 682e 7371  sts_d = [math.sq
+00027110: 7274 2828 6378 5f62 6967 6573 745f 6269  rt((cx_bigest_bi
+00027120: 675b 305d 2d63 785f 6269 6765 7374 5f64  g[0]-cx_bigest_d
+00027130: 5f6c 6173 7435 5b6a 5d29 2a2a 3220 2b20  _last5[j])**2 + 
+00027140: 2863 795f 6269 6767 6573 745f 6269 675b  (cy_biggest_big[
+00027150: 305d 2d63 795f 6269 6767 6573 745f 645f  0]-cy_biggest_d_
+00027160: 6c61 7374 355b 6a5d 292a 2a32 2920 666f  last5[j])**2) fo
+00027170: 7220 6a20 696e 2072 616e 6765 286c 656e  r j in range(len
+00027180: 2863 795f 6269 6767 6573 745f 645f 6c61  (cy_biggest_d_la
+00027190: 7374 3529 295d 0a20 2020 2020 2020 2020  st5))].         
+000271a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000271b0: 2020 2020 2020 2069 6e64 5f6c 6172 6765         ind_large
+000271c0: 7374 203d 206c 656e 2863 785f 6269 6765  st = len(cx_bige
+000271d0: 7374 5f64 2920 2d20 6c65 6e28 6378 5f62  st_d) - len(cx_b
+000271e0: 6967 6573 745f 6429 202b 206e 702e 6172  igest_d) + np.ar
+000271f0: 676d 696e 2864 6973 7473 5f64 290a 2020  gmin(dists_d).  
+00027200: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027210: 2020 2020 2020 2020 2020 2020 2020 0a20                . 
+00027220: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027230: 2020 2020 2020 2020 2020 2063 785f 6269             cx_bi
+00027240: 6765 7374 5f64 5f62 6967 5b30 5d20 3d20  gest_d_big[0] = 
+00027250: 6378 5f62 6967 6573 745f 645b 696e 645f  cx_bigest_d[ind_
+00027260: 6c61 7267 6573 745d 0a20 2020 2020 2020  largest].       
+00027270: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027280: 2020 2020 2063 795f 6269 6767 6573 745f       cy_biggest_
+00027290: 645f 6269 675b 305d 203d 2063 795f 6269  d_big[0] = cy_bi
+000272a0: 6767 6573 745f 645b 696e 645f 6c61 7267  ggest_d[ind_larg
+000272b0: 6573 745d 0a20 2020 2020 2020 2020 2020  est].           
+000272c0: 2020 2020 2020 2020 2020 2020 2065 7863               exc
+000272d0: 6570 7420 4578 6365 7074 696f 6e20 6173  ept Exception as
+000272e0: 2077 6879 3a0a 2020 2020 2020 2020 2020   why:.          
+000272f0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027300: 2020 7365 6c66 2e6c 6f67 6765 722e 6572    self.logger.er
+00027310: 726f 7228 7768 7929 0a0a 2020 2020 2020  ror(why)..      
+00027320: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027330: 2020 2868 2c20 7729 203d 2074 6578 745f    (h, w) = text_
+00027340: 6f6e 6c79 2e73 6861 7065 5b3a 325d 0a20  only.shape[:2]. 
+00027350: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027360: 2020 2020 2020 2063 656e 7465 7220 3d20         center = 
+00027370: 2877 202f 2f20 322e 302c 2068 202f 2f20  (w // 2.0, h // 
+00027380: 322e 3029 0a20 2020 2020 2020 2020 2020  2.0).           
+00027390: 2020 2020 2020 2020 2020 2020 204d 203d               M =
+000273a0: 2063 7632 2e67 6574 526f 7461 7469 6f6e   cv2.getRotation
+000273b0: 4d61 7472 6978 3244 2863 656e 7465 722c  Matrix2D(center,
+000273c0: 2073 6c6f 7065 5f64 6573 6b65 772c 2031   slope_deskew, 1
+000273d0: 2e30 290a 2020 2020 2020 2020 2020 2020  .0).            
+000273e0: 2020 2020 2020 2020 2020 2020 4d5f 3232              M_22
+000273f0: 203d 206e 702e 6172 7261 7928 4d29 5b3a   = np.array(M)[:
+00027400: 322c 203a 325d 0a20 2020 2020 2020 2020  2, :2].         
+00027410: 2020 2020 2020 2020 2020 2020 2020 2070                 p
+00027420: 5f62 6967 203d 206e 702e 646f 7428 4d5f  _big = np.dot(M_
+00027430: 3232 2c20 5b63 785f 6269 6765 7374 5f62  22, [cx_bigest_b
+00027440: 6967 2c20 6379 5f62 6967 6765 7374 5f62  ig, cy_biggest_b
+00027450: 6967 5d29 0a20 2020 2020 2020 2020 2020  ig]).           
+00027460: 2020 2020 2020 2020 2020 2020 2078 5f64               x_d
+00027470: 6966 6620 3d20 705f 6269 675b 305d 202d  iff = p_big[0] -
+00027480: 2063 785f 6269 6765 7374 5f64 5f62 6967   cx_bigest_d_big
+00027490: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000274a0: 2020 2020 2020 2020 2079 5f64 6966 6620           y_diff 
+000274b0: 3d20 705f 6269 675b 315d 202d 2063 795f  = p_big[1] - cy_
+000274c0: 6269 6767 6573 745f 645f 6269 670a 0a20  biggest_d_big.. 
+000274d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000274e0: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
+000274f0: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
+00027500: 5f64 5f6f 7264 6572 6564 203d 205b 5d0a  _d_ordered = [].
+00027510: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027520: 2020 2020 2020 2020 666f 7220 6920 696e          for i in
+00027530: 2072 616e 6765 286c 656e 2863 6f6e 746f   range(len(conto
+00027540: 7572 735f 6f6e 6c79 5f74 6578 745f 7061  urs_only_text_pa
+00027550: 7265 6e74 2929 3a0a 2020 2020 2020 2020  rent)):.        
+00027560: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027570: 2020 2020 7020 3d20 6e70 2e64 6f74 284d      p = np.dot(M
+00027580: 5f32 322c 205b 6378 5f62 6967 6573 745b  _22, [cx_bigest[
+00027590: 695d 2c20 6379 5f62 6967 6765 7374 5b69  i], cy_biggest[i
+000275a0: 5d5d 290a 2020 2020 2020 2020 2020 2020  ]]).            
+000275b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000275c0: 705b 305d 203d 2070 5b30 5d20 2d20 785f  p[0] = p[0] - x_
+000275d0: 6469 6666 5b30 5d0a 2020 2020 2020 2020  diff[0].        
+000275e0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000275f0: 2020 2020 705b 315d 203d 2070 5b31 5d20      p[1] = p[1] 
+00027600: 2d20 795f 6469 6666 5b30 5d0a 2020 2020  - y_diff[0].    
+00027610: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027620: 2020 2020 2020 2020 6469 7374 7320 3d20          dists = 
+00027630: 5b6d 6174 682e 7371 7274 2828 705b 305d  [math.sqrt((p[0]
+00027640: 202d 2063 785f 6269 6765 7374 5f64 5b6a   - cx_bigest_d[j
+00027650: 5d29 202a 2a20 3220 2b20 2870 5b31 5d20  ]) ** 2 + (p[1] 
+00027660: 2d20 6379 5f62 6967 6765 7374 5f64 5b6a  - cy_biggest_d[j
+00027670: 5d29 202a 2a20 3229 2066 6f72 206a 2069  ]) ** 2) for j i
+00027680: 6e20 7261 6e67 6528 6c65 6e28 6378 5f62  n range(len(cx_b
+00027690: 6967 6573 745f 6429 295d 0a20 2020 2020  igest_d))].     
+000276a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000276b0: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
+000276c0: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
+000276d0: 5f64 5f6f 7264 6572 6564 2e61 7070 656e  _d_ordered.appen
+000276e0: 6428 636f 6e74 6f75 7273 5f6f 6e6c 795f  d(contours_only_
+000276f0: 7465 7874 5f70 6172 656e 745f 645b 6e70  text_parent_d[np
+00027700: 2e61 7267 6d69 6e28 6469 7374 7329 5d29  .argmin(dists)])
+00027710: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027720: 2020 2020 2020 2020 2020 2020 2023 2069               # i
+00027730: 6d67 323d 6e70 2e7a 6572 6f73 2828 7465  mg2=np.zeros((te
+00027740: 7874 5f6f 6e6c 792e 7368 6170 655b 305d  xt_only.shape[0]
+00027750: 2c74 6578 745f 6f6e 6c79 2e73 6861 7065  ,text_only.shape
+00027760: 5b31 5d2c 3329 290a 2020 2020 2020 2020  [1],3)).        
+00027770: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027780: 2020 2020 2320 696d 6732 3d63 7632 2e66      # img2=cv2.f
+00027790: 696c 6c50 6f6c 7928 696d 6732 2c70 7473  illPoly(img2,pts
+000277a0: 3d5b 636f 6e74 6f75 7273 5f6f 6e6c 795f  =[contours_only_
+000277b0: 7465 7874 5f70 6172 656e 745f 645b 6e70  text_parent_d[np
+000277c0: 2e61 7267 6d69 6e28 6469 7374 7329 5d5d  .argmin(dists)]]
+000277d0: 202c 636f 6c6f 723d 2831 2c31 2c31 2929   ,color=(1,1,1))
+000277e0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000277f0: 2020 2020 2020 2020 2020 2020 2023 2070               # p
+00027800: 6c74 2e69 6d73 686f 7728 696d 6732 5b3a  lt.imshow(img2[:
+00027810: 2c3a 2c30 5d29 0a20 2020 2020 2020 2020  ,:,0]).         
+00027820: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027830: 2020 2023 2070 6c74 2e73 686f 7728 290a     # plt.show().
+00027840: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027850: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00027860: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027870: 2020 636f 6e74 6f75 7273 5f6f 6e6c 795f    contours_only_
+00027880: 7465 7874 5f70 6172 656e 745f 645f 6f72  text_parent_d_or
+00027890: 6465 7265 6420 3d20 5b5d 0a20 2020 2020  dered = [].     
+000278a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000278b0: 2020 2063 6f6e 746f 7572 735f 6f6e 6c79     contours_only
+000278c0: 5f74 6578 745f 7061 7265 6e74 5f64 203d  _text_parent_d =
+000278d0: 205b 5d0a 2020 2020 2020 2020 2020 2020   [].            
+000278e0: 2020 2020 2020 2020 2020 2020 636f 6e74              cont
+000278f0: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
+00027900: 6172 656e 7420 3d20 5b5d 0a20 2020 2020  arent = [].     
+00027910: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027920: 2020 200a 2020 2020 2020 2020 2020 2020     .            
+00027930: 2020 2020 656c 7365 3a0a 2020 2020 2020      else:.      
+00027940: 2020 2020 2020 2020 2020 2020 2020 636f                co
+00027950: 6e74 6f75 7273 5f6f 6e6c 795f 7465 7874  ntours_only_text
+00027960: 5f70 6172 656e 745f 645f 6f72 6465 7265  _parent_d_ordere
+00027970: 6420 3d20 5b5d 0a20 2020 2020 2020 2020  d = [].         
+00027980: 2020 2020 2020 2020 2020 2063 6f6e 746f             conto
+00027990: 7572 735f 6f6e 6c79 5f74 6578 745f 7061  urs_only_text_pa
+000279a0: 7265 6e74 5f64 203d 205b 5d0a 2020 2020  rent_d = [].    
+000279b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000279c0: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
+000279d0: 7874 5f70 6172 656e 7420 3d20 5b5d 0a20  xt_parent = []. 
+000279e0: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+000279f0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00027a00: 2063 6f6e 746f 7572 735f 6f6e 6c79 5f74   contours_only_t
+00027a10: 6578 742c 2068 6972 5f6f 6e5f 7465 7874  ext, hir_on_text
+00027a20: 203d 2072 6574 7572 6e5f 636f 6e74 6f75   = return_contou
+00027a30: 7273 5f6f 665f 696d 6167 6528 7465 7874  rs_of_image(text
+00027a40: 5f6f 6e6c 7929 0a20 2020 2020 2020 2020  _only).         
+00027a50: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
+00027a60: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
+00027a70: 203d 2072 6574 7572 6e5f 7061 7265 6e74   = return_parent
+00027a80: 5f63 6f6e 746f 7572 7328 636f 6e74 6f75  _contours(contou
+00027a90: 7273 5f6f 6e6c 795f 7465 7874 2c20 6869  rs_only_text, hi
+00027aa0: 725f 6f6e 5f74 6578 7429 0a20 2020 2020  r_on_text).     
+00027ab0: 2020 2020 2020 2020 2020 200a 2020 2020             .    
+00027ac0: 2020 2020 2020 2020 2020 2020 6966 206c              if l
+00027ad0: 656e 2863 6f6e 746f 7572 735f 6f6e 6c79  en(contours_only
+00027ae0: 5f74 6578 745f 7061 7265 6e74 2920 3e20  _text_parent) > 
+00027af0: 303a 0a20 2020 2020 2020 2020 2020 2020  0:.             
+00027b00: 2020 2020 2020 2061 7265 6173 5f63 6e74         areas_cnt
+00027b10: 5f74 6578 7420 3d20 6e70 2e61 7272 6179  _text = np.array
+00027b20: 285b 6376 322e 636f 6e74 6f75 7241 7265  ([cv2.contourAre
+00027b30: 6128 6329 2066 6f72 2063 2069 6e20 636f  a(c) for c in co
+00027b40: 6e74 6f75 7273 5f6f 6e6c 795f 7465 7874  ntours_only_text
+00027b50: 5f70 6172 656e 745d 290a 2020 2020 2020  _parent]).      
+00027b60: 2020 2020 2020 2020 2020 2020 2020 6172                ar
+00027b70: 6561 735f 636e 745f 7465 7874 203d 2061  eas_cnt_text = a
+00027b80: 7265 6173 5f63 6e74 5f74 6578 7420 2f20  reas_cnt_text / 
+00027b90: 666c 6f61 7428 7465 7874 5f6f 6e6c 792e  float(text_only.
+00027ba0: 7368 6170 655b 305d 202a 2074 6578 745f  shape[0] * text_
+00027bb0: 6f6e 6c79 2e73 6861 7065 5b31 5d29 0a0a  only.shape[1])..
+00027bc0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027bd0: 2020 2020 636f 6e74 6f75 7273 5f62 6967      contours_big
+00027be0: 6765 7374 203d 2063 6f6e 746f 7572 735f  gest = contours_
+00027bf0: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
+00027c00: 5b6e 702e 6172 676d 6178 2861 7265 6173  [np.argmax(areas
+00027c10: 5f63 6e74 5f74 6578 7429 5d0a 2020 2020  _cnt_text)].    
+00027c20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027c30: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
+00027c40: 7874 5f70 6172 656e 7420 3d20 5b63 2066  xt_parent = [c f
+00027c50: 6f72 206a 7a2c 2063 2069 6e20 656e 756d  or jz, c in enum
+00027c60: 6572 6174 6528 636f 6e74 6f75 7273 5f6f  erate(contours_o
+00027c70: 6e6c 795f 7465 7874 5f70 6172 656e 7429  nly_text_parent)
+00027c80: 2069 6620 6172 6561 735f 636e 745f 7465   if areas_cnt_te
+00027c90: 7874 5b6a 7a5d 203e 206d 696e 5f63 6f6e  xt[jz] > min_con
+00027ca0: 5f61 7265 615d 0a20 2020 2020 2020 2020  _area].         
+00027cb0: 2020 2020 2020 2020 2020 2061 7265 6173             areas
+00027cc0: 5f63 6e74 5f74 6578 745f 7061 7265 6e74  _cnt_text_parent
+00027cd0: 203d 205b 6172 6561 2066 6f72 2061 7265   = [area for are
+00027ce0: 6120 696e 2061 7265 6173 5f63 6e74 5f74  a in areas_cnt_t
+00027cf0: 6578 7420 6966 2061 7265 6120 3e20 6d69  ext if area > mi
+00027d00: 6e5f 636f 6e5f 6172 6561 5d0a 0a20 2020  n_con_area]..   
+00027d10: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027d20: 2069 6e64 6578 5f63 6f6e 5f70 6172 656e   index_con_paren
+00027d30: 7473 203d 206e 702e 6172 6773 6f72 7428  ts = np.argsort(
+00027d40: 6172 6561 735f 636e 745f 7465 7874 5f70  areas_cnt_text_p
+00027d50: 6172 656e 7429 0a20 2020 2020 2020 2020  arent).         
+00027d60: 2020 2020 2020 2020 2020 2063 6f6e 746f             conto
+00027d70: 7572 735f 6f6e 6c79 5f74 6578 745f 7061  urs_only_text_pa
+00027d80: 7265 6e74 203d 206c 6973 7428 6e70 2e61  rent = list(np.a
+00027d90: 7272 6179 2863 6f6e 746f 7572 735f 6f6e  rray(contours_on
+00027da0: 6c79 5f74 6578 745f 7061 7265 6e74 295b  ly_text_parent)[
+00027db0: 696e 6465 785f 636f 6e5f 7061 7265 6e74  index_con_parent
+00027dc0: 735d 290a 2020 2020 2020 2020 2020 2020  s]).            
+00027dd0: 2020 2020 2020 2020 6172 6561 735f 636e          areas_cn
+00027de0: 745f 7465 7874 5f70 6172 656e 7420 3d20  t_text_parent = 
+00027df0: 6c69 7374 286e 702e 6172 7261 7928 6172  list(np.array(ar
+00027e00: 6561 735f 636e 745f 7465 7874 5f70 6172  eas_cnt_text_par
+00027e10: 656e 7429 5b69 6e64 6578 5f63 6f6e 5f70  ent)[index_con_p
+00027e20: 6172 656e 7473 5d29 0a0a 2020 2020 2020  arents])..      
+00027e30: 2020 2020 2020 2020 2020 2020 2020 6378                cx
+00027e40: 5f62 6967 6573 745f 6269 672c 2063 795f  _bigest_big, cy_
+00027e50: 6269 6767 6573 745f 6269 672c 205f 2c20  biggest_big, _, 
+00027e60: 5f2c 205f 2c20 5f2c 205f 203d 2066 696e  _, _, _, _ = fin
+00027e70: 645f 6e65 775f 6665 6174 7572 6573 5f6f  d_new_features_o
+00027e80: 665f 636f 6e74 6f75 7273 285b 636f 6e74  f_contours([cont
+00027e90: 6f75 7273 5f62 6967 6765 7374 5d29 0a20  ours_biggest]). 
+00027ea0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027eb0: 2020 2063 785f 6269 6765 7374 2c20 6379     cx_bigest, cy
+00027ec0: 5f62 6967 6765 7374 2c20 5f2c 205f 2c20  _biggest, _, _, 
+00027ed0: 5f2c 205f 2c20 5f20 3d20 6669 6e64 5f6e  _, _, _ = find_n
+00027ee0: 6577 5f66 6561 7475 7265 735f 6f66 5f63  ew_features_of_c
+00027ef0: 6f6e 746f 7572 7328 636f 6e74 6f75 7273  ontours(contours
+00027f00: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
+00027f10: 7429 0a20 2020 2020 2020 2020 2020 2020  t).             
+00027f20: 2020 2020 2020 2023 7365 6c66 2e6c 6f67         #self.log
+00027f30: 6765 722e 6465 6275 6728 2761 7265 6173  ger.debug('areas
+00027f40: 5f63 6e74 5f74 6578 745f 7061 7265 6e74  _cnt_text_parent
+00027f50: 2025 7327 2c20 6172 6561 735f 636e 745f   %s', areas_cnt_
+00027f60: 7465 7874 5f70 6172 656e 7429 0a20 2020  text_parent).   
+00027f70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027f80: 2023 2073 656c 662e 6c6f 6767 6572 2e64   # self.logger.d
+00027f90: 6562 7567 2827 6172 6561 735f 636e 745f  ebug('areas_cnt_
+00027fa0: 7465 7874 5f70 6172 656e 745f 6420 2573  text_parent_d %s
+00027fb0: 272c 2061 7265 6173 5f63 6e74 5f74 6578  ', areas_cnt_tex
+00027fc0: 745f 7061 7265 6e74 5f64 290a 2020 2020  t_parent_d).    
+00027fd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00027fe0: 2320 7365 6c66 2e6c 6f67 6765 722e 6465  # self.logger.de
+00027ff0: 6275 6728 276c 656e 2863 6f6e 746f 7572  bug('len(contour
+00028000: 735f 6f6e 6c79 5f74 6578 745f 7061 7265  s_only_text_pare
+00028010: 6e74 2920 2573 272c 206c 656e 2863 6f6e  nt) %s', len(con
+00028020: 746f 7572 735f 6f6e 6c79 5f74 6578 745f  tours_only_text_
+00028030: 7061 7265 6e74 5f64 2929 0a20 2020 2020  parent_d)).     
+00028040: 2020 2020 2020 2020 2020 2065 6c73 653a             else:
+00028050: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028060: 2020 2020 2070 6173 730a 2020 2020 2020       pass.      
+00028070: 2020 2020 2020 6966 2073 656c 662e 6c69        if self.li
+00028080: 6768 745f 7665 7273 696f 6e3a 0a20 2020  ght_version:.   
+00028090: 2020 2020 2020 2020 2020 2020 2074 7874               txt
+000280a0: 5f63 6f6e 5f6f 7267 203d 2067 6574 5f74  _con_org = get_t
+000280b0: 6578 7472 6567 696f 6e5f 636f 6e74 6f75  extregion_contou
+000280c0: 7273 5f69 6e5f 6f72 675f 696d 6167 655f  rs_in_org_image_
+000280d0: 6c69 6768 7428 636f 6e74 6f75 7273 5f6f  light(contours_o
+000280e0: 6e6c 795f 7465 7874 5f70 6172 656e 742c  nly_text_parent,
+000280f0: 2073 656c 662e 696d 6167 652c 2073 6c6f   self.image, slo
+00028100: 7065 5f66 6972 7374 290a 2020 2020 2020  pe_first).      
+00028110: 2020 2020 2020 656c 7365 3a0a 2020 2020        else:.    
+00028120: 2020 2020 2020 2020 2020 2020 7478 745f              txt_
+00028130: 636f 6e5f 6f72 6720 3d20 6765 745f 7465  con_org = get_te
+00028140: 7874 7265 6769 6f6e 5f63 6f6e 746f 7572  xtregion_contour
+00028150: 735f 696e 5f6f 7267 5f69 6d61 6765 2863  s_in_org_image(c
+00028160: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
+00028170: 745f 7061 7265 6e74 2c20 7365 6c66 2e69  t_parent, self.i
+00028180: 6d61 6765 2c20 736c 6f70 655f 6669 7273  mage, slope_firs
+00028190: 7429 0a20 2020 2020 2020 2020 2020 2062  t).            b
+000281a0: 6f78 6573 5f74 6578 742c 205f 203d 2067  oxes_text, _ = g
+000281b0: 6574 5f74 6578 745f 7265 6769 6f6e 5f62  et_text_region_b
+000281c0: 6f78 6573 5f62 795f 6769 7665 6e5f 636f  oxes_by_given_co
+000281d0: 6e74 6f75 7273 2863 6f6e 746f 7572 735f  ntours(contours_
+000281e0: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
+000281f0: 290a 2020 2020 2020 2020 2020 2020 626f  ).            bo
+00028200: 7865 735f 6d61 7267 696e 616c 732c 205f  xes_marginals, _
+00028210: 203d 2067 6574 5f74 6578 745f 7265 6769   = get_text_regi
+00028220: 6f6e 5f62 6f78 6573 5f62 795f 6769 7665  on_boxes_by_give
+00028230: 6e5f 636f 6e74 6f75 7273 2870 6f6c 7967  n_contours(polyg
+00028240: 6f6e 735f 6f66 5f6d 6172 6769 6e61 6c73  ons_of_marginals
+00028250: 290a 2020 2020 2020 2020 2020 2020 0a20  ).            . 
+00028260: 2020 2020 2020 2020 2020 2069 6620 6e6f             if no
+00028270: 7420 7365 6c66 2e63 7572 7665 645f 6c69  t self.curved_li
+00028280: 6e65 3a0a 2020 2020 2020 2020 2020 2020  ne:.            
+00028290: 2020 2020 6966 2073 656c 662e 6c69 6768      if self.ligh
+000282a0: 745f 7665 7273 696f 6e3a 0a20 2020 2020  t_version:.     
+000282b0: 2020 2020 2020 2020 2020 2020 2020 2069                 i
+000282c0: 6620 7365 6c66 2e74 6578 746c 696e 655f  f self.textline_
+000282d0: 6c69 6768 743a 0a20 2020 2020 2020 2020  light:.         
+000282e0: 2020 2020 2020 2020 2020 2020 2020 2073                 s
+000282f0: 6c6f 7065 732c 2061 6c6c 5f66 6f75 6e64  lopes, all_found
+00028300: 5f74 6578 6c69 6e65 5f70 6f6c 7967 6f6e  _texline_polygon
+00028310: 732c 2062 6f78 6573 5f74 6578 742c 2074  s, boxes_text, t
+00028320: 7874 5f63 6f6e 5f6f 7267 2c20 636f 6e74  xt_con_org, cont
+00028330: 6f75 7273 5f6f 6e6c 795f 7465 7874 5f70  ours_only_text_p
+00028340: 6172 656e 742c 2061 6c6c 5f62 6f78 5f63  arent, all_box_c
+00028350: 6f6f 7264 2c20 696e 6465 785f 6279 5f74  oord, index_by_t
+00028360: 6578 745f 7061 725f 636f 6e20 3d20 7365  ext_par_con = se
+00028370: 6c66 2e67 6574 5f73 6c6f 7065 735f 616e  lf.get_slopes_an
+00028380: 645f 6465 736b 6577 5f6e 6577 5f6c 6967  d_deskew_new_lig
+00028390: 6874 2874 7874 5f63 6f6e 5f6f 7267 2c20  ht(txt_con_org, 
+000283a0: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
+000283b0: 7874 5f70 6172 656e 742c 2074 6578 746c  xt_parent, textl
+000283c0: 696e 655f 6d61 736b 5f74 6f74 5f65 615f  ine_mask_tot_ea_
+000283d0: 6f72 672c 2069 6d61 6765 5f70 6167 655f  org, image_page_
+000283e0: 726f 7461 7465 642c 2062 6f78 6573 5f74  rotated, boxes_t
+000283f0: 6578 742c 2073 6c6f 7065 5f64 6573 6b65  ext, slope_deske
+00028400: 7729 0a20 2020 2020 2020 2020 2020 2020  w).             
+00028410: 2020 2020 2020 2020 2020 2073 6c6f 7065             slope
+00028420: 735f 6d61 7267 696e 616c 732c 2061 6c6c  s_marginals, all
+00028430: 5f66 6f75 6e64 5f74 6578 6c69 6e65 5f70  _found_texline_p
+00028440: 6f6c 7967 6f6e 735f 6d61 7267 696e 616c  olygons_marginal
+00028450: 732c 2062 6f78 6573 5f6d 6172 6769 6e61  s, boxes_margina
+00028460: 6c73 2c20 5f2c 2070 6f6c 7967 6f6e 735f  ls, _, polygons_
+00028470: 6f66 5f6d 6172 6769 6e61 6c73 2c20 616c  of_marginals, al
+00028480: 6c5f 626f 785f 636f 6f72 645f 6d61 7267  l_box_coord_marg
+00028490: 696e 616c 732c 205f 203d 2073 656c 662e  inals, _ = self.
+000284a0: 6765 745f 736c 6f70 6573 5f61 6e64 5f64  get_slopes_and_d
+000284b0: 6573 6b65 775f 6e65 775f 6c69 6768 7428  eskew_new_light(
+000284c0: 706f 6c79 676f 6e73 5f6f 665f 6d61 7267  polygons_of_marg
+000284d0: 696e 616c 732c 2070 6f6c 7967 6f6e 735f  inals, polygons_
+000284e0: 6f66 5f6d 6172 6769 6e61 6c73 2c20 7465  of_marginals, te
+000284f0: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745f  xtline_mask_tot_
+00028500: 6561 5f6f 7267 2c20 696d 6167 655f 7061  ea_org, image_pa
+00028510: 6765 5f72 6f74 6174 6564 2c20 626f 7865  ge_rotated, boxe
+00028520: 735f 6d61 7267 696e 616c 732c 2073 6c6f  s_marginals, slo
+00028530: 7065 5f64 6573 6b65 7729 0a20 2020 2020  pe_deskew).     
+00028540: 2020 2020 2020 2020 2020 2020 2020 2065                 e
+00028550: 6c73 653a 0a20 2020 2020 2020 2020 2020  lse:.           
+00028560: 2020 2020 2020 2020 2020 2020 2073 6c6f               slo
+00028570: 7065 732c 2061 6c6c 5f66 6f75 6e64 5f74  pes, all_found_t
+00028580: 6578 6c69 6e65 5f70 6f6c 7967 6f6e 732c  exline_polygons,
+00028590: 2062 6f78 6573 5f74 6578 742c 2074 7874   boxes_text, txt
+000285a0: 5f63 6f6e 5f6f 7267 2c20 636f 6e74 6f75  _con_org, contou
+000285b0: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
+000285c0: 656e 742c 2061 6c6c 5f62 6f78 5f63 6f6f  ent, all_box_coo
+000285d0: 7264 2c20 696e 6465 785f 6279 5f74 6578  rd, index_by_tex
+000285e0: 745f 7061 725f 636f 6e20 3d20 7365 6c66  t_par_con = self
+000285f0: 2e67 6574 5f73 6c6f 7065 735f 616e 645f  .get_slopes_and_
+00028600: 6465 736b 6577 5f6e 6577 5f6c 6967 6874  deskew_new_light
+00028610: 2874 7874 5f63 6f6e 5f6f 7267 2c20 636f  (txt_con_org, co
+00028620: 6e74 6f75 7273 5f6f 6e6c 795f 7465 7874  ntours_only_text
+00028630: 5f70 6172 656e 742c 2074 6578 746c 696e  _parent, textlin
+00028640: 655f 6d61 736b 5f74 6f74 5f65 612c 2069  e_mask_tot_ea, i
+00028650: 6d61 6765 5f70 6167 655f 726f 7461 7465  mage_page_rotate
+00028660: 642c 2062 6f78 6573 5f74 6578 742c 2073  d, boxes_text, s
+00028670: 6c6f 7065 5f64 6573 6b65 7729 0a20 2020  lope_deskew).   
+00028680: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028690: 2020 2020 2073 6c6f 7065 735f 6d61 7267       slopes_marg
+000286a0: 696e 616c 732c 2061 6c6c 5f66 6f75 6e64  inals, all_found
+000286b0: 5f74 6578 6c69 6e65 5f70 6f6c 7967 6f6e  _texline_polygon
+000286c0: 735f 6d61 7267 696e 616c 732c 2062 6f78  s_marginals, box
+000286d0: 6573 5f6d 6172 6769 6e61 6c73 2c20 5f2c  es_marginals, _,
+000286e0: 2070 6f6c 7967 6f6e 735f 6f66 5f6d 6172   polygons_of_mar
+000286f0: 6769 6e61 6c73 2c20 616c 6c5f 626f 785f  ginals, all_box_
+00028700: 636f 6f72 645f 6d61 7267 696e 616c 732c  coord_marginals,
+00028710: 205f 203d 2073 656c 662e 6765 745f 736c   _ = self.get_sl
+00028720: 6f70 6573 5f61 6e64 5f64 6573 6b65 775f  opes_and_deskew_
+00028730: 6e65 775f 6c69 6768 7428 706f 6c79 676f  new_light(polygo
+00028740: 6e73 5f6f 665f 6d61 7267 696e 616c 732c  ns_of_marginals,
+00028750: 2070 6f6c 7967 6f6e 735f 6f66 5f6d 6172   polygons_of_mar
+00028760: 6769 6e61 6c73 2c20 7465 7874 6c69 6e65  ginals, textline
+00028770: 5f6d 6173 6b5f 746f 745f 6561 2c20 696d  _mask_tot_ea, im
+00028780: 6167 655f 7061 6765 5f72 6f74 6174 6564  age_page_rotated
+00028790: 2c20 626f 7865 735f 6d61 7267 696e 616c  , boxes_marginal
+000287a0: 732c 2073 6c6f 7065 5f64 6573 6b65 7729  s, slope_deskew)
+000287b0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+000287c0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000287d0: 2020 2020 2020 2020 2020 2073 6c6f 7065             slope
+000287e0: 732c 2061 6c6c 5f66 6f75 6e64 5f74 6578  s, all_found_tex
+000287f0: 6c69 6e65 5f70 6f6c 7967 6f6e 732c 2062  line_polygons, b
+00028800: 6f78 6573 5f74 6578 742c 2074 7874 5f63  oxes_text, txt_c
+00028810: 6f6e 5f6f 7267 2c20 636f 6e74 6f75 7273  on_org, contours
+00028820: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
+00028830: 742c 2061 6c6c 5f62 6f78 5f63 6f6f 7264  t, all_box_coord
+00028840: 2c20 696e 6465 785f 6279 5f74 6578 745f  , index_by_text_
+00028850: 7061 725f 636f 6e20 3d20 7365 6c66 2e67  par_con = self.g
+00028860: 6574 5f73 6c6f 7065 735f 616e 645f 6465  et_slopes_and_de
+00028870: 736b 6577 5f6e 6577 2874 7874 5f63 6f6e  skew_new(txt_con
+00028880: 5f6f 7267 2c20 636f 6e74 6f75 7273 5f6f  _org, contours_o
+00028890: 6e6c 795f 7465 7874 5f70 6172 656e 742c  nly_text_parent,
+000288a0: 2074 6578 746c 696e 655f 6d61 736b 5f74   textline_mask_t
+000288b0: 6f74 5f65 612c 2069 6d61 6765 5f70 6167  ot_ea, image_pag
+000288c0: 655f 726f 7461 7465 642c 2062 6f78 6573  e_rotated, boxes
+000288d0: 5f74 6578 742c 2073 6c6f 7065 5f64 6573  _text, slope_des
+000288e0: 6b65 7729 0a20 2020 2020 2020 2020 2020  kew).           
+000288f0: 2020 2020 2020 2020 2073 6c6f 7065 735f           slopes_
+00028900: 6d61 7267 696e 616c 732c 2061 6c6c 5f66  marginals, all_f
+00028910: 6f75 6e64 5f74 6578 6c69 6e65 5f70 6f6c  ound_texline_pol
+00028920: 7967 6f6e 735f 6d61 7267 696e 616c 732c  ygons_marginals,
+00028930: 2062 6f78 6573 5f6d 6172 6769 6e61 6c73   boxes_marginals
+00028940: 2c20 5f2c 2070 6f6c 7967 6f6e 735f 6f66  , _, polygons_of
+00028950: 5f6d 6172 6769 6e61 6c73 2c20 616c 6c5f  _marginals, all_
+00028960: 626f 785f 636f 6f72 645f 6d61 7267 696e  box_coord_margin
+00028970: 616c 732c 205f 203d 2073 656c 662e 6765  als, _ = self.ge
+00028980: 745f 736c 6f70 6573 5f61 6e64 5f64 6573  t_slopes_and_des
+00028990: 6b65 775f 6e65 7728 706f 6c79 676f 6e73  kew_new(polygons
+000289a0: 5f6f 665f 6d61 7267 696e 616c 732c 2070  _of_marginals, p
+000289b0: 6f6c 7967 6f6e 735f 6f66 5f6d 6172 6769  olygons_of_margi
+000289c0: 6e61 6c73 2c20 7465 7874 6c69 6e65 5f6d  nals, textline_m
+000289d0: 6173 6b5f 746f 745f 6561 2c20 696d 6167  ask_tot_ea, imag
+000289e0: 655f 7061 6765 5f72 6f74 6174 6564 2c20  e_page_rotated, 
+000289f0: 626f 7865 735f 6d61 7267 696e 616c 732c  boxes_marginals,
+00028a00: 2073 6c6f 7065 5f64 6573 6b65 7729 0a0a   slope_deskew)..
+00028a10: 2020 2020 2020 2020 2020 2020 656c 7365              else
+00028a20: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+00028a30: 2020 0a20 2020 2020 2020 2020 2020 2020    .             
+00028a40: 2020 2073 6361 6c65 5f70 6172 616d 203d     scale_param =
+00028a50: 2031 0a20 2020 2020 2020 2020 2020 2020   1.             
+00028a60: 2020 2061 6c6c 5f66 6f75 6e64 5f74 6578     all_found_tex
+00028a70: 6c69 6e65 5f70 6f6c 7967 6f6e 732c 2062  line_polygons, b
+00028a80: 6f78 6573 5f74 6578 742c 2074 7874 5f63  oxes_text, txt_c
+00028a90: 6f6e 5f6f 7267 2c20 636f 6e74 6f75 7273  on_org, contours
+00028aa0: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
+00028ab0: 742c 2061 6c6c 5f62 6f78 5f63 6f6f 7264  t, all_box_coord
+00028ac0: 2c20 696e 6465 785f 6279 5f74 6578 745f  , index_by_text_
+00028ad0: 7061 725f 636f 6e2c 2073 6c6f 7065 7320  par_con, slopes 
+00028ae0: 3d20 7365 6c66 2e67 6574 5f73 6c6f 7065  = self.get_slope
+00028af0: 735f 616e 645f 6465 736b 6577 5f6e 6577  s_and_deskew_new
+00028b00: 5f63 7572 7665 6428 7478 745f 636f 6e5f  _curved(txt_con_
+00028b10: 6f72 672c 2063 6f6e 746f 7572 735f 6f6e  org, contours_on
+00028b20: 6c79 5f74 6578 745f 7061 7265 6e74 2c20  ly_text_parent, 
+00028b30: 6376 322e 6572 6f64 6528 7465 7874 6c69  cv2.erode(textli
+00028b40: 6e65 5f6d 6173 6b5f 746f 745f 6561 2c20  ne_mask_tot_ea, 
+00028b50: 6b65 726e 656c 3d4b 4552 4e45 4c2c 2069  kernel=KERNEL, i
+00028b60: 7465 7261 7469 6f6e 733d 3129 2c20 696d  terations=1), im
+00028b70: 6167 655f 7061 6765 5f72 6f74 6174 6564  age_page_rotated
+00028b80: 2c20 626f 7865 735f 7465 7874 2c20 7465  , boxes_text, te
+00028b90: 7874 5f6f 6e6c 792c 206e 756d 5f63 6f6c  xt_only, num_col
+00028ba0: 5f63 6c61 7373 6966 6965 722c 2073 6361  _classifier, sca
+00028bb0: 6c65 5f70 6172 616d 2c20 736c 6f70 655f  le_param, slope_
+00028bc0: 6465 736b 6577 290a 2020 2020 2020 2020  deskew).        
+00028bd0: 2020 2020 2020 2020 616c 6c5f 666f 756e          all_foun
+00028be0: 645f 7465 786c 696e 655f 706f 6c79 676f  d_texline_polygo
+00028bf0: 6e73 203d 2073 6d61 6c6c 5f74 6578 746c  ns = small_textl
+00028c00: 696e 6573 5f74 6f5f 7061 7265 6e74 5f61  ines_to_parent_a
+00028c10: 6468 6572 656e 6365 3228 616c 6c5f 666f  dherence2(all_fo
+00028c20: 756e 645f 7465 786c 696e 655f 706f 6c79  und_texline_poly
+00028c30: 676f 6e73 2c20 7465 7874 6c69 6e65 5f6d  gons, textline_m
+00028c40: 6173 6b5f 746f 745f 6561 2c20 6e75 6d5f  ask_tot_ea, num_
+00028c50: 636f 6c5f 636c 6173 7369 6669 6572 290a  col_classifier).
+00028c60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028c70: 616c 6c5f 666f 756e 645f 7465 786c 696e  all_found_texlin
+00028c80: 655f 706f 6c79 676f 6e73 5f6d 6172 6769  e_polygons_margi
+00028c90: 6e61 6c73 2c20 626f 7865 735f 6d61 7267  nals, boxes_marg
+00028ca0: 696e 616c 732c 205f 2c20 706f 6c79 676f  inals, _, polygo
+00028cb0: 6e73 5f6f 665f 6d61 7267 696e 616c 732c  ns_of_marginals,
+00028cc0: 2061 6c6c 5f62 6f78 5f63 6f6f 7264 5f6d   all_box_coord_m
+00028cd0: 6172 6769 6e61 6c73 2c20 5f2c 2073 6c6f  arginals, _, slo
+00028ce0: 7065 735f 6d61 7267 696e 616c 7320 3d20  pes_marginals = 
+00028cf0: 7365 6c66 2e67 6574 5f73 6c6f 7065 735f  self.get_slopes_
+00028d00: 616e 645f 6465 736b 6577 5f6e 6577 5f63  and_deskew_new_c
+00028d10: 7572 7665 6428 706f 6c79 676f 6e73 5f6f  urved(polygons_o
+00028d20: 665f 6d61 7267 696e 616c 732c 2070 6f6c  f_marginals, pol
+00028d30: 7967 6f6e 735f 6f66 5f6d 6172 6769 6e61  ygons_of_margina
+00028d40: 6c73 2c20 6376 322e 6572 6f64 6528 7465  ls, cv2.erode(te
+00028d50: 7874 6c69 6e65 5f6d 6173 6b5f 746f 745f  xtline_mask_tot_
+00028d60: 6561 2c20 6b65 726e 656c 3d4b 4552 4e45  ea, kernel=KERNE
+00028d70: 4c2c 2069 7465 7261 7469 6f6e 733d 3129  L, iterations=1)
+00028d80: 2c20 696d 6167 655f 7061 6765 5f72 6f74  , image_page_rot
+00028d90: 6174 6564 2c20 626f 7865 735f 6d61 7267  ated, boxes_marg
+00028da0: 696e 616c 732c 2074 6578 745f 6f6e 6c79  inals, text_only
+00028db0: 2c20 6e75 6d5f 636f 6c5f 636c 6173 7369  , num_col_classi
+00028dc0: 6669 6572 2c20 7363 616c 655f 7061 7261  fier, scale_para
+00028dd0: 6d2c 2073 6c6f 7065 5f64 6573 6b65 7729  m, slope_deskew)
+00028de0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00028df0: 2061 6c6c 5f66 6f75 6e64 5f74 6578 6c69   all_found_texli
+00028e00: 6e65 5f70 6f6c 7967 6f6e 735f 6d61 7267  ne_polygons_marg
+00028e10: 696e 616c 7320 3d20 736d 616c 6c5f 7465  inals = small_te
+00028e20: 7874 6c69 6e65 735f 746f 5f70 6172 656e  xtlines_to_paren
+00028e30: 745f 6164 6865 7265 6e63 6532 2861 6c6c  t_adherence2(all
+00028e40: 5f66 6f75 6e64 5f74 6578 6c69 6e65 5f70  _found_texline_p
+00028e50: 6f6c 7967 6f6e 735f 6d61 7267 696e 616c  olygons_marginal
+00028e60: 732c 2074 6578 746c 696e 655f 6d61 736b  s, textline_mask
+00028e70: 5f74 6f74 5f65 612c 206e 756d 5f63 6f6c  _tot_ea, num_col
+00028e80: 5f63 6c61 7373 6966 6965 7229 0a20 2020  _classifier).   
+00028e90: 2020 2020 2020 2020 200a 2020 2020 2020           .      
+00028ea0: 2020 2020 2020 6966 2073 656c 662e 6675        if self.fu
+00028eb0: 6c6c 5f6c 6179 6f75 743a 0a20 2020 2020  ll_layout:.     
+00028ec0: 2020 2020 2020 2020 2020 2069 6620 6e70             if np
+00028ed0: 2e61 6273 2873 6c6f 7065 5f64 6573 6b65  .abs(slope_deske
+00028ee0: 7729 203e 3d20 534c 4f50 455f 5448 5245  w) >= SLOPE_THRE
+00028ef0: 5348 4f4c 443a 0a20 2020 2020 2020 2020  SHOLD:.         
+00028f00: 2020 2020 2020 2020 2020 2063 6f6e 746f             conto
+00028f10: 7572 735f 6f6e 6c79 5f74 6578 745f 7061  urs_only_text_pa
+00028f20: 7265 6e74 5f64 5f6f 7264 6572 6564 203d  rent_d_ordered =
+00028f30: 206c 6973 7428 6e70 2e61 7272 6179 2863   list(np.array(c
+00028f40: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
+00028f50: 745f 7061 7265 6e74 5f64 5f6f 7264 6572  t_parent_d_order
+00028f60: 6564 295b 696e 6465 785f 6279 5f74 6578  ed)[index_by_tex
+00028f70: 745f 7061 725f 636f 6e5d 290a 2020 2020  t_par_con]).    
+00028f80: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00028f90: 6966 2073 656c 662e 6c69 6768 745f 7665  if self.light_ve
+00028fa0: 7273 696f 6e3a 0a20 2020 2020 2020 2020  rsion:.         
+00028fb0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+00028fc0: 6578 745f 7265 6769 6f6e 735f 702c 2063  ext_regions_p, c
+00028fd0: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
+00028fe0: 745f 7061 7265 6e74 2c20 636f 6e74 6f75  t_parent, contou
+00028ff0: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
+00029000: 656e 745f 682c 2061 6c6c 5f62 6f78 5f63  ent_h, all_box_c
+00029010: 6f6f 7264 2c20 616c 6c5f 626f 785f 636f  oord, all_box_co
+00029020: 6f72 645f 682c 2061 6c6c 5f66 6f75 6e64  ord_h, all_found
+00029030: 5f74 6578 6c69 6e65 5f70 6f6c 7967 6f6e  _texline_polygon
+00029040: 732c 2061 6c6c 5f66 6f75 6e64 5f74 6578  s, all_found_tex
+00029050: 6c69 6e65 5f70 6f6c 7967 6f6e 735f 682c  line_polygons_h,
+00029060: 2073 6c6f 7065 732c 2073 6c6f 7065 735f   slopes, slopes_
+00029070: 682c 2063 6f6e 746f 7572 735f 6f6e 6c79  h, contours_only
+00029080: 5f74 6578 745f 7061 7265 6e74 5f64 5f6f  _text_parent_d_o
+00029090: 7264 6572 6564 2c20 636f 6e74 6f75 7273  rdered, contours
+000290a0: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
+000290b0: 745f 685f 645f 6f72 6465 7265 6420 3d20  t_h_d_ordered = 
+000290c0: 6368 6563 6b5f 616e 795f 7465 7874 5f72  check_any_text_r
+000290d0: 6567 696f 6e5f 696e 5f6d 6f64 656c 5f6f  egion_in_model_o
+000290e0: 6e65 5f69 735f 6d61 696e 5f6f 725f 6865  ne_is_main_or_he
+000290f0: 6164 6572 5f6c 6967 6874 2874 6578 745f  ader_light(text_
+00029100: 7265 6769 6f6e 735f 702c 2072 6567 696f  regions_p, regio
+00029110: 6e73 5f66 756c 6c79 2c20 636f 6e74 6f75  ns_fully, contou
+00029120: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
+00029130: 656e 742c 2061 6c6c 5f62 6f78 5f63 6f6f  ent, all_box_coo
+00029140: 7264 2c20 616c 6c5f 666f 756e 645f 7465  rd, all_found_te
+00029150: 786c 696e 655f 706f 6c79 676f 6e73 2c20  xline_polygons, 
+00029160: 736c 6f70 6573 2c20 636f 6e74 6f75 7273  slopes, contours
+00029170: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
+00029180: 745f 645f 6f72 6465 7265 6429 0a20 2020  t_d_ordered).   
+00029190: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000291a0: 2065 6c73 653a 0a20 2020 2020 2020 2020   else:.         
+000291b0: 2020 2020 2020 2020 2020 2020 2020 2074                 t
+000291c0: 6578 745f 7265 6769 6f6e 735f 702c 2063  ext_regions_p, c
+000291d0: 6f6e 746f 7572 735f 6f6e 6c79 5f74 6578  ontours_only_tex
+000291e0: 745f 7061 7265 6e74 2c20 636f 6e74 6f75  t_parent, contou
+000291f0: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
+00029200: 656e 745f 682c 2061 6c6c 5f62 6f78 5f63  ent_h, all_box_c
+00029210: 6f6f 7264 2c20 616c 6c5f 626f 785f 636f  oord, all_box_co
+00029220: 6f72 645f 682c 2061 6c6c 5f66 6f75 6e64  ord_h, all_found
+00029230: 5f74 6578 6c69 6e65 5f70 6f6c 7967 6f6e  _texline_polygon
+00029240: 732c 2061 6c6c 5f66 6f75 6e64 5f74 6578  s, all_found_tex
+00029250: 6c69 6e65 5f70 6f6c 7967 6f6e 735f 682c  line_polygons_h,
+00029260: 2073 6c6f 7065 732c 2073 6c6f 7065 735f   slopes, slopes_
+00029270: 682c 2063 6f6e 746f 7572 735f 6f6e 6c79  h, contours_only
+00029280: 5f74 6578 745f 7061 7265 6e74 5f64 5f6f  _text_parent_d_o
+00029290: 7264 6572 6564 2c20 636f 6e74 6f75 7273  rdered, contours
+000292a0: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
+000292b0: 745f 685f 645f 6f72 6465 7265 6420 3d20  t_h_d_ordered = 
+000292c0: 6368 6563 6b5f 616e 795f 7465 7874 5f72  check_any_text_r
+000292d0: 6567 696f 6e5f 696e 5f6d 6f64 656c 5f6f  egion_in_model_o
+000292e0: 6e65 5f69 735f 6d61 696e 5f6f 725f 6865  ne_is_main_or_he
+000292f0: 6164 6572 2874 6578 745f 7265 6769 6f6e  ader(text_region
+00029300: 735f 702c 2072 6567 696f 6e73 5f66 756c  s_p, regions_ful
+00029310: 6c79 2c20 636f 6e74 6f75 7273 5f6f 6e6c  ly, contours_onl
+00029320: 795f 7465 7874 5f70 6172 656e 742c 2061  y_text_parent, a
+00029330: 6c6c 5f62 6f78 5f63 6f6f 7264 2c20 616c  ll_box_coord, al
+00029340: 6c5f 666f 756e 645f 7465 786c 696e 655f  l_found_texline_
+00029350: 706f 6c79 676f 6e73 2c20 736c 6f70 6573  polygons, slopes
+00029360: 2c20 636f 6e74 6f75 7273 5f6f 6e6c 795f  , contours_only_
+00029370: 7465 7874 5f70 6172 656e 745f 645f 6f72  text_parent_d_or
+00029380: 6465 7265 6429 0a20 2020 2020 2020 2020  dered).         
+00029390: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+000293a0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+000293b0: 2023 7461 6b65 7320 6c6f 6e67 2074 696d   #takes long tim
+000293c0: 6565 0a20 2020 2020 2020 2020 2020 2020  ee.             
+000293d0: 2020 2020 2020 2063 6f6e 746f 7572 735f         contours_
+000293e0: 6f6e 6c79 5f74 6578 745f 7061 7265 6e74  only_text_parent
+000293f0: 5f64 5f6f 7264 6572 6564 203d 204e 6f6e  _d_ordered = Non
+00029400: 650a 2020 2020 2020 2020 2020 2020 2020  e.              
+00029410: 2020 2020 2020 6966 2073 656c 662e 6c69        if self.li
+00029420: 6768 745f 7665 7273 696f 6e3a 0a20 2020  ght_version:.   
+00029430: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029440: 2020 2020 2074 6578 745f 7265 6769 6f6e       text_region
+00029450: 735f 702c 2063 6f6e 746f 7572 735f 6f6e  s_p, contours_on
+00029460: 6c79 5f74 6578 745f 7061 7265 6e74 2c20  ly_text_parent, 
+00029470: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
+00029480: 7874 5f70 6172 656e 745f 682c 2061 6c6c  xt_parent_h, all
+00029490: 5f62 6f78 5f63 6f6f 7264 2c20 616c 6c5f  _box_coord, all_
+000294a0: 626f 785f 636f 6f72 645f 682c 2061 6c6c  box_coord_h, all
+000294b0: 5f66 6f75 6e64 5f74 6578 6c69 6e65 5f70  _found_texline_p
+000294c0: 6f6c 7967 6f6e 732c 2061 6c6c 5f66 6f75  olygons, all_fou
+000294d0: 6e64 5f74 6578 6c69 6e65 5f70 6f6c 7967  nd_texline_polyg
+000294e0: 6f6e 735f 682c 2073 6c6f 7065 732c 2073  ons_h, slopes, s
+000294f0: 6c6f 7065 735f 682c 2063 6f6e 746f 7572  lopes_h, contour
+00029500: 735f 6f6e 6c79 5f74 6578 745f 7061 7265  s_only_text_pare
+00029510: 6e74 5f64 5f6f 7264 6572 6564 2c20 636f  nt_d_ordered, co
+00029520: 6e74 6f75 7273 5f6f 6e6c 795f 7465 7874  ntours_only_text
+00029530: 5f70 6172 656e 745f 685f 645f 6f72 6465  _parent_h_d_orde
+00029540: 7265 6420 3d20 6368 6563 6b5f 616e 795f  red = check_any_
+00029550: 7465 7874 5f72 6567 696f 6e5f 696e 5f6d  text_region_in_m
+00029560: 6f64 656c 5f6f 6e65 5f69 735f 6d61 696e  odel_one_is_main
+00029570: 5f6f 725f 6865 6164 6572 5f6c 6967 6874  _or_header_light
+00029580: 2874 6578 745f 7265 6769 6f6e 735f 702c  (text_regions_p,
+00029590: 2072 6567 696f 6e73 5f66 756c 6c79 2c20   regions_fully, 
+000295a0: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
+000295b0: 7874 5f70 6172 656e 742c 2061 6c6c 5f62  xt_parent, all_b
+000295c0: 6f78 5f63 6f6f 7264 2c20 616c 6c5f 666f  ox_coord, all_fo
+000295d0: 756e 645f 7465 786c 696e 655f 706f 6c79  und_texline_poly
+000295e0: 676f 6e73 2c20 736c 6f70 6573 2c20 636f  gons, slopes, co
+000295f0: 6e74 6f75 7273 5f6f 6e6c 795f 7465 7874  ntours_only_text
+00029600: 5f70 6172 656e 745f 645f 6f72 6465 7265  _parent_d_ordere
+00029610: 6429 0a20 2020 2020 2020 2020 2020 2020  d).             
+00029620: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00029630: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029640: 2020 2020 2074 6578 745f 7265 6769 6f6e       text_region
+00029650: 735f 702c 2063 6f6e 746f 7572 735f 6f6e  s_p, contours_on
+00029660: 6c79 5f74 6578 745f 7061 7265 6e74 2c20  ly_text_parent, 
+00029670: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
+00029680: 7874 5f70 6172 656e 745f 682c 2061 6c6c  xt_parent_h, all
+00029690: 5f62 6f78 5f63 6f6f 7264 2c20 616c 6c5f  _box_coord, all_
+000296a0: 626f 785f 636f 6f72 645f 682c 2061 6c6c  box_coord_h, all
+000296b0: 5f66 6f75 6e64 5f74 6578 6c69 6e65 5f70  _found_texline_p
+000296c0: 6f6c 7967 6f6e 732c 2061 6c6c 5f66 6f75  olygons, all_fou
+000296d0: 6e64 5f74 6578 6c69 6e65 5f70 6f6c 7967  nd_texline_polyg
+000296e0: 6f6e 735f 682c 2073 6c6f 7065 732c 2073  ons_h, slopes, s
+000296f0: 6c6f 7065 735f 682c 2063 6f6e 746f 7572  lopes_h, contour
+00029700: 735f 6f6e 6c79 5f74 6578 745f 7061 7265  s_only_text_pare
+00029710: 6e74 5f64 5f6f 7264 6572 6564 2c20 636f  nt_d_ordered, co
+00029720: 6e74 6f75 7273 5f6f 6e6c 795f 7465 7874  ntours_only_text
+00029730: 5f70 6172 656e 745f 685f 645f 6f72 6465  _parent_h_d_orde
+00029740: 7265 6420 3d20 6368 6563 6b5f 616e 795f  red = check_any_
+00029750: 7465 7874 5f72 6567 696f 6e5f 696e 5f6d  text_region_in_m
+00029760: 6f64 656c 5f6f 6e65 5f69 735f 6d61 696e  odel_one_is_main
+00029770: 5f6f 725f 6865 6164 6572 2874 6578 745f  _or_header(text_
+00029780: 7265 6769 6f6e 735f 702c 2072 6567 696f  regions_p, regio
+00029790: 6e73 5f66 756c 6c79 2c20 636f 6e74 6f75  ns_fully, contou
+000297a0: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
+000297b0: 656e 742c 2061 6c6c 5f62 6f78 5f63 6f6f  ent, all_box_coo
+000297c0: 7264 2c20 616c 6c5f 666f 756e 645f 7465  rd, all_found_te
+000297d0: 786c 696e 655f 706f 6c79 676f 6e73 2c20  xline_polygons, 
+000297e0: 736c 6f70 6573 2c20 636f 6e74 6f75 7273  slopes, contours
+000297f0: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
+00029800: 745f 645f 6f72 6465 7265 6429 0a0a 2020  t_d_ordered)..  
+00029810: 2020 2020 2020 2020 2020 2020 2020 6966                if
+00029820: 2073 656c 662e 706c 6f74 7465 723a 0a20   self.plotter:. 
+00029830: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029840: 2020 2073 656c 662e 706c 6f74 7465 722e     self.plotter.
+00029850: 7361 7665 5f70 6c6f 745f 6f66 5f6c 6179  save_plot_of_lay
+00029860: 6f75 7428 7465 7874 5f72 6567 696f 6e73  out(text_regions
+00029870: 5f70 2c20 696d 6167 655f 7061 6765 290a  _p, image_page).
+00029880: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029890: 2020 2020 7365 6c66 2e70 6c6f 7474 6572      self.plotter
+000298a0: 2e73 6176 655f 706c 6f74 5f6f 665f 6c61  .save_plot_of_la
+000298b0: 796f 7574 5f61 6c6c 2874 6578 745f 7265  yout_all(text_re
+000298c0: 6769 6f6e 735f 702c 2069 6d61 6765 5f70  gions_p, image_p
+000298d0: 6167 6529 0a20 2020 2020 2020 200a 2020  age).        .  
+000298e0: 2020 2020 2020 2020 2020 2020 2020 7069                pi
+000298f0: 7865 6c5f 696d 6720 3d20 340a 2020 2020  xel_img = 4.    
+00029900: 2020 2020 2020 2020 2020 2020 706f 6c79              poly
+00029910: 676f 6e73 5f6f 665f 6472 6f70 5f63 6170  gons_of_drop_cap
+00029920: 6974 616c 7320 3d20 7265 7475 726e 5f63  itals = return_c
+00029930: 6f6e 746f 7572 735f 6f66 5f69 6e74 6572  ontours_of_inter
+00029940: 6573 7465 645f 7265 6769 6f6e 5f62 795f  ested_region_by_
+00029950: 6d69 6e5f 7369 7a65 2874 6578 745f 7265  min_size(text_re
+00029960: 6769 6f6e 735f 702c 2070 6978 656c 5f69  gions_p, pixel_i
+00029970: 6d67 290a 2020 2020 2020 2020 2020 2020  mg).            
+00029980: 2020 2020 616c 6c5f 666f 756e 645f 7465      all_found_te
+00029990: 786c 696e 655f 706f 6c79 676f 6e73 203d  xline_polygons =
+000299a0: 2061 6468 6572 655f 6472 6f70 5f63 6170   adhere_drop_cap
+000299b0: 6974 616c 5f72 6567 696f 6e5f 696e 746f  ital_region_into
+000299c0: 5f63 6f72 7265 7370 6f6e 6469 6e67 5f74  _corresponding_t
+000299d0: 6578 746c 696e 6528 7465 7874 5f72 6567  extline(text_reg
+000299e0: 696f 6e73 5f70 2c20 706f 6c79 676f 6e73  ions_p, polygons
+000299f0: 5f6f 665f 6472 6f70 5f63 6170 6974 616c  _of_drop_capital
+00029a00: 732c 2063 6f6e 746f 7572 735f 6f6e 6c79  s, contours_only
+00029a10: 5f74 6578 745f 7061 7265 6e74 2c20 636f  _text_parent, co
+00029a20: 6e74 6f75 7273 5f6f 6e6c 795f 7465 7874  ntours_only_text
+00029a30: 5f70 6172 656e 745f 682c 2061 6c6c 5f62  _parent_h, all_b
+00029a40: 6f78 5f63 6f6f 7264 2c20 616c 6c5f 626f  ox_coord, all_bo
+00029a50: 785f 636f 6f72 645f 682c 2061 6c6c 5f66  x_coord_h, all_f
+00029a60: 6f75 6e64 5f74 6578 6c69 6e65 5f70 6f6c  ound_texline_pol
+00029a70: 7967 6f6e 732c 2061 6c6c 5f66 6f75 6e64  ygons, all_found
+00029a80: 5f74 6578 6c69 6e65 5f70 6f6c 7967 6f6e  _texline_polygon
+00029a90: 735f 682c 206b 6572 6e65 6c3d 4b45 524e  s_h, kernel=KERN
+00029aa0: 454c 2c20 6375 7276 6564 5f6c 696e 653d  EL, curved_line=
+00029ab0: 7365 6c66 2e63 7572 7665 645f 6c69 6e65  self.curved_line
+00029ac0: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+00029ad0: 2020 7069 7865 6c5f 6c69 6e65 7320 3d20    pixel_lines = 
+00029ae0: 360a 2020 2020 2020 2020 2020 2020 2020  6.              
+00029af0: 2020 0a0a 2020 2020 2020 2020 2020 2020    ..            
+00029b00: 2020 2020 6966 206e 6f74 2073 656c 662e      if not self.
+00029b10: 6865 6164 6572 735f 6f66 663a 0a20 2020  headers_off:.   
+00029b20: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029b30: 2069 6620 6e70 2e61 6273 2873 6c6f 7065   if np.abs(slope
+00029b40: 5f64 6573 6b65 7729 203c 2053 4c4f 5045  _deskew) < SLOPE
+00029b50: 5f54 4852 4553 484f 4c44 3a0a 2020 2020  _THRESHOLD:.    
+00029b60: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029b70: 2020 2020 6e75 6d5f 636f 6c2c 205f 2c20      num_col, _, 
+00029b80: 6d61 7472 6978 5f6f 665f 6c69 6e65 735f  matrix_of_lines_
+00029b90: 6368 2c20 7370 6c69 7474 6572 5f79 5f6e  ch, splitter_y_n
+00029ba0: 6577 2c20 5f20 3d20 6669 6e64 5f6e 756d  ew, _ = find_num
+00029bb0: 6265 725f 6f66 5f63 6f6c 756d 6e73 5f69  ber_of_columns_i
+00029bc0: 6e5f 646f 6375 6d65 6e74 286e 702e 7265  n_document(np.re
+00029bd0: 7065 6174 2874 6578 745f 7265 6769 6f6e  peat(text_region
+00029be0: 735f 705b 3a2c 203a 2c20 6e70 2e6e 6577  s_p[:, :, np.new
+00029bf0: 6178 6973 5d2c 2033 2c20 6178 6973 3d32  axis], 3, axis=2
+00029c00: 292c 206e 756d 5f63 6f6c 5f63 6c61 7373  ), num_col_class
+00029c10: 6966 6965 722c 2073 656c 662e 7461 626c  ifier, self.tabl
+00029c20: 6573 2c20 2070 6978 656c 5f6c 696e 6573  es,  pixel_lines
+00029c30: 2c20 636f 6e74 6f75 7273 5f6f 6e6c 795f  , contours_only_
+00029c40: 7465 7874 5f70 6172 656e 745f 6829 0a20  text_parent_h). 
+00029c50: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029c60: 2020 2065 6c73 653a 0a20 2020 2020 2020     else:.       
+00029c70: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029c80: 205f 2c20 5f2c 206d 6174 7269 785f 6f66   _, _, matrix_of
+00029c90: 5f6c 696e 6573 5f63 685f 642c 2073 706c  _lines_ch_d, spl
+00029ca0: 6974 7465 725f 795f 6e65 775f 642c 205f  itter_y_new_d, _
+00029cb0: 203d 2066 696e 645f 6e75 6d62 6572 5f6f   = find_number_o
+00029cc0: 665f 636f 6c75 6d6e 735f 696e 5f64 6f63  f_columns_in_doc
+00029cd0: 756d 656e 7428 6e70 2e72 6570 6561 7428  ument(np.repeat(
+00029ce0: 7465 7874 5f72 6567 696f 6e73 5f70 5f31  text_regions_p_1
+00029cf0: 5f6e 5b3a 2c20 3a2c 206e 702e 6e65 7761  _n[:, :, np.newa
+00029d00: 7869 735d 2c20 332c 2061 7869 733d 3229  xis], 3, axis=2)
+00029d10: 2c20 6e75 6d5f 636f 6c5f 636c 6173 7369  , num_col_classi
+00029d20: 6669 6572 2c20 7365 6c66 2e74 6162 6c65  fier, self.table
+00029d30: 732c 2070 6978 656c 5f6c 696e 6573 2c20  s, pixel_lines, 
+00029d40: 636f 6e74 6f75 7273 5f6f 6e6c 795f 7465  contours_only_te
+00029d50: 7874 5f70 6172 656e 745f 685f 645f 6f72  xt_parent_h_d_or
+00029d60: 6465 7265 6429 0a20 2020 2020 2020 2020  dered).         
+00029d70: 2020 2020 2020 2065 6c69 6620 7365 6c66         elif self
+00029d80: 2e68 6561 6465 7273 5f6f 6666 3a0a 2020  .headers_off:.  
+00029d90: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029da0: 2020 6966 206e 702e 6162 7328 736c 6f70    if np.abs(slop
+00029db0: 655f 6465 736b 6577 2920 3c20 534c 4f50  e_deskew) < SLOP
+00029dc0: 455f 5448 5245 5348 4f4c 443a 0a20 2020  E_THRESHOLD:.   
+00029dd0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029de0: 2020 2020 206e 756d 5f63 6f6c 2c20 5f2c       num_col, _,
+00029df0: 206d 6174 7269 785f 6f66 5f6c 696e 6573   matrix_of_lines
+00029e00: 5f63 682c 2073 706c 6974 7465 725f 795f  _ch, splitter_y_
+00029e10: 6e65 772c 205f 203d 2066 696e 645f 6e75  new, _ = find_nu
+00029e20: 6d62 6572 5f6f 665f 636f 6c75 6d6e 735f  mber_of_columns_
+00029e30: 696e 5f64 6f63 756d 656e 7428 6e70 2e72  in_document(np.r
+00029e40: 6570 6561 7428 7465 7874 5f72 6567 696f  epeat(text_regio
+00029e50: 6e73 5f70 5b3a 2c20 3a2c 206e 702e 6e65  ns_p[:, :, np.ne
+00029e60: 7761 7869 735d 2c20 332c 2061 7869 733d  waxis], 3, axis=
+00029e70: 3229 2c20 6e75 6d5f 636f 6c5f 636c 6173  2), num_col_clas
+00029e80: 7369 6669 6572 2c20 7365 6c66 2e74 6162  sifier, self.tab
+00029e90: 6c65 732c 2020 7069 7865 6c5f 6c69 6e65  les,  pixel_line
+00029ea0: 7329 0a20 2020 2020 2020 2020 2020 2020  s).             
+00029eb0: 2020 2020 2020 2065 6c73 653a 0a20 2020         else:.   
+00029ec0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+00029ed0: 2020 2020 205f 2c20 5f2c 206d 6174 7269       _, _, matri
+00029ee0: 785f 6f66 5f6c 696e 6573 5f63 685f 642c  x_of_lines_ch_d,
+00029ef0: 2073 706c 6974 7465 725f 795f 6e65 775f   splitter_y_new_
+00029f00: 642c 205f 203d 2066 696e 645f 6e75 6d62  d, _ = find_numb
+00029f10: 6572 5f6f 665f 636f 6c75 6d6e 735f 696e  er_of_columns_in
+00029f20: 5f64 6f63 756d 656e 7428 6e70 2e72 6570  _document(np.rep
+00029f30: 6561 7428 7465 7874 5f72 6567 696f 6e73  eat(text_regions
+00029f40: 5f70 5f31 5f6e 5b3a 2c20 3a2c 206e 702e  _p_1_n[:, :, np.
+00029f50: 6e65 7761 7869 735d 2c20 332c 2061 7869  newaxis], 3, axi
+00029f60: 733d 3229 2c20 6e75 6d5f 636f 6c5f 636c  s=2), num_col_cl
+00029f70: 6173 7369 6669 6572 2c20 7365 6c66 2e74  assifier, self.t
+00029f80: 6162 6c65 732c 2070 6978 656c 5f6c 696e  ables, pixel_lin
+00029f90: 6573 290a 0a20 2020 2020 2020 2020 2020  es)..           
+00029fa0: 2020 2020 2069 6620 6e75 6d5f 636f 6c5f       if num_col_
+00029fb0: 636c 6173 7369 6669 6572 203e 3d20 333a  classifier >= 3:
+00029fc0: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+00029fd0: 2020 2020 2069 6620 6e70 2e61 6273 2873       if np.abs(s
+00029fe0: 6c6f 7065 5f64 6573 6b65 7729 203c 2053  lope_deskew) < S
+00029ff0: 4c4f 5045 5f54 4852 4553 484f 4c44 3a0a  LOPE_THRESHOLD:.
+0002a000: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a010: 2020 2020 2020 2020 7265 6769 6f6e 735f          regions_
+0002a020: 7769 7468 6f75 745f 7365 7061 7261 746f  without_separato
+0002a030: 7273 203d 2072 6567 696f 6e73 5f77 6974  rs = regions_wit
+0002a040: 686f 7574 5f73 6570 6172 6174 6f72 732e  hout_separators.
+0002a050: 6173 7479 7065 286e 702e 7569 6e74 3829  astype(np.uint8)
+0002a060: 0a20 2020 2020 2020 2020 2020 2020 2020  .               
+0002a070: 2020 2020 2020 2020 2072 6567 696f 6e73           regions
+0002a080: 5f77 6974 686f 7574 5f73 6570 6172 6174  _without_separat
+0002a090: 6f72 7320 3d20 6376 322e 6572 6f64 6528  ors = cv2.erode(
+0002a0a0: 7265 6769 6f6e 735f 7769 7468 6f75 745f  regions_without_
+0002a0b0: 7365 7061 7261 746f 7273 5b3a 2c20 3a5d  separators[:, :]
+0002a0c0: 2c20 4b45 524e 454c 2c20 6974 6572 6174  , KERNEL, iterat
+0002a0d0: 696f 6e73 3d36 290a 0a20 2020 2020 2020  ions=6)..       
+0002a0e0: 2020 2020 2020 2020 2020 2020 2065 6c73               els
+0002a0f0: 653a 0a20 2020 2020 2020 2020 2020 2020  e:.             
+0002a100: 2020 2020 2020 2020 2020 2072 6567 696f             regio
+0002a110: 6e73 5f77 6974 686f 7574 5f73 6570 6172  ns_without_separ
+0002a120: 6174 6f72 735f 6420 3d20 7265 6769 6f6e  ators_d = region
+0002a130: 735f 7769 7468 6f75 745f 7365 7061 7261  s_without_separa
+0002a140: 746f 7273 5f64 2e61 7374 7970 6528 6e70  tors_d.astype(np
+0002a150: 2e75 696e 7438 290a 2020 2020 2020 2020  .uint8).        
+0002a160: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a170: 7265 6769 6f6e 735f 7769 7468 6f75 745f  regions_without_
+0002a180: 7365 7061 7261 746f 7273 5f64 203d 2063  separators_d = c
+0002a190: 7632 2e65 726f 6465 2872 6567 696f 6e73  v2.erode(regions
+0002a1a0: 5f77 6974 686f 7574 5f73 6570 6172 6174  _without_separat
+0002a1b0: 6f72 735f 645b 3a2c 203a 5d2c 204b 4552  ors_d[:, :], KER
+0002a1c0: 4e45 4c2c 2069 7465 7261 7469 6f6e 733d  NEL, iterations=
+0002a1d0: 3629 0a20 2020 2020 2020 2020 2020 2020  6).             
+0002a1e0: 2020 2020 2020 2020 2020 200a 0a20 2020             ..   
+0002a1f0: 2020 2020 2020 2020 2020 2020 2069 6620               if 
+0002a200: 6e70 2e61 6273 2873 6c6f 7065 5f64 6573  np.abs(slope_des
+0002a210: 6b65 7729 203c 2053 4c4f 5045 5f54 4852  kew) < SLOPE_THR
+0002a220: 4553 484f 4c44 3a0a 2020 2020 2020 2020  ESHOLD:.        
+0002a230: 2020 2020 2020 2020 2020 2020 626f 7865              boxe
+0002a240: 732c 2070 6561 6b73 5f6e 6567 5f74 6f74  s, peaks_neg_tot
+0002a250: 5f74 6162 6c65 7320 3d20 7265 7475 726e  _tables = return
+0002a260: 5f62 6f78 6573 5f6f 665f 696d 6167 6573  _boxes_of_images
+0002a270: 5f62 795f 6f72 6465 725f 6f66 5f72 6561  _by_order_of_rea
+0002a280: 6469 6e67 5f6e 6577 2873 706c 6974 7465  ding_new(splitte
+0002a290: 725f 795f 6e65 772c 2072 6567 696f 6e73  r_y_new, regions
+0002a2a0: 5f77 6974 686f 7574 5f73 6570 6172 6174  _without_separat
+0002a2b0: 6f72 732c 206d 6174 7269 785f 6f66 5f6c  ors, matrix_of_l
+0002a2c0: 696e 6573 5f63 682c 206e 756d 5f63 6f6c  ines_ch, num_col
+0002a2d0: 5f63 6c61 7373 6966 6965 722c 2065 726f  _classifier, ero
+0002a2e0: 7369 6f6e 5f68 7572 7473 2c20 7365 6c66  sion_hurts, self
+0002a2f0: 2e74 6162 6c65 7329 0a20 2020 2020 2020  .tables).       
+0002a300: 2020 2020 2020 2020 2065 6c73 653a 0a20           else:. 
+0002a310: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a320: 2020 2062 6f78 6573 5f64 2c20 7065 616b     boxes_d, peak
+0002a330: 735f 6e65 675f 746f 745f 7461 626c 6573  s_neg_tot_tables
+0002a340: 5f64 203d 2072 6574 7572 6e5f 626f 7865  _d = return_boxe
+0002a350: 735f 6f66 5f69 6d61 6765 735f 6279 5f6f  s_of_images_by_o
+0002a360: 7264 6572 5f6f 665f 7265 6164 696e 675f  rder_of_reading_
+0002a370: 6e65 7728 7370 6c69 7474 6572 5f79 5f6e  new(splitter_y_n
+0002a380: 6577 5f64 2c20 7265 6769 6f6e 735f 7769  ew_d, regions_wi
+0002a390: 7468 6f75 745f 7365 7061 7261 746f 7273  thout_separators
+0002a3a0: 5f64 2c20 6d61 7472 6978 5f6f 665f 6c69  _d, matrix_of_li
+0002a3b0: 6e65 735f 6368 5f64 2c20 6e75 6d5f 636f  nes_ch_d, num_co
+0002a3c0: 6c5f 636c 6173 7369 6669 6572 2c20 6572  l_classifier, er
+0002a3d0: 6f73 696f 6e5f 6875 7274 732c 2073 656c  osion_hurts, sel
+0002a3e0: 662e 7461 626c 6573 290a 2020 2020 2020  f.tables).      
+0002a3f0: 2020 2020 2020 0a20 2020 2020 2020 2020        .         
+0002a400: 2020 2069 6620 7365 6c66 2e70 6c6f 7474     if self.plott
+0002a410: 6572 3a0a 2020 2020 2020 2020 2020 2020  er:.            
+0002a420: 2020 2020 7365 6c66 2e70 6c6f 7474 6572      self.plotter
+0002a430: 2e77 7269 7465 5f69 6d61 6765 735f 696e  .write_images_in
+0002a440: 746f 5f64 6972 6563 746f 7279 2870 6f6c  to_directory(pol
+0002a450: 7967 6f6e 735f 6f66 5f69 6d61 6765 732c  ygons_of_images,
+0002a460: 2069 6d61 6765 5f70 6167 6529 0a20 2020   image_page).   
+0002a470: 2020 2020 2020 2020 2074 5f6f 7264 6572           t_order
+0002a480: 203d 2074 696d 652e 7469 6d65 2829 0a20   = time.time(). 
+0002a490: 2020 2020 2020 2020 2020 2069 6620 7365             if se
+0002a4a0: 6c66 2e66 756c 6c5f 6c61 796f 7574 3a0a  lf.full_layout:.
+0002a4b0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a4c0: 6966 206e 702e 6162 7328 736c 6f70 655f  if np.abs(slope_
+0002a4d0: 6465 736b 6577 2920 3c20 534c 4f50 455f  deskew) < SLOPE_
+0002a4e0: 5448 5245 5348 4f4c 443a 0a20 2020 2020  THRESHOLD:.     
+0002a4f0: 2020 2020 2020 2020 2020 2020 2020 206f                 o
+0002a500: 7264 6572 5f74 6578 745f 6e65 772c 2069  rder_text_new, i
+0002a510: 645f 6f66 5f74 6578 7473 5f74 6f74 203d  d_of_texts_tot =
+0002a520: 2073 656c 662e 646f 5f6f 7264 6572 5f6f   self.do_order_o
+0002a530: 665f 7265 6769 6f6e 7328 636f 6e74 6f75  f_regions(contou
+0002a540: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
+0002a550: 656e 742c 2063 6f6e 746f 7572 735f 6f6e  ent, contours_on
+0002a560: 6c79 5f74 6578 745f 7061 7265 6e74 5f68  ly_text_parent_h
+0002a570: 2c20 626f 7865 732c 2074 6578 746c 696e  , boxes, textlin
+0002a580: 655f 6d61 736b 5f74 6f74 290a 2020 2020  e_mask_tot).    
+0002a590: 2020 2020 2020 2020 2020 2020 656c 7365              else
+0002a5a0: 3a0a 2020 2020 2020 2020 2020 2020 2020  :.              
+0002a5b0: 2020 2020 2020 6f72 6465 725f 7465 7874        order_text
+0002a5c0: 5f6e 6577 2c20 6964 5f6f 665f 7465 7874  _new, id_of_text
+0002a5d0: 735f 746f 7420 3d20 7365 6c66 2e64 6f5f  s_tot = self.do_
+0002a5e0: 6f72 6465 725f 6f66 5f72 6567 696f 6e73  order_of_regions
+0002a5f0: 2863 6f6e 746f 7572 735f 6f6e 6c79 5f74  (contours_only_t
+0002a600: 6578 745f 7061 7265 6e74 5f64 5f6f 7264  ext_parent_d_ord
+0002a610: 6572 6564 2c20 636f 6e74 6f75 7273 5f6f  ered, contours_o
+0002a620: 6e6c 795f 7465 7874 5f70 6172 656e 745f  nly_text_parent_
+0002a630: 685f 645f 6f72 6465 7265 642c 2062 6f78  h_d_ordered, box
+0002a640: 6573 5f64 2c20 7465 7874 6c69 6e65 5f6d  es_d, textline_m
+0002a650: 6173 6b5f 746f 745f 6429 0a0a 2020 2020  ask_tot_d)..    
+0002a660: 2020 2020 2020 2020 2020 2020 7063 6774              pcgt
+0002a670: 7320 3d20 7365 6c66 2e77 7269 7465 722e  s = self.writer.
+0002a680: 6275 696c 645f 7061 6765 786d 6c5f 6675  build_pagexml_fu
+0002a690: 6c6c 5f6c 6179 6f75 7428 636f 6e74 6f75  ll_layout(contou
+0002a6a0: 7273 5f6f 6e6c 795f 7465 7874 5f70 6172  rs_only_text_par
+0002a6b0: 656e 742c 2063 6f6e 746f 7572 735f 6f6e  ent, contours_on
+0002a6c0: 6c79 5f74 6578 745f 7061 7265 6e74 5f68  ly_text_parent_h
+0002a6d0: 2c20 7061 6765 5f63 6f6f 7264 2c20 6f72  , page_coord, or
+0002a6e0: 6465 725f 7465 7874 5f6e 6577 2c20 6964  der_text_new, id
+0002a6f0: 5f6f 665f 7465 7874 735f 746f 742c 2061  _of_texts_tot, a
+0002a700: 6c6c 5f66 6f75 6e64 5f74 6578 6c69 6e65  ll_found_texline
+0002a710: 5f70 6f6c 7967 6f6e 732c 2061 6c6c 5f66  _polygons, all_f
+0002a720: 6f75 6e64 5f74 6578 6c69 6e65 5f70 6f6c  ound_texline_pol
+0002a730: 7967 6f6e 735f 682c 2061 6c6c 5f62 6f78  ygons_h, all_box
+0002a740: 5f63 6f6f 7264 2c20 616c 6c5f 626f 785f  _coord, all_box_
+0002a750: 636f 6f72 645f 682c 2070 6f6c 7967 6f6e  coord_h, polygon
+0002a760: 735f 6f66 5f69 6d61 6765 732c 2063 6f6e  s_of_images, con
+0002a770: 746f 7572 735f 7461 626c 6573 2c20 706f  tours_tables, po
+0002a780: 6c79 676f 6e73 5f6f 665f 6472 6f70 5f63  lygons_of_drop_c
+0002a790: 6170 6974 616c 732c 2070 6f6c 7967 6f6e  apitals, polygon
+0002a7a0: 735f 6f66 5f6d 6172 6769 6e61 6c73 2c20  s_of_marginals, 
+0002a7b0: 616c 6c5f 666f 756e 645f 7465 786c 696e  all_found_texlin
+0002a7c0: 655f 706f 6c79 676f 6e73 5f6d 6172 6769  e_polygons_margi
+0002a7d0: 6e61 6c73 2c20 616c 6c5f 626f 785f 636f  nals, all_box_co
+0002a7e0: 6f72 645f 6d61 7267 696e 616c 732c 2073  ord_marginals, s
+0002a7f0: 6c6f 7065 732c 2073 6c6f 7065 735f 682c  lopes, slopes_h,
+0002a800: 2073 6c6f 7065 735f 6d61 7267 696e 616c   slopes_marginal
+0002a810: 732c 2063 6f6e 745f 7061 6765 2c20 706f  s, cont_page, po
+0002a820: 6c79 676f 6e73 5f6c 696e 6573 5f78 6d6c  lygons_lines_xml
+0002a830: 290a 2020 2020 2020 2020 2020 2020 2020  ).              
+0002a840: 2020 7365 6c66 2e6c 6f67 6765 722e 696e    self.logger.in
+0002a850: 666f 2822 4a6f 6220 646f 6e65 2069 6e20  fo("Job done in 
+0002a860: 252e 3166 7322 2c20 7469 6d65 2e74 696d  %.1fs", time.tim
+0002a870: 6528 2920 2d20 7430 290a 2020 2020 2020  e() - t0).      
+0002a880: 2020 2020 2020 2020 2020 2323 7265 7475            ##retu
+0002a890: 726e 2070 6367 7473 0a20 2020 2020 2020  rn pcgts.       
+0002a8a0: 2020 2020 2065 6c73 653a 0a20 2020 2020       else:.     
+0002a8b0: 2020 2020 2020 2020 2020 2063 6f6e 746f             conto
+0002a8c0: 7572 735f 6f6e 6c79 5f74 6578 745f 7061  urs_only_text_pa
+0002a8d0: 7265 6e74 5f68 203d 204e 6f6e 650a 2020  rent_h = None.  
+0002a8e0: 2020 2020 2020 2020 2020 2020 2020 6966                if
+0002a8f0: 206e 702e 6162 7328 736c 6f70 655f 6465   np.abs(slope_de
+0002a900: 736b 6577 2920 3c20 534c 4f50 455f 5448  skew) < SLOPE_TH
+0002a910: 5245 5348 4f4c 443a 0a20 2020 2020 2020  RESHOLD:.       
+0002a920: 2020 2020 2020 2020 2020 2020 206f 7264               ord
+0002a930: 6572 5f74 6578 745f 6e65 772c 2069 645f  er_text_new, id_
+0002a940: 6f66 5f74 6578 7473 5f74 6f74 203d 2073  of_texts_tot = s
+0002a950: 656c 662e 646f 5f6f 7264 6572 5f6f 665f  elf.do_order_of_
+0002a960: 7265 6769 6f6e 7328 636f 6e74 6f75 7273  regions(contours
+0002a970: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
+0002a980: 742c 2063 6f6e 746f 7572 735f 6f6e 6c79  t, contours_only
+0002a990: 5f74 6578 745f 7061 7265 6e74 5f68 2c20  _text_parent_h, 
+0002a9a0: 626f 7865 732c 2074 6578 746c 696e 655f  boxes, textline_
+0002a9b0: 6d61 736b 5f74 6f74 290a 2020 2020 2020  mask_tot).      
+0002a9c0: 2020 2020 2020 2020 2020 656c 7365 3a0a            else:.
+0002a9d0: 2020 2020 2020 2020 2020 2020 2020 2020                  
+0002a9e0: 2020 2020 636f 6e74 6f75 7273 5f6f 6e6c      contours_onl
+0002a9f0: 795f 7465 7874 5f70 6172 656e 745f 645f  y_text_parent_d_
+0002aa00: 6f72 6465 7265 6420 3d20 6c69 7374 286e  ordered = list(n
+0002aa10: 702e 6172 7261 7928 636f 6e74 6f75 7273  p.array(contours
+0002aa20: 5f6f 6e6c 795f 7465 7874 5f70 6172 656e  _only_text_paren
+0002aa30: 745f 645f 6f72 6465 7265 6429 5b69 6e64  t_d_ordered)[ind
+0002aa40: 6578 5f62 795f 7465 7874 5f70 6172 5f63  ex_by_text_par_c
+0002aa50: 6f6e 5d29 0a20 2020 2020 2020 2020 2020  on]).           
+0002aa60: 2020 2020 2020 2020 206f 7264 6572 5f74           order_t
+0002aa70: 6578 745f 6e65 772c 2069 645f 6f66 5f74  ext_new, id_of_t
+0002aa80: 6578 7473 5f74 6f74 203d 2073 656c 662e  exts_tot = self.
+0002aa90: 646f 5f6f 7264 6572 5f6f 665f 7265 6769  do_order_of_regi
+0002aaa0: 6f6e 7328 636f 6e74 6f75 7273 5f6f 6e6c  ons(contours_onl
+0002aab0: 795f 7465 7874 5f70 6172 656e 745f 645f  y_text_parent_d_
+0002aac0: 6f72 6465 7265 642c 2063 6f6e 746f 7572  ordered, contour
+0002aad0: 735f 6f6e 6c79 5f74 6578 745f 7061 7265  s_only_text_pare
+0002aae0: 6e74 5f68 2c20 626f 7865 735f 642c 2074  nt_h, boxes_d, t
+0002aaf0: 6578 746c 696e 655f 6d61 736b 5f74 6f74  extline_mask_tot
+0002ab00: 5f64 290a 2020 2020 2020 2020 2020 2020  _d).            
+0002ab10: 2020 2020 7063 6774 7320 3d20 7365 6c66      pcgts = self
+0002ab20: 2e77 7269 7465 722e 6275 696c 645f 7061  .writer.build_pa
+0002ab30: 6765 786d 6c5f 6e6f 5f66 756c 6c5f 6c61  gexml_no_full_la
+0002ab40: 796f 7574 2874 7874 5f63 6f6e 5f6f 7267  yout(txt_con_org
+0002ab50: 2c20 7061 6765 5f63 6f6f 7264 2c20 6f72  , page_coord, or
+0002ab60: 6465 725f 7465 7874 5f6e 6577 2c20 6964  der_text_new, id
+0002ab70: 5f6f 665f 7465 7874 735f 746f 742c 2061  _of_texts_tot, a
+0002ab80: 6c6c 5f66 6f75 6e64 5f74 6578 6c69 6e65  ll_found_texline
+0002ab90: 5f70 6f6c 7967 6f6e 732c 2061 6c6c 5f62  _polygons, all_b
+0002aba0: 6f78 5f63 6f6f 7264 2c20 706f 6c79 676f  ox_coord, polygo
+0002abb0: 6e73 5f6f 665f 696d 6167 6573 2c20 706f  ns_of_images, po
+0002abc0: 6c79 676f 6e73 5f6f 665f 6d61 7267 696e  lygons_of_margin
+0002abd0: 616c 732c 2061 6c6c 5f66 6f75 6e64 5f74  als, all_found_t
+0002abe0: 6578 6c69 6e65 5f70 6f6c 7967 6f6e 735f  exline_polygons_
+0002abf0: 6d61 7267 696e 616c 732c 2061 6c6c 5f62  marginals, all_b
+0002ac00: 6f78 5f63 6f6f 7264 5f6d 6172 6769 6e61  ox_coord_margina
+0002ac10: 6c73 2c20 736c 6f70 6573 2c20 736c 6f70  ls, slopes, slop
+0002ac20: 6573 5f6d 6172 6769 6e61 6c73 2c20 636f  es_marginals, co
+0002ac30: 6e74 5f70 6167 652c 2070 6f6c 7967 6f6e  nt_page, polygon
+0002ac40: 735f 6c69 6e65 735f 786d 6c2c 2063 6f6e  s_lines_xml, con
+0002ac50: 746f 7572 735f 7461 626c 6573 290a 2020  tours_tables).  
+0002ac60: 2020 2020 2020 2020 2020 2020 2020 7365                se
+0002ac70: 6c66 2e6c 6f67 6765 722e 696e 666f 2822  lf.logger.info("
+0002ac80: 4a6f 6220 646f 6e65 2069 6e20 252e 3166  Job done in %.1f
+0002ac90: 7322 2c20 7469 6d65 2e74 696d 6528 2920  s", time.time() 
+0002aca0: 2d20 7430 290a 2020 2020 2020 2020 2020  - t0).          
+0002acb0: 2020 2020 2020 2323 7265 7475 726e 2070        ##return p
+0002acc0: 6367 7473 0a20 2020 2020 2020 2020 2020  cgts.           
+0002acd0: 2073 656c 662e 7772 6974 6572 2e77 7269   self.writer.wri
+0002ace0: 7465 5f70 6167 6578 6d6c 2870 6367 7473  te_pagexml(pcgts
+0002acf0: 290a 2020 2020 2020 2020 2020 2020 2373  ).            #s
+0002ad00: 656c 662e 6c6f 6767 6572 2e69 6e66 6f28  elf.logger.info(
+0002ad10: 224a 6f62 2064 6f6e 6520 696e 2025 2e31  "Job done in %.1
+0002ad20: 6673 222c 2074 696d 652e 7469 6d65 2829  fs", time.time()
+0002ad30: 202d 2074 3029 0a20 2020 2020 2020 2069   - t0).        i
+0002ad40: 6620 7365 6c66 2e64 6972 5f69 6e3a 0a20  f self.dir_in:. 
+0002ad50: 2020 2020 2020 2020 2020 2073 656c 662e             self.
+0002ad60: 6c6f 6767 6572 2e69 6e66 6f28 2241 6c6c  logger.info("All
+0002ad70: 206a 6f62 7320 646f 6e65 2069 6e20 252e   jobs done in %.
+0002ad80: 3166 7322 2c20 7469 6d65 2e74 696d 6528  1fs", time.time(
+0002ad90: 2920 2d20 7430 5f74 6f74 290a            ) - t0_tot).
```

### Comparing `eynollah-0.2.0/qurator/eynollah/ocrd-tool.json` & `eynollah-0.3.0/qurator/eynollah/ocrd-tool.json`

 * *Files 4% similar despite different names*

#### Pretty-printed

 * *Similarity: 0.8324652777777778%*

 * *Differences: {"'tools'": "{'ocrd-eynollah-segment': {'resources': {0: {'url': "*

 * *            "'https://github.com/qurator-spk/eynollah/releases/download/v0.3.0/models_eynollah.tar.gz', "*

 * *            "'size': 1757668443}}}}",*

 * * "'version'": "'0.3.0'"}*

```diff
@@ -57,20 +57,20 @@
                 }
             },
             "resources": [
                 {
                     "description": "models for eynollah (TensorFlow format)",
                     "name": "default",
                     "path_in_archive": "default",
-                    "size": 1483106598,
+                    "size": 1757668443,
                     "type": "archive",
-                    "url": "https://qurator-data.de/eynollah/2021-04-25/SavedModel.tar.gz"
+                    "url": "https://github.com/qurator-spk/eynollah/releases/download/v0.3.0/models_eynollah.tar.gz"
                 }
             ],
             "steps": [
                 "layout/segmentation/region",
                 "layout/segmentation/line"
             ]
         }
     },
-    "version": "0.2.0"
+    "version": "0.3.0"
 }
```

### Comparing `eynollah-0.2.0/qurator/eynollah/plot.py` & `eynollah-0.3.0/qurator/eynollah/plot.py`

 * *Files 5% similar despite different names*

```diff
@@ -15,24 +15,26 @@
     """
 
     def __init__(
         self,
         *,
         dir_out,
         dir_of_all,
+        dir_save_page,
         dir_of_deskewed,
         dir_of_layout,
         dir_of_cropped_images,
         image_filename_stem,
         image_org=None,
         scale_x=1,
         scale_y=1,
     ):
         self.dir_out = dir_out
         self.dir_of_all = dir_of_all
+        self.dir_save_page = dir_save_page
         self.dir_of_layout = dir_of_layout
         self.dir_of_cropped_images = dir_of_cropped_images
         self.dir_of_deskewed = dir_of_deskewed
         self.image_filename_stem = image_filename_stem
         # XXX TODO hacky these cannot be set at init time
         self.image_org = image_org
         self.scale_x = scale_x
@@ -70,30 +72,30 @@
             plt.legend(handles=patches, bbox_to_anchor=(1.05, 1), loc=2, borderaxespad=0.0, fontsize=60)
             plt.savefig(os.path.join(self.dir_of_all, self.image_filename_stem + "_layout_main_and_page.png"))
 
     def save_plot_of_layout(self, text_regions_p, image_page):
         if self.dir_of_layout is not None:
             values = np.unique(text_regions_p[:, :])
             # pixels=['Background' , 'Main text' , 'Heading' , 'Marginalia' ,'Drop capitals' , 'Images' , 'Seperators' , 'Tables', 'Graphics']
-            pixels = ["Background", "Main text", "Header", "Marginalia", "Drop capital", "Image", "Separator"]
-            values_indexes = [0, 1, 2, 8, 4, 5, 6]
+            pixels = ["Background", "Main text", "Header", "Marginalia", "Drop capital", "Image", "Separator", "Tables"]
+            values_indexes = [0, 1, 2, 8, 4, 5, 6, 10]
             plt.figure(figsize=(40, 40))
             plt.rcParams["font.size"] = "40"
             im = plt.imshow(text_regions_p[:, :])
             colors = [im.cmap(im.norm(value)) for value in values]
             patches = [mpatches.Patch(color=colors[np.where(values == i)[0][0]], label="{l}".format(l=pixels[int(np.where(values_indexes == i)[0][0])])) for i in values]
             plt.legend(handles=patches, bbox_to_anchor=(1.05, 1), loc=2, borderaxespad=0.0, fontsize=40)
             plt.savefig(os.path.join(self.dir_of_layout, self.image_filename_stem + "_layout.png"))
 
     def save_plot_of_layout_all(self, text_regions_p, image_page):
         if self.dir_of_all is not None:
             values = np.unique(text_regions_p[:, :])
             # pixels=['Background' , 'Main text' , 'Heading' , 'Marginalia' ,'Drop capitals' , 'Images' , 'Seperators' , 'Tables', 'Graphics']
-            pixels = ["Background", "Main text", "Header", "Marginalia", "Drop capital", "Image", "Separator"]
-            values_indexes = [0, 1, 2, 8, 4, 5, 6]
+            pixels = ["Background", "Main text", "Header", "Marginalia", "Drop capital", "Image", "Separator", "Tables"]
+            values_indexes = [0, 1, 2, 8, 4, 5, 6, 10]
             plt.figure(figsize=(80, 40))
             plt.rcParams["font.size"] = "40"
             plt.subplot(1, 2, 1)
             plt.imshow(image_page)
             plt.subplot(1, 2, 2)
             im = plt.imshow(text_regions_p[:, :])
             colors = [im.cmap(im.norm(value)) for value in values]
@@ -123,14 +125,16 @@
         if self.dir_of_deskewed is not None:
             img_rotated = rotate_image_different(self.image_org, slope_deskew)
             cv2.imwrite(os.path.join(self.dir_of_deskewed, self.image_filename_stem + "_deskewed.png"), img_rotated)
 
     def save_page_image(self, image_page):
         if self.dir_of_all is not None:
             cv2.imwrite(os.path.join(self.dir_of_all, self.image_filename_stem + "_page.png"), image_page)
+        if self.dir_save_page is not None:
+            cv2.imwrite(os.path.join(self.dir_save_page, self.image_filename_stem + "_page.png"), image_page)
     def save_enhanced_image(self, img_res):
         cv2.imwrite(os.path.join(self.dir_out, self.image_filename_stem + "_enhanced.png"), img_res)
         
     def save_plot_of_textline_density(self, img_patch_org):
         if self.dir_of_all is not None:
             plt.figure(figsize=(80,40))
             plt.rcParams['font.size']='50'
```

### Comparing `eynollah-0.2.0/qurator/eynollah/processor.py` & `eynollah-0.3.0/qurator/eynollah/processor.py`

 * *Files identical despite different names*

### Comparing `eynollah-0.2.0/qurator/eynollah/utils/__init__.py` & `eynollah-0.3.0/qurator/eynollah/utils/__init__.py`

 * *Files 3% similar despite different names*

```diff
@@ -793,14 +793,84 @@
     for jj in range(len(contours_drop_parent)):
         x, y, w, h = cv2.boundingRect(contours_drop_parent[jj])
         layout_in_patch[y : y + h, x : x + w, 0] = 4
 
     return layout_in_patch
 
 def check_any_text_region_in_model_one_is_main_or_header(regions_model_1,regions_model_full,contours_only_text_parent,all_box_coord,all_found_texline_polygons,slopes,contours_only_text_parent_d_ordered):
+    
+    cx_main,cy_main ,x_min_main , x_max_main, y_min_main ,y_max_main,y_corr_x_min_from_argmin=find_new_features_of_contours(contours_only_text_parent)
+
+    length_con=x_max_main-x_min_main
+    height_con=y_max_main-y_min_main
+
+
+
+    all_found_texline_polygons_main=[]
+    all_found_texline_polygons_head=[]
+
+    all_box_coord_main=[]
+    all_box_coord_head=[]
+
+    slopes_main=[]
+    slopes_head=[]
+
+    contours_only_text_parent_main=[]
+    contours_only_text_parent_head=[]
+
+    contours_only_text_parent_main_d=[]
+    contours_only_text_parent_head_d=[]
+
+    for ii in range(len(contours_only_text_parent)):
+        con=contours_only_text_parent[ii]
+        img=np.zeros((regions_model_1.shape[0],regions_model_1.shape[1],3))
+        img = cv2.fillPoly(img, pts=[con], color=(255, 255, 255))
+
+
+
+        all_pixels=((img[:,:,0]==255)*1).sum()
+
+        pixels_header=( ( (img[:,:,0]==255) & (regions_model_full[:,:,0]==2) )*1 ).sum()
+        pixels_main=all_pixels-pixels_header
+
+
+        if (pixels_header>=pixels_main) and ( (length_con[ii]/float(height_con[ii]) )>=1.3 ):
+            regions_model_1[:,:][(regions_model_1[:,:]==1) & (img[:,:,0]==255) ]=2
+            contours_only_text_parent_head.append(con)
+            if contours_only_text_parent_d_ordered is not None:
+                contours_only_text_parent_head_d.append(contours_only_text_parent_d_ordered[ii])
+            all_box_coord_head.append(all_box_coord[ii])
+            slopes_head.append(slopes[ii])
+            all_found_texline_polygons_head.append(all_found_texline_polygons[ii])
+        else:
+            regions_model_1[:,:][(regions_model_1[:,:]==1) & (img[:,:,0]==255) ]=1
+            contours_only_text_parent_main.append(con)
+            if contours_only_text_parent_d_ordered is not None:
+                contours_only_text_parent_main_d.append(contours_only_text_parent_d_ordered[ii])
+            all_box_coord_main.append(all_box_coord[ii])
+            slopes_main.append(slopes[ii])
+            all_found_texline_polygons_main.append(all_found_texline_polygons[ii])
+
+        #print(all_pixels,pixels_main,pixels_header)
+
+    return regions_model_1,contours_only_text_parent_main,contours_only_text_parent_head,all_box_coord_main,all_box_coord_head,all_found_texline_polygons_main,all_found_texline_polygons_head,slopes_main,slopes_head,contours_only_text_parent_main_d,contours_only_text_parent_head_d
+
+
+def check_any_text_region_in_model_one_is_main_or_header_light(regions_model_1,regions_model_full,contours_only_text_parent,all_box_coord,all_found_texline_polygons,slopes,contours_only_text_parent_d_ordered):
+    
+    ### to make it faster
+    h_o = regions_model_1.shape[0]
+    w_o = regions_model_1.shape[1]
+    
+    regions_model_1 = cv2.resize(regions_model_1, (int(regions_model_1.shape[1]/3.), int(regions_model_1.shape[0]/3.)), interpolation=cv2.INTER_NEAREST)
+    regions_model_full = cv2.resize(regions_model_full, (int(regions_model_full.shape[1]/3.), int(regions_model_full.shape[0]/3.)), interpolation=cv2.INTER_NEAREST)
+    contours_only_text_parent = [ (i/3.).astype(np.int32) for i in  contours_only_text_parent]
+
+    ###
+    
     cx_main,cy_main ,x_min_main , x_max_main, y_min_main ,y_max_main,y_corr_x_min_from_argmin=find_new_features_of_contours(contours_only_text_parent)
 
     length_con=x_max_main-x_min_main
     height_con=y_max_main-y_min_main
 
 
 
@@ -849,16 +919,22 @@
             slopes_main.append(slopes[ii])
             all_found_texline_polygons_main.append(all_found_texline_polygons[ii])
 
         #print(all_pixels,pixels_main,pixels_header)
 
 
 
-        #plt.imshow(img[:,:,0])
-        #plt.show()
+    ### to make it faster
+    
+    regions_model_1 = cv2.resize(regions_model_1, (w_o, h_o), interpolation=cv2.INTER_NEAREST)
+    #regions_model_full = cv2.resize(img, (int(regions_model_full.shape[1]/3.), int(regions_model_full.shape[0]/3.)), interpolation=cv2.INTER_NEAREST)
+    contours_only_text_parent_head = [ (i*3.).astype(np.int32) for i in  contours_only_text_parent_head]
+    contours_only_text_parent_main = [ (i*3.).astype(np.int32) for i in  contours_only_text_parent_main]
+    ###
+    
     return regions_model_1,contours_only_text_parent_main,contours_only_text_parent_head,all_box_coord_main,all_box_coord_head,all_found_texline_polygons_main,all_found_texline_polygons_head,slopes_main,slopes_head,contours_only_text_parent_main_d,contours_only_text_parent_head_d
 
 def small_textlines_to_parent_adherence2(textlines_con, textline_iamge, num_col):
     # print(textlines_con)
     # textlines_con=textlines_con.astype(np.uint32)
 
     textlines_con_changed = []
```

### Comparing `eynollah-0.2.0/qurator/eynollah/utils/contour.py` & `eynollah-0.3.0/qurator/eynollah/utils/contour.py`

 * *Files 20% similar despite different names*

```diff
@@ -1,13 +1,14 @@
 import cv2
 import numpy as np
 from shapely import geometry
 
 from .rotate import rotate_image, rotation_image_new
-
+from multiprocessing import Process, Queue, cpu_count
+from multiprocessing import Pool
 def contours_in_same_horizon(cy_main_hor):
     X1 = np.zeros((len(cy_main_hor), len(cy_main_hor)))
     X2 = np.zeros((len(cy_main_hor), len(cy_main_hor)))
 
     X1[0::1, :] = cy_main_hor[:]
     X2 = X1.T
 
@@ -143,14 +144,104 @@
     contours_imgs, hierarchy = cv2.findContours(thresh, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)
 
     contours_imgs = return_parent_contours(contours_imgs, hierarchy)
     contours_imgs = filter_contours_area_of_image_tables(thresh, contours_imgs, hierarchy, max_area=1, min_area=min_area)
 
     return contours_imgs
 
+def do_work_of_contours_in_image(queue_of_all_params, contours_per_process, indexes_r_con_per_pro, img, slope_first):
+    cnts_org_per_each_subprocess = []
+    index_by_text_region_contours = []
+    for mv in range(len(contours_per_process)):
+        index_by_text_region_contours.append(indexes_r_con_per_pro[mv])
+        
+        img_copy = np.zeros(img.shape)
+        img_copy = cv2.fillPoly(img_copy, pts=[contours_per_process[mv]], color=(1, 1, 1))
+
+        img_copy = rotation_image_new(img_copy, -slope_first)
+
+        img_copy = img_copy.astype(np.uint8)
+        imgray = cv2.cvtColor(img_copy, cv2.COLOR_BGR2GRAY)
+        ret, thresh = cv2.threshold(imgray, 0, 255, 0)
+
+        cont_int, _ = cv2.findContours(thresh, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)
+
+        cont_int[0][:, 0, 0] = cont_int[0][:, 0, 0] + np.abs(img_copy.shape[1] - img.shape[1])
+        cont_int[0][:, 0, 1] = cont_int[0][:, 0, 1] + np.abs(img_copy.shape[0] - img.shape[0])
+
+
+        cnts_org_per_each_subprocess.append(cont_int[0])
+
+    queue_of_all_params.put([ cnts_org_per_each_subprocess, index_by_text_region_contours])
+
+
+def get_textregion_contours_in_org_image_multi(cnts, img, slope_first):
+    
+    num_cores = cpu_count()
+    queue_of_all_params = Queue()
+
+    processes = []
+    nh = np.linspace(0, len(cnts), num_cores + 1)
+    indexes_by_text_con = np.array(range(len(cnts)))
+    for i in range(num_cores):
+        contours_per_process = cnts[int(nh[i]) : int(nh[i + 1])]
+        indexes_text_con_per_process = indexes_by_text_con[int(nh[i]) : int(nh[i + 1])]
+
+        processes.append(Process(target=do_work_of_contours_in_image, args=(queue_of_all_params, contours_per_process, indexes_text_con_per_process, img,slope_first )))
+    for i in range(num_cores):
+        processes[i].start()
+    cnts_org = []
+    all_index_text_con = []
+    for i in range(num_cores):
+        list_all_par = queue_of_all_params.get(True)
+        contours_for_sub_process = list_all_par[0]
+        indexes_for_sub_process = list_all_par[1]
+        for j in range(len(contours_for_sub_process)):
+            cnts_org.append(contours_for_sub_process[j])
+            all_index_text_con.append(indexes_for_sub_process[j])
+    for i in range(num_cores):
+        processes[i].join()
+
+    print(all_index_text_con)
+    return cnts_org
+def loop_contour_image(index_l, cnts,img, slope_first):
+    img_copy = np.zeros(img.shape)
+    img_copy = cv2.fillPoly(img_copy, pts=[cnts[index_l]], color=(1, 1, 1))
+
+    # plt.imshow(img_copy)
+    # plt.show()
+
+    # print(img.shape,'img')
+    img_copy = rotation_image_new(img_copy, -slope_first)
+    ##print(img_copy.shape,'img_copy')
+    # plt.imshow(img_copy)
+    # plt.show()
+
+    img_copy = img_copy.astype(np.uint8)
+    imgray = cv2.cvtColor(img_copy, cv2.COLOR_BGR2GRAY)
+    ret, thresh = cv2.threshold(imgray, 0, 255, 0)
+
+    cont_int, _ = cv2.findContours(thresh, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)
+
+    cont_int[0][:, 0, 0] = cont_int[0][:, 0, 0] + np.abs(img_copy.shape[1] - img.shape[1])
+    cont_int[0][:, 0, 1] = cont_int[0][:, 0, 1] + np.abs(img_copy.shape[0] - img.shape[0])
+    # print(np.shape(cont_int[0]))
+    return cont_int[0]
+
+def get_textregion_contours_in_org_image_multi2(cnts, img, slope_first):
+
+    cnts_org = []
+    # print(cnts,'cnts')
+    with Pool(cpu_count()) as p:
+        cnts_org = p.starmap(loop_contour_image, [(index_l,cnts, img,slope_first) for index_l in range(len(cnts))])
+        
+    print(len(cnts_org),'lendiha')
+
+    return cnts_org
+
 def get_textregion_contours_in_org_image(cnts, img, slope_first):
 
     cnts_org = []
     # print(cnts,'cnts')
     for i in range(len(cnts)):
         img_copy = np.zeros(img.shape)
         img_copy = cv2.fillPoly(img_copy, pts=[cnts[i]], color=(1, 1, 1))
@@ -171,19 +262,51 @@
         cont_int, _ = cv2.findContours(thresh, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)
 
         cont_int[0][:, 0, 0] = cont_int[0][:, 0, 0] + np.abs(img_copy.shape[1] - img.shape[1])
         cont_int[0][:, 0, 1] = cont_int[0][:, 0, 1] + np.abs(img_copy.shape[0] - img.shape[0])
         # print(np.shape(cont_int[0]))
         cnts_org.append(cont_int[0])
 
-    # print(cnts_org,'cnts_org')
+    return cnts_org
+
+def get_textregion_contours_in_org_image_light(cnts, img, slope_first):
+    
+    h_o = img.shape[0]
+    w_o = img.shape[1]
+    
+    img = cv2.resize(img, (int(img.shape[1]/3.), int(img.shape[0]/3.)), interpolation=cv2.INTER_NEAREST)
+    ##cnts = list( (np.array(cnts)/2).astype(np.int16) )
+    #cnts = cnts/2
+    cnts = [(i/ 3).astype(np.int32) for i in cnts]
+    cnts_org = []
+    #print(cnts,'cnts')
+    for i in range(len(cnts)):
+        img_copy = np.zeros(img.shape)
+        img_copy = cv2.fillPoly(img_copy, pts=[cnts[i]], color=(1, 1, 1))
+
+        # plt.imshow(img_copy)
+        # plt.show()
+
+        # print(img.shape,'img')
+        img_copy = rotation_image_new(img_copy, -slope_first)
+        ##print(img_copy.shape,'img_copy')
+        # plt.imshow(img_copy)
+        # plt.show()
+
+        img_copy = img_copy.astype(np.uint8)
+        imgray = cv2.cvtColor(img_copy, cv2.COLOR_BGR2GRAY)
+        ret, thresh = cv2.threshold(imgray, 0, 255, 0)
+
+        cont_int, _ = cv2.findContours(thresh, cv2.RETR_TREE, cv2.CHAIN_APPROX_SIMPLE)
+
+        cont_int[0][:, 0, 0] = cont_int[0][:, 0, 0] + np.abs(img_copy.shape[1] - img.shape[1])
+        cont_int[0][:, 0, 1] = cont_int[0][:, 0, 1] + np.abs(img_copy.shape[0] - img.shape[0])
+        # print(np.shape(cont_int[0]))
+        cnts_org.append(cont_int[0]*3)
 
-    # sys.exit()
-    # self.y_shift = np.abs(img_copy.shape[0] - img.shape[0])
-    # self.x_shift = np.abs(img_copy.shape[1] - img.shape[1])
     return cnts_org
 
 def return_contours_of_interested_textline(region_pre_p, pixel):
 
     # pixels of images are identified by 5
     if len(region_pre_p.shape) == 3:
         cnts_images = (region_pre_p[:, :, 0] == pixel) * 1
```

### Comparing `eynollah-0.2.0/qurator/eynollah/utils/counter.py` & `eynollah-0.3.0/qurator/eynollah/utils/counter.py`

 * *Files identical despite different names*

### Comparing `eynollah-0.2.0/qurator/eynollah/utils/drop_capitals.py` & `eynollah-0.3.0/qurator/eynollah/utils/drop_capitals.py`

 * *Files identical despite different names*

### Comparing `eynollah-0.2.0/qurator/eynollah/utils/marginals.py` & `eynollah-0.3.0/qurator/eynollah/utils/marginals.py`

 * *Files identical despite different names*

### Comparing `eynollah-0.2.0/qurator/eynollah/utils/pil_cv2.py` & `eynollah-0.3.0/qurator/eynollah/utils/pil_cv2.py`

 * *Files identical despite different names*

### Comparing `eynollah-0.2.0/qurator/eynollah/utils/rotate.py` & `eynollah-0.3.0/qurator/eynollah/utils/rotate.py`

 * *Files identical despite different names*

### Comparing `eynollah-0.2.0/qurator/eynollah/utils/separate_lines.py` & `eynollah-0.3.0/qurator/eynollah/utils/separate_lines.py`

 * *Files identical despite different names*

### Comparing `eynollah-0.2.0/qurator/eynollah/utils/xml.py` & `eynollah-0.3.0/qurator/eynollah/utils/xml.py`

 * *Files identical despite different names*

### Comparing `eynollah-0.2.0/qurator/eynollah/writer.py` & `eynollah-0.3.0/qurator/eynollah/writer.py`

 * *Files 2% similar despite different names*

```diff
@@ -18,20 +18,21 @@
         SeparatorRegionType,
         to_xml
         )
 import numpy as np
 
 class EynollahXmlWriter():
 
-    def __init__(self, *, dir_out, image_filename, curved_line, pcgts=None):
+    def __init__(self, *, dir_out, image_filename, curved_line,textline_light, pcgts=None):
         self.logger = getLogger('eynollah.writer')
         self.counter = EynollahIdCounter()
         self.dir_out = dir_out
         self.image_filename = image_filename
         self.curved_line = curved_line
+        self.textline_light = textline_light
         self.pcgts = pcgts
         self.scale_x = None # XXX set outside __init__
         self.scale_y = None # XXX set outside __init__
         self.height_org = None # XXX set outside __init__
         self.width_org = None # XXX set outside __init__
 
     @property
@@ -56,35 +57,35 @@
     def serialize_lines_in_marginal(self, marginal_region, all_found_texline_polygons_marginals, marginal_idx, page_coord, all_box_coord_marginals, slopes_marginals, counter):
         for j in range(len(all_found_texline_polygons_marginals[marginal_idx])):
             coords = CoordsType()
             textline = TextLineType(id=counter.next_line_id, Coords=coords)
             marginal_region.add_TextLine(textline)
             points_co = ''
             for l in range(len(all_found_texline_polygons_marginals[marginal_idx][j])):
-                if not self.curved_line:
+                if not (self.curved_line or self.textline_light):
                     if len(all_found_texline_polygons_marginals[marginal_idx][j][l]) == 2:
                         textline_x_coord = max(0, int((all_found_texline_polygons_marginals[marginal_idx][j][l][0] + all_box_coord_marginals[marginal_idx][2] + page_coord[2]) / self.scale_x) )
                         textline_y_coord = max(0, int((all_found_texline_polygons_marginals[marginal_idx][j][l][1] + all_box_coord_marginals[marginal_idx][0] + page_coord[0]) / self.scale_y) )
                     else:
                         textline_x_coord = max(0, int((all_found_texline_polygons_marginals[marginal_idx][j][l][0][0] + all_box_coord_marginals[marginal_idx][2] + page_coord[2]) / self.scale_x) )
                         textline_y_coord = max(0, int((all_found_texline_polygons_marginals[marginal_idx][j][l][0][1] + all_box_coord_marginals[marginal_idx][0] + page_coord[0]) / self.scale_y) )
                     points_co += str(textline_x_coord)
                     points_co += ','
                     points_co += str(textline_y_coord)
-                if self.curved_line and np.abs(slopes_marginals[marginal_idx]) <= 45:
+                if (self.curved_line or self.textline_light) and np.abs(slopes_marginals[marginal_idx]) <= 45:
                     if len(all_found_texline_polygons_marginals[marginal_idx][j][l]) == 2:
                         points_co += str(int((all_found_texline_polygons_marginals[marginal_idx][j][l][0] + page_coord[2]) / self.scale_x))
                         points_co += ','
                         points_co += str(int((all_found_texline_polygons_marginals[marginal_idx][j][l][1] + page_coord[0]) / self.scale_y))
                     else:
                         points_co += str(int((all_found_texline_polygons_marginals[marginal_idx][j][l][0][0] + page_coord[2]) / self.scale_x))
                         points_co += ','
                         points_co += str(int((all_found_texline_polygons_marginals[marginal_idx][j][l][0][1] + page_coord[0]) / self.scale_y))
 
-                elif self.curved_line and np.abs(slopes_marginals[marginal_idx]) > 45:
+                elif (self.curved_line or self.textline_light) and np.abs(slopes_marginals[marginal_idx]) > 45:
                     if len(all_found_texline_polygons_marginals[marginal_idx][j][l]) == 2:
                         points_co += str(int((all_found_texline_polygons_marginals[marginal_idx][j][l][0] + all_box_coord_marginals[marginal_idx][2] + page_coord[2]) / self.scale_x))
                         points_co += ','
                         points_co += str(int((all_found_texline_polygons_marginals[marginal_idx][j][l][1] + all_box_coord_marginals[marginal_idx][0] + page_coord[0]) / self.scale_y))
                     else:
                         points_co += str(int((all_found_texline_polygons_marginals[marginal_idx][j][l][0][0] + all_box_coord_marginals[marginal_idx][2] + page_coord[2]) / self.scale_x))
                         points_co += ','
@@ -97,35 +98,35 @@
         for j in range(len(all_found_texline_polygons[region_idx])):
             coords = CoordsType()
             textline = TextLineType(id=counter.next_line_id, Coords=coords)
             text_region.add_TextLine(textline)
             region_bboxes = all_box_coord[region_idx]
             points_co = ''
             for idx_contour_textline, contour_textline in enumerate(all_found_texline_polygons[region_idx][j]):
-                if not self.curved_line:
+                if not (self.curved_line or self.textline_light):
                     if len(contour_textline) == 2:
                         textline_x_coord = max(0, int((contour_textline[0] + region_bboxes[2] + page_coord[2]) / self.scale_x))
                         textline_y_coord = max(0, int((contour_textline[1] + region_bboxes[0] + page_coord[0]) / self.scale_y))
                     else:
                         textline_x_coord = max(0, int((contour_textline[0][0] + region_bboxes[2] + page_coord[2]) / self.scale_x))
                         textline_y_coord = max(0, int((contour_textline[0][1] + region_bboxes[0] + page_coord[0]) / self.scale_y))
                     points_co += str(textline_x_coord)
                     points_co += ','
                     points_co += str(textline_y_coord)
 
-                if self.curved_line and np.abs(slopes[region_idx]) <= 45:
+                if (self.curved_line or self.textline_light) and np.abs(slopes[region_idx]) <= 45:
                     if len(contour_textline) == 2:
                         points_co += str(int((contour_textline[0] + page_coord[2]) / self.scale_x))
                         points_co += ','
                         points_co += str(int((contour_textline[1] + page_coord[0]) / self.scale_y))
                     else:
                         points_co += str(int((contour_textline[0][0] + page_coord[2]) / self.scale_x))
                         points_co += ','
                         points_co += str(int((contour_textline[0][1] + page_coord[0])/self.scale_y))
-                elif self.curved_line and np.abs(slopes[region_idx]) > 45:
+                elif (self.curved_line or self.textline_light) and np.abs(slopes[region_idx]) > 45:
                     if len(contour_textline)==2:
                         points_co += str(int((contour_textline[0] + region_bboxes[2] + page_coord[2])/self.scale_x))
                         points_co += ','
                         points_co += str(int((contour_textline[1] + region_bboxes[0] + page_coord[0])/self.scale_y))
                     else:
                         points_co += str(int((contour_textline[0][0] + region_bboxes[2]+page_coord[2])/self.scale_x))
                         points_co += ','
```

### Comparing `eynollah-0.2.0/setup.py` & `eynollah-0.3.0/setup.py`

 * *Files 14% similar despite different names*

```diff
@@ -1,23 +1,22 @@
-from setuptools import setup, find_packages
+from setuptools import find_namespace_packages, find_packages, setup
 from json import load
 
 install_requires = open('requirements.txt').read().split('\n')
 with open('ocrd-tool.json', 'r', encoding='utf-8') as f:
     version = load(f)['version']
 
 setup(
     name='eynollah',
     version=version,
     long_description=open('README.md').read(),
     long_description_content_type='text/markdown',
     author='Vahid Rezanezhad',
     url='https://github.com/qurator-spk/eynollah',
     license='Apache License 2.0',
-    namespace_packages=['qurator'],
     packages=find_packages(exclude=['tests']),
     install_requires=install_requires,
     package_data={
         '': ['*.json']
     },
     entry_points={
         'console_scripts': [
```

### Comparing `eynollah-0.2.0/tests/test_counter.py` & `eynollah-0.3.0/tests/test_counter.py`

 * *Files identical despite different names*

### Comparing `eynollah-0.2.0/tests/test_run.py` & `eynollah-0.3.0/tests/test_run.py`

 * *Files identical despite different names*

